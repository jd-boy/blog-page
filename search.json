[{"title":"Java ç¯å¢ƒå˜é‡è®¾ç½® Options","url":"/posts/14498/","content":"JDK_JAVA_OPTIONSæ–‡æ¡£ï¼šhttps://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE\nJAVA_TOOL_OPTIONShttps://blog.51cto.com/u_11791718/4832223\n\nJDK_JAVA_OPTIONS is only picked up by the java launcher, so use it for options that you only want to apply (or only make sense for) the java startup command. This variable is also new on JDK 9+, and will be ignored by earlier JDK versions. Hence, itâ€™s useful when migrating from older versions to 9+.\nJAVA_TOOL_OPTIONS is picked up also by other java tools like jar and javac so it should be used for flags that you want to apply (and are valid) to all those java tools.\n\n","categories":["Java"]},{"title":"Javaagent","url":"/posts/54537/","content":"JVMå¯åŠ¨å‰é™æ€InstrumentJavaagent æ˜¯ä»€ä¹ˆï¼Ÿ\nJavaagentæ˜¯javaå‘½ä»¤çš„ä¸€ä¸ªå‚æ•°ã€‚å‚æ•° javaagent å¯ä»¥ç”¨äºæŒ‡å®šä¸€ä¸ª jar åŒ…ï¼Œå¹¶ä¸”å¯¹è¯¥ java åŒ…æœ‰2ä¸ªè¦æ±‚ï¼š\n\nè¿™ä¸ª jar åŒ…çš„ MANIFEST.MF æ–‡ä»¶å¿…é¡»æŒ‡å®š Premain-Class é¡¹ã€‚\nPremain-Class æŒ‡å®šçš„é‚£ä¸ªç±»å¿…é¡»å®ç° premain() æ–¹æ³•ã€‚\n\npremain æ–¹æ³•ï¼Œä»å­—é¢ä¸Šç†è§£ï¼Œå°±æ˜¯è¿è¡Œåœ¨ main å‡½æ•°ä¹‹å‰çš„çš„ç±»ã€‚å½“Java è™šæ‹Ÿæœºå¯åŠ¨æ—¶ï¼Œåœ¨æ‰§è¡Œ main å‡½æ•°ä¹‹å‰ï¼ŒJVM ä¼šå…ˆè¿è¡Œ-javaagentæ‰€æŒ‡å®š jar åŒ…å†… Premain-Class è¿™ä¸ªç±»çš„ premain æ–¹æ³• ã€‚\nåœ¨å‘½ä»¤è¡Œè¾“å…¥ javaå¯ä»¥çœ‹åˆ°ç›¸åº”çš„å‚æ•°ï¼Œå…¶ä¸­æœ‰ å’Œ java agentç›¸å…³çš„ï¼š\nCopy-agentlib:&lt;libname&gt;[=&lt;é€‰é¡¹&gt;] åŠ è½½æœ¬æœºä»£ç†åº“ &lt;libname&gt;, ä¾‹å¦‚ -agentlib:hprof\tå¦è¯·å‚é˜… -agentlib:jdwp=help å’Œ -agentlib:hprof=help-agentpath:&lt;pathname&gt;[=&lt;é€‰é¡¹&gt;]\tæŒ‰å®Œæ•´è·¯å¾„ååŠ è½½æœ¬æœºä»£ç†åº“-javaagent:&lt;jarpath&gt;[=&lt;é€‰é¡¹&gt;]\tåŠ è½½ Java ç¼–ç¨‹è¯­è¨€ä»£ç†, è¯·å‚é˜… java.lang.instrument\n\nåœ¨ä¸Šé¢-javaagentå‚æ•°ä¸­æåˆ°äº†å‚é˜…java.lang.instrumentï¼Œè¿™æ˜¯åœ¨rt.jar ä¸­å®šä¹‰çš„ä¸€ä¸ªåŒ…ï¼Œè¯¥è·¯å¾„ä¸‹æœ‰ä¸¤ä¸ªé‡è¦çš„ç±»ï¼š\n\nè¯¥åŒ…æä¾›äº†ä¸€äº›å·¥å…·å¸®åŠ©å¼€å‘äººå‘˜åœ¨ Java ç¨‹åºè¿è¡Œæ—¶ï¼ŒåŠ¨æ€ä¿®æ”¹ç³»ç»Ÿä¸­çš„ Class ç±»å‹ã€‚å…¶ä¸­ï¼Œä½¿ç”¨è¯¥è½¯ä»¶åŒ…çš„ä¸€ä¸ªå…³é”®ç»„ä»¶å°±æ˜¯ Javaagentã€‚ä»åå­—ä¸Šçœ‹ï¼Œä¼¼ä¹æ˜¯ä¸ª Java ä»£ç†ä¹‹ç±»çš„ï¼Œè€Œå®é™…ä¸Šï¼Œä»–çš„åŠŸèƒ½æ›´åƒæ˜¯ä¸€ä¸ªClass ç±»å‹çš„è½¬æ¢å™¨ï¼Œä»–å¯ä»¥åœ¨è¿è¡Œæ—¶æ¥å—é‡æ–°å¤–éƒ¨è¯·æ±‚ï¼Œå¯¹Classç±»å‹è¿›è¡Œä¿®æ”¹ã€‚\nä»æœ¬è´¨ä¸Šè®²ï¼ŒJava Agent æ˜¯ä¸€ä¸ªéµå¾ªä¸€ç»„ä¸¥æ ¼çº¦å®šçš„å¸¸è§„ Java ç±»ã€‚ ä¸Šé¢è¯´åˆ° javaagentå‘½ä»¤è¦æ±‚æŒ‡å®šçš„ç±»ä¸­å¿…é¡»è¦æœ‰premain()æ–¹æ³•ï¼Œå¹¶ä¸”å¯¹premainæ–¹æ³•çš„ç­¾åä¹Ÿæœ‰è¦æ±‚ï¼Œç­¾åå¿…é¡»æ»¡è¶³ä»¥ä¸‹ä¸¤ç§æ ¼å¼ï¼š\nCopypublic static void premain(String agentArgs, Instrumentation inst)    public static void premain(String agentArgs)\n\nJVM ä¼šä¼˜å…ˆåŠ è½½ å¸¦ Instrumentation ç­¾åçš„æ–¹æ³•ï¼ŒåŠ è½½æˆåŠŸå¿½ç•¥ç¬¬äºŒç§ï¼Œå¦‚æœç¬¬ä¸€ç§æ²¡æœ‰ï¼Œåˆ™åŠ è½½ç¬¬äºŒç§æ–¹æ³•ã€‚è¿™ä¸ªé€»è¾‘åœ¨sun.instrument.InstrumentationImpl ç±»ä¸­ï¼š\n\nInstrumentation ç±» å®šä¹‰å¦‚ä¸‹ï¼š\nCopypublic interface Instrumentation &#123;        //å¢åŠ ä¸€ä¸ªClass æ–‡ä»¶çš„è½¬æ¢å™¨ï¼Œè½¬æ¢å™¨ç”¨äºæ”¹å˜ Class äºŒè¿›åˆ¶æµçš„æ•°æ®ï¼Œå‚æ•° canRetransform è®¾ç½®æ˜¯å¦å…è®¸é‡æ–°è½¬æ¢ã€‚    void addTransformer(ClassFileTransformer transformer, boolean canRetransform);    //åœ¨ç±»åŠ è½½ä¹‹å‰ï¼Œé‡æ–°å®šä¹‰ Class æ–‡ä»¶ï¼ŒClassDefinition è¡¨ç¤ºå¯¹ä¸€ä¸ªç±»æ–°çš„å®šä¹‰ï¼Œå¦‚æœåœ¨ç±»åŠ è½½ä¹‹åï¼Œéœ€è¦ä½¿ç”¨ retransformClasses æ–¹æ³•é‡æ–°å®šä¹‰ã€‚addTransformeræ–¹æ³•é…ç½®ä¹‹åï¼Œåç»­çš„ç±»åŠ è½½éƒ½ä¼šè¢«Transformeræ‹¦æˆªã€‚å¯¹äºå·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œå¯ä»¥æ‰§è¡ŒretransformClassesæ¥é‡æ–°è§¦å‘è¿™ä¸ªTransformerçš„æ‹¦æˆªã€‚ç±»åŠ è½½çš„å­—èŠ‚ç è¢«ä¿®æ”¹åï¼Œé™¤éå†æ¬¡è¢«retransformï¼Œå¦åˆ™ä¸ä¼šæ¢å¤ã€‚    void addTransformer(ClassFileTransformer transformer);    //åˆ é™¤ä¸€ä¸ªç±»è½¬æ¢å™¨    boolean removeTransformer(ClassFileTransformer transformer);    boolean isRetransformClassesSupported();    //åœ¨ç±»åŠ è½½ä¹‹åï¼Œé‡æ–°å®šä¹‰ Classã€‚è¿™ä¸ªå¾ˆé‡è¦ï¼Œè¯¥æ–¹æ³•æ˜¯1.6 ä¹‹ååŠ å…¥çš„ï¼Œäº‹å®ä¸Šï¼Œè¯¥æ–¹æ³•æ˜¯ update äº†ä¸€ä¸ªç±»ã€‚    void retransformClasses(Class&lt;?&gt;... classes) throws UnmodifiableClassException;    boolean isRedefineClassesSupported();        void redefineClasses(ClassDefinition... definitions)        throws  ClassNotFoundException, UnmodifiableClassException;    boolean isModifiableClass(Class&lt;?&gt; theClass);    @SuppressWarnings(&quot;rawtypes&quot;)    Class[] getAllLoadedClasses();      @SuppressWarnings(&quot;rawtypes&quot;)    Class[] getInitiatedClasses(ClassLoader loader);    //è·å–ä¸€ä¸ªå¯¹è±¡çš„å¤§å°    long getObjectSize(Object objectToSize);       void appendToBootstrapClassLoaderSearch(JarFile jarfile);        void appendToSystemClassLoaderSearch(JarFile jarfile);        boolean isNativeMethodPrefixSupported();        void setNativeMethodPrefix(ClassFileTransformer transformer, String prefix);&#125;\n\næœ€ä¸ºé‡è¦çš„æ˜¯ä¸Šé¢æ³¨é‡Šçš„å‡ ä¸ªæ–¹æ³•ï¼Œä¸‹é¢æˆ‘ä»¬ä¼šç”¨åˆ°ã€‚\nå¦‚ä½•ä½¿ç”¨javaagentï¼Ÿ\nä½¿ç”¨ javaagent éœ€è¦å‡ ä¸ªæ­¥éª¤ï¼š\n\nå®šä¹‰ä¸€ä¸ª MANIFEST.MF æ–‡ä»¶ï¼Œå¿…é¡»åŒ…å« Premain-Class é€‰é¡¹ï¼Œé€šå¸¸ä¹Ÿä¼šåŠ å…¥Can-Redefine-Classes å’Œ Can-Retransform-Classes é€‰é¡¹ã€‚\nåˆ›å»ºä¸€ä¸ªPremain-Class æŒ‡å®šçš„ç±»ï¼Œç±»ä¸­åŒ…å« premain æ–¹æ³•ï¼Œæ–¹æ³•é€»è¾‘ç”±ç”¨æˆ·è‡ªå·±ç¡®å®šã€‚\nå°† premain çš„ç±»å’Œ MANIFEST.MF æ–‡ä»¶æ‰“æˆ jar åŒ…ã€‚\nä½¿ç”¨å‚æ•° -javaagent: jaråŒ…è·¯å¾„ å¯åŠ¨è¦ä»£ç†çš„æ–¹æ³•ã€‚\n\nåœ¨æ‰§è¡Œä»¥ä¸Šæ­¥éª¤åï¼ŒJVM ä¼šå…ˆæ‰§è¡Œ premain æ–¹æ³•ï¼Œå¤§éƒ¨åˆ†ç±»åŠ è½½éƒ½ä¼šé€šè¿‡è¯¥æ–¹æ³•ï¼Œæ³¨æ„ï¼šæ˜¯å¤§éƒ¨åˆ†ï¼Œä¸æ˜¯æ‰€æœ‰ã€‚å½“ç„¶ï¼Œé—æ¼çš„ä¸»è¦æ˜¯ç³»ç»Ÿç±»ï¼Œå› ä¸ºå¾ˆå¤šç³»ç»Ÿç±»å…ˆäº agent æ‰§è¡Œï¼Œè€Œç”¨æˆ·ç±»çš„åŠ è½½è‚¯å®šæ˜¯ä¼šè¢«æ‹¦æˆªçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åœ¨ main æ–¹æ³•å¯åŠ¨å‰æ‹¦æˆªå¤§éƒ¨åˆ†ç±»çš„åŠ è½½æ´»åŠ¨ï¼Œæ—¢ç„¶å¯ä»¥æ‹¦æˆªç±»çš„åŠ è½½ï¼Œé‚£ä¹ˆå°±å¯ä»¥å»åšé‡å†™ç±»è¿™æ ·çš„æ“ä½œï¼Œç»“åˆç¬¬ä¸‰æ–¹çš„å­—èŠ‚ç ç¼–è¯‘å·¥å…·ï¼Œæ¯”å¦‚ASMï¼Œjavassistï¼Œcglibç­‰ç­‰æ¥æ”¹å†™å®ç°ç±»ã€‚\né€šè¿‡ä¸Šé¢çš„æ­¥éª¤æˆ‘ä»¬ç”¨ä»£ç å®ç°æ¥å®ç°ã€‚å®ç° javaagent ä½ éœ€è¦æ­å»ºä¸¤ä¸ªå·¥ç¨‹ï¼Œä¸€ä¸ªå·¥ç¨‹æ˜¯ç”¨æ¥æ‰¿è½½ javaagentç±»ï¼Œå•ç‹¬çš„æ‰“æˆjaråŒ…ï¼›ä¸€ä¸ªå·¥ç¨‹æ˜¯javaagentéœ€è¦å»ä»£ç†çš„ç±»ã€‚å³javaagentä¼šåœ¨è¿™ä¸ªå·¥ç¨‹ä¸­çš„mainæ–¹æ³•å¯åŠ¨ä¹‹å‰å»åšä¸€äº›äº‹æƒ…ã€‚\n1.é¦–å…ˆæ¥å®ç°javaagentå·¥ç¨‹ã€‚\nå·¥ç¨‹ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š\nCopy-java-agent----src--------main--------|------java--------|----------com.rickiyang.learn--------|------------PreMainTraceAgent--------|resources-----------META-INF--------------MANIFEST.MF\n\nç¬¬ä¸€æ­¥æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªç±»ï¼ŒåŒ…å«premain æ–¹æ³•ï¼š\nCopyimport java.lang.instrument.ClassFileTransformer;import java.lang.instrument.IllegalClassFormatException;import java.lang.instrument.Instrumentation;import java.security.ProtectionDomain;/** * @author: rickiyang * @date: 2019/8/12 * @description: */public class PreMainTraceAgent &#123;    public static void premain(String agentArgs, Instrumentation inst) &#123;        System.out.println(&quot;agentArgs : &quot; + agentArgs);        inst.addTransformer(new DefineTransformer(), true);    &#125;    static class DefineTransformer implements ClassFileTransformer&#123;        @Override        public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;            System.out.println(&quot;premain load Class:&quot; + className);            return classfileBuffer;        &#125;    &#125;&#125;\n\nä¸Šé¢å°±æ˜¯æˆ‘å®ç°çš„ä¸€ä¸ªç±»ï¼Œå®ç°äº†å¸¦Instrumentationå‚æ•°çš„premain()æ–¹æ³•ã€‚è°ƒç”¨addTransformer()æ–¹æ³•å¯¹å¯åŠ¨æ—¶æ‰€æœ‰çš„ç±»è¿›è¡Œæ‹¦æˆªã€‚\nç„¶ååœ¨ resources ç›®å½•ä¸‹æ–°å»ºç›®å½•ï¼šMETA-INFï¼Œåœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºæ–‡ä»¶ï¼šMANIFREST.MFï¼š\nCopyManifest-Version: 1.0Can-Redefine-Classes: trueCan-Retransform-Classes: truePremain-Class: PreMainTraceAgent\n\næ³¨æ„åˆ°ç¬¬5è¡Œæœ‰ç©ºè¡Œã€‚\nè¯´ä¸€ä¸‹MANIFREST.MFæ–‡ä»¶çš„ä½œç”¨ï¼Œè¿™é‡Œå¦‚æœä½ ä¸å»æ‰‹åŠ¨æŒ‡å®šçš„è¯ï¼Œç›´æ¥ æ‰“åŒ…ï¼Œé»˜è®¤ä¼šåœ¨æ‰“åŒ…çš„æ–‡ä»¶ä¸­ç”Ÿæˆä¸€ä¸ªMANIFREST.MFæ–‡ä»¶ï¼š\nCopyManifest-Version: 1.0Implementation-Title: test-agentImplementation-Version: 0.0.1-SNAPSHOTBuilt-By: yangyueImplementation-Vendor-Id: com.rickiyang.learnSpring-Boot-Version: 2.0.9.RELEASEMain-Class: org.springframework.boot.loader.JarLauncherStart-Class: com.rickiyang.learn.LearnApplicationSpring-Boot-Classes: BOOT-INF/classes/Spring-Boot-Lib: BOOT-INF/lib/Created-By: Apache Maven 3.5.2Build-Jdk: 1.8.0_151Implementation-URL: https://projects.spring.io/spring-boot/#/spring-bo ot-starter-parent/test-agent\n\nè¿™æ˜¯é»˜è®¤çš„æ–‡ä»¶ï¼ŒåŒ…å«å½“å‰çš„ä¸€äº›ç‰ˆæœ¬ä¿¡æ¯ï¼Œå½“å‰å·¥ç¨‹çš„å¯åŠ¨ç±»ï¼Œå®ƒè¿˜æœ‰åˆ«çš„å‚æ•°å…è®¸ä½ åšæ›´å¤šçš„äº‹æƒ…ï¼Œå¯ä»¥ç”¨ä¸Šçš„æœ‰ï¼š\n\nPremain-Class ï¼šåŒ…å« premain æ–¹æ³•çš„ç±»ï¼ˆç±»çš„å…¨è·¯å¾„åï¼‰\nAgent-Class ï¼šåŒ…å« agentmain æ–¹æ³•çš„ç±»ï¼ˆç±»çš„å…¨è·¯å¾„åï¼‰\nBoot-Class-Path ï¼šè®¾ç½®å¼•å¯¼ç±»åŠ è½½å™¨æœç´¢çš„è·¯å¾„åˆ—è¡¨ã€‚æŸ¥æ‰¾ç±»çš„ç‰¹å®šäºå¹³å°çš„æœºåˆ¶å¤±è´¥åï¼Œå¼•å¯¼ç±»åŠ è½½å™¨ä¼šæœç´¢è¿™äº›è·¯å¾„ã€‚æŒ‰åˆ—å‡ºçš„é¡ºåºæœç´¢è·¯å¾„ã€‚åˆ—è¡¨ä¸­çš„è·¯å¾„ç”±ä¸€ä¸ªæˆ–å¤šä¸ªç©ºæ ¼åˆ†å¼€ã€‚è·¯å¾„ä½¿ç”¨åˆ†å±‚ URI çš„è·¯å¾„ç»„ä»¶è¯­æ³•ã€‚å¦‚æœè¯¥è·¯å¾„ä»¥æ–œæ å­—ç¬¦ï¼ˆâ€œ/â€ï¼‰å¼€å¤´ï¼Œåˆ™ä¸ºç»å¯¹è·¯å¾„ï¼Œå¦åˆ™ä¸ºç›¸å¯¹è·¯å¾„ã€‚ç›¸å¯¹è·¯å¾„æ ¹æ®ä»£ç† JAR æ–‡ä»¶çš„ç»å¯¹è·¯å¾„è§£æã€‚å¿½ç•¥æ ¼å¼ä¸æ­£ç¡®çš„è·¯å¾„å’Œä¸å­˜åœ¨çš„è·¯å¾„ã€‚å¦‚æœä»£ç†æ˜¯åœ¨ VM å¯åŠ¨ä¹‹åæŸä¸€æ—¶åˆ»å¯åŠ¨çš„ï¼Œåˆ™å¿½ç•¥ä¸è¡¨ç¤º JAR æ–‡ä»¶çš„è·¯å¾„ã€‚ï¼ˆå¯é€‰ï¼‰\nCan-Redefine-Classes ï¼štrueè¡¨ç¤ºèƒ½é‡å®šä¹‰æ­¤ä»£ç†æ‰€éœ€çš„ç±»ï¼Œé»˜è®¤å€¼ä¸º falseï¼ˆå¯é€‰ï¼‰\nCan-Retransform-Classes ï¼štrue è¡¨ç¤ºèƒ½é‡è½¬æ¢æ­¤ä»£ç†æ‰€éœ€çš„ç±»ï¼Œé»˜è®¤å€¼ä¸º false ï¼ˆå¯é€‰ï¼‰\nCan-Set-Native-Method-Prefixï¼š trueè¡¨ç¤ºèƒ½è®¾ç½®æ­¤ä»£ç†æ‰€éœ€çš„æœ¬æœºæ–¹æ³•å‰ç¼€ï¼Œé»˜è®¤å€¼ä¸º falseï¼ˆå¯é€‰ï¼‰\n\nå³åœ¨è¯¥æ–‡ä»¶ä¸­ä¸»è¦å®šä¹‰äº†ç¨‹åºè¿è¡Œç›¸å…³çš„é…ç½®ä¿¡æ¯ï¼Œç¨‹åºè¿è¡Œå‰ä¼šå…ˆæ£€æµ‹è¯¥æ–‡ä»¶ä¸­çš„é…ç½®é¡¹ã€‚\nä¸€ä¸ªjavaç¨‹åºä¸­-javaagentå‚æ•°çš„ä¸ªæ•°æ˜¯æ²¡æœ‰é™åˆ¶çš„ï¼Œæ‰€ä»¥å¯ä»¥æ·»åŠ ä»»æ„å¤šä¸ªjavaagentã€‚æ‰€æœ‰çš„java agentä¼šæŒ‰ç…§ä½ å®šä¹‰çš„é¡ºåºæ‰§è¡Œï¼Œä¾‹å¦‚ï¼š\nCopyjava -javaagent:agent1.jar -javaagent:agent2.jar -jar MyProgram.jar\n\nç¨‹åºæ‰§è¡Œçš„é¡ºåºå°†ä¼šæ˜¯ï¼š\nMyAgent1.premain -&gt; MyAgent2.premain -&gt; MyProgram.main\nè¯´å›ä¸Šé¢çš„ javaagentå·¥ç¨‹ï¼Œæ¥ä¸‹æ¥å°†è¯¥å·¥ç¨‹æ‰“æˆjaråŒ…ï¼Œæˆ‘åœ¨æ‰“åŒ…çš„æ—¶å€™å‘ç°æ‰“å®ŒåŒ…ä¹‹åçš„ MANIFREST.MFæ–‡ä»¶è¢«é»˜è®¤é…ç½®æ›¿æ¢æ‰äº†ã€‚æ‰€ä»¥æˆ‘æ˜¯æ‰‹åŠ¨å°†ä¸Šé¢æˆ‘çš„é…ç½®æ–‡ä»¶æ›¿æ¢åˆ°jaråŒ…ä¸­çš„æ–‡ä»¶ï¼Œè¿™é‡Œä½ éœ€è¦æ³¨æ„ã€‚\nå¦å¤–çš„å†è¯´ä¸€ç§ä¸å»æ‰‹åŠ¨å†™MANIFREST.MFæ–‡ä»¶çš„æ–¹å¼ï¼Œä½¿ç”¨mavenæ’ä»¶ï¼š\nCopy&lt;plugin&gt;    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;    &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;    &lt;version&gt;3.1.0&lt;/version&gt;    &lt;configuration&gt;        &lt;archive&gt;            &lt;!--è‡ªåŠ¨æ·»åŠ META-INF/MANIFEST.MF --&gt;            &lt;manifest&gt;                &lt;addClasspath&gt;true&lt;/addClasspath&gt;            &lt;/manifest&gt;            &lt;manifestEntries&gt;                &lt;Premain-Class&gt;com.rickiyang.learn.PreMainTraceAgent&lt;/Premain-Class&gt;                &lt;Agent-Class&gt;com.rickiyang.learn.PreMainTraceAgent&lt;/Agent-Class&gt;                &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;                &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt;            &lt;/manifestEntries&gt;        &lt;/archive&gt;    &lt;/configuration&gt;&lt;/plugin&gt;\n\nç”¨è¿™ç§æ’ä»¶çš„æ–¹å¼ä¹Ÿå¯ä»¥è‡ªåŠ¨ç”Ÿæˆè¯¥æ–‡ä»¶ã€‚\nagentä»£ç å°±å†™å®Œäº†ï¼Œä¸‹é¢å†é‡æ–°å¼€ä¸€ä¸ªå·¥ç¨‹ï¼Œä½ åªéœ€è¦å†™ä¸€ä¸ªå¸¦ main æ–¹æ³•çš„ç±»å³å¯ï¼š\nCopypublic class TestMain &#123;    public static void main(String[] args) &#123;        System.out.println(&quot;main start&quot;);        try &#123;            Thread.sleep(3000);        &#125; catch (InterruptedException e) &#123;            e.printStackTrace();        &#125;        System.out.println(&quot;main end&quot;);    &#125;&#125;\n\nå¾ˆç®€å•ï¼Œç„¶åéœ€è¦åšçš„å°±æ˜¯å°†ä¸Šé¢çš„ ä»£ç†ç±» å’Œ è¿™ä¸ªæµ‹è¯•ç±»å…³è”èµ·æ¥ã€‚æœ‰ä¸¤ç§æ–¹å¼ï¼š\nå¦‚æœä½ ç”¨çš„æ˜¯ideaï¼Œé‚£ä¹ˆä½ å¯ä»¥ç‚¹å‡»èœå•ï¼š run-debug configurationï¼Œç„¶åå°†ä½ çš„ä»£ç†ç±»åŒ… æŒ‡å®šåœ¨ å¯åŠ¨å‚æ•°ä¸­å³å¯ï¼š\n\nå¦ä¸€ç§æ–¹å¼æ˜¯ä¸ç”¨ ç¼–è¯‘å™¨ï¼Œé‡‡ç”¨å‘½ä»¤è¡Œçš„æ–¹æ³•ã€‚ä¸ä¸Šé¢å¤§è‡´ç›¸åŒï¼Œå°† ä¸Šé¢çš„æµ‹è¯•ç±»ç¼–è¯‘æˆ classæ–‡ä»¶ï¼Œç„¶å è¿è¡Œè¯¥ç±»å³å¯ï¼š\nCopy #å°†è¯¥ç±»ç¼–è¯‘æˆclassæ–‡ä»¶ &gt; javac TestMain.java  #æŒ‡å®šagentç¨‹åºå¹¶è¿è¡Œè¯¥ç±» &gt; java -javaagent:c:/alg.jar TestMain\n\nä½¿ç”¨ä¸Šé¢ä¸¤ç§æ–¹å¼éƒ½å¯ä»¥è¿è¡Œ,è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\nCopyD:\\soft\\jdk1.8\\bin\\java.exe -javaagent:c:/alg.jar &quot;-javaagent:D:\\soft\\IntelliJ IDEA 2019.1.1\\lib\\idea_rt.jar=54274:D:\\soft\\IntelliJ IDEA 2019.1.1\\bin&quot; -Dfile.encoding=UTF-8 -classpath D:\\soft\\jdk1.8\\jre\\lib\\charsets.jar;D:\\soft\\jdk1.8\\jre\\lib\\deploy.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\access-bridge-64.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\cldrdata.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\dnsns.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\jaccess.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\jfxrt.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\localedata.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\nashorn.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\sunec.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\sunjce_provider.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\sunmscapi.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\sunpkcs11.jar;D:\\soft\\jdk1.8\\jre\\lib\\ext\\zipfs.jar;D:\\soft\\jdk1.8\\jre\\lib\\javaws.jar;D:\\soft\\jdk1.8\\jre\\lib\\jce.jar;D:\\soft\\jdk1.8\\jre\\lib\\jfr.jar;D:\\soft\\jdk1.8\\jre\\lib\\jfxswt.jar;D:\\soft\\jdk1.8\\jre\\lib\\jsse.jar;D:\\soft\\jdk1.8\\jre\\lib\\management-agent.jar;D:\\soft\\jdk1.8\\jre\\lib\\plugin.jar;D:\\soft\\jdk1.8\\jre\\lib\\resources.jar;D:\\soft\\jdk1.8\\jre\\lib\\rt.jar;D:\\workspace\\demo1\\target\\classes;E:\\.m2\\repository\\org\\springframework\\boot\\spring-boot-starter-aop\\2.1.1.RELEASE\\spring-.........1.8.11.jar;E:\\.m2\\repository\\com\\google\\guava\\guava\\20.0\\guava-20.0.jar;E:\\.m2\\repository\\org\\apache\\commons\\commons-lang3\\3.7\\commons-lang3-3.7.jar;E:\\.m2\\repository\\com\\alibaba\\fastjson\\1.2.54\\fastjson-1.2.54.jar;E:\\.m2\\repository\\org\\springframework\\boot\\spring-boot\\2.1.0.RELEASE\\spring-boot-2.1.0.RELEASE.jar;E:\\.m2\\repository\\org\\springframework\\spring-context\\5.1.3.RELEASE\\spring-context-5.1.3.RELEASE.jar com.springboot.example.demo.service.TestMainagentArgs : nullpremain load Class     :java/util/concurrent/ConcurrentHashMap$ForwardingNodepremain load Class     :sun/nio/cs/ThreadLocalCoderspremain load Class     :sun/nio/cs/ThreadLocalCoders$1premain load Class     :sun/nio/cs/ThreadLocalCoders$Cachepremain load Class     :sun/nio/cs/ThreadLocalCoders$2premain load Class     :java/util/jar/Attributespremain load Class     :java/util/jar/Manifest$FastInputStream.........premain load Class     :java/lang/Class$MethodArraypremain load Class     :java/lang/Voidmain startpremain load Class     :sun/misc/VMSupportpremain load Class     :java/util/Hashtable$KeySetpremain load Class     :sun/nio/cs/ISO_8859_1$Encoderpremain load Class     :sun/nio/cs/Surrogate$Parserpremain load Class     :sun/nio/cs/Surrogate.........premain load Class     :sun/util/locale/provider/LocaleResources$ResourceReferencemain endpremain load Class     :java/lang/Shutdownpremain load Class     :java/lang/Shutdown$LockProcess finished with exit code 0\n\nä¸Šé¢çš„è¾“å‡ºç»“æœæˆ‘ä»¬èƒ½å¤Ÿå‘ç°ï¼š\n\næ‰§è¡Œmainæ–¹æ³•ä¹‹å‰ä¼šåŠ è½½æ‰€æœ‰çš„ç±»ï¼ŒåŒ…æ‹¬ç³»ç»Ÿç±»å’Œè‡ªå®šä¹‰ç±»ï¼›\nåœ¨ClassFileTransformerä¸­ä¼šå»æ‹¦æˆªç³»ç»Ÿç±»å’Œè‡ªå·±å®ç°çš„ç±»å¯¹è±¡ï¼›\nå¦‚æœä½ æœ‰å¯¹æŸäº›ç±»å¯¹è±¡è¿›è¡Œæ”¹å†™ï¼Œé‚£ä¹ˆåœ¨æ‹¦æˆªçš„æ—¶å€™æŠ“ä½è¯¥ç±»ä½¿ç”¨å­—èŠ‚ç ç¼–è¯‘å·¥å…·å³å¯å®ç°ã€‚\n\nä¸‹é¢æ˜¯ä½¿ç”¨javassistæ¥åŠ¨æ€å°†æŸä¸ªæ–¹æ³•æ›¿æ¢æ‰ï¼š\nCopypackage com.rickiyang.learn;import javassist.*;import java.io.IOException;import java.lang.instrument.ClassFileTransformer;import java.security.ProtectionDomain;/** * @author rickiyang * @date 2019-08-06 * @Desc */public class MyClassTransformer implements ClassFileTransformer &#123;    @Override    public byte[] transform(final ClassLoader loader, final String className, final Class&lt;?&gt; classBeingRedefined,final ProtectionDomain protectionDomain, final byte[] classfileBuffer) &#123;        // æ“ä½œDateç±»        if (&quot;java/util/Date&quot;.equals(className)) &#123;            try &#123;                // ä»ClassPoolè·å¾—CtClasså¯¹è±¡                final ClassPool classPool = ClassPool.getDefault();                final CtClass clazz = classPool.get(&quot;java.util.Date&quot;);                CtMethod convertToAbbr = clazz.getDeclaredMethod(&quot;convertToAbbr&quot;);                //è¿™é‡Œå¯¹ java.util.Date.convertToAbbr() æ–¹æ³•è¿›è¡Œäº†æ”¹å†™ï¼Œåœ¨ returnä¹‹å‰å¢åŠ äº†ä¸€ä¸ª æ‰“å°æ“ä½œ                String methodBody = &quot;&#123;sb.append(Character.toUpperCase(name.charAt(0)));&quot; +                        &quot;sb.append(name.charAt(1)).append(name.charAt(2));&quot; +                        &quot;System.out.println(\\&quot;sb.toString()\\&quot;);&quot; +                        &quot;return sb;&#125;&quot;;                convertToAbbr.setBody(methodBody);                // è¿”å›å­—èŠ‚ç ï¼Œå¹¶ä¸”detachCtClasså¯¹è±¡                byte[] byteCode = clazz.toBytecode();                //detachçš„æ„æ€æ˜¯å°†å†…å­˜ä¸­æ›¾ç»è¢«javassiståŠ è½½è¿‡çš„Dateå¯¹è±¡ç§»é™¤ï¼Œå¦‚æœä¸‹æ¬¡æœ‰éœ€è¦åœ¨å†…å­˜ä¸­æ‰¾ä¸åˆ°ä¼šé‡æ–°èµ°javassiståŠ è½½                clazz.detach();                return byteCode;            &#125; catch (Exception ex) &#123;                ex.printStackTrace();            &#125;        &#125;        // å¦‚æœè¿”å›nullåˆ™å­—èŠ‚ç ä¸ä¼šè¢«ä¿®æ”¹        return null;    &#125;&#125;\n\nJVMå¯åŠ¨ååŠ¨æ€Instrumentä¸Šé¢ä»‹ç»çš„Instrumentationæ˜¯åœ¨ JDK 1.5ä¸­æä¾›çš„ï¼Œå¼€å‘è€…åªèƒ½åœ¨mainåŠ è½½ä¹‹å‰æ·»åŠ æ‰‹è„šï¼Œåœ¨ Java SE 6 çš„ Instrumentation å½“ä¸­ï¼Œæä¾›äº†ä¸€ä¸ªæ–°çš„ä»£ç†æ“ä½œæ–¹æ³•ï¼šagentmainï¼Œå¯ä»¥åœ¨ main å‡½æ•°å¼€å§‹è¿è¡Œä¹‹åå†è¿è¡Œã€‚\nè·Ÿpremainå‡½æ•°ä¸€æ ·ï¼Œ å¼€å‘è€…å¯ä»¥ç¼–å†™ä¸€ä¸ªå«æœ‰agentmainå‡½æ•°çš„ Java ç±»ï¼š\nCopy//é‡‡ç”¨attachæœºåˆ¶ï¼Œè¢«ä»£ç†çš„ç›®æ ‡ç¨‹åºVMæœ‰å¯èƒ½å¾ˆæ—©ä¹‹å‰å·²ç»å¯åŠ¨ï¼Œå½“ç„¶å…¶æ‰€æœ‰ç±»å·²ç»è¢«åŠ è½½å®Œæˆï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å€ŸåŠ©Instrumentation#retransformClasses(Class&lt;?&gt;... classes)è®©å¯¹åº”çš„ç±»å¯ä»¥é‡æ–°è½¬æ¢ï¼Œä»è€Œæ¿€æ´»é‡æ–°è½¬æ¢çš„ç±»æ‰§è¡ŒClassFileTransformeråˆ—è¡¨ä¸­çš„å›è°ƒpublic static void agentmain (String agentArgs, Instrumentation inst)public static void agentmain (String agentArgs)\n\nåŒæ ·ï¼Œagentmain æ–¹æ³•ä¸­å¸¦Instrumentationå‚æ•°çš„æ–¹æ³•ä¹Ÿæ¯”ä¸å¸¦ä¼˜å…ˆçº§æ›´é«˜ã€‚å¼€å‘è€…å¿…é¡»åœ¨ manifest æ–‡ä»¶é‡Œé¢è®¾ç½®â€œAgent-Classâ€æ¥æŒ‡å®šåŒ…å« agentmain å‡½æ•°çš„ç±»ã€‚\nåœ¨Java6 ä»¥åå®ç°å¯åŠ¨ååŠ è½½çš„æ–°å®ç°æ˜¯Attach apiã€‚Attach API å¾ˆç®€å•ï¼Œåªæœ‰ 2 ä¸ªä¸»è¦çš„ç±»ï¼Œéƒ½åœ¨ com.sun.tools.attach åŒ…é‡Œé¢ï¼š\n\n\nVirtualMachine å­—é¢æ„ä¹‰è¡¨ç¤ºä¸€ä¸ªJava è™šæ‹Ÿæœºï¼Œä¹Ÿå°±æ˜¯ç¨‹åºéœ€è¦ç›‘æ§çš„ç›®æ ‡è™šæ‹Ÿæœºï¼Œæä¾›äº†è·å–ç³»ç»Ÿä¿¡æ¯(æ¯”å¦‚è·å–å†…å­˜dumpã€çº¿ç¨‹dumpï¼Œç±»ä¿¡æ¯ç»Ÿè®¡(æ¯”å¦‚å·²åŠ è½½çš„ç±»ä»¥åŠå®ä¾‹ä¸ªæ•°ç­‰)ï¼Œ loadAgentï¼ŒAttach å’Œ Detach ï¼ˆAttach åŠ¨ä½œçš„ç›¸åè¡Œä¸ºï¼Œä» JVM ä¸Šé¢è§£é™¤ä¸€ä¸ªä»£ç†ï¼‰ç­‰æ–¹æ³•ï¼Œå¯ä»¥å®ç°çš„åŠŸèƒ½å¯ä»¥è¯´éå¸¸ä¹‹å¼ºå¤§ ã€‚è¯¥ç±»å…è®¸æˆ‘ä»¬é€šè¿‡ç»™attachæ–¹æ³•ä¼ å…¥ä¸€ä¸ªjvmçš„pid(è¿›ç¨‹id)ï¼Œè¿œç¨‹è¿æ¥åˆ°jvmä¸Š ã€‚\nä»£ç†ç±»æ³¨å…¥æ“ä½œåªæ˜¯å®ƒä¼—å¤šåŠŸèƒ½ä¸­çš„ä¸€ä¸ªï¼Œé€šè¿‡loadAgentæ–¹æ³•å‘jvmæ³¨å†Œä¸€ä¸ªä»£ç†ç¨‹åºagentï¼Œåœ¨è¯¥agentçš„ä»£ç†ç¨‹åºä¸­ä¼šå¾—åˆ°ä¸€ä¸ªInstrumentationå®ä¾‹ï¼Œè¯¥å®ä¾‹å¯ä»¥ åœ¨classåŠ è½½å‰æ”¹å˜classçš„å­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥åœ¨classåŠ è½½åé‡æ–°åŠ è½½ã€‚åœ¨è°ƒç”¨Instrumentationå®ä¾‹çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•ä¼šä½¿ç”¨ClassFileTransformeræ¥å£ä¸­æä¾›çš„æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚\n\nVirtualMachineDescriptor åˆ™æ˜¯ä¸€ä¸ªæè¿°è™šæ‹Ÿæœºçš„å®¹å™¨ç±»ï¼Œé…åˆ VirtualMachine ç±»å®Œæˆå„ç§åŠŸèƒ½ã€‚\n\n\nattachå®ç°åŠ¨æ€æ³¨å…¥çš„åŸç†å¦‚ä¸‹ï¼š\né€šè¿‡VirtualMachineç±»çš„attach(pid)æ–¹æ³•ï¼Œä¾¿å¯ä»¥attachåˆ°ä¸€ä¸ªè¿è¡Œä¸­çš„javaè¿›ç¨‹ä¸Šï¼Œä¹‹åä¾¿å¯ä»¥é€šè¿‡loadAgent(agentJarPath)æ¥å°†agentçš„jaråŒ…æ³¨å…¥åˆ°å¯¹åº”çš„è¿›ç¨‹ï¼Œç„¶åå¯¹åº”çš„è¿›ç¨‹ä¼šè°ƒç”¨agentmainæ–¹æ³•ã€‚\n\næ—¢ç„¶æ˜¯ä¸¤ä¸ªè¿›ç¨‹ä¹‹é—´é€šä¿¡é‚£è‚¯å®šçš„å»ºç«‹èµ·è¿æ¥ï¼ŒVirtualMachine.attachåŠ¨ä½œç±»ä¼¼TCPåˆ›å»ºè¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œç›®çš„å°±æ˜¯æ­å»ºattaché€šä¿¡çš„è¿æ¥ã€‚è€Œåé¢æ‰§è¡Œçš„æ“ä½œï¼Œä¾‹å¦‚vm.loadAgentï¼Œå…¶å®å°±æ˜¯å‘è¿™ä¸ªsocketå†™å…¥æ•°æ®æµï¼Œæ¥æ”¶æ–¹target VMä¼šé’ˆå¯¹ä¸åŒçš„ä¼ å…¥æ•°æ®æ¥åšä¸åŒçš„å¤„ç†ã€‚\næˆ‘ä»¬æ¥æµ‹è¯•ä¸€ä¸‹agentmainçš„ä½¿ç”¨ï¼š\nå·¥ç¨‹ç»“æ„å’Œ ä¸Šé¢premainçš„æµ‹è¯•ä¸€æ ·ï¼Œç¼–å†™AgentMainTestï¼Œç„¶åä½¿ç”¨mavenæ’ä»¶æ‰“åŒ… ç”ŸæˆMANIFEST.MFã€‚\nCopypackage com.rickiyang.learn;import java.lang.instrument.ClassFileTransformer;import java.lang.instrument.IllegalClassFormatException;import java.lang.instrument.Instrumentation;import java.security.ProtectionDomain;/** * @author rickiyang * @date 2019-08-16 * @Desc */public class AgentMainTest &#123;    public static void agentmain(String agentArgs, Instrumentation instrumentation) &#123;        instrumentation.addTransformer(new DefineTransformer(), true);    &#125;        static class DefineTransformer implements ClassFileTransformer &#123;        @Override        public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) throws IllegalClassFormatException &#123;            System.out.println(&quot;premain load Class:&quot; + className);            return classfileBuffer;        &#125;    &#125;&#125;Copy&lt;plugin&gt;  &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;  &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt;  &lt;version&gt;3.1.0&lt;/version&gt;  &lt;configuration&gt;    &lt;archive&gt;      &lt;!--è‡ªåŠ¨æ·»åŠ META-INF/MANIFEST.MF --&gt;      &lt;manifest&gt;        &lt;addClasspath&gt;true&lt;/addClasspath&gt;      &lt;/manifest&gt;      &lt;manifestEntries&gt;        &lt;Agent-Class&gt;com.rickiyang.learn.AgentMainTest&lt;/Agent-Class&gt;        &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt;        &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt;      &lt;/manifestEntries&gt;    &lt;/archive&gt;  &lt;/configuration&gt;&lt;/plugin&gt;\n\nå°†agentæ‰“åŒ…ä¹‹åï¼Œå°±æ˜¯ç¼–å†™æµ‹è¯•mainæ–¹æ³•ã€‚ä¸Šé¢æˆ‘ä»¬ç”»çš„å›¾ä¸­çš„æ­¥éª¤æ˜¯ï¼šä»ä¸€ä¸ªattach JVMå»æ¢æµ‹ç›®æ ‡JVMï¼Œå¦‚æœç›®æ ‡JVMå­˜åœ¨åˆ™å‘å®ƒå‘é€agent.jarã€‚æˆ‘æµ‹è¯•å†™çš„ç®€å•äº†äº›ï¼Œæ‰¾åˆ°å½“å‰JVMå¹¶åŠ è½½agent.jarã€‚\nCopypackage com.rickiyang.learn.job;import com.sun.tools.attach.*;import java.io.IOException;import java.util.List;/** * @author rickiyang * @date 2019-08-16 * @Desc */public class TestAgentMain &#123;    public static void main(String[] args) throws IOException, AttachNotSupportedException, AgentLoadException, AgentInitializationException &#123;        //è·å–å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰ è¿è¡Œä¸­çš„ è™šæ‹Ÿæœº        System.out.println(&quot;running JVM start &quot;);        List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();        for (VirtualMachineDescriptor vmd : list) &#123;            //å¦‚æœè™šæ‹Ÿæœºçš„åç§°ä¸º xxx åˆ™ è¯¥è™šæ‹Ÿæœºä¸ºç›®æ ‡è™šæ‹Ÿæœºï¼Œè·å–è¯¥è™šæ‹Ÿæœºçš„ pid            //ç„¶ååŠ è½½ agent.jar å‘é€ç»™è¯¥è™šæ‹Ÿæœº            System.out.println(vmd.displayName());            if (vmd.displayName().endsWith(&quot;com.rickiyang.learn.job.TestAgentMain&quot;)) &#123;                VirtualMachine virtualMachine = VirtualMachine.attach(vmd.id());                virtualMachine.loadAgent(&quot;/Users/yangyue/Documents/java-agent.jar&quot;);                virtualMachine.detach();            &#125;        &#125;    &#125;&#125;\n\nlist()æ–¹æ³•ä¼šå»å¯»æ‰¾å½“å‰ç³»ç»Ÿä¸­æ‰€æœ‰è¿è¡Œç€çš„JVMè¿›ç¨‹ï¼Œä½ å¯ä»¥æ‰“å°vmd.displayName()çœ‹åˆ°å½“å‰ç³»ç»Ÿéƒ½æœ‰å“ªäº›JVMè¿›ç¨‹åœ¨è¿è¡Œã€‚å› ä¸ºmainå‡½æ•°æ‰§è¡Œèµ·æ¥çš„æ—¶å€™è¿›ç¨‹åä¸ºå½“å‰ç±»åï¼Œæ‰€ä»¥é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥å»æ‰¾åˆ°å½“å‰çš„è¿›ç¨‹idã€‚\næ³¨æ„ï¼šåœ¨macä¸Šå®‰è£…äº†çš„jdkæ˜¯èƒ½ç›´æ¥æ‰¾åˆ° VirtualMachine ç±»çš„ï¼Œä½†æ˜¯åœ¨windowsä¸­å®‰è£…çš„jdkæ— æ³•æ‰¾åˆ°ï¼Œå¦‚æœä½ é‡åˆ°è¿™ç§æƒ…å†µï¼Œè¯·æ‰‹åŠ¨å°†ä½ jdkå®‰è£…ç›®å½•ä¸‹ï¼šlibç›®å½•ä¸­çš„tools.jaræ·»åŠ è¿›å½“å‰å·¥ç¨‹çš„Librariesä¸­ã€‚\nè¿è¡Œmainæ–¹æ³•çš„è¾“å‡ºä¸ºï¼š\n\nå¯ä»¥çœ‹åˆ°å®é™…ä¸Šæ˜¯å¯åŠ¨äº†ä¸€ä¸ªsocketè¿›ç¨‹å»ä¼ è¾“agent.jarã€‚å…ˆæ‰“å°äº†â€œrunning JVM startâ€è¡¨åmainæ–¹æ³•æ˜¯å…ˆå¯åŠ¨äº†ï¼Œç„¶åæ‰è¿›å…¥ä»£ç†ç±»çš„transformæ–¹æ³•ã€‚\ninstrumentåŸç†instrumentçš„åº•å±‚å®ç°ä¾èµ–äºJVMTI(JVM Tool Interface)ï¼Œå®ƒæ˜¯JVMæš´éœ²å‡ºæ¥çš„ä¸€äº›ä¾›ç”¨æˆ·æ‰©å±•çš„æ¥å£é›†åˆï¼ŒJVMTIæ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ï¼ŒJVMæ¯æ‰§è¡Œåˆ°ä¸€å®šçš„é€»è¾‘å°±ä¼šè°ƒç”¨ä¸€äº›äº‹ä»¶çš„å›è°ƒæ¥å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œè¿™äº›æ¥å£å¯ä»¥ä¾›å¼€å‘è€…å»æ‰©å±•è‡ªå·±çš„é€»è¾‘ã€‚JVMTIAgentæ˜¯ä¸€ä¸ªåˆ©ç”¨JVMTIæš´éœ²å‡ºæ¥çš„æ¥å£æä¾›äº†ä»£ç†å¯åŠ¨æ—¶åŠ è½½(agent on load)ã€ä»£ç†é€šè¿‡attachå½¢å¼åŠ è½½(agent on attach)å’Œä»£ç†å¸è½½(agent on unload)åŠŸèƒ½çš„åŠ¨æ€åº“ã€‚è€Œinstrument agentå¯ä»¥ç†è§£ä¸ºä¸€ç±»JVMTIAgentåŠ¨æ€åº“ï¼Œåˆ«åæ˜¯JPLISAgent(Java Programming Language Instrumentation Services Agent)ï¼Œä¹Ÿå°±æ˜¯ä¸“é—¨ä¸ºjavaè¯­è¨€ç¼–å†™çš„æ’æ¡©æœåŠ¡æä¾›æ”¯æŒçš„ä»£ç†ã€‚\nå¯åŠ¨æ—¶åŠ è½½instrument agentè¿‡ç¨‹ï¼š\nåˆ›å»ºå¹¶åˆå§‹åŒ– JPLISAgentï¼›\nç›‘å¬ VMInit äº‹ä»¶ï¼Œåœ¨ JVM åˆå§‹åŒ–å®Œæˆä¹‹ååšä¸‹é¢çš„äº‹æƒ…ï¼š\nåˆ›å»º InstrumentationImpl å¯¹è±¡ ï¼›\nç›‘å¬ ClassFileLoadHook äº‹ä»¶ ï¼›\nè°ƒç”¨ InstrumentationImpl çš„loadClassAndCallPremainæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œä¼šå»è°ƒç”¨ javaagent ä¸­ MANIFEST.MF é‡ŒæŒ‡å®šçš„Premain-Class ç±»çš„ premain æ–¹æ³• ï¼›\n\n\nè§£æ javaagent ä¸­ MANIFEST.MF æ–‡ä»¶çš„å‚æ•°ï¼Œå¹¶æ ¹æ®è¿™äº›å‚æ•°æ¥è®¾ç½® JPLISAgent é‡Œçš„ä¸€äº›å†…å®¹ã€‚\n\nè¿è¡Œæ—¶åŠ è½½instrument agentè¿‡ç¨‹ï¼šé€šè¿‡ JVM çš„attachæœºåˆ¶æ¥è¯·æ±‚ç›®æ ‡ JVM åŠ è½½å¯¹åº”çš„agentï¼Œè¿‡ç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\n\nåˆ›å»ºå¹¶åˆå§‹åŒ–JPLISAgentï¼›\nè§£æ javaagent é‡Œ MANIFEST.MF é‡Œçš„å‚æ•°ï¼›\nåˆ›å»º InstrumentationImpl å¯¹è±¡ï¼›\nç›‘å¬ ClassFileLoadHook äº‹ä»¶ï¼›\nè°ƒç”¨ InstrumentationImpl çš„loadClassAndCallAgentmainæ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œä¼šå»è°ƒç”¨javaagenté‡Œ MANIFEST.MF é‡ŒæŒ‡å®šçš„Agent-Classç±»çš„agentmainæ–¹æ³•ã€‚\n\nInstrumentationçš„å±€é™æ€§å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨Instrumentationéƒ½æ˜¯ä½¿ç”¨å…¶å­—èŠ‚ç æ’æ¡©çš„åŠŸèƒ½ï¼Œæˆ–è€…ç¬¼ç»Ÿè¯´å°±æ˜¯ç±»é‡å®šä¹‰(Class Redefine)çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹çš„å±€é™æ€§ï¼š\n\npremainå’Œagentmainä¸¤ç§æ–¹å¼ä¿®æ”¹å­—èŠ‚ç çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»è¦å¸¦æœ‰Classç±»å‹çš„å‚æ•°ï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚\nç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢(Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰Instrumentation#redefineClasses()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š\næ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒï¼›\næ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£ï¼›\næ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´ï¼›\næ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯private static/finalä¿®é¥°çš„ï¼›\nå¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“ã€‚\n\n\n\né™¤äº†ä¸Šé¢çš„æ–¹å¼ï¼Œå¦‚æœæƒ³è¦é‡æ–°å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¯ä»¥è€ƒè™‘åŸºäºç±»åŠ è½½å™¨éš”ç¦»çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»é€šè¿‡æ–°çš„å­—èŠ‚ç å»å®šä¹‰ä¸€ä¸ªå…¨æ–°çš„ç±»ï¼Œä¸è¿‡ä¹Ÿå­˜åœ¨åªèƒ½é€šè¿‡åå°„è°ƒç”¨è¯¥å…¨æ–°ç±»çš„å±€é™æ€§ã€‚\n","categories":["Java"]},{"title":"ReentrantLock å®ç°åŒçº¿ç¨‹é¡ºåºæ‰“å°1-100","url":"/posts/53751/","content":"ä½¿ç”¨ ReentrantLock å®ç°åŒçº¿ç¨‹é¡ºåºæ‰“å°1-100\n\n\nimport java.util.concurrent.locks.Condition;import java.util.concurrent.locks.ReentrantLock;public class Test &#123;    private static ReentrantLock lock = new ReentrantLock();    private static Condition even = lock.newCondition();    private static Condition odd = lock.newCondition();    private static boolean flag = true;    public static void main(String[] args) throws InterruptedException &#123;        Thread aThread = new Thread(() -&gt; &#123;            try &#123;                lock.lock();                if (flag) &#123;                    even.await();                &#125;                lock.unlock();                for (int i = 2; i &lt;= 100; i += 2) &#123;                    lock.lock();                    System.out.println(i);                    odd.signal();                    even.await();                    lock.unlock();                &#125;            &#125; catch (Exception e) &#123;            &#125;            System.out.println(&quot;even end&quot;);        &#125;);        Thread bThread = new Thread(() -&gt; &#123;            try &#123;                for (int i = 1; i &lt; 100; i += 2) &#123;                    lock.lock();                    if (flag) &#123;                        flag = false;                    &#125;                    System.out.println(i);                    even.signal();                    odd.await();                    lock.unlock();                &#125;            &#125; catch (Exception e) &#123;            &#125;            lock.lock();            even.signal();            lock.unlock();            System.out.println(&quot;odd end&quot;);        &#125;);        aThread.start();        bThread.start();        aThread.join();    &#125;&#125;\n\n","categories":["Java"]},{"title":"byteä¸ºä»€ä¹ˆè¦ä¸ä¸Š0xffï¼Ÿ","url":"/posts/37071/","content":"æ— æ„é—´ç¿»çœ‹ä¹‹é—´çš„ä»£ç ï¼Œå‘ç°äº†ä¸€æ®µéš¾ä»¥ç†è§£çš„ä»£ç ã€‚\nbyte[] bs = digest.digest(origin.getBytes(Charset.forName(charsetName))) ;  for (int i = 0; i &lt; bs.length; i++) &#123;    int c = bs[i] &amp; 0xFF ;  if(c &lt; 16)&#123;     sb.append(&quot;0&quot;);    &#125;    sb.append(Integer.toHexString(c)) ;  &#125;  return sb.toString() ;\n\nbsæ˜¯ç”±ä¸€æ®µå­—ç¬¦ä¸²ç»è¿‡MD5åŠ å¯†åï¼Œè¾“å‡ºçš„byteæ•°ç»„ã€‚æˆ‘èµ·åˆéš¾ä»¥ç†è§£ä¸ºä»€ä¹ˆåœ¨æ¥ä¸‹æ¥çš„å¾ªç¯ä¸­è¦å°†bs[i]&amp;oxFFå†å¤åˆ¶ç»™intç±»å‹å‘¢ï¼Ÿ\nbs[i]æ˜¯8ä½äºŒè¿›åˆ¶ï¼Œ0xFFè½¬åŒ–æˆ8ä½äºŒè¿›åˆ¶å°±æ˜¯11111111ï¼Œé‚£ä¹ˆbs[i]&amp;0xFFä¸æ˜¯è¿˜æ˜¯bs[i]æœ¬èº«å—ï¼Ÿæœ‰æ„æ€å—ï¼Ÿ\nåæ¥æˆ‘åˆå†™äº†ä¸€ä¸ªdemo\npublic class Test &#123;    public static void main(String[] args) &#123;        byte[] a = new byte[10];        a[0]= -127;        System.out.println(a[0]);        int c = a[0]&amp;0xff;        System.out.println(c);    &#125;&#125;\n\næˆ‘å…ˆæ‰“å°a[0],åœ¨æ‰“å°a[0]&amp;0xffåçš„å€¼ï¼Œæœ¬æ¥æˆ‘æƒ³ç»“æœåº”è¯¥éƒ½æ˜¯-127\nä½†æ˜¯ç»“æœçœŸçš„æ˜¯å‡ºäººæ„æ–™å•Šï¼\n\n-127\n129\n\nåˆ°åº•æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ&amp;0xffåè€Œä¸å¯¹äº†ã€‚\næ¥¼ä¸»çœŸçš„æ˜¯ä¸æ‡‚å•Šï¼Œåæ¥å¾€è¡¥ç é‚£ä¸ªæ–¹å‘æƒ³äº†æƒ³ã€‚\nè®°å¾—åœ¨å­¦è®¡ç®—æœºåŸç†çš„æ—¶å€™ï¼Œäº†è§£åˆ°è®¡ç®—æœºå†…çš„å­˜å‚¨éƒ½æ˜¯åˆ©ç”¨äºŒè¿›åˆ¶çš„è¡¥ç è¿›è¡Œå­˜å‚¨çš„ã€‚\nåŸç ã€åç ã€è¡¥ç å¯¹äºæ­£æ•°ï¼ˆ00000001ï¼‰åŸç æ¥è¯´ï¼Œé¦–ä½è¡¨ç¤ºç¬¦å·ä½ï¼Œåç  è¡¥ç éƒ½æ˜¯æœ¬èº«\nå¯¹äºè´Ÿæ•°ï¼ˆ100000001ï¼‰åŸç æ¥è¯´ï¼Œåç æ˜¯å¯¹åŸç é™¤äº†ç¬¦å·ä½ä¹‹å¤–ä½œå–åè¿ç®—å³ï¼ˆ111111110ï¼‰ï¼Œè¡¥ç æ˜¯å¯¹åç ä½œ+1è¿ç®—å³ï¼ˆ111111111ï¼‰\nå½“å°†-127èµ‹å€¼ç»™a[0]æ—¶å€™ï¼Œa[0]ä½œä¸ºä¸€ä¸ªbyteç±»å‹ï¼Œå…¶è®¡ç®—æœºå­˜å‚¨çš„è¡¥ç æ˜¯10000001ï¼ˆ8ä½ï¼‰ã€‚\nå°†a[0] ä½œä¸ºintç±»å‹å‘æ§åˆ¶å°è¾“å‡ºçš„æ—¶å€™ï¼Œjvmä½œäº†ä¸€ä¸ªè¡¥ä½çš„å¤„ç†ï¼Œå› ä¸ºintç±»å‹æ˜¯32ä½æ‰€ä»¥è¡¥ä½åçš„è¡¥ç å°±æ˜¯1111111111111111111111111 10000001ï¼ˆ32ä½ï¼‰ï¼Œè¿™ä¸ª32ä½äºŒè¿›åˆ¶è¡¥ç è¡¨ç¤ºçš„ä¹Ÿæ˜¯-127.\nå‘ç°æ²¡æœ‰ï¼Œè™½ç„¶byte-&gt;intè®¡ç®—æœºèƒŒåå­˜å‚¨çš„äºŒè¿›åˆ¶è¡¥ç ç”±10000001ï¼ˆ8ä½ï¼‰è½¬åŒ–æˆäº†1111111111111111111111111 10000001ï¼ˆ32ä½ï¼‰å¾ˆæ˜¾ç„¶è¿™ä¸¤ä¸ªè¡¥ç è¡¨ç¤ºçš„åè¿›åˆ¶æ•°å­—ä¾ç„¶æ˜¯ç›¸åŒçš„ã€‚\nä½†æ˜¯æˆ‘åšbyte-&gt;intçš„è½¬åŒ– æ‰€æœ‰æ—¶å€™éƒ½åªæ˜¯ä¸ºäº†ä¿æŒ åè¿›åˆ¶çš„ä¸€è‡´æ€§å—ï¼Ÿ\nä¸ä¸€å®šå§ï¼Ÿå¥½æ¯”æˆ‘ä»¬æ‹¿åˆ°çš„æ–‡ä»¶æµè½¬æˆbyteæ•°ç»„ï¼Œéš¾é“æˆ‘ä»¬å…³å¿ƒçš„æ˜¯byteæ•°ç»„çš„åè¿›åˆ¶çš„å€¼æ˜¯å¤šå°‘å—ï¼Ÿæˆ‘ä»¬å…³å¿ƒçš„æ˜¯å…¶èƒŒåäºŒè¿›åˆ¶å­˜å‚¨çš„è¡¥ç å§\næ‰€ä»¥å¤§å®¶åº”è¯¥èƒ½çŒœåˆ°ä¸ºä»€ä¹ˆbyteç±»å‹çš„æ•°å­—è¦&amp;0xffå†èµ‹å€¼ç»™intç±»å‹ï¼Œå…¶æœ¬è´¨åŸå› å°±æ˜¯æƒ³ä¿æŒäºŒè¿›åˆ¶è¡¥ç çš„ä¸€è‡´æ€§ã€‚\nå½“byteè¦è½¬åŒ–ä¸ºintçš„æ—¶å€™ï¼Œé«˜çš„24ä½å¿…ç„¶ä¼šè¡¥1ï¼Œè¿™æ ·ï¼Œå…¶äºŒè¿›åˆ¶è¡¥ç å…¶å®å·²ç»ä¸ä¸€è‡´äº†ï¼Œ&amp;0xffå¯ä»¥å°†é«˜çš„24ä½ç½®ä¸º0ï¼Œä½8ä½ä¿æŒåŸæ ·ã€‚è¿™æ ·åšçš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿è¯äºŒè¿›åˆ¶æ•°æ®çš„ä¸€è‡´æ€§ã€‚\nå½“ç„¶æ‹‰ï¼Œä¿è¯äº†äºŒè¿›åˆ¶æ•°æ®æ€§çš„åŒæ—¶ï¼Œå¦‚æœäºŒè¿›åˆ¶è¢«å½“ä½œbyteå’Œintæ¥è§£è¯»ï¼Œå…¶10è¿›åˆ¶çš„å€¼å¿…ç„¶æ˜¯ä¸åŒçš„ï¼Œå› ä¸ºç¬¦å·ä½ä½ç½®å·²ç»å‘ç”Ÿäº†å˜åŒ–ã€‚\nè±¡ä¾‹2ä¸­ï¼Œint c = a[0]&0xff;  a[0]&amp;0xff=1111111111111111111111111 10000001&amp;11111111=000000000000000000000000 10000001 ï¼Œè¿™ä¸ªå€¼ç®—ä¸€ä¸‹å°±æ˜¯129ï¼Œ\næ‰€ä»¥cçš„è¾“å‡ºçš„å€¼å°±æ˜¯129ã€‚æœ‰äººé—®ä¸ºä»€ä¹ˆä¸Šé¢çš„å¼å­ä¸­a[0]ä¸æ˜¯8ä½è€Œæ˜¯32ä½ï¼Œå› ä¸ºå½“ç³»ç»Ÿæ£€æµ‹åˆ°byteå¯èƒ½ä¼šè½¬åŒ–æˆintæˆ–è€…è¯´byteä¸intç±»å‹è¿›è¡Œè¿ç®—çš„æ—¶å€™ï¼Œå°±ä¼šå°†byteçš„å†…å­˜ç©ºé—´é«˜ä½è¡¥1ï¼ˆä¹Ÿå°±æ˜¯æŒ‰ç¬¦å·ä½è¡¥ä½ï¼‰æ‰©å……åˆ°32ä½ï¼Œå†å‚ä¸è¿ç®—ã€‚ä¸Šé¢çš„0xffå…¶å®æ˜¯intç±»å‹çš„å­—é¢é‡å€¼ï¼Œæ‰€ä»¥å¯ä»¥è¯´byteä¸intè¿›è¡Œè¿ç®—ã€‚\n","categories":["Java"]},{"title":"GitOps flux cd","url":"/posts/39629/","content":"å®˜æ–¹ä»“åº“\nå®˜æ–¹å®‰è£…æ–‡æ¡£\nå®˜æ–¹æ–‡æ¡£\nä¸€ã€å®‰è£…fluxä½¿ç”¨ Homebrew åœ¨ Mac ä¸Šå®‰è£…\nbrew install fluxcd/tap/flux\n\næ£€æŸ¥æ˜¯å¦å…·å¤‡è¿è¡Œ Flux æ‰€éœ€çš„ä¸€åˆ‡ï¼š\nflux check --pre\n\nè¾“å‡ºç±»ä¼¼äºï¼š\nâ–º checking prerequisitesâœ” kubernetes 1.22.2 &gt;=1.20.6âœ” prerequisites checks passed\n\näºŒã€åœ¨ K8S ä¸­éƒ¨ç½² flux1.è®¾ç½®ç¯å¢ƒå˜é‡å°† github çš„ access token è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ã€‚\nexport GITHUB_TOKEN=ghp_ooooooxxxxxxxPxxxxxxxxxpppppp\n\n2. éƒ¨ç½²åˆ°é›†ç¾¤è¯¥æ­¥éª¤ä¼šåœ¨ä»“åº“ä¸­è‡ªåŠ¨åˆ›å»º clusters/demo-cluster ç›®å½•ï¼Œç›¸å…³ yaml ä¹Ÿä¼š push\n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\nflux bootstrap github \\  --hostname=github.com \\  --owner=jd-boy \\  --repository=gitops \\  --branch=master \\  --path=clusters/demo-cluster\n\nä¸‰ã€åˆ›å»º sourceurlä¸­æŒ‡å®šçš„æ˜¯å­˜æ”¾ yaml çš„ä»“åº“åœ°å€ï¼Œå¯ä»¥ä¸ä¸Šä¸€æ­¥çš„ä»“åº“åœ°å€ä¸ä¸€æ ·\nflux create source git podinfo \\  --url=ssh://git@github.com/jd-boy/gitops \\  --branch=master \\  --interval=30s \\  --private-key-file=/Users/jd/.ssh/mac-github-rsa\n\næŸ¥çœ‹ source çŠ¶æ€\nflux get sources git --watch\n\nå››ã€åˆ›å»º kustomizationé…ç½®è¯»å–ç¬¬ä¸‰æ­¥ source ä»“åº“ä¸­ apps/demo-cluster è·¯å¾„ä¸‹çš„ yaml\nflux create kustomization podinfo \\  --target-namespace=test \\  --source=podinfo \\  --path=&quot;./apps/demo-cluster&quot; \\  --prune=true \\  --interval=1m\n\næŸ¥çœ‹ kustomizations çŠ¶å†µï¼š\nflux get kustomizations\n\nä»“åº“ä¸­çš„ç›®å½•ç»“æ„ä¸ºï¼š\ngitopsâ””â”€â”€ clusters/    â””â”€â”€ demo-cluster/        â””â”€â”€ flux-system/                                    â”œâ”€â”€ gotk-components.yaml            â”œâ”€â”€ gotk-sync.yaml            â””â”€â”€ kustomization.yamlâ””â”€â”€ apps/    â””â”€â”€ demo-cluster/        â””â”€â”€nginx-deployment.yaml\n\næ­¤æ—¶å»é›†ç¾¤çš„ test å‘½åç©ºé—´ä¸‹æŸ¥çœ‹nginxå·²ç»éƒ¨ç½²ã€‚\n","categories":["Kubernetes"]},{"title":"K8S ExitCode","url":"/posts/17169/","content":"ä¸€ã€å¦‚ä½•æŸ¥çœ‹é€€å‡ºç æŸ¥çœ‹podä¸­çš„å®¹å™¨é€€å‡ºç \n$ kubectl describe pod xxxPort:           &lt;none&gt;    Host Port:      &lt;none&gt;    State:          Running      Started:      Tue, 26 May 2020 20:01:04 +0800    Last State:     Terminated      Reason:       Error      Exit Code:    137      Started:      Tue, 26 May 2020 19:58:40 +0800      Finished:     Tue, 26 May 2020 20:01:04 +0800    Ready:          True    Restart Count:  2363\n\ndockeræŸ¥çœ‹\n$ docker ps --filter &quot;status=exited&quot;$ docker inspect &lt;container-id&gt; --format=&#x27;&#123;&#123;.State.ExitCode&#125;&#125;&#x27;\n\næ‰‹åŠ¨è¾“å‡º\ndocker container run alpine sh -c &quot;exit 1&quot;$ docker container ls -aCONTAINER ID   IMAGE    COMMAND            CREATED              STATUS                       61c6880xxxxx   alpine   &quot;sh -c &#x27;exit 1&#x27;&quot;   About a minute ago   Exited (1) 3 seconds ago\n\näºŒã€å¸¸è§é€€å‡ºç Exit Code 0\né€€å‡ºä»£ç 0è¡¨ç¤ºç‰¹å®šå®¹å™¨æ²¡æœ‰é™„åŠ å‰å°è¿›ç¨‹ã€‚\nè¯¥é€€å‡ºä»£ç æ˜¯æ‰€æœ‰å…¶ä»–åç»­é€€å‡ºä»£ç çš„ä¾‹å¤–ã€‚\nè¿™ä¸ä¸€å®šæ„å‘³ç€å‘ç”Ÿäº†ä¸å¥½çš„äº‹æƒ…ã€‚å¦‚æœå¼€å‘äººå‘˜æƒ³è¦åœ¨å®¹å™¨å®Œæˆå…¶å·¥ä½œåè‡ªåŠ¨åœæ­¢å…¶å®¹å™¨ï¼Œåˆ™ä½¿ç”¨æ­¤é€€å‡ºä»£ç ã€‚\n\nExit Code 1\nç¨‹åºé”™è¯¯ï¼Œæˆ–è€…Dockerfileä¸­å¼•ç”¨ä¸å­˜åœ¨çš„æ–‡ä»¶ï¼Œå¦‚ entrypointä¸­å¼•ç”¨äº†é”™è¯¯çš„åŒ…\nç¨‹åºé”™è¯¯å¯ä»¥å¾ˆç®€å•ï¼Œä¾‹å¦‚ â€œé™¤ä»¥0â€ï¼Œä¹Ÿå¯ä»¥å¾ˆå¤æ‚ï¼Œæ¯”å¦‚ç©ºå¼•ç”¨æˆ–è€…å…¶ä»–ç¨‹åº crash\n\nExit Code 137\næ­¤çŠ¶æ€ç ä¸€èˆ¬æ˜¯å› ä¸º pod ä¸­å®¹å™¨å†…å­˜è¾¾åˆ°äº†å®ƒçš„èµ„æºé™åˆ¶ï¼ˆresources.limitsï¼‰ï¼Œä¸€èˆ¬æ˜¯å†…å­˜æº¢å‡ºï¼ˆOOMï¼‰ï¼ŒCPUè¾¾åˆ°é™åˆ¶åªéœ€è¦ä¸åˆ†æ—¶é—´ç‰‡ç»™ç¨‹åºå°±å¯ä»¥ã€‚å› ä¸ºé™åˆ¶èµ„æºæ˜¯é€šè¿‡ linux çš„ cgroup å®ç°çš„ï¼Œæ‰€ä»¥ cgroup ä¼šå°†æ­¤å®¹å™¨å¼ºåˆ¶æ€æ‰ï¼Œç±»ä¼¼äº kill -9\nè¿˜å¯èƒ½æ˜¯å®¿ä¸»æœºæœ¬èº«èµ„æºä¸å¤Ÿç”¨äº†ï¼ˆOOMï¼‰ï¼Œå†…æ ¸ä¼šé€‰å–ä¸€äº›è¿›ç¨‹æ€æ‰æ¥é‡Šæ”¾å†…å­˜\nä¸ç®¡æ˜¯ cgroup é™åˆ¶æ€æ‰è¿›ç¨‹è¿˜æ˜¯å› ä¸ºèŠ‚ç‚¹æœºå™¨æœ¬èº«èµ„æºä¸å¤Ÿå¯¼è‡´è¿›ç¨‹æ­»æ‰ï¼Œéƒ½å¯ä»¥ä»ç³»ç»Ÿçš„ dmesg ä¸­çœ‹åˆ° oom æ—¥å¿—( journalctl -k )\n\nExit Code 139\nè¡¨æ˜å®¹å™¨æ”¶åˆ°äº† SIGSEGV ä¿¡å·ï¼Œæ— æ•ˆçš„å†…å­˜å¼•ç”¨ï¼Œå¯¹åº” kill -11\nä¸€èˆ¬æ˜¯ä»£ç æœ‰é—®é¢˜ï¼Œæˆ–è€… docker çš„åŸºç¡€é•œåƒæœ‰é—®é¢˜\n\nExit Code 143\nè¡¨æ˜å®¹å™¨æ”¶åˆ°äº† SIGTERM ä¿¡å·ï¼Œç»ˆç«¯å…³é—­ï¼Œå¯¹åº” kill -15\nä¸€èˆ¬å¯¹åº” docker stop å‘½ä»¤\næœ‰æ—¶ docker stop ä¹Ÿä¼šå¯¼è‡´ Exit Code 137ã€‚å‘ç”Ÿåœ¨ä¸ä»£ç æ— æ³•å¤„ç† SIGTERM çš„æƒ…å†µä¸‹ï¼Œdocker è¿›ç¨‹ç­‰å¾…åç§’é’Ÿç„¶åå‘å‡º SIGKILL å¼ºåˆ¶é€€å‡ºã€‚\n\nä¸å¸¸ç”¨çš„ä¸€äº› Exit Code\nExit Code 126: æƒé™é—®é¢˜æˆ–å‘½ä»¤ä¸å¯æ‰§è¡Œ\nExit Code 127: Shell è„šæœ¬ä¸­å¯èƒ½å‡ºç°é”™å­—ä¸”å­—ç¬¦æ— æ³•è¯†åˆ«çš„æƒ…å†µ\nExit Code 1 æˆ– 255ï¼šå› ä¸ºå¾ˆå¤šç¨‹åºå‘˜å†™å¼‚å¸¸é€€å‡ºæ—¶ä¹ æƒ¯ç”¨ exit(1) æˆ– exit(-1)ï¼Œ-1 ä¼šæ ¹æ®è½¬æ¢è§„åˆ™è½¬æˆ 255ã€‚è¿™ä¸ªä¸€èˆ¬æ˜¯è‡ªå®šä¹‰ codeï¼Œè¦çœ‹å…·ä½“é€»è¾‘ã€‚\n\né€€å‡ºçŠ¶æ€ç çš„åŒºé—´\nå¿…é¡»åœ¨ 0-255 ä¹‹é—´ï¼Œ0 è¡¨ç¤ºæ­£å¸¸é€€å‡º\nå¤–ç•Œå°†ç¨‹åºä¸­æ–­é€€å‡ºï¼ŒçŠ¶æ€ç åœ¨ 129-255\nç¨‹åºè‡ªèº«å¼‚å¸¸é€€å‡ºï¼ŒçŠ¶æ€ç ä¸€èˆ¬åœ¨ 1-128\nå‡å¦‚å†™ä»£ç æŒ‡å®šçš„é€€å‡ºçŠ¶æ€ç æ—¶ä¸åœ¨ 0-255 ä¹‹é—´ï¼Œä¾‹å¦‚: exit(-1)ï¼Œè¿™æ—¶ä¼šè‡ªåŠ¨åšä¸€ä¸ªè½¬æ¢ï¼Œæœ€ç»ˆå‘ˆç°çš„çŠ¶æ€ç è¿˜æ˜¯ä¼šåœ¨ 0-255 ä¹‹é—´ã€‚æˆ‘ä»¬æŠŠçŠ¶æ€ç è®°ä¸º codeï¼Œå½“æŒ‡å®šçš„é€€å‡ºæ—¶çŠ¶æ€ç ä¸ºè´Ÿæ•°ï¼Œé‚£ä¹ˆè½¬æ¢å…¬å¼å¦‚ä¸‹ï¼š256 â€“ (|code| % 256)\n\n","categories":["Kubernetes"]},{"title":"K8S æ‹‰å–ç§æœ‰Dockerä»“åº“é•œåƒ","url":"/posts/36130/","content":"ä¸€ã€åˆ›å»ºä¿å­˜æˆæƒä»¤ç‰Œçš„ SecretKubernetes é›†ç¾¤ä½¿ç”¨ docker-registry ç±»å‹çš„ Secret æ¥é€šè¿‡å®¹å™¨ä»“åº“çš„èº«ä»½éªŒè¯ï¼Œè¿›è€Œæå–ç§æœ‰æ˜ åƒã€‚\nåœ¨ test å‘½åç©ºé—´åˆ›å»º Secretï¼Œå‘½åä¸º regcredï¼š\nkubectl create secret docker-registry docker-secret \\  --docker-server=&lt;ä½ çš„é•œåƒä»“åº“æœåŠ¡å™¨&gt; \\  --docker-username=&lt;ä½ çš„ç”¨æˆ·å&gt; \\  --docker-password=&lt;ä½ çš„å¯†ç &gt; \\  --docker-email=&lt;ä½ çš„é‚®ç®±åœ°å€&gt;\n\n\n&lt;your-registry-server&gt; æ˜¯ä½ çš„ç§æœ‰ Docker ä»“åº“å…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ã€‚ DockerHub ä½¿ç”¨ https://index.docker.io/v1/ã€‚\n&lt;your-name&gt; æ˜¯ä½ çš„ Docker ç”¨æˆ·åã€‚\n&lt;your-pword&gt; æ˜¯ä½ çš„ Docker å¯†ç ã€‚\n&lt;your-email&gt; æ˜¯ä½ çš„ Docker é‚®ç®±ã€‚\n\näºŒã€æ£€æŸ¥ Secretè¦äº†è§£ä½ åˆ›å»ºçš„ regcred Secret çš„å†…å®¹ï¼Œå¯ä»¥ç”¨ YAML æ ¼å¼è¿›è¡ŒæŸ¥çœ‹ï¼š\nkubectl -n test get secret docker-secret --output=yaml\n\nå†…å®¹å¦‚ä¸‹ï¼š\napiVersion: v1data:  .dockerconfigjson: eyJhdXRocyI6eyJyZWdpc3R.........9fX0=kind: Secretmetadata:  creationTimestamp: &quot;2022-03-20T12:54:05Z&quot;  name: docker-secret  namespace: default  resourceVersion: &quot;44636&quot;  uid: d23ef2b3-eee8-41f2-9a0a-5baf4efb5107type: kubernetes.io/dockerconfigjson\n\n.dockerconfigjson å­—æ®µçš„å€¼æ˜¯ Docker å‡­è¯çš„ base64 è¡¨ç¤ºã€‚\nè¦äº†è§£ dockerconfigjson å­—æ®µä¸­çš„å†…å®¹ï¼Œè¯·å°† Secret æ•°æ®è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š\nkubectl -n test get secret docker-secret --output=&quot;jsonpath=&#123;.data.\\.dockerconfigjson&#125;&quot; | base64 --decode\n\nå†…å®¹å¦‚ä¸‹ï¼š\n&#123;&quot;auths&quot;:&#123;&quot;yourprivateregistry.com&quot;:&#123;&quot;username&quot;:&quot;janedoe&quot;,&quot;password&quot;:&quot;xxxxxxxxxxx&quot;,&quot;email&quot;:&quot;jdoe@example.com&quot;,&quot;auth&quot;:&quot;c3R...zE2&quot;&#125;&#125;&#125;\n\nè¦äº†è§£ auth å­—æ®µä¸­çš„å†…å®¹ï¼Œè¯·å°† base64 ç¼–ç è¿‡çš„æ•°æ®è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š\necho &quot;c3R...zE2&quot; | base64 --decode\n\nè¾“å‡ºç»“æœä¸­ï¼Œç”¨æˆ·åå’Œå¯†ç ç”¨ : é“¾æ¥ï¼Œç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š\njanedoe:xxxxxxxxxxx\n\nä¸‰ã€åˆ›å»ºä½¿ç”¨ä½ çš„ Secret çš„ Podcat &lt;&lt;EOF | kubectl apply -f -apiVersion: apps/v1kind: Deploymentmetadata:  labels:    app: vertx-demo  name: vertx-demo  namespace: testspec:  replicas: 1  minReadySeconds: 5  strategy:    rollingUpdate:      maxSurge: 25%      maxUnavailable: 25%    type: RollingUpdate  selector:    matchLabels:      app: vertx-demo  template:    metadata:      labels:        app: vertx-demo    spec:      imagePullSecrets:        - name: docker-secret      containers:        - name: vertx-demo          image: &#x27;registry.xxx.com/jd-zeus/demo&#x27;          imagePullPolicy: &#x27;Always&#x27;          resources:            limits:              cpu: &#x27;1&#x27;              memory: &#x27;400M&#x27;            requests:              cpu: &#x27;0.5&#x27;              memory: &#x27;200M&#x27;          ports:            - name: tcp-8080              containerPort: 8080              protocol: TCP            - name: metrics              containerPort: 8001              protocol: TCP      restartPolicy: AlwaysEOF\n\n","categories":["Kubernetes"]},{"title":"K8S ç”Ÿæˆkubeconfig","url":"/posts/59459/","content":"1.åˆ›å»ºnamespacekubectl create namespace test\n\n2.åˆ›å»º ServiceAccountåˆ›å»ºyaml\ncat &gt;&gt; serviceAccount.yaml&lt;&lt;EOFapiVersion: v1kind: ServiceAccountmetadata:  name: test-userEOF\n\nåˆ›å»ºèµ„æº\nkubectl create -f serviceAccount.yaml -n test\n\n3.åˆ›å»ºRoleåˆ›å»ºä¸€ä¸ªroleï¼Œå¹¶é€šè¿‡RBACæ§åˆ¶ä¸Šé¢ç”Ÿæˆçš„service accountåªèƒ½è®¿é—®è¯¥namespaceé‡Œçš„èµ„æºã€‚\nåˆ›å»ºyaml\ncat &gt;&gt; role.yaml&lt;&lt;EOFapiVersion: rbac.authorization.k8s.io/v1kind: Rolemetadata:  name: test-role  namespace: testrules:  - apiGroups:      - &quot;&quot;    resources:      - &quot;namespaces&quot;    verbs:      - &quot;get&quot;      - &quot;list&quot;---apiVersion: rbac.authorization.k8s.io/v1kind: RoleBindingmetadata:  name: test-rolebinding  namespace: testroleRef:  apiGroup: rbac.authorization.k8s.io  kind: Role  name: test-rolesubjects:  - namespace: test    kind: ServiceAccount    name: test-userEOF\n\nåˆ›å»ºèµ„æº\nkubectl create -f role.yaml\n\n4.è·å–ServiceAccountçš„secret$ kubectl describe serviceAccounts test-user -n testName:                test-userNamespace:           testLabels:              &lt;none&gt;Annotations:         &lt;none&gt;Image pull secrets:  &lt;none&gt;Mountable secrets:   test-user-token-jfj9gTokens:              test-user-token-jfj9gEvents:              &lt;none&gt;\n\n5.è·å–secretå¯¹åº”tokenkubectl describe secret test-user-token-jfj9g -n test\n\n6.è·å–é›†ç¾¤ä¿¡æ¯kubectl config view --flatten --minify\n\n7.æŒ‰ä»¥ä¸‹æ ¼å¼ç”ŸæˆkubeconfigapiVersion: v1kind: Configusers:- name: test-user  user:    token: &#123;æ­¥éª¤5è·å–çš„token&#125;  clusters:- cluster:    certificate-authority-data: &#123;æ­¥éª¤6è·å–&#125;    server: &#123;æ­¥éª¤6è·å–&#125;  name: &#123;æ­¥éª¤6è·å–çš„é›†ç¾¤å&#125;contexts:- context:    cluster: &#123;æ­¥éª¤6è·å–çš„é›†ç¾¤å&#125;    user: test-user  name: test-user-contextcurrent-context: test-user-context\n\n9.ä¸ºnamespaceè®¾ç½®quotaåˆ›å»ºyaml\n$ cat &gt;&gt; quota.yaml&lt;&lt;EOFapiVersion: v1kind: Listitems:- apiVersion: v1  kind: ResourceQuota  metadata:    name: quota  spec:    hard:      cpu: &quot;20&quot;    # CPU      memory: 10Gi  # å†…å­˜      pods: &quot;50&quot;  # podæ•°EOF\n\nåˆ›å»ºèµ„æº\n$ kubectl create -f quota.yaml -n testresourcequota/quota created\n\n\n\napiVersion: v1kind: Configusers:- name: test-user  user:    token: eyJhbGciOiJSUzI1NiIsImtpZCI6IjdrLVloT2NDd191VndTREh2TUpmM21EdkNPWkZFOEZXaklxZEl5Qms3dE0ifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6InRlc3QtdXNlci10b2tlbi12Y3BodiIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50Lm5hbWUiOiJ0ZXN0LXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI0NTg0ZGVjYi01M2YxLTQ4ZjAtYWZiZS01NmY5ODY5ZTc3YzgiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6ZGVmYXVsdDp0ZXN0LXVzZXIifQ.H-Sn6QbRfnZs03YTYe338MJpRuoSHwFIynQGMeKqDBwxy5EZXGMjTtIKHCpK46XSxtdchsbsPpbktsZs0QFrluDLO03MYDsBWVoT0cV0YXUgnz7OHYUX-4pfO1zXeBL_CmHAT-Gn06O4Vcs_cOZXJd-Rlc4Sw6M3AhuzouKvWOKK8zPbahhbYyOOAU1VAAYv_DdS8Txq74vs5In5nqtvLhW5wca9LTkLPysxPsAB9V_UxJWedalf27OEl1vssvWaD9K0cKPBn3ZSxyJNAper6Ivu254KVuQj2V6p2xqqSzJ_f_UPeQXAS53WhB4jxJGLmJ7BefZUjSR-IUlo1fzUYwclusters:- cluster:    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCakNDQWU2Z0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRJeE1USXdOakUwTXprME9Wb1hEVE14TVRJd05URTBNemswT1Zvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTFJzCjZIY3N6Y0lWZVIxa1oraGRPb2d1NlRtTEw5VWhtV0N5U21FYVNiZFlzWlpacmo0VEFOaGdabFpPOUhvUDhqeTUKaTh1K2g0cDBZR0ZHd05COHRMSmdyN0puMW9MYzFRWFJXajZoNSt4SXdRdER3TmpYUnFNRURWcUF5RnNGV1pETgpWTlZGTWdTSS9IdWFEUUVYV2xyMGFUd3Jzb3VXeG1vbmtyamt4dWJzUHhiTnJWajJtaDdISFpSdTBMak1kTGplCnZUSE80dWVydEZJTFAySGJBK0I3ZUlRNDFLU051WGxRUmN0Y3BCQll6ZzB1ODVWMmx4a2MwNkRaSy9weHZ4ZE4KejRDVXh3KzVkdTdDZlhVeEFCT3VReS9YdExELzhiRXUvd1B5REk0M1Byb1gvVmtzNjk2KzNXcGFDR1lRMVZYUgpNVU5zcm9OSW9pb2R3djhNZGowQ0F3RUFBYU5oTUY4d0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQjBHQTFVZERnUVcKQkJSR2RoeFVrVGVrbnRhdHBXaFBEQkxCUzhBcWVEQU5CZ2txaGtpRzl3MEJBUXNGQUFPQ0FRRUFiZFFwOTQxZQpmaVJjdTBSaTdrWkVXZkpqNDBWa2hqQTdTNjV4NEUyN3hYYXFxRG9tc2dkSFVpaHNyM0pXRU5iNjZYS0dFUWhlCmFDQUlHcE9tNjdJSUFacW15dUNOYVpwUGVKSXpzTTBOMVRLSnppNGhCczR4Rm5BQTljbHh0bm9jZmZLVnpxV1cKRUQ2d01BT1J1Z1pUTC9ldUgzandON2NXdEdhRkdPMFJxdXFqRW9rdGlYbkZwN1ZhT1ZaNUtpZ0RzUWZibmhJVQo2OFJoQTJJZWlYTWh2L3RiTHZwL3VQNUh5VnVSUGU2S1ZXRFB3N1NXNHV4Z0QvM29ocm8wWjVNTDF2dXk1b2Z1Ck5EWk1nUmR3dXFLT2JWektCTElaTXJKd2RWUHhvNE5xbFlnU0xGSGZjZ3ArOWUrOWVMUzZhKy9ORzkxeVRJS04KQlRkNFVUbi9QS01VbkE9PQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==    server: https://127.0.0.1:49570  name: minikubecontexts:- context:    cluster: minikube    user: test-user  name: testKubeconfigcurrent-context: testKubeconfig\n\n","categories":["Kubernetes"]},{"title":"K8S éƒ¨ç½²ä»£ç†è®¿é—®å†…ç½‘æœåŠ¡","url":"/posts/19720/","content":"Github\nDockerhub\nä¸€ã€DockerfileFROM alpine:3.9MAINTAINER David Salgado &lt;david.salgado@digital.justice.gov.uk&gt;LABEL MAINTAINER David Salgado &lt;david.salgado@digital.justice.gov.uk&gt;RUN apk add --update --no-cache socat \\\t&amp;&amp; rm -rf /var/cache/apk/RUN addgroup -g 1001 -S appgroup &amp;&amp; \\    adduser -u 1001 -S appuser -G appgroupARG DEF_REMOTE_PORT=8000ARG DEF_LOCAL_PORT=8000ENV REMOTE_PORT=$DEF_REMOTE_PORTENV LOCAL_PORT=$DEF_LOCAL_PORT## By default container listens on $LOCAL_PORT (8000)EXPOSE 8000USER 1001CMD socat tcp-listen:$LOCAL_PORT,reuseaddr,fork tcp:$REMOTE_HOST:$REMOTE_PORT &amp; pid=$! &amp;&amp; trap &quot;kill $pid&quot; SIGINT &amp;&amp; \\\techo &quot;Socat started listening on $LOCAL_PORT: Redirecting traffic to $REMOTE_HOST:$REMOTE_PORT ($pid)&quot; &amp;&amp; wait $pid\n\näºŒã€ç”¨æ³•Define the following environment variables to configure port-forwarding.\n\n\n\nVariable\nDescription\nOptional\n\n\n\nREMOTE_HOST\nIP or address of the host you want to forward traffic to\nno\n\n\nREMOTE_PORT\nPort on remote host to forward traffic to\nyes (80)\n\n\nLOCAL_PORT\nPort where container listens\nyes (80)\n\n\nThe socat process within the container will listen by default to port 80, use -pdocker flag to map the port of the local machine where it will listen to traffic to be forwarded.\ndocker run -e REMOTE_HOST=&lt;remote_host&gt; -e REMOTE_PORT=&lt;remote_port&gt; -e LOCAL_PORT=&lt;local_port&gt; -p &lt;exposed_local_port&gt;:&lt;local_port&gt; marcnuri/port-forward\n\nä¸‰ã€æ ·ä¾‹The following commands will all forward 8080 traffic to a remote machine located at www.marcnuri.com in the http port\ndocker run -e REMOTE_HOST=www.marcnuri.com -e REMOTE_PORT=80 -e LOCAL_PORT=80 -p 8080:80 marcnuri/port-forwarddocker run -e REMOTE_HOST=www.marcnuri.com -e REMOTE_PORT=80 -p 8080:80 marcnuri/port-forwarddocker run -e REMOTE_HOST=www.marcnuri.com -p 8080:80 marcnuri/port-forward\n\nå››ã€åœ¨ K8S ä¸­ä½¿ç”¨kubectl run -n test --env REMOTE_HOST=127.0.233.11 --env REMOTE_PORT=9199 --env LOCAL_PORT=9199 --port 9199 --image marcnuri/port-forward &lt;name&gt;\n\n","categories":["Kubernetes"]},{"title":"Mac å®‰è£… Minikube","url":"/posts/22705/","content":"å®˜æ–¹æ–‡æ¡£\nä¸€ã€å®‰è£… kubectlbrew install kubectl\n\näºŒã€å®‰è£… Minikube1.å®‰è£… minikubebrew install minikube\n\n2.æŸ¥çœ‹ minikube ç‰ˆæœ¬jz@Bean-You ~ % minikube versionminikube version: v1.24.0commit: 76b94fb3c4e8ac5062daf70d60cf03ddcc0a741b\n\nä¸‰ã€å¯åŠ¨é›†ç¾¤minikube start --image-mirror-country=&#x27;cn&#x27; --image-repository=registry.cn-hangzhou.aliyuncs.com/google_containers\n\nå¯åŠ¨åå°†ä¼šçœ‹åˆ°ä¼šè‡ªåŠ¨é€‰æ‹© docker é©±åŠ¨\nå¦‚æœå¯åŠ¨å¤±è´¥ï¼Œå¯ä»¥å‚è€ƒ å®˜æ–¹çš„ Driver é€‰æ‹©æ–‡æ¡£ ï¼Œé€šè¿‡ --vm-driver= å‚æ•°æŒ‡å®šé©±åŠ¨ã€‚\nå››ã€minikube å¸¸ç”¨å‘½ä»¤1.åˆ é™¤é›†ç¾¤jz@Bean-You bin % minikube deleteğŸ”¥  æ­£åœ¨åˆ é™¤ docker ä¸­çš„â€œminikubeâ€â€¦ğŸ”¥  æ­£åœ¨åˆ é™¤å®¹å™¨ &quot;minikube&quot; ...ğŸ”¥  æ­£åœ¨ç§»é™¤ /Users/jd/.minikube/machines/minikubeâ€¦ğŸ’€  Removed all traces of the &quot;minikube&quot; cluster.\n\n2.é›†ç¾¤çŠ¶æ€jz@Bean-You bin % minikube statusminikubetype: Control Planehost: Runningkubelet: Runningapiserver: Runningkubeconfig: Configured\n\n3.åœæ­¢é›†ç¾¤minikube stop\n","categories":["Kubernetes"]},{"title":"Pod ä¸ Service çš„ DNS","url":"/posts/48384/","content":"Kubernetes ä¸º Service å’Œ Pod åˆ›å»º DNS è®°å½•ã€‚ ä½ å¯ä»¥ä½¿ç”¨ä¸€è‡´çš„ DNS åç§°è€Œé IP åœ°å€è®¿é—® Serviceã€‚\nåŸæ–‡è¿æ¥\nä¸€ã€ä»‹ç»Kubernetes DNS é™¤äº†åœ¨é›†ç¾¤ä¸Šè°ƒåº¦ DNS Pod å’Œ Serviceï¼Œ è¿˜é…ç½® kubelet ä»¥å‘ŠçŸ¥å„ä¸ªå®¹å™¨ä½¿ç”¨ DNS Service çš„ IP æ¥è§£æ DNS åç§°ã€‚\né›†ç¾¤ä¸­å®šä¹‰çš„æ¯ä¸ª Service ï¼ˆåŒ…æ‹¬ DNS æœåŠ¡å™¨è‡ªèº«ï¼‰éƒ½è¢«èµ‹äºˆä¸€ä¸ª DNS åç§°ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ Pod çš„ DNS æœç´¢åˆ—è¡¨ä¼šåŒ…å« Pod è‡ªèº«çš„åå­—ç©ºé—´å’Œé›†ç¾¤çš„é»˜è®¤åŸŸã€‚\nService çš„åå­—ç©ºé—´DNS æŸ¥è¯¢å¯èƒ½å› ä¸ºæ‰§è¡ŒæŸ¥è¯¢çš„ Pod æ‰€åœ¨çš„åå­—ç©ºé—´è€Œè¿”å›ä¸åŒçš„ç»“æœã€‚ ä¸æŒ‡å®šåå­—ç©ºé—´çš„ DNS æŸ¥è¯¢ä¼šè¢«é™åˆ¶åœ¨ Pod æ‰€åœ¨çš„åå­—ç©ºé—´å†…ã€‚ è¦è®¿é—®å…¶ä»–åå­—ç©ºé—´ä¸­çš„ Serviceï¼Œéœ€è¦åœ¨ DNS æŸ¥è¯¢ä¸­æŒ‡å®šåå­—ç©ºé—´ã€‚\nä¾‹å¦‚ï¼Œå‡å®šåå­—ç©ºé—´ test ä¸­å­˜åœ¨ä¸€ä¸ª Podï¼Œprod åå­—ç©ºé—´ä¸­å­˜åœ¨ä¸€ä¸ªæœåŠ¡ dataã€‚\nPod æŸ¥è¯¢ data æ—¶æ²¡æœ‰è¿”å›ç»“æœï¼Œå› ä¸ºä½¿ç”¨çš„æ˜¯ Pod çš„åå­—ç©ºé—´ testã€‚\nPod æŸ¥è¯¢ data.prod æ—¶åˆ™ä¼šè¿”å›é¢„æœŸçš„ç»“æœï¼Œå› ä¸ºæŸ¥è¯¢ä¸­æŒ‡å®šäº†åå­—ç©ºé—´ã€‚\nDNS æŸ¥è¯¢å¯ä»¥ä½¿ç”¨ Pod ä¸­çš„ /etc/resolv.conf å±•å¼€ã€‚kubelet ä¼šä¸ºæ¯ä¸ª Pod ç”Ÿæˆæ­¤æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¯¹ data çš„æŸ¥è¯¢å¯èƒ½è¢«å±•å¼€ä¸º data.test.svc.cluster.localã€‚ search é€‰é¡¹çš„å–å€¼ä¼šè¢«ç”¨æ¥å±•å¼€æŸ¥è¯¢ã€‚è¦è¿›ä¸€æ­¥äº†è§£ DNS æŸ¥è¯¢ï¼Œå¯å‚é˜… resolv.conf æ‰‹å†Œé¡µé¢ã€‚\nnameserver 10.32.0.10search &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.localoptions ndots:5\n\næ¦‚æ‹¬èµ·æ¥ï¼Œåå­—ç©ºé—´ test ä¸­çš„ Pod å¯ä»¥æˆåŠŸåœ°è§£æ data.prod æˆ–è€… data.prod.svc.cluster.localã€‚\nDNS è®°å½•å“ªäº›å¯¹è±¡ä¼šè·å¾— DNS è®°å½•å‘¢ï¼Ÿ\n\nServices\nPods\n\nä»¥ä¸‹å„èŠ‚è¯¦ç»†ä»‹ç»å·²æ”¯æŒçš„ DNS è®°å½•ç±»å‹å’Œå¸ƒå±€ã€‚ å…¶å®ƒå¸ƒå±€ã€åç§°æˆ–è€…æŸ¥è¯¢å³ä½¿ç¢°å·§å¯ä»¥å·¥ä½œï¼Œä¹Ÿåº”è§†ä¸ºå®ç°ç»†èŠ‚ï¼Œ å°†æ¥å¾ˆå¯èƒ½è¢«æ›´æ”¹è€Œä¸”ä¸ä¼šå› æ­¤å‘å‡ºè­¦å‘Šã€‚ æœ‰å…³æœ€æ–°è§„èŒƒè¯·æŸ¥çœ‹ Kubernetes åŸºäº DNS çš„æœåŠ¡å‘ç°ã€‚\nServicesA/AAAA è®°å½•â€œæ™®é€šâ€ Serviceï¼ˆé™¤äº†æ— å¤´ Serviceï¼‰ä¼šä»¥ my-svc.my-namespace.svc.cluster-domain.example è¿™ç§åå­—çš„å½¢å¼è¢«åˆ†é…ä¸€ä¸ª DNS A æˆ– AAAA è®°å½•ï¼Œå–å†³äº Service çš„ IP åè®®æ—ã€‚ è¯¥åç§°ä¼šè§£ææˆå¯¹åº” Service çš„é›†ç¾¤ IPã€‚\nâ€œæ— å¤´ï¼ˆHeadlessï¼‰â€ Service ï¼ˆæ²¡æœ‰é›†ç¾¤ IPï¼‰ä¹Ÿä¼šä»¥ my-svc.my-namespace.svc.cluster-domain.example è¿™ç§åå­—çš„å½¢å¼è¢«æŒ‡æ´¾ä¸€ä¸ª DNS A æˆ– AAAA è®°å½•ï¼Œ å…·ä½“å–å†³äº Service çš„ IP åè®®æ—ã€‚ ä¸æ™®é€š Service ä¸åŒï¼Œè¿™ä¸€è®°å½•ä¼šè¢«è§£ææˆå¯¹åº” Service æ‰€é€‰æ‹©çš„ Pod IP çš„é›†åˆã€‚ å®¢æˆ·ç«¯è¦èƒ½å¤Ÿä½¿ç”¨è¿™ç»„ IPï¼Œæˆ–è€…ä½¿ç”¨æ ‡å‡†çš„è½®è½¬ç­–ç•¥ä»è¿™ç»„ IP ä¸­è¿›è¡Œé€‰æ‹©ã€‚\nSRV è®°å½•Kubernetes æ ¹æ®æ™®é€š Service æˆ– Headless Service ä¸­çš„å‘½åç«¯å£åˆ›å»º SRV è®°å½•ã€‚æ¯ä¸ªå‘½åç«¯å£ï¼Œ SRV è®°å½•æ ¼å¼ä¸º _my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster-domain.exampleã€‚ æ™®é€š Serviceï¼Œè¯¥è®°å½•ä¼šè¢«è§£ææˆç«¯å£å·å’ŒåŸŸåï¼šmy-svc.my-namespace.svc.cluster-domain.exampleã€‚ æ— å¤´ Serviceï¼Œè¯¥è®°å½•ä¼šè¢«è§£ææˆå¤šä¸ªç»“æœï¼ŒåŠè¯¥æœåŠ¡çš„æ¯ä¸ªåç«¯ Pod å„ä¸€ä¸ª SRV è®°å½•ï¼Œ å…¶ä¸­åŒ…å« Pod ç«¯å£å·å’Œæ ¼å¼ä¸º auto-generated-name.my-svc.my-namespace.svc.cluster-domain.example çš„åŸŸåã€‚\näºŒã€PodsA/AAAA è®°å½•ä¸€èˆ¬è€Œè¨€ï¼ŒPod ä¼šå¯¹åº”å¦‚ä¸‹ DNS åå­—è§£æï¼š\npod-ip-address.my-namespace.pod.cluster-domain.example\n\nä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªä½äº default åå­—ç©ºé—´ï¼ŒIP åœ°å€ä¸º 172.17.0.3 çš„ Podï¼Œ å¦‚æœé›†ç¾¤çš„åŸŸåä¸º cluster.localï¼Œåˆ™ Pod ä¼šå¯¹åº” DNS åç§°ï¼š\n172-17-0-3.default.pod.cluster.local.\né€šè¿‡ Service æš´éœ²å‡ºæ¥çš„æ‰€æœ‰ Pod éƒ½ä¼šæœ‰å¦‚ä¸‹ DNS è§£æåç§°å¯ç”¨ï¼š\npod-ip-address.service-name.my-namespace.svc.cluster-domain.example.\nPod çš„ hostname å’Œ subdomain å­—æ®µå½“å‰ï¼Œåˆ›å»º Pod æ—¶å…¶ä¸»æœºåå–è‡ª Pod çš„ metadata.name å€¼ã€‚\nPod è§„çº¦ä¸­åŒ…å«ä¸€ä¸ªå¯é€‰çš„ hostname å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®š Pod çš„ä¸»æœºåã€‚ å½“è¿™ä¸ªå­—æ®µè¢«è®¾ç½®æ—¶ï¼Œå®ƒå°†ä¼˜å…ˆäº Pod çš„åå­—æˆä¸ºè¯¥ Pod çš„ä¸»æœºåã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œç»™å®šä¸€ä¸ª hostname è®¾ç½®ä¸º â€œmy-hostâ€œ çš„ Podï¼Œ è¯¥ Pod çš„ä¸»æœºåå°†è¢«è®¾ç½®ä¸º â€œmy-hostâ€œã€‚\nPod è§„çº¦è¿˜æœ‰ä¸€ä¸ªå¯é€‰çš„ subdomain å­—æ®µï¼Œå¯ä»¥ç”¨æ¥æŒ‡å®š Pod çš„å­åŸŸåã€‚ ä¸¾ä¸ªä¾‹å­ï¼ŒæŸ Pod çš„ hostname è®¾ç½®ä¸º â€œfooâ€ï¼Œsubdomain è®¾ç½®ä¸º â€œbarâ€ï¼Œ åœ¨åå­—ç©ºé—´ â€œmy-namespaceâ€ ä¸­å¯¹åº”çš„å®Œå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ä¸º â€œfoo.bar.my-namespace.svc.cluster-domain.exampleâ€ã€‚\nç¤ºä¾‹ï¼š\napiVersion: v1kind: Servicemetadata:  name: default-subdomainspec:  selector:    name: busybox  clusterIP: None  ports:  - name: foo # å®é™…ä¸Šä¸éœ€è¦æŒ‡å®šç«¯å£å·    port: 1234    targetPort: 1234---apiVersion: v1kind: Podmetadata:  name: busybox1  labels:    name: busyboxspec:  hostname: busybox-1  subdomain: default-subdomain  containers:  - image: busybox:1.28    command:      - sleep      - &quot;3600&quot;    name: busybox---apiVersion: v1kind: Podmetadata:  name: busybox2  labels:    name: busyboxspec:  hostname: busybox-2  subdomain: default-subdomain  containers:  - image: busybox:1.28    command:      - sleep      - &quot;3600&quot;    name: busybox\n\nå¦‚æœæŸæ— å¤´ Service ä¸æŸ Pod åœ¨åŒä¸€ä¸ªåå­—ç©ºé—´ä¸­ï¼Œä¸”å®ƒä»¬å…·æœ‰ç›¸åŒçš„å­åŸŸåï¼Œ é›†ç¾¤çš„ DNS æœåŠ¡å™¨ä¹Ÿä¼šä¸ºè¯¥ Pod çš„å…¨é™å®šä¸»æœºåè¿”å› A è®°å½•æˆ– AAAA è®°å½•ã€‚ ä¾‹å¦‚ï¼Œåœ¨åŒä¸€ä¸ªåå­—ç©ºé—´ä¸­ï¼Œç»™å®šä¸€ä¸ªä¸»æœºåä¸º â€œbusybox-1â€ã€ å­åŸŸåè®¾ç½®ä¸º â€œdefault-subdomainâ€ çš„ Podï¼Œå’Œä¸€ä¸ªåç§°ä¸º â€œdefault-subdomainâ€ çš„æ— å¤´ Serviceï¼ŒPod å°†çœ‹åˆ°è‡ªå·±çš„ FQDN ä¸º â€œbusybox-1.default-subdomain.my-namespace.svc.cluster-domain.exampleâ€œã€‚ DNS ä¼šä¸ºæ­¤åå­—æä¾›ä¸€ä¸ª A è®°å½•æˆ– AAAA è®°å½•ï¼ŒæŒ‡å‘è¯¥ Pod çš„ IPã€‚ â€œbusybox1â€ å’Œ â€œbusybox2â€ è¿™ä¸¤ä¸ª Pod åˆ†åˆ«å…·æœ‰å®ƒä»¬è‡ªå·±çš„ A æˆ– AAAA è®°å½•ã€‚\nEndpoints å¯¹è±¡å¯ä»¥ä¸ºä»»ä½•ç«¯ç‚¹åœ°å€åŠå…¶ IP æŒ‡å®š hostnameã€‚\nè¯´æ˜ï¼š ç”±äºä¸æ˜¯ä¸º Pod åç§°åˆ›å»º A æˆ– AAAA è®°å½•çš„ï¼Œå› æ­¤ Pod çš„ A æˆ– AAAA éœ€è¦ hostnameã€‚ æ²¡æœ‰è®¾ç½® hostname ä½†è®¾ç½®äº† subdomain çš„ Pod åªä¼šä¸º æ— å¤´ Service åˆ›å»º A æˆ– AAAA è®°å½•ï¼ˆdefault-subdomain.my-namespace.svc.cluster-domain.exampleï¼‰ æŒ‡å‘ Pod çš„ IP åœ°å€ã€‚ å¦å¤–ï¼Œé™¤éåœ¨æœåŠ¡ä¸Šè®¾ç½®äº† publishNotReadyAddresses=Trueï¼Œå¦åˆ™åªæœ‰ Pod è¿›å…¥å°±ç»ªçŠ¶æ€ æ‰ä¼šæœ‰ä¸ä¹‹å¯¹åº”çš„è®°å½•ã€‚\nPod çš„ setHostnameAsFQDN å­—æ®µç‰¹æ€§çŠ¶æ€ï¼š Kubernetes v1.22 [stable]\nå½“ Pod é…ç½®ä¸ºå…·æœ‰å…¨é™å®šåŸŸå (FQDN) æ—¶ï¼Œå…¶ä¸»æœºåæ˜¯çŸ­ä¸»æœºåã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªå…·æœ‰å®Œå…¨é™å®šåŸŸå busybox-1.default-subdomain.my-namespace.svc.cluster-domain.example çš„ Podï¼Œ åˆ™é»˜è®¤æƒ…å†µä¸‹ï¼Œè¯¥ Pod å†…çš„ hostname å‘½ä»¤è¿”å› busybox-1ï¼Œè€Œ hostname --fqdn å‘½ä»¤è¿”å› FQDNã€‚\nå½“ä½ åœ¨ Pod è§„çº¦ä¸­è®¾ç½®äº† setHostnameAsFQDN: true æ—¶ï¼Œkubelet ä¼šå°† Pod çš„å…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ä½œä¸ºè¯¥ Pod çš„ä¸»æœºåè®°å½•åˆ° Pod æ‰€åœ¨åå­—ç©ºé—´ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œhostname å’Œ hostname --fqdn éƒ½ä¼šè¿”å› Pod çš„å…¨é™å®šåŸŸåã€‚\nè¯´æ˜ï¼š\nåœ¨ Linux ä¸­ï¼Œå†…æ ¸çš„ä¸»æœºåå­—æ®µï¼ˆstruct utsname çš„ nodename å­—æ®µï¼‰é™å®š æœ€å¤š 64 ä¸ªå­—ç¬¦ã€‚\nå¦‚æœ Pod å¯ç”¨è¿™ä¸€ç‰¹æ€§ï¼Œè€Œå…¶ FQDN è¶…å‡º 64 å­—ç¬¦ï¼ŒPod çš„å¯åŠ¨ä¼šå¤±è´¥ã€‚ Pod ä¼šä¸€ç›´å‡ºäº Pending çŠ¶æ€ï¼ˆé€šè¿‡ kubectl æ‰€çœ‹åˆ°çš„ ContainerCreatingï¼‰ï¼Œ å¹¶äº§ç”Ÿé”™è¯¯äº‹ä»¶ï¼Œä¾‹å¦‚ â€œFailed to construct FQDN from Pod hostname and cluster domain, FQDN long-FQDN is too long (64 characters is the max, 70 characters requested).â€ ï¼ˆæ— æ³•åŸºäº Pod ä¸»æœºåå’Œé›†ç¾¤åŸŸåæ„é€  FQDNï¼ŒFQDN long-FQDN è¿‡é•¿ï¼Œè‡³å¤š 64 å­—ç¬¦ï¼Œè¯·æ±‚å­—ç¬¦æ•°ä¸º 70ï¼‰ã€‚ å¯¹äºè¿™ç§åœºæ™¯è€Œè¨€ï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒçš„ä¸€ç§æ–¹å¼æ˜¯åˆ›å»ºä¸€ä¸ª å‡†å…¥ Webhook æ§åˆ¶å™¨ï¼Œ åœ¨ç”¨æˆ·åˆ›å»ºé¡¶å±‚å¯¹è±¡ï¼ˆå¦‚ Deploymentï¼‰çš„æ—¶å€™æ§åˆ¶ FQDN çš„é•¿åº¦ã€‚\nPod çš„ DNS ç­–ç•¥DNS ç­–ç•¥å¯ä»¥é€ä¸ª Pod æ¥è®¾å®šã€‚ç›®å‰ Kubernetes æ”¯æŒä»¥ä¸‹ç‰¹å®š Pod çš„ DNS ç­–ç•¥ã€‚ è¿™äº›ç­–ç•¥å¯ä»¥åœ¨ Pod è§„çº¦ä¸­çš„ dnsPolicy å­—æ®µè®¾ç½®ï¼š\n\nDefaultï¼š Pod ä»è¿è¡Œæ‰€åœ¨çš„èŠ‚ç‚¹ç»§æ‰¿åç§°è§£æé…ç½®ã€‚å‚è€ƒ ç›¸å…³è®¨è®º è·å–æ›´å¤šä¿¡æ¯ã€‚\nClusterFirstï¼šä¸é…ç½®çš„é›†ç¾¤åŸŸåç¼€ä¸åŒ¹é…çš„ä»»ä½• DNS æŸ¥è¯¢ï¼ˆä¾‹å¦‚ â€œwww.kubernetes.io&quot;ï¼‰ éƒ½å°†è½¬å‘åˆ°ä»èŠ‚ç‚¹ç»§æ‰¿çš„ä¸Šæ¸¸åç§°æœåŠ¡å™¨ã€‚é›†ç¾¤ç®¡ç†å‘˜å¯èƒ½é…ç½®äº†é¢å¤–çš„å­˜æ ¹åŸŸå’Œä¸Šæ¸¸ DNS æœåŠ¡å™¨ã€‚ å‚é˜…ç›¸å…³è®¨è®º äº†è§£åœ¨è¿™äº›åœºæ™¯ä¸­å¦‚ä½•å¤„ç† DNS æŸ¥è¯¢çš„ä¿¡æ¯ã€‚\nClusterFirstWithHostNetï¼šå¯¹äºä»¥ hostNetwork æ–¹å¼è¿è¡Œçš„ Podï¼Œåº”æ˜¾å¼è®¾ç½®å…¶ DNS ç­–ç•¥ ClusterFirstWithHostNetã€‚\næ³¨æ„ï¼šè¿™åœ¨ Windows ä¸Šä¸æ”¯æŒã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§ä¸‹æ–‡ã€‚\n\n\nNoneï¼šæ­¤è®¾ç½®å…è®¸ Pod å¿½ç•¥ Kubernetes ç¯å¢ƒä¸­çš„ DNS è®¾ç½®ã€‚Pod ä¼šä½¿ç”¨å…¶ dnsConfig å­—æ®µ æ‰€æä¾›çš„ DNS è®¾ç½®ã€‚ å‚è§ Pod çš„ DNS é…ç½®èŠ‚ã€‚\n\nè¯´æ˜ï¼š Default ä¸æ˜¯é»˜è®¤çš„ DNS ç­–ç•¥ã€‚å¦‚æœæœªæ˜ç¡®æŒ‡å®š dnsPolicyï¼Œåˆ™ä½¿ç”¨ ClusterFirstã€‚\nä¸‹é¢çš„ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸€ä¸ª Podï¼Œå…¶ DNS ç­–ç•¥è®¾ç½®ä¸º ClusterFirstWithHostNetï¼Œ å› ä¸ºå®ƒå·²å°† hostNetwork è®¾ç½®ä¸º trueã€‚\napiVersion: v1kind: Podmetadata:  name: busybox  namespace: defaultspec:  containers:  - image: busybox:1.28    command:      - sleep      - &quot;3600&quot;    imagePullPolicy: IfNotPresent    name: busybox  restartPolicy: Always  hostNetwork: true  dnsPolicy: ClusterFirstWithHostNet\n\nPod çš„ DNS é…ç½®ç‰¹æ€§çŠ¶æ€ï¼š Kubernetes v1.14 [stable]\nPod çš„ DNS é…ç½®å¯è®©ç”¨æˆ·å¯¹ Pod çš„ DNS è®¾ç½®è¿›è¡Œæ›´å¤šæ§åˆ¶ã€‚\ndnsConfig å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå®ƒå¯ä»¥ä¸ä»»ä½• dnsPolicy è®¾ç½®ä¸€èµ·ä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œå½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€œ æ—¶ï¼Œå¿…é¡»æŒ‡å®š dnsConfig å­—æ®µã€‚\nç”¨æˆ·å¯ä»¥åœ¨ dnsConfig å­—æ®µä¸­æŒ‡å®šä»¥ä¸‹å±æ€§ï¼š\n\nnameserversï¼šå°†ç”¨ä½œäº Pod çš„ DNS æœåŠ¡å™¨çš„ IP åœ°å€åˆ—è¡¨ã€‚ æœ€å¤šå¯ä»¥æŒ‡å®š 3 ä¸ª IP åœ°å€ã€‚å½“ Pod çš„ dnsPolicy è®¾ç½®ä¸º â€œNoneâ€œ æ—¶ï¼Œ åˆ—è¡¨å¿…é¡»è‡³å°‘åŒ…å«ä¸€ä¸ª IP åœ°å€ï¼Œå¦åˆ™æ­¤å±æ€§æ˜¯å¯é€‰çš„ã€‚ æ‰€åˆ—å‡ºçš„æœåŠ¡å™¨å°†åˆå¹¶åˆ°ä»æŒ‡å®šçš„ DNS ç­–ç•¥ç”Ÿæˆçš„åŸºæœ¬åç§°æœåŠ¡å™¨ï¼Œå¹¶åˆ é™¤é‡å¤çš„åœ°å€ã€‚\nsearchesï¼šç”¨äºåœ¨ Pod ä¸­æŸ¥æ‰¾ä¸»æœºåçš„ DNS æœç´¢åŸŸçš„åˆ—è¡¨ã€‚æ­¤å±æ€§æ˜¯å¯é€‰çš„ã€‚ æŒ‡å®šæ­¤å±æ€§æ—¶ï¼Œæ‰€æä¾›çš„åˆ—è¡¨å°†åˆå¹¶åˆ°æ ¹æ®æ‰€é€‰ DNS ç­–ç•¥ç”Ÿæˆçš„åŸºæœ¬æœç´¢åŸŸåä¸­ã€‚ é‡å¤çš„åŸŸåå°†è¢«åˆ é™¤ã€‚Kubernetes æœ€å¤šå…è®¸ 6 ä¸ªæœç´¢åŸŸã€‚\noptionsï¼šå¯é€‰çš„å¯¹è±¡åˆ—è¡¨ï¼Œå…¶ä¸­æ¯ä¸ªå¯¹è±¡å¯èƒ½å…·æœ‰ name å±æ€§ï¼ˆå¿…éœ€ï¼‰å’Œ value å±æ€§ï¼ˆå¯é€‰ï¼‰ã€‚ æ­¤å±æ€§ä¸­çš„å†…å®¹å°†åˆå¹¶åˆ°ä»æŒ‡å®šçš„ DNS ç­–ç•¥ç”Ÿæˆçš„é€‰é¡¹ã€‚ é‡å¤çš„æ¡ç›®å°†è¢«åˆ é™¤ã€‚\n\nä»¥ä¸‹æ˜¯å…·æœ‰è‡ªå®šä¹‰ DNS è®¾ç½®çš„ Pod ç¤ºä¾‹ï¼š\napiVersion: v1kind: Podmetadata:  namespace: default  name: dns-examplespec:  containers:    - name: test      image: nginx  dnsPolicy: &quot;None&quot;  dnsConfig:    nameservers:      - 1.2.3.4    searches:      - ns1.svc.cluster-domain.example      - my.dns.search.suffix    options:      - name: ndots        value: &quot;2&quot;      - name: edns0\n\nåˆ›å»ºä¸Šé¢çš„ Pod åï¼Œå®¹å™¨ test ä¼šåœ¨å…¶ /etc/resolv.conf æ–‡ä»¶ä¸­è·å–ä»¥ä¸‹å†…å®¹ï¼š\nnameserver 1.2.3.4search ns1.svc.cluster-domain.example my.dns.search.suffixoptions ndots:2 edns0\n\nå¯¹äº IPv6 è®¾ç½®ï¼Œæœç´¢è·¯å¾„å’Œåç§°æœåŠ¡å™¨åº”æŒ‰ä»¥ä¸‹æ–¹å¼è®¾ç½®ï¼š\nkubectl exec -it dns-example -- cat /etc/resolv.conf\n\nè¾“å‡ºç±»ä¼¼äºï¼š\nnameserver fd00:79:30::asearch default.svc.cluster-domain.example svc.cluster-domain.example cluster-domain.exampleoptions ndots:5\n\næ‰©å±• DNS é…ç½®ç‰¹æ€§çŠ¶æ€ï¼š Kubernetes 1.22 [alpha]\nå¯¹äº Pod DNS é…ç½®ï¼ŒKubernetes é»˜è®¤å…è®¸æœ€å¤š 6 ä¸ª æœç´¢åŸŸï¼ˆ Search Domainï¼‰ ä»¥åŠä¸€ä¸ªæœ€å¤š 256 ä¸ªå­—ç¬¦çš„æœç´¢åŸŸåˆ—è¡¨ã€‚\nå¦‚æœå¯ç”¨ kube-apiserver å’Œ kubelet çš„ç‰¹æ€§é—¨æ§ ExpandedDNSConfigï¼ŒKubernetes å°†å¯ä»¥æœ‰æœ€å¤š 32 ä¸ª æœç´¢åŸŸä»¥åŠä¸€ä¸ªæœ€å¤š 2048 ä¸ªå­—ç¬¦çš„æœç´¢åŸŸåˆ—è¡¨ã€‚\nä¸‰ã€Windows èŠ‚ç‚¹ä¸Šçš„ DNS è§£æ\nåœ¨ Windows èŠ‚ç‚¹ä¸Šè¿è¡Œçš„ Pod ä¸æ”¯æŒ ClusterFirstWithHostNetã€‚ Windows å°†æ‰€æœ‰å¸¦æœ‰ . çš„åç§°è§†ä¸ºå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰å¹¶è·³è¿‡å…¨é™å®šåŸŸåï¼ˆFQDNï¼‰è§£æã€‚\nåœ¨ Windows ä¸Šï¼Œå¯ä»¥ä½¿ç”¨çš„ DNS è§£æå™¨æœ‰å¾ˆå¤šã€‚ ç”±äºè¿™äº›è§£æå™¨å½¼æ­¤ä¹‹é—´ä¼šæœ‰è½»å¾®çš„è¡Œä¸ºå·®åˆ«ï¼Œå»ºè®®ä½¿ç”¨ Resolve-DNSName powershell cmdlet è¿›è¡Œåç§°æŸ¥è¯¢è§£æã€‚\nåœ¨ Linux ä¸Šï¼Œæœ‰ä¸€ä¸ª DNS åç¼€åˆ—è¡¨ï¼Œå½“è§£æå…¨åå¤±è´¥æ—¶å¯ä»¥ä½¿ç”¨ã€‚ åœ¨ Windows ä¸Šï¼Œä½ åªèƒ½æœ‰ä¸€ä¸ª DNS åç¼€ï¼Œ å³ä¸è¯¥ Pod çš„å‘½åç©ºé—´ç›¸å…³è”çš„ DNS åç¼€ï¼ˆä¾‹å¦‚ï¼šmydns.svc.cluster.localï¼‰ã€‚ Windows å¯ä»¥è§£æå…¨é™å®šåŸŸåï¼ˆFQDNï¼‰ï¼Œå’Œä½¿ç”¨äº†è¯¥ DNS åç¼€çš„ Services æˆ–è€…ç½‘ç»œåç§°ã€‚ ä¾‹å¦‚ï¼Œåœ¨ default å‘½åç©ºé—´ä¸­ç”Ÿæˆä¸€ä¸ª Podï¼Œè¯¥ Pod ä¼šè·å¾—çš„ DNS åç¼€ä¸º default.svc.cluster.localã€‚ åœ¨ Windows çš„ Pod ä¸­ï¼Œä½ å¯ä»¥è§£æ kubernetes.default.svc.cluster.local å’Œ kubernetesï¼Œ ä½†æ˜¯ä¸èƒ½è§£æéƒ¨åˆ†é™å®šåç§°ï¼ˆkubernetes.default å’Œ kubernetes.default.svcï¼‰ã€‚\n\n","categories":["Kubernetes"]},{"title":"Prometheus Operator ç›‘æ§ K8Såº”ç”¨","url":"/posts/64877/","content":"ä¸€ã€Prometheus Operator èƒ½åšä»€ä¹ˆGithub\napi æ–‡æ¡£\nè¦äº†è§£ Prometheus Operator èƒ½åšä»€ä¹ˆï¼Œå…¶å®å°±æ˜¯è¦äº†è§£ Prometheus Operator ä¸ºæˆ‘ä»¬æä¾›äº†å“ªäº›è‡ªå®šä¹‰çš„ Kubernetes èµ„æºï¼Œåˆ—å‡ºäº† Prometheus Operator ç›®å‰æä¾›çš„ï¸4ç±»èµ„æºï¼š\n\nPrometheusï¼šå£°æ˜å¼åˆ›å»ºå’Œç®¡ç† Prometheus Serverå®ä¾‹ï¼›\nPodMonitorï¼šé…ç½® Prometheus éœ€è¦ç›‘æ§çš„ podï¼›\nServiceMonitorï¼šé…ç½® Prometheus éœ€è¦ç›‘æ§çš„ serviceï¼›\nPrometheusRuleï¼šè´Ÿè´£å£°æ˜å¼çš„ç®¡ç†å‘Šè­¦é…ç½®ï¼›\nAlertmanagerï¼šå£°æ˜å¼çš„åˆ›å»ºå’Œç®¡ç† Alertmanager å®ä¾‹ã€‚\n\nç®€è¨€ä¹‹ï¼ŒPrometheus Operatorèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·è‡ªåŠ¨åŒ–çš„åˆ›å»ºä»¥åŠç®¡ç† Prometheus Server ä»¥åŠå…¶ç›¸åº”çš„é…ç½®ã€‚\näºŒã€éƒ¨ç½² Prometheus Operatoråœ¨ Kubernetes ä¸­å®‰è£… Prometheus Operator éå¸¸ç®€å•ï¼Œç”¨æˆ·å¯ä»¥ä»ä»¥ä¸‹åœ°å€ä¸­è·å– Prometheus Operatorçš„æºç ï¼š\ngit clone https://github.com/coreos/prometheus-operator.git\n\nè¿™é‡Œï¼Œæˆ‘ä»¬ä¸º Promethues Operator åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„å‘½åç©ºé—´ monitorï¼š\nkubectl create namespace monitor\n\nç”±äºéœ€è¦å¯¹ Prometheus Operator è¿›è¡Œ RBAC æˆæƒï¼Œè€Œé»˜è®¤çš„ bundle.yaml ä¸­ä½¿ç”¨äº† default å‘½åç©ºé—´ï¼Œå› æ­¤ï¼Œåœ¨å®‰è£… Prometheus Operator ä¹‹å‰éœ€è¦å…ˆæ›¿æ¢ä¸€ä¸‹ bundle.yaml æ–‡ä»¶ä¸­æ‰€æœ‰ namespace å®šä¹‰ï¼Œç”± default ä¿®æ”¹ä¸º monitorã€‚ é€šè¿‡è¿è¡Œä¸€ä¸‹å‘½ä»¤å®‰è£…Prometheus Operatorçš„Deploymentå®ä¾‹ï¼š\nkubectl -n monitor create -f bundle.yaml\n\nPrometheus Operator é€šè¿‡ Deployment çš„å½¢å¼è¿›è¡Œéƒ¨ç½²ï¼Œä¸ºäº†èƒ½å¤Ÿè®© Prometheus Operator èƒ½å¤Ÿç›‘å¬å’Œç®¡ç† Kubernetes èµ„æºåŒæ—¶ä¹Ÿåˆ›å»ºäº†å•ç‹¬çš„ ServiceAccount ä»¥åŠç›¸å…³çš„æˆæƒåŠ¨ä½œã€‚\næŸ¥çœ‹Prometheus Operatoréƒ¨ç½²çŠ¶æ€ï¼Œä»¥ç¡®ä¿å·²æ­£å¸¸è¿è¡Œï¼š\nkubectl get pods -n monitorNAME                                   READY   STATUS    RESTARTS     AGEprometheus-operator-64d6cb9c4d-xpx7f   1/1     Running   8 (2m ago)   24h\n\nä¸‰ã€éƒ¨ç½² Prometheus æœåŠ¡1. åˆ›å»ºå…·æœ‰é›†ç¾¤æƒé™çš„ ServiceAccountç”±äºé»˜è®¤åˆ›å»ºçš„ Prometheus å®ä¾‹ä½¿ç”¨çš„æ˜¯å…¶æ‰€åœ¨å‘½åç©ºé—´ï¼ˆæœ¬æ–‡ä¸­æ˜¯ monitorï¼‰ä¸‹çš„ default è´¦å·ï¼Œè¯¥è´¦å·å¹¶æ²¡æœ‰æƒé™èƒ½å¤Ÿè·å–å…¶ä»–å‘½åç©ºé—´ä¸‹çš„ä»»ä½•èµ„æºä¿¡æ¯ã€‚\nä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ monitor å‘½åç©ºé—´ä¸‹ä¸ºåˆ›å»ºä¸€ä¸ªåä¸º Prometheus çš„ ServiceAccountï¼Œå¹¶ä¸”ä¸ºè¯¥è´¦å·èµ‹äºˆç›¸åº”çš„é›†ç¾¤è®¿é—®æƒé™ã€‚\ncat &lt;&lt;EOF | kubectl -n monitor create -f -apiVersion: v1kind: ServiceAccountmetadata:  name: prometheus  namespace: monitor---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRolemetadata:  name: prometheusrules:- apiGroups: [&quot;&quot;]  resources:  - nodes  - services  - endpoints  - pods  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]- apiGroups: [&quot;&quot;]  resources:  - configmaps  verbs: [&quot;get&quot;]- nonResourceURLs: [&quot;/metrics&quot;]  verbs: [&quot;get&quot;]---apiVersion: rbac.authorization.k8s.io/v1kind: ClusterRoleBindingmetadata:  name: prometheusroleRef:  apiGroup: rbac.authorization.k8s.io  kind: ClusterRole  name: prometheussubjects:- kind: ServiceAccount  name: prometheus  namespace: monitorEOF\n\n2. åˆ›å»º Prometheus å®ä¾‹å½“é›†ç¾¤ä¸­å·²ç»å®‰è£… Prometheus Operator ä¹‹åï¼Œå¯¹äºéƒ¨ç½² Prometheus Server å®ä¾‹å°±å˜æˆäº†å£°æ˜ä¸€ä¸ª Prometheus èµ„æºï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬åœ¨ monitor å‘½åç©ºé—´ä¸‹åˆ›å»ºä¸€ä¸ª Prometheus å®ä¾‹ï¼š\ncat &lt;&lt;EOF | kubectl -n monitor apply -f -apiVersion: monitoring.coreos.com/v1kind: Prometheusmetadata:  name: prometheus  namespace: monitorspec:  serviceAccountName: prometheus  serviceMonitorSelector:    matchLabels:      evn: test  resources:    requests:      memory: 400Mi      cpu: 1EOF\n\nPrometheus é€šè¿‡  serviceMonitorSelector é€‰æ‹©å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„ ServiceMonitor ç›‘æ§é…ç½®ã€‚\npodMonitorSelector é€‰æ‹©å…·æœ‰æŒ‡å®šæ ‡ç­¾çš„ PodMonitor ç›‘æ§é…ç½®ã€‚\næ­¤æ—¶ï¼ŒæŸ¥çœ‹ monitor å‘½åç©ºé—´ä¸‹çš„ statefulsets èµ„æºï¼Œå¯ä»¥çœ‹åˆ° Prometheus Operator è‡ªåŠ¨é€šè¿‡ Statefulset åˆ›å»ºçš„ Prometheus å®ä¾‹ï¼š\nkubectl get statefulsets -n monitorNAME              READY   AGEprometheus-inst   0/1     2m58s\n\næŸ¥çœ‹ Pod å®ä¾‹ï¼š\nkubectl get pods -n monitorNAME                                   READY   STATUS    RESTARTS   AGEprometheus-prometheus-0                      2/2     Running   0          64sprometheus-operator-64d6cb9c4d-j2n9t   1/1     Running   0          32m\n\n3. è®¿é—® Prometheus ç•Œé¢é€šè¿‡ port-forward è®¿é—® Prometheus å®ä¾‹:\nkubectl -n monitor port-forward statefulsets/prometheus-prometheus 9090:9090\n\né€šè¿‡ http://localhost:9090 å¯ä»¥åœ¨æœ¬åœ°ç›´æ¥è®¿é—® Prometheus Operator åˆ›å»ºçš„ Prometheus å®ä¾‹ã€‚\nå››ã€ä½¿ç”¨ ServiceMonitor ç®¡ç†ç›‘æ§é…ç½®ä¿®æ”¹ç›‘æ§é…ç½®é¡¹ä¹Ÿæ˜¯ Prometheus ä¸‹å¸¸ç”¨çš„è¿ç»´æ“ä½œä¹‹ä¸€ï¼Œä¸ºäº†èƒ½å¤Ÿè‡ªåŠ¨åŒ–çš„ç®¡ç† Prometheus çš„é…ç½®ï¼ŒPrometheus Operator ä½¿ç”¨äº†è‡ªå®šä¹‰èµ„æºç±»å‹ ServiceMonitor å’Œ PodMonitor åˆ†åˆ«æ¥æè¿°ç›‘æ§çš„ service å’Œ podã€‚\n1. éƒ¨ç½²ç¤ºä¾‹åº”ç”¨cat &lt;&lt;EOF | kubectl create -f -apiVersion: apps/v1kind: Deploymentmetadata:  name: example-app  namespace: defaultspec:  replicas: 3  selector:    matchLabels:      app: example-app  template:    metadata:      labels:        app: example-app    spec:      containers:      - name: example-app        image: fabxc/instrumented_app        ports:        - name: web          containerPort: 8080EOF\n\nç¤ºä¾‹åº”ç”¨ä¼šé€šè¿‡ Deployment åˆ›å»º3ä¸ªPodå®ä¾‹ï¼Œå¹¶ä¸”é€šè¿‡ Service æš´éœ²åº”ç”¨è®¿é—®ä¿¡æ¯ã€‚\nkubectl get podsNAME                           READY   STATUS    RESTARTS   AGEexample-app-7d95cbf666-755k4   1/1     Running   0          2m6sexample-app-7d95cbf666-grvxp   1/1     Running   0          2m6sexample-app-7d95cbf666-z245c   1/1     Running   0          2m6s\n\nåœ¨æœ¬åœ°åŒæ ·é€šè¿‡ port-forward è®¿é—®ä»»æ„Podå®ä¾‹\nkubectl port-forward deployments/example-app 8080:8080\n\nè®¿é—®æœ¬åœ°çš„ http://localhost:8080/metrics å®ä¾‹åº”ç”¨ç¨‹åºä¼šè¿”å›æŒ‡æ ‡æ•°æ®ã€‚\n2. ç»™æœåŠ¡æ·»åŠ ç›‘æ§åœ¨åŸç”Ÿçš„ Prometheus é…ç½®æ–¹å¼ä¸­ï¼Œæˆ‘ä»¬åœ¨ Prometheus é…ç½®æ–‡ä»¶ä¸­é™æ€çš„å®šä¹‰ job ï¼Œä¸ºäº†èƒ½å¤Ÿè®© Prometheus èƒ½å¤Ÿé‡‡é›†éƒ¨ç½²åœ¨ Kubernetes ä¸‹åº”ç”¨çš„ç›‘æ§æ•°æ®ï¼Œå¯ä»¥é€šè¿‡éƒ¨ç½² ServiceMonitor æˆ– PodMonitor æ¥å®ç°ï¼Œé…ç½®åçš„å®é™… job_name åç§°å°±æ˜¯ namespace/name çš„å½¢å¼\næ–¹å¼ä¸€ï¼šServiceMonitorè€Œåœ¨ Prometheus Operator ä¸­ï¼Œåˆ™å¯ä»¥ç›´æ¥å£°æ˜ä¸€ä¸ª ServiceMonitor å¯¹è±¡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\ncat &lt;&lt;EOF | kubectl apply -f -apiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:  name: example-app  namespace: monitor  labels:    evn: testspec:  namespaceSelector:    matchNames:    - default  selector:    matchLabels:      app: example-app    # ç»™ service æ‰“çš„æ ‡ç­¾  endpoints:  - port: web        # è¿™é‡Œæ˜¯ service ä¸­çš„name    path: /metrics   # è·¯å¾„ï¼Œæ²¡æœ‰é»˜è®¤ /metrics    interval: 15s    # Prometheuså¯¹å½“å‰endpointsé‡‡é›†çš„å‘¨æœŸï¼Œå•ä½ä¸ºç§’EOF\n\né€šè¿‡å®šä¹‰ selector ä¸­çš„æ ‡ç­¾å®šä¹‰é€‰æ‹©ç›‘æ§ç›®æ ‡çš„ service å¯¹è±¡ï¼ŒåŒæ—¶åœ¨ endpoints ä¸­æŒ‡å®š port åç§°ä¸º web çš„ç«¯å£ã€‚\né»˜è®¤æƒ…å†µä¸‹ ServiceMonitor å’Œç›‘æ§å¯¹è±¡å¿…é¡»æ˜¯åœ¨ç›¸åŒ Namespace ä¸‹çš„ã€‚\nåœ¨æœ¬ç¤ºä¾‹ä¸­ç”±äº Prometheus æ˜¯éƒ¨ç½²åœ¨ monitor å‘½åç©ºé—´ä¸‹ï¼Œå› æ­¤ä¸ºäº†èƒ½å¤Ÿå…³è” default å‘½åç©ºé—´ä¸‹çš„ example å¯¹è±¡ï¼Œéœ€è¦ä½¿ç”¨ namespaceSelector å®šä¹‰è®©å…¶å¯ä»¥è·¨å‘½åç©ºé—´å…³è” ServiceMonitor èµ„æºã€‚\nå¦‚æœå¸Œæœ› ServiceMonitor å¯ä»¥å…³è”ä»»æ„å‘½åç©ºé—´ä¸‹çš„æ ‡ç­¾ï¼Œåˆ™é€šè¿‡ä»¥ä¸‹æ–¹å¼å®šä¹‰ï¼š\nspec:  namespaceSelector:    any: true\n\nå¦‚æœç›‘æ§çš„ Target å¯¹è±¡å¯ç”¨äº† BasicAuth è®¤è¯ï¼Œé‚£åœ¨å®šä¹‰ ServiceMonitor å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ endpoints é…ç½®ä¸­å®šä¹‰ basicAuth å¦‚ä¸‹æ‰€ç¤ºï¼š\napiVersion: monitoring.coreos.com/v1kind: ServiceMonitormetadata:  name: example-app-service-monitor  namespace: monitor  labels:    team: frontendspec:  namespaceSelector:    matchNames:    - default  selector:    matchLabels:      app: example-app  endpoints:  - basicAuth:      password:        name: basic-auth        key: password      username:        name: basic-auth        key: user    port: web\n\nå…¶ä¸­ basicAuth ä¸­å…³è”äº†åä¸º basic-auth çš„ Secret å¯¹è±¡ï¼Œç”¨æˆ·éœ€è¦æ‰‹åŠ¨å°†è®¤è¯ä¿¡æ¯ä¿å­˜åˆ°Secretä¸­:\napiVersion: v1kind: Secretmetadata:  name: basic-authdata:  password: dG9vcg== # base64ç¼–ç åçš„å¯†ç   user: YWRtaW4= # base64ç¼–ç åçš„ç”¨æˆ·åtype: Opaque\n\næ–¹å¼äºŒï¼šPodMonitorcat &lt;&lt;EOF | kubectl apply -f -apiVersion: monitoring.coreos.com/v1kind: PodMonitormetadata:  name: example-app-pod-monitor  namespace: monitor  labels:    env: testspec:  namespaceSelector:    matchNames:      - has-yum-test  selector:    matchLabels:      app: example-app  podMetricsEndpoints:    - path: /metrics      port: webEOF\n\näº”ã€éƒ¨ç½² Grafanaè¿™é‡Œæ²¡æœ‰å¯¹ Grafana è¿›è¡ŒæŒ‚è½½ã€‚\ncat &lt;&lt;EOF | kubectl apply -f -kind: DeploymentapiVersion: apps/v1metadata:  labels:    app: grafana  name: grafana  namespace: monitorspec:  replicas: 1  revisionHistoryLimit: 10  selector:    matchLabels:      app: grafana  template:    metadata:      labels:        app: grafana    spec:      securityContext:        runAsUser: 0      containers:        - name: grafana          image: grafana/grafana:latest          imagePullPolicy: IfNotPresent          env:            - name: GF_AUTH_BASIC_ENABLED              value: &quot;true&quot;            - name: GF_AUTH_ANONYMOUS_ENABLED              value: &quot;false&quot;            - name: GF_SECURITY_ADMIN_USER              value: &quot;admin&quot;            - name: GF_SECURITY_ADMIN_PASSWORD              value: &quot;admin&quot;          readinessProbe:            httpGet:              path: /login              port: 3000          ports:            - containerPort: 3000              protocol: TCP---kind: ServiceapiVersion: v1metadata:  labels:    app: grafana  name: grafana  namespace: monitorspec:  ports:    - port: 3000      targetPort: 3000  selector:    app: grafanaEOF\n\nåœ¨ç¬¬ä¸‰æ­¥éƒ¨ç½² Prometheus çš„æ—¶å€™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåå­—æ˜¯ prometheus-operated çš„ serviceï¼Œæ‰€ä»¥åœ¨ Grafana ä¸­é…ç½® prometheus æ—¶åœ°å€å¡« http://prometheus-operated.monitor:9090 å³å¯ã€‚\n","categories":["Kubernetes"]},{"title":"k8s ä½¿ç”¨ nsenter æŠ“åŒ…","url":"/posts/3066/","content":"ä¸€ã€æ ¼å¼nsenter [options] [&lt;program&gt; [&lt;argument&gt;...]]Run a program with namespaces of other processes.Options: -a, --all              enter all namespaces -t, --target &lt;pid&gt;     target process to get namespaces from -m, --mount[=&lt;file&gt;]   enter mount namespace -u, --uts[=&lt;file&gt;]     enter UTS namespace (hostname etc) -i, --ipc[=&lt;file&gt;]     enter System V IPC namespace -n, --net[=&lt;file&gt;]     enter network namespace -p, --pid[=&lt;file&gt;]     enter pid namespace -C, --cgroup[=&lt;file&gt;]  enter cgroup namespace -U, --user[=&lt;file&gt;]    enter user namespace -T, --time[=&lt;file&gt;]    enter time namespace -S, --setuid &lt;uid&gt;     set uid in entered namespace -G, --setgid &lt;gid&gt;     set gid in entered namespace     --preserve-credentials do not touch uids or gids -r, --root[=&lt;dir&gt;]     set the root directory -w, --wd[=&lt;dir&gt;]       set the working directory -F, --no-fork          do not fork before exec&#x27;ing &lt;program&gt; -Z, --follow-context   set SELinux context according to --target PID\n\näºŒã€æŠ“åŒ…1.è·å–podèŠ‚ç‚¹ä¿¡æ¯kubectl get pod pod-name -n namespace -o wide\n\nç„¶åè¿›å…¥podæ‰€åœ¨node\n2.è·å–podå®¹å™¨idContainerd è¿è¡Œæ—¶\n$ kubectl get pod pod-name -n namespace -o yaml | grep containerID  - containerID: containerd://1904197bb55ded3bcb1b75939f595993be9d34d42a732b707d8c083196f03a44\n\nDocker è¿è¡Œæ—¶\n$ kubectl get pod pod-name -n namespace -o yaml | grep containerID  - containerID: docker://1904197bb55ded3bcb1b75939f595993be9d34d42a732b707d8c083196f03a44\n\n3.è·å–pod PIDContainerd è¿è¡Œæ—¶\n$ crictl inspect 1904197bb55ded3bcb1b75939f595993be9d34d42a732b707d8c083196f03a44 | grep -i pid    &quot;pid&quot;: 2209352,    &quot;pid&quot;: 1    &quot;type&quot;: &quot;pid&quot;\n\nDocker è¿è¡Œæ—¶\n$ docker inspect 1904197bb55ded3bcb1b75939f595993be9d34d42a732b707d8c083196f03a44 | grep -i pid    &quot;pid&quot;: 2209352,    &quot;PidMode&quot;: 1    &quot;PidsLimit&quot;: &quot;0&quot;\n\n4.æŠ“åŒ…nsenter -t 2209352 -n tcpdump -i eth0 -n -nn dst port 8083\n\nç„¶ååœ¨nodeèŠ‚ç‚¹ä¸Šå°±èƒ½çœ‹åˆ°æŠ“åŒ…çš„æ–‡ä»¶äº†ã€‚\n","categories":["Kubernetes"]},{"title":"k8s ç‰ˆæœ¬å›é€€","url":"/posts/30022/","content":"1. æŸ¥çœ‹å†å²è®°å½•kubectl -n monitor rollout history deployment/myDep\n\n2. æŸ¥çœ‹æŸä¸ªå†å²è¯¦æƒ…kubectl -n monitor rollout history deployment/myDep --revision=10\n\n3. å›æ»šåˆ°ä¸Šä¸ªç‰ˆæœ¬kubectl -n monitor rollout undo deployment/myDep\n\n4. å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬kubectl -n monitor rollout undo deployment/myDep --to-revision=11\n\n","categories":["Kubernetes"]},{"title":"k8så‘½ä»¤","url":"/posts/48999/","content":"1ã€é‡å¯PODkubectl get pod &#123;podname&#125; -n &#123;namespace&#125; -o yaml | kubectl replace --force -f -\n\n2ã€æŸ¥çœ‹ä»£ç†æ¨¡å¼$ kubectl get pods -n kube-system -o wide | grep proxykube-proxy-flnqq                                  1/1     Running     0          10d     10.172.5.3      10.172.5.3    &lt;none&gt;           &lt;none&gt;kube-proxy-wlzxh                                  1/1     Running     0          10d     10.172.5.10     10.172.5.10   &lt;none&gt;           &lt;none&gt;\n\n$ kubectl logs kube-proxy-wlzxh -n kube-systemFri Dec 31 14:05:26 CST 2021: set iptables to nft modeI1231 14:05:26.800004       1 flags.go:33] FLAG: --add-dir-header=&quot;false&quot;I1231 14:05:26.800036       1 flags.go:33] FLAG: --alsologtostderr=&quot;false&quot;I1231 14:05:26.800039       1 flags.go:33] FLAG: --bind-address=&quot;0.0.0.0&quot;I1231 14:05:26.800044       1 flags.go:33] FLAG: --cleanup=&quot;false&quot;I1231 14:05:26.800051       1 flags.go:33] FLAG: --cleanup-ipvs=&quot;true&quot;\n\n","categories":["Kubernetes"]},{"title":"Linux æŸ¥çœ‹ç£ç›˜å ç”¨æƒ…å†µ","url":"/posts/4155/","content":"1ã€æŸ¥çœ‹ç£ç›˜çŠ¶æ€[root@delivery-test ~]# df -hFilesystem      Size  Used Avail Use% Mounted ondevtmpfs        3.9G     0  3.9G   0% /devtmpfs           3.9G     0  3.9G   0% /dev/shmtmpfs           3.9G  410M  3.5G  11% /runtmpfs           3.9G     0  3.9G   0% /sys/fs/cgroup/dev/sda1        40G   40G   20K 100% /tmpfs           799M     0  799M   0% /run/user/0overlay          40G   40G   20K 100% /var/lib/docker/overlay2/2f948926a76c2201c01918b47d54bb87db7deac28ac2a1586820e2a0163fe471/mergedshm              64M     0   64M   0% /var/lib/docker/containers/fc77375a461d6a68d3d7af41519c194662d405ce131d50793963e734b8131f42/shm\n\n2ã€æŸ¥çœ‹å„ä¸ªæ–‡ä»¶ç£ç›˜å ç”¨æƒ…å†µå‘½ä»¤ä¸­çš„ / è¡¨ç¤ºè·Ÿç›®å½•ï¼Œä¹Ÿå¯ä»¥è¯• /home ç­‰ï¼Œå¯æ ¹æ®æƒ…å†µè‡ªè¡Œä¿®æ”¹ã€‚\n[root@delivery-test ~]# du -sh /*0\t/bin154M\t/boot0\t/dev36M\t/etc37G\t/home0\t/lib4.3M\t/root1.5M\t/tmp1.6G\t/usr530M\t/var\n\n3ã€æŸ¥çœ‹inodeså®¹é‡å½“ç£ç›˜å®¹é‡æˆ–inodeå®¹é‡ä»»æ„ä¸€ä¸ªä¸è¶³æ—¶å°±éƒ½ä¼šæç¤º No space left on deviceã€‚\næŸ¥çœ‹åè¿›å…¥å ç”¨ç‡é«˜çš„ç›®å½•åˆ é™¤æ— ç”¨æ–‡ä»¶å³å¯ã€‚\n[root@delivery-test /]# df -ihFilesystem     Inodes IUsed IFree IUse% Mounted ondevtmpfs         996K   384  995K    1% /devtmpfs            998K     1  998K    1% /dev/shmtmpfs            998K   566  998K    1% /runtmpfs            998K    16  998K    1% /sys/fs/cgroup/dev/sda1        106K  106K   923  100% /tmpfs            998K     1  998K    1% /run/user/0overlay          106K  106K   923  100% /var/lib/docker/overlay2/2f9489a0163fe471/mergedshm              998K     1  998K    1% /var/lib/docker/containers/fc7834b8131f42/shm\n\n4ã€æŸ¥çœ‹æ–‡ä»¶æ•°é‡inodes çˆ†æ»¡é‚£å°±æŸ¥çœ‹ä¸€ä¸‹å“ªäº›åœ°æ–¹æ–‡ä»¶æ•°é‡è¿‡å¤šã€‚\næ ¹æ®ä¸Šè¾¹çš„ä¿¡æ¯ / ç›®å½•çš„ inodes å ç”¨ç‡ä¸º 100% æ‰€ä»¥æŸ¥çœ‹å…¶ä¸‹æ–‡ä»¶ï¼Œå°†æ— ç”¨æ–‡ä»¶åˆ é™¤å³å¯ï¼Œè¿›è¡Œåˆ é™¤å³å¯ã€‚\nfor i in /*; do echo $i; find $i |wc -l; done\n\n5ã€åƒµå°¸è¿›ç¨‹è‹¥ç£ç›˜å®¹é‡å’Œ inodes å®¹é‡éƒ½æ­£å¸¸ä½†è¿˜æ˜¯æ²¡æœ‰ç£ç›˜ç©ºé—´ï¼Œåˆ™éœ€æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å·²è¢«åˆ é™¤çš„æ–‡ä»¶ï¼ŒçŠ¶æ€ä¸º deleted\nlsof | grep deleted\n\næ ¹æ®è¿›ç¨‹å·ï¼Œå°†å…¶ kill æ‰å³å¯ã€‚è‹¥ä¸æ¸…æ¥šè¯¥è¿›ç¨‹ä½œç”¨è¯·å‹¿éšæ„ kill\nåŸç†ï¼š\nåœ¨linuxä¸Šè¢«åˆ é™¤çš„æ–‡ä»¶ä»è¢«å…¶ä»–è¿›ç¨‹æ‰€ä½¿ç”¨ï¼Œæ–‡ä»¶å¥æŸ„æ²¡æœ‰å®Œå…¨é‡Šæ”¾å‡ºæ¥ï¼Œå¯¼è‡´ç©ºé—´æ— æ³•é‡Šæ”¾å‡ºæ¥,åœ¨Linuxæˆ–è€…Unixç³»ç»Ÿä¸­ï¼Œé€šè¿‡rmæˆ–è€…æ–‡ä»¶ç®¡ç†å™¨åˆ é™¤æ–‡ä»¶å°†ä¼šä»æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„ä¸Šè§£é™¤é“¾æ¥(unlink).ç„¶è€Œå¦‚æœæ–‡ä»¶æ˜¯è¢«æ‰“å¼€çš„ï¼ˆæœ‰ä¸€ä¸ªè¿›ç¨‹æ­£åœ¨ä½¿ç”¨ï¼‰ï¼Œé‚£ä¹ˆè¿›ç¨‹å°†ä»ç„¶å¯ä»¥è¯»å–è¯¥æ–‡ä»¶ï¼Œç£ç›˜ç©ºé—´ä¹Ÿä¸€ç›´è¢«å ç”¨ã€‚\n","categories":["è¿ç»´","Linux"]},{"title":"Linux æŸ¥çœ‹ç«¯å£å ç”¨","url":"/posts/59330/","content":"ä¸€ã€lsoflsof(list open files)æ˜¯ä¸€ä¸ªåˆ—å‡ºå½“å‰ç³»ç»Ÿæ‰“å¼€æ–‡ä»¶çš„å·¥å…·ã€‚\nlsof æŸ¥çœ‹ç«¯å£å ç”¨è¯­æ³•æ ¼å¼ï¼š\nlsof -i:ç«¯å£å·\n\nå®ä¾‹æŸ¥çœ‹æœåŠ¡å™¨ 8000 ç«¯å£çš„å ç”¨æƒ…å†µï¼š\n# lsof -i:8000COMMAND   PID USER   FD   TYPE   DEVICE SIZE/OFF NODE NAMEnodejs  26993 root   10u  IPv4 37999514      0t0  TCP *:8000 (LISTEN)\n\nå¯ä»¥çœ‹åˆ° 8000 ç«¯å£å·²ç»è¢«è½» nodejs æœåŠ¡å ç”¨ã€‚\nlsof -i éœ€è¦ root ç”¨æˆ·çš„æƒé™æ¥æ‰§è¡Œã€‚\n\nCOMMANDï¼šè¿›ç¨‹çš„åç§°\nPIDï¼šè¿›ç¨‹æ ‡è¯†ç¬¦\nUSERï¼šè¿›ç¨‹æ‰€æœ‰è€…\nFDï¼šæ–‡ä»¶æè¿°ç¬¦\nTYPEï¼šæ–‡ä»¶ç±»å‹\nDEVICDï¼šæŒ‡å®šç£ç›˜çš„åç§°\nSIZEï¼šæ–‡ä»¶å¤§å°\nNODEï¼šç´¢å¼•èŠ‚ç‚¹ï¼ˆæ–‡ä»¶åœ¨ç£ç›˜ä¸Šçš„æ ‡è¯†ï¼‰\nNAMEï¼šæ‰“å¼€æ–‡ä»¶çš„ç¡®åˆ‡åç§°\n\næ›´å¤š lsof çš„å‘½ä»¤å¦‚ä¸‹ï¼šlsof -i:8080ï¼šæŸ¥çœ‹8080ç«¯å£å ç”¨lsof abc.txtï¼šæ˜¾ç¤ºå¼€å¯æ–‡ä»¶abc.txtçš„è¿›ç¨‹lsof -c abcï¼šæ˜¾ç¤ºabcè¿›ç¨‹ç°åœ¨æ‰“å¼€çš„æ–‡ä»¶lsof -c -p 1234ï¼šåˆ—å‡ºè¿›ç¨‹å·ä¸º1234çš„è¿›ç¨‹æ‰€æ‰“å¼€çš„æ–‡ä»¶lsof -g gidï¼šæ˜¾ç¤ºå½’å±gidçš„è¿›ç¨‹æƒ…å†µlsof +d /usr/local/ï¼šæ˜¾ç¤ºç›®å½•ä¸‹è¢«è¿›ç¨‹å¼€å¯çš„æ–‡ä»¶lsof +D /usr/local/ï¼šåŒä¸Šï¼Œä½†æ˜¯ä¼šæœç´¢ç›®å½•ä¸‹çš„ç›®å½•ï¼Œæ—¶é—´è¾ƒé•¿lsof -d 4ï¼šæ˜¾ç¤ºä½¿ç”¨fdä¸º4çš„è¿›ç¨‹lsof -i -Uï¼šæ˜¾ç¤ºæ‰€æœ‰æ‰“å¼€çš„ç«¯å£å’ŒUNIX domainæ–‡ä»¶\n\näºŒã€netstatnetstat -tunlp ç”¨äºæ˜¾ç¤º tcpï¼Œudp çš„ç«¯å£å’Œè¿›ç¨‹ç­‰ç›¸å…³æƒ…å†µã€‚\nnetstat æŸ¥çœ‹ç«¯å£å ç”¨è¯­æ³•æ ¼å¼ï¼š\nnetstat -tunlp | grep ç«¯å£å·\n\n\n-t (tcp) ä»…æ˜¾ç¤ºtcpç›¸å…³é€‰é¡¹\n-u (udp)ä»…æ˜¾ç¤ºudpç›¸å…³é€‰é¡¹\n-n æ‹’ç»æ˜¾ç¤ºåˆ«åï¼Œèƒ½æ˜¾ç¤ºæ•°å­—çš„å…¨éƒ¨è½¬åŒ–ä¸ºæ•°å­—\n-l ä»…åˆ—å‡ºåœ¨Listen(ç›‘å¬)çš„æœåŠ¡çŠ¶æ€\n-p æ˜¾ç¤ºå»ºç«‹ç›¸å…³é“¾æ¥çš„ç¨‹åºå\n\nä¾‹å¦‚æŸ¥çœ‹ 8000 ç«¯å£çš„æƒ…å†µï¼Œä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š\n# netstat -tunlp | grep 8000tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      26993/nodejs   \n\næ›´å¤šå‘½ä»¤ï¼š\nnetstat -ntlp   //æŸ¥çœ‹å½“å‰æ‰€æœ‰tcpç«¯å£netstat -ntulp | grep 80   //æŸ¥çœ‹æ‰€æœ‰80ç«¯å£ä½¿ç”¨æƒ…å†µnetstat -ntulp | grep 3306   //æŸ¥çœ‹æ‰€æœ‰3306ç«¯å£ä½¿ç”¨æƒ…å†µ","categories":["è¿ç»´","Linux"]},{"title":"NUMA æ¶æ„","url":"/posts/29679/","content":"ç›¸å…³æ–‡ç« ï¼š\nhttps://zhuanlan.zhihu.com/p/62795773\nåŸºæœ¬æ¦‚å¿µSMP VS. AMP\nSMP(Symmetric Multiprocessing)ï¼Œ å³å¯¹ç§°å¤šå¤„ç†å™¨æ¶æ„ï¼Œæ˜¯ç›®å‰æœ€å¸¸è§çš„å¤šå¤„ç†å™¨è®¡ç®—æœºæ¶æ„ã€‚\nAMP(Asymmetric Multiprocessing)ï¼Œ å³éå¯¹ç§°å¤šå¤„ç†å™¨æ¶æ„ï¼Œåˆ™æ˜¯ä¸SMPç›¸å¯¹çš„æ¦‚å¿µã€‚\n\né‚£ä¹ˆä¸¤è€…ä¹‹é—´çš„ä¸»è¦åŒºåˆ«æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ æ€»ç»“ä¸‹æ¥æœ‰è¿™ä¹ˆå‡ ç‚¹ï¼Œ\n\nSMPçš„å¤šä¸ªå¤„ç†å™¨éƒ½æ˜¯åŒæ„çš„ï¼Œä½¿ç”¨ç›¸åŒæ¶æ„çš„CPUï¼›è€ŒAMPçš„å¤šä¸ªå¤„ç†å™¨åˆ™å¯èƒ½æ˜¯å¼‚æ„çš„ã€‚\nSMPçš„å¤šä¸ªå¤„ç†å™¨å…±äº«åŒä¸€å†…å­˜åœ°å€ç©ºé—´ï¼›è€ŒAMPçš„æ¯ä¸ªå¤„ç†å™¨åˆ™æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„åœ°å€ç©ºé—´ã€‚\nSMPçš„å¤šä¸ªå¤„ç†å™¨æ“é€šå¸¸å…±äº«ä¸€ä¸ªæ“ä½œç³»ç»Ÿçš„å®ä¾‹ï¼›è€ŒAMPçš„æ¯ä¸ªå¤„ç†å™¨å¯ä»¥æœ‰æˆ–è€…æ²¡æœ‰è¿è¡Œæ“ä½œç³»ç»Ÿï¼Œ è¿è¡Œæ“ä½œç³»ç»Ÿçš„CPUä¹Ÿæ˜¯åœ¨è¿è¡Œå¤šä¸ªç‹¬ç«‹çš„å®ä¾‹ã€‚\nSMPçš„å¤šå¤„ç†å™¨ä¹‹é—´å¯ä»¥é€šè¿‡å…±äº«å†…å­˜æ¥ååŒé€šä¿¡ï¼›è€ŒAMPåˆ™éœ€è¦æä¾›ä¸€ç§å¤„ç†å™¨é—´çš„é€šä¿¡æœºåˆ¶ã€‚\n\nSMPå’ŒAMPçš„æ·±å…¥ä»‹ç»å¾ˆå¤šç»å…¸æ–‡ç« ä¹¦ç±å¯å‚è€ƒï¼Œæ­¤å¤„ä¸å†èµ˜è¿°ã€‚ç°ä»Šä¸»æµçš„x86å¤šå¤„ç†å™¨æœåŠ¡å™¨éƒ½æ˜¯SMPæ¶æ„çš„ï¼Œ è€Œå¾ˆå¤šåµŒå…¥å¼ç³»ç»Ÿåˆ™æ˜¯AMPæ¶æ„çš„ã€‚\nNUMA VS. UMANUMA(Non-Uniform Memory Access) éå‡åŒ€å†…å­˜è®¿é—®æ¶æ„æ˜¯æŒ‡å¤šå¤„ç†å™¨ç³»ç»Ÿä¸­ï¼Œå†…å­˜çš„è®¿é—®æ—¶é—´æ˜¯ä¾èµ–äºå¤„ç†å™¨å’Œå†…å­˜ä¹‹é—´çš„ç›¸å¯¹ä½ç½®çš„ã€‚ è¿™ç§è®¾è®¡é‡Œå­˜åœ¨å’Œå¤„ç†å™¨ç›¸å¯¹è¿‘çš„å†…å­˜ï¼Œé€šå¸¸è¢«ç§°ä½œæœ¬åœ°å†…å­˜ï¼›è¿˜æœ‰å’Œå¤„ç†å™¨ç›¸å¯¹è¿œçš„å†…å­˜ï¼Œ é€šå¸¸è¢«ç§°ä¸ºéæœ¬åœ°å†…å­˜ã€‚\nUMA(Uniform Memory Access) å‡åŒ€å†…å­˜è®¿é—®æ¶æ„åˆ™æ˜¯ä¸NUMAç›¸åï¼Œæ‰€ä»¥å¤„ç†å™¨å¯¹å…±äº«å†…å­˜çš„è®¿é—®è·ç¦»å’Œæ—¶é—´æ˜¯ç›¸åŒçš„ã€‚\nç”±æ­¤å¯çŸ¥ï¼Œä¸è®ºæ˜¯NUMAè¿˜æ˜¯UMAéƒ½æ˜¯SMPæ¶æ„çš„ä¸€ç§è®¾è®¡å’Œå®ç°ä¸Šçš„é€‰æ‹©ã€‚\né˜…è¯»æ–‡æ¡£æ—¶ï¼Œä¹Ÿå¸¸å¸¸èƒ½çœ‹åˆ°**ccNUMA(Cache Coherent NUMA)**ï¼Œå³ç¼“å­˜ä¸€è‡´æ€§NUMAæ¶æ„ã€‚ è¿™ç§æ¶æ„ä¸»è¦æ˜¯åœ¨NUMAæ¶æ„ä¹‹ä¸Šä¿è¯äº†å¤šå¤„ç†å™¨ä¹‹é—´çš„ç¼“å­˜ä¸€è‡´æ€§ã€‚é™ä½äº†ç³»ç»Ÿç¨‹åºçš„ç¼–å†™éš¾åº¦ã€‚\nx86å¤šå¤„ç†å™¨å‘å±•å†å²ä¸Šï¼Œæ—©æœŸçš„å¤šæ ¸å’Œå¤šå¤„ç†å™¨ç³»ç»Ÿéƒ½æ˜¯UMAæ¶æ„çš„ã€‚è¿™ç§æ¶æ„ä¸‹ï¼Œ å¤šä¸ªCPUé€šè¿‡åŒä¸€ä¸ªåŒ—æ¡¥(North Bridge)èŠ¯ç‰‡ä¸å†…å­˜é“¾æ¥ã€‚åŒ—æ¡¥èŠ¯ç‰‡é‡Œé›†æˆäº†å†…å­˜æ§åˆ¶å™¨(Memory Controller)ï¼Œ\nä¸‹å›¾æ˜¯ä¸€ä¸ªå…¸å‹çš„æ—©æœŸ x86 UMA ç³»ç»Ÿï¼Œå››è·¯å¤„ç†å™¨é€šè¿‡ FSB (å‰ç«¯ç³»ç»Ÿæ€»çº¿, Front Side Bus) å’Œä¸»æ¿ä¸Šçš„å†…å­˜æ§åˆ¶å™¨èŠ¯ç‰‡ (MCH, Memory Controller Hub) ç›¸è¿ï¼ŒDRAM æ˜¯ä»¥ UMA æ–¹å¼ç»„ç»‡çš„ï¼Œå»¶è¿Ÿå¹¶æ— è®¿é—®å·®å¼‚ã€‚\n]\n\næ³¨ï¼š\n\nPCH(Platform Controller Hub)ï¼ŒIntel äº 2008 å¹´èµ·é€€å‡ºçš„ä¸€ç³»åˆ—æ™¶ç‰‡ç»„ï¼Œç”¨äºå–ä»£ä»¥å¾€çš„ I/O Controller Hubï¼ˆICH)\n\n\nåœ¨ UMA æ¶æ„ä¸‹ï¼ŒCPU å’Œå†…å­˜æ§åˆ¶å™¨ä¹‹é—´çš„å‰ç«¯æ€»çº¿ (FSB) åœ¨ç³»ç»Ÿ CPU æ•°é‡ä¸æ–­å¢åŠ çš„å‰æä¸‹ï¼Œ æˆä¸ºäº†ç³»ç»Ÿæ€§èƒ½çš„ç“¶é¢ˆã€‚å› æ­¤ï¼ŒAMD åœ¨å¼•å…¥ 64 ä½ x86 æ¶æ„æ—¶ï¼Œå®ç°äº† NUMA æ¶æ„ã€‚ä¹‹åï¼Œ Intel ä¹Ÿæ¨å‡ºäº† x64 çš„ Nehalem æ¶æ„ï¼Œx86 ç»ˆäºå…¨é¢è¿›å…¥åˆ° NUMA æ—¶ä»£ã€‚x86 NUMA ç›®å‰çš„å®ç°å±äº ccNUMAã€‚\nä» Nehalem æ¶æ„å¼€å§‹ï¼Œx86 å¼€å§‹è½¬å‘ NUMA æ¶æ„ï¼Œå†…å­˜æ§åˆ¶å™¨èŠ¯ç‰‡è¢«é›†æˆåˆ°å¤„ç†å™¨å†…éƒ¨ï¼Œå¤šä¸ªå¤„ç†å™¨é€šè¿‡ QPI é“¾è·¯ç›¸è¿ï¼Œä»æ­¤ DRAM æœ‰äº†è¿œè¿‘ä¹‹åˆ†ã€‚ è€Œ Sandybridge æ¶æ„åˆ™æ›´è¿‘ä¸€æ­¥ï¼Œå°†ç‰‡å¤–çš„ IOH èŠ¯ç‰‡ä¹Ÿé›†æˆåˆ°äº†å¤„ç†å™¨å†…éƒ¨ï¼Œè‡³æ­¤ï¼Œå†…å­˜æ§åˆ¶å™¨å’Œ PCIe Root Complex å…¨éƒ¨åœ¨å¤„ç†å™¨å†…éƒ¨äº†ã€‚ ä¸‹å›¾å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ x86 çš„ NUMA æ¶æ„ï¼š\n\n\nNUMA HierarchyNUMA Node å†…éƒ¨ä¸€ä¸ªNUMA Nodeå†…éƒ¨æ˜¯ç”±ä¸€ä¸ªç‰©ç†CPUå’Œå®ƒæ‰€æœ‰çš„æœ¬åœ°å†…å­˜(Local Memory)ç»„æˆçš„ã€‚å¹¿ä¹‰å¾—è®²ï¼Œ ä¸€ä¸ªNUMA Nodeå†…éƒ¨è¿˜åŒ…å«æœ¬åœ°IOèµ„æºï¼Œå¯¹å¤§å¤šæ•°Intel x86 NUMAå¹³å°æ¥è¯´ï¼Œä¸»è¦æ˜¯PCIeæ€»çº¿èµ„æºã€‚ ACPIè§„èŒƒå°±æ˜¯è¿™ä¹ˆæŠ½è±¡ä¸€ä¸ªNUMA Nodeçš„ã€‚\nç‰©ç† CPUä¸€ä¸ªCPU Socketé‡Œå¯ä»¥ç”±å¤šä¸ªCPU Coreå’Œä¸€ä¸ªUncoreéƒ¨åˆ†ç»„æˆã€‚æ¯ä¸ªCPU Coreå†…éƒ¨åˆå¯ä»¥ç”±ä¸¤ä¸ªCPU Threadç»„æˆã€‚ æ¯ä¸ªCPU threadéƒ½æ˜¯ä¸€ä¸ªæ“ä½œç³»ç»Ÿå¯è§çš„é€»è¾‘CPUã€‚å¯¹å¤§å¤šæ•°æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œä¸€ä¸ªå…«æ ¸HTæ‰“å¼€çš„CPUä¼šè¢«è¯†åˆ«ä¸º16ä¸ªCPUã€‚ ä¸‹é¢å°±è¯´ä¸€è¯´è¿™é‡Œé¢ç›¸å…³çš„æ¦‚å¿µï¼Œ\n\nSocket\nä¸€ä¸ªSocketå¯¹åº”ä¸€ä¸ªç‰©ç†CPUã€‚ è¿™ä¸ªè¯å¤§æ¦‚æ˜¯ä»CPUåœ¨ä¸»æ¿ä¸Šçš„ç‰©ç†è¿æ¥æ–¹å¼ä¸Šæ¥çš„ï¼Œå¯ä»¥ç†è§£ä¸º Socket å°±æ˜¯ä¸»æ¿ä¸Šçš„ CPU æ’æ§½ã€‚å¤„ç†å™¨é€šè¿‡ä¸»æ¿çš„Socketæ¥æ’åˆ°ä¸»æ¿ä¸Šã€‚ å°¤å…¶æ˜¯æœ‰äº†å¤šæ ¸(Multi-core)ç³»ç»Ÿä»¥åï¼ŒMulti-socketç³»ç»Ÿè¢«ç”¨æ¥æŒ‡æ˜ç³»ç»Ÿåˆ°åº•å­˜åœ¨å¤šå°‘ä¸ªç‰©ç†CPUã€‚\n\nNode\nNUMAä½“ç³»ç»“æ„ä¸­å¤šäº†Nodeçš„æ¦‚å¿µï¼Œè¿™ä¸ªæ¦‚å¿µå…¶å®æ˜¯ç”¨æ¥è§£å†³coreçš„åˆ†ç»„çš„é—®é¢˜ã€‚æ¯ä¸ªnodeæœ‰è‡ªå·±çš„å†…éƒ¨CPUï¼Œæ€»çº¿å’Œå†…å­˜ï¼ŒåŒæ—¶è¿˜å¯ä»¥è®¿é—®å…¶ä»–nodeå†…çš„å†…å­˜ï¼ŒNUMAçš„æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯å¯ä»¥æ–¹ä¾¿çš„å¢åŠ CPUçš„æ•°é‡ã€‚é€šå¸¸ä¸€ä¸ª Socket æœ‰ä¸€ä¸ª Nodeï¼Œä¹Ÿæœ‰å¯èƒ½ä¸€ä¸ª Socket æœ‰å¤šä¸ª Nodeã€‚\n\nCore\nCPUçš„è¿ç®—æ ¸å¿ƒã€‚ x86çš„æ ¸åŒ…å«äº†CPUè¿ç®—çš„åŸºæœ¬éƒ¨ä»¶ï¼Œå¦‚é€»è¾‘è¿ç®—å•å…ƒ(ALU), æµ®ç‚¹è¿ç®—å•å…ƒ(FPU), L1å’ŒL2ç¼“å­˜ã€‚ ä¸€ä¸ªSocketé‡Œå¯ä»¥æœ‰å¤šä¸ªCoreã€‚å¦‚ä»Šçš„å¤šæ ¸æ—¶ä»£ï¼Œå³ä½¿æ˜¯Single Socketçš„ç³»ç»Ÿï¼Œ ä¹Ÿæ˜¯é€»è¾‘ä¸Šçš„SMPç³»ç»Ÿã€‚ä½†æ˜¯ï¼Œä¸€ä¸ªç‰©ç†CPUçš„ç³»ç»Ÿä¸å­˜åœ¨éæœ¬åœ°å†…å­˜ï¼Œå› æ­¤ç›¸å½“äºUMAç³»ç»Ÿã€‚\n\nUncore\nIntel x86ç‰©ç†CPUé‡Œæ²¡æœ‰æ”¾åœ¨Coreé‡Œçš„éƒ¨ä»¶éƒ½è¢«å«åšUncoreã€‚Uncoreé‡Œé›†æˆäº†è¿‡å»x86 UMAæ¶æ„æ—¶ä»£åŒ—æ¡¥èŠ¯ç‰‡çš„åŸºæœ¬åŠŸèƒ½ã€‚ åœ¨Nehalemæ—¶ä»£ï¼Œå†…å­˜æ§åˆ¶å™¨è¢«é›†æˆåˆ°CPUé‡Œï¼Œå«åšiMC(Integrated Memory Controller)ã€‚ è€ŒPCIe Root Complexè¿˜åšä¸ºç‹¬ç«‹éƒ¨ä»¶åœ¨IO HubèŠ¯ç‰‡é‡Œã€‚åˆ°äº†SandyBridgeæ—¶ä»£ï¼ŒPCIe Root Complexä¹Ÿè¢«é›†æˆåˆ°äº†CPUé‡Œã€‚ ç°ä»Šçš„Uncoreéƒ¨åˆ†ï¼Œé™¤äº†iMCï¼ŒPCIe Root Complexï¼Œè¿˜æœ‰QPI(QuickPath Interconnect)æ§åˆ¶å™¨ï¼Œ L3ç¼“å­˜ï¼ŒCBox(è´Ÿè´£ç¼“å­˜ä¸€è‡´æ€§)ï¼ŒåŠå…¶å®ƒå¤–è®¾æ§åˆ¶å™¨ã€‚\n\nThreads\nè¿™é‡Œç‰¹æŒ‡CPUçš„å¤šçº¿ç¨‹æŠ€æœ¯ã€‚åœ¨Intel x86æ¶æ„ä¸‹ï¼ŒCPUçš„å¤šçº¿ç¨‹æŠ€æœ¯è¢«ç§°ä½œè¶…çº¿ç¨‹(Hyper-Threading)æŠ€æœ¯ã€‚ Intelçš„è¶…çº¿ç¨‹æŠ€æœ¯åœ¨ä¸€ä¸ªå¤„ç†å™¨Coreå†…éƒ¨å¼•å…¥äº†é¢å¤–çš„ç¡¬ä»¶è®¾è®¡æ¨¡æ‹Ÿäº†ä¸¤ä¸ªé€»è¾‘å¤„ç†å™¨(Logical Processor)ï¼Œ æ¯ä¸ªé€»è¾‘å¤„ç†å™¨éƒ½æœ‰ç‹¬ç«‹çš„å¤„ç†å™¨çŠ¶æ€ï¼Œä½†å…±äº«Coreå†…éƒ¨çš„è®¡ç®—èµ„æºï¼Œå¦‚ALUï¼ŒFPUï¼ŒL1ï¼ŒL2ç¼“å­˜ã€‚ è¿™æ ·åœ¨æœ€å°çš„ç¡¬ä»¶æŠ•å…¥ä¸‹æé«˜äº†CPUåœ¨å¤šçº¿ç¨‹è½¯ä»¶å·¥ä½œè´Ÿè½½ä¸‹çš„æ€§èƒ½ï¼Œæé«˜äº†ç¡¬ä»¶ä½¿ç”¨æ•ˆç‡ã€‚ x86çš„è¶…çº¿ç¨‹æŠ€æœ¯å‡ºç°æ—©äºNUMAæ¶æ„ã€‚\n\n\næœ¬åœ°å†…å­˜åœ¨Intel x86å¹³å°ä¸Šï¼Œæ‰€è°“æœ¬åœ°å†…å­˜ï¼Œå°±æ˜¯CPUå¯ä»¥ç»è¿‡Uncoreéƒ¨ä»¶é‡Œçš„iMCè®¿é—®åˆ°çš„å†…å­˜ã€‚è€Œé‚£äº›éæœ¬åœ°çš„ï¼Œ è¿œç¨‹å†…å­˜(Remote Memory)ï¼Œåˆ™éœ€è¦ç»è¿‡QPIçš„é“¾è·¯åˆ°è¯¥å†…å­˜æ‰€åœ¨çš„æœ¬åœ°CPUçš„iMCæ¥è®¿é—®ã€‚ æ›¾ç»åœ¨Intel IvyBridgeçš„NUMAå¹³å°ä¸Šåšçš„å†…å­˜è®¿é—®æ€§èƒ½æµ‹è¯•æ˜¾ç¤ºï¼Œè¿œç¨‹å†…å­˜è®¿é—®çš„å»¶æ—¶æ—¶æœ¬åœ°å†…å­˜çš„ä¸€å€ã€‚\nå¯ä»¥å‡è®¾ï¼Œæ“ä½œç³»ç»Ÿåº”è¯¥å°½é‡åˆ©ç”¨æœ¬åœ°å†…å­˜çš„ä½è®¿é—®å»¶è¿Ÿç‰¹æ€§æ¥ä¼˜åŒ–åº”ç”¨å’Œç³»ç»Ÿçš„æ€§èƒ½ã€‚\næœ¬åœ° IO èµ„æºå¦‚å‰æ‰€è¿°ï¼ŒIntelè‡ªä»SandyBridgeå¤„ç†å™¨å¼€å§‹ï¼Œå·²ç»æŠŠPCIe Root Complexé›†æˆåˆ°CPUé‡Œäº†ã€‚ æ­£å› ä¸ºå¦‚æ­¤ï¼Œä»CPUç›´æ¥å¼•å‡ºPCIe Root Portçš„PCIe 3.0çš„é“¾è·¯å¯ä»¥ç›´æ¥ä¸PCIe Switchæˆ–è€…PCIe Endpointç›¸è¿ã€‚ ä¸€ä¸ªPCIe Endpointå°±æ˜¯ä¸€ä¸ªPCIeå¤–è®¾ã€‚è¿™å°±æ„å‘³ç€ï¼Œå¯¹æŸä¸ªPCIeå¤–è®¾æ¥è¯´ï¼Œå¦‚æœå®ƒç›´æ¥äºå“ªä¸ªCPUç›¸è¿ï¼Œ å®ƒå°±å±äºå“ªä¸ªCPUæ‰€åœ¨çš„NUMA Nodeã€‚\nä¸æœ¬åœ°å†…å­˜ä¸€æ ·ï¼Œæ‰€è°“æœ¬åœ°IOèµ„æºï¼Œå°±æ˜¯CPUå¯ä»¥ç»è¿‡Uncoreéƒ¨ä»¶é‡Œçš„PCIe Root Complexç›´æ¥è®¿é—®åˆ°çš„IOèµ„æºã€‚ å¦‚æœæ˜¯éæœ¬åœ°IOèµ„æºï¼Œåˆ™éœ€è¦ç»è¿‡QPIé“¾è·¯åˆ°è¯¥IOèµ„æºæ‰€å±çš„CPUï¼Œå†é€šè¿‡è¯¥CPU PCIe Root Complexè®¿é—®ã€‚ å¦‚æœåŒä¸€ä¸ªNUMA Nodeå†…çš„CPUå’Œå†…å­˜å’Œå¦å¤–ä¸€ä¸ªNUMA Nodeçš„IOèµ„æºå‘ç”Ÿäº’æ“ä½œï¼Œå› ä¸ºè¦è·¨è¶ŠQPIé“¾è·¯ï¼Œ ä¼šå­˜åœ¨é¢å¤–çš„è®¿é—®å»¶è¿Ÿé—®é¢˜ã€‚\nå…¶å®ƒä½“ç³»ç»“æ„é‡Œï¼Œä¸ºé™ä½å¤–è®¾è®¿é—®å»¶è¿Ÿï¼Œä¹Ÿæœ‰å°†IB(Infiniband)æ€»çº¿é›†æˆåˆ°CPUé‡Œçš„ã€‚ è¿™æ ·IBè®¾å¤‡ä¹Ÿå±äºNUMA Nodeçš„ä¸€éƒ¨åˆ†äº†ã€‚\nå¯ä»¥å‡è®¾ï¼Œæ“ä½œç³»ç»Ÿå¦‚æœæ˜¯NUMA Awareçš„è¯ï¼Œåº”è¯¥ä¼šå°½é‡é’ˆå¯¹æœ¬åœ°IOèµ„æºä½å»¶è¿Ÿçš„ä¼˜ç‚¹è¿›è¡Œä¼˜åŒ–ã€‚\n\nNUMA Node äº’è”åœ¨Intel x86ä¸Šï¼ŒNUMA Nodeä¹‹é—´çš„äº’è”æ˜¯é€šè¿‡ QPI((QuickPath Interconnect) Linkçš„ã€‚ CPUçš„Uncoreéƒ¨åˆ†æœ‰QPIçš„æ§åˆ¶å™¨æ¥æ§åˆ¶CPUåˆ°QPIçš„æ•°æ®è®¿é—®ã€‚\nä¸‹å›¾å°±æ˜¯ä¸€ä¸ªåˆ©ç”¨ QPI Switch äº’è”çš„ 8 NUMA Node çš„ x86 ç³»ç»Ÿï¼Œ\n\nNUMA AffinityNUMA Affinity(äº²å’Œæ€§)æ˜¯å’ŒNUMA Hierarchy(å±‚çº§ç»“æ„)ç›´æ¥ç›¸å…³çš„ã€‚å¯¹ç³»ç»Ÿè½¯ä»¶æ¥è¯´ï¼Œ ä»¥ä¸‹ä¸¤ä¸ªæ¦‚å¿µè‡³å…³é‡è¦ï¼Œ\n\nCPU NUMA Affinity\nCPU NUMAçš„äº²å’Œæ€§æ˜¯æŒ‡ä»CPUè§’åº¦çœ‹ï¼Œå“ªäº›å†…å­˜è®¿é—®æ›´å¿«ï¼Œæœ‰æ›´ä½çš„å»¶è¿Ÿã€‚å¦‚å‰æ‰€è¿°ï¼Œ å’Œè¯¥CPUç›´æ¥ç›¸è¿çš„æœ¬åœ°å†…å­˜æ˜¯æ›´å¿«çš„ã€‚æ“ä½œç³»ç»Ÿå¦‚æœå¯ä»¥æ ¹æ®ä»»åŠ¡æ‰€åœ¨CPUå»åˆ†é…æœ¬åœ°å†…å­˜ï¼Œ å°±æ˜¯åŸºäºCPU NUMAäº²å’Œæ€§çš„è€ƒè™‘ã€‚å› æ­¤ï¼ŒCPU NUMAäº²å’Œæ€§å°±æ˜¯è¦å°½é‡è®©ä»»åŠ¡è¿è¡Œåœ¨æœ¬åœ°çš„NUMA Nodeé‡Œã€‚\n\nDevice NUMA Affinity\nè®¾å¤‡NUMAäº²å’Œæ€§æ˜¯æŒ‡ä»PCIeå¤–è®¾çš„è§’åº¦çœ‹ï¼Œå¦‚æœå’ŒCPUå’Œå†…å­˜ç›¸å…³çš„IOæ´»åŠ¨éƒ½å‘ç”Ÿåœ¨å¤–è®¾æ‰€å±çš„NUMA Nodeï¼Œ å°†ä¼šæœ‰æ›´ä½å»¶è¿Ÿã€‚è¿™é‡Œæœ‰ä¸¤ç§è®¾å¤‡NUMAäº²å’Œæ€§çš„é—®é¢˜ï¼Œ\n\nDMA Buffer NUMA Affinity\nå¤§éƒ¨åˆ†PCIeè®¾å¤‡æ”¯æŒDMAåŠŸèƒ½çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾å¤‡å¯ä»¥ç›´æ¥æŠŠæ•°æ®å†™å…¥åˆ°ä½äºå†…å­˜ä¸­çš„DMAç¼“å†²åŒºã€‚ æ˜¾ç„¶ï¼Œå¦‚æœDMAç¼“å†²åŒºåœ¨PCIeå¤–è®¾æ‰€å±çš„NUMA Nodeé‡Œåˆ†é…ï¼Œé‚£ä¹ˆå°†ä¼šæœ‰æœ€ä½çš„å»¶è¿Ÿã€‚ å¦åˆ™ï¼Œå¤–è®¾çš„DMAæ“ä½œè¦è·¨è¶ŠQPIé“¾æ¥å»è¯»å†™å¦å¤–ä¸€ä¸ªNUMA Nodeé‡Œçš„DMAç¼“å†²åŒºã€‚ å› æ­¤ï¼Œæ“ä½œç³»ç»Ÿå¦‚æœå¯ä»¥æ ¹æ®PCIeè®¾å¤‡æ‰€å±çš„NUMA nodeåˆ†é…DMAç¼“å†²åŒºï¼Œ å°†ä¼šæœ‰æœ€å¥½çš„DMAæ“ä½œçš„æ€§èƒ½ã€‚\n\nInterrupt NUMA Affinity\nè®¾å¤‡DMAæ“ä½œå®Œæˆåï¼Œéœ€è¦åœ¨CPUä¸Šè§¦å‘ä¸­æ–­æ¥é€šçŸ¥é©±åŠ¨ç¨‹åºçš„ä¸­æ–­å¤„ç†ä¾‹ç¨‹(ISR)æ¥è¯»å†™DMAç¼“å†²åŒºã€‚ å¾ˆå¤šæ—¶å€™ï¼ŒISRè§¦å‘ä¸‹åŠéƒ¨æœºåˆ¶(SoftIRQ)æ¥è¿›å…¥åˆ°åè®®æ ˆç›¸å…³(Networkï¼ŒStorage)çš„ä»£ç è·¯å¾„æ¥ä¼ é€æ•°æ®ã€‚ å¯¹å¤§éƒ¨åˆ†æ“ä½œç³»ç»Ÿæ¥è¯´ï¼Œç¡¬ä»¶ä¸­æ–­(HardIRQ)å’Œä¸‹åŠéƒ¨æœºåˆ¶çš„ä»£ç åœ¨åŒä¸€ä¸ªCPUä¸Šå‘ç”Ÿã€‚ å› æ­¤ï¼ŒDMAç¼“å†²åŒºçš„è¯»å†™æ“ä½œå‘ç”Ÿçš„ä½ç½®å’Œè®¾å¤‡ç¡¬ä»¶ä¸­æ–­(HardIRQ)å¯†åˆ‡ç›¸å…³ã€‚å‡è®¾æ“ä½œç³»ç»Ÿå¯ä»¥æŠŠè®¾å¤‡çš„ç¡¬ä»¶ä¸­æ–­ç»‘å®šåˆ°è‡ªå·±æ‰€å±çš„NUMA nodeï¼Œ é‚£ä¹‹åä¸­æ–­å¤„ç†å‡½æ•°å’Œåè®®æ ˆä»£ç å¯¹DMAç¼“å†²åŒºçš„è¯»å†™å°†ä¼šæœ‰æ›´ä½çš„å»¶è¿Ÿã€‚\n\n\n\n\nFirmware æ¥å£ç”±äºNUMAçš„äº²å’Œæ€§å¯¹åº”ç”¨çš„æ€§èƒ½éå¸¸é‡è¦ï¼Œé‚£ä¹ˆç¡¬ä»¶å¹³å°å°±éœ€è¦ç»™æ“ä½œç³»ç»Ÿæä¾›æ¥å£æœºåˆ¶æ¥æ„ŸçŸ¥ç¡¬ä»¶çš„NUMAå±‚çº§ç»“æ„ã€‚ åœ¨x86å¹³å°ï¼ŒACPIè§„èŒƒæä¾›äº†ä»¥ä¸‹æ¥å£æ¥è®©æ“ä½œç³»ç»Ÿæ¥æ£€æµ‹ç³»ç»Ÿçš„NUMAå±‚çº§ç»“æ„ã€‚\nACPI 5.0aè§„èŒƒçš„ç¬¬17ç« æ˜¯æœ‰å…³NUMAçš„ç« èŠ‚ã€‚ACPIè§„èŒƒé‡Œï¼ŒNUMA Nodeè¢«ç¬¬9ç« å®šä¹‰çš„Module Deviceæ‰€æè¿°ã€‚ ACPIè§„èŒƒé‡Œç”¨Proximity Domainå¯¹NUMA Nodeåšäº†æŠ½è±¡ï¼Œä¸¤è€…çš„æ¦‚å¿µå¤§å¤šæ—¶å€™ç­‰åŒã€‚\n\nSRAT(System Resource Affinity Table)\nä¸»è¦æè¿°äº†ç³»ç»Ÿbootæ—¶çš„CPUå’Œå†…å­˜éƒ½å±äºå“ªä¸ªProximity Domain(NUMA Node)ã€‚ è¿™ä¸ªè¡¨æ ¼é‡Œçš„ä¿¡æ¯æ—¶é™æ€çš„ï¼Œå¦‚æœæ˜¯å¯åŠ¨åçƒ­æ’æ‹”ï¼Œéœ€è¦ç”¨OSPMçš„_PXMæ–¹æ³•å»è·å¾—ç›¸å…³ä¿¡æ¯ã€‚\n\nSLIT(System Locality Information Table)\næä¾›CPUå’Œå†…å­˜ä¹‹é—´çš„ä½ç½®è¿œè¿‘ä¿¡æ¯ã€‚åœ¨SRATè¡¨æ ¼é‡Œï¼Œåªèƒ½å‘Šè¯‰ç»™å®šçš„CPUå’Œå†…å­˜æ˜¯å¦åœ¨ä¸€ä¸ªNUMA Nodeã€‚ å¯¹æŸä¸ªCPUæ¥è¯´ï¼Œä¸åœ¨æœ¬NUMA Nodeé‡Œçš„å†…å­˜ï¼Œå³è¿œç¨‹å†…å­˜ä»¬æ˜¯å¦éƒ½æ˜¯ä¸€æ ·çš„è®¿é—®å»¶è¿Ÿå–å†³äºNUMAçš„æ‹“æ‰‘æœ‰å¤šå¤æ‚(QPIçš„è·³æ•°)ã€‚ æ€»ä¹‹ï¼Œå¯¹äºä¸èƒ½ç®€å•ç”¨è¿œè¿‘æ¥æè¿°çš„NUMAç³»ç»Ÿ(QPIå­˜åœ¨0ï¼Œ1ï¼Œ2ç­‰ä¸åŒè·³æ•°)ï¼Œ éœ€è¦SLITè¡¨æ ¼ç»™å‡ºè¿›ä¸€æ­¥çš„è¯´æ˜ã€‚åŒæ ·çš„ï¼Œè¿™ä¸ªè¡¨æ ¼ä¹Ÿæ˜¯é™æ€è¡¨æ ¼ï¼Œçƒ­æ’æ‹”éœ€è¦ä½¿ç”¨OSPMçš„_SLIæ–¹æ³•ã€‚\n\nDSDT(Differentiated System Description Table)\nä»Device NUMAè§’åº¦çœ‹ï¼Œè¿™ä¸ªè¡¨æ ¼ç»™å‡ºäº†ç³»ç»Ÿbootæ—¶çš„å¤–è®¾éƒ½å±äºå“ªä¸ªProximity Domain(NUMA Node)ã€‚\n\n\nACPIè§„èŒƒOSPM(Operating System-directed configuration and Power Management) å’ŒOSPMå„ç§æ–¹æ³•å°±æ˜¯æ“ä½œç³»ç»Ÿé‡Œçš„ACPIé©±åŠ¨å’ŒACPI firmwareä¹‹é—´çš„ä¸€ä¸ªäº’åŠ¨çš„æ¥å£ã€‚ x86å¯åŠ¨OSåï¼Œæ²¡æœ‰ACPIä¹‹å‰ï¼Œfirmware(BIOS)çš„ä»£ç æ˜¯æ— æ³•è¢«æ‰§è¡Œäº†ï¼Œé™¤éé€šè¿‡SMIä¸­æ–­å¤„ç†ç¨‹åºã€‚ ä½†æœ‰äº†ACPIï¼ŒBIOSæå‰æŠŠACPIçš„ä¸€äº›é™æ€è¡¨æ ¼å’ŒAMLçš„bytecodeä»£ç è£…è½½åˆ°å†…å­˜ï¼Œ ç„¶åACPIé©±åŠ¨å°±ä¼šåŠ è½½AMLçš„è§£é‡Šå™¨ï¼Œè¿™æ ·OSå°±å¯ä»¥é€šè¿‡ACPIé©±åŠ¨è°ƒç”¨é¢„å…ˆè£…è½½çš„AMLä»£ç ã€‚ AML(ACPI Machine Language)æ˜¯å’ŒJavaç±»ä¼¼çš„ä¸€ç§è™šæ‹Ÿæœºè§£é‡Šå‹è¯­è¨€ï¼Œæ‰€ä»¥ä¸åŒæ“ä½œç³»ç»Ÿçš„ACPIé©±åŠ¨ï¼Œ åªè¦æœ‰ç›¸åŒçš„è™šæ‹Ÿæœºè§£é‡Šå™¨ï¼Œå°±å¯ä»¥ç›´æ¥ä»æ“ä½œç³»ç»Ÿè°ƒç”¨ACPIå†™å¥½çš„AMLçš„ä»£ç äº†ã€‚ æ‰€ä»¥ï¼Œå‰æ–‡æ‰€è¿°çš„æ‰€æœ‰çƒ­æ’æ‹”çš„OSPMæ–¹æ³•ï¼Œå…¶å®å°±æ˜¯å¯¹åº”ACPI firmwareçš„AMLçš„ä¸€æ®µå‡½æ•°ä»£ç è€Œå·²ã€‚ (å…³äºACPIçš„ç®€å•ä»‹ç»ï¼Œè¿™é‡Œç»™å‡ºä¸¤ç¯‡å»¶ä¼¸é˜…è¯»ï¼š1 å’Œ2ã€‚)\nNUMA Optimization\nhttps://blog.jcole.us/2010/09/28/mysql-swap-insanity-and-the-numa-architecture/\nhttps://frankdenneman.nl/2016/07/08/numa-deep-dive-part-2-system-architecture/\nhttp://oliveryang.net/2016/02/linux-numa-optimization-1/\n\nç›¸å…³æ–‡ç« æ¨è\n\nã€è®¡ç®—æœºä½“ç³»ç»“æ„ã€‘Cache Memory\nMelodies Are Just Math\nKey Numbers Every Programmer Should Know\n\nåŸæ–‡ï¼š\nhttps://houmin.cc/posts/b893097a/\n","categories":["è¿ç»´","Linux"]},{"title":"NUMA æ¶æ„ç›¸å…³å‘½ä»¤","url":"/posts/31066/","content":"ç›¸å…³æ–‡ç« ï¼š\nhttps://zhuanlan.zhihu.com/p/62795773\næŸ¥çœ‹æ˜¯å¦æ”¯æŒ NUMA æ¶æ„dmesg | grep -i numa\n\næŸ¥çœ‹ NUMA node æƒ…å†µnumactl --hardware\n\nè¿›ç¨‹ä½¿ç”¨æŒ‡å®š node çš„å†…å­˜numactl --membind=0 java -jar app.jar\n\nå®ç”¨å·¥å…· lstopolstopo --of png &gt; server.png\n\n","categories":["è¿ç»´","Linux"]},{"title":"curl å‘½ä»¤","url":"/posts/39748/","content":"æµ‹è¯•å»¶è¿Ÿcurl -m 9 -s -w %&#123;time_namelookup&#125;---%&#123;time_connect&#125;---%&#123;time_starttransfer&#125;---%&#123;time_total&#125;---%&#123;speed_download&#125;&quot;\\n&quot; -H &#x27;Accept: application/vnd.dmp.v2+json&#x27; -H &#x27;Authorization: 28b4b2fb90f9c2aab4843966c0ecc42a&#x27; -d &quot;&quot; &quot;http://hldmp.abeacon.com/user/tasklist&quot;\n\n\ntime_connectï¼šå»ºç«‹åˆ°æœåŠ¡å™¨çš„ TCP è¿æ¥æ‰€ç”¨çš„æ—¶é—´\ntime_starttransferï¼šåœ¨å‘å‡ºè¯·æ±‚ä¹‹å,Web æœåŠ¡å™¨è¿”å›æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ‰€ç”¨çš„æ—¶é—´\ntime_totalï¼šå®Œæˆè¯·æ±‚æ‰€ç”¨çš„æ—¶é—´\ntime_namelookupï¼šDNSè§£ææ—¶é—´,ä»è¯·æ±‚å¼€å§‹åˆ°DNSè§£æå®Œæ¯•æ‰€ç”¨æ—¶é—´(è®°å¾—å…³æ‰ Linux çš„ nscd çš„æœåŠ¡æµ‹è¯•)\nspeed_downloadï¼šä¸‹è½½é€Ÿåº¦ï¼Œå•ä½-å­—èŠ‚æ¯ç§’ã€‚\n\n","categories":["è¿ç»´","Linux"]},{"title":"tcpdump å‘½ä»¤è¯¦è§£","url":"/posts/37051/","content":"åœ¨è®²è§£ä¹‹å‰ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦å£°æ˜ï¼š\n\nç¬¬ä¸‰èŠ‚åˆ°ç¬¬å…­èŠ‚é‡Œçš„ tcpdump å‘½ä»¤ç¤ºä¾‹ï¼Œåªä¸ºäº†è¯´æ˜å‚æ•°çš„ä½¿ç”¨ï¼Œå¹¶ä¸ä¸€å®šå°±èƒ½æŠ“åˆ°åŒ…ï¼Œå¦‚æœè¦ç²¾å‡†æŠ“åˆ°ä½ æ‰€éœ€è¦çš„åŒ…ï¼Œéœ€è¦é…åˆç¬¬äº”èŠ‚çš„é€»è¾‘é€»è¾‘è¿ç®—ç¬¦è¿›è¡Œç»„åˆæ­é…ã€‚\nä¸åŒ Linux å‘è¡Œç‰ˆä¸‹ã€ä¸åŒç‰ˆæœ¬çš„ tcpdump å¯èƒ½æœ‰å°è®¸å·®å¼‚ï¼Œ æœ¬æ–‡æ˜¯åŸºäº CentOS 7.2 çš„ 4.5.1 ç‰ˆæœ¬çš„tcpdump è¿›è¡Œå­¦ä¹ çš„ï¼Œè‹¥åœ¨ä½ çš„ç¯å¢ƒä¸­æ— æ³•ä½¿ç”¨ï¼Œè¯·å‚è€ƒ man tcpdump è¿›è¡Œé’ˆå¯¹æ€§å­¦ä¹ ã€‚\n\n1. tcpdump æ ¸å¿ƒå‚æ•°å›¾è§£å¤§å®¶éƒ½çŸ¥é“ï¼Œç½‘ç»œä¸Šçš„æµé‡ã€æ•°æ®åŒ…ï¼Œéå¸¸çš„å¤šï¼Œå› æ­¤è¦æƒ³æŠ“åˆ°æˆ‘ä»¬æ‰€éœ€è¦çš„æ•°æ®åŒ…ï¼Œå°±éœ€è¦æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªç²¾å‡†çš„è¿‡æ»¤å™¨ï¼ŒæŠŠè¿™äº›ç›®æ ‡æ•°æ®åŒ…ï¼Œä»å·¨å¤§çš„æ•°æ®åŒ…ç½‘ç»œä¸­æŠ“å–å‡ºæ¥ã€‚\næ‰€ä»¥å­¦ä¹ æŠ“åŒ…å·¥å…·ï¼Œå…¶å®å°±æ˜¯å­¦ä¹ å¦‚ä½•å®šä¹‰è¿‡æ»¤å™¨çš„è¿‡ç¨‹ã€‚\nè€Œåœ¨ tcpdump çš„ä¸–ç•Œé‡Œï¼Œè¿‡æ»¤å™¨çš„å®ç°ï¼Œéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªåˆä¸€ä¸ªçš„å‚æ•°ç»„åˆèµ·æ¥ï¼Œä¸€ä¸ªå‚æ•°ä¸å¤Ÿç²¾å‡†ï¼Œé‚£å°±å†åŠ ä¸€ä¸ªï¼Œç›´åˆ°æˆ‘ä»¬èƒ½è¿‡æ»¤æ‰æ— ç”¨çš„æ•°æ®åŒ…ï¼Œåªç•™ä¸‹æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ•°æ®åŒ…ã€‚\ntcpdump çš„å‚æ•°éå¸¸çš„å¤šï¼Œåˆå­¦è€…åœ¨æ²¡æœ‰æŒæ¡ tcpdump æ—¶ï¼Œä¼šå¯¹è¿™ä¸ªå‘½ä»¤çš„ä¼—å¤šå‚æ•°äº§ç”Ÿå¾ˆå¤šçš„ç–‘æƒ‘ã€‚\nå°±æ¯”å¦‚ä¸‹é¢è¿™ä¸ªå‘½ä»¤ï¼Œæˆ‘ä»¬è¦é€šè¿‡ host å‚æ•°æŒ‡å®š host ip è¿›è¡Œè¿‡æ»¤\n$ tcpdump host 192.168.10.100\n\nä¸»ç¨‹åº + å‚æ•°å+ å‚æ•°å€¼ è¿™æ ·çš„ç»„åˆæ‰æ˜¯æˆ‘ä»¬æ­£å¸¸è®¤çŸ¥é‡Œé¢å‘½ä»¤è¡Œè¯¥æœ‰çš„æ ·å­ã€‚\nå¯ tcpdump å´ä¸èµ°å¯»å¸¸è·¯ï¼Œæˆ‘ä»¬å±…ç„¶è¿˜å¯ä»¥åœ¨ host å‰å†åŠ ä¸€ä¸ªé™å®šè¯ï¼Œæ¥ç¼©å°è¿‡æ»¤çš„èŒƒå›´ï¼Ÿ\n$ tcpdump src host 192.168.10.100\n\nä»å­—é¢ä¸Šç†è§£ï¼Œç¡®å®å¾ˆå®¹æ˜“ç†è§£ï¼Œä½†æ˜¯è¿™ä¸ç¬¦åˆç¼–å†™å‘½ä»¤è¡Œç¨‹åºçš„æ­£å¸¸é€»è¾‘ï¼Œå¯¼è‡´æˆ‘ä»¬ä¼šæœ‰æ‰€ç–‘è™‘ï¼š\n\né™¤äº† src ï¼Œdstï¼Œå¯è¿˜æœ‰å…¶å®ƒå¯ä»¥ç”¨çš„é™å®šè¯ï¼Ÿ\nsrcï¼Œhost åº”è¯¥å¦‚ä½•ç†è§£å®ƒä»¬ï¼Œå«å‚æ•°åï¼Ÿä¸åˆé€‚ï¼Œå› ä¸º src æ˜æ˜¾ä¸åˆé€‚ã€‚\n\nå¦‚æœä½ åœ¨ç½‘ä¸Šçœ‹åˆ°æœ‰å…³ tcpdump çš„åšå®¢ã€æ•™ç¨‹ï¼Œæ— ä¸€ä¸æ˜¯ç»™ä½ ä¸€ä¸ªå‚æ•°ç»„åˆï¼Œå‘Šè¯‰ä½ è¿™æ˜¯å®ç°äº†æ€æ ·çš„ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Ÿè¿™æ ·çš„æ•™å­¦æ–¹å¼ï¼Œå¾ˆå®¹æ˜“è®©ä½ ä¾èµ–åˆ«äººçš„æ–‡ç« æ¥ä½¿ç”¨ tcpdumpï¼Œè€Œä¸èƒ½å°† tcpdump è¿™æ ·ç¥å™¨æ¶ˆåŒ–ï¼Œè¾¾åˆ°çµæ´»åº”ç”¨ï¼Œçµæ´»æ­é…è¿‡æ»¤å™¨çš„æ•ˆæœã€‚\nä¸Šé¢åŠ äº† src æœ¬èº«å°±é¢ è¦†äº†æˆ‘ä»¬çš„è®¤çŸ¥ï¼Œä½ å¯çŸ¥é“åœ¨ src ä¹‹å‰è¿˜å¯ä»¥åŠ æ›´å¤šçš„æ¡ä»¶ï¼Œæ¯”å¦‚ tcp, udp, icmp ç­‰è¯ï¼Œåœ¨ä½ ä¹‹å‰çš„åŸºç¡€ä¸Šå†è¿‡æ»¤ä¸€å±‚ã€‚\n$ tcpdump tcp src host 192.168.10.100\n\nè¿™ç§å‚æ•°çš„ä¸ç¡®å®šæ€§ï¼Œè®©å¤§å¤šæ•°äººå¯¹ tcpdump çš„å­¦ä¹ å§‹ç»ˆæ— æ³•å¾—å…¶ç²¾é«“ã€‚\nå› æ­¤ï¼Œåœ¨å­¦ä¹  tcpdump ä¹‹å‰ï¼Œæˆ‘è§‰å¾—æœ‰å¿…è¦è¦å…ˆè®©ä½ çŸ¥é“ï¼štcpdump çš„å‚æ•°æ˜¯å¦‚ä½•ç»„æˆçš„ï¼Ÿè¿™éå¸¸é‡è¦ã€‚\nä¸ºæ­¤ï¼Œæˆ‘ç”»äº†ä¸€å¼ å›¾ï¼Œæ–¹ä¾¿ä½ ç›´è§‚çš„ç†è§£ tcpdump çš„å„ç§å‚æ•°ï¼š\n\n\noption å¯é€‰å‚æ•°ï¼šå°†åœ¨åè¾¹ä¸€ä¸€è§£é‡Šã€‚\nproto ç±»è¿‡æ»¤å™¨ï¼šæ ¹æ®åè®®è¿›è¡Œè¿‡æ»¤ï¼Œå¯è¯†åˆ«çš„å…³é”®è¯æœ‰ï¼š tcp, udp, icmp, ip, ip6, arp, rarp,ether,wlan, fddi, tr, decnet\ntype ç±»è¿‡æ»¤å™¨ï¼šå¯è¯†åˆ«çš„å…³é”®è¯æœ‰ï¼šhost, net, port, portrangeï¼Œè¿™äº›è¯åè¾¹éœ€è¦å†æ¥å‚æ•°ã€‚\ndirection ç±»è¿‡æ»¤å™¨ï¼šæ ¹æ®æ•°æ®æµå‘è¿›è¡Œè¿‡æ»¤ï¼Œå¯è¯†åˆ«çš„å…³é”®å­—æœ‰ï¼šsrc, dstï¼ŒåŒæ—¶ä½ å¯ä»¥ä½¿ç”¨é€»è¾‘è¿ç®—ç¬¦è¿›è¡Œç»„åˆï¼Œæ¯”å¦‚ src or dst\n\nprotoã€typeã€direction è¿™ä¸‰ç±»è¿‡æ»¤å™¨çš„å†…å®¹æ¯”è¾ƒç®€å•ï¼Œä¹Ÿæœ€å¸¸ç”¨ï¼Œå› æ­¤æˆ‘å°†å…¶æ”¾åœ¨æœ€å‰é¢ï¼Œä¹Ÿå°±æ˜¯ ç¬¬ä¸‰èŠ‚ï¼šå¸¸è§„è¿‡æ»¤è§„åˆ™ä¸€èµ·ä»‹ç»ã€‚\nè€Œ option å¯é€‰çš„å‚æ•°éå¸¸å¤šï¼Œæœ‰çš„ç”šè‡³ä¹Ÿä¸ç»å¸¸ç”¨åˆ°ï¼Œå› æ­¤æˆ‘å°†å…¶æ”¾åˆ°åé¢ä¸€ç‚¹ï¼Œä¹Ÿå°±æ˜¯ ç¬¬å››èŠ‚ï¼šå¯é€‰å‚æ•°è§£æ\nå½“ä½ çœ‹å®Œå‰é¢å…­èŠ‚ï¼Œä½ å¯¹ tcpdump çš„è®¤è¯†ä¼šä¸Šäº†ä¸€ä¸ªå°é˜¶ï¼Œè‡³å°‘èƒ½å¤Ÿæ»¡è¶³ä½  80% çš„ä½¿ç”¨éœ€æ±‚ã€‚\nä½ ä¸€å®šä¼šé—®äº†ï¼Œè¿˜æœ‰ 20% å‘¢ï¼Ÿ\nå…¶å® tcpdump è¿˜æœ‰ä¸€äº›è¿‡æ»¤å…³é”®è¯ï¼Œå®ƒä¸ç¬¦åˆä»¥ä¸Šå››ç§è¿‡æ»¤è§„åˆ™ï¼Œå¯èƒ½éœ€è¦ä½ å•ç‹¬è®°å¿†ã€‚å…³äºè¿™éƒ¨åˆ†æˆ‘ä¼šåœ¨ ç¬¬å…­èŠ‚ï¼šç‰¹æ®Šè¿‡æ»¤è§„åˆ™ é‡Œè¿›è¡Œä»‹ç»ã€‚\n2. ç†è§£ tcpdump çš„è¾“å‡º2.1 è¾“å‡ºå†…å®¹ç»“æ„tcpdump è¾“å‡ºçš„å†…å®¹è™½ç„¶å¤šï¼Œå´å¾ˆè§„å¾‹ã€‚\nè¿™é‡Œä»¥æˆ‘éšä¾¿æŠ“å–çš„ä¸€ä¸ª tcp åŒ…ä¸ºä¾‹æ¥çœ‹ä¸€ä¸‹\n21:26:49.013621 IP 172.20.20.1.15605 &gt; 172.20.20.2.5920: Flags [P.], seq 49:97, ack 106048, win 4723, length 48\n\nä»ä¸Šé¢çš„è¾“å‡ºæ¥çœ‹ï¼Œå¯ä»¥æ€»ç»“å‡ºï¼š\n\nç¬¬ä¸€åˆ—ï¼šæ—¶åˆ†ç§’æ¯«ç§’ 21:26:49.013621\nç¬¬äºŒåˆ—ï¼šç½‘ç»œåè®® IP\nç¬¬ä¸‰åˆ—ï¼šå‘é€æ–¹çš„ipåœ°å€+ç«¯å£å·ï¼Œå…¶ä¸­172.20.20.1æ˜¯ ipï¼Œè€Œ15605 æ˜¯ç«¯å£å·\nç¬¬å››åˆ—ï¼šç®­å¤´ &gt;ï¼Œ è¡¨ç¤ºæ•°æ®æµå‘\nç¬¬äº”åˆ—ï¼šæ¥æ”¶æ–¹çš„ipåœ°å€+ç«¯å£å·ï¼Œå…¶ä¸­ 172.20.20.2 æ˜¯ ipï¼Œè€Œ5920 æ˜¯ç«¯å£å·\nç¬¬å…­åˆ—ï¼šå†’å·\nç¬¬ä¸ƒåˆ—ï¼šæ•°æ®åŒ…å†…å®¹ï¼ŒåŒ…æ‹¬Flags æ ‡è¯†ç¬¦ï¼Œseq å·ï¼Œack å·ï¼Œwin çª—å£ï¼Œæ•°æ®é•¿åº¦ lengthï¼Œå…¶ä¸­ [P.] è¡¨ç¤º PUSH æ ‡å¿—ä½ä¸º 1ï¼Œæ›´å¤šæ ‡è¯†ç¬¦è§ä¸‹é¢\n\n2.2 Flags æ ‡è¯†ç¬¦ä½¿ç”¨ tcpdump æŠ“åŒ…åï¼Œä¼šé‡åˆ°çš„ TCP æŠ¥æ–‡ Flagsï¼Œæœ‰ä»¥ä¸‹å‡ ç§ï¼š\n\n[S] : SYNï¼ˆå¼€å§‹è¿æ¥ï¼‰\n[P] : PSHï¼ˆæ¨é€æ•°æ®ï¼‰\n[F] : FIN ï¼ˆç»“æŸè¿æ¥ï¼‰\n[R] : RSTï¼ˆé‡ç½®è¿æ¥ï¼‰\n[.] : æ²¡æœ‰ Flag ï¼ˆæ„æ€æ˜¯é™¤ä¸Šé¢å››ç§ç±»å‹å¤–çš„å…¶ä»–æƒ…å†µï¼Œæœ‰å¯èƒ½æ˜¯ ACK ä¹Ÿæœ‰å¯èƒ½æ˜¯ URGï¼‰\n\n3. å¸¸è§„è¿‡æ»¤è§„åˆ™3.1 åŸºäºIPåœ°å€è¿‡æ»¤ï¼šhostä½¿ç”¨ host å°±å¯ä»¥æŒ‡å®š host ip è¿›è¡Œè¿‡æ»¤\n$ tcpdump host 192.168.10.100\n\næ•°æ®åŒ…çš„ ip å¯ä»¥å†ç»†åˆ†ä¸ºæºipå’Œç›®æ ‡ipä¸¤ç§\n# æ ¹æ®æºipè¿›è¡Œè¿‡æ»¤$ tcpdump -i eth2 src 192.168.10.100# æ ¹æ®ç›®æ ‡ipè¿›è¡Œè¿‡æ»¤$ tcpdump -i eth2 dst 192.168.10.200\n\n3.2 åŸºäºç½‘æ®µè¿›è¡Œè¿‡æ»¤ï¼šnetè‹¥ä½ çš„ipèŒƒå›´æ˜¯ä¸€ä¸ªç½‘æ®µï¼Œå¯ä»¥ç›´æ¥è¿™æ ·æŒ‡å®š\n$ tcpdump net 192.168.10.0/24\n\nç½‘æ®µåŒæ ·å¯ä»¥å†ç»†åˆ†ä¸ºæºç½‘æ®µå’Œç›®æ ‡ç½‘æ®µ\n# æ ¹æ®æºç½‘æ®µè¿›è¡Œè¿‡æ»¤$ tcpdump src net 192.168# æ ¹æ®ç›®æ ‡ç½‘æ®µè¿›è¡Œè¿‡æ»¤$ tcpdump dst net 192.168\n\n3.3 åŸºäºç«¯å£è¿›è¡Œè¿‡æ»¤ï¼športä½¿ç”¨ port å°±å¯ä»¥æŒ‡å®šç‰¹å®šç«¯å£è¿›è¡Œè¿‡æ»¤\n$ tcpdump port 8088\n\nç«¯å£åŒæ ·å¯ä»¥å†ç»†åˆ†ä¸ºæºç«¯å£ï¼Œç›®æ ‡ç«¯å£\n# æ ¹æ®æºç«¯å£è¿›è¡Œè¿‡æ»¤$ tcpdump src port 8088# æ ¹æ®ç›®æ ‡ç«¯å£è¿›è¡Œè¿‡æ»¤$ tcpdump dst port 8088\n\nå¦‚æœä½ æƒ³è¦åŒæ—¶æŒ‡å®šä¸¤ä¸ªç«¯å£ä½ å¯ä»¥è¿™æ ·å†™\n$ tcpdump port 80 or port 8088\n\nä½†ä¹Ÿå¯ä»¥ç®€å†™æˆè¿™æ ·\n$ tcpdump port 80 or 8088\n\nå¦‚æœä½ çš„æƒ³æŠ“å–çš„ä¸å†æ˜¯ä¸€ä¸¤ä¸ªç«¯å£ï¼Œè€Œæ˜¯ä¸€ä¸ªèŒƒå›´ï¼Œä¸€ä¸ªä¸€ä¸ªæŒ‡å®šå°±éå¸¸éº»çƒ¦äº†ï¼Œæ­¤æ—¶ä½ å¯ä»¥è¿™æ ·æŒ‡å®šä¸€ä¸ªç«¯å£æ®µã€‚\n$ tcpdump portrange 8000-8080$ tcpdump src portrange 8000-8080$ tcpdump dst portrange 8000-8080\n\nå¯¹äºä¸€äº›å¸¸è§åè®®çš„é»˜è®¤ç«¯å£ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨åè®®åï¼Œè€Œä¸ç”¨å…·ä½“çš„ç«¯å£å·\næ¯”å¦‚ http == 80ï¼Œhttps == 443 ç­‰\n$ tcpdump tcp port http\n\n3.4 åŸºäºåè®®è¿›è¡Œè¿‡æ»¤ï¼šprotoå¸¸è§çš„ç½‘ç»œåè®®æœ‰ï¼štcp, udp, icmp, http, ip,ipv6 ç­‰\nè‹¥ä½ åªæƒ³æŸ¥çœ‹ icmp çš„åŒ…ï¼Œå¯ä»¥ç›´æ¥è¿™æ ·å†™\n$ tcpdump icmp\n\nprotocol å¯é€‰å€¼ï¼šip, ip6, arp, rarp, atalk, aarp, decnet, sca, lat, mopdl, moprc, iso, stp, ipx, or netbeui\n3.5 åŸºæœ¬IPåè®®çš„ç‰ˆæœ¬è¿›è¡Œè¿‡æ»¤å½“ä½ æƒ³æŸ¥çœ‹ tcp çš„åŒ…ï¼Œä½ ä¹Ÿè®¸ä¼šè¿™æ ·å­å†™\n$ tcpdump tcp\n\nè¿™æ ·å­å†™ä¹Ÿæ²¡é—®é¢˜ï¼Œå°±æ˜¯ä¸å¤Ÿç²¾å‡†ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿ\nip æ ¹æ®ç‰ˆæœ¬çš„ä¸åŒï¼Œå¯ä»¥å†ç»†åˆ†ä¸º IPv4 å’Œ IPv6 ä¸¤ç§ï¼Œå¦‚æœä½ åªæŒ‡å®šäº† tcpï¼Œè¿™ä¸¤ç§å…¶å®éƒ½ä¼šåŒ…å«åœ¨å†…ã€‚\né‚£æœ‰ä»€ä¹ˆåŠæ³•ï¼Œèƒ½å¤Ÿå°† IPv4 å’Œ IPv6 åŒºåˆ†å¼€æ¥å‘¢ï¼Ÿ\nå¾ˆç®€å•ï¼Œå¦‚æœæ˜¯ IPv4 çš„ tcp åŒ… ï¼Œå°±è¿™æ ·å†™ï¼ˆå‹æƒ…æç¤ºï¼šæ•°å­— 6 è¡¨ç¤ºçš„æ˜¯ tcp åœ¨ipæŠ¥æ–‡ä¸­çš„ç¼–å·ã€‚ï¼‰\n$ tcpdump &#x27;ip proto tcp&#x27;# or$ tcpdump ip proto 6# or$ tcpdump &#x27;ip protochain tcp&#x27;# or $ tcpdump ip protochain 6\n\nè€Œå¦‚æœæ˜¯ IPv6 çš„ tcp åŒ… ï¼Œå°±è¿™æ ·å†™\n$ tcpdump &#x27;ip6 proto tcp&#x27;# or$ tcpdump ip6 proto 6# or$ tcpdump &#x27;ip6 protochain tcp&#x27;# or $ tcpdump ip6 protochain 6\n\nå…³äºä¸Šé¢è¿™å‡ ä¸ªå‘½ä»¤ç¤ºä¾‹ï¼Œæœ‰ä¸¤ç‚¹éœ€è¦æ³¨æ„ï¼š\n\nè·Ÿåœ¨ proto å’Œ protochain åé¢çš„å¦‚æœæ˜¯ tcp, udp, icmp ï¼Œé‚£ä¹ˆè¿‡æ»¤å™¨éœ€è¦ç”¨å¼•å·åŒ…å«ï¼Œè¿™æ˜¯å› ä¸º tcp,udp, icmp æ˜¯ tcpdump çš„å…³é”®å­—ã€‚\nè·Ÿåœ¨ip å’Œ ip6 å…³é”®å­—åé¢çš„ proto å’Œ protochain æ˜¯ä¸¤ä¸ªæ–°é¢å­”ï¼Œçœ‹èµ·æ¥ç”¨æ³•ç±»ä¼¼ï¼Œå®ƒä»¬æ˜¯å¦ç­‰ä»·ï¼Œåˆæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ\n\nå…³äºç¬¬äºŒç‚¹ï¼Œç½‘ç»œä¸Šæ²¡æœ‰æ‰¾åˆ°å¾ˆå…·ä½“çš„ç­”æ¡ˆï¼Œæˆ‘åªèƒ½é€šè¿‡ man tcpdump çš„æç¤ºï¼Œ ç»™å‡ºè‡ªå·±çš„ä¸ªäººçŒœæµ‹ï¼Œä½†ä¸ä¿è¯æ­£ç¡®ã€‚\nproto åé¢è·Ÿçš„ &lt;protocol&gt; çš„å…³é”®è¯æ˜¯å›ºå®šçš„ï¼Œåªèƒ½æ˜¯ ip, ip6, arp, rarp, atalk, aarp, decnet, sca, lat, mopdl, moprc, iso, stp, ipx, or netbeui è¿™é‡Œé¢çš„å…¶ä¸­ä¸€ä¸ªã€‚\nè€Œ protochain åé¢è·Ÿçš„ protocol è¦æ±‚å°±æ²¡æœ‰é‚£ä¹ˆä¸¥æ ¼ï¼Œå®ƒå¯ä»¥æ˜¯ä»»æ„è¯ï¼Œåªè¦ tcpdump çš„ IP æŠ¥æ–‡å¤´éƒ¨é‡Œçš„ protocol å­—æ®µä¸º &lt;protocol&gt; å°±èƒ½åŒ¹é…ä¸Šã€‚\nç†è®ºä¸Šæ¥è®²ï¼Œä¸‹é¢ä¸¤ç§å†™æ³•æ•ˆæœæ˜¯ä¸€æ ·çš„\n$ tcpdump &#x27;ip &amp;&amp; tcp&#x27;$ tcpdump &#x27;ip proto tcp&#x27;\n\nåŒæ ·çš„ï¼Œè¿™ä¸¤ç§å†™æ³•ä¹Ÿæ˜¯ä¸€æ ·çš„\n$ tcpdump &#x27;ip6 &amp;&amp; tcp&#x27;$ tcpdump &#x27;ip6 proto tcp&#x27;\n\n4. å¯é€‰å‚æ•°è§£æ4.1 è®¾ç½®ä¸è§£æåŸŸåæå‡é€Ÿåº¦\n-nï¼šä¸æŠŠipè½¬åŒ–æˆåŸŸåï¼Œç›´æ¥æ˜¾ç¤º ipï¼Œé¿å…æ‰§è¡Œ DNS lookups çš„è¿‡ç¨‹ï¼Œé€Ÿåº¦ä¼šå¿«å¾ˆå¤š\n-nnï¼šä¸æŠŠåè®®å’Œç«¯å£å·è½¬åŒ–æˆåå­—ï¼Œé€Ÿåº¦ä¹Ÿä¼šå¿«å¾ˆå¤šã€‚\n-Nï¼šä¸æ‰“å°å‡ºhost çš„åŸŸåéƒ¨åˆ†.ã€‚æ¯”å¦‚,ï¼Œå¦‚æœè®¾ç½®äº†æ­¤é€‰ç°ï¼Œtcpdump å°†ä¼šæ‰“å°â€™nicâ€™ è€Œä¸æ˜¯ â€˜nic.ddn.milâ€™.\n\n4.2 è¿‡æ»¤ç»“æœè¾“å‡ºåˆ°æ–‡ä»¶ä½¿ç”¨ tcpdump å·¥å…·æŠ“åˆ°åŒ…åï¼Œå¾€å¾€éœ€è¦å†å€ŸåŠ©å…¶ä»–çš„å·¥å…·è¿›è¡Œåˆ†æï¼Œæ¯”å¦‚å¸¸è§çš„ wireshark ã€‚\nè€Œè¦ä½¿ç”¨wireshark ï¼Œæˆ‘ä»¬å¾—å°† tcpdump æŠ“åˆ°çš„åŒ…æ•°æ®ç”Ÿæˆåˆ°æ–‡ä»¶ä¸­ï¼Œæœ€åå†ä½¿ç”¨ wireshark æ‰“å¼€å®ƒå³å¯ã€‚\nä½¿ç”¨ -w å‚æ•°åæ¥ä¸€ä¸ªä»¥ .pcap åç¼€å‘½ä»¤çš„æ–‡ä»¶åï¼Œå°±å¯ä»¥å°† tcpdump æŠ“åˆ°çš„æ•°æ®ä¿å­˜åˆ°æ–‡ä»¶ä¸­ã€‚\n$ tcpdump icmp -w icmp.pcap\n\n4.3 ä»æ–‡ä»¶ä¸­è¯»å–åŒ…æ•°æ®ä½¿ç”¨ -w æ˜¯å†™å…¥æ•°æ®åˆ°æ–‡ä»¶ï¼Œè€Œä½¿ç”¨ -r æ˜¯ä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ã€‚\nè¯»å–åï¼Œæˆ‘ä»¬ç…§æ ·å¯ä»¥ä½¿ç”¨ä¸Šè¿°çš„è¿‡æ»¤å™¨è¯­æ³•è¿›è¡Œè¿‡æ»¤åˆ†æã€‚\n$ tcpdump icmp -r all.pcap\n\n4.4 æ§åˆ¶è¯¦ç»†å†…å®¹çš„è¾“å‡º\n-vï¼šäº§ç”Ÿè¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚åŒ…çš„TTLï¼Œidæ ‡è¯†ï¼Œæ•°æ®åŒ…é•¿åº¦ï¼Œä»¥åŠIPåŒ…çš„ä¸€äº›é€‰é¡¹ã€‚åŒæ—¶å®ƒè¿˜ä¼šæ‰“å¼€ä¸€äº›é™„åŠ çš„åŒ…å®Œæ•´æ€§æ£€æµ‹ï¼Œæ¯”å¦‚å¯¹IPæˆ–ICMPåŒ…å¤´éƒ¨çš„æ ¡éªŒå’Œã€‚\n-vvï¼šäº§ç”Ÿæ¯”-væ›´è¯¦ç»†çš„è¾“å‡º. æ¯”å¦‚NFSå›åº”åŒ…ä¸­çš„é™„åŠ åŸŸå°†ä¼šè¢«æ‰“å°, SMBæ•°æ®åŒ…ä¹Ÿä¼šè¢«å®Œå…¨è§£ç ã€‚ï¼ˆæ‘˜è‡ªç½‘ç»œï¼Œç›®å‰æˆ‘è¿˜æœªä½¿ç”¨è¿‡ï¼‰\n-vvvï¼šäº§ç”Ÿæ¯”-vvæ›´è¯¦ç»†çš„è¾“å‡ºã€‚æ¯”å¦‚ telent æ—¶æ‰€ä½¿ç”¨çš„SB, SE é€‰é¡¹å°†ä¼šè¢«æ‰“å°, å¦‚æœtelnetåŒæ—¶ä½¿ç”¨çš„æ˜¯å›¾å½¢ç•Œé¢ï¼Œå…¶ç›¸åº”çš„å›¾å½¢é€‰é¡¹å°†ä¼šä»¥16è¿›åˆ¶çš„æ–¹å¼æ‰“å°å‡ºæ¥ï¼ˆæ‘˜è‡ªç½‘ç»œï¼Œç›®å‰æˆ‘è¿˜æœªä½¿ç”¨è¿‡ï¼‰\n\n4.5 æ§åˆ¶æ—¶é—´çš„æ˜¾ç¤º\n-tï¼šåœ¨æ¯è¡Œçš„è¾“å‡ºä¸­ä¸è¾“å‡ºæ—¶é—´\n-ttï¼šåœ¨æ¯è¡Œçš„è¾“å‡ºä¸­ä¼šè¾“å‡ºæ—¶é—´æˆ³\n-tttï¼šè¾“å‡ºæ¯ä¸¤è¡Œæ‰“å°çš„æ—¶é—´é—´éš”(ä»¥æ¯«ç§’ä¸ºå•ä½)\n-ttttï¼šåœ¨æ¯è¡Œæ‰“å°çš„æ—¶é—´æˆ³ä¹‹å‰æ·»åŠ æ—¥æœŸçš„æ‰“å°ï¼ˆæ­¤ç§é€‰é¡¹ï¼Œè¾“å‡ºçš„æ—¶é—´æœ€ç›´è§‚ï¼‰\n\n4.6 æ˜¾ç¤ºæ•°æ®åŒ…çš„å¤´éƒ¨\n-xï¼šä»¥16è¿›åˆ¶çš„å½¢å¼æ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®ï¼ˆä½†ä¸åŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨ï¼‰\n-xxï¼šä»¥16è¿›åˆ¶çš„å½¢å¼æ‰“å°æ¯ä¸ªåŒ…çš„å¤´éƒ¨æ•°æ®ï¼ˆåŒ…æ‹¬æ•°æ®é“¾è·¯å±‚çš„å¤´éƒ¨ï¼‰\n-Xï¼šä»¥16è¿›åˆ¶å’Œ ASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(ä½†ä¸åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨)ï¼Œè¿™åœ¨åˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿ã€‚\n-XXï¼šä»¥16è¿›åˆ¶å’Œ ASCIIç å½¢å¼æ‰“å°å‡ºæ¯ä¸ªåŒ…çš„æ•°æ®(åŒ…æ‹¬è¿æ¥å±‚çš„å¤´éƒ¨)ï¼Œè¿™åœ¨åˆ†æä¸€äº›æ–°åè®®çš„æ•°æ®åŒ…å¾ˆæ–¹ä¾¿ã€‚\n\n4.7 è¿‡æ»¤æŒ‡å®šç½‘å¡çš„æ•°æ®åŒ…\n-iï¼šæŒ‡å®šè¦è¿‡æ»¤çš„ç½‘å¡æ¥å£ï¼Œå¦‚æœè¦æŸ¥çœ‹æ‰€æœ‰ç½‘å¡ï¼Œå¯ä»¥ -i any\n\n4.8 è¿‡æ»¤ç‰¹å®šæµå‘çš„æ•°æ®åŒ…\n-Qï¼š é€‰æ‹©æ˜¯å…¥æ–¹å‘è¿˜æ˜¯å‡ºæ–¹å‘çš„æ•°æ®åŒ…ï¼Œå¯é€‰é¡¹æœ‰ï¼šin, out, inoutï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ â€“direction=[direction] è¿™ç§å†™æ³•\n\n4.9 å…¶ä»–å¸¸ç”¨çš„ä¸€äº›å‚æ•°\n-Aï¼šä»¥ASCIIç æ–¹å¼æ˜¾ç¤ºæ¯ä¸€ä¸ªæ•°æ®åŒ…(ä¸æ˜¾ç¤ºé“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯). åœ¨æŠ“å–åŒ…å«ç½‘é¡µæ•°æ®çš„æ•°æ®åŒ…æ—¶, å¯æ–¹ä¾¿æŸ¥çœ‹æ•°æ®\n-l : åŸºäºè¡Œçš„è¾“å‡ºï¼Œä¾¿äºä½ ä¿å­˜æŸ¥çœ‹ï¼Œæˆ–è€…äº¤ç»™å…¶å®ƒå·¥å…·åˆ†æ\n-q : ç®€æ´åœ°æ‰“å°è¾“å‡ºã€‚å³æ‰“å°å¾ˆå°‘çš„åè®®ç›¸å…³ä¿¡æ¯, ä»è€Œè¾“å‡ºè¡Œéƒ½æ¯”è¾ƒç®€çŸ­.\n-c : æ•è· count ä¸ªåŒ… tcpdump å°±é€€å‡º\n-s : tcpdump é»˜è®¤åªä¼šæˆªå–å‰ 96 å­—èŠ‚çš„å†…å®¹ï¼Œè¦æƒ³æˆªå–æ‰€æœ‰çš„æŠ¥æ–‡å†…å®¹ï¼Œå¯ä»¥ä½¿ç”¨ -s numberï¼Œ number å°±æ˜¯ä½ è¦æˆªå–çš„æŠ¥æ–‡å­—èŠ‚æ•°ï¼Œå¦‚æœæ˜¯ 0 çš„è¯ï¼Œè¡¨ç¤ºæˆªå–æŠ¥æ–‡å…¨éƒ¨å†…å®¹ã€‚\n-S : ä½¿ç”¨ç»å¯¹åºåˆ—å·ï¼Œè€Œä¸æ˜¯ç›¸å¯¹åºåˆ—å·\n-Cï¼šfile-sizeï¼Œtcpdump åœ¨æŠŠåŸå§‹æ•°æ®åŒ…ç›´æ¥ä¿å­˜åˆ°æ–‡ä»¶ä¸­ä¹‹å‰, æ£€æŸ¥æ­¤æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡file-size. å¦‚æœè¶…è¿‡äº†, å°†å…³é—­æ­¤æ–‡ä»¶,å¦åˆ›ä¸€ä¸ªæ–‡ä»¶ç»§ç»­ç”¨äºåŸå§‹æ•°æ®åŒ…çš„è®°å½•. æ–°åˆ›å»ºçš„æ–‡ä»¶åä¸-w é€‰é¡¹æŒ‡å®šçš„æ–‡ä»¶åä¸€è‡´, ä½†æ–‡ä»¶ååå¤šäº†ä¸€ä¸ªæ•°å­—.è¯¥æ•°å­—ä¼šä»1å¼€å§‹éšç€æ–°åˆ›å»ºæ–‡ä»¶çš„å¢å¤šè€Œå¢åŠ . file-sizeçš„å•ä½æ˜¯ç™¾ä¸‡å­—èŠ‚(nt: è¿™é‡ŒæŒ‡1,000,000ä¸ªå­—èŠ‚,å¹¶é1,048,576ä¸ªå­—èŠ‚, åè€…æ˜¯ä»¥1024å­—èŠ‚ä¸º1k, 1024kå­—èŠ‚ä¸º1Mè®¡ç®—æ‰€å¾—, å³1M=1024 ï¼Š 1024 ï¼ 1,048,576)\n-Fï¼šä½¿ç”¨file æ–‡ä»¶ä½œä¸ºè¿‡æ»¤æ¡ä»¶è¡¨è¾¾å¼çš„è¾“å…¥, æ­¤æ—¶å‘½ä»¤è¡Œä¸Šçš„è¾“å…¥å°†è¢«å¿½ç•¥.\n\n4.10 å¯¹è¾“å‡ºå†…å®¹è¿›è¡Œæ§åˆ¶çš„å‚æ•°\n-D : æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨ç½‘ç»œæ¥å£çš„åˆ—è¡¨\n-e : æ¯è¡Œçš„æ‰“å°è¾“å‡ºä¸­å°†åŒ…æ‹¬æ•°æ®åŒ…çš„æ•°æ®é“¾è·¯å±‚å¤´éƒ¨ä¿¡æ¯\n-E : æ­ç§˜IPSECæ•°æ®\n-L ï¼šåˆ—å‡ºæŒ‡å®šç½‘ç»œæ¥å£æ‰€æ”¯æŒçš„æ•°æ®é“¾è·¯å±‚çš„ç±»å‹åé€€å‡º\n-Zï¼šåæ¥ç”¨æˆ·åï¼Œåœ¨æŠ“åŒ…æ—¶ä¼šå—åˆ°æƒé™çš„é™åˆ¶ã€‚å¦‚æœä»¥rootç”¨æˆ·å¯åŠ¨tcpdumpï¼Œtcpdumpå°†ä¼šæœ‰è¶…çº§ç”¨æˆ·æƒé™ã€‚\n-dï¼šæ‰“å°å‡ºæ˜“è¯»çš„åŒ…åŒ¹é…ç \n-ddï¼šä»¥Cè¯­è¨€çš„å½¢å¼æ‰“å°å‡ºåŒ…åŒ¹é…ç .\n-dddï¼šä»¥åè¿›åˆ¶æ•°çš„å½¢å¼æ‰“å°å‡ºåŒ…åŒ¹é…ç \n\n5. è¿‡æ»¤è§„åˆ™ç»„åˆæœ‰ç¼–ç¨‹åŸºç¡€çš„åŒå­¦ï¼Œå¯¹äºä¸‹é¢ä¸‰ä¸ªé€»è¾‘è¿ç®—ç¬¦åº”è¯¥ä¸é™Œç”Ÿäº†å§\n\nandï¼šæ‰€æœ‰çš„æ¡ä»¶éƒ½éœ€è¦æ»¡è¶³ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º &amp;&amp;\norï¼šåªè¦æœ‰ä¸€ä¸ªæ¡ä»¶æ»¡è¶³å°±å¯ä»¥ï¼Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º ||\nnotï¼šå–åï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ !\n\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘æƒ³éœ€è¦æŠ“ä¸€ä¸ªæ¥è‡ª10.5.2.3ï¼Œå‘å¾€ä»»æ„ä¸»æœºçš„3389ç«¯å£çš„åŒ…\n$ tcpdump src 10.5.2.3 and dst port 3389\n\nå½“ä½ åœ¨ä½¿ç”¨å¤šä¸ªè¿‡æ»¤å™¨è¿›è¡Œç»„åˆæ—¶ï¼Œæœ‰å¯èƒ½éœ€è¦ç”¨åˆ°æ‹¬å·ï¼Œè€Œæ‹¬å·åœ¨ shell ä¸­æ˜¯ç‰¹æ®Šç¬¦å·ï¼Œå› ä¸ºä½ éœ€è¦ä½¿ç”¨å¼•å·å°†å…¶åŒ…å«ã€‚ä¾‹å­å¦‚ä¸‹ï¼š\n$ tcpdump &#x27;src 10.0.2.4 and (dst port 3389 or 22)&#x27;\n\nè€Œåœ¨å•ä¸ªè¿‡æ»¤å™¨é‡Œï¼Œå¸¸å¸¸ä¼šåˆ¤æ–­ä¸€æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œè¿™æ—¶å€™ï¼Œå°±è¦ä½¿ç”¨ä¸‹é¢ä¸¤ä¸ªç¬¦å·\n\n=ï¼šåˆ¤æ–­äºŒè€…ç›¸ç­‰\n==ï¼šåˆ¤æ–­äºŒè€…ç›¸ç­‰\n!=ï¼šåˆ¤æ–­äºŒè€…ä¸ç›¸ç­‰\n\nå½“ä½ ä½¿ç”¨è¿™ä¸¤ä¸ªç¬¦å·æ—¶ï¼Œtcpdump è¿˜æä¾›äº†ä¸€äº›å…³é”®å­—çš„æ¥å£æ¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œåˆ¤æ–­ï¼Œæ¯”å¦‚\n\nifï¼šè¡¨ç¤ºç½‘å¡æ¥å£åã€\nprocï¼šè¡¨ç¤ºè¿›ç¨‹å\npidï¼šè¡¨ç¤ºè¿›ç¨‹ id\nsvcï¼šè¡¨ç¤º service class\ndirï¼šè¡¨ç¤ºæ–¹å‘ï¼Œin å’Œ out\neprocï¼šè¡¨ç¤º effective process name\nepidï¼šè¡¨ç¤º effective process ID\n\næ¯”å¦‚æˆ‘ç°åœ¨è¦è¿‡æ»¤æ¥è‡ªè¿›ç¨‹åä¸º nc å‘å‡ºçš„æµç» en0 ç½‘å¡çš„æ•°æ®åŒ…ï¼Œæˆ–è€…ä¸æµç» en0 çš„å…¥æ–¹å‘æ•°æ®åŒ…ï¼Œå¯ä»¥è¿™æ ·å­å†™\n$ tcpdump &quot;( if=en0 and proc =nc ) || (if != en0 and dir=in)&quot;\n\n6. ç‰¹æ®Šè¿‡æ»¤è§„åˆ™5.1 æ ¹æ® tcpflags è¿›è¡Œè¿‡æ»¤é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬çŸ¥é“äº† tcp çš„é¦–éƒ¨æœ‰ä¸€ä¸ªæ ‡å¿—ä½ã€‚\n\ntcpdump æ”¯æŒæˆ‘ä»¬æ ¹æ®æ•°æ®åŒ…çš„æ ‡å¿—ä½è¿›è¡Œè¿‡æ»¤\nproto [ expr:size ]\n\n\nprotoï¼šå¯ä»¥æ˜¯ç†ŸçŸ¥çš„åè®®ä¹‹ä¸€ï¼ˆå¦‚ipï¼Œarpï¼Œtcpï¼Œudpï¼Œicmpï¼Œipv6ï¼‰\nexprï¼šå¯ä»¥æ˜¯æ•°å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¡¨ç¤ºä¸æŒ‡å®šçš„åè®®å¤´å¼€å§‹å¤„çš„å­—èŠ‚åç§»é‡ã€‚\nsizeï¼šæ˜¯å¯é€‰çš„ï¼Œè¡¨ç¤ºä»å­—èŠ‚åç§»é‡å¼€å§‹å–çš„å­—èŠ‚æ•°é‡ã€‚\n\næ¥ä¸‹æ¥ï¼Œæˆ‘å°†ä¸¾å‡ ä¸ªä¾‹å­ï¼Œè®©äººæ˜ç™½å®ƒçš„å†™æ³•ï¼Œä¸è¿‡åœ¨é‚£ä¹‹å‰ï¼Œæœ‰å‡ ä¸ªç‚¹éœ€è¦ä½ æ˜ç™½ï¼Œè¿™åœ¨åé¢çš„ä¾‹å­ä¸­ä¼šç”¨åˆ°ï¼š\n1ã€tcpflags å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªåˆ«åå¸¸é‡ï¼Œç›¸å½“äº 13ï¼Œå®ƒä»£è¡¨ç€ä¸æŒ‡å®šçš„åè®®å¤´å¼€å¤´ç›¸å…³çš„å­—èŠ‚åç§»é‡ï¼Œä¹Ÿå°±æ˜¯æ ‡å¿—ä½ï¼Œæ‰€ä»¥ tcp[tcpflags] ç­‰ä»·äº tcp[13] ï¼Œå¯¹åº”ä¸‹å›¾ä¸­çš„æŠ¥æ–‡ä½ç½®ã€‚\n\n2ã€tcp-fin, tcp-syn, tcp-rst, tcp-push, tcp-ack, tcp-urg è¿™äº›åŒæ ·å¯ä»¥ç†è§£ä¸ºåˆ«åå¸¸é‡ï¼Œåˆ†åˆ«ä»£è¡¨ 1ï¼Œ2ï¼Œ4ï¼Œ8ï¼Œ16ï¼Œ32ï¼Œ64ã€‚è¿™äº›æ•°å­—æ˜¯å¦‚ä½•è®¡ç®—å‡ºæ¥çš„å‘¢ï¼Ÿ\nä»¥ tcp-syn ä¸ºä¾‹ï¼Œä½ å¯ä»¥å‚ç…§ä¸‹é¢è¿™å¼ å›¾ï¼Œè®¡ç®—å‡ºæ¥çš„å€¼ æ˜¯å°±æ˜¯ 2\n\nç”±äºæ•°å­—ä¸å¥½è®°å¿†ï¼Œæ‰€ä»¥ä¸€èˆ¬ä½¿ç”¨è¿™æ ·çš„â€œåˆ«åå¸¸é‡â€è¡¨ç¤ºã€‚\nå› æ­¤å½“ä¸‹é¢è¿™ä¸ªè¡¨è¾¾å¼æˆç«‹æ—¶ï¼Œå°±ä»£è¡¨è¿™ä¸ªåŒ…æ˜¯ä¸€ä¸ª syn åŒ…ã€‚\ntcp[tcpflags] == tcp-syn\n\nè¦æŠ“å–ç‰¹å®šæ•°æ®åŒ…ï¼Œæ–¹æ³•æœ‰å¾ˆå¤šç§ã€‚\nä¸‹é¢ä»¥æœ€å¸¸è§çš„ synåŒ…ä¸ºä¾‹ï¼Œæ¼”ç¤ºä¸€ä¸‹å¦‚ä½•ç”¨ tcpdump æŠ“å–åˆ° syn åŒ…ï¼Œè€Œå…¶ä»–çš„ç±»å‹çš„åŒ…ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ã€‚\næ®æˆ‘æ€»ç»“ï¼Œä¸»è¦æœ‰ä¸‰ç§å†™æ³•ï¼š\n1ã€ç¬¬ä¸€ç§å†™æ³•ï¼šä½¿ç”¨æ•°å­—è¡¨ç¤ºåç§»é‡\n$ tcpdump -i eth0 &quot;tcp[13] &amp; 2 != 0&quot; \n\n2ã€ç¬¬äºŒç§å†™æ³•ï¼šä½¿ç”¨åˆ«åå¸¸é‡è¡¨ç¤ºåç§»é‡\n$ tcpdump -i eth0 &quot;tcp[tcpflags] &amp; tcp-syn != 0&quot; \n\n3ã€ç¬¬ä¸‰ç§å†™æ³•ï¼šä½¿ç”¨æ··åˆå†™æ³•\n$ tcpdump -i eth0 &quot;tcp[tcpflags] &amp; 2 != 0&quot; # or$ tcpdump -i eth0 &quot;tcp[13] &amp; tcp-syn != 0&quot; \n\nå¦‚æœæˆ‘æƒ³åŒæ—¶æ•è·å¤šç§ç±»å‹çš„åŒ…å‘¢ï¼Œæ¯”å¦‚ syn + ack åŒ…\n1ã€ç¬¬ä¸€ç§å†™æ³•\n$ tcpdump -i eth0 &#x27;tcp[13] == 2 or tcp[13] == 16&#x27;\n\n2ã€ç¬¬äºŒç§å†™æ³•\n$ tcpdump -i eth0 &#x27;tcp[tcpflags] == tcp-syn or tcp[tcpflags] == tcp-ack&#x27;\n\n3ã€ç¬¬ä¸‰ç§å†™æ³•\n$ tcpdump -i eth0 &quot;tcp[tcpflags] &amp; (tcp-syn|tcp-ack) != 0&quot; \n\n4ã€ç¬¬å››ç§å†™æ³•ï¼šæ³¨æ„è¿™é‡Œæ˜¯ å•ä¸ªç­‰å·ï¼Œè€Œä¸æ˜¯åƒä¸Šé¢ä¸€æ ·ä¸¤ä¸ªç­‰å·ï¼Œ18ï¼ˆsyn+ackï¼‰ = 2ï¼ˆsynï¼‰ + 16ï¼ˆackï¼‰\n$ tcpdump -i eth0 &#x27;tcp[13] = 18&#x27;# or$ tcpdump -i eth0 &#x27;tcp[tcpflags] = 18&#x27;\n\ntcp ä¸­æœ‰ ç±»ä¼¼ tcp-syn çš„åˆ«åå¸¸é‡ï¼Œå…¶ä»–åè®®ä¹Ÿæ˜¯æœ‰çš„ï¼Œæ¯”å¦‚ icmp åè®®ï¼Œå¯ä»¥ä½¿ç”¨çš„åˆ«åå¸¸é‡æœ‰\nicmp-echoreply, icmp-unreach, icmp-sourcequench, icmp-redirect, icmp-echo, icmp-routeradvert,icmp-routersolicit, icmp-timx-ceed, icmp-paramprob, icmp-tstamp, icmp-tstampreply,icmp-ireq, icmp-ireqreply, icmp-maskreq, icmp-maskreply\n\n5.2 åŸºäºåŒ…å¤§å°è¿›è¡Œè¿‡æ»¤è‹¥ä½ æƒ³æŸ¥çœ‹æŒ‡å®šå¤§å°çš„æ•°æ®åŒ…ï¼Œä¹Ÿæ˜¯å¯ä»¥çš„\n$ tcpdump less 32 $ tcpdump greater 64 $ tcpdump &lt;= 128\n\n5.3 æ ¹æ® mac åœ°å€è¿›è¡Œè¿‡æ»¤ä¾‹å­å¦‚ä¸‹ï¼Œå…¶ä¸­ ehost æ˜¯è®°å½•åœ¨ /etc/ethers é‡Œçš„ name\n$ tcpdump ether host [ehost]$ tcpdump ether dst\t[ehost]$ tcpdump ether src\t[ehost]\n\n5.4 è¿‡æ»¤é€šè¿‡æŒ‡å®šç½‘å…³çš„æ•°æ®åŒ…$ tcpdump gateway [host]\n\n5.5 è¿‡æ»¤å¹¿æ’­/å¤šæ’­æ•°æ®åŒ…$ tcpdump ether broadcast$ tcpdump ether multicast$ tcpdump ip broadcast$ tcpdump ip multicast$ tcpdump ip6 multicast\n\n7. å¦‚ä½•æŠ“å–åˆ°æ›´ç²¾å‡†çš„åŒ…ï¼Ÿå…ˆç»™ä½ æŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœæˆ‘åªæƒ³æŠ“å– HTTP çš„ POST è¯·æ±‚è¯¥å¦‚ä½•å†™å‘¢ï¼Ÿ\nå¦‚æœåªå­¦ä¹ äº†ä¸Šé¢çš„å†…å®¹ï¼Œææ€•ä½ è¿˜æ˜¯æ— æ³•å†™æ³•æ»¡è¶³è¿™ä¸ªæŠ“å–éœ€æ±‚çš„è¿‡æ»¤å™¨ã€‚\nåœ¨å­¦ä¹ ä¹‹å‰ï¼Œæˆ‘å…ˆç»™å‡ºç­”æ¡ˆï¼Œç„¶åå†å‰–æä¸€ä¸‹ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨æ˜¯å¦‚ä½•ç”Ÿæ•ˆçš„ï¼Œå±…ç„¶èƒ½è®©æˆ‘ä»¬å¯¹åŒ…å†…çš„å†…å®¹è¿›è¡Œåˆ¤æ–­ã€‚\n$ tcpdump -s 0 -A -vv &#x27;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4]&#x27;\n\nå‘½ä»¤é‡Œçš„å¯é€‰å‚æ•°ï¼Œåœ¨å‰é¢çš„å†…å®¹é‡Œå·²ç»è¯¦ç»†è®²è¿‡äº†ã€‚è¿™é‡Œä¸å†ç»†è®²ã€‚\næœ¬èŠ‚çš„é‡ç‚¹æ˜¯å¼•å·é‡Œçš„å†…å®¹ï¼Œçœ‹èµ·æ¥å¾ˆå¤æ‚çš„æ ·å­ã€‚\nå°†å®ƒé€ä¸€åˆ†è§£ï¼Œæˆ‘ä»¬åªè¦å…ˆç†è§£äº†ä¸‹é¢å‡ ç§ç”¨æ³•ï¼Œå°±èƒ½æ˜ç™½\n\ntcp[n]ï¼šè¡¨ç¤º tcp æŠ¥æ–‡é‡Œ ç¬¬ n ä¸ªå­—èŠ‚\n\ntcp[n:c]ï¼šè¡¨ç¤º tcp æŠ¥æ–‡é‡Œä»ç¬¬nä¸ªå­—èŠ‚å¼€å§‹å– c ä¸ªå­—èŠ‚ï¼Œtcp[12:1] è¡¨ç¤ºä»æŠ¥æ–‡çš„ç¬¬12ä¸ªå­—èŠ‚ï¼ˆå› ä¸ºæœ‰ç¬¬0ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™é‡Œçš„12å…¶å®è¡¨ç¤ºçš„æ˜¯13ï¼‰å¼€å§‹ç®—èµ·å–ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªbitã€‚æŸ¥çœ‹ tcp çš„æŠ¥æ–‡é¦–éƒ¨ç»“æ„ï¼Œå¯ä»¥å¾—çŸ¥è¿™ 8 ä¸ªbit å…¶å®å°±æ˜¯ä¸‹å›¾ä¸­çš„çº¢æ¡†åœˆèµ·æ¥çš„ä½ç½®ï¼Œè€Œåœ¨è¿™é‡Œæˆ‘ä»¬åªè¦å‰é¢ 4ä¸ªbitï¼Œä¹Ÿå°±æ˜¯å®é™…æ•°æ®åœ¨æ•´ä¸ªæŠ¥æ–‡é¦–éƒ¨ä¸­çš„åç§»é‡ã€‚\n\n\n&amp;ï¼šæ˜¯ä½è¿ç®—é‡Œçš„ and æ“ä½œç¬¦ï¼Œæ¯”å¦‚ 0011 &amp; 0010 = 0010\n\n&gt;&gt;ï¼šæ˜¯ä½è¿ç®—é‡Œçš„å³ç§»æ“ä½œï¼Œæ¯”å¦‚ 0111 &gt;&gt; 2 = 0001\n\n0xf0ï¼šæ˜¯ 10 è¿›åˆ¶çš„ 240 çš„ 16 è¿›åˆ¶è¡¨ç¤ºï¼Œä½†å¯¹äºä½æ“ä½œæ¥è¯´ï¼Œ10è¿›åˆ¶å’Œ16è¿›åˆ¶éƒ½å°†æ¯«æ— æ„ä¹‰ï¼Œæˆ‘ä»¬éœ€è¦çš„æ˜¯äºŒè¿›åˆ¶ï¼Œå°†å…¶è½¬æ¢æˆäºŒè¿›åˆ¶åæ˜¯ï¼š11110000ï¼Œè¿™ä¸ªæ•°æœ‰ä»€ä¹ˆç‰¹ç‚¹å‘¢ï¼Ÿå‰é¢ä¸ª 4bit å…¨éƒ¨æ˜¯ 1ï¼Œåé¢4ä¸ªbitå…¨éƒ¨æ˜¯0ï¼Œå¾€åçœ‹ä½ å°±çŸ¥é“è¿™ä¸ªç‰¹ç‚¹æœ‰ä»€ä¹ˆç”¨äº†ã€‚\n\n\nåˆ†è§£å®Œåï¼Œå†æ…¢æ…¢åˆå¹¶èµ·æ¥çœ‹\n1ã€tcp[12:1] &amp; 0xf0 å…¶å®å¹¶ä¸ç›´è§‚ï¼Œä½†æ˜¯æˆ‘ä»¬å°†å®ƒæ¢ä¸€ç§å†™æ³•ï¼Œå°±å¥½çœ‹å¤šäº†ï¼Œå‡è®¾ tcp æŠ¥æ–‡ä¸­çš„ ç¬¬12 ä¸ªå­—èŠ‚æ˜¯è¿™æ ·ç»„æˆçš„ 10110000ï¼Œé‚£ä¹ˆè¿™ä¸ªè¡¨è¾¾å¼å°±å¯ä»¥å˜æˆ 10110110 &amp;&amp; 11110000 = 10110000ï¼Œå¾—åˆ°äº† 10110000 åï¼Œå†è¿›å…¥ä¸‹ä¸€æ­¥ã€‚\n2ã€tcp[12:1] &amp; 0xf0) &gt;&gt; 2 ï¼šå¦‚æœä½ ä¸ç†è§£ tcp æŠ¥æ–‡é¦–éƒ¨é‡Œçš„æ•°æ®åç§»ï¼Œè¯·å…ˆç‚¹å‡»è¿™ä¸ªå‰å¾€æˆ‘çš„ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œææ‡‚æ•°æ®åç§»çš„æ„ä¹‰ï¼Œå¦åˆ™æˆ‘ä¿è¯ä½ è¿™é‡Œä¼šç»å¯¹ä¼šå¬æ‡µäº†ã€‚\ntcp[12:1] &amp; 0xf0) &gt;&gt; 2 è¿™ä¸ªè¡¨è¾¾å¼å®é™…æ˜¯ (tcp[12:1] &amp; 0xf0) &gt;&gt; 4 ) &lt;&lt; 2 çš„ç®€å†™å½¢å¼ã€‚æ‰€ä»¥è¦ææ‡‚ tcp[12:1] &amp; 0xf0) &gt;&gt; 2 åªè¦ç†è§£äº†(tcp[12:1] &amp; 0xf0) &gt;&gt; 4 ) &lt;&lt; 2 å°±è¡Œäº† ã€‚\nä»ä¸Šä¸€æ­¥æˆ‘ä»¬ç®—å‡ºäº† tcp[12:1] &amp; 0xf0 çš„å€¼å…¶å®æ˜¯ä¸€ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ 8 ä¸ªbitï¼Œä½†æ˜¯ä½ å†å›å»çœ‹ä¸‹ä¸Šé¢çš„ tcp æŠ¥æ–‡é¦–éƒ¨ç»“æ„å›¾ï¼Œè¡¨ç¤ºæ•°æ®åç§»é‡çš„åªæœ‰ 4ä¸ªbitï¼Œä¹Ÿå°±æ˜¯è¯´ ä¸Šé¢å¾—åˆ°çš„å€¼ 10110000ï¼Œå‰é¢ 4 ä½ï¼ˆ1011ï¼‰æ‰æ˜¯æ­£ç¡®çš„åç§»é‡ï¼Œé‚£ä¹ˆä¸ºäº†å¾—åˆ° 1011ï¼Œåªéœ€è¦å°† 10110000 å³ç§»4ä½å³å¯ï¼Œä¹Ÿå°±æ˜¯ tcp[12:1] &amp; 0xf0) &gt;&gt; 4ï¼Œè‡³æ­¤æˆ‘ä»¬æ˜¯ä¸æ˜¯å·²ç»å¾—å‡ºäº†å®é™…æ•°æ®çš„æ­£ç¡®ä½ç½®å‘¢ï¼Œå¾ˆé—æ†¾è¿˜æ²¡æœ‰ï¼Œå‰ä¸€ç¯‡æ–‡ç« é‡Œæˆ‘ä»¬è®²åˆ° Data Offset çš„å•ä½æ˜¯ 4ä¸ªå­—èŠ‚ï¼Œå› ä¸ºè¦å°† 1011 ä¹˜ä»¥ 4æ‰å¯ä»¥ï¼Œé™¤ä»¥4åœ¨ä½è¿ç®—ä¸­ç›¸å½“äºå·¦ç§»2ä½ï¼Œä¹Ÿå°±æ˜¯ &lt;&lt;2ï¼Œä¸å‰é¢çš„ &gt;&gt;4 ç»“åˆèµ·æ¥ä¸€èµ·ç®—çš„è¯ï¼Œæœ€ç»ˆçš„è¿ç®—å¯ä»¥ç®€åŒ–ä¸º &gt;&gt;2ã€‚\nè‡³æ­¤ï¼Œæˆ‘ä»¬ç»ˆäºå¾—å‡ºäº†å®é™…æ•°æ®å¼€å§‹çš„ä½ç½®æ˜¯ tcp[12:1] &amp; 0xf0) &gt;&gt; 2 ï¼ˆå•ä½æ˜¯å­—èŠ‚ï¼‰ã€‚\næ‰¾åˆ°äº†æ•°æ®çš„èµ·ç‚¹åï¼Œå¯åˆ«å¿˜äº†æˆ‘ä»¬çš„ç›®çš„æ˜¯ä»æ•°æ®ä¸­æ‰“åˆ° HTTP è¯·æ±‚çš„æ–¹æ³•ï¼Œæ˜¯ GET å‘¢ è¿˜æ˜¯ POST ï¼Œæˆ–è€…æ˜¯å…¶ä»–çš„ï¼Ÿ\næœ‰äº†ä¸Šé¢çš„ç»éªŒï¼Œæˆ‘ä»¬è‡ªç„¶æ‡‚å¾—ä½¿ç”¨ tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] ä»æ•°æ®å¼€å§‹çš„ä½ç½®å†å–å‡ºå››ä¸ªå­—èŠ‚ï¼Œç„¶åå°†ç»“æœä¸ GET ï¼ˆæ³¨æ„ GETæœ€åè¿˜æœ‰ä¸ªç©ºæ ¼ï¼‰çš„ 16è¿›åˆ¶å†™æ³•ï¼ˆä¹Ÿå°±æ˜¯ 0x47455420ï¼‰è¿›è¡Œæ¯”å¯¹ã€‚\n0x47   --&gt;   71    --&gt;  G0x45   --&gt;   69    --&gt;  E0x54   --&gt;   84    --&gt;  T0x20   --&gt;   32    --&gt;  ç©ºæ ¼\n\n\nå¦‚æœç›¸ç­‰ï¼Œåˆ™è¯¥è¡¨è¾¾å¼ä¸ºTrueï¼Œtcpdump è®¤ä¸ºè¿™å°±æ˜¯æˆ‘ä»¬æ‰€éœ€è¦æŠ“çš„æ•°æ®åŒ…ï¼Œå°†å…¶è¾“å‡ºåˆ°æˆ‘ä»¬çš„ç»ˆç«¯å±å¹•ä¸Šã€‚\n8. æŠ“åŒ…å®æˆ˜åº”ç”¨ä¾‹å­8.1 æå– HTTP çš„ User-Agentä» HTTP è¯·æ±‚å¤´ä¸­æå– HTTP çš„ User-Agentï¼š\n$ tcpdump -nn -A -s1500 -l | grep &quot;User-Agent:&quot;\n\né€šè¿‡ egrep å¯ä»¥åŒæ—¶æå–User-Agent å’Œä¸»æœºåï¼ˆæˆ–å…¶ä»–å¤´æ–‡ä»¶ï¼‰ï¼š\n$ tcpdump -nn -A -s1500 -l | egrep -i &#x27;User-Agent:|Host:&#x27;\n\n8.2 æŠ“å– HTTP GET å’Œ POST è¯·æ±‚æŠ“å– HTTP GET è¯·æ±‚åŒ…ï¼š\n$ tcpdump -s 0 -A -vv &#x27;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x47455420&#x27;# or$ tcpdump -vvAls0 | grep &#x27;GET&#x27;\n\nå¯ä»¥æŠ“å– HTTP POST è¯·æ±‚åŒ…ï¼š\n$ tcpdump -s 0 -A -vv &#x27;tcp[((tcp[12:1] &amp; 0xf0) &gt;&gt; 2):4] = 0x504f5354&#x27;# or $ tcpdump -vvAls0 | grep &#x27;POST&#x27;\n\næ³¨æ„ï¼šè¯¥æ–¹æ³•ä¸èƒ½ä¿è¯æŠ“å–åˆ° HTTP POST æœ‰æ•ˆæ•°æ®æµé‡ï¼Œå› ä¸ºä¸€ä¸ª POST è¯·æ±‚ä¼šè¢«åˆ†å‰²ä¸ºå¤šä¸ª TCP æ•°æ®åŒ…ã€‚\n8.3 æ‰¾å‡ºå‘åŒ…æ•°æœ€å¤šçš„ IPæ‰¾å‡ºä¸€æ®µæ—¶é—´å†…å‘åŒ…æœ€å¤šçš„ IPï¼Œæˆ–è€…ä»ä¸€å †æŠ¥æ–‡ä¸­æ‰¾å‡ºå‘åŒ…æœ€å¤šçš„ IPï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š\n$ tcpdump -nnn -t -c 200 | cut -f 1,2,3,4 -d &#x27;.&#x27; | sort | uniq -c | sort -nr | head -n 20\n\n\ncut -f 1,2,3,4 -d â€˜.â€™ : ä»¥ . ä¸ºåˆ†éš”ç¬¦ï¼Œæ‰“å°å‡ºæ¯è¡Œçš„å‰å››åˆ—ã€‚å³ IP åœ°å€ã€‚\nsort | uniq -c : æ’åºå¹¶è®¡æ•°\nsort -nr : æŒ‰ç…§æ•°å€¼å¤§å°é€†å‘æ’åº\n\n8.4 æŠ“å– DNS è¯·æ±‚å’Œå“åº”DNS çš„é»˜è®¤ç«¯å£æ˜¯ 53ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ç«¯å£è¿›è¡Œè¿‡æ»¤\n$ tcpdump -i any -s0 port 53\n\n8.5 åˆ‡å‰² pcap æ–‡ä»¶å½“æŠ“å–å¤§é‡æ•°æ®å¹¶å†™å…¥æ–‡ä»¶æ—¶ï¼Œå¯ä»¥è‡ªåŠ¨åˆ‡å‰²ä¸ºå¤šä¸ªå¤§å°ç›¸åŒçš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œä¸‹é¢çš„å‘½ä»¤è¡¨ç¤ºæ¯ 3600 ç§’åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶ capture-(hour).pcapï¼Œæ¯ä¸ªæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 200*1000000 å­—èŠ‚ï¼š\n$ tcpdump  -w /tmp/capture-%H.pcap -G 3600 -C 200\n\nè¿™äº›æ–‡ä»¶çš„å‘½åä¸º capture-&#123;1-24&#125;.pcapï¼Œ24 å°æ—¶ä¹‹åï¼Œä¹‹å‰çš„æ–‡ä»¶å°±ä¼šè¢«è¦†ç›–ã€‚\n8.6 æå– HTTP POST è¯·æ±‚ä¸­çš„å¯†ç ä» HTTP POST è¯·æ±‚ä¸­æå–å¯†ç å’Œä¸»æœºåï¼š\n$ tcpdump -s 0 -A -n -l | egrep -i &quot;POST /|pwd=|passwd=|password=|Host:&quot;\n\n8.7 æå– HTTP è¯·æ±‚çš„ URLæå– HTTP è¯·æ±‚çš„ä¸»æœºåå’Œè·¯å¾„ï¼š\n$ tcpdump -s 0 -v -n -l | egrep -i &quot;POST /|GET /|Host:&quot;\n\n8.8 æŠ“å– HTTP æœ‰æ•ˆæ•°æ®åŒ…æŠ“å– 80 ç«¯å£çš„ HTTP æœ‰æ•ˆæ•°æ®åŒ…ï¼Œæ’é™¤ TCP è¿æ¥å»ºç«‹è¿‡ç¨‹çš„æ•°æ®åŒ…ï¼ˆSYN / FIN / ACKï¼‰ï¼š\n$ tcpdump &#x27;tcp port 80 and (((ip[2:2] - ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;0xf0)&gt;&gt;2)) != 0)&#x27;\n\n8.9 ç»“åˆ Wireshark è¿›è¡Œåˆ†æé€šå¸¸ Wiresharkï¼ˆæˆ– tsharkï¼‰æ¯” tcpdump æ›´å®¹æ˜“åˆ†æåº”ç”¨å±‚åè®®ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šå…ˆä½¿ç”¨ tcpdump æŠ“å–æ•°æ®å¹¶å†™å…¥æ–‡ä»¶(åç¼€ä¸ºpacp)ï¼Œç„¶åå†å°†æ–‡ä»¶æ‹·è´åˆ°æœ¬åœ°å·¥ä½œç«™ä¸Šç”¨ Wireshark åˆ†æã€‚\nè¿˜æœ‰ä¸€ç§æ›´é«˜æ•ˆçš„æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡ ssh è¿æ¥å°†æŠ“å–åˆ°çš„æ•°æ®å®æ—¶å‘é€ç»™ Wireshark è¿›è¡Œåˆ†æã€‚ä»¥ MacOS ç³»ç»Ÿä¸ºä¾‹ï¼Œå¯ä»¥é€šè¿‡ brew cask install wireshark æ¥å®‰è£…ï¼Œç„¶åé€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥åˆ†æï¼š\n$ ssh root@remotesystem &#x27;tcpdump -s0 -c 1000 -nn -w - not port 22&#x27; | /Applications/Wireshark.app/Contents/MacOS/Wireshark -k -i -\n\nä¾‹å¦‚ï¼Œå¦‚æœæƒ³åˆ†æ DNS åè®®ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š\n$ ssh root@remotesystem &#x27;tcpdump -s0 -c 1000 -nn -w - port 53&#x27; | /Applications/Wireshark.app/Contents/MacOS/Wireshark -k -i -\n\næŠ“å–åˆ°çš„æ•°æ®ï¼š\n\n-c é€‰é¡¹ç”¨æ¥é™åˆ¶æŠ“å–æ•°æ®çš„å¤§å°ã€‚å¦‚æœä¸é™åˆ¶å¤§å°ï¼Œå°±åªèƒ½é€šè¿‡ ctrl-c æ¥åœæ­¢æŠ“å–ï¼Œè¿™æ ·ä¸€æ¥ä¸ä»…å…³é—­äº† tcpdumpï¼Œä¹Ÿå…³é—­äº† wiresharkã€‚\nåˆ°è¿™é‡Œï¼Œæˆ‘å·²ç»å°†æˆ‘æ‰€çŸ¥é“çš„ tcpdump çš„ç”¨æ³•å…¨éƒ¨è¯´äº†ä¸€éï¼Œå¦‚æœä½ æœ‰è®¤çœŸåœ°çœ‹å®Œæœ¬æ–‡ï¼Œç›¸ä¿¡ä¼šæœ‰ä¸å°çš„æ”¶è·ï¼ŒæŒæ¡ä¸€ä¸ªä¸Šæ‰‹çš„æŠ“åŒ…å·¥å…·ï¼Œå¯¹äºä»¥åæˆ‘ä»¬å­¦ä¹ ç½‘ç»œã€åˆ†æç½‘ç»œåè®®ã€ä»¥åŠå®šä½ç½‘ç»œé—®é¢˜ï¼Œä¼šå¾ˆæœ‰å¸®åŠ©ï¼Œè€Œ tcpdump æ˜¯æˆ‘æ¨èçš„ä¸€ä¸ªæŠ“åŒ…å·¥å…·ã€‚\n9. å‚è€ƒæ–‡ç« \nFreeBSD Manual Pages About tcpdump\nLinux tcpdumpå‘½ä»¤è¯¦è§£\nä¸€ä»½å¿«é€Ÿå®ç”¨çš„ tcpdump å‘½ä»¤å‚è€ƒæ‰‹å†Œ\nè¶…è¯¦ç»†çš„ç½‘ç»œæŠ“åŒ…ç¥å™¨ tcpdump ä½¿ç”¨æŒ‡å—\n[è¯‘]tcpdump ç¤ºä¾‹æ•™ç¨‹\n[è‹±]tcpdump ç¤ºä¾‹æ•™ç¨‹\n\n","categories":["è¿ç»´","Linux"]},{"title":"Docker å®‰è£…Mysql","url":"/posts/15647/","content":"1.æ‹‰å–é•œåƒdocker pull --platform linux/x86_64 mysql\n\n2.å¯åŠ¨å®¹å™¨docker run -d --name mysql -p 3306:3306 -e MYSQL_ROOT_PASSWORD=123456 --platform linux/x86_64 mysql","categories":["MySQL"]},{"title":"Mac Navicat 15 æ— é™è¯•ç”¨","url":"/posts/7658/","content":"1. åˆ é™¤æ³¨å†Œè¡¨cd ~/Library/Preferences# æŸ¥çœ‹æ³¨å†Œè¡¨plutil -p com.prect.NavicatPremium15.plist# åˆ é™¤å±æ€§plutil -remove 91F6C435D172C8163E0689D3DAD3F3E9 com.prect.NavicatPremium15.plist\n\n2. åˆ é™¤éšè—æ–‡ä»¶cd ~/Library/Application\\ Support/PremiumSoft\\ CyberTech/Navicat\\ CC/Navicat\\ Premiumls -al# åˆ é™¤ä¸è¯¥æ–‡ä»¶åç›¸ä¼¼çš„æ–‡ä»¶rm -rf .*\n","categories":["MySQL"]},{"title":"Maxwell åŸºäº Kafka å®ç° MySQL CDC","url":"/posts/8994/","content":"Maxwell Github ä»“åº“\nMaxwell å®˜æ–¹æ–‡æ¡£\nDocker è¿è¡Œ Maxwelldocker run -it --rm --link mysql --link kafka zendesk/maxwell bin/maxwell \\    --user=root \\    --password=123456 \\    --host=mysql \\    --producer=kafka \\    --kafka.bootstrap.servers=127.0.0.1:9092 \\    --kafka_topic=test\n\n","categories":["MySQL"]},{"title":"MySQL Explain","url":"/posts/45366/","content":"1.typeSystemè¡¨æ•°æ®å·²ç»è¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸éœ€è¦è¿›è¡Œç£ç›˜IOçš„SQL\nconst\nå‘½ä¸­ä¸»é”®æˆ–è€…å”¯ä¸€ç´¢å¼•\nåˆ¤æ–­æ¡ä»¶ä¸ºå¸¸é‡å€¼\n\nç¤ºä¾‹ï¼šid ä¸ºä¸»é”®\nexplain select * from test where id = 1;\nname ä¸ºå”¯ä¸€ç´¢å¼•\nexplain select * from test where name = &#x27;12&#x27;;\n\neq_refå¯¹äºå‰è¡¨çš„æ¯ä¸€è¡Œï¼Œåè¡¨åªæœ‰ä¸€è¡Œè¢«æ‰«æã€‚å³\n\njoinæŸ¥è¯¢\nè¿æ¥æ—¶å‘½ä¸­ ä¸»é”® æˆ– éç©ºå”¯ä¸€ç´¢å¼•\nç­‰å€¼è¿æ¥\n\nç¤ºä¾‹ï¼štest è¡¨ä¸º eq_ref\nexplain select * from test1 t1 left join test t on t1.test_id = t.id\n\nrefå­—æ®µç´¢å¼•ä¸º éå”¯ä¸€ç´¢å¼• ï¼Œå³åŒä¸€ç´¢å¼•å€¼å¯èƒ½æ‰«æåˆ°å¤šæ¡è®°å½•ã€‚\nç¤ºä¾‹ï¼šname ä¸ºæ™®é€šç´¢å¼•\nexplain select * from test where name = &#x27;12&#x27;;\n\nrangeç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ï¼Œå¦‚ betweenã€inã€&gt;ã€&lt; éƒ½æ˜¯èŒƒå›´æŸ¥è¯¢\nç¤ºä¾‹ï¼šname ä¸ºæ™®é€šç´¢å¼•\nexplain select * from test where name like &quot;12%&quot;;explain select * from test where name != &#x27;12&#x27;;\nid ä¸ºä¸»é”®\nexplain select * from test where id &gt; 1;explain select * from test where id != 1;\n\nindexéœ€è¦æ‰«æ ç´¢å¼• ä¸Šçš„å…¨éƒ¨æ•°æ®ï¼Œä¾‹å¦‚ select count(*) from user;\nallæ²¡æœ‰ç´¢å¼•æˆ–ç´¢å¼•å¤±æ•ˆï¼Œå…¨è¡¨æ‰«æã€‚\nç¤ºä¾‹ï¼šname ä¸ºæ™®é€šç´¢å¼•\nexplain select * from test where name like &quot;%12&quot;;\n\nid ä¸æ˜¯ä¸»é”®ï¼Œæ— ä»»ä½•ç´¢å¼•\nexplain select * from user where id = 1;","categories":["MySQL"]},{"title":"MySQL MVCC","url":"/posts/9873/","content":"Mysql æœ‰ è¯»æœªæäº¤ï¼ˆRUï¼‰ã€è¯»å·²æäº¤ï¼ˆRCï¼‰ã€å¯é‡å¤è¯»ï¼ˆRRï¼‰ã€åºåˆ—åŒ–ï¼Œå››ç§éš”ç¦»çº§åˆ«ï¼ŒMVCCå¯ä»¥ä½œç”¨åœ¨ è¯»å·²æäº¤ å’Œ å¯é‡å¤è¯» ä¸¤ç§éš”ç¦»çº§åˆ«ä¸Šï¼ŒåŒæ—¶åœ¨ å¯é‡å¤è¯» çº§åˆ«ä¸Šè§£å†³äº†å¹»è¯»ã€‚\n1.éšè—å­—æ®µåœ¨æ¯ä¸€è¡Œæ•°æ®ä¸­ï¼Œä¼šæœ‰ä¸‰ä¸ªéšè—å­—æ®µ db_row_idã€data_trx_idã€data_roll_ptrã€‚\n\ndb_row_idï¼šåœ¨æ²¡æœ‰è®¾ç½®ä¸»é”®ï¼Œæ²¡æœ‰å”¯ä¸€ç´¢å¼•çš„æƒ…å†µä¸‹ä½œä¸ºéšè—è¡Œå·ï¼Œå®ç°ç´¢å¼•çš„ï¼›\n\ndata_trx_idï¼šæœ€è¿‘ä¸€æ¬¡å¯¹è¯¥è¡Œæ›´æ–°çš„äº‹åŠ¡çš„idï¼›\n\ndata_roll_ptrï¼šå›æ»šæŒ‡é’ˆï¼ŒæŒ‡å‘å…¶ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ undo logã€‚\n\n\nå½“å¯¹ä¸€æ¡æ•°æ®æ›´æ–°åï¼Œä¼šå°†å…¶åŸæœ¬çš„æ•°æ®ç”Ÿæˆä¸€æ¡ undo logï¼Œç„¶åå°† DATA_ROLL_PTR æŒ‡å‘è¯¥ undo log ï¼Œå½¢æˆä¸€æ¡ç‰ˆæœ¬é“¾ï¼Œæ–¹ä¾¿å›æ»šå’ŒMVCC æŸ¥æ‰¾å¯è®¿é—®çš„æ•°æ®ç‰ˆæœ¬ã€‚\n2.ReadViewåœ¨ ReadView ä¸­æœ‰ä»¥ä¸‹å››ä¸ªä¸»è¦å±æ€§ï¼š\n\nmIdsï¼šç”Ÿæˆ ReadView æ—¶ï¼Œæ‰€æœ‰æ­£åœ¨æ´»è·ƒï¼ˆæœªæäº¤çš„ï¼‰çš„äº‹åŠ¡idï¼›\nmin_trx_idï¼šmIds ä¸­æœ€å°çš„äº‹åŠ¡idï¼›\nmax_trx_idï¼šç”Ÿæˆ ReadView æ—¶ï¼Œæœ€å¤§çš„äº‹åŠ¡idï¼Œæ³¨æ„ ä¸æ˜¯æ­£åœ¨æ´»è·ƒçš„æœ€å¤§äº‹åŠ¡idï¼ˆæˆ–è€…è¯´mIdsä¸­çš„æœ€å¤§idï¼‰ã€‚å› ä¸ºå…ˆæäº¤çš„äº‹åŠ¡ä¸ä¸€å®šå…ˆç»“æŸï¼Œå¯èƒ½å½“å‰æœ€å¤§äº‹åŠ¡idä¸º100ï¼Œè€Œ mIds ä¸­æœ€å¤§çš„äº‹åŠ¡idæ˜¯98ï¼Œä¹Ÿå°±æ˜¯è¯´idä¸º98çš„äº‹åŠ¡è¿˜æœªæäº¤ï¼Œè€Œidä¸º99å’Œ100çš„äº‹åŠ¡å·²ç»æäº¤äº†ï¼›\ncreator_trx_idï¼šåˆ›å»ºè¯¥ ReadView çš„äº‹åŠ¡idã€‚\n\nä¸¾ä¸ªæ —å­ï¼š\nå¦‚æœ mIds = &#123;5, 6, 7, 11, 13&#125;ï¼Œé‚£ä¹ˆ min_trx_id = 5ï¼Œmax_trx_id &gt; 13 æˆ– max_trx_id = 13ã€‚\nåœ¨ RC çº§åˆ«ï¼ŒMVCC ä¼šåœ¨æ¯æ¬¡è¯»æ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ ReadViewï¼›\nåœ¨ RR çº§åˆ«ï¼ŒMVCC åªä¼šåœ¨ç¬¬ä¸€æ¬¡è¯»æ—¶ç”Ÿæˆ ReadViewï¼Œå½“å‰äº‹åŠ¡ä¹‹åéƒ½ä½¿ç”¨è¿™åŒä¸€ä¸ª ReadViewã€‚\n3.è®¿é—®è§„åˆ™\nå¦‚æœ data_trx_id å°äº min_trx_id ï¼Œè¯´æ˜ç”Ÿæˆå½“å‰ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨ç”Ÿæˆ ReadView ä¹‹å‰å°±å·²ç»æäº¤äº†ï¼Œé‚£ä¹ˆå½“å‰äº‹åŠ¡å¯ä»¥è®¿é—®è¯¥ç‰ˆæœ¬æ•°æ®ã€‚\nå¦‚æœ data_trx_id å¤§äº max_trx_id è¯´æ˜å½“å‰ç‰ˆæœ¬çš„æ•°æ®æ˜¯åœ¨ç”Ÿæˆ ReadView ä¹‹åæ‰ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å½“å‰äº‹åŠ¡ä¸å¯è®¿é—®è¯¥ç‰ˆæœ¬æ•°æ®ã€‚\nå¦‚æœ data_trx_id åœ¨ mIds ä¸­ï¼Œå³å¤§äºç­‰äº min_trx_id ä¸”å°äºç­‰äº mIds ä¸­çš„æœ€å¤§äº‹åŠ¡idï¼ˆæ³¨æ„ä¸æ˜¯ max_trx_idï¼‰ï¼Œè¯´æ˜åˆ›å»ºè¯¥ ReadView æ—¶ï¼Œç”Ÿæˆè¯¥ç‰ˆæœ¬æ•°æ®çš„äº‹åŠ¡è¿˜æœªæäº¤ï¼Œæ‰€ä»¥ä¸èƒ½è®¿é—®ã€‚\nå¦‚æœ data_trx_id å¤§äº  mIds ä¸­çš„æœ€å¤§äº‹åŠ¡idä¸”å°äºç­‰äº max_trx_id ï¼Œè¯´æ˜åˆ›å»ºè¯¥ ReadView æ—¶ï¼Œç”Ÿæˆè¯¥ç‰ˆæœ¬æ•°æ®çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œæ‰€ä»¥å¯ä»¥è®¿é—®ã€‚\n\nå½“å‘ç°å½“å‰ç‰ˆæœ¬æ•°æ®æ— æ³•è®¿é—®æ—¶ï¼Œå¯ä»¥é€šè¿‡ data_roll_ptr å¯¹ undo log è¿›è¡Œéå†ï¼Œæ ¹æ®ä»¥ä¸Šè§„åˆ™æ‰¾åˆ°å¯ä»¥è®¿é—®çš„æ•°æ®ç‰ˆæœ¬ã€‚\n","categories":["MySQL"]},{"title":"Mysql Buffer Poolè¯¦è§£","url":"/posts/17417/","content":"ä¸€ã€å‰è¨€1. buffer poolæ˜¯ä»€ä¹ˆã€€ã€€å’±ä»¬åœ¨ä½¿ç”¨mysqlçš„æ—¶å€™ï¼Œæ¯”å¦‚å¾ˆç®€å•çš„select * from table;è¿™æ¡è¯­å¥ï¼Œå…·ä½“æŸ¥è¯¢æ•°æ®å…¶å®æ˜¯åœ¨å­˜å‚¨å¼•æ“ä¸­å®ç°çš„ï¼Œå¤§å®¶éƒ½çŸ¥é“mysqlæ•°æ®å…¶å®æ˜¯æ”¾åœ¨ç£ç›˜é‡Œé¢çš„ï¼Œå¦‚æœæ¯æ¬¡æŸ¥è¯¢éƒ½ç›´æ¥ä»ç£ç›˜é‡Œé¢æŸ¥è¯¢ï¼Œè¿™æ ·åŠ¿å¿…ä¼šå¾ˆå½±å“æ€§èƒ½ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯å…ˆæŠŠæ•°æ®ä»ç£ç›˜ä¸­å–å‡ºï¼Œç„¶åæ”¾åœ¨å†…å­˜ä¸­ï¼Œä¸‹æ¬¡æŸ¥è¯¢ç›´æ¥ä»å†…å­˜ä¸­æ¥å–ã€‚ä½†æ˜¯ä¸€å°æœºå™¨ä¸­å¾€å¾€ä¸æ˜¯åªæœ‰mysqlä¸€ä¸ªè¿›ç¨‹åœ¨è¿è¡Œçš„ï¼Œå¾ˆå¤šä¸ªè¿›ç¨‹éƒ½éœ€è¦ä½¿ç”¨å†…å­˜ï¼Œæ‰€ä»¥mysqlä¸­ä¼šæœ‰ä¸€ä¸ªä¸“é—¨çš„åŒºåŸŸæ¥å¤„ç†è¿™äº›æ•°æ®ï¼Œè¿™ä¸ªä¸“é—¨ä¸ºmysqlå‡†å¤‡çš„åŒºåŸŸï¼Œå°±å«buffer poolã€‚\nbuffer poolæ˜¯mysqlä¸€ä¸ªéå¸¸å…³é”®çš„æ ¸å¿ƒç»„ä»¶ã€‚æ•°æ®åº“ä¸­çš„æ•°æ®å®é™…ä¸Šæœ€ç»ˆéƒ½æ˜¯è¦å­˜æ”¾åœ¨ç£ç›˜æ–‡ä»¶ä¸Šçš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\n\nã€€ã€€ä½†æ˜¯æˆ‘ä»¬åœ¨å¯¹æ•°æ®åº“æ‰§è¡Œå¢åˆ æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¸å¯èƒ½ç›´æ¥æ›´æ–°ç£ç›˜ä¸Šçš„æ•°æ®çš„ï¼Œå› ä¸ºå¦‚æœä½ å¯¹ç£ç›˜è¿›è¡Œéšæœºè¯»å†™æ“ä½œï¼Œé‚£é€Ÿåº¦æ˜¯ç›¸å½“çš„æ…¢ï¼Œéšä¾¿ä¸€ä¸ªå¤§ç£ç›˜æ–‡ä»¶çš„éšæœºè¯»å†™æ“ä½œï¼Œå¯èƒ½éƒ½è¦å‡ ç™¾æ¯«ç§’ã€‚å¦‚æœè¦æ˜¯é‚£ä¹ˆæçš„è¯ï¼Œå¯èƒ½ä½ çš„æ•°æ®åº“æ¯ç§’ä¹Ÿå°±åªèƒ½å¤„ç†å‡ ç™¾ä¸ªè¯·æ±‚äº†ï¼ åœ¨å¯¹æ•°æ®åº“æ‰§è¡Œå¢åˆ æ”¹æ“ä½œçš„æ—¶å€™ï¼Œå®é™…ä¸Šä¸»è¦éƒ½æ˜¯é’ˆå¯¹å†…å­˜é‡Œçš„Buffer Poolä¸­çš„æ•°æ®è¿›è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯å®é™…ä¸Šä¸»è¦æ˜¯å¯¹æ•°æ®åº“çš„å†…å­˜é‡Œçš„æ•°æ®ç»“æ„è¿›è¡Œäº†å¢åˆ æ”¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º\n\nã€€ã€€å…¶å®æ¯ä¸ªäººéƒ½æ‹…å¿ƒä¸€ä¸ªäº‹ï¼Œå°±æ˜¯ä½ åœ¨æ•°æ®åº“çš„å†…å­˜é‡Œæ‰§è¡Œäº†ä¸€å †å¢åˆ æ”¹çš„æ“ä½œï¼Œå†…å­˜æ•°æ®æ˜¯æ›´æ–°äº†ï¼Œä½†æ˜¯è¿™ä¸ªæ—¶å€™å¦‚æœæ•°æ®åº“çªç„¶å´©æºƒäº†ï¼Œé‚£ä¹ˆå†…å­˜é‡Œæ›´æ–°å¥½çš„æ•°æ®ä¸æ˜¯éƒ½æ²¡äº†å—ï¼Ÿ MySQLå°±æ€•è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥å¼•å…¥äº†ä¸€ä¸ªredo logæœºåˆ¶ï¼Œä½ åœ¨å¯¹å†…å­˜é‡Œçš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹çš„æ—¶å€™ï¼Œä»–åŒæ—¶ä¼šæŠŠå¢åˆ æ”¹å¯¹åº”çš„æ—¥å¿—å†™å…¥redo logä¸­ï¼Œå¦‚ä¸‹å›¾\n\nã€€ã€€ä¸‡ä¸€ä½ çš„æ•°æ®åº“çªç„¶å´©æºƒäº†ï¼Œæ²¡å…³ç³»ï¼Œåªè¦ä»redo logæ—¥å¿—æ–‡ä»¶é‡Œè¯»å–å‡ºæ¥ä½ ä¹‹å‰åšè¿‡å“ªäº›å¢åˆ æ”¹æ“ä½œï¼Œç¬é—´å°±å¯ä»¥é‡æ–°æŠŠè¿™äº›å¢åˆ æ”¹æ“ä½œåœ¨ä½ çš„å†…å­˜é‡Œæ‰§è¡Œä¸€éï¼Œè¿™å°±å¯ä»¥æ¢å¤å‡ºæ¥ä½ ä¹‹å‰åšè¿‡å“ªäº›å¢åˆ æ”¹æ“ä½œäº†ã€‚ å½“ç„¶å¯¹äºæ•°æ®æ›´æ–°çš„è¿‡ç¨‹ï¼Œä»–æ˜¯æœ‰ä¸€å¥—ä¸¥å¯†çš„æ­¥éª¤çš„ï¼Œè¿˜æ¶‰åŠåˆ°undo logã€binlogã€æäº¤äº‹åŠ¡ã€buffer poolè„æ•°æ®åˆ·å›ç£ç›˜ï¼Œç­‰ç­‰ã€‚\n\nã€€ã€€Buffer Poolå°±æ˜¯æ•°æ®åº“çš„ä¸€ä¸ªå†…å­˜ç»„ä»¶ï¼Œé‡Œé¢ç¼“å­˜äº†ç£ç›˜ä¸Šçš„çœŸå®æ•°æ®ï¼Œç„¶åæˆ‘ä»¬çš„ç³»ç»Ÿå¯¹æ•°æ®åº“æ‰§è¡Œçš„å¢åˆ æ”¹æ“ä½œï¼Œå…¶å®ä¸»è¦å°±æ˜¯å¯¹è¿™ä¸ªå†…å­˜æ•°æ®ç»“æ„ä¸­çš„ç¼“å­˜æ•°æ®æ‰§è¡Œçš„ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä¿è¯æ¯ä¸ªæ›´æ–°è¯·æ±‚ï¼Œå°½é‡å°±æ˜¯åªæ›´æ–°å†…å­˜ï¼Œç„¶åå¾€ç£ç›˜é¡ºåºå†™æ—¥å¿—æ–‡ä»¶ã€‚\næ›´æ–°å†…å­˜çš„æ€§èƒ½æ˜¯æé«˜çš„ï¼Œç„¶åé¡ºåºå†™ç£ç›˜ä¸Šçš„æ—¥å¿—æ–‡ä»¶çš„æ€§èƒ½ä¹Ÿæ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå› ä¸ºé¡ºåºå†™ç£ç›˜æ–‡ä»¶ï¼Œä»–çš„æ€§èƒ½è¦è¿œé«˜äºéšæœºè¯»å†™ç£ç›˜æ–‡ä»¶ã€‚\n\n2. buffer poolçš„å·¥ä½œæµç¨‹\nå’±ä»¬ä»¥æŸ¥è¯¢è¯­å¥ä¸ºä¾‹\n1:åœ¨æŸ¥è¯¢çš„æ—¶å€™ä¼šå…ˆå»buffer pool(å†…å­˜)ä¸­çœ‹çœ‹æœ‰æ²¡æœ‰å¯¹åº”çš„æ•°æ®é¡µï¼Œå¦‚æœæœ‰çš„è¯ç›´æ¥è¿”å›\n2:å¦‚æœbuffer poolä¸­æ²¡æœ‰å¯¹åº”çš„æ•°æ®é¡µï¼Œåˆ™ä¼šå»ç£ç›˜ä¸­æŸ¥æ‰¾ï¼Œç£ç›˜ä¸­å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„æ•°æ®ï¼Œåˆ™ä¼šæŠŠè¯¥é¡µçš„æ•°æ®ç›´æ¥copyä¸€ä»½åˆ°buffer poolä¸­è¿”å›ç»™å®¢æˆ·ç«¯\n3:ä¸‹æ¬¡æœ‰åŒæ ·çš„æŸ¥è¯¢è¿›æ¥ç›´æ¥æŸ¥æ‰¾buffer poolæ‰¾åˆ°å¯¹åº”çš„æ•°æ®è¿”å›å³å¯ã€‚\nå¤§å®¶çœ‹åˆ°è¿™é‡Œç›¸ä¿¡åº”è¯¥å¯¹buffer poolæœ‰äº†ä¸ªå¤§æ¦‚çš„è®¤è¯†ï¼Œæœ‰æ²¡æœ‰æ„Ÿè§‰æœ‰ç‚¹ç¼“å­˜çš„æ„Ÿè§‰ï¼Œå½“ç„¶buffer poolå¯æ²¡æœ‰ç¼“å­˜é‚£ä¹ˆç®€å•ï¼Œå†…éƒ¨ç»“æ„è¿˜æ˜¯æ¯”è¾ƒå¤æ‚çš„ï¼Œä¸è¿‡æ²¡å…³ç³»ï¼Œå’±ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚\n3. buffer poolç¼“å†²æ± å’ŒæŸ¥è¯¢ç¼“å­˜(query cache)åœ¨æ­£å¼è®²è§£buffer pool ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆææ¸…æ¥šbuffer poolç¼“å†²æ± å’ŒæŸ¥è¯¢ç¼“å­˜(query cache)ç®€ç§°Qcacheçš„åŒºåˆ«ã€‚\nå¦‚æœå°†Mysqlåˆ†ä¸ºServerå±‚å’Œå­˜å‚¨å¼•æ“å±‚ä¸¤å¤§éƒ¨åˆ†ï¼Œé‚£ä¹ˆQcacheä½äºServerå±‚ï¼ŒBuffer Poolä½äºå­˜å‚¨å¼•æ“å±‚ã€‚\nã€€ã€€å¦‚æœä½ çš„Mysql æŸ¥è¯¢ç¼“å­˜åŠŸèƒ½æ˜¯æ‰“å¼€çš„ï¼Œé‚£ä¹ˆå½“ä¸€ä¸ªsqlè¿›å…¥Mysql Serverä¹‹åï¼ŒMysql Serveré¦–å…ˆä¼šä»æŸ¥è¯¢ç¼“å­˜ä¸­æŸ¥çœ‹æ˜¯å¦æ›¾ç»æ‰§è¡Œè¿‡è¿™ä¸ªSQLï¼Œå¦‚æœæ›¾ç»æ‰§è¡Œè¿‡çš„è¯ï¼Œæ›¾ç»æ‰§è¡Œçš„æŸ¥è¯¢ç»“æœä¹‹å‰ä¼šä»¥key-valueçš„å½¢å¼ä¿å­˜åœ¨æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚keyæ˜¯sqlè¯­å¥ï¼Œvalueæ˜¯æŸ¥è¯¢ç»“æœã€‚æˆ‘ä»¬å°†è¿™ä¸ªè¿‡ç¨‹ç§°ä¸ºæŸ¥è¯¢ç¼“å­˜ï¼\nã€€ã€€å¦‚æœæŸ¥è¯¢ç¼“å­˜ä¸­æ²¡æœ‰ä½ è¦æ‰¾çš„æ•°æ®çš„è¯ï¼ŒMySQLæ‰ä¼šæ‰§è¡Œåç»­çš„é€»è¾‘ï¼Œé€šè¿‡å­˜å‚¨å¼•æ“å°†æ•°æ®æ£€ç´¢å‡ºæ¥ã€‚å¹¶ä¸”æŸ¥è¯¢ç¼“å­˜ä¼šè¢«shared cache for sessionsï¼Œæ˜¯çš„ï¼Œå®ƒä¼šè¢«æ‰€æœ‰çš„sessionå…±äº«ã€‚\nã€€ã€€MySQLæŸ¥è¯¢ç¼“å­˜æ˜¯æŸ¥è¯¢ç»“æœç¼“å­˜ã€‚å®ƒå°†ä»¥SELå¼€å¤´çš„æŸ¥è¯¢ä¸å“ˆå¸Œè¡¨è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™è¿”å›ä¸Šä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœã€‚è¿›è¡ŒåŒ¹é…æ—¶ï¼ŒæŸ¥è¯¢å¿…é¡»é€å­—èŠ‚åŒ¹é…ï¼Œä¾‹å¦‚ SELECT * FROM t1; ä¸ç­‰äºselect * from t1;ï¼Œæ­¤å¤–ï¼Œä¸€äº›ä¸ç¡®å®šçš„æŸ¥è¯¢ç»“æœæ— æ³•è¢«ç¼“å­˜ï¼Œä»»ä½•å¯¹è¡¨çš„ä¿®æ”¹éƒ½ä¼šå¯¼è‡´è¿™äº›è¡¨çš„æ‰€æœ‰ç¼“å­˜æ— æ•ˆ(åªè¦æœ‰ä¸€ä¸ªsql updateäº†è¯¥è¡¨ï¼Œé‚£ä¹ˆè¡¨çš„æŸ¥è¯¢ç¼“å­˜å°±ä¼šå¤±æ•ˆ)ã€‚å› æ­¤ï¼Œé€‚ç”¨äºæŸ¥è¯¢ç¼“å­˜çš„æœ€ç†æƒ³çš„æ–¹æ¡ˆæ˜¯åªè¯»ï¼Œç‰¹åˆ«æ˜¯éœ€è¦æ£€æŸ¥æ•°ç™¾ä¸‡è¡Œåä»…è¿”å›æ•°è¡Œçš„å¤æ‚æŸ¥è¯¢ã€‚å¦‚æœä½ çš„æŸ¥è¯¢ç¬¦åˆè¿™æ ·ä¸€ä¸ªç‰¹ç‚¹ï¼Œå¼€å¯æŸ¥è¯¢ç¼“å­˜ä¼šæå‡ä½ çš„æŸ¥è¯¢æ€§èƒ½ã€‚\nã€€ã€€MySQLæŸ¥è¯¢ç¼“å­˜çš„ç›®çš„æ˜¯ä¸ºäº†æå‡æŸ¥è¯¢æ€§èƒ½ï¼Œä½†å®ƒæœ¬èº«ä¹Ÿæ˜¯æœ‰æ€§èƒ½å¼€é”€çš„ã€‚éœ€è¦åœ¨åˆé€‚çš„ä¸šåŠ¡åœºæ™¯ä¸‹ï¼ˆè¯»å†™å‹åŠ›æ¨¡å‹ï¼‰ä½¿ç”¨ï¼Œä¸åˆé€‚çš„ä¸šåŠ¡åœºæ™¯ä¸ä½†ä¸èƒ½æå‡æŸ¥è¯¢æ€§èƒ½ï¼ŒæŸ¥è¯¢ç¼“å­˜åè€Œä¼šå˜æˆMySQLçš„ç“¶é¢ˆã€‚\næŸ¥è¯¢ç¼“å­˜çš„å¼€é”€ä¸»è¦æœ‰ï¼š\n\nè¯»æŸ¥è¯¢åœ¨å¼€å§‹å‰å¿…é¡»å…ˆæ£€æŸ¥æ˜¯å¦å‘½ä¸­ç¼“å­˜ï¼›\nå¦‚æœè¿™ä¸ªè¯»æŸ¥è¯¢å¯ä»¥è¢«ç¼“å­˜ï¼Œé‚£ä¹ˆå½“å®Œæˆæ‰§è¡Œåï¼ŒMySQLè‹¥å‘ç°æŸ¥è¯¢ç¼“å­˜ä¸­æ²¡æœ‰è¿™ä¸ªæŸ¥è¯¢ï¼Œä¼šå°†å…¶ç»“æœå­˜å…¥æŸ¥è¯¢ç¼“å­˜ï¼Œè¿™ä¼šå¸¦æ¥é¢å¤–çš„ç³»ç»Ÿæ¶ˆè€—ï¼›\nå½“å‘æŸä¸ªè¡¨å†™å…¥æ•°æ®çš„æ—¶å€™ï¼ŒMySQLå¿…é¡»å°†å¯¹åº”è¡¨çš„æ‰€æœ‰ç¼“å­˜éƒ½è®¾ç½®å¤±æ•ˆã€‚å¦‚æœæŸ¥è¯¢ç¼“å­˜éå¸¸å¤§æˆ–è€…ç¢ç‰‡å¾ˆå¤šï¼Œè¿™ä¸ªæ“ä½œå°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„ç³»ç»Ÿæ¶ˆè€—ã€‚\n\næŸ¥è¯¢ç¼“å­˜çš„ç¼ºç‚¹ï¼š\nã€€ã€€é¦–å…ˆï¼ŒæŸ¥è¯¢ç¼“å­˜çš„æ•ˆæœå–å†³äºç¼“å­˜çš„å‘½ä¸­ç‡ï¼Œåªæœ‰å‘½ä¸­ç¼“å­˜çš„æŸ¥è¯¢æ•ˆæœæ‰èƒ½æœ‰æ”¹å–„ï¼Œå› æ­¤æ— æ³•é¢„æµ‹å…¶æ€§èƒ½ã€‚åªè¦æœ‰ä¸€ä¸ªsql updateäº†è¯¥è¡¨ï¼Œé‚£ä¹ˆè¡¨çš„æŸ¥è¯¢ç¼“å­˜å°±ä¼šå¤±æ•ˆï¼Œæ‰€ä»¥å½“ä½ çš„ä¸šåŠ¡å¯¹è¡¨CRUDçš„æ¯”ä¾‹ä¸ç›¸ä¸Šä¸‹ï¼Œé‚£ä¹ˆæŸ¥è¯¢ç¼“å­˜may beä¼šå½±å“åº”ç”¨çš„ååæ•ˆç‡ã€‚\nã€€ã€€å…¶æ¬¡ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å¦ä¸€ä¸ªå¤§é—®é¢˜æ˜¯å®ƒå—åˆ°å•ä¸ªäº’æ–¥é”çš„ä¿æŠ¤ã€‚åœ¨å…·æœ‰å¤šä¸ªå†…æ ¸çš„æœåŠ¡å™¨ä¸Šï¼Œå¤§é‡æŸ¥è¯¢ä¼šå¯¼è‡´å¤§é‡çš„äº’æ–¥é”äº‰ç”¨ã€‚\nåœ¨mysql8.0çš„ç‰ˆæœ¬ä¸­ï¼Œå·²ç»å°†æŸ¥è¯¢ç¼“å­˜æ¨¡å—åˆ é™¤äº†ã€‚\näºŒã€buffer poolçš„å†…å­˜æ•°æ®ç»“æ„1. æ•°æ®é¡µæ¦‚å¿µæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸‹æ•°æ®é¡µè¿™ä¸ªæ¦‚å¿µã€‚å®ƒæ˜¯ MySQL æŠ½è±¡å‡ºæ¥çš„æ•°æ®å•ä½ï¼Œç£ç›˜æ–‡ä»¶ä¸­å°±æ˜¯å­˜æ”¾äº†å¾ˆå¤šæ•°æ®é¡µï¼Œæ¯ä¸ªæ•°æ®é¡µé‡Œå­˜æ”¾äº†å¾ˆå¤šè¡Œæ•°æ®ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®é¡µçš„å¤§å°æ˜¯ 16kbã€‚\næ‰€ä»¥å¯¹åº”çš„ï¼Œåœ¨ Buffer Pool ä¸­ï¼Œä¹Ÿæ˜¯ä»¥æ•°æ®é¡µä¸ºæ•°æ®å•ä½ï¼Œå­˜æ”¾ç€å¾ˆå¤šæ•°æ®ã€‚ä½†æ˜¯æˆ‘ä»¬é€šå¸¸å«åšç¼“å­˜é¡µï¼Œå› ä¸º Buffer Pool æ¯•ç«Ÿæ˜¯ä¸€ä¸ªç¼“å†²æ± ï¼Œå¹¶ä¸”é‡Œé¢çš„æ•°æ®éƒ½æ˜¯ä»ç£ç›˜æ–‡ä»¶ä¸­ç¼“å­˜åˆ°å†…å­˜ä¸­ã€‚\næ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ç¼“å­˜é¡µçš„å¤§å°ä¹Ÿæ˜¯ 16kbï¼Œå› ä¸ºå®ƒå’Œç£ç›˜æ–‡ä»¶ä¸­æ•°æ®é¡µæ˜¯ä¸€ä¸€å¯¹åº”çš„ã€‚\næ‰€ä»¥ï¼Œç¼“å†²æ± å’Œç£ç›˜ä¹‹é—´çš„æ•°æ®äº¤æ¢çš„å•ä½æ˜¯æ•°æ®é¡µï¼ŒBuffer Poolä¸­å­˜æ”¾çš„æ˜¯ä¸€ä¸ªä¸€ä¸ªçš„æ•°æ®é¡µã€‚\nå‡è®¾æˆ‘ä»¬è¦æ›´æ–°ä¸€è¡Œæ•°æ®ï¼Œæ­¤æ—¶æ•°æ®åº“ä¼šæ‰¾åˆ°è¿™è¡Œæ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µï¼Œç„¶åä»ç£ç›˜æ–‡ä»¶é‡ŒæŠŠè¿™è¡Œæ•°æ®æ‰€åœ¨çš„æ•°æ®é¡µç›´æ¥ç»™åŠ è½½åˆ°Buffer Poolé‡Œå»ã€‚å¦‚ä¸‹å›¾ã€‚\n\n2. é‚£ä¹ˆæ€ä¹ˆè¯†åˆ«æ•°æ®åœ¨å“ªä¸ªç¼“å­˜é¡µä¸­æ¯ä¸ªç¼“å­˜é¡µéƒ½ä¼šå¯¹åº”ç€ä¸€ä¸ªæè¿°æ•°æ®å—ï¼Œé‡Œé¢åŒ…å«æ•°æ®é¡µæ‰€å±çš„è¡¨ç©ºé—´ã€æ•°æ®é¡µçš„ç¼–å·ï¼Œç¼“å­˜é¡µåœ¨ Buffer Pool ä¸­çš„åœ°å€ç­‰ç­‰ã€‚\næè¿°æ•°æ®å—æœ¬èº«ä¹Ÿæ˜¯ä¸€å—æ•°æ®ï¼Œå®ƒçš„å¤§å°å¤§æ¦‚æ˜¯ç¼“å­˜é¡µå¤§å°çš„5%å·¦å³ï¼Œå¤§æ¦‚800ä¸ªå­—èŠ‚å·¦å³çš„å¤§å°ã€‚ç„¶åå‡è®¾ä½ è®¾ç½®çš„buffer poolå¤§å°æ˜¯128MBï¼Œå®é™…ä¸ŠBuffer PoolçœŸæ­£çš„æœ€ç»ˆå¤§å°ä¼šè¶…å‡ºä¸€äº›ï¼Œå¯èƒ½æœ‰ä¸ª130å¤šMBçš„æ ·å­ï¼Œå› ä¸ºä»–é‡Œé¢è¿˜è¦å­˜æ”¾æ¯ä¸ªç¼“å­˜é¡µçš„æè¿°æ•°æ®ã€‚\nåœ¨Buffer Poolä¸­ï¼Œæ¯ä¸ªç¼“å­˜é¡µçš„æè¿°æ•°æ®æ”¾åœ¨æœ€å‰é¢ï¼Œç„¶åå„ä¸ªç¼“å­˜é¡µæ”¾åœ¨åé¢ã€‚æ‰€ä»¥æ­¤æ—¶æˆ‘ä»¬çœ‹ä¸‹é¢çš„å›¾ï¼ŒBuffer Poolå®é™…çœ‹èµ·æ¥å¤§æ¦‚é•¿è¿™ä¸ªæ ·å­ ã€‚\n\n3. buffer poolçš„åˆå§‹åŒ–ä¸é…ç½®MySQL å¯åŠ¨æ—¶ï¼Œæ˜¯å¦‚ä½•åˆå§‹åŒ– Buffer Pool çš„å‘¢ï¼Ÿ\n1ã€MySQL å¯åŠ¨æ—¶ï¼Œä¼šæ ¹æ®å‚æ•° innodb_buffer_pool_size çš„å€¼æ¥ä¸º Buffer Pool åˆ†é…å†…å­˜åŒºåŸŸã€‚\n2ã€ç„¶åä¼šæŒ‰ç…§ç¼“å­˜é¡µçš„é»˜è®¤å¤§å° 16k ä»¥åŠå¯¹åº”çš„æè¿°æ•°æ®å—çš„ 800ä¸ªå­—èŠ‚ å·¦å³å¤§å°ï¼Œåœ¨ Buffer Pool ä¸­åˆ’åˆ†ä¸­ä¸€ä¸ªä¸ªçš„ç¼“å­˜é¡µå’Œä¸€ä¸ªä¸ªçš„æè¿°æ•°æ®åº“å—ã€‚\n3ã€æ³¨æ„ï¼Œæ­¤æ—¶çš„ç¼“å­˜é¡µå’Œæè¿°æ•°æ®å—éƒ½æ˜¯ç©ºçš„ï¼Œæ¯•ç«Ÿæ‰åˆšå¯åŠ¨ MySQL å‘¢ã€‚\nbuffer poolçš„é…ç½®\nã€€ã€€buffer poolé€šå¸¸ç”±æ•°ä¸ªå†…å­˜å—åŠ ä¸Šä¸€ç»„æ§åˆ¶ç»“æ„ä½“å¯¹è±¡ç»„æˆã€‚å†…å­˜å—çš„ä¸ªæ•°å–å†³äºbuffer pool instanceçš„ä¸ªæ•°ï¼Œä¸è¿‡åœ¨5.7ç‰ˆæœ¬ä¸­å¼€å§‹é»˜è®¤ä»¥128M(å¯é…ç½®)çš„chunkå•ä½åˆ†é…å†…å­˜å—ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æ”¯æŒbuffer poolçš„åœ¨çº¿åŠ¨æ€è°ƒæ•´å¤§å°ã€‚\nã€€ã€€Buffer Poolé»˜è®¤æƒ…å†µä¸‹æ˜¯128MBï¼Œè¿˜æ˜¯æœ‰ä¸€ç‚¹åå°äº†ï¼Œæˆ‘ä»¬å®é™…ç”Ÿäº§ç¯å¢ƒä¸‹å®Œå…¨å¯ä»¥å¯¹Buffer Poolè¿›è¡Œè°ƒæ•´ã€‚ æ¯”å¦‚æˆ‘ä»¬çš„æ•°æ®åº“å¦‚æœæ˜¯16æ ¸32Gçš„æœºå™¨ï¼Œé‚£ä¹ˆä½ å°±å¯ä»¥ç»™Buffer Poolåˆ†é…ä¸ª2GBçš„å†…å­˜ã€‚\n1ã€innodb_buffer_pool_sizeï¼šè¿™ä¸ªå€¼æ˜¯è®¾ç½® InnoDB Buffer Pool çš„æ€»å¤§å°ï¼›\n2ã€innodb_buffer_pool_chunk_sizeï¼šå½“å¢åŠ æˆ–å‡å°‘innodb_buffer_pool_sizeæ—¶ï¼Œæ“ä½œä»¥å—ï¼ˆchunkï¼‰å½¢å¼æ‰§è¡Œã€‚å—å¤§å°ç”±innodb_buffer_pool_chunk_sizeé…ç½®é€‰é¡¹å®šä¹‰ï¼Œé»˜è®¤å€¼128Mã€‚\nè¿™é‡Œé¢æœ‰ä¸ªå…³ç³»è¦ç¡®å®šä¸€ä¸‹ï¼Œæœ€å¥½æŒ‰ç…§è¿™ä¸ªè®¾ç½® innodb_buffer_pool_size=innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances*Nï¼ˆN&gt;=1ï¼‰;\n3ã€innodb_buffer_pool_instancesï¼šè®¾ç½® InnoDB Buffer Pool å®ä¾‹çš„ä¸ªæ•°ï¼Œæ¯ä¸€ä¸ªå®ä¾‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ list ç®¡ç†Buffer Poolï¼›\nã€€ã€€å½“buffer poolæ¯”è¾ƒå¤§çš„æ—¶å€™ï¼ˆè¶…è¿‡1Gï¼‰ï¼Œinnodbä¼šæŠŠbuffer poolåˆ’åˆ†æˆå‡ ä¸ªinstancesï¼Œè¿™æ ·å¯ä»¥æé«˜è¯»å†™æ“ä½œçš„å¹¶å‘ï¼Œå‡å°‘ç«äº‰ã€‚è¯»å†™pageéƒ½ä½¿ç”¨hashå‡½æ•°åˆ†é…ç»™ä¸€ä¸ªinstancesã€‚\nã€€ã€€å½“å¢åŠ æˆ–è€…å‡å°‘buffer poolå¤§å°çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯æ“ä½œçš„chunkã€‚buffer poolçš„å¤§å°å¿…é¡»æ˜¯innodb_buffer_pool_chunk_sizeinnodb_buffer_pool_instancesçš„æ•´æ•°å€ï¼Œå¦‚æœé…ç½®çš„innodb_buffer_pool_sizeä¸æ˜¯innodb_buffer_pool_chunk_sizeinnodb_buffer_pool_instancesçš„å€æ•°ï¼Œbuffer poolçš„å¤§å°ä¼šè‡ªåŠ¨è°ƒæ•´ä¸ºinnodb_buffer_pool_chunk_size*innodb_buffer_pool_instancesçš„å€æ•°ï¼Œè‡ªåŠ¨è°ƒæ•´çš„å€¼ä¸å°‘äºæŒ‡å®šçš„å€¼ã€‚å¦‚æœæŒ‡å®šçš„bufferå¤§å°æ˜¯9Gï¼Œinstancesçš„ä¸ªæ•°æ˜¯16ï¼Œchunké»˜è®¤çš„å¤§å°æ˜¯128Mï¼Œé‚£ä¹ˆbufferä¼šè‡ªåŠ¨è°ƒæ•´ä¸º10Gã€‚4ã€innodb_old_blocks_pctï¼šé»˜è®¤ InnoDB Buffer Pool ä¸­ç‚¹çš„ä½ç½®ï¼Œé»˜è®¤å€¼æ˜¯37ï¼Œæœ€å¤§100ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è°“çš„3/8çš„ä½ç½®ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®ã€‚\n1ï¼‰Buffer Pool Size è®¾ç½®å’Œç”Ÿæ•ˆè¿‡ç¨‹ã€€ã€€ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨ç»™æœåŠ¡å™¨çš„å…¶ä»–è¿›ç¨‹ç•™ä¸‹è¶³å¤Ÿçš„å†…å­˜ç©ºé—´çš„æƒ…å†µä¸‹ï¼ŒBuffer Pool Size åº”è¯¥è®¾ç½®çš„å°½å¯èƒ½å¤§ã€‚å½“ Buffer Pool Size è®¾ç½®çš„è¶³å¤Ÿå¤§æ—¶ï¼Œæ•´ä¸ªæ•°æ®åº“å°±ç›¸å½“äºå­˜å‚¨åœ¨å†…å­˜å½“ä¸­ï¼Œå½“è¯»å–ä¸€æ¬¡æ•°æ®åˆ° Buffer Pool Size ä»¥åï¼Œåç»­çš„è¯»æ“ä½œå°±ä¸ç”¨å†è®¿é—®ç£ç›˜ã€‚\nä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ Buffer Pool Size çš„è®¾ç½®æ–¹å¼ï¼š\nå½“æ•°æ®åº“å·²ç»å¯åŠ¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨çº¿è°ƒæ•´çš„æ–¹å¼ä¿®æ”¹ Buffer Pool Size çš„å¤§å°ã€‚é€šè¿‡ä»¥ä¸‹è¯­å¥ï¼š\nSET GLOBAL innodb_buffer_pool_size=402653184;\n\nå½“æ‰§è¡Œè¿™ä¸ªè¯­å¥ä»¥åï¼Œå¹¶ä¸ä¼šç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ˜¯è¦ç­‰æ‰€æœ‰çš„äº‹åŠ¡å…¨éƒ¨æ‰§è¡ŒæˆåŠŸä»¥åæ‰ä¼šç”Ÿæ•ˆï¼›æ–°çš„è¿æ¥å’Œäº‹åŠ¡å¿…é¡»ç­‰å…¶ä»–äº‹åŠ¡å®Œå…¨æ‰§è¡ŒæˆåŠŸä»¥åï¼ŒBuffer Pool Size è®¾ç½®ç”Ÿæ•ˆä»¥åæ‰èƒ½å¤Ÿè¿æ¥æˆåŠŸï¼Œä¸ç„¶ä¼šä¸€ç›´å¤„äºç­‰å¾…çŠ¶æ€ã€‚\næœŸé—´ï¼ŒBuffer Pool Size è¦å®Œæˆç¢ç‰‡æ•´ç†ï¼Œå»é™¤ç¼“å­˜ page ç­‰ç­‰æ“ä½œã€‚åœ¨æ‰§è¡Œå¢åŠ æˆ–è€…å‡å°‘ Buffer Pool Size çš„æ“ä½œæ—¶ï¼Œæ“ä½œä¼šä½œä¸ºä¸€ä¸ªæ‰§è¡Œå—æ‰§è¡Œï¼Œinnodb_buffer_pool_chunk_size çš„å¤§å°ä¼šå®šä¹‰ä¸€ä¸ªæ‰§è¡Œå—çš„å¤§å°ï¼Œé»˜è®¤çš„æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯128Mã€‚\nBuffer Pool Size çš„å¤§å°æœ€å¥½è®¾ç½®ä¸º innodb_buffer_pool_chunk_size innodb_buffer_pool_instances çš„æ•´æ•°å€ï¼Œè€Œä¸”æ˜¯å¤§äºç­‰äº1ã€‚\nå¦‚æœä½ çš„æœºå™¨é…ç½®çš„å¤§å°ä¸æ˜¯æ•´æ•°å€çš„è¯ï¼ŒBuffer Pool Size çš„å¤§å°æ˜¯ä¼šè‡ªé€‚åº”ä¿®æ”¹ä¸º innodb_buffer_pool_chunk_sizeinnodb_buffer_pool_instances çš„æ•´æ•°å€ï¼Œä¼šç•¥å°äºä½ é…ç½®çš„ Buffer Pool Size çš„å¤§å°ã€‚\næ¯”å¦‚ä»¥8Gä¸ºä¾‹ï¼š\nmysqld â€“innodb_buffer_pool_size=8G â€“innodb_buffer_pool_instances=16ï¼Œç„¶åinnodb_buffer_pool_instances=16 çš„å¤§å°åˆšå¥½è®¾ç½®ä¸º16ï¼Œæ˜¯ä¸€ä¸ªæ•´æ•°å€çš„å…³ç³»ã€‚è€Œä¸”innodb_buffer_pool_chunk_size çš„å¤§å°ä¹Ÿæ˜¯å¯ä»¥åœ¨my.cnfé‡Œé¢æŒ‡å®šçš„ã€‚\nè¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯ innodb_buffer_pool_chunk_size * innodb_buffer_pool_instances å¤§äº buffer pool size çš„æƒ…å†µä¸‹ï¼Œinnodb_buffer_pool_chunk_size ä¹Ÿä¼šè‡ªé€‚åº”ä¸º Buffer Pool size/innodb_buffer_pool_instancesï¼Œå¯è§MySQL çš„ç®¡ç†è¿˜æ˜¯éå¸¸çš„æ™ºèƒ½çš„ã€‚\nå¦‚æœæˆ‘ä»¬è¦æŸ¥ Buffer Pool çš„çŠ¶æ€çš„è¯ï¼š\nSHOW STATUS WHERE Variable_name=&#x27;InnoDB_buffer_pool_resize_status&#x27;\n\nå¯ä»¥å¸®æˆ‘ä»¬æŸ¥çœ‹åˆ°çŠ¶æ€ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹å¢åŠ  Buffer Pool çš„æ—¶å€™çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå†çœ‹ä¸€ä¸‹å‡å°‘çš„æ—¶å€™çš„æ—¥å¿—ï¼Œå…¶å®è¿˜æ˜¯å¾ˆå¥½ç†è§£çš„ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹æˆæ¯æ¬¡å¢å¤§æˆ–è€…å‡å°‘ Buffer Pool çš„æ—¶å€™å°±æ˜¯è¿›è¡Œ innodb_buffer_pool_chunk çš„å¢åŠ æˆ–è€…é‡Šæ”¾ï¼ŒæŒ‰ç…§ innodb_buffer_pool_chunk_size è®¾å®šå€¼çš„å¤§å°å¢åŠ æˆ–è€…é‡Šæ”¾æ‰§è¡Œå—ã€‚\nå¢åŠ çš„è¿‡ç¨‹ï¼šå¢åŠ æ‰§è¡Œå—ï¼ŒæŒ‡å®šæ–°åœ°å€ï¼Œå°†æ–°åŠ å…¥çš„æ‰§è¡Œå—åŠ å…¥åˆ° free listï¼ˆæ§åˆ¶æ‰§è¡Œå—çš„ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯ä»¥è¿™ä¹ˆç†è§£ï¼‰ã€‚\nå‡å°‘çš„è¿‡ç¨‹ï¼šé‡æ–°æ•´ç† Buffer Pool å’Œç©ºé—²é¡µï¼Œå°†æ•°æ®ä»å—ä¸­ç§»é™¤ï¼ŒæŒ‡å®šæ–°åœ°å€ã€‚\n2ï¼‰Buffer Pool Instancesåœ¨64ä½æ“ä½œç³»ç»Ÿçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ‹†åˆ†ç¼“å†²æ± æˆå¤šä¸ªéƒ¨åˆ†ï¼Œè¿™æ ·å¯ä»¥åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹æœ€å¤§å¯èƒ½çš„å‡å°‘äº‰ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹æ€ä¹ˆé…ç½® Buffer Pool Instancesï¼Ÿ\né…ç½®å¤šä¸ª Buffer Pool Instances èƒ½åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šèƒ½å¤Ÿæé«˜ MySQL åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹å¤„ç†äº‹ç‰©çš„æ€§èƒ½ï¼Œä¼˜åŒ–ä¸åŒè¿æ¥è¯»å–ç¼“å†²é¡µçš„äº‰ç”¨ã€‚\næˆ‘ä»¬å¯ä»¥é€šè¿‡è®¾ç½® innodb_buffer_pool_instances æ¥è®¾ç½® Buffer Pool Instancesã€‚å½“ InnoDB Buffer Pool è¶³å¤Ÿå¤§çš„æ—¶å€™ï¼Œä½ èƒ½å¤Ÿä»å†…å­˜ä¸­è¯»å–æ—¶å€™èƒ½æœ‰ä¸€ä¸ªè¾ƒå¥½çš„æ€§èƒ½ï¼Œä½†æ˜¯ä¹Ÿæœ‰å¯èƒ½ç¢°åˆ°å¤šä¸ªçº¿ç¨‹åŒæ—¶è¯·æ±‚ç¼“å†²æ± çš„ç“¶é¢ˆã€‚è¿™ä¸ªæ—¶å€™è®¾ç½®å¤šä¸ª Buffer Pool Instances èƒ½å¤Ÿå°½é‡å‡å°‘è¿æ¥çš„äº‰ç”¨ã€‚\nè¿™èƒ½å¤Ÿä¿è¯æ¯æ¬¡ä»å†…å­˜è¯»å–çš„é¡µéƒ½å¯¹åº”ä¸€ä¸ª Buffer Pool Instancesï¼Œè€Œä¸”è¿™ç§å¯¹åº”å…³ç³»æ˜¯ä¸€ä¸ªéšæœºçš„å…³ç³»ã€‚å¹¶ä¸æ˜¯çƒ­æ•°æ®å­˜æ”¾åœ¨ä¸€ä¸ª Buffer Pool Instancesä¸‹ï¼Œå†…éƒ¨ä¹Ÿæ˜¯é€šè¿‡ hash ç®—æ³•æ¥å®ç°è¿™ä¸ªéšæœºæ•°çš„ã€‚æ¯ä¸€ä¸ª Buffer Pool Instances éƒ½æœ‰è‡ªå·±çš„ free listsï¼ŒLRU å’Œå…¶ä»–çš„ä¸€äº› Buffer Poll çš„æ•°æ®ç»“æ„ï¼Œå„ä¸ª Buffer Pool Instances æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ã€‚\ninnodb_buffer_pool_instances çš„è®¾ç½®å¿…é¡»å¤§äº1æ‰ç®—å¾—ä¸Šæ˜¯å¤šé…ç½®ï¼Œä½†æ˜¯è¿™ä¸ªåŠŸèƒ½èµ·ä½œç”¨çš„å‰ææ˜¯innodb_buffer_pool_size çš„å¤§å°å¿…é¡»å¤§äº1Gï¼Œç†æƒ³æƒ…å†µä¸‹ innodb_buffer_pool_instances çš„æ¯ä¸€ä¸ª instance éƒ½ä¿è¯åœ¨1Gä»¥ä¸Šã€‚\n3ï¼‰SHOW ENGINE INNODB STATUSå½“ä½ çš„æ•°æ®åº“å¯åŠ¨ä¹‹åï¼Œä½ éšæ—¶å¯ä»¥é€šè¿‡ä¸Šè¿°å‘½ä»¤ï¼Œå»æŸ¥çœ‹å½“å‰innodbé‡Œçš„ä¸€äº›å…·ä½“æƒ…å†µï¼Œæ‰§è¡ŒSHOW ENGINE INNODB STATUSå°±å¯ä»¥äº†ã€‚æ­¤æ—¶ä½ å¯èƒ½ä¼šçœ‹åˆ°å¦‚ä¸‹ä¸€ç³»åˆ—çš„ä¸œè¥¿ï¼š\nTotal memory allocated xxxx;Dictionary memory allocated xxxBuffer pool size xxxxFree buffers xxxDatabase pages xxxOld database pages xxxxModified db pages xxPending reads 0Pending writes: LRU 0, flush list 0, single page 0Pages made young xxxx, not young xxxxx youngs/s, xx non-youngs/sPages read xxxx, created xxx, written xxxxx reads/s, xx creates/s, 1xx writes/sBuffer pool hit rate xxx / 1000, young-making rate xxx / 1000 not xx / 1000Pages read ahead 0.00/s, evicted without access 0.00/s, Random read ahead 0.00/sLRU len: xxxx, unzip_LRU len: xxxI/O sum[xxx]:cur[xx], unzip sum[16xx:cur[0]\n\nä¸‹é¢è§£é‡Šä¸€ä¸‹è¿™é‡Œçš„ä¸œè¥¿ï¼Œä¸»è¦è®²è§£è¿™é‡Œè·Ÿbuffer poolç›¸å…³çš„ä¸€äº›ä¸œè¥¿ã€‚\n\n\nTotal memory allocatedï¼Œè¿™å°±æ˜¯è¯´buffer poolæœ€ç»ˆçš„æ€»å¤§å°æ˜¯å¤šå°‘\nBuffer pool sizeï¼Œè¿™å°±æ˜¯è¯´buffer poolä¸€å…±èƒ½å®¹çº³å¤šå°‘ä¸ªç¼“å­˜é¡µ\nFree buffersï¼Œè¿™å°±æ˜¯è¯´freeé“¾è¡¨ä¸­ä¸€å…±æœ‰å¤šå°‘ä¸ªç©ºé—²çš„ç¼“å­˜é¡µæ˜¯å¯ç”¨çš„\nDatabase pageså’ŒOld database pagesï¼Œå°±æ˜¯è¯´lrué“¾è¡¨ä¸­ä¸€å…±æœ‰å¤šå°‘ä¸ªç¼“å­˜é¡µï¼Œä»¥åŠå†·æ•°æ®åŒºåŸŸé‡Œçš„ç¼“å­˜é¡µæ•°é‡\nModified db pagesï¼Œè¿™å°±æ˜¯flushé“¾è¡¨ä¸­çš„ç¼“å­˜é¡µæ•°é‡\nPending readså’ŒPending writesï¼Œç­‰å¾…ä»ç£ç›˜ä¸ŠåŠ è½½è¿›ç¼“å­˜é¡µçš„æ•°é‡ï¼Œè¿˜æœ‰å°±æ˜¯å³å°†ä»lrué“¾è¡¨ä¸­åˆ·å…¥ç£ç›˜çš„æ•°é‡ã€å³å°†ä»flushé“¾è¡¨ä¸­åˆ·å…¥ç£ç›˜çš„æ•°é‡\nPages made youngå’Œnot youngï¼Œè¿™å°±æ˜¯è¯´å·²ç»lruå†·æ•°æ®åŒºåŸŸé‡Œè®¿é—®ä¹‹åè½¬ç§»åˆ°çƒ­æ•°æ®åŒºåŸŸçš„ç¼“å­˜é¡µçš„æ•° é‡ï¼Œä»¥åŠåœ¨lruå†·æ•°æ®åŒºåŸŸé‡Œ1så†…è¢«è®¿é—®äº†æ²¡è¿›å…¥çƒ­æ•°æ®åŒºåŸŸçš„ç¼“å­˜é¡µçš„æ•°é‡\nyoungs/så’Œnot youngs/sï¼Œè¿™å°±æ˜¯è¯´æ¯ç§’ä»å†·æ•°æ®åŒºåŸŸè¿›å…¥çƒ­æ•°æ®åŒºåŸŸçš„ç¼“å­˜é¡µçš„æ•°é‡ï¼Œä»¥åŠæ¯ç§’åœ¨å†·æ•°æ®åŒºåŸŸé‡Œè¢«è®¿é—®äº†ä½†æ˜¯ä¸èƒ½è¿›å…¥çƒ­æ•°æ®åŒºåŸŸçš„ç¼“å­˜é¡µçš„æ•°é‡\nPages read xxxx, created xxx, written xxxï¼Œxx reads/s, xx creates/s, 1xx writes/sï¼Œè¿™é‡Œå°±æ˜¯è¯´å·²ç»è¯»å–ã€åˆ›å»ºå’Œå†™å…¥äº†å¤šå°‘ä¸ªç¼“å­˜é¡µï¼Œä»¥åŠæ¯ç§’é’Ÿè¯»å–ã€åˆ›å»ºå’Œå†™å…¥çš„ç¼“å­˜é¡µæ•°é‡\nBuffer pool hit rate xxx / 1000ï¼Œè¿™å°±æ˜¯è¯´æ¯1000æ¬¡è®¿é—®ï¼Œæœ‰å¤šå°‘æ¬¡æ˜¯ç›´æ¥å‘½ä¸­äº†buffer poolé‡Œçš„ç¼“å­˜çš„\nyoung-making rate xxx / 1000 not xx / 1000ï¼Œæ¯1000æ¬¡è®¿é—®ï¼Œæœ‰å¤šå°‘æ¬¡è®¿é—®è®©ç¼“å­˜é¡µä»å†·æ•°æ®åŒºåŸŸç§»åŠ¨åˆ°äº†çƒ­æ•°æ®åŒºåŸŸï¼Œä»¥åŠæ²¡ç§»åŠ¨çš„ç¼“å­˜é¡µæ•°é‡\nLRU lenï¼šè¿™å°±æ˜¯lrué“¾è¡¨é‡Œçš„ç¼“å­˜é¡µçš„æ•°é‡\nI/O sumï¼šæœ€è¿‘50sè¯»å–ç£ç›˜é¡µçš„æ€»æ•°\nI/O curï¼šç°åœ¨æ­£åœ¨è¯»å–ç£ç›˜é¡µçš„æ•°é‡\n\n\nä¸‰ã€buffer poolçš„ç©ºé—´ç®¡ç†ã€€ã€€ç¼“å†²æ± ä¹Ÿæ˜¯æœ‰å¤§å°é™åˆ¶çš„ï¼Œé‚£ä¹ˆæ—¢ç„¶ç¼“å†²æ± æœ‰å¤§å°é™åˆ¶çš„ï¼Œæ¯æ¬¡éƒ½è¯»å…¥çš„æ•°æ®é¡µæ€ä¹ˆæ¥ç®¡ç†å‘¢ï¼Ÿè¿™é‡Œæˆ‘ä»¬æ¥èŠèŠç¼“å†²æ± çš„ç©ºé—´ç®¡ç†ï¼Œå…¶å®å¯¹ç¼“å†²æ± è¿›è¡Œç®¡ç†çš„å…³é”®éƒ¨åˆ†æ˜¯å¦‚ä½•å®‰æ’è¿›æ± çš„æ•°æ®å¹¶ä¸”æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥æ·˜æ±°æ± ä¸­çš„æ•°æ®ï¼Œä¿è¯æ± ä¸­çš„æ•°æ®ä¸â€œæº¢å‡ºâ€ï¼ŒåŒæ—¶è¿˜èƒ½ä¿è¯å¸¸ç”¨æ•°æ®ç•™åœ¨æ± å­ä¸­ã€‚\n\n1. ä¼ ç»Ÿ LRU æ·˜æ±°æ³•ç¼“å†²æ± æ˜¯åŸºäºä¼ ç»Ÿçš„ LRU æ–¹æ³•æ¥è¿›è¡Œç¼“å­˜é¡µç®¡ç†çš„ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸‹å¦‚æœä½¿ç”¨ LRU æ˜¯å¦‚ä½•ç®¡ç†çš„ã€‚\nLRUï¼Œå…¨ç§°æ˜¯ Least Recently Usedï¼Œä¸­æ–‡åå­—å«ä½œã€Œæœ€è¿‘æœ€å°‘ä½¿ç”¨ã€ã€‚ä»åå­—ä¸Šå°±å¾ˆå®¹æ˜“ç†è§£äº†ã€‚\nè¿™é‡Œåˆ†ä¸¤ç§æƒ…å†µï¼š\n1ï¼‰ç¼“å­˜é¡µå·²åœ¨ç¼“å†²æ± ä¸­è¿™ç§æƒ…å†µä¸‹ä¼šå°†å¯¹åº”çš„ç¼“å­˜é¡µæ”¾åˆ° LRU é“¾è¡¨çš„å¤´éƒ¨ï¼Œæ— éœ€ä»ç£ç›˜å†è¿›è¡Œè¯»å–ï¼Œä¹Ÿæ— éœ€æ·˜æ±°å…¶å®ƒç¼“å­˜é¡µã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœè¦è®¿é—®çš„æ•°æ®åœ¨ 6 å·é¡µä¸­ï¼Œåˆ™å°† 6 å·é¡µæ”¾åˆ°é“¾è¡¨å¤´éƒ¨å³å¯ï¼Œè¿™ç§æƒ…å†µä¸‹æ²¡æœ‰ç¼“å­˜é¡µè¢«æ·˜æ±°ã€‚\n\n2ï¼‰ç¼“å­˜é¡µä¸åœ¨ç¼“å†²æ± ä¸­ç¼“å­˜é¡µä¸åœ¨ç¼“å†²ä¸­ï¼Œè¿™æ—¶å€™å°±éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥å¯¹åº”çš„æ•°æ®é¡µï¼Œå°†å…¶æ”¾ç½®åœ¨é“¾è¡¨å¤´éƒ¨ï¼ŒåŒæ—¶æ·˜æ±°æ‰æœ«å°¾çš„ç¼“å­˜é¡µ \nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœè¦è®¿é—®çš„æ•°æ®åœ¨ 60 å·é¡µä¸­ï¼Œ60 å·é¡µä¸åœ¨ç¼“å†²æ± ä¸­ï¼Œæ­¤æ—¶åŠ è½½è¿›æ¥æ”¾åˆ°é“¾è¡¨çš„å¤´éƒ¨ï¼ŒåŒæ—¶æ·˜æ±°æ‰æœ«å°¾çš„ 17 å·ç¼“å­˜é¡µã€‚\n\næ˜¯ä¸æ˜¯çœ‹ä¸Šå»å¾ˆç®€å•ï¼ŒåŒæ—¶ä¹Ÿèƒ½æ»¡è¶³ç¼“å†²æ± æ·˜æ±°ç¼“å­˜é¡µçš„æ–¹æ³•ï¼Ÿä½†æ˜¯æˆ‘ä»¬æ¥æ€è€ƒå‡ ä¸ªé—®é¢˜ï¼š\né¢„è¯»å¤±æ•ˆ\nã€€ã€€ä¸Šé¢æˆ‘ä»¬æåˆ°äº†ç¼“å†²æ± çš„é¢„è¯»æœºåˆ¶å¯èƒ½ä¼šé¢„å…ˆåŠ è½½ç›¸é‚»çš„æ•°æ®é¡µã€‚å‡å¦‚åŠ è½½äº† 20ã€21 ç›¸é‚»çš„ä¸¤ä¸ªæ•°æ®é¡µï¼Œå¦‚æœåªæœ‰é¡µå·ä¸º 20 çš„ç¼“å­˜é¡µè¢«è®¿é—®äº†ï¼Œè€Œå¦ä¸€ä¸ªç¼“å­˜é¡µå´æ²¡æœ‰è¢«è®¿é—®ã€‚æ­¤æ—¶ä¸¤ä¸ªç¼“å­˜é¡µéƒ½åœ¨é“¾è¡¨çš„å¤´éƒ¨ï¼Œä½†æ˜¯ä¸ºäº†åŠ è½½è¿™ä¸¤ä¸ªç¼“å­˜é¡µå´æ·˜æ±°äº†æœ«å°¾çš„ç¼“å­˜é¡µï¼Œè€Œè¢«æ·˜æ±°çš„ç¼“å­˜é¡µå´æ˜¯ç»å¸¸è¢«è®¿é—®çš„ã€‚è¿™ç§æƒ…å†µå°±æ˜¯é¢„è¯»å¤±æ•ˆï¼Œè¢«é¢„å…ˆåŠ è½½è¿›ç¼“å†²æ± çš„é¡µï¼Œå¹¶æ²¡æœ‰è¢«è®¿é—®åˆ°ï¼Œè¿™ç§æƒ…å†µæ˜¯ä¸æ˜¯å¾ˆä¸åˆç†ã€‚\nç¼“å†²æ± æ±¡æŸ“ã€€ã€€è¿˜æœ‰ä¸€ç§æƒ…å†µæ˜¯å½“æ‰§è¡Œä¸€æ¡ SQL è¯­å¥æ—¶ï¼Œå¦‚æœæ‰«æäº†å¤§é‡æ•°æ®æˆ–æ˜¯è¿›è¡Œäº†å…¨è¡¨æ‰«æï¼Œæ­¤æ—¶ç¼“å†²æ± ä¸­å°±ä¼šåŠ è½½å¤§é‡çš„æ•°æ®é¡µï¼Œä»è€Œå°†ç¼“å†²æ± ä¸­å·²å­˜åœ¨çš„æ‰€æœ‰é¡µæ›¿æ¢å‡ºå»ï¼Œè¿™ç§æƒ…å†µåŒæ ·æ˜¯ä¸åˆç†çš„ã€‚è¿™å°±æ˜¯ç¼“å†²æ± æ±¡æŸ“ï¼Œå¹¶ä¸”è¿˜ä¼šå¯¼è‡´ MySQL æ€§èƒ½æ€¥å‰§ä¸‹é™ã€‚\n2. å†·çƒ­æ•°æ®åˆ†ç¦»è¿™æ ·çœ‹æ¥ï¼Œä¼ ç»Ÿçš„ LRU æ–¹æ³•å¹¶ä¸èƒ½æ»¡è¶³ç¼“å†²æ± çš„ç©ºé—´ç®¡ç†ã€‚å› æ­¤ï¼ŒMsyql åŸºäº LRU è®¾è®¡äº†å†·çƒ­æ•°æ®åˆ†ç¦»çš„å¤„ç†æ–¹æ¡ˆã€‚\nä¹Ÿå°±æ˜¯å°† LRU é“¾è¡¨åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ä¸ºçƒ­æ•°æ®åŒºåŸŸï¼Œä¸€éƒ¨åˆ†ä¸ºå†·æ•°æ®åŒºåŸŸã€‚\n\nå½“æ•°æ®é¡µç¬¬ä¸€æ¬¡è¢«åŠ è½½åˆ°ç¼“å†²æ± ä¸­çš„æ—¶å€™ï¼Œå…ˆå°†å…¶æ”¾åˆ°å†·æ•°æ®åŒºåŸŸçš„é“¾è¡¨å¤´éƒ¨ï¼Œ1sï¼ˆç”± innodb_old_blocks_time å‚æ•°æ§åˆ¶ï¼‰ åè¯¥ç¼“å­˜é¡µè¢«è®¿é—®äº†å†å°†å…¶ç§»è‡³çƒ­æ•°æ®åŒºåŸŸçš„é“¾è¡¨å¤´éƒ¨ã€‚\n\nã€€ã€€å¯èƒ½ä½ ä¼šæœ‰ç–‘æƒ‘äº†ï¼Œä¸ºä»€ä¹ˆè¦ç­‰ 1s åæ‰å°†å…¶ç§»è‡³çƒ­æ•°æ®åŒºåŸŸå‘¢ï¼Ÿä½ æƒ³æƒ³ï¼Œå¦‚æœæ•°æ®é¡µåˆšè¢«åŠ è½½åˆ°å†·æ•°æ®åŒºå°±è¢«è®¿é—®äº†ï¼Œä¹‹åå†ä¹Ÿä¸è®¿é—®å®ƒäº†å‘¢ï¼Ÿè¿™ä¸å°±é€ æˆçƒ­æ•°æ®åŒºçš„æµªè´¹äº†å—ï¼Ÿè¦æ˜¯ 1s åä¸è®¿é—®äº†ï¼Œè¯´æ˜ä¹‹åå¯èƒ½ä¹Ÿä¸ä¼šå»é¢‘ç¹è®¿é—®å®ƒï¼Œä¹Ÿå°±æ²¡æœ‰ç§»è‡³çƒ­ç¼“å†²åŒºçš„å¿…è¦äº†ã€‚å½“ç¼“å­˜é¡µä¸å¤Ÿçš„æ—¶å€™ï¼Œä»å†·æ•°æ®åŒºæ·˜æ±°å®ƒä»¬å°±è¡Œäº†ã€‚ \nã€€ã€€å¦ä¸€ç§æƒ…å†µï¼Œå½“æˆ‘çš„æ•°æ®é¡µå·²ç»åœ¨çƒ­ç¼“å†²åŒºäº†ï¼Œæ˜¯ä¸æ˜¯ç¼“å­˜é¡µåªè¦è¢«è®¿é—®äº†å°±å°†å…¶æ’åˆ°é“¾è¡¨å¤´éƒ¨å‘¢ï¼Ÿä¸ç”¨æˆ‘è¯´ä½ è‚¯å®šä¹Ÿè§‰å¾—ä¸åˆç†ã€‚çƒ­æ•°æ®åŒºåŸŸé‡Œçš„ç¼“å­˜é¡µæ˜¯ä¼šè¢«ç»å¸¸è®¿é—®çš„ï¼Œå¦‚æœæ¯è®¿é—®ä¸€ä¸ªç¼“å­˜é¡µå°±æ’å…¥ä¸€æ¬¡é“¾è¡¨å¤´ï¼Œé‚£æ•´ä¸ªçƒ­ç¼“å†²åŒºé‡Œå°±å¼‚å¸¸éªšåŠ¨äº†ï¼Œä½ æƒ³æƒ³é‚£ä¸ªç”»é¢ã€‚\né‚£å’‹æ•´å‘¢ï¼ŸMysql ä¸­ä¼˜åŒ–ä¸ºçƒ­æ•°æ®åŒºçš„å 3/4 éƒ¨åˆ†è¢«è®¿é—®åæ‰å°†å…¶ç§»åŠ¨åˆ°é“¾è¡¨å¤´éƒ¨å»ï¼Œå¯¹äºå‰ 1/4 éƒ¨åˆ†çš„ç¼“å­˜é¡µè¢«è®¿é—®äº†ä¸ä¼šè¿›è¡Œç§»åŠ¨ã€‚\nå››ã€Buffer Pool é¢„è¯»æœºåˆ¶ã€€ã€€é¢„è¯»æ˜¯mysqlæé«˜æ€§èƒ½çš„ä¸€ä¸ªé‡è¦çš„ç‰¹æ€§ã€‚é¢„è¯»å°±æ˜¯ IO å¼‚æ­¥è¯»å–å¤šä¸ªé¡µæ•°æ®è¯»å…¥ Buffer Pool çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”è¿™äº›é¡µè¢«è®¤ä¸ºæ˜¯å¾ˆå¿«å°±ä¼šè¢«è¯»å–åˆ°çš„ã€‚InnoDBä½¿ç”¨ä¸¤ç§é¢„è¯»ç®—æ³•æ¥æé«˜I/Oæ€§èƒ½ï¼šçº¿æ€§é¢„è¯»ï¼ˆlinear read-aheadï¼‰å’Œéšæœºé¢„è¯»ï¼ˆrandomread-aheadï¼‰\nã€€ã€€ä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§é¢„è¯»çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçº¿æ€§é¢„è¯»æ”¾åˆ°ä»¥extentä¸ºå•ä½ï¼Œè€Œéšæœºé¢„è¯»æ”¾åˆ°ä»¥extentä¸­çš„pageä¸ºå•ä½ã€‚çº¿æ€§é¢„è¯»ç€çœ¼äºå°†ä¸‹ä¸€ä¸ªextentæå‰è¯»å–åˆ°buffer poolä¸­ï¼Œè€Œéšæœºé¢„è¯»ç€çœ¼äºå°†å½“å‰extentä¸­çš„å‰©ä½™çš„pageæå‰è¯»å–åˆ°buffer poolä¸­ã€‚\n1. Linearçº¿æ€§é¢„è¯»ã€€ã€€çº¿æ€§é¢„è¯»çš„å•ä½æ˜¯extendï¼Œä¸€ä¸ªextendä¸­æœ‰64ä¸ªpageã€‚çº¿æ€§é¢„è¯»çš„ä¸€ä¸ªé‡è¦å‚æ•°æ˜¯innodb_read_ahead_thresholdï¼Œæ˜¯æŒ‡åœ¨è¿ç»­è®¿é—®å¤šå°‘ä¸ªé¡µé¢ä¹‹åï¼ŒæŠŠä¸‹ä¸€ä¸ªextendè¯»å…¥åˆ°buffer poolä¸­ï¼Œä¸è¿‡é¢„è¯»æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„æ“ä½œã€‚å½“ç„¶è¿™ä¸ªå‚æ•°ä¸èƒ½è¶…è¿‡64ï¼Œå› ä¸ºä¸€ä¸ªextendæœ€å¤šåªæœ‰64ä¸ªé¡µé¢ã€‚ä¾‹å¦‚ï¼Œinnodb_read_ahead_threshold = 56ï¼Œå°±æ˜¯æŒ‡åœ¨è¿ç»­è®¿é—®äº†ä¸€ä¸ªextendçš„56ä¸ªé¡µé¢ä¹‹åæŠŠä¸‹ä¸€ä¸ªextendè¯»å…¥åˆ°buffer poolä¸­ã€‚åœ¨æ·»åŠ æ­¤å‚æ•°ä¹‹å‰ï¼ŒInnoDBä»…è®¡ç®—å½“å®ƒåœ¨å½“å‰èŒƒå›´çš„æœ€åä¸€é¡µä¸­è¯»å–æ—¶æ˜¯å¦ä¸ºæ•´ä¸ªä¸‹ä¸€ä¸ªèŒƒå›´å‘å‡ºå¼‚æ­¥é¢„å–è¯·æ±‚ã€‚\n2. Randoméšæœºé¢„è¯»ã€€ã€€éšæœºé¢„è¯»æ–¹å¼åˆ™æ˜¯è¡¨ç¤ºå½“åŒä¸€ä¸ªextentä¸­çš„ä¸€äº›pageåœ¨buffer poolä¸­å‘ç°æ—¶ï¼ŒInnodbä¼šå°†è¯¥extentä¸­çš„å‰©ä½™pageä¸€å¹¶è¯»åˆ°buffer poolä¸­ã€‚ç”±äºéšæœºé¢„è¯»æ–¹å¼ç»™innodb codeå¸¦æ¥äº†ä¸€äº›ä¸å¿…è¦çš„å¤æ‚æ€§ï¼ŒåŒæ—¶åœ¨æ€§èƒ½ä¹Ÿå­˜åœ¨ä¸ç¨³å®šæ€§ï¼Œåœ¨5.5ä¸­å·²ç»å°†è¿™ç§é¢„è¯»æ–¹å¼åºŸå¼ƒï¼Œé»˜è®¤æ˜¯OFFã€‚è‹¥è¦å¯ç”¨æ­¤åŠŸèƒ½ï¼Œå³å°†é…ç½®å˜é‡è®¾ç½®innodb_random_read_aheadä¸ºONã€‚\n\näº”ã€Buffer Poolçš„ä¸‰ç§Pageå’Œé“¾è¡¨ã€€ã€€Buffer Pool æ˜¯Innodb å†…å­˜ä¸­çš„çš„ä¸€å—å æ¯”è¾ƒå¤§çš„åŒºåŸŸï¼Œç”¨æ¥ç¼“å­˜è¡¨å’Œç´¢å¼•æ•°æ®ã€‚ä¼—æ‰€å‘¨çŸ¥ï¼Œä»å†…å­˜è®¿é—®ä¼šæ¯”ä»ç£ç›˜è®¿é—®å¿«å¾ˆå¤šã€‚ä¸ºäº†æé«˜æ•°æ®çš„è¯»å–é€Ÿåº¦ï¼ŒBuffer Pool ä¼šé€šè¿‡ä¸‰ç§Page å’Œé“¾è¡¨æ¥ç®¡ç†è¿™äº›ç»å¸¸è®¿é—®çš„æ•°æ®ï¼Œä¿è¯çƒ­æ•°æ®ä¸è¢«ç½®æ¢å‡ºBuffer Poolã€‚\n1. ä¸‰ç§PageFree Pageï¼ˆç©ºé—²é¡µï¼‰\nè¡¨ç¤ºæ­¤Page æœªè¢«ä½¿ç”¨ï¼Œä½äº Free é“¾è¡¨ã€‚\nClean Pageï¼ˆå¹²å‡€é¡µï¼‰\næ­¤Page å·²è¢«ä½¿ç”¨ï¼Œä½†æ˜¯é¡µé¢æœªå‘ç”Ÿä¿®æ”¹ï¼Œä½äºLRU é“¾è¡¨ã€‚\nDirty Pageï¼ˆè„é¡µï¼‰\næ­¤Page å·²è¢«ä½¿ç”¨ï¼Œé¡µé¢å·²ç»è¢«ä¿®æ”¹ï¼Œå…¶æ•°æ®å’Œç£ç›˜ä¸Šçš„æ•°æ®å·²ç»ä¸ä¸€è‡´ã€‚å½“è„é¡µä¸Šçš„æ•°æ®å†™å…¥ç£ç›˜åï¼Œå†…å­˜æ•°æ®å’Œç£ç›˜æ•°æ®ä¸€è‡´ï¼Œé‚£ä¹ˆè¯¥Page å°±å˜æˆäº†å¹²å‡€é¡µã€‚è„é¡µ åŒæ—¶å­˜åœ¨äºLRU é“¾è¡¨å’ŒFlush é“¾è¡¨ã€‚\n \n2. ä¸‰ç§é“¾è¡¨1ï¼‰LRU é“¾è¡¨\nå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ˜¯Buffer Poolé‡Œé¢çš„LRU(least recently used)é“¾è¡¨ã€‚LRUé“¾è¡¨æ˜¯è¢«ä¸€ç§å«åšæœ€è¿‘æœ€å°‘ä½¿ç”¨çš„ç®—æ³•ç®¡ç†ã€‚\nLRUé“¾è¡¨è¢«åˆ†æˆä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯New Sublist(Young é“¾è¡¨)ï¼Œç”¨æ¥å­˜æ”¾ç»å¸¸è¢«è¯»å–çš„é¡µçš„åœ°å€ï¼Œå¦å¤–ä¸€éƒ¨åˆ†æ˜¯Old Sublist(Old é“¾è¡¨)ï¼Œç”¨æ¥å­˜æ”¾è¾ƒå°‘è¢«ä½¿ç”¨çš„é¡µé¢ã€‚æ¯éƒ¨åˆ†éƒ½æœ‰å¯¹åº”çš„å¤´éƒ¨ å’Œå°¾éƒ¨ã€‚\né»˜è®¤æƒ…å†µä¸‹\n\nOld é“¾è¡¨å æ•´ä¸ªLRU é“¾è¡¨çš„æ¯”ä¾‹æ˜¯3/8ã€‚è¯¥æ¯”ä¾‹ç”±innodb_old_blocks_pctæ§åˆ¶ï¼Œé»˜è®¤å€¼æ˜¯37ï¼ˆ3/8*100ï¼‰ã€‚è¯¥å€¼å–å€¼èŒƒå›´ä¸º5~95ï¼Œä¸ºå…¨å±€åŠ¨æ€å˜é‡ã€‚\nå½“æ–°çš„é¡µè¢«è¯»å–åˆ°Buffer Poolé‡Œé¢çš„æ—¶å€™ï¼Œå’Œä¼ ç»Ÿçš„LRUç®—æ³•æ’å…¥åˆ°LRUé“¾è¡¨å¤´éƒ¨ä¸åŒï¼ŒInnodb LRUç®—æ³•æ˜¯å°†æ–°çš„é¡µé¢æ’å…¥åˆ°Yong é“¾è¡¨çš„å°¾éƒ¨å’ŒOld é“¾è¡¨çš„å¤´éƒ¨ä¸­é—´çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®å«åšMid Pointï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºã€‚\né¢‘ç¹è®¿é—®ä¸€ä¸ªBuffer Poolçš„é¡µé¢ï¼Œä¼šä¿ƒä½¿é¡µé¢å¾€Youngé“¾è¡¨çš„å¤´éƒ¨ç§»åŠ¨ã€‚å¦‚æœä¸€ä¸ªPageåœ¨è¢«è¯»åˆ°Buffer Poolåå¾ˆå¿«å°±è¢«è®¿é—®ï¼Œé‚£ä¹ˆè¯¥Pageä¼šå¾€Young Listçš„å¤´éƒ¨ç§»åŠ¨ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªé¡µé¢æ˜¯é€šè¿‡é¢„è¯»çš„æ–¹å¼è¯»åˆ°Buffer Poolï¼Œä¸”ä¹‹åçŸ­æ—¶é—´å†…æ²¡æœ‰è¢«è®¿é—®ï¼Œé‚£ä¹ˆå¾ˆå¯èƒ½åœ¨ä¸‹æ¬¡è®¿é—®ä¹‹å‰å°±è¢«ç§»åŠ¨åˆ°Old Listçš„å°¾éƒ¨ï¼Œè€Œè¢«é©±é€äº†ã€‚\néšç€æ•°æ®åº“çš„æŒç»­è¿è¡Œï¼Œæ–°çš„é¡µé¢è¢«ä¸æ–­çš„æ’å…¥åˆ°LRUé“¾è¡¨çš„Mid Pointï¼ŒOld é“¾è¡¨é‡Œçš„é¡µé¢ä¼šé€æ¸çš„è¢«ç§»åŠ¨Oldé“¾è¡¨çš„å°¾éƒ¨ã€‚åŒæ—¶ï¼Œå½“ç»å¸¸è¢«è®¿é—®çš„é¡µé¢ç§»åŠ¨åˆ°LRUé“¾è¡¨å¤´éƒ¨çš„æ—¶å€™ï¼Œé‚£äº›æ²¡æœ‰è¢«è®¿é—®çš„é¡µé¢ä¼šé€æ¸çš„è¢«ç§»åŠ¨åˆ°é“¾è¡¨çš„å°¾éƒ¨ã€‚æœ€ç»ˆï¼Œä½äºOld é“¾è¡¨å°¾éƒ¨çš„é¡µé¢å°†è¢«é©±é€ã€‚\n\nå¦‚æœä¸€ä¸ªæ•°æ®é¡µå·²ç»å¤„äºYoung é“¾è¡¨ï¼Œå½“å®ƒå†æ¬¡è¢«è®¿é—®çš„æ—¶å€™ï¼Œåªæœ‰å½“å…¶å¤„äºYoung é“¾è¡¨é•¿åº¦çš„1/4(å¤§çº¦å€¼)ä¹‹åï¼Œæ‰ä¼šè¢«ç§»åŠ¨åˆ°Young é“¾è¡¨çš„å¤´éƒ¨ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯å‡å°‘å¯¹LRU é“¾è¡¨çš„ä¿®æ”¹ï¼Œå› ä¸ºLRU é“¾è¡¨çš„ç›®æ ‡æ˜¯ä¿è¯ç»å¸¸è¢«è®¿é—®çš„æ•°æ®é¡µä¸ä¼šè¢«é©±é€å‡ºå»ã€‚\ninnodb_old_blocks_time æ§åˆ¶çš„Old é“¾è¡¨å¤´éƒ¨é¡µé¢çš„è½¬ç§»ç­–ç•¥ã€‚è¯¥Pageéœ€è¦åœ¨Old é“¾è¡¨åœç•™è¶…è¿‡innodb_old_blocks_time æ—¶é—´ï¼Œä¹‹åå†æ¬¡è¢«è®¿é—®ï¼Œæ‰ä¼šç§»åŠ¨åˆ°Young é“¾è¡¨ã€‚è¿™ä¹ˆæ“ä½œæ˜¯é¿å…Young é“¾è¡¨è¢«é‚£äº›åªåœ¨innodb_old_blocks_timeæ—¶é—´é—´éš”å†…é¢‘ç¹è®¿é—®ï¼Œä¹‹åå°±ä¸è¢«è®¿é—®çš„é¡µé¢å¡æ»¡ï¼Œä»è€Œæœ‰æ•ˆçš„ä¿æŠ¤Young é“¾è¡¨ã€‚\nåœ¨å…¨è¡¨æ‰«ææˆ–è€…å…¨ç´¢å¼•æ‰«æçš„æ—¶å€™ï¼ŒInnodbä¼šå°†å¤§é‡çš„é¡µé¢å†™å…¥LRU é“¾è¡¨çš„Mid Pointä½ç½®ï¼Œå¹¶ä¸”åªåœ¨çŸ­æ—¶é—´å†…è®¿é—®å‡ æ¬¡ä¹‹åå°±ä¸å†è®¿é—®äº†ã€‚è®¾ç½®innodb_old_blocks_timeçš„æ—¶é—´çª—å£å¯ä»¥æœ‰æ•ˆçš„ä¿æŠ¤Young Listï¼Œä¿è¯äº†çœŸæ­£çš„é¢‘ç¹è®¿é—®çš„é¡µé¢ä¸è¢«é©±é€ã€‚\ninnodb_old_blocks_time å•ä½æ˜¯æ¯«ç§’ï¼Œé»˜è®¤å€¼æ˜¯1000ã€‚è°ƒå¤§è¯¥å€¼æé«˜äº†ä»Oldé“¾è¡¨ç§»åŠ¨åˆ°Youngé“¾è¡¨çš„éš¾åº¦ï¼Œä¼šä¿ƒä½¿æ›´å¤šé¡µé¢è¢«ç§»åŠ¨åˆ°Old é“¾è¡¨ï¼Œè€åŒ–ï¼Œä»è€Œè¢«é©±é€ã€‚\nå½“æ‰«æçš„è¡¨å¾ˆå¤§ï¼ŒBuffer Pooléƒ½æ”¾ä¸ä¸‹æ—¶ï¼Œå¯ä»¥å°†innodb_old_blocks_pctè®¾ç½®ä¸ºè¾ƒå°çš„å€¼ï¼Œè¿™æ ·åªè¯»å–ä¸€æ¬¡çš„æ•°æ®é¡µå°±ä¸ä¼šå æ®å¤§éƒ¨åˆ†çš„Buffer Poolã€‚ä¾‹å¦‚ï¼Œè®¾ç½®innodb_old_blocks_pct = 5ï¼Œä¼šå°†ä»…è¯»å–ä¸€æ¬¡çš„æ•°æ®é¡µåœ¨Buffer Poolçš„å ç”¨é™åˆ¶ä¸º5ï¼…ã€‚\nå½“ç»å¸¸æ‰«æä¸€äº›å°è¡¨æ—¶ï¼Œè¿™äº›é¡µé¢åœ¨Buffer Poolç§»åŠ¨çš„å¼€é”€è¾ƒå°ï¼Œæˆ‘ä»¬å¯ä»¥é€‚å½“çš„è°ƒå¤§innodb_old_blocks_pctï¼Œä¾‹å¦‚è®¾ç½®innodb_old_blocks_pct = 50ã€‚\nåœ¨SHOW ENGINE INNODB STATUS é‡Œé¢æä¾›äº†Buffer Poolä¸€äº›ç›‘æ§æŒ‡æ ‡ï¼Œæœ‰å‡ ä¸ªæˆ‘ä»¬éœ€è¦å…³æ³¨ä¸€ä¸‹ï¼š\n\nyoungs/sï¼šè¯¥æŒ‡æ ‡è¡¨ç¤ºçš„æ˜¯æ¯ç§’è®¿é—®Old é“¾è¡¨ä¸­é¡µé¢ï¼Œä½¿å…¶ç§»åŠ¨åˆ°Youngé“¾è¡¨çš„æ¬¡æ•°ã€‚å¦‚æœMySQLå®ä¾‹éƒ½æ˜¯ä¸€äº›å°äº‹åŠ¡ï¼Œæ²¡æœ‰å¤§è¡¨å…¨æ‰«æï¼Œä¸”è¯¥æŒ‡æ ‡å¾ˆå°ï¼Œå°±éœ€è¦è°ƒå¤§innodb_old_blocks_pct æˆ–è€…å‡å°innodb_old_blocks_timeï¼Œè¿™æ ·ä¼šä½¿å¾—Old List çš„é•¿åº¦æ›´é•¿ï¼ŒOldé¡µé¢è¢«ç§»åŠ¨åˆ°Old List çš„å°¾éƒ¨æ¶ˆè€—çš„æ—¶é—´ä¼šæ›´ä¹…ï¼Œé‚£ä¹ˆå°±æå‡äº†ä¸‹ä¸€æ¬¡è®¿é—®åˆ°Old Listé‡Œé¢çš„é¡µé¢çš„å¯èƒ½æ€§ã€‚å¦‚æœè¯¥æŒ‡æ ‡å¾ˆå¤§ï¼Œå¯ä»¥è°ƒå°innodb_old_blocks_pctï¼ŒåŒæ—¶è°ƒå¤§innodb_old_blocks_timeï¼Œä¿æŠ¤çƒ­æ•°æ®ã€‚\nnon-youngs/sï¼šè¯¥æŒ‡æ ‡è¡¨ç¤ºçš„æ˜¯æ¯ç§’è®¿é—®Old é“¾è¡¨ä¸­é¡µé¢ï¼Œæ²¡æœ‰ç§»åŠ¨åˆ°Youngé“¾è¡¨çš„æ¬¡æ•°ï¼Œå› ä¸ºå…¶ä¸ç¬¦åˆinnodb_old_blocks_timeã€‚å¦‚æœè¯¥æŒ‡æ ‡å¾ˆå¤§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ˜¯MySQLå­˜åœ¨å¤§é‡çš„å…¨è¡¨æ‰«æã€‚å¦‚æœMySQLå­˜åœ¨å¤§é‡å…¨è¡¨æ‰«æï¼Œä¸”è¿™ä¸ªæŒ‡æ ‡åˆä¸å¤§çš„æ—¶å€™ï¼Œéœ€è¦è°ƒå¤§innodb_old_blocks_timeï¼Œå› ä¸ºè¿™ä¸ªæŒ‡æ ‡ä¸å¤§æ„å‘³ç€å…¨è¡¨æ‰«æçš„é¡µé¢è¢«ç§»åŠ¨åˆ°Young é“¾è¡¨äº†ï¼Œè°ƒå¤§innodb_old_blocks_timeæ—¶é—´ä¼šä½¿å¾—è¿™äº›çŸ­æ—¶é—´é¢‘ç¹è®¿é—®çš„é¡µé¢ä¿ç•™åœ¨Old é“¾è¡¨é‡Œé¢ã€‚\n\næ¯éš”1ç§’é’Ÿï¼ŒPage Cleanerçº¿ç¨‹æ‰§è¡ŒLRU List Flushçš„æ“ä½œï¼Œæ¥é‡Šæ”¾è¶³å¤Ÿçš„Free Pageã€‚innodb_lru_scan_depth å˜é‡æ§åˆ¶æ¯ä¸ªBuffer Poolå®ä¾‹æ¯æ¬¡æ‰«æLRU Listçš„é•¿åº¦ï¼Œæ¥å¯»æ‰¾å¯¹åº”çš„è„é¡µï¼Œæ‰§è¡ŒFlushæ“ä½œã€‚\n2ï¼‰Flush é“¾è¡¨\nFlush é“¾è¡¨é‡Œé¢ä¿å­˜çš„éƒ½æ˜¯è„é¡µï¼Œä¹Ÿä¼šå­˜åœ¨äºLRU é“¾è¡¨ã€‚\nFlush é“¾è¡¨æ˜¯æŒ‰ç…§oldest_modificationæ’åºï¼Œå€¼å¤§çš„åœ¨å¤´éƒ¨ï¼Œå€¼å°çš„åœ¨å°¾éƒ¨\nå½“æœ‰é¡µé¢è®¿è¢«ä¿®æ”¹çš„æ—¶å€™ï¼Œä½¿ç”¨mini-transactionï¼Œå¯¹åº”çš„pageè¿›å…¥Flush é“¾è¡¨\nå¦‚æœå½“å‰é¡µé¢å·²ç»æ˜¯è„é¡µï¼Œå°±ä¸éœ€è¦å†æ¬¡åŠ å…¥Flush listï¼Œå¦åˆ™æ˜¯ç¬¬ä¸€æ¬¡ä¿®æ”¹ï¼Œéœ€è¦åŠ å…¥Flush é“¾è¡¨\nå½“Page Cleanerçº¿ç¨‹æ‰§è¡Œflushæ“ä½œçš„æ—¶å€™ï¼Œä»å°¾éƒ¨å¼€å§‹scanï¼Œå°†ä¸€å®šçš„è„é¡µå†™å…¥ç£ç›˜ï¼Œæ¨è¿›æ£€æŸ¥ç‚¹ï¼Œå‡å°‘recoverçš„æ—¶é—´\n\nã€€ã€€SQL çš„å¢åˆ æ”¹æŸ¥éƒ½åœ¨ Buffer Pool ä¸­æ‰§è¡Œï¼Œæ…¢æ…¢åœ°ï¼ŒBuffer Pool ä¸­çš„ç¼“å­˜é¡µå› ä¸ºä¸æ–­è¢«ä¿®æ”¹è€Œå¯¼è‡´å’Œç£ç›˜æ–‡ä»¶ä¸­çš„æ•°æ®ä¸ä¸€è‡´äº†ï¼Œä¹Ÿå°±æ˜¯ Buffer Pool ä¸­ä¼šæœ‰å¾ˆå¤šä¸ªè„é¡µï¼Œè„é¡µé‡Œé¢å¾ˆå¤šè„æ•°æ®ã€‚\næ‰€ä»¥ï¼ŒMySQL ä¼šæœ‰ä¸€æ¡åå°çº¿ç¨‹ï¼Œå®šæ—¶åœ°å°† Buffer Pool ä¸­çš„è„é¡µåˆ·å›åˆ°ç£ç›˜æ–‡ä»¶ä¸­ã€‚\nä½†æ˜¯ï¼Œåå°çº¿ç¨‹æ€ä¹ˆçŸ¥é“å“ªäº›ç¼“å­˜é¡µæ˜¯è„é¡µå‘¢ï¼Œä¸å¯èƒ½å°†å…¨éƒ¨çš„ç¼“å­˜é¡µéƒ½å¾€ç£ç›˜ä¸­åˆ·å§ï¼Œè¿™ä¼šå¯¼è‡´ MySQL æš‚åœä¸€æ®µæ—¶é—´ã€‚\nMySQL æ˜¯æ€ä¹ˆåˆ¤æ–­è„é¡µçš„\nã€€ã€€æˆ‘ä»¬å¼•å…¥ä¸€ä¸ªå’Œ free é“¾è¡¨ç±»ä¼¼çš„ flush é“¾è¡¨ã€‚ä»–çš„æœ¬è´¨ä¹Ÿæ˜¯é€šè¿‡ç¼“å­˜é¡µçš„æè¿°æ•°æ®å—ä¸­çš„ä¸¤ä¸ªæŒ‡é’ˆï¼Œè®©ä¿®æ”¹è¿‡çš„ç¼“å­˜é¡µçš„æè¿°æ•°æ®å—èƒ½ä¸²æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸¤æŒ‡é’ˆå¤§å®¶å¯ä»¥è®¤ä¸ºæ˜¯ flush_pre æŒ‡é’ˆå’Œ flush_next æŒ‡é’ˆã€‚\nä¸‹é¢æˆ‘ç”¨ä¼ªä»£ç æ¥æè¿°ä¸€ä¸‹ï¼š\nDescriptionDataBlock&#123;    block_id = block1;    // free é“¾è¡¨çš„    free_pre = null;    free_next = null;    // flush é“¾è¡¨çš„    flush_pre = null;    flush_next = block2;&#125;\n\nflush é“¾è¡¨ä¹Ÿæœ‰å¯¹åº”çš„åŸºç¡€èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯åŒ…å«é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œè¿˜æœ‰å°±æ˜¯ä¿®æ”¹è¿‡çš„ç¼“å­˜é¡µçš„æ•°é‡ã€‚\nFlushListBaseNode&#123;    start = block1;    end = block2;    count = 2;&#125;\n\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼ŒSQL çš„å¢åˆ æ”¹éƒ½ä¼šä½¿å¾—ç¼“å­˜é¡µå˜ä¸ºè„é¡µï¼Œæ­¤æ—¶ä¼šä¿®æ”¹è„é¡µå¯¹åº”çš„æè¿°æ•°æ®å—çš„ flush_pre æŒ‡é’ˆå’Œ flush_next æŒ‡é’ˆï¼Œä½¿å¾—æè¿°æ•°æ®å—åŠ å…¥åˆ° flush é“¾è¡¨ä¸­ï¼Œä¹‹å MySQL çš„åå°çº¿ç¨‹å°±å¯ä»¥å°†è¿™ä¸ªè„é¡µåˆ·å›åˆ°ç£ç›˜ä¸­ã€‚\n3ï¼‰Free é“¾è¡¨\nFree é“¾è¡¨ å­˜æ”¾çš„æ˜¯ç©ºé—²é¡µé¢ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ç”³è¯·ä¸€å®šæ•°é‡çš„é¡µé¢ï¼Œå½“ MySQL å¯åŠ¨åï¼Œä¼šä¸æ–­åœ°æœ‰ SQL è¯·æ±‚è¿›æ¥ï¼Œæ­¤æ—¶ç©ºå…ˆçš„ç¼“å­˜é¡µå°±ä¼šä¸æ–­åœ°è¢«ä½¿ç”¨ã€‚\nåœ¨æ‰§è¡ŒSQLçš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡æˆåŠŸload é¡µé¢åˆ°å†…å­˜åï¼Œä¼šåˆ¤æ–­Free é“¾è¡¨çš„é¡µé¢æ˜¯å¦å¤Ÿç”¨ã€‚å¦‚æœä¸å¤Ÿç”¨çš„è¯ï¼Œå°±flush LRU é“¾è¡¨å’ŒFlush é“¾è¡¨æ¥é‡Šæ”¾ç©ºé—²é¡µã€‚å¦‚æœå¤Ÿç”¨ï¼Œå°±ä»Free é“¾è¡¨é‡Œé¢åˆ é™¤å¯¹åº”çš„é¡µé¢ï¼Œåœ¨LRU é“¾è¡¨å¢åŠ é¡µé¢ï¼Œä¿æŒæ€»æ•°ä¸å˜ã€‚\n\nFree é“¾è¡¨çš„ä½¿ç”¨åŸç†\nfree é“¾è¡¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œé“¾è¡¨çš„æ¯ä¸ªèŠ‚ç‚¹å°±æ˜¯ä¸€ä¸ªä¸ªç©ºé—²çš„ç¼“å­˜é¡µå¯¹åº”çš„æè¿°æ•°æ®å—ã€‚\nä»–æœ¬èº«å…¶å®å°±æ˜¯ç”± Buffer Pool é‡Œçš„æè¿°æ•°æ®å—ç»„æˆçš„ï¼Œä½ å¯ä»¥è®¤ä¸ºæ˜¯æ¯ä¸ªæè¿°æ•°æ®å—é‡Œéƒ½æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæ˜¯ free_pre æŒ‡é’ˆï¼Œä¸€ä¸ªæ˜¯ free_next æŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘è‡ªå·±çš„ä¸Šä¸€ä¸ª free é“¾è¡¨çš„èŠ‚ç‚¹ï¼Œä»¥åŠä¸‹ä¸€ä¸ª free é“¾è¡¨çš„èŠ‚ç‚¹ã€‚\né€šè¿‡ Buffer Pool ä¸­çš„æè¿°æ•°æ®å—çš„ free_pre å’Œ free_next ä¸¤ä¸ªæŒ‡é’ˆï¼Œå°±å¯ä»¥æŠŠæ‰€æœ‰çš„æè¿°æ•°æ®å—ä¸²æˆä¸€ä¸ª free é“¾è¡¨ã€‚\nä¸‹é¢æˆ‘ä»¬å¯ä»¥ç”¨ä¼ªä»£ç æ¥æè¿°ä¸€ä¸‹ free é“¾è¡¨ä¸­æè¿°æ•°æ®å—èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼š\nDescriptionDataBlock&#123;    block_id = block1;    free_pre = null;    free_next = block2;&#125;\n\nfree é“¾è¡¨æœ‰ä¸€ä¸ªåŸºç¡€èŠ‚ç‚¹ï¼Œä»–ä¼šå¼•ç”¨é“¾è¡¨çš„å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼Œé‡Œé¢è¿˜å­˜å‚¨äº†é“¾è¡¨ä¸­æœ‰å¤šå°‘ä¸ªæè¿°æ•°æ®å—çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æœ‰å¤šå°‘ä¸ªç©ºé—²çš„ç¼“å­˜é¡µã€‚\nä¸‹é¢æˆ‘ä»¬ä¹Ÿç”¨ä¼ªä»£ç æ¥æè¿°ä¸€ä¸‹åŸºç¡€èŠ‚ç‚¹çš„æ•°æ®ç»“æ„ï¼š\nFreeListBaseNode&#123;    start = block01;    end = block03;       count = 2;&#125;\n\nåˆ°æ­¤ï¼Œfree é“¾è¡¨å°±ä»‹ç»å®Œäº†ã€‚ä¸Šé¢æˆ‘ä»¬ä¹Ÿä»‹ç»äº† MySQL å¯åŠ¨æ—¶ Buffer Pool çš„åˆå§‹æµç¨‹ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä¼šå°†ç»“åˆåˆšä»‹ç»å®Œçš„ free é“¾è¡¨ï¼Œè®²è§£ä¸€ä¸‹ SQL è¿›æ¥æ—¶ï¼Œç£ç›˜æ•°æ®é¡µè¯»å–åˆ° Buffer Pool çš„ç¼“å­˜é¡µçš„è¿‡ç¨‹ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬å…ˆè¦äº†è§£ä¸€ä¸‹ä¸€ä¸ªæ–°æ¦‚å¿µï¼šæ•°æ®é¡µç¼“å­˜å“ˆå¸Œè¡¨ï¼Œå®ƒçš„ key æ˜¯è¡¨ç©ºé—´+æ•°æ®é¡µå·ï¼Œè€Œ value æ˜¯å¯¹åº”ç¼“å­˜é¡µçš„åœ°å€ã€‚\næè¿°å¦‚å›¾æ‰€ç¤ºï¼š\n\nç£ç›˜æ•°æ®é¡µè¯»å–åˆ° Buffer Pool çš„ç¼“å­˜é¡µçš„è¿‡ç¨‹\n\né¦–å…ˆï¼ŒSQL è¿›æ¥æ—¶ï¼Œåˆ¤æ–­æ•°æ®å¯¹åº”çš„æ•°æ®é¡µèƒ½å¦åœ¨ æ•°æ®é¡µç¼“å­˜å“ˆå¸Œè¡¨é‡Œ æ‰¾åˆ°å¯¹åº”çš„ç¼“å­˜é¡µã€‚\nå¦‚æœæ‰¾åˆ°ï¼Œå°†ç›´æ¥åœ¨ Buffer Pool ä¸­è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚\nå¦‚æœæ‰¾ä¸åˆ°ï¼Œåˆ™ä» free é“¾è¡¨ä¸­æ‰¾åˆ°ä¸€ä¸ªç©ºé—²çš„ç¼“å­˜é¡µï¼Œç„¶åä»ç£ç›˜æ–‡ä»¶ä¸­è¯»å–å¯¹åº”çš„æ•°æ®é¡µçš„æ•°æ®åˆ°ç¼“å­˜é¡µä¸­ï¼Œå¹¶ä¸”å°†æ•°æ®é¡µçš„ä¿¡æ¯å’Œç¼“å­˜é¡µçš„åœ°å€å†™å…¥åˆ°å¯¹åº”çš„æè¿°æ•°æ®å—ä¸­ï¼Œç„¶åä¿®æ”¹ç›¸å…³çš„æè¿°æ•°æ®å—çš„ free_pre æŒ‡é’ˆå’Œ free_next æŒ‡é’ˆï¼Œå°†ä½¿ç”¨äº†çš„æè¿°æ•°æ®å—ä» free é“¾è¡¨ä¸­ç§»é™¤ã€‚è®°å¾—ï¼Œè¿˜è¦åœ¨æ•°æ®é¡µç¼“å­˜å“ˆå¸Œè¡¨ä¸­å†™å…¥å¯¹åº”çš„ key-value å¯¹ã€‚æœ€åä¹Ÿæ˜¯åœ¨ Buffer Pool ä¸­è¿›è¡Œå¢åˆ æ”¹æŸ¥ã€‚\n\n3. LRU é“¾è¡¨å’ŒFlushé“¾è¡¨çš„åŒºåˆ«\nLRU é“¾è¡¨ flushï¼Œç”±ç”¨æˆ·çº¿ç¨‹è§¦å‘(MySQL 5.6.2ä¹‹å‰)ï¼›è€ŒFlush é“¾è¡¨ flushç”±MySQLæ•°æ®åº“InnoDBå­˜å‚¨å¼•æ“åå°srv_masterçº¿ç¨‹å¤„ç†ã€‚(åœ¨MySQL 5.6.2ä¹‹åï¼Œéƒ½è¢«è¿ç§»åˆ°Page Cleanerçº¿ç¨‹ä¸­)ã€‚\nLRU é“¾è¡¨ flushï¼Œå…¶ç›®çš„æ˜¯ä¸ºäº†å†™å‡ºLRU é“¾è¡¨å°¾éƒ¨çš„è„é¡µï¼Œé‡Šæ”¾è¶³å¤Ÿçš„ç©ºé—²é¡µï¼Œå½“Buffer Poolæ»¡çš„æ—¶å€™ï¼Œç”¨æˆ·å¯ä»¥ç«‹å³è·å¾—ç©ºé—²é¡µé¢ï¼Œè€Œä¸éœ€è¦é•¿æ—¶é—´ç­‰å¾…ï¼›Flush é“¾è¡¨ flushï¼Œå…¶ç›®çš„æ˜¯æ¨è¿›Checkpoint LSNï¼Œä½¿å¾—InnoDBç³»ç»Ÿå´©æºƒä¹‹åèƒ½å¤Ÿå¿«é€Ÿçš„æ¢å¤ã€‚\nLRU é“¾è¡¨ flushï¼Œå…¶å†™å‡ºçš„è„é¡µï¼Œéœ€è¦ä»LRUé“¾è¡¨ä¸­åˆ é™¤ï¼Œç§»åŠ¨åˆ°Free é“¾è¡¨ã€‚Flush List flushï¼Œä¸éœ€è¦ç§»åŠ¨pageåœ¨LRUé“¾è¡¨ä¸­çš„ä½ç½®ã€‚\nLRU é“¾è¡¨ flushï¼Œæ¯æ¬¡flushçš„è„é¡µæ•°é‡è¾ƒå°‘ï¼ŒåŸºæœ¬å›ºå®šï¼Œåªè¦é‡Šæ”¾ä¸€å®šçš„ç©ºé—²é¡µå³å¯ï¼›Flush é“¾è¡¨ flushï¼Œæ ¹æ®å½“å‰ç³»ç»Ÿçš„æ›´æ–°ç¹å¿™ç¨‹åº¦ï¼ŒåŠ¨æ€è°ƒæ•´ä¸€æ¬¡flushçš„è„é¡µæ•°é‡ï¼Œé‡å¾ˆå¤§ã€‚\nåœ¨Flush é“¾è¡¨ä¸Šçš„é¡µé¢ä¸€å®šåœ¨LRU é“¾è¡¨ä¸Šï¼Œåä¹‹åˆ™ä¸æˆç«‹ã€‚\n\n4. è§¦å‘åˆ·è„é¡µçš„æ¡ä»¶\nREDOæ—¥å¿—å¿«ç”¨æ»¡çš„æ—¶å€™ã€‚ç”±äºMySQLæ›´æ–°æ˜¯å…ˆå†™REDOæ—¥å¿—ï¼Œåé¢å†å°†æ•°æ®Flushåˆ°ç£ç›˜ï¼Œå¦‚æœREDOæ—¥å¿—å¯¹åº”è„æ•°æ®è¿˜æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜å°±è¢«è¦†ç›–çš„è¯ï¼Œä¸‡ä¸€å‘ç”ŸCrashï¼Œæ•°æ®å°±æ— æ³•æ¢å¤äº†ã€‚æ­¤æ—¶ä¼šä»Flush é“¾è¡¨é‡Œé¢é€‰å–è„é¡µï¼Œè¿›è¡ŒFlushã€‚\nä¸ºäº†ä¿è¯MySQLä¸­çš„ç©ºé—²é¡µé¢çš„æ•°é‡ï¼ŒPage Cleanerçº¿ç¨‹ä¼šä»LRU é“¾è¡¨å°¾éƒ¨æ·˜æ±°ä¸€éƒ¨åˆ†é¡µé¢ä½œä¸ºç©ºé—²é¡µã€‚å¦‚æœå¯¹åº”çš„é¡µé¢æ˜¯è„é¡µçš„è¯ï¼Œå°±éœ€è¦å…ˆå°†é¡µé¢Flushåˆ°ç£ç›˜ã€‚\nMySQLä¸­è„é¡µå¤ªå¤šçš„æ—¶å€™ã€‚innodb_max_dirty_pages_pct è¡¨ç¤ºçš„æ˜¯Buffer Poolæœ€å¤§çš„è„é¡µæ¯”ä¾‹ï¼Œé»˜è®¤å€¼æ˜¯75%ï¼Œå½“è„é¡µæ¯”ä¾‹å¤§äºè¿™ä¸ªå€¼æ—¶ä¼šå¼ºåˆ¶è¿›è¡Œåˆ·è„é¡µï¼Œä¿è¯ç³»ç»Ÿæœ‰è¶³å¤Ÿå¯ç”¨çš„Free Pageã€‚innodb_max_dirty_pages_pct_lwmå‚æ•°æ§åˆ¶çš„æ˜¯è„é¡µæ¯”ä¾‹çš„ä½æ°´ä½ï¼Œå½“è¾¾åˆ°è¯¥å‚æ•°è®¾å®šçš„æ—¶å€™ï¼Œä¼šè¿›è¡Œpreflushï¼Œé¿å…æ¯”ä¾‹è¾¾åˆ°innodb_max_dirty_pages_pct æ¥å¼ºåˆ¶Flushï¼Œå¯¹MySQLå®ä¾‹äº§ç”Ÿå½±å“ã€‚\nMySQLå®ä¾‹æ­£å¸¸å…³é—­çš„æ—¶å€™ï¼Œä¹Ÿä¼šè§¦å‘MySQLæŠŠå†…å­˜é‡Œé¢çš„è„é¡µå…¨éƒ¨åˆ·æ–°åˆ°ç£ç›˜ã€‚\n\nInnodb çš„ç­–ç•¥æ˜¯åœ¨è¿è¡Œè¿‡ç¨‹ä¸­å°½å¯èƒ½çš„å¤šå ç”¨å†…å­˜ï¼Œå› æ­¤æœªè¢«ä½¿ç”¨çš„é¡µé¢ä¼šå¾ˆå°‘ã€‚å½“æˆ‘ä»¬è¯»å–çš„æ•°æ®ä¸åœ¨Buffer Poolé‡Œé¢æ—¶ï¼Œå°±éœ€è¦ç”³è¯·ä¸€ä¸ªç©ºé—²é¡µæ¥å­˜æ”¾ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—²é¡µæ—¶ï¼Œå°±å¿…é¡»ä»LRU é“¾è¡¨çš„å°¾éƒ¨æ·˜æ±°é¡µé¢ã€‚å¦‚æœè¯¥é¡µé¢æ˜¯å¹²å‡€çš„ï¼Œå¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ï¼Œå¦‚æœæ˜¯è„é¡µï¼Œå°±éœ€è¦è¿›è¡Œåˆ·è„æ“ä½œï¼Œå°†å†…å­˜æ•°æ®Flushåˆ°ç£ç›˜ã€‚\næ‰€ä»¥ï¼Œå¦‚æœå‡ºç°ä»¥ä¸‹æƒ…å†µï¼Œæ˜¯å¾ˆå®¹æ˜“å½±å“MySQLå®ä¾‹çš„æ€§èƒ½ï¼š\n\nä¸€ä¸ªSQLæŸ¥è¯¢çš„æ•°æ®é¡µéœ€è¦æ·˜æ±°çš„é¡µé¢è¿‡å¤š\nå®ä¾‹æ˜¯ä¸ªå†™å¤šå‹çš„MySQLï¼Œcheckpointè·Ÿä¸ä¸Šæ—¥å¿—äº§ç”Ÿé‡ï¼Œä¼šå¯¼è‡´æ›´æ–°å…¨éƒ¨å µå¡ï¼ŒTPSè·Œ0ã€‚\n\ninnodb_io_capacity å‚æ•°å®šä¹‰äº†Innodb åå°ä»»åŠ¡çš„IOèƒ½åŠ›ï¼Œä¾‹å¦‚åˆ·è„æ“ä½œè¿˜æœ‰Change Bufferçš„mergeæ“ä½œç­‰ã€‚\nInnodb çš„ä¸‰ç§Pageå’Œé“¾è¡¨çš„è®¾è®¡ï¼Œä¿è¯äº†æˆ‘ä»¬éœ€è¦çš„çƒ­æ•°æ®å¸¸é©»åœ¨å†…å­˜ï¼ŒåŠæ—¶æ·˜æ±°ä¸éœ€è¦çš„æ•°æ®ï¼Œæå‡äº†æˆ‘ä»¬çš„æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶ä¸åŒçš„åˆ·è„ç­–ç•¥ä¹Ÿæé«˜äº†æˆ‘ä»¬çš„æ¢å¤é€Ÿåº¦ï¼Œä¿è¯äº†æ•°æ®å®‰å…¨ã€‚\n","categories":["MySQL"]},{"title":"ä»€ä¹ˆæ˜¯ Change Data Capture ï¼Ÿ","url":"/posts/33848/","content":"Change Data Capture (ç¼©å†™ä¸º CDC)â€”â€” å¤§æ¦‚å¯ä»¥æœºç¿»ä¸º â€œå˜åŠ¨æ•°æ®æ•è·â€â€”â€” ä½ å¯ä»¥å°†å®ƒè§†ä¸ºå’Œæ•°æ®åº“æœ‰å…³çš„æ¶æ„è®¾è®¡æ¨¡å¼çš„ä¸€ç§ã€‚å®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œç›‘æµ‹å¹¶æ•è·æ•°æ®åº“çš„å˜åŠ¨ï¼ˆåŒ…æ‹¬æ•°æ®æˆ–æ•°æ®è¡¨çš„æ’å…¥ï¼Œæ›´æ–°ï¼Œåˆ é™¤ç­‰ï¼‰ï¼Œå°†è¿™äº›å˜æ›´æŒ‰å‘ç”Ÿçš„é¡ºåºå®Œæ•´è®°å½•ä¸‹æ¥ï¼Œå†™å…¥åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä¸­ä»¥ä¾›å…¶ä»–æœåŠ¡è¿›è¡Œè®¢é˜…åŠæ¶ˆè´¹ã€‚\nä¸€ã€é€‚ç”¨åœºæ™¯æˆ‘ä»¬å¯ä»¥æŠŠ CDC è®¤ä¸ºæ˜¯æ•°æ®åº“äº‹ä»¶é©±åŠ¨çš„ä¸€ç§æ•°æ® / ä¿¡æ¯åˆ†å‘ç³»ç»Ÿï¼ŒCDC ä¸»è¦é€‚ç”¨äºä»¥ä¸‹çš„åœºæ™¯ï¼š\nå¼‚æ„æ•°æ®åº“ä¹‹é—´çš„æ•°æ®åŒæ­¥æˆ–å¤‡ä»½ / å»ºç«‹æ•°æ®åˆ†æè®¡ç®—å¹³å°åœ¨ MySQLï¼ŒPostgreSQLï¼ŒMongoDB ç­‰ç­‰æ•°æ®åº“ä¹‹é—´äº’ç›¸åŒæ­¥æ•°æ®ï¼Œæˆ–è€…æŠŠè¿™äº›æ•°æ®åº“çš„æ•°æ®åŒæ­¥åˆ° Elasticsearch é‡Œä»¥ä¾›å…¨æ–‡æœç´¢ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥åŸºäº CDC å¯¹æ•°æ®åº“è¿›è¡Œå¤‡ä»½ã€‚è€Œæ•°æ®åˆ†æç³»ç»Ÿå¯ä»¥é€šè¿‡è®¢é˜…æ„Ÿå…´è¶£çš„æ•°æ®è¡¨çš„å˜æ›´ï¼Œæ¥è·å–æ‰€éœ€è¦çš„åˆ†ææ•°æ®è¿›è¡Œå¤„ç†ï¼Œä¸éœ€è¦æŠŠåˆ†ææµç¨‹åµŒå…¥åˆ°å·²æœ‰ç³»ç»Ÿä¸­ï¼Œä»¥å®ç°è§£è€¦ã€‚\n\nå¾®æœåŠ¡ä¹‹é—´å…±äº«æ•°æ®çŠ¶æ€åœ¨å¾®æœåŠ¡å¤§è¡Œå…¶é“çš„ä»Šæ—¥ï¼Œå¾®æœåŠ¡ä¹‹é—´ä¿¡æ¯å…±äº«ä¸€ç›´æ¯”è¾ƒå¤æ‚ï¼ŒCDC ä¹Ÿæ˜¯ä¸€ç§å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼Œå¾®æœåŠ¡å¯ä»¥é€šè¿‡ CDC æ¥è·å–å…¶ä»–å¾®æœåŠ¡æ•°æ®åº“çš„å˜æ›´ï¼Œä»è€Œè·å–æ•°æ®çš„çŠ¶æ€æ›´æ–°ï¼Œæ‰§è¡Œè‡ªå·±ç›¸åº”çš„é€»è¾‘ã€‚\n\næ›´æ–°ç¼“å­˜ / CQRS çš„ Query è§†å›¾æ›´æ–°é€šå¸¸ç¼“å­˜æ›´æ–°éƒ½æ¯”è¾ƒéš¾æï¼Œå¯ä»¥é€šè¿‡ CDC æ¥è·å–æ•°æ®åº“çš„æ•°æ®æ›´æ–°äº‹ä»¶ï¼Œä»è€Œæ§åˆ¶å¯¹ç¼“å­˜çš„åˆ·æ–°æˆ–å¤±æ•ˆã€‚\nè€Œ CQRS æ˜¯ä»€ä¹ˆåˆæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ï¼Œç®€å•æ¥è®²ï¼Œä½ å¯ä»¥æŠŠ CQRS ç†è§£ä¸ºä¸€ç§é«˜é…ç‰ˆçš„è¯»å†™åˆ†ç¦»çš„è®¾è®¡æ¨¡å¼ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å‰é¢è®²äº†å¯ä»¥åˆ©ç”¨ CDC å°† MySQL çš„æ•°æ®åŒæ­¥åˆ° Elasticsearch ä¸­ä»¥ä¾›æœç´¢ï¼Œåœ¨è¿™æ ·çš„æ¶æ„é‡Œï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½ç”¨ ES æ¥æŸ¥ï¼Œä½†åœ¨æƒ³ä¿®æ”¹æ•°æ®æ—¶ï¼Œå¹¶ä¸ç›´æ¥ä¿®æ”¹ ES é‡Œçš„æ•°æ®ï¼Œè€Œæ˜¯ä¿®æ”¹ä¸Šæ¸¸çš„ MySQL æ•°æ®ï¼Œä½¿ä¹‹äº§ç”Ÿæ•°æ®æ›´æ–°äº‹ä»¶ï¼Œäº‹ä»¶è¢«æ¶ˆè´¹è€…æ¶ˆè´¹æ¥æ›´æ–° ES ä¸­çš„æ•°æ®ï¼Œè¿™å°±åŸºæœ¬ä¸Šæ˜¯ä¸€ç§ CQRS æ¨¡å¼ã€‚è€Œåœ¨å…¶ä»– CQRS çš„ç³»ç»Ÿä¸­ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ç±»ä¼¼çš„æ–¹å¼æ¥æ›´æ–°æŸ¥è¯¢è§†å›¾ã€‚\n\näºŒã€æ•´ä½“æ¶æ„æ•°æ®æºæ•°æ®åº“ï¼ˆå³æ•°æ®æºï¼‰éœ€è¦èƒ½å®Œæ•´åœ°è®°å½•æˆ–è¾“å‡ºæ•°æ®åº“çš„äº‹ä»¶ï¼ˆæ•°æ®æˆ–æ•°æ®è¡¨çš„å˜åŠ¨ï¼‰ã€‚ä¾‹å¦‚ MySQL çš„ binlogï¼ŒMySQL é€šè¿‡ binlogï¼ˆäºŒè¿›åˆ¶æ—¥å¿—ï¼‰è®°å½•æ•°æ®åº“çš„å˜åŠ¨äº‹ä»¶ï¼Œè€Œ MySQL æœ¬èº«å¯ä»¥å€ŸåŠ© binlog æ¥å®ç°ä¸»ä»å¤åˆ¶ã€‚å…¶å® CDC æœ¬èº«ä¹Ÿåªæ˜¯æŠŠè¿™ç§æœºåˆ¶æ‰©å±•äº†ä¸€ä¸‹ï¼Œä½¿ä¹‹èƒ½å¤Ÿä½œä¸ºæ›´å¹¿æ³›çš„ç”¨é€”ã€‚\nå¤§éƒ¨åˆ†æ•°æ®åº“éƒ½æœ‰ç±»ä¼¼çš„æœºåˆ¶ï¼š\n\nMySQL: binlog\nPostgreSQL: Streaming Replication Protocol\nMongoDB: oplogç­‰ç­‰ã€‚\n\nå‘å¸ƒæœåŠ¡ï¼ˆç”Ÿäº§è€…ï¼‰è¿™ä¸œè¥¿ç°åœ¨æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„åç§°ï¼Œè¿™é‡Œå°±æš‚ä¸”ç§°ä¸ºå‘å¸ƒæœåŠ¡ã€‚å®ƒçš„åŠŸèƒ½æ˜¯è§£ææ•°æ®æºè¾“å‡ºçš„æµå¼æ•°æ®ï¼Œåºåˆ—åŒ–æˆç»Ÿä¸€çš„å°è£…æ ¼å¼ï¼Œå¹¶è¾“å‡ºåˆ°æ•°æ®æ€»çº¿ä¸­ã€‚\nMaxwellzendesk/maxwellï¼Œä¸“ä¸º MySQL æ•°æ®æºä½¿ç”¨ï¼Œå®ƒèƒ½å¤Ÿè¯»å– binlogï¼Œå°†æ•°æ®åº“å˜æ›´åºåˆ—åŒ–ä¸º JSONï¼Œè¾“å‡ºåˆ° Kafka, Kinesis, RabbitMQ, Google Cloud Pub/Sub, Redis ç­‰æ¶ˆæ¯é˜Ÿåˆ—ä¸­ã€‚å®ƒè¿˜æä¾›äº† bootstrap å‘½ä»¤ï¼Œæ”¯æŒå°†æŸå¼ è¡¨å…¨é‡æ•°æ®è¾“å‡ºä½œä¸ºèµ·å§‹æ•°æ®ã€‚\nDebeziumdebezium/debeziumï¼Œç›®å‰æ”¯æŒç›‘å¬ MySQLï¼ŒMongoDBï¼ŒPostgreSQLï¼ŒOracleï¼ŒSQL Server ç­‰æ•°æ®åº“çš„å˜åŒ–ï¼Œä½†æ¶ˆæ¯ä¸­é—´ä»¶åªèƒ½ä½¿ç”¨ Kafkaã€‚å®ƒçš„æ•°æ®äº¤æ¢é»˜è®¤é‡‡ç”¨ Avro æ ¼å¼ï¼Œè¿™ç§æ ¼å¼å¯¹æ•°æ® schema çš„å˜æ›´æ¯”è¾ƒå‹å¥½ã€‚ç›®å‰è¿˜å¤„åœ¨å¼€å‘é˜¶æ®µï¼Œæ‰€ä»¥æ–‡æ¡£ä¸æ˜¯ç‰¹åˆ«å®Œå–„ï¼Œä½†ä¼¼ä¹å·²ç»æœ‰å‹‡æ•¢çš„å…¬å¸ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒä¸­äº†ã€‚\ncanalalibaba/canalï¼Œå®ƒèƒ½è§£æ binlog å¹¶è¾“å‡ºï¼Œå¯ä»¥åˆ©ç”¨å®ƒæä¾›çš„ client æ¥å®ç°è‡ªå·±çš„è®¢é˜…æ¶ˆè´¹é€»è¾‘ï¼Œä½†è¿™ä¸ªé¡¹ç›®ä¸æ¶‰åŠåˆ°è¾“å‡ºåˆ°é€šç”¨çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œå› æ­¤é€‚ç”¨èŒƒå›´è¾ƒçª„ã€‚æœ€è¿‘çœ‹äº†ä¸€ä¸‹å‘ç°æœ‰äº†æ›´æ–°ï¼Œæ”¯æŒè¾“å‡ºåˆ° kafkaï¼Œç”šè‡³è¿˜å¸¦ä¸€äº›ç›‘æ§åŠŸèƒ½ï¼Œçœ‹èµ·æ¥å¾ˆå¼ºã€‚\nè‡ªè¡Œå®ç°ä½ éœ€è¦çš„æ˜¯ä¸€ä¸ªèƒ½å¤Ÿè§£ææ•°æ®åº“è¾“å‡ºæµçš„åº“ï¼Œæ¯”å¦‚ noplay/python-mysql-replication è¿™ç§ï¼ŒåŸºäºè¿™æ ·çš„åº“æ¥å®ç°å‘å¸ƒæœåŠ¡ã€‚\næˆ‘æ›¾ç»å†™è¿‡ py-mysql-elasticsearch-sync è¿™æ ·ä¸€ä¸ªå·¥å…·ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³æŠŠ MySQL çš„æ•°æ®åŒæ­¥åˆ° Elasticsearch è¿™æ ·çš„ä»»åŠ¡ï¼Œå¯ä»¥æŠŠè¿™ä¸œè¥¿è§†ä¸ºå¼±é¸¡ç‰ˆçš„ CDCï¼ˆå› ä¸ºä¸­é—´æ²¡æœ‰é€šè¿‡æ•°æ®æ€»çº¿å‘å¸ƒï¼Œè€Œæ˜¯ç›´æ¥å†™å…¥ ES äº†ï¼‰ã€‚å…¶ä¸­å°±ä½¿ç”¨äº† python-mysql-replication è¿™ä¸ªåº“æ¥è·å–æ•°æ®åº“å˜æ›´ï¼Œå®ƒçš„åŸç†å°±æ˜¯å°†è‡ªå·±ä¼ªè£…æˆä¸€ä¸ª MySQL Slave æ•°æ®åº“ï¼Œé€šè¿‡è§£æ binlog è·å–æ•°æ®å˜æ›´çš„äº‹ä»¶ã€‚ï¼ˆå’Œ canal åŸç†ä¸Šå·®ä¸å¤šï¼‰\næ•°æ®æ€»çº¿ï¼ˆæ¶ˆæ¯ä¸­é—´ä»¶ï¼‰æ•°æ®æ€»çº¿è¿™éƒ¨åˆ†æ˜¯ä¸€ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¸€èˆ¬ä¼šé€‰ Kafkaï¼ŒRabbitMQï¼ŒRedis ä¹‹ç±»çš„ï¼Œä½†å¤§éƒ¨åˆ†åš CDC éƒ½ä¼šé€‰ç”¨ Kafkaã€‚\nKafka å®˜æ–¹å¹¶ä¸æŠŠè‡ªå·±ç§°ä¸ºæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè€Œæ˜¯å« â€œdistributed streaming platformâ€ï¼Œçš„ç¡®ï¼Œç›®å‰ kafka çš„èƒ½åŠ›ä»¥åŠæ¼”åŒ–æ–¹å‘æ›´åƒæ˜¯ä¸€ä¸ªæ•°æ®å¤„ç†çš„å¹³å°äº†ï¼Œè€Œä¸ä»…ä»…æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä½ å¯ä»¥åˆ©ç”¨ Kafka Streams æ¥è¿›è¡Œä¸€äº›æ•°æ®å¤„ç†ã€‚\nåœ¨æ•´ä¸ª CDC é‡Œï¼ŒKafka ä¼šä½œä¸ºæ ¸å¿ƒçš„æ•°æ®äº¤æ¢ç»„ä»¶ï¼Œæˆ–è€…ä½ å¯ä»¥æŠŠå®ƒç§°ä¸ºæ•°æ®æ€»çº¿ï¼Œkafka é›†ç¾¤çš„å¥å£®æ€§å’Œååé‡èƒ½å¤Ÿæ”¯æ’‘æµ·é‡æ•°æ®çš„ pub/subï¼Œå¹¶ä¸”èƒ½å¤Ÿå°†å†™å…¥çš„æ•°æ®æŒä¹…åŒ–ä¸€æ®µæ—¶é—´ï¼Œå‘å¸ƒæœåŠ¡å°†æ•°æ®åº“ä»»ä½•æ•°æ®å˜åŠ¨å†™å…¥ Kafkaï¼Œç”±ä¸åŒçš„æ¶ˆè´¹è€…åœ¨ä¸Šé¢åŒæ—¶è¿›è¡Œè®¢é˜…å’Œæ¶ˆè´¹ï¼Œå¦‚æœæœ‰éœ€è¦ï¼Œæ¶ˆè´¹è€…éšæ—¶å¯ä»¥æŠŠè‡ªå·±çš„ offset å¾€å‰è°ƒï¼Œå¯¹ä»¥å¾€çš„æ¶ˆæ¯é‡æ–°æ¶ˆè´¹ã€‚\næ¶ˆè´¹è€…æ¶ˆè´¹è€…éƒ¨åˆ†æ ¹æ®åœºæ™¯è€Œä¸åŒï¼Œé€šå¸¸åªè¦ä½¿ç”¨ç›¸åº”æ¶ˆæ¯é˜Ÿåˆ—çš„å®¢æˆ·ç«¯åº“å®ç°æ¶ˆè´¹è€…ï¼Œæ ¹æ®ç”Ÿäº§è€…ç”Ÿæˆçš„æ¶ˆæ¯æ ¼å¼è¿›è¡Œè§£æå¤„ç†å³å¯ï¼Œä¾‹å¦‚ä½ ç”¨ Kafka ä½œä¸ºé˜Ÿåˆ—ï¼Œé‚£ä¹ˆåœ¨ Python ä¸­å¯ä»¥ç”¨ confluentinc/confluent-kafka-python ä¹‹ç±»çš„åº“æ¥è¿›è¡Œå®ç°ã€‚è€Œéœ€æ±‚æ¯”è¾ƒç®€å•çš„è¯å¯ä»¥ä½¿ç”¨ç›´æ¥ç°æˆçš„å¼€æºå·¥å…·ï¼Œæ¯”å¦‚ Kafka çš„ä¸€äº› Sink Connectorsã€‚\nå¦‚æœæœ‰ç‰¹æ®Šçš„éœ€æ±‚ï¼Œå¯ä»¥è‡ªè¡Œå®ç°ç±»ä¼¼çš„ç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…ï¼ˆæˆ–è€…å€ŸåŠ©å·²æœ‰çš„å·¥å…·è¿›è¡Œæ”¹é€ ï¼‰ï¼Œå°†æ•°æ®å˜åŠ¨é€šè¿‡ Kafka ä¹‹ç±»çš„æ¶ˆæ¯æ€»çº¿è¿›è¡Œå‘å¸ƒï¼Œæ¥è‡ªå®šä¹‰è‡ªå·±çš„ CDC ç³»ç»Ÿã€‚\n","categories":["MySQL"]},{"title":"åº–ä¸è§£InnoDBä¹‹REDO LOG","url":"/posts/59699/","content":"æ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶çš„å‰ä¸–ä»Šç”Ÿä¸­ä»‹ç»äº†ï¼Œç£ç›˜æ•°æ®åº“ä¸ºäº†åœ¨ä¿è¯æ•°æ®åº“çš„åŸå­æ€§(A, Atomic) å’ŒæŒä¹…æ€§(D, Durability)çš„åŒæ—¶ï¼Œè¿˜èƒ½ä»¥çµæ´»çš„åˆ·ç›˜ç­–ç•¥æ¥å……åˆ†åˆ©ç”¨ç£ç›˜é¡ºåºå†™çš„æ€§èƒ½ï¼Œä¼šè®°å½•REDOå’ŒUNDOæ—¥å¿—ï¼Œå³ARIESæ–¹æ³•ã€‚æœ¬æ–‡å°†é‡ç‚¹ä»‹ç»REDO LOGçš„ä½œç”¨ï¼Œè®°å½•çš„å†…å®¹ï¼Œç»„ç»‡ç»“æ„ï¼Œå†™å…¥æ–¹å¼ç­‰å†…å®¹ï¼Œå¸Œæœ›è¯»è€…èƒ½å¤Ÿæ›´å…¨é¢å‡†ç¡®çš„ç†è§£REDO LOGåœ¨InnoDBä¸­çš„ä½ç½®ã€‚æœ¬æ–‡åŸºäºMySQL 8.0ä»£ç ã€‚\n1. ä¸ºä»€ä¹ˆéœ€è¦è®°å½•REDOä¸ºäº†å–å¾—æ›´å¥½çš„è¯»å†™æ€§èƒ½ï¼ŒInnoDBä¼šå°†æ•°æ®ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ˆInnoDB Buffer Poolï¼‰ï¼Œå¯¹ç£ç›˜æ•°æ®çš„ä¿®æ”¹ä¹Ÿä¼šè½åäºå†…å­˜ï¼Œè¿™æ—¶å¦‚æœè¿›ç¨‹æˆ–æœºå™¨å´©æºƒï¼Œä¼šå¯¼è‡´å†…å­˜æ•°æ®ä¸¢å¤±ï¼Œä¸ºäº†ä¿è¯æ•°æ®åº“æœ¬èº«çš„ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ï¼ŒInnoDBç»´æŠ¤äº†REDO LOGã€‚ä¿®æ”¹Pageä¹‹å‰éœ€è¦å…ˆå°†ä¿®æ”¹çš„å†…å®¹è®°å½•åˆ°REDOä¸­ï¼Œå¹¶ä¿è¯REDO LOGæ—©äºå¯¹åº”çš„Pageè½ç›˜ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„WALï¼ŒWrite Ahead Logã€‚å½“æ•…éšœå‘ç”Ÿå¯¼è‡´å†…å­˜æ•°æ®ä¸¢å¤±åï¼ŒInnoDBä¼šåœ¨é‡å¯æ—¶ï¼Œé€šè¿‡é‡æ”¾REDOï¼Œå°†Pageæ¢å¤åˆ°å´©æºƒå‰çš„çŠ¶æ€ã€‚\n2. éœ€è¦ä»€ä¹ˆæ ·çš„REDOé‚£ä¹ˆæˆ‘ä»¬éœ€è¦ä»€ä¹ˆæ ·çš„REDOå‘¢ï¼Ÿé¦–å…ˆï¼ŒREDOçš„ç»´æŠ¤å¢åŠ äº†ä¸€ä»½å†™ç›˜æ•°æ®ï¼ŒåŒæ—¶ä¸ºäº†ä¿è¯æ•°æ®æ­£ç¡®ï¼Œäº‹åŠ¡åªæœ‰åœ¨ä»–çš„REDOå…¨éƒ¨è½ç›˜æ‰èƒ½è¿”å›ç”¨æˆ·æˆåŠŸï¼ŒREDOçš„å†™ç›˜æ—¶é—´ä¼šç›´æ¥å½±å“ç³»ç»Ÿååï¼Œæ˜¾è€Œæ˜“è§ï¼ŒREDOçš„æ•°æ®é‡è¦å°½é‡å°‘ã€‚å…¶æ¬¡ï¼Œç³»ç»Ÿå´©æºƒæ€»æ˜¯å‘ç”Ÿåœ¨å§‹æ–™æœªåŠçš„æ—¶å€™ï¼Œå½“é‡å¯é‡æ”¾REDOæ—¶ï¼Œç³»ç»Ÿå¹¶ä¸çŸ¥é“å“ªäº›REDOå¯¹åº”çš„Pageå·²ç»è½ç›˜ï¼Œå› æ­¤REDOçš„é‡æ”¾å¿…é¡»å¯é‡å…¥ï¼Œå³REDOæ“ä½œè¦ä¿è¯å¹‚ç­‰ã€‚æœ€åï¼Œä¸ºäº†ä¾¿äºé€šè¿‡å¹¶å‘é‡æ”¾çš„æ–¹å¼åŠ å¿«é‡å¯æ¢å¤é€Ÿåº¦ï¼ŒREDOåº”è¯¥æ˜¯åŸºäºPageçš„ï¼Œå³ä¸€ä¸ªREDOåªæ¶‰åŠä¸€ä¸ªPageçš„ä¿®æ”¹ã€‚\nç†Ÿæ‚‰çš„è¯»è€…ä¼šå‘ç°ï¼Œæ•°æ®é‡å°æ˜¯Logical Loggingçš„ä¼˜ç‚¹ï¼Œè€Œå¹‚ç­‰ä»¥åŠåŸºäºPageæ­£æ˜¯Physical Loggingçš„ä¼˜ç‚¹ï¼Œå› æ­¤InnoDBé‡‡å–äº†ä¸€ç§ç§°ä¸ºPhysiological Loggingçš„æ–¹å¼ï¼Œæ¥å…¼å¾—äºŒè€…çš„ä¼˜åŠ¿ã€‚æ‰€è°“Physiological Loggingï¼Œå°±æ˜¯ä»¥Pageä¸ºå•ä½ï¼Œä½†åœ¨Pageå†…ä»¥é€»è¾‘çš„æ–¹å¼è®°å½•ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒMLOG_REC_UPDATE_IN_PLACEç±»å‹çš„REDOä¸­è®°å½•äº†å¯¹Pageä¸­ä¸€ä¸ªRecordçš„ä¿®æ”¹ï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š\n\nï¼ˆPage IDï¼ŒRecord Offsetï¼Œ(Filed 1, Value 1) â€¦ (Filed i, Value i) â€¦ )\n\nå…¶ä¸­ï¼ŒPageIDæŒ‡å®šè¦æ“ä½œçš„Pageé¡µï¼ŒRecord Offsetè®°å½•äº†Recordåœ¨Pageå†…çš„åç§»ä½ç½®ï¼Œåé¢çš„Fieldæ•°ç»„ï¼Œè®°å½•äº†éœ€è¦ä¿®æ”¹çš„Fieldä»¥åŠä¿®æ”¹åçš„Valueã€‚\nç”±äºPhysiological Loggingçš„æ–¹å¼é‡‡ç”¨äº†ç‰©ç†Pageä¸­çš„é€»è¾‘è®°æ³•ï¼Œå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š\n1ï¼Œéœ€è¦åŸºäºæ­£ç¡®çš„PageçŠ¶æ€ä¸Šé‡æ”¾REDO\nç”±äºåœ¨ä¸€ä¸ªPageå†…ï¼ŒREDOæ˜¯ä»¥é€»è¾‘çš„æ–¹å¼è®°å½•äº†å‰åä¸¤æ¬¡çš„ä¿®æ”¹ï¼Œå› æ­¤é‡æ”¾REDOå¿…é¡»åŸºäºæ­£ç¡®çš„PageçŠ¶æ€ã€‚ç„¶è€ŒInnoDBé»˜è®¤çš„Pageå¤§å°æ˜¯16KBï¼Œæ˜¯å¤§äºæ–‡ä»¶ç³»ç»Ÿèƒ½ä¿è¯åŸå­çš„4KBå¤§å°çš„ï¼Œå› æ­¤å¯èƒ½å‡ºç°Pageå†…å®¹æˆåŠŸä¸€åŠçš„æƒ…å†µã€‚InnoDBä¸­é‡‡ç”¨äº†Double Write Bufferçš„æ–¹å¼æ¥é€šè¿‡å†™ä¸¤æ¬¡çš„æ–¹å¼ä¿è¯æ¢å¤çš„æ—¶å€™æ‰¾åˆ°ä¸€ä¸ªæ­£ç¡®çš„PageçŠ¶æ€ã€‚è¿™éƒ¨åˆ†ä¼šåœ¨ä¹‹åä»‹ç»Buffer Poolçš„æ—¶å€™è¯¦ç»†ä»‹ç»ã€‚\n2ï¼Œéœ€è¦ä¿è¯REDOé‡æ”¾çš„å¹‚ç­‰\nDouble Write Bufferèƒ½å¤Ÿä¿è¯æ‰¾åˆ°ä¸€ä¸ªæ­£ç¡®çš„PageçŠ¶æ€ï¼Œæˆ‘ä»¬è¿˜éœ€è¦çŸ¥é“è¿™ä¸ªçŠ¶æ€å¯¹åº”REDOä¸Šçš„å“ªä¸ªè®°å½•ï¼Œæ¥é¿å…å¯¹Pageçš„é‡å¤ä¿®æ”¹ã€‚ä¸ºæ­¤ï¼ŒInnoDBç»™æ¯ä¸ªREDOè®°å½•ä¸€ä¸ªå…¨å±€å”¯ä¸€é€’å¢çš„æ ‡å·**LSN(Log Sequence Number)**ã€‚Pageåœ¨ä¿®æ”¹æ—¶ï¼Œä¼šå°†å¯¹åº”çš„REDOè®°å½•çš„LSNè®°å½•åœ¨Pageä¸Šï¼ˆFIL_PAGE_LSNå­—æ®µï¼‰ï¼Œè¿™æ ·æ¢å¤é‡æ”¾REDOæ—¶ï¼Œå°±å¯ä»¥æ¥åˆ¤æ–­è·³è¿‡å·²ç»åº”ç”¨çš„REDOï¼Œä»è€Œå®ç°é‡æ”¾çš„å¹‚ç­‰ã€‚\n3. REDOä¸­è®°å½•äº†ä»€ä¹ˆå†…å®¹çŸ¥é“äº†InnoDBä¸­è®°å½•REDOçš„æ–¹å¼ï¼Œé‚£ä¹ˆREDOé‡Œå…·ä½“ä¼šè®°å½•å“ªäº›å†…å®¹å‘¢ï¼Ÿä¸ºäº†åº”å¯¹InnoDBå„ç§å„æ ·ä¸åŒçš„éœ€æ±‚ï¼Œåˆ°MySQL 8.0ä¸ºæ­¢ï¼Œå·²ç»æœ‰å¤šè¾¾65ç§çš„REDOè®°å½•ã€‚ç”¨æ¥è®°å½•è¿™ä¸åŒçš„ä¿¡æ¯ï¼Œæ¢å¤æ—¶éœ€è¦åˆ¤æ–­ä¸åŒçš„REDOç±»å‹ï¼Œæ¥åšå¯¹åº”çš„è§£æã€‚æ ¹æ®REDOè®°å½•ä¸åŒçš„ä½œç”¨å¯¹è±¡ï¼Œå¯ä»¥å°†è¿™65ä¸­REDOåˆ’åˆ†ä¸ºä¸‰ä¸ªå¤§ç±»ï¼šä½œç”¨äºPageï¼Œä½œç”¨äºSpaceä»¥åŠæä¾›é¢å¤–ä¿¡æ¯çš„Logicç±»å‹ã€‚\n1ï¼Œä½œç”¨äºPageçš„REDO\nè¿™ç±»REDOå æ‰€æœ‰REDOç±»å‹çš„ç»å¤§å¤šæ•°ï¼Œæ ¹æ®ä½œç”¨çš„Pageçš„ä¸åŒç±»å‹åˆå¯ä»¥ç»†åˆ†ä¸ºï¼ŒIndex Page REDOï¼ŒUndo Page REDOï¼ŒRtree PageREDOç­‰ã€‚æ¯”å¦‚MLOG_REC_INSERTï¼ŒMLOG_REC_UPDATE_IN_PLACEï¼ŒMLOG_REC_DELETEä¸‰ç§ç±»å‹åˆ†åˆ«å¯¹åº”äºPageä¸­è®°å½•çš„æ’å…¥ï¼Œä¿®æ”¹ä»¥åŠåˆ é™¤ã€‚è¿™é‡Œè¿˜æ˜¯ä»¥MLOG_REC_UPDATE_IN_PLACEä¸ºä¾‹æ¥çœ‹çœ‹å…¶ä¸­å…·ä½“çš„å†…å®¹ï¼š\n\nå…¶ä¸­ï¼ŒTypeå°±æ˜¯MLOG_REC_UPDATE_IN_PLACEç±»å‹ï¼ŒSpace IDå’ŒPage Numberå”¯ä¸€æ ‡è¯†ä¸€ä¸ªPageé¡µï¼Œè¿™ä¸‰é¡¹æ˜¯æ‰€æœ‰REDOè®°å½•éƒ½éœ€è¦æœ‰çš„å¤´ä¿¡æ¯ï¼Œåé¢çš„æ˜¯MLOG_REC_UPDATE_IN_PLACEç±»å‹ç‹¬æœ‰çš„ï¼Œå…¶ä¸­Record Offsetç”¨ç»™å‡ºè¦ä¿®æ”¹çš„è®°å½•åœ¨Pageä¸­çš„ä½ç½®åç§»ï¼ŒUpdate Field Countè¯´æ˜è®°å½•é‡Œæœ‰å‡ ä¸ªFieldè¦ä¿®æ”¹ï¼Œç´§æ¥ç€å¯¹æ¯ä¸ªFieldç»™å‡ºäº†Fieldç¼–å·(Field Number)ï¼Œæ•°æ®é•¿åº¦ï¼ˆField Data Lengthï¼‰ä»¥åŠæ•°æ®ï¼ˆFiled Dataï¼‰ã€‚\n2ï¼Œä½œç”¨äºSpaceçš„REDO\nè¿™ç±»REDOé’ˆå¯¹ä¸€ä¸ªSpaceæ–‡ä»¶çš„ä¿®æ”¹ï¼Œå¦‚MLOG_FILE_CREATEï¼ŒMLOG_FILE_DELETEï¼ŒMLOG_FILE_RENAMEåˆ†åˆ«å¯¹åº”å¯¹ä¸€ä¸ªSpaceçš„åˆ›å»ºï¼Œåˆ é™¤ä»¥åŠé‡å‘½åã€‚ç”±äºæ–‡ä»¶æ“ä½œçš„REDOæ˜¯åœ¨æ–‡ä»¶æ“ä½œç»“æŸåæ‰è®°å½•çš„ï¼Œå› æ­¤åœ¨æ¢å¤çš„è¿‡ç¨‹ä¸­çœ‹åˆ°è¿™ç±»æ—¥å¿—æ—¶ï¼Œè¯´æ˜æ–‡ä»¶æ“ä½œå·²ç»æˆåŠŸï¼Œå› æ­¤åœ¨æ¢å¤è¿‡ç¨‹ä¸­å¤§å¤šåªæ˜¯åšå¯¹æ–‡ä»¶çŠ¶æ€çš„æ£€æŸ¥ï¼Œä»¥MLOG_FILE_CREATEæ¥çœ‹çœ‹å…¶ä¸­è®°å½•çš„å†…å®¹ï¼š\n\nåŒæ ·çš„å‰ä¸‰ä¸ªå­—æ®µè¿˜æ˜¯Typeï¼ŒSpace IDå’ŒPage Numberï¼Œç”±äºæ˜¯é’ˆå¯¹Pageçš„æ“ä½œï¼Œè¿™é‡Œçš„Page Numberæ°¸è¿œæ˜¯0ã€‚åœ¨æ­¤ä¹‹åè®°å½•äº†åˆ›å»ºçš„æ–‡ä»¶flagä»¥åŠæ–‡ä»¶åï¼Œç”¨ä½œé‡å¯æ¢å¤æ—¶çš„æ£€æŸ¥ã€‚\n3ï¼Œæä¾›é¢å¤–ä¿¡æ¯çš„Logic REDO\né™¤äº†ä¸Šè¿°ç±»å‹å¤–ï¼Œè¿˜æœ‰å°‘æ•°çš„å‡ ä¸ªREDOç±»å‹ä¸æ¶‰åŠå…·ä½“çš„æ•°æ®ä¿®æ”¹ï¼Œåªæ˜¯ä¸ºäº†è®°å½•ä¸€äº›éœ€è¦çš„ä¿¡æ¯ï¼Œæ¯”å¦‚æœ€å¸¸è§çš„MLOG_MULTI_REC_ENDå°±æ˜¯ä¸ºäº†æ ‡è¯†ä¸€ä¸ªREDOç»„ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„åŸå­æ“ä½œçš„ç»“æŸã€‚\n4. REDOæ˜¯å¦‚ä½•ç»„ç»‡çš„æ‰€è°“REDOçš„ç»„ç»‡æ–¹å¼ï¼Œå°±æ˜¯å¦‚ä½•æŠŠéœ€è¦çš„REDOå†…å®¹è®°å½•åˆ°ç£ç›˜æ–‡ä»¶ä¸­ï¼Œä»¥æ–¹ä¾¿é«˜æ•ˆçš„REDOå†™å…¥ï¼Œè¯»å–ï¼Œæ¢å¤ä»¥åŠæ¸…ç†ã€‚æˆ‘ä»¬è¿™é‡ŒæŠŠREDOä»ä¸Šåˆ°ä¸‹åˆ†ä¸ºä¸‰å±‚ï¼šé€»è¾‘REDOå±‚ã€ç‰©ç†REDOå±‚å’Œæ–‡ä»¶å±‚ã€‚\né€»è¾‘REDOå±‚è¿™ä¸€å±‚æ˜¯çœŸæ­£çš„REDOå†…å®¹ï¼ŒREDOç”±å¤šä¸ªä¸åŒTypeçš„å¤šä¸ªREDOè®°å½•æ”¶å°¾ç›¸è¿ç»„æˆï¼Œæœ‰å…¨å±€å”¯ä¸€çš„é€’å¢çš„åç§»snï¼ŒInnoDBä¼šåœ¨å…¨å±€log_sysä¸­ç»´æŠ¤å½“å‰snçš„æœ€å¤§å€¼ï¼Œå¹¶åœ¨æ¯æ¬¡å†™å…¥æ•°æ®æ—¶å°†snå¢åŠ REDOå†…å®¹é•¿åº¦ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç‰©ç†REDOå±‚ç£ç›˜æ˜¯å—è®¾å¤‡ï¼ŒInnoDBä¸­ä¹Ÿç”¨Blockçš„æ¦‚å¿µæ¥è¯»å†™æ•°æ®ï¼Œä¸€ä¸ªBlockçš„é•¿åº¦OS_FILE_LOG_BLOCK_SIZEç­‰äºç£ç›˜æ‰‡åŒºçš„å¤§å°512Bï¼Œæ¯æ¬¡IOè¯»å†™çš„æœ€å°å•ä½éƒ½æ˜¯ä¸€ä¸ªBlockã€‚é™¤äº†REDOæ•°æ®ä»¥å¤–ï¼ŒBlockä¸­è¿˜éœ€è¦ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œä¸‹å›¾æ‰€ç¤ºä¸€ä¸ªLog Blockçš„çš„ç»„æˆï¼ŒåŒ…æ‹¬12å­—èŠ‚çš„Block Headerï¼šå‰4å­—èŠ‚ä¸­Flush Flagå ç”¨æœ€é«˜ä½bitï¼Œæ ‡è¯†ä¸€æ¬¡IOçš„ç¬¬ä¸€ä¸ªBlockï¼Œå‰©ä¸‹çš„31ä¸ªä¸ªbitæ˜¯Blockç¼–å·ï¼›ä¹‹åæ˜¯2å­—èŠ‚çš„æ•°æ®é•¿åº¦ï¼Œå–å€¼åœ¨[12ï¼Œ508]ï¼›ç´§æ¥ç€2å­—èŠ‚çš„First Record Offsetç”¨æ¥æŒ‡å‘Blockä¸­ç¬¬ä¸€ä¸ªREDOç»„çš„å¼€å§‹ï¼Œè¿™ä¸ªå€¼çš„å­˜åœ¨ä½¿å¾—æˆ‘ä»¬å¯¹ä»»ä½•ä¸€ä¸ªBlockéƒ½å¯ä»¥æ‰¾åˆ°ä¸€ä¸ªåˆæ³•çš„çš„REDOå¼€å§‹ä½ç½®ï¼›æœ€åçš„4å­—èŠ‚Checkpoint Numberè®°å½•å†™Blockæ—¶çš„next_checkpoint_numberï¼Œç”¨æ¥å‘ç°æ–‡ä»¶çš„å¾ªç¯ä½¿ç”¨ï¼Œè¿™ä¸ªä¼šåœ¨æ–‡ä»¶å±‚è¯¦ç»†è®²è§£ã€‚Blockæœ«å°¾æ˜¯4å­—èŠ‚çš„Block Tailerï¼Œè®°å½•å½“å‰Blockçš„Checksumï¼Œé€šè¿‡è¿™ä¸ªå€¼ï¼Œè¯»å–Logæ—¶å¯ä»¥æ˜ç¡®Blockæ•°æ®æœ‰æ²¡æœ‰è¢«å®Œæ•´å†™ç›˜ã€‚\n\nBlockä¸­å‰©ä½™çš„ä¸­é—´498ä¸ªå­—èŠ‚å°±æ˜¯REDOçœŸæ­£å†…å®¹çš„å­˜æ”¾ä½ç½®ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„é€»è¾‘REDOã€‚æˆ‘ä»¬ç°åœ¨å°†é€»è¾‘REDOæ”¾åˆ°ç‰©ç†REDOç©ºé—´ä¸­ï¼Œç”±äºBlockå†…çš„ç©ºé—´å›ºå®šï¼Œè€ŒREDOé•¿åº¦ä¸å®šï¼Œå› æ­¤å¯èƒ½ä¸€ä¸ªBlockä¸­æœ‰å¤šä¸ªREDOï¼Œä¹Ÿå¯èƒ½ä¸€ä¸ªREDOè¢«æ‹†åˆ†åˆ°å¤šä¸ªBlockä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ£•è‰²å’Œçº¢è‰²åˆ†åˆ«ä»£è¡¨Block Headerå’ŒTailerï¼Œä¸­é—´çš„REDOè®°å½•ç”±äºå‰ä¸€ä¸ªBlockå‰©ä½™ç©ºé—´ä¸è¶³ï¼Œè€Œè¢«æ‹†åˆ†åœ¨è¿ç»­çš„ä¸¤ä¸ªBlockä¸­ã€‚\n\nç”±äºå¢åŠ äº†Block Headerå’ŒTailerçš„å­—èŠ‚å¼€é”€ï¼Œåœ¨ç‰©ç†REDOç©ºé—´ä¸­ç”¨LSNæ¥æ ‡è¯†åç§»ï¼Œå¯ä»¥çœ‹å‡ºLSNå’ŒSNä¹‹é—´æœ‰ç®€å•çš„æ¢ç®—å…³ç³»ï¼š\nconstexpr inline lsn_t log_translate_sn_to_lsn(lsn_t sn) &#123;  return (sn / LOG_BLOCK_DATA_SIZE * OS_FILE_LOG_BLOCK_SIZE +          sn % LOG_BLOCK_DATA_SIZE + LOG_BLOCK_HDR_SIZE);&#125;\n\nSNåŠ ä¸Šä¹‹å‰æ‰€æœ‰çš„Blockçš„Headerä»¥åŠTailerçš„é•¿åº¦å°±å¯ä»¥æ¢ç®—åˆ°å¯¹åº”çš„LSNï¼Œåä¹‹äº¦ç„¶ã€‚\næ–‡ä»¶å±‚æœ€ç»ˆREDOä¼šè¢«å†™å…¥åˆ°REDOæ—¥å¿—æ–‡ä»¶ä¸­ï¼Œä»¥ib_logfile0ã€ib_logfile1â€¦å‘½åï¼Œä¸ºäº†é¿å…åˆ›å»ºæ–‡ä»¶åŠåˆå§‹åŒ–ç©ºé—´å¸¦æ¥çš„å¼€é”€ï¼ŒInooDBçš„REDOæ–‡ä»¶ä¼šå¾ªç¯ä½¿ç”¨ï¼Œé€šè¿‡å‚æ•°innodb_log_files_in_groupå¯ä»¥æŒ‡å®šREDOæ–‡ä»¶çš„ä¸ªæ•°ã€‚å¤šä¸ªæ–‡ä»¶æ”¶å°¾ç›¸è¿é¡ºåºå†™å…¥REDOå†…å®¹ã€‚æ¯ä¸ªæ–‡ä»¶ä»¥Blockä¸ºå•ä½åˆ’åˆ†ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å¼€å¤´å›ºå®šé¢„ç•™4ä¸ªBlockæ¥è®°å½•ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªBlockç§°ä¸ºHeader Blockï¼Œä¹‹åçš„3ä¸ªBlockåœ¨0å·æ–‡ä»¶ä¸Šç”¨æ¥å­˜å‚¨Checkpointä¿¡æ¯ï¼Œè€Œåœ¨å…¶ä»–æ–‡ä»¶ä¸Šç•™ç©ºï¼š\n\nå…¶ä¸­ç¬¬ä¸€ä¸ªHeader Blockçš„æ•°æ®åŒºåŸŸè®°å½•äº†ä¸€äº›æ–‡ä»¶ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ4å­—èŠ‚çš„Formateå­—æ®µè®°å½•Logçš„ç‰ˆæœ¬ï¼Œä¸åŒç‰ˆæœ¬çš„LOGï¼Œä¼šæœ‰REDOç±»å‹çš„å¢å‡ï¼Œè¿™ä¸ªä¿¡æ¯æ˜¯8.0å¼€å§‹æ‰åŠ å…¥çš„ï¼›8å­—èŠ‚çš„Start LSNæ ‡è¯†å½“å‰æ–‡ä»¶å¼€å§‹LSNï¼Œé€šè¿‡è¿™ä¸ªä¿¡æ¯å¯ä»¥å°†æ–‡ä»¶çš„offsetä¸å¯¹åº”çš„lsnå¯¹åº”èµ·æ¥ï¼›æœ€åæ˜¯æœ€é•¿32ä½çš„Creatorä¿¡æ¯ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä¼šè®°å½•MySQLçš„ç‰ˆæœ¬ã€‚\n\nç°åœ¨æˆ‘ä»¬å°†REDOæ”¾åˆ°æ–‡ä»¶ç©ºé—´ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé€»è¾‘REDOæ˜¯çœŸæ­£éœ€è¦çš„æ•°æ®ï¼Œç”¨snç´¢å¼•ï¼Œé€»è¾‘REDOæŒ‰å›ºå®šå¤§å°çš„Blockç»„ç»‡ï¼Œå¹¶æ·»åŠ Blockçš„å¤´å°¾ä¿¡æ¯å½¢æˆç‰©ç†REDOï¼Œä»¥lsnç´¢å¼•ï¼Œè¿™äº›Blockåˆä¼šæ”¾åˆ°å¾ªç¯ä½¿ç”¨çš„æ–‡ä»¶ç©ºé—´ä¸­çš„æŸä¸€ä½ç½®ï¼Œæ–‡ä»¶ä¸­ç”¨offsetç´¢å¼•ï¼š\n\nè™½ç„¶é€šè¿‡LSNå¯ä»¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªREDOä½ç½®ï¼Œä½†æœ€ç»ˆå¯¹REDOçš„è¯»å†™è¿˜éœ€è¦è½¬æ¢åˆ°å¯¹æ–‡ä»¶çš„è¯»å†™IOï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦è¡¨ç¤ºæ–‡ä»¶ç©ºé—´çš„offsetï¼Œä»–ä»¬ä¹‹é—´çš„æ¢ç®—æ–¹å¼å¦‚ä¸‹ï¼š\nconst auto real_offset =      log.current_file_real_offset + (lsn - log.current_file_lsn);\n\nåˆ‡æ¢æ–‡ä»¶æ—¶ä¼šåœ¨å†…å­˜ä¸­æ›´æ–°å½“å‰æ–‡ä»¶å¼€å¤´çš„æ–‡ä»¶offsetï¼Œcurrent_file_real_offsetï¼Œä»¥åŠå¯¹åº”çš„LSNï¼Œcurrent_file_lsnï¼Œé€šè¿‡è¿™ä¸¤ä¸ªå€¼å¯ä»¥æ–¹ä¾¿åœ°ç”¨ä¸Šé¢çš„æ–¹å¼å°†LSNè½¬åŒ–ä¸ºæ–‡ä»¶offsetã€‚æ³¨æ„è¿™é‡Œçš„offsetæ˜¯ç›¸å½“äºæ•´ä¸ªREDOæ–‡ä»¶ç©ºé—´è€Œè¨€çš„ï¼Œç”±äºInnoDBä¸­è¯»å†™æ–‡ä»¶çš„spaceå±‚å®ç°æ”¯æŒå¤šä¸ªæ–‡ä»¶ï¼Œå› æ­¤ï¼Œå¯ä»¥å°†é¦–ä½ç›¸è¿çš„å¤šä¸ªREDOæ–‡ä»¶çœ‹æˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œé‚£ä¹ˆè¿™é‡Œçš„offsetå°±æ˜¯è¿™ä¸ªå¤§æ–‡ä»¶ä¸­çš„åç§»ã€‚\n5. å¦‚ä½•é«˜æ•ˆåœ°å†™REDOä½œä¸ºç»´æŠ¤æ•°æ®åº“æ­£ç¡®æ€§çš„é‡è¦ä¿¡æ¯ï¼ŒREDOæ—¥å¿—å¿…é¡»åœ¨äº‹åŠ¡æäº¤å‰ä¿è¯è½ç›˜ï¼Œå¦åˆ™ä¸€æ—¦æ–­ç”µå°†ä¼šæœ‰æ•°æ®ä¸¢å¤±çš„å¯èƒ½ï¼Œå› æ­¤ä»REDOç”Ÿæˆåˆ°æœ€ç»ˆè½ç›˜çš„å®Œæ•´è¿‡ç¨‹æˆä¸ºæ•°æ®åº“å†™å…¥çš„å…³é”®è·¯å¾„ï¼Œå…¶æ•ˆç‡ä¹Ÿç›´æ¥å†³å®šäº†æ•°æ®åº“çš„å†™å…¥æ€§èƒ½ã€‚è¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬REDOå†…å®¹çš„äº§ç”Ÿï¼ŒREDOå†™å…¥InnoDB Log Bufferï¼Œä»InnoDB Log Bufferå†™å…¥æ“ä½œç³»ç»ŸPage Cacheï¼Œä»¥åŠREDOåˆ·ç›˜ï¼Œä¹‹åè¿˜éœ€è¦å”¤é†’ç­‰å¾…çš„ç”¨æˆ·çº¿ç¨‹å®ŒæˆCommitã€‚ä¸‹é¢å°±é€šè¿‡è¿™å‡ ä¸ªé˜¶æ®µæ¥çœ‹çœ‹InnoDBå¦‚ä½•åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹è¿˜èƒ½é«˜æ•ˆåœ°å®Œæˆå†™REDOã€‚\nREDOäº§ç”Ÿæˆ‘ä»¬çŸ¥é“äº‹åŠ¡åœ¨å†™å…¥æ•°æ®çš„æ—¶å€™ä¼šäº§ç”ŸREDOï¼Œä¸€æ¬¡åŸå­çš„æ“ä½œå¯èƒ½ä¼šåŒ…å«å¤šæ¡REDOè®°å½•ï¼Œè¿™äº›REDOå¯èƒ½æ˜¯è®¿é—®åŒä¸€Pageçš„ä¸åŒä½ç½®ï¼Œä¹Ÿå¯èƒ½æ˜¯è®¿é—®ä¸åŒçš„Pageï¼ˆå¦‚BtreeèŠ‚ç‚¹åˆ†è£‚ï¼‰ã€‚InnoDBæœ‰ä¸€å¥—å®Œæ•´çš„æœºåˆ¶æ¥ä¿è¯æ¶‰åŠä¸€æ¬¡åŸå­æ“ä½œçš„å¤šæ¡REDOè®°å½•åŸå­ï¼Œå³æ¢å¤çš„æ—¶å€™è¦ä¹ˆå…¨éƒ¨é‡æ”¾ï¼Œè¦ä¸å…¨éƒ¨ä¸é‡æ”¾ï¼Œè¿™éƒ¨åˆ†å°†åœ¨ä¹‹åä»‹ç»æ¢å¤é€»è¾‘çš„æ—¶å€™è¯¦ç»†ä»‹ç»ï¼Œæœ¬æ–‡åªæ¶‰åŠå…¶ä¸­æœ€åŸºæœ¬çš„è¦æ±‚ï¼Œå°±æ˜¯è¿™äº›REDOå¿…é¡»è¿ç»­ã€‚InnoDBä¸­é€šè¿‡min-transactionå®ç°ï¼Œç®€ç§°mtrï¼Œéœ€è¦åŸå­æ“ä½œæ—¶ï¼Œè°ƒç”¨mtr_startç”Ÿæˆä¸€ä¸ªmtrï¼Œmträ¸­ä¼šç»´æŠ¤ä¸€ä¸ªåŠ¨æ€å¢é•¿çš„m_logï¼Œè¿™æ˜¯ä¸€ä¸ªåŠ¨æ€åˆ†é…çš„å†…å­˜ç©ºé—´ï¼Œå°†è¿™ä¸ªåŸå­æ“ä½œéœ€è¦å†™çš„æ‰€æœ‰REDOå…ˆå†™åˆ°è¿™ä¸ªm_logä¸­ï¼Œå½“åŸå­æ“ä½œç»“æŸåï¼Œè°ƒç”¨mtr_commitå°†m_logä¸­çš„æ•°æ®æ‹·è´åˆ°InnoDBçš„Log Bufferã€‚\nå†™å…¥InnoDB Log Bufferé«˜å¹¶å‘çš„ç¯å¢ƒä¸­ï¼Œä¼šåŒæ—¶æœ‰éå¸¸å¤šçš„min-transaction(mtr)éœ€è¦æ‹·è´æ•°æ®åˆ°Log Bufferï¼Œå¦‚æœé€šè¿‡é”äº’æ–¥ï¼Œé‚£ä¹ˆæ¯«æ— ç–‘é—®è¿™é‡Œå°†æˆä¸ºæ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆã€‚ä¸ºæ­¤ï¼Œä»MySQL 8.0å¼€å§‹ï¼Œè®¾è®¡äº†ä¸€å¥—æ— é”çš„å†™logæœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæ€è·¯æ˜¯å…è®¸ä¸åŒçš„mtrï¼ŒåŒæ—¶å¹¶å‘åœ°å†™Log Bufferçš„ä¸åŒä½ç½®ã€‚ä¸åŒçš„mträ¼šé¦–å…ˆè°ƒç”¨log_buffer_reserveå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é‡Œä¼šç”¨è‡ªå·±çš„REDOé•¿åº¦ï¼ŒåŸå­åœ°å¯¹å…¨å±€åç§»log.snåšfetch_addï¼Œå¾—åˆ°è‡ªå·±åœ¨Log Bufferä¸­ç‹¬äº«çš„ç©ºé—´ã€‚ä¹‹åä¸åŒmtrå¹¶è¡Œçš„å°†è‡ªå·±çš„m_logä¸­çš„æ•°æ®æ‹·è´åˆ°å„è‡ªç‹¬äº«çš„ç©ºé—´å†…ã€‚\n/* Reserve space in sequence of data bytes: */const sn_t start_sn = log.sn.fetch_add(len);\n\nå†™å…¥Page Cacheå†™å…¥åˆ°Log Bufferä¸­çš„REDOæ•°æ®éœ€è¦è¿›ä¸€æ­¥å†™å…¥æ“ä½œç³»ç»Ÿçš„Page Cacheï¼ŒInnoDBä¸­æœ‰å•ç‹¬çš„log_writeræ¥åšè¿™ä»¶äº‹æƒ…ã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œç”±äºLog Bufferä¸­çš„æ•°æ®æ˜¯ä¸åŒmtrå¹¶å‘å†™å…¥çš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­Log Bufferä¸­æ˜¯æœ‰ç©ºæ´çš„ï¼Œå› æ­¤log_writeréœ€è¦æ„ŸçŸ¥å½“å‰Log Bufferä¸­è¿ç»­æ—¥å¿—çš„æœ«å°¾ï¼Œå°†è¿ç»­æ—¥å¿—é€šè¿‡pwriteç³»ç»Ÿè°ƒç”¨å†™å…¥æ“ä½œç³»ç»ŸPage Cacheã€‚æ•´ä¸ªè¿‡ç¨‹ä¸­åº”å°½å¯èƒ½ä¸å½±å“åç»­mtrè¿›è¡Œæ•°æ®æ‹·è´ï¼ŒInnoDBåœ¨è¿™é‡Œå¼•å…¥ä¸€ä¸ªå«åšlink_bufçš„æ•°æ®ç»“æ„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nlink_bufæ˜¯ä¸€ä¸ªå¾ªç¯ä½¿ç”¨çš„æ•°ç»„ï¼Œå¯¹æ¯ä¸ªlsnå–æ¨¡å¯ä»¥å¾—åˆ°å…¶åœ¨link_bufä¸Šçš„ä¸€ä¸ªæ§½ä½ï¼Œåœ¨è¿™ä¸ªæ§½ä½ä¸­è®°å½•REDOé•¿åº¦ã€‚å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä»å¼€å§‹éå†è¿™ä¸ªlink_bufï¼Œé€šè¿‡æ§½ä½ä¸­çš„é•¿åº¦å¯ä»¥æ‰¾åˆ°è¿™æ¡REDOçš„ç»“å°¾ä½ç½®ï¼Œä¸€ç›´éå†åˆ°ä¸‹ä¸€ä½ç½®ä¸º0çš„ä½ç½®ï¼Œå¯ä»¥è®¤ä¸ºä¹‹åçš„REDOæœ‰ç©ºæ´ï¼Œè€Œä¹‹å‰å·²ç»è¿ç»­ï¼Œè¿™ä¸ªä½ç½®å«åšlink_bufçš„tailã€‚ä¸‹é¢çœ‹çœ‹log_writerå’Œä¼—å¤šmtræ˜¯å¦‚ä½•åˆ©ç”¨è¿™ä¸ªlink_bufæ•°æ®ç»“æ„çš„ã€‚è¿™é‡Œçš„è¿™ä¸ªlink_bufä¸ºlog.recent_writtenï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå›¾ä¸­ä¸ŠåŠéƒ¨åˆ†æ˜¯REDOæ—¥å¿—ç¤ºæ„å›¾ï¼Œwrite_lsnæ˜¯å½“å‰log_writerå·²ç»å†™å…¥åˆ°Page Cacheä¸­æ—¥å¿—æœ«å°¾ï¼Œcurrent_lsnæ˜¯å½“å‰å·²ç»åˆ†é…ç»™mtrçš„çš„æœ€å¤§lsnä½ç½®ï¼Œè€Œbuf_ready_for_write_lsnæ˜¯å½“å‰log_writeræ‰¾åˆ°çš„Log Bufferä¸­å·²ç»è¿ç»­çš„æ—¥å¿—ç»“å°¾ï¼Œä»write_lsnåˆ°buf_ready_for_write_lsnæ˜¯ä¸‹ä¸€æ¬¡log_writerå¯ä»¥è¿ç»­è°ƒç”¨pwriteå†™å…¥Page Cacheçš„èŒƒå›´ï¼Œè€Œä»buf_ready_for_write_lsnåˆ°current_lsnæ˜¯å½“å‰mtræ­£åœ¨å¹¶å‘å†™Log Bufferçš„èŒƒå›´ã€‚ä¸‹é¢çš„è¿ç»­æ–¹æ ¼ä¾¿æ˜¯log.recent_writtençš„æ•°æ®ç»“æ„ï¼Œå¯ä»¥çœ‹å‡ºç”±äºä¸­é—´çš„ä¸¤ä¸ªå…¨é›¶çš„ç©ºæ´å¯¼è‡´buf_ready_for_write_lsnæ— æ³•ç»§ç»­æ¨è¿›ï¼Œæ¥ä¸‹æ¥ï¼Œå‡å¦‚reserveåˆ°ä¸­é—´ç¬¬ä¸€ä¸ªç©ºæ´çš„mträ¹Ÿå®Œæˆäº†å†™Log Bufferï¼Œå¹¶æ›´æ–°äº†log.recent_written*ï¼Œå¦‚ä¸‹å›¾ï¼š\n\nè¿™æ—¶ï¼Œlog_writerä»å½“å‰çš„buf_ready_for_write_lsnå‘åéå†log.recent_writtenï¼Œå‘ç°è¿™æ®µå·²ç»è¿ç»­ï¼š\n\nå› æ­¤æå‡å½“å‰çš„buf_ready_for_write_lsnï¼Œå¹¶å°†log.recent_writtençš„tailä½ç½®å‘å‰æ»‘åŠ¨ï¼Œä¹‹åçš„ä½ç½®æ¸…é›¶ï¼Œä¾›ä¹‹åå¾ªç¯å¤ç”¨ï¼š\n\nç´§æ¥log_writerå°†è¿ç»­çš„å†…å®¹åˆ·ç›˜å¹¶æå‡write_lsnã€‚\nåˆ·ç›˜log_writeræå‡write_lsnä¹‹åä¼šé€šçŸ¥log_flusherçº¿ç¨‹ï¼Œlog_flusherçº¿ç¨‹ä¼šè°ƒç”¨fsyncå°†REDOåˆ·ç›˜ï¼Œè‡³æ­¤å®Œæˆäº†REDOå®Œæ•´çš„å†™å…¥è¿‡ç¨‹ã€‚\nå”¤é†’ç”¨æˆ·çº¿ç¨‹ä¸ºäº†ä¿è¯æ•°æ®æ­£ç¡®ï¼Œåªæœ‰REDOå†™å®Œåäº‹åŠ¡æ‰å¯ä»¥commitï¼Œå› æ­¤åœ¨REDOå†™å…¥çš„è¿‡ç¨‹ä¸­ï¼Œå¤§é‡çš„ç”¨æˆ·çº¿ç¨‹ä¼šblockç­‰å¾…ï¼Œç›´åˆ°è‡ªå·±çš„æœ€åä¸€æ¡æ—¥å¿—ç»“æŸå†™å…¥ã€‚é»˜è®¤æƒ…å†µä¸‹innodb_flush_log_at_trx_commit = 1ï¼Œéœ€è¦ç­‰REDOå®Œæˆåˆ·ç›˜ï¼Œè¿™ä¹Ÿæ˜¯æœ€å®‰å…¨çš„æ–¹å¼ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è®¾ç½®innodb_flush_log_at_trx_commit = 2ï¼Œè¿™æ ·ï¼Œåªè¦REDOå†™å…¥Page Cacheå°±è®¤ä¸ºå®Œæˆäº†å†™å…¥ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œæ‰ç”µå¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚\nå¤§é‡çš„ç”¨æˆ·çº¿ç¨‹è°ƒç”¨log_write_up_toç­‰å¾…åœ¨è‡ªå·±çš„lsnä½ç½®ï¼Œä¸ºäº†é¿å…å¤§é‡æ— æ•ˆçš„å”¤é†’ï¼ŒInnoDBå°†é˜»å¡çš„æ¡ä»¶å˜é‡æ‹†åˆ†ä¸ºå¤šä¸ªï¼Œlog_write_up_toæ ¹æ®è‡ªå·±éœ€è¦ç­‰å¾…çš„lsnæ‰€åœ¨çš„blockå–æ¨¡å¯¹åº”åˆ°ä¸åŒçš„æ¡ä»¶å˜é‡ä¸Šå»ã€‚åŒæ—¶ï¼Œä¸ºäº†é¿å…å¤§é‡çš„å”¤é†’å·¥ä½œå½±å“log_writeræˆ–log_flusherçº¿ç¨‹ï¼ŒInnoDBä¸­å¼•å…¥äº†ä¸¤ä¸ªä¸“é—¨è´Ÿè´£å”¤é†’ç”¨æˆ·çš„çº¿ç¨‹ï¼šlog_wirte_notifierå’Œlog_flush_notifierï¼Œå½“è¶…è¿‡ä¸€ä¸ªæ¡ä»¶å˜é‡éœ€è¦è¢«å”¤é†’æ—¶ï¼Œlog_writerå’Œlog_flusherä¼šé€šçŸ¥è¿™ä¸¤ä¸ªçº¿ç¨‹å®Œæˆå”¤é†’å·¥ä½œã€‚ä¸‹å›¾æ˜¯æ•´ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾ï¼š\n\nå¤šä¸ªçº¿ç¨‹é€šè¿‡ä¸€äº›å†…éƒ¨æ•°æ®ç»“æ„çš„è¾…åŠ©ï¼Œå®Œæˆäº†é«˜æ•ˆçš„ä»REDOäº§ç”Ÿï¼Œåˆ°REDOå†™ç›˜ï¼Œå†åˆ°å”¤é†’ç”¨æˆ·çº¿ç¨‹çš„æµç¨‹ï¼Œä¸‹é¢æ˜¯æ•´ä¸ªè¿™ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾ï¼š\n\n6. å¦‚ä½•å®‰å…¨åœ°æ¸…é™¤REDOç”±äºREDOæ–‡ä»¶ç©ºé—´æœ‰é™ï¼ŒåŒæ—¶ä¸ºäº†å°½é‡å‡å°‘æ¢å¤æ—¶éœ€è¦é‡æ”¾çš„REDOï¼ŒInnoDBå¼•å…¥log_checkpointerçº¿ç¨‹å‘¨æœŸæ€§çš„æ‰“Checkpointã€‚é‡å¯æ¢å¤çš„æ—¶å€™ï¼Œåªéœ€è¦ä»æœ€æ–°çš„Checkpointå¼€å§‹å›æ”¾åè¾¹çš„REDOï¼Œå› æ­¤Checkpointä¹‹å‰çš„REDOå°±å¯ä»¥åˆ é™¤æˆ–è¢«å¤ç”¨ã€‚\næˆ‘ä»¬çŸ¥é“REDOçš„ä½œç”¨æ˜¯é¿å…åªå†™äº†å†…å­˜çš„æ•°æ®ç”±äºæ•…éšœä¸¢å¤±ï¼Œé‚£ä¹ˆæ‰“Checkpiontçš„ä½ç½®å°±å¿…é¡»ä¿è¯ä¹‹å‰æ‰€æœ‰REDOæ‰€äº§ç”Ÿçš„å†…å­˜è„é¡µéƒ½å·²ç»åˆ·ç›˜ã€‚æœ€ç›´æ¥çš„ï¼Œå¯ä»¥ä»Buffer Poolä¸­è·å¾—å½“å‰æ‰€æœ‰è„é¡µå¯¹åº”çš„æœ€å°REDO LSNï¼šlwm_lsnã€‚ ä½†å…‰æœ‰è¿™ä¸ªè¿˜ä¸å¤Ÿï¼Œå› ä¸ºæœ‰ä¸€éƒ¨åˆ†min-transactionçš„REDOå¯¹åº”çš„Pageè¿˜æ²¡æœ‰æ¥çš„åŠåŠ å…¥åˆ°Buffer Poolçš„è„é¡µä¸­å»ï¼Œå¦‚æœcheckpointæ‰“åˆ°è¿™äº›REDOçš„åè¾¹ï¼Œä¸€æ—¦è¿™æ—¶å‘ç”Ÿæ•…éšœæ¢å¤ï¼Œè¿™éƒ¨åˆ†æ•°æ®å°†ä¸¢å¤±ï¼Œå› æ­¤è¿˜éœ€è¦çŸ¥é“å½“å‰å·²ç»åŠ å…¥åˆ°Buffer Poolçš„REDO lsnä½ç½®ï¼šdpa_lsnã€‚å–äºŒè€…çš„è¾ƒå°å€¼ä½œä¸ºæœ€ç»ˆcheckpointçš„ä½ç½®ï¼Œå…¶æ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ï¼š\n/* LWM lsn for unflushed dirty pages in Buffer Pool */lsn_t lwm_lsn = buf_pool_get_oldest_modification_lwm();/* Note lsn up to which all dirty pages have already been added into Buffer Pool */const lsn_t dpa_lsn = log_buffer_dirty_pages_added_up_to_lsn(log);lsn_t checkpoint_lsn = std::min(lwm_lsn, dpa_lsn);\n\nMySQL 8.0ä¸­ä¸ºäº†èƒ½å¤Ÿè®©mträ¹‹é—´æ›´å¤§ç¨‹åº¦çš„å¹¶å‘ï¼Œå…è®¸å¹¶å‘åœ°ç»™Buffer Poolæ³¨å†Œè„é¡µã€‚ç±»ä¼¼ä¸log.recent_writtenå’Œlog_writerï¼Œè¿™é‡Œå¼•å…¥ä¸€ä¸ªå«åšrecent_closedçš„link_bufæ¥å¤„ç†å¹¶å‘å¸¦æ¥çš„ç©ºæ´ï¼Œç”±å•ç‹¬çš„çº¿ç¨‹log_closeræ¥æå‡recent_closedçš„tailï¼Œä¹Ÿå°±æ˜¯å½“å‰è¿ç»­åŠ å…¥Buffer Poolè„é¡µçš„æœ€å¤§LSNï¼Œè¿™ä¸ªå€¼ä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„dpa_lsnã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¿™ç§ä¹±åºçš„å­˜åœ¨ï¼Œlwm_lsnçš„å€¼å¹¶ä¸èƒ½ç®€å•çš„è·å–å½“å‰Buffer Poolä¸­çš„æœ€è€çš„è„é¡µçš„LSNï¼Œä¿å®ˆèµ·è§ï¼Œè¿˜éœ€è¦å‡æ‰ä¸€ä¸ªrecent_closedçš„å®¹é‡å¤§å°ï¼Œä¹Ÿå°±æ˜¯æœ€å¤§çš„ä¹±åºèŒƒå›´ï¼Œç®€åŒ–åçš„ä»£ç å¦‚ä¸‹ï¼š\n/* LWM lsn for unflushed dirty pages in Buffer Pool */const lsn_t lsn = buf_pool_get_oldest_modification_approx();const lsn_t lag = log.recent_closed.capacity();lsn_t lwm_lsn = lsn - lag;/* Note lsn up to which all dirty pages have already been added into Buffer Pool */const lsn_t dpa_lsn = log_buffer_dirty_pages_added_up_to_lsn(log);lsn_t checkpoint_lsn = std::min(lwm_lsn, dpa_lsn);\n\nè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œç”±äºlwm_lsnå·²ç»å‡å»äº†recent_closedçš„capacityï¼Œå› æ­¤ç†è®ºä¸Šè¿™ä¸ªå€¼ä¸€å®šæ˜¯å°äºdpa_lsnçš„ã€‚é‚£ä¹ˆå†å»æ¯”è¾ƒlwm_lsnå’Œdpa_lsnæ¥è·å–Checkpointä½ç½®æˆ–è®¸æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚\nä¸Šé¢å·²ç»æåˆ°ï¼Œib_logfile0æ–‡ä»¶çš„å‰ä¸‰ä¸ªBlockæœ‰ä¸¤ä¸ªè¢«é¢„ç•™ä½œä¸ºCheckpoint Blockï¼Œè¿™ä¸¤ä¸ªBlockä¼šåœ¨æ‰“Checkpiontçš„æ—¶å€™äº¤æ›¿ä½¿ç”¨ï¼Œè¿™æ ·æ¥é¿å…å†™Checkpointè¿‡ç¨‹ä¸­çš„å´©æºƒå¯¼è‡´æ²¡æœ‰å¯ç”¨çš„Checkpointã€‚Checkpoint Blockä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š\n\né¦–å…ˆ8ä¸ªå­—èŠ‚çš„Checkpoint Numberï¼Œé€šè¿‡æ¯”è¾ƒè¿™ä¸ªå€¼å¯ä»¥åˆ¤æ–­å“ªä¸ªæ˜¯æœ€æ–°çš„Checkpiontè®°å½•ï¼Œä¹‹å8å­—èŠ‚çš„Checkpoint LSNä¸ºæ‰“Checkpointçš„REDOä½ç½®ï¼Œæ¢å¤æ—¶ä¼šä»è¿™ä¸ªä½ç½®å¼€å§‹é‡æ”¾åè¾¹çš„REDOã€‚ä¹‹å8ä¸ªå­—èŠ‚çš„Checkpoint Offsetï¼Œå°†Checkpoint LSNä¸æ–‡ä»¶ç©ºé—´çš„åç§»å¯¹åº”èµ·æ¥ã€‚æœ€å8å­—èŠ‚æ˜¯å‰é¢æåˆ°çš„Log Bufferçš„é•¿åº¦ï¼Œè¿™ä¸ªå€¼ç›®å‰åœ¨æ¢å¤è¿‡ç¨‹å¹¶æ²¡æœ‰ä½¿ç”¨ã€‚\n7. æ€»ç»“æœ¬æ–‡ç³»ç»Ÿçš„ä»‹ç»äº†InnoDBä¸­REDOçš„ä½œç”¨ã€ç‰¹æ€§ã€ç»„ç»‡ç»“æ„ã€å†™å…¥æ–¹å¼å·²ç»æ¸…ç†æ—¶æœºï¼ŒåŸºæœ¬è¦†ç›–äº†REDOçš„å¤§å¤šæ•°å†…å®¹ã€‚å…³äºé‡å¯æ¢å¤æ—¶å¦‚ä½•ä½¿ç”¨REDOå°†æ•°æ®åº“æ¢å¤åˆ°æ­£ç¡®çš„çŠ¶æ€ï¼Œå°†åœ¨ä¹‹åä»‹ç»InnoDBæ•…éšœæ¢å¤æœºåˆ¶çš„æ—¶å€™è¯¦ç»†ä»‹ç»ã€‚\n","categories":["MySQL"]},{"title":"åº–ä¸è§£InnoDBä¹‹Undo LOG","url":"/posts/43631/","content":"Undo Logæ˜¯InnoDBååˆ†é‡è¦çš„ç»„æˆéƒ¨åˆ†ï¼Œå®ƒçš„ä½œç”¨æ¨ªè´¯InnoDBä¸­ä¸¤ä¸ªæœ€ä¸»è¦çš„éƒ¨åˆ†ï¼Œå¹¶å‘æ§åˆ¶ï¼ˆConcurrency Controlï¼‰å’Œæ•…éšœæ¢å¤ï¼ˆCrash Recoveryï¼‰ï¼ŒInnoDBä¸­Undo Logçš„å®ç°äº¦æ—¥å¿—äº¦æ•°æ®ã€‚æœ¬æ–‡å°†ä»å…¶ä½œç”¨ã€è®¾è®¡æ€è·¯ã€è®°å½•å†…å®¹ã€ç»„ç»‡ç»“æ„ï¼Œä»¥åŠå„ç§åŠŸèƒ½å®ç°ç­‰æ–¹é¢ï¼Œæ•´ä½“ä»‹ç»InnoDBä¸­çš„Undo Logï¼Œæ–‡ç« ä¼šæ·±å…¥ä¸€å®šçš„ä»£ç å®ç°ï¼Œä½†åœ¨ç»†èŠ‚ä¸Šè¿˜æ˜¯å¸Œæœ›ç”¨æŠ½è±¡çš„å®ç°æ€è·¯ä»£æ›¿å…·ä½“çš„ä»£ç ã€‚æœ¬æ–‡åŸºäºMySQL 8.0ï¼Œä½†åœ¨å¤§å¤šæ•°çš„è®¾è®¡æ€è·¯ä¸ŠMySQLçš„å„ä¸ªç‰ˆæœ¬éƒ½æ˜¯ä¸€è‡´çš„ã€‚è€ƒè™‘åˆ°ç¯‡å¹…æœ‰é™ï¼Œä»¥åŠé¿å…è¿‡å¤šä¿¡æ¯çš„å¹²æ‰°ï¼Œä»è€Œèƒ½å¤Ÿèšç„¦Undo Logæœ¬èº«çš„å†…å®¹ï¼Œæœ¬æ–‡ä¸­ä¸€ç¬”å¸¦è¿‡æˆ–æœ‰æ„çœç•¥äº†ä¸€äº›å†…å®¹ï¼ŒåŒ…æ‹¬ç´¢å¼•ã€äº‹åŠ¡ç³»ç»Ÿã€ä¸´æ—¶è¡¨ã€XAäº‹åŠ¡ã€Virtual Columnã€å¤–éƒ¨è®°å½•ã€Blobç­‰ã€‚\nä¸€ã€Undo Logçš„ä½œç”¨æ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶çš„å‰ä¸–ä»Šç”Ÿä¸­æåˆ°è¿‡ï¼ŒUndo Logç”¨æ¥è®°å½•æ¯æ¬¡ä¿®æ”¹ä¹‹å‰çš„å†å²å€¼ï¼Œé…åˆRedo Logç”¨äºæ•…éšœæ¢å¤ã€‚è¿™ä¹Ÿå°±æ˜¯InnoDBä¸­Undo Logçš„ç¬¬ä¸€ä¸ªä½œç”¨ï¼š\n1. äº‹åŠ¡å›æ»šåœ¨è®¾è®¡æ•°æ®åº“æ—¶ï¼Œæˆ‘ä»¬å‡è®¾æ•°æ®åº“å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»ï¼Œç”±äºå¦‚ç¡¬ä»¶æ•…éšœï¼Œè½¯ä»¶Bugï¼Œè¿ç»´æ“ä½œç­‰åŸå› çªç„¶å´©æºƒã€‚è¿™ä¸ªæ—¶å€™å°šæœªå®Œæˆæäº¤çš„äº‹åŠ¡å¯èƒ½å·²ç»æœ‰éƒ¨åˆ†æ•°æ®å†™å…¥äº†ç£ç›˜ï¼Œå¦‚æœä¸åŠ å¤„ç†ï¼Œä¼šè¿åæ•°æ®åº“å¯¹Atomicçš„ä¿è¯ï¼Œä¹Ÿå°±æ˜¯ä»»ä½•äº‹åŠ¡çš„ä¿®æ”¹è¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å–æ¶ˆã€‚é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œç›´è§‚çš„æƒ³æ³•æ˜¯ç­‰åˆ°äº‹åŠ¡çœŸæ­£æäº¤æ—¶ï¼Œæ‰èƒ½å…è®¸è¿™ä¸ªäº‹åŠ¡çš„ä»»ä½•ä¿®æ”¹è½ç›˜ï¼Œä¹Ÿå°±æ˜¯No-Stealç­–ç•¥ã€‚æ˜¾è€Œæ˜“è§ï¼Œè¿™ç§åšæ³•ä¸€æ–¹é¢é€ æˆå¾ˆå¤§çš„å†…å­˜ç©ºé—´å‹åŠ›ï¼Œå¦ä¸€æ–¹é¢æäº¤æ—¶çš„å¤§é‡éšæœºIOä¼šæå¤§çš„å½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œæ•°æ®åº“å®ç°ä¸­é€šå¸¸ä¼šåœ¨æ­£å¸¸äº‹åŠ¡è¿›è¡Œä¸­ï¼Œå°±ä¸æ–­çš„è¿ç»­å†™å…¥Undo Logï¼Œæ¥è®°å½•æœ¬æ¬¡ä¿®æ”¹ä¹‹å‰çš„å†å²å€¼ã€‚å½“CrashçœŸæ­£å‘ç”Ÿæ—¶ï¼Œå¯ä»¥åœ¨Recoveryè¿‡ç¨‹ä¸­é€šè¿‡å›æ”¾Undo Logå°†æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹æŠ¹æ‰ã€‚InnoDBé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ–¹å¼ã€‚\næ—¢ç„¶å·²ç»æœ‰äº†åœ¨Crash Recoveryæ—¶æ”¯æŒäº‹åŠ¡å›æ»šçš„Undo Logï¼Œè‡ªç„¶åœ°ï¼Œåœ¨æ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæ­»é”å¤„ç†æˆ–ç”¨æˆ·è¯·æ±‚çš„äº‹åŠ¡å›æ»šä¹Ÿå¯ä»¥åˆ©ç”¨è¿™éƒ¨åˆ†æ•°æ®æ¥å®Œæˆã€‚\n2. MVCCï¼ˆMulti-Versioin Concurrency Controlï¼‰æµ…ææ•°æ®åº“å¹¶å‘æ§åˆ¶æœºåˆ¶ä¸­æåˆ°è¿‡ï¼Œä¸ºäº†é¿å…åªè¯»äº‹åŠ¡ä¸å†™äº‹åŠ¡ä¹‹é—´çš„å†²çªï¼Œé¿å…å†™æ“ä½œç­‰å¾…è¯»æ“ä½œï¼Œå‡ ä¹æ‰€æœ‰çš„ä¸»æµæ•°æ®åº“éƒ½é‡‡ç”¨äº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆMVCCï¼‰çš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ä¾›è¯»äº‹åŠ¡è®¿é—®ï¼Œæ–°çš„å†™å…¥åªéœ€è¦æ·»åŠ æ–°çš„ç‰ˆæœ¬å³å¯ï¼Œæ— éœ€ç­‰å¾…ã€‚InnoDBåœ¨è¿™é‡Œå¤ç”¨äº†Undo Logä¸­å·²ç»è®°å½•çš„å†å²ç‰ˆæœ¬æ•°æ®æ¥æ»¡è¶³MVCCçš„éœ€æ±‚ã€‚\näºŒã€ä»€ä¹ˆæ ·çš„Undo Logåº–ä¸è§£InnoDBä¹‹REDO LOGä¸­è®²è¿‡çš„åŸºäºPageçš„Redo Logå¯ä»¥æ›´å¥½çš„æ”¯æŒå¹¶å‘çš„Redoåº”ç”¨ï¼Œä»è€Œç¼©çŸ­DBçš„Crash Recoveryæ—¶é—´ã€‚è€Œå¯¹äºUndo Logæ¥è¯´ï¼ŒInnoDBç”¨Undo Logæ¥å®ç°MVCCï¼ŒDBè¿è¡Œè¿‡ç¨‹ä¸­æ˜¯å…è®¸æœ‰å†å²ç‰ˆæœ¬çš„æ•°æ®å­˜åœ¨çš„ã€‚å› æ­¤ï¼ŒCrash Recoveryæ—¶åˆ©ç”¨Undo Logçš„äº‹åŠ¡å›æ»šå®Œå…¨å¯ä»¥åœ¨åå°ï¼Œåƒæ­£å¸¸è¿è¡Œçš„äº‹åŠ¡ä¸€æ ·å¼‚æ­¥å›æ»šï¼Œä»è€Œè®©æ•°æ®åº“å…ˆæ¢å¤æœåŠ¡ã€‚å› æ­¤ï¼ŒUndo Logçš„è®¾è®¡æ€è·¯ä¸åŒäºRedo Logï¼ŒUndo Logéœ€è¦çš„æ˜¯äº‹åŠ¡ä¹‹é—´çš„å¹¶å‘ï¼Œä»¥åŠæ–¹ä¾¿çš„å¤šç‰ˆæœ¬æ•°æ®ç»´æŠ¤ï¼Œå…¶é‡æ”¾é€»è¾‘ä¸å¸Œæœ›å› DBçš„ç‰©ç†å­˜å‚¨å˜åŒ–è€Œå˜åŒ–ã€‚å› æ­¤ï¼ŒInnoDBä¸­çš„Undo Logé‡‡ç”¨äº†åŸºäºäº‹åŠ¡çš„Logical Loggingçš„æ–¹å¼ã€‚\nåŒæ—¶ï¼Œæ›´å¤šçš„è´£ä»»æ„å‘³ç€æ›´å¤æ‚çš„ç®¡ç†é€»è¾‘ï¼ŒInnoDBä¸­å…¶å®æ˜¯æŠŠUndoå½“åšä¸€ç§æ•°æ®æ¥ç»´æŠ¤å’Œä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒUndo Logæ—¥å¿—æœ¬èº«ä¹Ÿåƒå…¶ä»–çš„æ•°æ®åº“æ•°æ®ä¸€æ ·ï¼Œä¼šå†™è‡ªå·±å¯¹åº”çš„Redo Logï¼Œé€šè¿‡Redo Logæ¥ä¿è¯è‡ªå·±çš„åŸå­æ€§ã€‚å› æ­¤ï¼Œæ›´åˆé€‚çš„ç§°å‘¼åº”è¯¥æ˜¯Undo Dataã€‚\nä¸‰ã€Undo Recordä¸­çš„å†…å®¹æ¯å½“InnoDBä¸­éœ€è¦ä¿®æ”¹æŸä¸ªRecordæ—¶ï¼Œéƒ½ä¼šå°†å…¶å†å²ç‰ˆæœ¬å†™å…¥ä¸€ä¸ªUndo Logä¸­ï¼Œå¯¹åº”çš„Undo Recordæ˜¯Updateç±»å‹ã€‚å½“æ’å…¥æ–°çš„Recordæ—¶ï¼Œè¿˜æ²¡æœ‰ä¸€ä¸ªå†å²ç‰ˆæœ¬ï¼Œä½†ä¸ºäº†æ–¹ä¾¿äº‹åŠ¡å›æ»šæ—¶åšé€†å‘ï¼ˆDeleteï¼‰æ“ä½œï¼Œè¿™é‡Œè¿˜æ˜¯ä¼šå†™å…¥ä¸€ä¸ªInsertç±»å‹çš„Undo Recordã€‚\nInsertç±»å‹çš„Undo Recordè¿™ç§Undo Recordåœ¨ä»£ç ä¸­å¯¹åº”çš„æ˜¯TRX_UNDO_INSERT_RECç±»å‹ã€‚ä¸åŒäºUpdateç±»å‹çš„Undo Recordï¼ŒInsert Undo Recordä»…ä»…æ˜¯ä¸ºäº†å¯èƒ½çš„äº‹åŠ¡å›æ»šå‡†å¤‡çš„ï¼Œå¹¶ä¸åœ¨MVCCåŠŸèƒ½ä¸­æ‰¿æ‹…ä½œç”¨ã€‚å› æ­¤åªéœ€è¦è®°å½•å¯¹åº”Recordçš„Keyï¼Œä¾›å›æ»šæ—¶æŸ¥æ‰¾Recordä½ç½®å³å¯ã€‚\n\nå…¶ä¸­Undo Numberæ˜¯Undoçš„ä¸€ä¸ªé€’å¢ç¼–å·ï¼ŒTable IDç”¨æ¥è¡¨ç¤ºæ˜¯å“ªå¼ è¡¨çš„ä¿®æ”¹ã€‚ä¸‹é¢ä¸€ç»„Key Fieldsçš„é•¿åº¦ä¸å®šï¼Œå› ä¸ºå¯¹åº”è¡¨çš„ä¸»é”®å¯èƒ½ç”±å¤šä¸ªfieldç»„æˆï¼Œè¿™é‡Œéœ€è¦è®°å½•Recordå®Œæ•´çš„ä¸»é”®ä¿¡æ¯ï¼Œå›æ»šçš„æ—¶å€™å¯ä»¥é€šè¿‡è¿™ä¸ªä¿¡æ¯åœ¨ç´¢å¼•ä¸­å®šä½åˆ°å¯¹åº”çš„Recordã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨Undo Recordçš„å¤´å°¾è¿˜å„ç•™äº†ä¸¤ä¸ªå­—èŠ‚ç”¨æˆ·è®°å½•å…¶å‰åºå’Œåç»§Undo Recordçš„ä½ç½®ã€‚\nUpdateç±»å‹çš„Undo Recordç”±äºMVCCéœ€è¦ä¿ç•™Recordçš„å¤šä¸ªå†å²ç‰ˆæœ¬ï¼Œå½“æŸä¸ªRecordçš„å†å²ç‰ˆæœ¬è¿˜åœ¨è¢«ä½¿ç”¨æ—¶ï¼Œè¿™ä¸ªRecordæ˜¯ä¸èƒ½è¢«çœŸæ­£çš„åˆ é™¤çš„ã€‚å› æ­¤ï¼Œå½“éœ€è¦åˆ é™¤æ—¶ï¼Œå…¶å®åªæ˜¯ä¿®æ”¹å¯¹åº”Recordçš„Delete Markæ ‡è®°ã€‚å¯¹åº”çš„ï¼Œå¦‚æœè¿™æ—¶è¿™ä¸ªRecordåˆé‡æ–°æ’å…¥ï¼Œå…¶å®ä¹Ÿåªæ˜¯ä¿®æ”¹ä¸€ä¸‹Delete Markæ ‡è®°ï¼Œä¹Ÿå°±æ˜¯å°†è¿™ä¸¤ç§æƒ…å†µçš„deleteå’Œinsertè½¬å˜æˆäº†updateæ“ä½œã€‚å†åŠ ä¸Šå¸¸è§„çš„Recordä¿®æ”¹ï¼Œå› æ­¤è¿™é‡Œçš„Update Undo Recordä¼šå¯¹åº”ä¸‰ç§Typeï¼šTRX_UNDO_UPD_EXIST_RECã€TRX_UNDO_DEL_MARK_REC å’Œ TRX_UNDO_UPD_DEL_RECã€‚ä»–ä»¬çš„å­˜å‚¨å†…å®¹ä¹Ÿç±»ä¼¼ï¼š\n\né™¤äº†è·ŸInsert Undo Recordç›¸åŒçš„å¤´å°¾ä¿¡æ¯ï¼Œä»¥åŠä¸»é”®Key Filedsä¹‹å¤–ï¼ŒUpdate Undo Recordå¢åŠ äº†ï¼š\n\nTransaction Idè®°å½•äº†äº§ç”Ÿè¿™ä¸ªå†å²ç‰ˆæœ¬äº‹åŠ¡Idï¼Œç”¨ä½œåç»­MVCCä¸­çš„ç‰ˆæœ¬å¯è§æ€§åˆ¤æ–­\nRollptræŒ‡å‘çš„æ˜¯è¯¥è®°å½•çš„ä¸Šä¸€ä¸ªç‰ˆæœ¬çš„ä½ç½®ï¼ŒåŒ…æ‹¬space numberï¼Œpage numberå’Œpageå†…çš„offsetã€‚æ²¿ç€Rollptrå¯ä»¥æ‰¾åˆ°ä¸€ä¸ªRecordçš„æ‰€æœ‰å†å²ç‰ˆæœ¬ã€‚\nUpdate Fieldsä¸­è®°å½•çš„å°±æ˜¯å½“å‰è¿™ä¸ªRecordç‰ˆæœ¬ç›¸å¯¹äºå…¶ä¹‹åçš„ä¸€æ¬¡ä¿®æ”¹çš„Deltaä¿¡æ¯ï¼ŒåŒ…æ‹¬æ‰€æœ‰è¢«ä¿®æ”¹çš„Fieldçš„ç¼–å·ï¼Œé•¿åº¦å’Œå†å²å€¼ã€‚\n\nå››ã€Undo Recordçš„ç»„ç»‡æ–¹å¼ä¸Šé¢ä»‹ç»äº†ä¸€ä¸ªUndo Recordä¸­çš„å­˜æ”¾çš„å†…å®¹ï¼Œæ¯ä¸€æ¬¡çš„ä¿®æ”¹éƒ½ä¼šäº§ç”Ÿè‡³å°‘ä¸€ä¸ªUndo Recordï¼Œé‚£ä¹ˆå¤§é‡Undo Recordå¦‚ä½•ç»„ç»‡èµ·æ¥ï¼Œæ¥æ”¯æŒé«˜æ•ˆçš„è®¿é—®å’Œç®¡ç†å‘¢ï¼Œè¿™ä¸€å°èŠ‚æˆ‘ä»¬å°†ä»å‡ ä¸ªå±‚é¢æ¥è¿›è¡Œä»‹ç»ï¼šé¦–å…ˆæ˜¯åœ¨ä¸è€ƒè™‘ç‰©ç†å­˜å‚¨çš„æƒ…å†µä¸‹çš„é€»è¾‘ç»„ç»‡æ–¹å¼ï¼› ä¹‹åï¼Œç‰©ç†ç»„ç»‡æ–¹å¼ä»‹ç»å¦‚ä½•å°†å…¶å­˜å‚¨åˆ°å®é™…16KBç‰©ç†å—ä¸­ï¼›ç„¶åæ–‡ä»¶ç»„ç»‡æ–¹å¼ä»‹ç»æ•´ä½“çš„æ–‡ä»¶ç»“æ„ï¼›æœ€åå†ä»‹ç»å…¶åœ¨å†…å­˜ä¸­çš„ç»„ç»‡æ–¹å¼ã€‚\né€»è¾‘ç»„ç»‡æ–¹å¼ - Undo Logæ¯ä¸ªäº‹åŠ¡å…¶å®ä¼šä¿®æ”¹ä¸€ç»„çš„Recordï¼Œå¯¹åº”çš„ä¹Ÿå°±ä¼šäº§ç”Ÿä¸€ç»„Undo Recordï¼Œè¿™äº›Undo Recordæ”¶å°¾ç›¸è¿å°±ç»„æˆäº†è¿™ä¸ªäº‹åŠ¡çš„Undo Logã€‚é™¤äº†ä¸€ä¸ªä¸ªçš„Undo Recordä¹‹å¤–ï¼Œè¿˜åœ¨å¼€å¤´å¢åŠ äº†ä¸€ä¸ªUndo Log Headeræ¥è®°å½•ä¸€äº›å¿…è¦çš„æ§åˆ¶ä¿¡æ¯ï¼Œå› æ­¤ï¼Œä¸€ä¸ªUndo Logçš„ç»“æ„å¦‚ä¸‹æ‰€ç¤ºï¼š\nUndo Log Headerä¸­è®°å½•äº†äº§ç”Ÿè¿™ä¸ªUndo Logçš„äº‹åŠ¡çš„ Trx IDï¼›\nTrx No æ˜¯äº‹åŠ¡çš„æäº¤é¡ºåºï¼Œä¹Ÿä¼šç”¨è¿™ä¸ªæ¥åˆ¤æ–­æ˜¯å¦èƒ½Purgeï¼Œè¿™ä¸ªåœ¨åé¢ä¼šè¯¦ç»†ä»‹ç»ï¼›\nDelete Mark è¡¨æ˜è¯¥Undo Logä¸­æœ‰æ²¡æœ‰ TRX_UNDO_DEL_MARK_REC ç±»å‹çš„Undo Recordï¼Œé¿å…Purgeæ—¶ä¸å¿…è¦çš„æ‰«æï¼›\nLog Start Offset ä¸­è®°å½•Undo Log Headerçš„ç»“æŸä½ç½®ï¼Œæ–¹ä¾¿ä¹‹åHeaderä¸­å¢åŠ å†…å®¹æ—¶çš„å…¼å®¹ï¼›\nä¹‹åæ˜¯ä¸€äº›Flagä¿¡æ¯ï¼›\nNext Undo Log åŠ Prev Undo Log æ ‡è®°å‰åä¸¤ä¸ªUndo Logï¼Œè¿™ä¸ªä¼šåœ¨æ¥ä¸‹æ¥ä»‹ç»ï¼›\næœ€åé€šè¿‡ History List Node å°†è‡ªå·±æŒ‚è½½åˆ°ä¸ºPurgeå‡†å¤‡çš„History Listä¸­ã€‚\nç´¢å¼•ä¸­çš„åŒä¸€ä¸ªRecordè¢«ä¸åŒäº‹åŠ¡ä¿®æ”¹ï¼Œä¼šäº§ç”Ÿä¸åŒçš„å†å²ç‰ˆæœ¬ï¼Œè¿™äº›å†å²ç‰ˆæœ¬åˆé€šè¿‡Rollptrç©¿æˆä¸€ä¸ªé“¾è¡¨ï¼Œä¾›MVCCä½¿ç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç¤ºä¾‹ä¸­æœ‰ä¸‰ä¸ªäº‹åŠ¡æ“ä½œäº†è¡¨tä¸Šï¼Œä¸»é”®idæ˜¯1çš„è®°å½•ï¼Œé¦–å…ˆäº‹åŠ¡Iæ’å…¥äº†è¿™æ¡è®°å½•å¹¶ä¸”è®¾ç½®filed açš„å€¼æ˜¯Aï¼Œä¹‹åäº‹åŠ¡Jå’Œäº‹åŠ¡Kåˆ†åˆ«å°†è¿™æ¡idä¸º1çš„è®°å½•ä¸­çš„filed açš„å€¼ä¿®æ”¹ä¸ºäº†Bå’ŒCã€‚\nIï¼ŒJï¼ŒKä¸‰ä¸ªäº‹åŠ¡åˆ†åˆ«æœ‰è‡ªå·±çš„é€»è¾‘ä¸Šè¿ç»­çš„ä¸‰æ¡Undo Logï¼Œæ¯æ¡Undo Logæœ‰è‡ªå·±çš„Undo Log Headerã€‚\nä»ç´¢å¼•ä¸­çš„è¿™æ¡Recordæ²¿ç€Rollptrå¯ä»¥ä¾æ¬¡æ‰¾åˆ°è¿™ä¸‰ä¸ªäº‹åŠ¡Undo Logä¸­å…³äºè¿™æ¡è®°å½•çš„å†å²ç‰ˆæœ¬ã€‚\nåŒæ—¶å¯ä»¥çœ‹å‡ºï¼ŒInsertç±»å‹Undo Recordä¸­åªè®°å½•äº†å¯¹åº”çš„ä¸»é”®å€¼ï¼šid=1ï¼Œè€ŒUpdateç±»å‹çš„Undo Recordä¸­è¿˜è®°å½•äº†å¯¹åº”çš„å†å²ç‰ˆæœ¬çš„ç”Ÿæˆäº‹åŠ¡Trx_idï¼Œä»¥åŠè¢«ä¿®æ”¹çš„field açš„å†å²å€¼ã€‚\nç‰©ç†ç»„ç»‡æ ¼å¼ - Undo Segmentä¸Šé¢æè¿°äº†ä¸€ä¸ªUndo Logçš„ç»“æ„ï¼Œä¸€ä¸ªäº‹åŠ¡ä¼šäº§ç”Ÿå¤šå¤§çš„Undo Logæœ¬èº«æ˜¯ä¸å¯æ§çš„ï¼Œè€Œæœ€ç»ˆå†™å…¥ç£ç›˜å´æ˜¯æŒ‰ç…§å›ºå®šçš„å—å¤§å°ä¸ºå•ä½çš„ï¼ŒInnoDBä¸­é»˜è®¤æ˜¯16KBï¼Œé‚£ä¹ˆå¦‚ä½•ç”¨å›ºå®šçš„å—å¤§å°æ‰¿è½½ä¸å®šé•¿çš„Undo Logï¼Œä»¥å®ç°é«˜æ•ˆçš„ç©ºé—´åˆ†é…ã€å¤ç”¨ï¼Œé¿å…ç©ºé—´æµªè´¹ã€‚\nInnoDBçš„åŸºæœ¬æ€è·¯æ˜¯è®©å¤šä¸ªè¾ƒå°çš„Undo Logç´§å‡‘å­˜åœ¨ä¸€ä¸ªUndo Pageä¸­ï¼Œè€Œå¯¹è¾ƒå¤§çš„Undo Logåˆ™éšç€ä¸æ–­çš„å†™å…¥ï¼ŒæŒ‰éœ€åˆ†é…è¶³å¤Ÿå¤šçš„Undo Pageåˆ†æ•£æ‰¿è½½ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹çœ‹è¿™éƒ¨åˆ†çš„ç‰©ç†å­˜å‚¨æ–¹å¼ï¼š\n\nå¦‚ä¸Šæ‰€ç¤ºï¼Œæ˜¯ä¸€ä¸ªUndo Segmentçš„ç¤ºæ„å›¾ï¼Œæ¯ä¸ªå†™äº‹åŠ¡å¼€å§‹å†™æ“ä½œä¹‹å‰éƒ½éœ€è¦æŒæœ‰ä¸€ä¸ªUndo Segmentï¼Œä¸€ä¸ªUndo Segmentä¸­çš„æ‰€æœ‰ç£ç›˜ç©ºé—´çš„åˆ†é…å’Œé‡Šæ”¾ï¼Œä¹Ÿå°±æ˜¯16KB Pageçš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªFSPçš„Segmentç®¡ç†çš„ï¼Œè¿™ä¸ªè·Ÿç´¢å¼•ä¸­çš„Leaf Node Segmentå’ŒNon-Leaf Node Segmentçš„ç®¡ç†æ–¹å¼æ˜¯ä¸€è‡´çš„ï¼Œè¿™éƒ¨åˆ†ä¹‹åä¼šæœ‰å•ç‹¬çš„æ–‡ç« æ¥è¿›è¡Œä»‹ç»ã€‚\nUndo Segmentä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Pageï¼Œæ¯ä¸ªUndo Pageä¼šåœ¨å¼€å¤´38å­—èŠ‚åˆ°56å­—èŠ‚è®°å½•Undo Page Headerï¼Œå…¶ä¸­è®°å½•Undo Pageçš„ç±»å‹ã€æœ€åä¸€æ¡Undo Recordçš„ä½ç½®ï¼Œå½“å‰Pageè¿˜ç©ºé—²éƒ¨åˆ†çš„å¼€å¤´ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€æ¡Undo Recordè¦å†™å…¥çš„ä½ç½®ã€‚Undo Segmentä¸­çš„ç¬¬ä¸€ä¸ªUndo Pageè¿˜ä¼šåœ¨56å­—èŠ‚åˆ°86å­—èŠ‚è®°å½•Undo Segment Headerï¼Œè¿™ä¸ªå°±æ˜¯è¿™ä¸ªUndo Segmentä¸­ç£ç›˜ç©ºé—´ç®¡ç†çš„Handleï¼›å…¶ä¸­è®°å½•çš„æ˜¯è¿™ä¸ªUndo Segmentçš„çŠ¶æ€ï¼Œæ¯”å¦‚TRX_UNDO_CACHEDã€TRX_UNDO_TO_PURGEç­‰ï¼›è¿™ä¸ªUndo Segmentä¸­æœ€åä¸€æ¡Undo Recordçš„ä½ç½®ï¼›è¿™ä¸ªFSP Segmentçš„Headerï¼Œä»¥åŠå½“å‰åˆ†é…å‡ºæ¥çš„æ‰€æœ‰Undo Pageçš„é“¾è¡¨ã€‚\nUndo Pageå‰©ä½™çš„ç©ºé—´éƒ½æ˜¯ç”¨æ¥å­˜æ”¾Undo Logçš„ï¼Œå¯¹äºåƒä¸Šå›¾Undo Log 1ï¼ŒUndo Log 2è¿™ç§è¾ƒçŸ­çš„Undo Logï¼Œä¸ºäº†é¿å…Pageå†…çš„ç©ºé—´æµªè´¹ï¼ŒInnoDBä¼šå¤ç”¨Undo Pageæ¥å­˜æ”¾å¤šä¸ªUndo Logï¼Œè€Œå¯¹äºåƒUndo Log 3è¿™ç§æ¯”è¾ƒé•¿çš„Undo Logå¯èƒ½ä¼šåˆ†é…å¤šä¸ªUndo Pageæ¥å­˜æ”¾ã€‚éœ€è¦æ³¨æ„çš„æ˜¯Undo Pageçš„å¤ç”¨åªä¼šå‘ç”Ÿåœ¨ç¬¬ä¸€ä¸ªPageã€‚\næ–‡ä»¶ç»„ç»‡æ–¹å¼ - Undo Tablespaceæ¯ä¸€æ—¶åˆ»ä¸€ä¸ªUndo Segmentéƒ½æ˜¯è¢«ä¸€ä¸ªäº‹åŠ¡ç‹¬å çš„ã€‚æ¯ä¸ªå†™äº‹åŠ¡éƒ½ä¼šæŒæœ‰è‡³å°‘ä¸€ä¸ªUndo Segmentï¼Œå½“æœ‰å¤§é‡å†™äº‹åŠ¡å¹¶å‘è¿è¡Œæ—¶ï¼Œå°±éœ€è¦å­˜åœ¨å¤šä¸ªUndo Segmentã€‚InnoDBä¸­çš„Undo æ–‡ä»¶ä¸­å‡†å¤‡äº†å¤§é‡çš„Undo Segmentçš„æ§½ä½ï¼ŒæŒ‰ç…§1024ä¸€ç»„åˆ’åˆ†ä¸ºRollback Segmentã€‚æ¯ä¸ªUndo Tablespaceæœ€å¤šä¼šåŒ…å«128ä¸ªRollback Segmentï¼ŒUndo Tablespaceæ–‡ä»¶ä¸­çš„ç¬¬ä¸‰ä¸ªPageä¼šå›ºå®šä½œä¸ºè¿™128ä¸ªRollback Segmentçš„ç›®å½•ï¼Œä¹Ÿå°±æ˜¯Rollback Segment Arrary Headerï¼Œå…¶ä¸­æœ€å¤šä¼šæœ‰128ä¸ªæŒ‡é’ˆæŒ‡å‘å„ä¸ªRollback Segment Headeræ‰€åœ¨çš„Pageã€‚Rollback Segment Headeræ˜¯æŒ‰éœ€åˆ†é…çš„ï¼Œå…¶ä¸­åŒ…å«1024ä¸ªSlotï¼Œæ¯ä¸ªSlotå å››ä¸ªå­—èŠ‚ï¼ŒæŒ‡å‘ä¸€ä¸ªUndo Segmentçš„First Pageã€‚é™¤æ­¤ä¹‹å‰è¿˜ä¼šè®°å½•è¯¥Rollback Segmentä¸­å·²æäº¤äº‹åŠ¡çš„History Listï¼Œåç»­çš„Purgeè¿‡ç¨‹ä¼šé¡ºåºä»è¿™é‡Œå¼€å§‹å›æ”¶å·¥ä½œã€‚\nå¯ä»¥çœ‹å‡ºRollback Segmentçš„ä¸ªæ•°ä¼šç›´æ¥å½±å“InnoDBæ”¯æŒçš„æœ€å¤§äº‹åŠ¡å¹¶å‘æ•°ã€‚MySQL 8.0ç”±äºæ”¯æŒäº†æœ€å¤š127ä¸ªç‹¬ç«‹çš„Undo Tablespaceï¼Œä¸€æ–¹é¢é¿å…äº†ibdata1çš„è†¨èƒ€ï¼Œæ–¹ä¾¿undoç©ºé—´å›æ”¶ï¼Œå¦ä¸€æ–¹é¢ä¹Ÿå¤§å¤§å¢åŠ äº†æœ€å¤§çš„Rollback Segmentçš„ä¸ªæ•°ï¼Œå¢åŠ äº†å¯æ”¯æŒçš„æœ€å¤§å¹¶å‘å†™äº‹åŠ¡æ•°ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå†…å­˜ç»„ç»‡ç»“æ„ä¸Šé¢ä»‹ç»çš„éƒ½æ˜¯Undoæ•°æ®åœ¨ç£ç›˜ä¸Šçš„ç»„ç»‡ç»“æ„ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å†…å­˜ä¸­ä¹Ÿä¼šç»´æŠ¤å¯¹åº”çš„æ•°æ®ç»“æ„æ¥ç®¡ç†Undo Logï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå¯¹åº”æ¯ä¸ªç£ç›˜Undo Tablespaceä¼šæœ‰ä¸€ä¸ªundo::Tablespaceçš„å†…å­˜ç»“æ„ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„å°±æ˜¯ä¸€ç»„trx_rseg_tçš„é›†åˆï¼Œtrx_rseg_tå¯¹åº”çš„å°±æ˜¯ä¸Šé¢ä»‹ç»è¿‡çš„ä¸€ä¸ªRollback Segment Headerï¼Œé™¤äº†ä¸€äº›åŸºæœ¬çš„å…ƒä¿¡æ¯ä¹‹å¤–ï¼Œtrx_rseg_tä¸­ç»´æŠ¤äº†å››ä¸ªtrx_undo_tçš„é“¾è¡¨ï¼ŒUpdate Listä¸­æ˜¯æ­£åœ¨è¢«ä½¿ç”¨çš„ç”¨äºå†™å…¥Updateç±»å‹Undoçš„Undo Segmentï¼›\nUpdate Cache Listä¸­æ˜¯ç©ºé—²ç©ºé—´æ¯”è¾ƒå¤šï¼Œå¯ä»¥è¢«åç»­äº‹åŠ¡å¤ç”¨çš„Updateç±»å‹Undo Segment;\nå¯¹åº”çš„ï¼ŒInsert Listå’ŒInsert Cache Liståˆ†åˆ«æ˜¯æ­£åœ¨ä½¿ç”¨ä¸­çš„Insertç±»å‹Undo Segmentï¼Œå’Œç©ºé—´ç©ºé—´è¾ƒå¤šï¼Œå¯ä»¥è¢«åç»­å¤ç”¨çš„Insertç±»å‹Undo Segmentã€‚å› æ­¤trx_undo_tå¯¹åº”çš„å°±æ˜¯ä¸Šé¢ä»‹ç»è¿‡çš„Undo Segmentã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±ä»Undoçš„å†™å…¥ã€Undoç”¨äºRollbackã€MVCCã€Crash Recoveryä»¥åŠå¦‚ä½•æ¸…ç†Undoç­‰æ–¹é¢æ¥ä»‹ç»InnoDBä¸­Undoçš„è§’è‰²å’ŒåŠŸèƒ½ã€‚\näº”ã€Undoçš„å†™å…¥å½“å†™äº‹åŠ¡å¼€å§‹æ—¶ï¼Œä¼šå…ˆé€šè¿‡trx_assign_rseg_durableåˆ†é…ä¸€ä¸ªRollback Segmentï¼Œè¯¥äº‹åŠ¡çš„å†…å­˜ç»“æ„trx_tä¹Ÿä¼šé€šè¿‡rsegsæŒ‡é’ˆæŒ‡å‘å¯¹åº”çš„trx_rseg_tå†…å­˜ç»“æ„ï¼Œè¿™é‡Œçš„åˆ†é…ç­–ç•¥å¾ˆç®€å•ï¼Œå°±æ˜¯ä¾æ¬¡å°è¯•ä¸‹ä¸€ä¸ªActiveçš„Rollback Segmentã€‚\nä¹‹åå½“ç¬¬ä¸€æ¬¡çœŸæ­£äº§ç”Ÿä¿®æ”¹éœ€è¦å†™Undo Recordçš„æ—¶ï¼Œä¼šè°ƒç”¨trx_undo_assign_undoæ¥è·å¾—ä¸€ä¸ªUndo Segmentã€‚è¿™é‡Œä¼šä¼˜å…ˆå¤ç”¨trx_rseg_tä¸ŠCached Listä¸­çš„trx_undo_tï¼Œä¹Ÿå°±æ˜¯å·²ç»åˆ†é…å‡ºæ¥ä½†æ²¡æœ‰è¢«æ­£åœ¨ä½¿ç”¨çš„Undo Segmentï¼Œå¦‚æœæ²¡æœ‰æ‰è°ƒç”¨trx_undo_createåˆ›å»ºæ–°çš„Undo Segmentï¼Œtrx_undo_createä¸­ä¼šè½®è¯¢é€‰æ‹©å½“å‰Rollback Segmentä¸­å¯ç”¨çš„Slotï¼Œä¹Ÿæ˜¯å°±å€¼FIL_NULçš„Slotï¼Œç”³è¯·æ–°çš„Undo Pageï¼Œåˆå§‹åŒ–Undo Page Headerï¼ŒUndo Segment Headerç­‰ä¿¡æ¯ï¼Œåˆ›å»ºæ–°çš„trx_undo_tå†…å­˜ç»“æ„å¹¶æŒ‚åˆ°trx_rseg_tçš„å¯¹åº”Listä¸­ã€‚\nè·å¾—äº†å¯ç”¨çš„Undo Segmentä¹‹åï¼Œè¯¥äº‹åŠ¡ä¼šåœ¨åˆé€‚çš„ä½ç½®åˆå§‹åŒ–è‡ªå·±çš„Undo Log Headerï¼Œä¹‹åï¼Œå…¶æ‰€æœ‰ä¿®æ”¹äº§ç”Ÿçš„Undo Recordéƒ½ä¼šé¡ºåºçš„é€šè¿‡trx_undo_report_row_operationé¡ºåºçš„å†™å…¥å½“å‰çš„Undo Logï¼Œå…¶ä¸­ä¼šæ ¹æ®æ˜¯insertè¿˜æ˜¯updateç±»å‹ï¼Œåˆ†åˆ«è°ƒç”¨trx_undo_page_report_insertæˆ–è€…trx_undo_page_report_modifyã€‚\næœ¬æ–‡å¼€å§‹å·²ç»ä»‹ç»è¿‡äº†å…·ä½“çš„Undo Recordå†…å®¹ã€‚ç®€å•çš„è®²ï¼Œinsertç±»å‹ä¼šè®°å½•æ’å…¥Recordçš„ä¸»é”®ï¼Œupdateç±»å‹é™¤äº†è®°å½•ä¸»é”®ä»¥å¤–è¿˜ä¼šæœ‰ä¸€ä¸ªupdate filedsè®°å½•è¿™ä¸ªå†å²å€¼è·Ÿç´¢å¼•å€¼çš„diffã€‚ä¹‹åæŒ‡å‘å½“å‰Undo Recordä½ç½®çš„Rollpträ¼šè¿”å›å†™å…¥ç´¢å¼•çš„Recordä¸Šã€‚\nå½“ä¸€ä¸ªPageå†™æ»¡åï¼Œä¼šè°ƒç”¨trx_undo_add_pageæ¥åœ¨å½“å‰çš„Undo Segmentä¸Šæ·»åŠ æ–°çš„Pageï¼Œæ–°Pageå†™å…¥Undo Page Headerä¹‹åç»§ç»­ä¾›äº‹åŠ¡å†™å…¥Undo Recordï¼Œä¸ºäº†æ–¹ä¾¿ç»´æŠ¤ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªé™åˆ¶å°±æ˜¯å•æ¡Undo Recordä¸è·¨pageï¼Œå¦‚æœå½“å‰Pageæ”¾ä¸ä¸‹ï¼Œä¼šå°†æ•´ä¸ªUndo Recordå†™å…¥ä¸‹ä¸€ä¸ªPageã€‚\nå½“äº‹åŠ¡ç»“æŸï¼ˆcommitæˆ–è€…rollbackï¼‰ä¹‹åï¼Œå¦‚æœåªå ç”¨äº†ä¸€ä¸ªUndo Pageï¼Œä¸”å½“å‰Undo Pageä½¿ç”¨ç©ºé—´å°äºpageçš„3/4ï¼Œè¿™ä¸ªUndo Segmentä¼šä¿ç•™å¹¶åŠ å…¥åˆ°å¯¹åº”çš„insert/update cached listä¸­ã€‚å¦åˆ™ï¼Œinsertç±»å‹çš„Undo Segmentä¼šç›´æ¥å›æ”¶ï¼Œè€Œupdateç±»å‹çš„Undo Segmentä¼šç­‰å¾…åå°çš„Purgeåšå®Œåå›æ”¶ã€‚æ ¹æ®ä¸åŒçš„æƒ…å†µï¼ŒUndo Segment Headerä¸­çš„Stateä¼šè¢«ä»TRX_UNDO_ACTIVEæ”¹æˆTRX_UNDO_TO_FREEï¼ŒTRX_UNDO_TO_PURGEæˆ–TRX_UNDO_CACHEDï¼Œè¿™ä¸ªä¿®æ”¹å…¶å®å°±æ˜¯InnoDBçš„äº‹åŠ¡ç»“æŸçš„æ ‡å¿—ï¼Œæ— è®ºæ˜¯Rollbackè¿˜æ˜¯Commitï¼Œåœ¨è¿™ä¸ªä¿®æ”¹å¯¹åº”çš„Redoè½ç›˜ä¹‹åï¼Œå°±å¯ä»¥è¿”å›ç”¨æˆ·ç»“æœï¼Œå¹¶ä¸”Crash Recoveryä¹‹åä¹Ÿä¸ä¼šå†åšå›æ»šå¤„ç†ã€‚\nå…­ã€Undo for RollbackInnoDBä¸­çš„äº‹åŠ¡å¯èƒ½ä¼šç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘Rollbackï¼›ä¹Ÿå¯èƒ½å› ä¸ºé‡åˆ°æ­»é”å¼‚å¸¸Rollbackï¼›æˆ–è€…å‘ç”ŸCrashï¼Œé‡å¯åå¯¹æœªæäº¤çš„äº‹åŠ¡å›æ»šã€‚åœ¨Undoå±‚é¢æ¥çœ‹ï¼Œè¿™äº›å›æ»šçš„æ“ä½œæ˜¯ä¸€è‡´çš„ï¼ŒåŸºæœ¬çš„è¿‡ç¨‹å°±æ˜¯ä»è¯¥äº‹åŠ¡çš„Undo Logä¸­ï¼Œä»åå‘å‰ä¾æ¬¡è¯»å–Undo Recordï¼Œå¹¶æ ¹æ®å…¶ä¸­å†…å®¹åšé€†å‘æ“ä½œï¼Œæ¢å¤ç´¢å¼•è®°å½•ã€‚\nå›æ»šçš„å…¥å£æ˜¯å‡½æ•°row_undoï¼Œå…¶ä¸­ä¼šå…ˆè°ƒç”¨trx_roll_pop_top_rec_of_trxè·å–å¹¶åˆ é™¤è¯¥äº‹åŠ¡çš„æœ€åä¸€æ¡Undo Recordã€‚\nå¦‚ä¸‹å›¾ä¾‹å­ä¸­çš„Undo LogåŒ…æ‹¬ä¸‰æ¡Undo Recordsï¼Œå…¶ä¸­Record 1åœ¨Undo Page 1ä¸­ï¼ŒRecord 2ï¼Œ3åœ¨Undo Page 2ä¸­ï¼Œå…ˆé€šè¿‡ä»Undo Segment Headerä¸­è®°å½•çš„Page Listæ‰¾åˆ°å½“å‰äº‹åŠ¡çš„æœ€åä¸€ä¸ªUndo Pageçš„Headerï¼Œå¹¶æ ¹æ®Undo Page 2çš„Headerä¸Šè®°å½•çš„Free Space Offsetå®šä½æœ€åä¸€æ¡Undo Recordç»“æŸçš„ä½ç½®ï¼Œå½“ç„¶å®é™…è¿è¡Œæ—¶ï¼Œè¿™ä¸¤ä¸ªå€¼æ˜¯ç¼“å­˜åœ¨trx_undo_tçš„top_page_noå’Œtop_offsetä¸­çš„ã€‚åˆ©ç”¨Prev Record Offsetå¯ä»¥æ‰¾åˆ°Undo Record 3ï¼Œåšå®Œå¯¹åº”çš„å›æ»šæ“ä½œä¹‹åï¼Œå†é€šè¿‡å‰åºæŒ‡é’ˆPrev Record Offsetæ‰¾åˆ°å‰ä¸€ä¸ªUndo Recordï¼Œä¾æ¬¡è¿›è¡Œå¤„ç†ã€‚å¤„ç†å®Œå½“å‰Pageä¸­çš„æ‰€æœ‰Undo Recordsåï¼Œå†æ²¿ç€Undo Page Headerä¸­çš„Listæ‰¾åˆ°å‰ä¸€ä¸ªUndo Pageï¼Œé‡å¤å‰é¢çš„è¿‡ç¨‹ï¼Œå®Œæˆä¸€ä¸ªäº‹åŠ¡æ‰€æœ‰Pageä¸Šçš„æ‰€æœ‰Undo Recordsçš„å›æ»šã€‚\n\næ‹¿åˆ°ä¸€ä¸ªUndo Recordä¹‹åï¼Œè‡ªç„¶åœ°ï¼Œå°±æ˜¯å¯¹å…¶ä¸­å†…å®¹çš„è§£æï¼Œè¿™é‡Œä¼šè°ƒç”¨row_undo_ins_parse_undo_recï¼Œä»Undo Recordä¸­è·å–ä¿®æ”¹è¡Œçš„tableï¼Œè§£æå‡ºå…¶ä¸­è®°å½•çš„ä¸»é”®ä¿¡æ¯ï¼Œå¦‚æœæ˜¯updateç±»å‹ï¼Œè¿˜ä¼šæ‹¿åˆ°ä¸€ä¸ªupdate vectorè®°å½•å…¶ç›¸å¯¹äºæ›´æ–°çš„ä¸€ä¸ªç‰ˆæœ¬çš„å˜åŒ–ã€‚\nTRX_UNDO_INSERT_RECç±»å‹çš„Undoå›æ»šåœ¨row_undo_insä¸­è¿›è¡Œï¼Œinsertçš„é€†å‘æ“ä½œå½“ç„¶å°±æ˜¯deleteï¼Œæ ¹æ®ä»Undo Recordä¸­è§£æå‡ºæ¥çš„ä¸»é”®ï¼Œç”¨row_undo_search_clust_to_pcurå®šä½åˆ°å¯¹åº”çš„ROWï¼Œ åˆ†åˆ«è°ƒç”¨row_undo_ins_remove_sec_recå’Œrow_undo_ins_remove_clust_recåœ¨äºŒçº§ç´¢å¼•å’Œä¸»ç´¢å¼•ä¸Šå°†å½“å‰è¡Œåˆ é™¤ã€‚\nupdateç±»å‹çš„undoåŒ…æ‹¬TRX_UNDO_UPD_EXIST_RECï¼ŒTRX_UNDO_DEL_MARK_RECå’ŒTRX_UNDO_UPD_DEL_RECä¸‰ç§æƒ…å†µï¼Œä»–ä»¬çš„Undoå›æ»šéƒ½æ˜¯åœ¨row_undo_modä¸­è¿›è¡Œï¼Œé¦–å…ˆä¼šè°ƒç”¨row_undo_mod_del_unmark_sec_and_undo_updateï¼Œå…¶ä¸­æ ¹æ®ä»Undo Recordä¸­è§£æå‡ºçš„update vectoræ¥å›é€€è¿™æ¬¡æ“ä½œåœ¨æ‰€æœ‰äºŒçº§ç´¢å¼•ä¸Šçš„å½±å“ï¼Œå¯èƒ½åŒ…æ‹¬é‡æ–°æ’å…¥è¢«åˆ é™¤çš„äºŒçº§ç´¢å¼•è®°å½•ã€å»é™¤å…¶ä¸­çš„Delete Markæ ‡è®°ï¼Œæˆ–è€…ç”¨update vectorä¸­çš„diffä¿¡æ¯å°†äºŒçº§ç´¢å¼•è®°å½•ä¿®æ”¹ä¹‹å‰çš„å€¼ã€‚ä¹‹åè°ƒç”¨row_undo_mod_cluståŒæ ·åˆ©ç”¨update vectorä¸­è®°å½•çš„diffä¿¡æ¯å°†ä¸»ç´¢å¼•è®°å½•ä¿®æ”¹å›ä¹‹å‰çš„å€¼ã€‚\nå®Œæˆå›æ»šçš„Undo Logéƒ¨åˆ†ï¼Œä¼šè°ƒç”¨trx_roll_try_truncateè¿›è¡Œå›æ”¶ï¼Œå¯¹ä¸å†ä½¿ç”¨çš„pageè°ƒç”¨trx_undo_free_last_pageå°†ç£ç›˜ç©ºé—´äº¤è¿˜ç»™Undo Segmentï¼Œè¿™ä¸ªæ˜¯å†™å…¥è¿‡ç¨‹ä¸­trx_undo_add_pageçš„é€†æ“ä½œã€‚\nä¸ƒã€Undo for MVCCå¤šç‰ˆæœ¬çš„ç›®çš„æ˜¯ä¸ºäº†é¿å…å†™äº‹åŠ¡å’Œè¯»äº‹åŠ¡çš„äº’ç›¸ç­‰å¾…ï¼Œé‚£ä¹ˆæ¯ä¸ªè¯»äº‹åŠ¡éƒ½éœ€è¦åœ¨ä¸å¯¹RecordåŠ Lockçš„æƒ…å†µä¸‹ï¼Œ æ‰¾åˆ°å¯¹åº”çš„åº”è¯¥çœ‹åˆ°çš„å†å²ç‰ˆæœ¬ã€‚\næ‰€è°“å†å²ç‰ˆæœ¬å°±æ˜¯å‡è®¾åœ¨è¯¥åªè¯»äº‹åŠ¡å¼€å§‹çš„æ—¶å€™å¯¹æ•´ä¸ªDBæ‰“ä¸€ä¸ªå¿«ç…§ï¼Œä¹‹åè¯¥äº‹åŠ¡çš„æ‰€æœ‰è¯»è¯·æ±‚éƒ½ä»è¿™ä¸ªå¿«ç…§ä¸Šè·å–ã€‚\nå½“ç„¶å®ç°ä¸Šä¸èƒ½çœŸæ­£å»ä¸ºæ¯ä¸ªäº‹åŠ¡æ‰“ä¸€ä¸ªå¿«ç…§ï¼Œè¿™ä¸ªæ—¶é—´ç©ºé—´éƒ½å¤ªé«˜äº†ã€‚\nInnoDBçš„åšæ³•ï¼Œæ˜¯åœ¨è¯»äº‹åŠ¡ç¬¬ä¸€æ¬¡è¯»å–çš„æ—¶å€™è·å–ä¸€ä»½ReadViewï¼Œå¹¶ä¸€ç›´æŒæœ‰ï¼Œå…¶ä¸­è®°å½•æ‰€æœ‰å½“å‰æ´»è·ƒçš„å†™äº‹åŠ¡IDï¼Œç”±äºå†™äº‹åŠ¡çš„IDæ˜¯è‡ªå¢åˆ†é…çš„ï¼Œé€šè¿‡è¿™ä¸ªReadViewæˆ‘ä»¬å¯ä»¥çŸ¥é“åœ¨è¿™ä¸€ç¬é—´ï¼Œå“ªäº›äº‹åŠ¡å·²ç»æäº¤å“ªäº›è¿˜åœ¨è¿è¡Œï¼Œæ ¹æ®Read Committedçš„è¦æ±‚ï¼Œæœªæäº¤çš„äº‹åŠ¡çš„ä¿®æ”¹å°±æ˜¯ä¸åº”è¯¥è¢«çœ‹è§çš„ï¼Œå¯¹åº”åœ°ï¼Œå·²ç»æäº¤çš„äº‹åŠ¡çš„ä¿®æ”¹åº”è¯¥è¢«çœ‹åˆ°ã€‚\nä½œä¸ºå­˜å‚¨å†å²ç‰ˆæœ¬çš„Undo Recordï¼Œå…¶ä¸­è®°å½•çš„trx_idå°±æ˜¯åšè¿™ä¸ªå¯è§æ€§åˆ¤æ–­çš„ï¼Œå¯¹åº”çš„ä¸»ç´¢å¼•çš„Recordä¸Šä¹Ÿæœ‰è¿™ä¸ªå€¼ã€‚\nå½“ä¸€ä¸ªè¯»äº‹åŠ¡æ‹¿ç€è‡ªå·±çš„ReadViewè®¿é—®æŸä¸ªè¡¨ç´¢å¼•ä¸Šçš„è®°å½•æ—¶ï¼Œä¼šé€šè¿‡æ¯”è¾ƒRecordä¸Šçš„trx_idç¡®å®šæ˜¯å¦æ˜¯å¯è§çš„ç‰ˆæœ¬ï¼Œå¦‚æœä¸å¯è§å°±æ²¿ç€Recordæˆ–Undo Recordä¸­è®°å½•çš„rollpträ¸€è·¯æ‰¾æ›´è€çš„å†å²ç‰ˆæœ¬ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œäº‹åŠ¡Rå¼€å§‹éœ€è¦æŸ¥è¯¢è¡¨tä¸Šçš„idä¸º1çš„è®°å½•ï¼ŒRå¼€å§‹æ—¶äº‹åŠ¡Iå·²ç»æäº¤ï¼Œäº‹åŠ¡Jè¿˜åœ¨è¿è¡Œï¼Œäº‹åŠ¡Kè¿˜æ²¡å¼€å§‹ï¼Œè¿™äº›ä¿¡æ¯éƒ½è¢«è®°å½•åœ¨äº†äº‹åŠ¡Rçš„ReadViewä¸­ã€‚äº‹åŠ¡Rä»ç´¢å¼•ä¸­æ‰¾åˆ°å¯¹åº”çš„è¿™æ¡Record[1, C]ï¼Œå¯¹åº”çš„trx_idæ˜¯Kï¼Œä¸å¯è§ã€‚æ²¿ç€Rollptræ‰¾åˆ°Undoä¸­çš„å‰ä¸€ç‰ˆæœ¬[1, B]ï¼Œå¯¹åº”çš„trx_idæ˜¯Jï¼Œä¸å¯è§ã€‚ç»§ç»­æ²¿ç€Rollptræ‰¾åˆ°[1, A]ï¼Œtrx_idæ˜¯Iå¯è§ï¼Œè¿”å›ç»“æœã€‚\n\nå‰é¢æåˆ°è¿‡ï¼Œä½œä¸ºLogical Logï¼ŒUndoä¸­è®°å½•çš„å…¶å®æ˜¯å‰åä¸¤ä¸ªç‰ˆæœ¬çš„diffä¿¡æ¯ï¼Œè€Œè¯»æ“ä½œæœ€ç»ˆæ˜¯è¦è·å¾—å®Œæ•´çš„Recordå†…å®¹çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¿™ä¸ªæ²¿ç€rollptræŒ‡é’ˆä¸€è·¯æŸ¥æ‰¾çš„è¿‡ç¨‹ä¸­éœ€è¦ç”¨Undo Recordä¸­çš„diffå†…å®¹ä¾æ¬¡æ„é€ å‡ºå¯¹åº”çš„å†å²ç‰ˆæœ¬ï¼Œè¿™ä¸ªè¿‡ç¨‹åœ¨å‡½æ•°row_search_mvccä¸­ï¼Œå…¶ä¸­trx_undo_prev_version_buildä¼šæ ¹æ®å½“å‰çš„rollptræ‰¾åˆ°å¯¹åº”çš„Undo Recordä½ç½®ï¼Œè¿™é‡Œå¦‚æœrollptræŒ‡å‘çš„æ˜¯insertç±»å‹ï¼Œæˆ–è€…æ‰¾åˆ°äº†å·²ç»Purgeäº†çš„ä½ç½®ï¼Œè¯´æ˜åˆ°å¤´äº†ï¼Œä¼šç›´æ¥è¿”å›å¤±è´¥ã€‚å¦åˆ™ï¼Œå°±ä¼šè§£æå¯¹åº”çš„Undo Recordï¼Œæ¢å¤å‡ºtrx_idã€æŒ‡å‘ä¸‹ä¸€æ¡Undo Recordçš„rollptrã€ä¸»é”®ä¿¡æ¯ï¼Œdiffä¿¡æ¯update vectorç­‰ä¿¡æ¯ã€‚ä¹‹åé€šè¿‡row_upd_rec_in_placeï¼Œç”¨update vectorä¿®æ”¹å½“å‰æŒæœ‰çš„Recordæ‹·è´ä¸­çš„ä¿¡æ¯ï¼Œè·å¾—Recordçš„è¿™ä¸ªå†å²ç‰ˆæœ¬ã€‚ä¹‹åè°ƒç”¨è‡ªå·±ReadViewçš„changes_visibleåˆ¤æ–­å¯è§æ€§ï¼Œå¦‚æœå¯è§åˆ™è¿”å›ç”¨æˆ·ã€‚å®Œæˆè¿™ä¸ªå†å²ç‰ˆæœ¬çš„è¯»å–ã€‚\nå…«ã€Undo for Crash RecoveryCrash Recoveryæ—¶ï¼Œéœ€è¦åˆ©ç”¨Undoä¸­çš„ä¿¡æ¯å°†æœªæäº¤çš„äº‹åŠ¡çš„æ‰€æœ‰å½±å“å›æ»šï¼Œä»¥ä¿è¯æ•°æ®åº“çš„Failure Atomicã€‚\nå‰é¢æåˆ°è¿‡ï¼ŒInnoDBä¸­çš„Undoå…¶å®æ˜¯åƒæ•°æ®ä¸€æ ·å¤„ç†çš„ï¼Œä¹Ÿä»ä¸Šé¢çš„ç»„ç»‡ç»“æ„ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒUndoæœ¬èº«æœ‰ç€æ¯”Redo Logå¤æ‚å¾—å¤šã€æŒ‰äº‹åŠ¡åˆ†é…è€Œä¸æ˜¯é¡ºåºå†™å…¥çš„ç»„ç»‡ç»“æ„ï¼Œå…¶æœ¬èº«çš„DurabilityåƒInnoDBä¸­å…¶ä»–çš„æ•°æ®ä¸€æ ·ï¼Œéœ€è¦é Redoæ¥ä¿è¯ï¼Œåƒåº–ä¸è§£InnoDBä¹‹REDO LOGä¸­ä»‹ç»çš„é‚£æ ·ã€‚\né™¤äº†é€šç”¨çš„ä¸€äº›MLOG_2BYTESã€MLOG_4BYTESç±»å‹ä¹‹å¤–ï¼ŒUndoæœ¬èº«ä¹Ÿæœ‰è‡ªå·±å¯¹åº”çš„Redo Logç±»å‹ï¼š\nMLOG_UNDO_INITç±»å‹åœ¨Undo Pageèˆ’é€‚åŒ–çš„æ—¶å€™è®°å½•åˆå§‹åŒ–ï¼›åœ¨åˆ†é…Undo Logçš„æ—¶å€™ï¼Œéœ€è¦é‡ç”¨Undo Log Headeræˆ–éœ€è¦åˆ›å»ºæ–°çš„Undo Log Headerçš„æ—¶å€™ï¼Œä¼šåˆ†åˆ«è®°å½•MLOG_UNDO_HDR_REUSEå’ŒMLOG_UNDO_HDR_CREATEç±»å‹çš„Redo Recordï¼›\nMLOG_UNDO_INSERTæ˜¯æœ€å¸¸è§çš„ï¼Œåœ¨Undo Logé‡Œå†™å…¥æ–°çš„Undo Recordéƒ½å¯¹åº”çš„å†™è¿™ä¸ªæ—¥å¿—è®°å½•å†™å…¥Undoä¸­çš„æ‰€æœ‰å†…å®¹ï¼›\nMLOG_UNDO_ERASE_END å¯¹åº”Undo Logè·¨Undo Pageæ—¶æŠ¹é™¤æœ€åä¸€ä¸ªä¸å®Œæ•´çš„Undo Recordçš„æ“ä½œã€‚\nå¦‚æ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶çš„å‰ä¸–ä»Šç”Ÿä¸­è®²è¿‡çš„ARIESè¿‡ç¨‹ï¼ŒCrash Recoveryçš„è¿‡ç¨‹ä¸­ä¼šå…ˆé‡æ”¾æ‰€æœ‰çš„Redo Logï¼Œæ•´ä¸ªUndoçš„ç£ç›˜ç»„ç»‡ç»“æ„ï¼Œä¹Ÿä¼šä½œä¸ºä¸€ç§æ•°æ®ç±»å‹ä¹Ÿä¼šé€šè¿‡ä¸Šé¢è®²åˆ°çš„è¿™äº›Redoç±»å‹çš„é‡æ”¾æ¢å¤å‡ºæ¥ã€‚ä¹‹ååœ¨trx_sys_init_at_db_startä¸­ä¼šæ‰«æUndoçš„ç£ç›˜ç»“æ„ï¼Œéå†æ‰€æœ‰çš„Rollback Segmentå’Œå…¶ä¸­æ‰€æœ‰çš„Undo Segmentï¼Œé€šè¿‡è¯»å–Undo Segment Headerä¸­çš„Stateï¼Œå¯ä»¥çŸ¥é“åœ¨Crashå‰ï¼Œæœ€åæŒæœ‰è¿™ä¸ªUndo Segmentçš„äº‹åŠ¡çŠ¶æ€ã€‚å¦‚æœæ˜¯TRX_UNDO_ACTIVEï¼Œè¯´æ˜å½“æ—¶äº‹åŠ¡éœ€è¦å›æ»šï¼Œå¦åˆ™è¯´æ˜äº‹åŠ¡å·²ç»ç»“æŸï¼Œå¯ä»¥ç»§ç»­æ¸…ç†Undo Segmentçš„é€»è¾‘ã€‚ä¹‹åï¼Œå°±å¯ä»¥æ¢å¤å‡ºUndo Logçš„å†…å­˜ç»„ç»‡æ¨¡å¼ï¼ŒåŒ…æ‹¬æ´»è·ƒäº‹åŠ¡çš„å†…å­˜ç»“æ„trx_tï¼ŒRollback Segmentçš„å†…å­˜ç»“æ„trx_rseg_tï¼Œä»¥åŠå…¶ä¸­çš„trx_undo_tçš„å››ä¸ªé“¾è¡¨ã€‚\nCrash Recoveryå®Œæˆä¹‹å‰ï¼Œä¼šå¯åŠ¨åœ¨srv_dict_recover_on_restartä¸­å¯åŠ¨å¼‚æ­¥å›æ»šçº¿ç¨‹trx_recovery_rollback_threadï¼Œå…¶ä¸­å¯¹Crashå‰è¿˜æ´»è·ƒçš„äº‹åŠ¡ï¼Œé€šè¿‡trx_rollback_activeè¿›è¡Œå›æ»šï¼Œè¿™ä¸ªè¿‡ç¨‹æ›´ä¸Šé¢æåˆ°çš„Undo for Rollbackæ˜¯ä¸€è‡´çš„ã€‚\nä¹ã€Undoçš„æ¸…ç†æˆ‘ä»¬å·²ç»çŸ¥é“ï¼ŒInnoDBåœ¨Undo Logä¸­ä¿å­˜äº†å¤šä»½å†å²ç‰ˆæœ¬æ¥å®ç°MVCCï¼Œå½“æŸä¸ªå†å²ç‰ˆæœ¬å·²ç»ç¡®è®¤ä¸ä¼šè¢«ä»»ä½•ç°æœ‰çš„å’Œæœªæ¥çš„äº‹åŠ¡çœ‹åˆ°çš„æ—¶å€™ï¼Œå°±åº”è¯¥è¢«æ¸…ç†æ‰ã€‚å› æ­¤å°±éœ€è¦æœ‰åŠæ³•åˆ¤æ–­å“ªäº›Undo Logä¸ä¼šå†è¢«çœ‹åˆ°ã€‚\nInnoDBä¸­æ¯ä¸ªå†™äº‹åŠ¡ç»“æŸæ—¶éƒ½ä¼šæ‹¿ä¸€ä¸ªé€’å¢çš„ç¼–å·trx_noä½œä¸ºäº‹åŠ¡çš„æäº¤åºå·ï¼Œè€Œæ¯ä¸ªè¯»äº‹åŠ¡ä¼šåœ¨è‡ªå·±çš„ReadViewä¸­è®°å½•è‡ªå·±å¼€å§‹çš„æ—¶å€™çœ‹åˆ°çš„æœ€å¤§çš„trx_noä¸ºm_low_limit_noã€‚é‚£ä¹ˆï¼Œå¦‚æœä¸€ä¸ªäº‹åŠ¡çš„trx_noå°äºå½“å‰æ‰€æœ‰æ´»è·ƒçš„è¯»äº‹åŠ¡Readviewä¸­çš„è¿™ä¸ªm_low_limit_noï¼Œè¯´æ˜è¿™ä¸ªäº‹åŠ¡åœ¨æ‰€æœ‰çš„è¯»å¼€å§‹ä¹‹å‰å·²ç»æäº¤äº†ï¼Œå…¶ä¿®æ”¹çš„æ–°ç‰ˆæœ¬æ˜¯å¯è§çš„ï¼Œ å› æ­¤ä¸å†éœ€è¦é€šè¿‡undoæ„å»ºä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¿™ä¸ªäº‹åŠ¡çš„Undo Logä¹Ÿå°±å¯ä»¥è¢«æ¸…ç†äº†ã€‚\nå¦‚ä¸‹å›¾æ‰€æ‰€ä»¥ï¼Œç”±äºReadView Listä¸­æœ€è€çš„ReadViewåœ¨è·å–æ—¶ï¼ŒTransaction Jå°±å·²ç»Commitï¼Œå› æ­¤æ‰€æœ‰çš„è¯»äº‹åŠ¡éƒ½ä¸€å®šèƒ½è¢«Indexä¸­çš„ç‰ˆæœ¬æˆ–è€…ç¬¬ä¸€ä¸ªUndoå†å²ç‰ˆæœ¬æ»¡è¶³ï¼Œä¸éœ€è¦æ›´è€çš„Undoï¼Œå› æ­¤æ•´ä¸ªTransaction Jçš„Undo Logéƒ½å¯ä»¥æ¸…ç†äº†ã€‚\n\nUndoçš„æ¸…ç†å·¥ä½œæ˜¯ç”±ä¸“é—¨çš„åå°çº¿ç¨‹srv_purge_coordinator_threadè¿›è¡Œæ‰«æå’Œåˆ†å‘ï¼Œ å¹¶ç”±å¤šä¸ªsrv_worker_threadçœŸæ­£æ¸…ç†çš„ã€‚coordinatorä¼šé¦–å…ˆåœ¨å‡½æ•°trx_purge_attach_undo_recsä¸­æ‰«æinnodb_purge_batch_sizeé…ç½®ä¸ªUndo Recordsï¼Œä½œä¸ºä¸€è½®æ¸…ç†çš„ä»»åŠ¡åˆ†å‘ç»™workerã€‚\næ‰«æä¸€æ‰¹è¦æ¸…ç†Undo Recordsäº‹åŠ¡ç»“æŸçš„æ—¶å€™ï¼Œå¯¹äºéœ€è¦Purgeçš„Updateç±»å‹çš„Undo Logï¼Œä¼šæŒ‰ç…§äº‹åŠ¡æäº¤çš„é¡ºåºtrx_noï¼ŒæŒ‚è½½åˆ°Rollback Segment Headerçš„History Listä¸Šã€‚Undo Logå›æ”¶çš„åŸºæœ¬æ€è·¯ï¼Œå°±æ˜¯æŒ‰ç…§trx_noä»å°åˆ°å¤§ï¼Œä¾æ¬¡éå†æ‰€æœ‰Undo Logè¿›è¡Œæ¸…ç†æ“ä½œã€‚\nå‰é¢ä»‹ç»äº†ï¼ŒInnoDBä¸­æœ‰å¤šä¸ªRollback Segmentï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å¤šä¸ªHistory Listï¼Œæ¯ä¸ªHistory Listå†…éƒ¨äº‹åŠ¡æœ‰åºï¼Œä½†è¿˜éœ€è¦ä»å¤šä¸ªHistory Listä¸Šæ‰¾ä¸€ä¸ªtrx_noå…¨å±€æœ‰åºçš„åºåˆ—ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå›¾ä¸­çš„äº‹åŠ¡ç¼–å·æ˜¯æŒ‰ç…§InnoDBè¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªå †ç»“æ„purge_queueï¼Œç”¨æ¥ä¾æ¬¡ä»æ‰€æœ‰History Listä¸­æ‰¾åˆ°ä¸‹ä¸€ä¸ªæ‹¥æœ‰æœ€å°trx_noçš„äº‹åŠ¡ã€‚purge_queueä¸­è®°å½•äº†æ‰€æœ‰ç­‰å¾…Purgeçš„Rollback Segmentå’Œå…¶Historyä¸­trx_noæœ€å°çš„äº‹åŠ¡ï¼Œtrx_purge_choose_next_logä¾æ¬¡ä»purge_queueä¸­popå‡ºæ‹¥æœ‰å…¨å±€æœ€å°trx_noçš„Undo Logã€‚è°ƒç”¨trx_purge_get_next_recéå†å¯¹åº”çš„Undo Logï¼Œå¤„ç†æ¯ä¸€æ¡Undo Recordã€‚ä¹‹åç»§ç»­è°ƒç”¨trx_purge_rseg_get_next_history_logä»purge_queueä¸­è·å–ä¸‹ä¸€æ¡trx_noæœ€å°çš„Undo Logï¼Œå¹¶ä¸”å°†å½“å‰Rollback Segmentä¸Šçš„ä¸‹ä¸€æ¡Undo Logç»§ç»­pushè¿›purge_queueï¼Œç­‰å¾…åç»­çš„é¡ºåºå¤„ç†ã€‚å¯¹åº”ä¸Šå›¾çš„å¤„ç†è¿‡ç¨‹å’Œå¯¹åº”çš„å‡½æ•°è°ƒç”¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n[trx_purge_choose_next_log] Pop T1 from purge_queue;[trx_purge_get_next_rec] Iterator T1;[trx_purge_rseg_get_next_history_log] Get T1 next: T5;[trx_purge_choose_next_log] Push T5 into purge_queue;[trx_purge_choose_next_log] Pop T4 from purge_queue;[trx_purge_get_next_rec] Iterator T4;[trx_purge_rseg_get_next_history_log] Get T4 next: ...;[trx_purge_choose_next_log] Push ... into purge_queue;[trx_purge_choose_next_log] Pop T5 from purge_queue;[trx_purge_get_next_rec] Iterator T5;[trx_purge_rseg_get_next_history_log] Get T5 next: T6;[trx_purge_choose_next_log] Push T6 into purge_queue;......\n\nå…¶ä¸­ï¼Œtrx_purge_get_next_recä¼šä»ä¸Šåˆ°ä¸‹éå†ä¸€ä¸ªUndo Logä¸­çš„æ‰€æœ‰Undo Recordï¼Œè¿™ä¸ªè·Ÿå‰é¢è®²è¿‡çš„Rollbackæ—¶å€™ä»ä¸‹åˆ°ä¸Šçš„éå†æ–¹å‘æ˜¯ç›¸åçš„ï¼Œè¿˜æ˜¯ä»¥åŒæ ·çš„åœºæ™¯ä¸ºä¾‹ï¼Œè¦Purgeçš„Undo Logæ¨ªè·¨ä¸¤ä¸ªUndo Pageï¼ŒUndo Record 1åœ¨Page 1ä¸­ï¼Œè€ŒUndo Record 2ï¼Œ3åœ¨Page 2ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé¦–å…ˆä¼šä»å½“å‰çš„Undo Log Headerä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªUndo Recordçš„ä½ç½®Log Start Offsetï¼Œå¤„ç†å®ŒUndo Record1ä¹‹åæ²¿ç€Next Record Offsetå»æ‰¾ä¸‹ä¸€ä¸ªUndo Recordï¼Œå½“æ‰¾åˆ°Pageæœ«å°¾æ—¶ï¼Œè¦é€šè¿‡Page List Nodeæ‰¾ä¸‹ä¸€ä¸ªPageï¼Œæ‰¾åˆ°Pageå†…çš„ç¬¬ä¸€ä¸ªUndo Recordï¼Œé‡å¤ä¸Šé¢çš„è¿‡ç¨‹ç›´åˆ°æ‰¾å‡ºæ‰€æœ‰çš„Undo Recordã€‚\n\nå¯¹æ¯ä¸ªè¦Purgeçš„Undo Recordï¼Œåœ¨çœŸæ­£åˆ é™¤å®ƒæœ¬èº«ä¹‹å‰ï¼Œå¯èƒ½è¿˜éœ€è¦å¤„ç†ä¸€äº›ç´¢å¼•ä¸Šçš„ä¿¡æ¯ï¼Œè¿™æ˜¯ç”±äºæ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“éœ€è¦åˆ é™¤æŸä¸ªRecordæ—¶ï¼Œä¸ºäº†ä¿è¯å…¶ä¹‹å‰çš„å†å²ç‰ˆæœ¬è¿˜å¯ä»¥é€šè¿‡Rollptræ‰¾åˆ°ï¼ŒRecordæ˜¯æ²¡æœ‰çœŸæ­£åˆ é™¤çš„ï¼Œåªæ˜¯æ‰“äº†Delete Markçš„æ ‡è®°ï¼Œå¹¶ä½œä¸ºä¸€ç§ç‰¹æ®Šçš„Updateæ“ä½œè®°å½•äº†Undo Recordã€‚é‚£ä¹ˆåœ¨å¯¹åº”çš„TRX_UNDO_DEL_MARK_RECç±»å‹çš„Undo Recordè¢«æ¸…ç†ä¹‹å‰ï¼Œéœ€è¦å…ˆä»ç´¢å¼•ä¸ŠçœŸæ­£åœ°åˆ é™¤è¿™ä¸ªDelete Markçš„è®°å½•ã€‚å› æ­¤Undo Recordçš„æ¸…ç†å·¥ä½œä¼šåˆ†ä¸ºä¸¤ä¸ªè¿‡ç¨‹ï¼š\n\nTRX_UNDO_DEL_MARK_RECç±»å‹Undo Recordå¯¹åº”çš„Recordçš„çœŸæ­£åˆ é™¤ï¼Œç§°ä¸ºUndo Purgeï¼›\nä»¥åŠUndo Recordæœ¬èº«ä»æ—§åˆ°æ–°çš„åˆ é™¤ï¼Œç§°ä¸ºUndo Truncateã€‚\n\né™¤æ­¤ä¹‹å¤–ï¼Œå½“é…ç½®çš„ç‹¬ç«‹Undo Tablespaceå¤§äºä¸¤ä¸ªçš„æ—¶å€™ï¼ŒInnoDBæ”¯æŒé€šè¿‡é‡å»ºæ¥ç¼©å°è¶…è¿‡é…ç½®å¤§å°çš„Undo Tablespaceï¼š\n\nUndo Tablespaceçš„é‡å»ºç¼©å°ï¼Œç§°ä¸ºUndo Tablespace Truncate\n\nUndo Purgeè¿™ä¸€æ­¥ä¸»è¦é’ˆå¯¹çš„æ˜¯TRX_UNDO_DEL_MARK_RECç±»å‹çš„Undo Recordï¼Œç”¨æ¥çœŸæ­£çš„åˆ é™¤ç´¢å¼•ä¸Šè¢«æ ‡è®°ä¸ºDelete Markçš„Recordã€‚workerçº¿ç¨‹ä¼šåœ¨row_purgeå‡½æ•°ä¸­ï¼Œå¾ªç¯å¤„ç†coordinatoråˆ†é…æ¥çš„æ¯ä¸€ä¸ªUndo Recordsï¼Œå…ˆé€šè¿‡row_purge_parse_undo_recï¼Œä¾æ¬¡ä»Undo Recordä¸­è§£æå‡ºtypeã€table_idã€rollptrã€å¯¹åº”è®°å½•çš„ä¸»é”®ä¿¡æ¯ä»¥åŠupdate vectorã€‚ä¹‹åï¼Œé’ˆå¯¹TRX_UNDO_DEL_MARK_RECç±»å‹ï¼Œè°ƒç”¨row_purge_remove_sec_if_posså°†éœ€è¦åˆ é™¤çš„è®°å½•ä»æ‰€æœ‰çš„äºŒçº§ç´¢å¼•ä¸Šåˆ é™¤ï¼Œè°ƒç”¨row_purge_remove_clust_if_possä»ä¸»ç´¢å¼•ä¸Šåˆ é™¤ã€‚å¦å¤–ï¼ŒTRX_UNDO_UPD_EXIST_RECç±»å‹çš„Undoè™½ç„¶ä¸æ¶‰åŠä¸»ç´¢å¼•çš„åˆ é™¤ï¼Œä½†å¯èƒ½éœ€è¦åšäºŒçº§ç´¢å¼•çš„åˆ é™¤ï¼Œä¹Ÿæ˜¯åœ¨è¿™é‡Œå¤„ç†çš„ã€‚\nUndo Truncatecoordinatorçº¿ç¨‹ä¼šç­‰å¾…æ‰€æœ‰çš„workerå®Œæˆä¸€æ‰¹Undo Recordsçš„Purgeå·¥ä½œï¼Œä¹‹åå°è¯•æ¸…ç†ä¸å†éœ€è¦çš„Undo Logï¼Œtrx_purge_truncateå‡½æ•°ä¸­ä¼šéå†æ‰€æœ‰çš„Rollback Segmentä¸­çš„æ‰€æœ‰Undo Segmentï¼Œå¦‚æœå…¶çŠ¶æ€æ˜¯TRX_UNDO_TO_PURGEï¼Œè°ƒç”¨trx_purge_free_segmenté‡Šæ”¾å ç”¨çš„ç£ç›˜ç©ºé—´å¹¶ä»History Listä¸­åˆ é™¤ã€‚å¦åˆ™ï¼Œè¯´æ˜è¯¥Undo Segmentæ­£åœ¨è¢«ä½¿ç”¨æˆ–è€…è¿˜åœ¨è¢«cacheï¼ˆTRX_UNDO_CACHEDç±»å‹ï¼‰ï¼Œé‚£ä¹ˆåªé€šè¿‡trx_purge_remove_log_hdå°†å…¶ä»History Listä¸­åˆ é™¤ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒUndo Truncateçš„åŠ¨ä½œå¹¶ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šè¿›è¡Œçš„ï¼Œå®ƒçš„é¢‘æ¬¡æ˜¯ç”±å‚æ•°innodb_rseg_truncate_frequencyæ§åˆ¶çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¦æ”’innodb_rseg_truncate_frequencyä¸ªbatchæ‰è¿›è¡Œä¸€æ¬¡ï¼Œå‰é¢æåˆ°æ¯ä¸€ä¸ªbatchä¸­ä¼šå¤„ç†innodb_purge_batch_sizeä¸ªUndo Recordsï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬ä»show engine innodb statusä¸­çœ‹åˆ°çš„Undo History Listçš„ç¼©çŸ­æ˜¯è·³å˜çš„ã€‚\nUndo Tablespace Truncateå¦‚æœinnodb_trx_purge_truncateé…ç½®æ‰“å¼€ï¼Œåœ¨å‡½æ•°trx_purge_truncateä¸­è¿˜ä¼šå»å°è¯•é‡å»ºUndo Tablespacesä»¥ç¼©å°æ–‡ä»¶ç©ºé—´å ç”¨ã€‚Undo Truncateä¹‹åï¼Œä¼šåœ¨å‡½æ•°trx_purge_mark_undo_for_truncateä¸­æ‰«ææ‰€æœ‰çš„Undo Tablespaceï¼Œæ–‡ä»¶å¤§å°å¤§äºé…ç½®çš„innodb_max_undo_log_sizeçš„Tablespaceä¼šè¢«æ ‡è®°ä¸ºinactiveï¼Œæ¯ä¸€æ—¶åˆ»æœ€å¤šæœ‰ä¸€ä¸ªTablespaceå¤„äºinactiveï¼Œinactiveçš„Undo Tablespaceä¸Šçš„æ‰€æœ‰Rollback Segmentéƒ½ä¸å‚ä¸ç»™æ–°äº‹ç‰©çš„åˆ†é…ï¼Œç­‰è¯¥æ–‡ä»¶ä¸Šæ‰€æœ‰çš„æ´»è·ƒäº‹åŠ¡é€€å‡ºï¼Œå¹¶ä¸”æ‰€æœ‰çš„Undo Logéƒ½å®ŒæˆPurgeä¹‹åï¼Œè¿™ä¸ªTablespaceå°±ä¼šè¢«é€šè¿‡trx_purge_initiate_truncateé‡å»ºï¼ŒåŒ…æ‹¬é‡å»ºUndo Tablespaceä¸­çš„æ–‡ä»¶ç»“æ„å’Œå†…å­˜ç»“æ„ï¼Œä¹‹åè¢«é‡æ–°æ ‡è®°ä¸ºactiveï¼Œå‚ä¸åˆ†é…ç»™æ–°çš„äº‹åŠ¡ä½¿ç”¨ã€‚\næ€»ç»“ï¼šæœ¬æ–‡é¦–å…ˆæ¦‚æ‹¬åœ°ä»‹ç»äº†Undo Logçš„è§’è‰²ï¼Œä¹‹åä»‹ç»äº†ä¸€ä¸ªUndo Recordä¸­çš„å†…å®¹ï¼Œç´§æ¥ç€ä»‹ç»å®ƒçš„é€»è¾‘ç»„ç»‡æ–¹å¼ã€ç‰©ç†ç»„ç»‡æ–¹å¼ã€æ–‡ä»¶ç»„ç»‡æ–¹å¼ä»¥åŠå†…å­˜ç»„ç»‡æ–¹å¼ï¼Œè¯¦ç»†æè¿°äº†Undo Tablespaceã€Rollback Segmentã€Undo Segmentã€Undo Logå’ŒUndo Recordçš„ä¹‹é—´çš„å…³ç³»å’Œå±‚çº§ã€‚è¿™äº›ç»„ç»‡æ–¹å¼éƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„ä½¿ç”¨å’Œç»´æŠ¤Undoä¿¡æ¯ã€‚æœ€ååœ¨æ­¤åŸºç¡€ä¸Šï¼Œä»‹ç»äº†Undoåœ¨å„ä¸ªé‡è¦çš„DBåŠŸèƒ½ä¸­çš„ä½œç”¨å’Œå®ç°æ–¹å¼ï¼ŒåŒ…æ‹¬äº‹åŠ¡å›æ»šã€MVCCã€Crash Recoveryã€Purgeç­‰ã€‚\n","categories":["MySQL"]},{"title":"æ•°æ®åº“äº‹åŠ¡éš”ç¦»å‘å±•å†å²","url":"/posts/38370/","content":"äº‹åŠ¡éš”ç¦»æ˜¯æ•°æ®åº“ç³»ç»Ÿè®¾è®¡ä¸­æ ¹æœ¬çš„ç»„æˆéƒ¨åˆ†ï¼Œæœ¬æ–‡ä¸»è¦ä»æ ‡å‡†å±‚é¢æ¥è®¨è®ºéš”ç¦»çº§åˆ«çš„å‘å±•å†å²ï¼Œé¦–å…ˆæ˜ç¡®éš”ç¦»çº§åˆ«åˆ’åˆ†çš„ç›®æ ‡ï¼›ä¹‹åæ¦‚è¿°å…¶å¦å®šä¹‹å¦å®šçš„å‘å±•å†ç¨‹ï¼›è¿›è€Œå¼•å‡º Adyaç»™å‡ºçš„æ¯”è¾ƒåˆç†çš„éš”ç¦»çº§åˆ«å®šä¹‰ï¼Œæœ€ç»ˆæ€»ç»“éš”ç¦»æ ‡å‡†ä¸€è·¯èµ°æ¥çš„æ€è·¯ã€‚\nä¸€ã€ç›®æ ‡äº‹åŠ¡éš”ç¦»æ˜¯äº‹åŠ¡å¹¶å‘äº§ç”Ÿçš„ç›´æ¥éœ€æ±‚ï¼Œæœ€ç›´è§‚çš„ã€ä¿è¯æ­£ç¡®æ€§çš„éš”ç¦»æ–¹å¼ï¼Œæ˜¾ç„¶æ˜¯è®©å¹¶å‘çš„äº‹åŠ¡ä¾æ¬¡æ‰§è¡Œï¼Œæˆ–æ˜¯çœ‹èµ·æ¥åƒæ˜¯ä¾æ¬¡æ‰§è¡Œã€‚ä½†åœ¨çœŸå®çš„åœºæ™¯ä¸­ï¼Œæœ‰æ—¶å¹¶ä¸éœ€è¦å¦‚æ­¤é«˜çš„æ­£ç¡®æ€§ä¿è¯ï¼Œå› æ­¤å¸Œæœ›ç‰ºç‰²ä¸€äº›æ­£ç¡®æ€§æ¥æé«˜æ•´ä½“æ€§èƒ½ã€‚é€šè¿‡åŒºåˆ«ä¸åŒå¼ºåº¦çš„éš”ç¦»çº§åˆ«ä½¿å¾—ä½¿ç”¨è€…å¯ä»¥åœ¨æ­£ç¡®æ€§å’Œæ€§èƒ½ä¸Šè‡ªç”±æƒè¡¡ã€‚éšç€æ•°æ®åº“äº§å“æ•°é‡ä»¥åŠä½¿ç”¨åœºæ™¯çš„è†¨èƒ€ï¼Œå¸¦æ¥äº†å„ç§éš”ç¦»çº§åˆ«é€‰æ‹©çš„æ··ä¹±ï¼Œæ•°æ®åº“çš„ä¼—å¤šè®¾è®¡è€…å’Œä½¿ç”¨è€…äºŸéœ€ä¸€ä¸ªå¯¹éš”ç¦»çº§åˆ«åˆ’åˆ†çš„å…±è¯†ï¼Œè¿™å°±æ˜¯æ ‡å‡†å‡ºç°çš„æ„ä¹‰ã€‚ä¸€ä¸ªå¥½çš„éš”ç¦»çº§åˆ«å®šä¹‰æœ‰å¦‚ä¸‹ä¸¤ä¸ªé‡è¦çš„ç›®æ ‡ï¼š\n\næ­£ç¡®ï¼šæ¯ä¸ªçº§åˆ«çš„å®šä¹‰ï¼Œåº”è¯¥èƒ½å¤Ÿå°†æ‰€æœ‰æŸå®³è¯¥çº§åˆ«æƒ³è¦ä¿è¯çš„æ­£ç¡®æ€§çš„æƒ…å†µæ’é™¤åœ¨å¤–ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦å®ç°æ»¡è¶³æŸä¸€éš”ç¦»çº§åˆ«å®šä¹‰ï¼Œå°±ä¸€å®šèƒ½è·å¾—å¯¹åº”çš„æ­£ç¡®æ€§ä¿è¯ã€‚\nå®ç°æ— å…³ï¼šå¸¸è§çš„å¹¶å‘æ§åˆ¶çš„å®ç°æ–¹å¼åŒ…æ‹¬ï¼Œé”ã€OCCä»¥åŠå¤šç‰ˆæœ¬ ã€‚è€Œä¸€ä¸ªå¥½çš„æ ‡å‡†ä¸åº”è¯¥é™åˆ¶å…¶å®ç°æ–¹å¼ã€‚\n\näºŒã€ANSI SQLæ ‡å‡†(1992)ï¼šåŸºäºå¼‚è±¡1992å¹´ANSIé¦–å…ˆå°è¯•æŒ‡å®šç»Ÿä¸€çš„éš”ç¦»çº§åˆ«æ ‡å‡†ï¼Œå…¶å®šä¹‰äº†ä¸åŒçº§åˆ«çš„å¼‚è±¡(phenomenas)ï¼Œ å¹¶ä¾æ®èƒ½é¿å…å¤šå°‘å¼‚è±¡æ¥åˆ’åˆ†éš”ç¦»æ ‡å‡†ã€‚å¼‚è±¡åŒ…æ‹¬ï¼š\n\nè„è¯»ï¼ˆDirty Readï¼‰: è¯»åˆ°äº†å…¶ä»–äº‹åŠ¡è¿˜æœªæäº¤çš„æ•°æ®ï¼›\nä¸å¯é‡å¤è¯»ï¼ˆNon-Repeatable/Fuzzy Readï¼‰ï¼šç”±äºå…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹ï¼Œå¯¹æŸæ•°æ®çš„ä¸¤æ¬¡è¯»å–ç»“æœä¸åŒï¼ˆå› ä¸ºå…¶ä»–äº‹ç‰©å·²æäº¤ï¼Œæ‰€ä»¥åœ¨è¯¥äº‹åŠ¡ä¸­å¯è§ï¼‰ï¼›\nå¹»è¯»ï¼ˆPhantom Readï¼‰ï¼šåœ¨è‡ªå·±çš„äº‹åŠ¡ä¸­ï¼Œåœ¨ä¸¤ä¸ªè¿ç»­çš„æŸ¥æ‰¾ä¹‹é—´ï¼Œä¸€ä¸ªå¹¶å‘çš„äº‹åŠ¡å¢åŠ æˆ–åˆ é™¤äº†æ•°æ®ï¼Œå¯¼è‡´è¿™ä¸¤ä¸ªæŸ¥è¯¢è¿”å›äº†ä¸åŒçš„ç»“æœï¼ˆæ³¨ï¼šä¸å¯é‡å¤è¯»ä¸å¹»è¯»å¾ˆç›¸ä¼¼ï¼Œä¸å¯é‡å¤è¯»çš„é‡ç‚¹æ˜¯ä¿®æ”¹ï¼Œè€Œå¹»è¯»çš„é‡ç‚¹åœ¨äºæ–°å¢æˆ–è€…åˆ é™¤ï¼‰ã€‚\n\né€šè¿‡é˜»æ­¢ä¸åŒçš„å¼‚è±¡å‘ç”Ÿï¼Œå¾—åˆ°äº†å››ç§ä¸åŒçº§åˆ«çš„éš”ç¦»æ ‡å‡†ï¼š\nANSI SQLæ ‡å‡†çœ‹èµ·æ¥æ˜¯éå¸¸ç›´è§‚çš„åˆ’åˆ†æ–¹å¼ï¼Œä¸æƒ³è¦ä»€ä¹ˆå°±æ’é™¤ä»€ä¹ˆï¼Œå¹¶ä¸”åšåˆ°äº†å®ç°æ— å…³ã€‚ç„¶è€Œï¼Œç°å®å¹¶ä¸åƒæƒ³è±¡ç¾å¥½ã€‚å› ä¸ºå®ƒå¹¶ä¸æ­£ç¡®ã€‚\nä¸‰ã€A Critique of ANSI(1995)ï¼šåŸºäºé”å‡ å¹´åï¼Œå¾®è½¯çš„ç ”ç©¶å‘˜ä»¬åœ¨A Critique of ANSI SQL Isolation Levelsä¸€æ–‡ä¸­å¯¹ANSIçš„æ ‡å‡†è¿›è¡Œäº†æ‰¹åˆ¤ï¼ŒæŒ‡å‡ºå…¶å­˜åœ¨ä¸¤ä¸ªè‡´å‘½çš„é—®é¢˜ï¼š\n1ï¼Œä¸å®Œæ•´ï¼Œç¼ºå°‘å¯¹Dirty Writeçš„æ’é™¤\nANSI SQLæ ‡å‡†ä¸­æ‰€æœ‰çš„éš”ç¦»çº§åˆ«éƒ½æ²¡æœ‰å°†Dirty Writeè¿™ç§å¼‚è±¡æ’é™¤åœ¨å¤–ï¼Œæ‰€è°“Dirty WriteæŒ‡çš„æ˜¯ä¸¤ä¸ªæœªæäº¤çš„äº‹åŠ¡å…ˆåå¯¹åŒä¸€ä¸ªå¯¹è±¡è¿›è¡Œäº†ä¿®æ”¹ã€‚è€ŒDirty Writeä¹‹æ‰€ä»¥æ˜¯ä¸€ç§å¼‚è±¡ï¼Œä¸»è¦å› ä¸ºä»–ä¼šå¯¼è‡´ä¸‹é¢çš„ä¸€è‡´æ€§é—®é¢˜ï¼š\n\nH0: w1[x] w2[x] w2[y] c2 w1[y] c1\n\nè¿™æ®µå†å²ä¸­ï¼Œå‡è®¾æœ‰ç›¸å…³æ€§çº¦æŸx=yï¼ŒT1å°è¯•å°†äºŒè€…éƒ½ä¿®æ”¹ä¸º1ï¼ŒT2å°è¯•å°†äºŒè€…éƒ½ä¿®æ”¹ä¸º2ï¼Œé¡ºåºæ‰§è¡Œçš„ç»“æœåº”è¯¥æ˜¯äºŒè€…éƒ½ä¸º1æˆ–è€…éƒ½ä¸º2ï¼Œä½†ç”±äºDirty Writeçš„å‘ç”Ÿï¼Œæœ€ç»ˆç»“æœå˜ä¸ºx=2ï¼Œy=1ï¼Œä¸ä¸€è‡´ã€‚\n2ï¼Œæ­§ä¹‰\nANSI SQLçš„è‹±æ–‡è¡¨è¿°æœ‰æ­§ä¹‰ã€‚ä»¥Phantomä¸ºä¾‹ï¼Œå¦‚ä¸‹å›¾å†å²H3ï¼š\n\nH3ï¼šr1[P] w2[insert y to P] r2[z] w2[z] c2 r1[z] c1\n\nå‡è®¾T1æ ¹æ®æ¡ä»¶PæŸ¥è¯¢æ‰€æœ‰çš„é›‡å‘˜åˆ—è¡¨ï¼Œä¹‹åT2å¢åŠ äº†ä¸€ä¸ªé›‡å‘˜å¹¶å¢åŠ äº†é›‡å‘˜äººæ•°å€¼zï¼Œä¹‹åT1è¯»å–é›‡å‘˜äººæ•°zï¼Œæœ€ç»ˆT1çš„åˆ—è¡¨ä¸­çš„äººæ•°æ¯”zå°‘ï¼Œä¸ä¸€è‡´ã€‚ä½†T1å¹¶æ²¡æœ‰åœ¨T2ä¿®æ”¹é“¾è¡¨åå†ä½¿ç”¨Pä¸­çš„å€¼ï¼Œæ˜¯å¦å°±ä¸å±äºANSIä¸­å¯¹Phantomçš„å®šä¹‰äº†å‘¢ï¼Ÿè¿™ä¹Ÿå¯¼è‡´äº†å¯¹ANSIçš„è¡¨è¿°å¯èƒ½æœ‰ä¸¥æ ¼å’Œå®½æ¾ä¸¤ç§è§£è¯»ã€‚å¯¹äºRead Dirtyå’ŒNon-Repeatable/Fuzzy Readä¹Ÿæœ‰åŒæ ·çš„é—®é¢˜ã€‚\né‚£ä¹ˆï¼Œå¦‚ä½•è§£å†³ä¸Šè¿°ä¸¤ä¸ªé—®é¢˜å‘¢ï¼ŸCritique of ANSIçš„ç­”æ¡ˆæ˜¯ï¼šå®å¯é”™æ€ä¸‰åƒï¼Œä¸å¯æ”¾è¿‡ä¸€ä¸ªï¼Œå³ç»™ANSIæ ‡å‡†ä¸­çš„å¼‚è±¡æœ€ä¸¥æ ¼çš„å®šä¹‰ã€‚Critique of ANSIæ”¹é€ äº†å¼‚è±¡çš„å®šä¹‰ï¼š\n\nP0: w1[x]â€¦w2[x]â€¦(c1 or a1) (Dirty Write)\nP1: w1[x]â€¦r2[x]â€¦(c1 or a1) (Dirty Read)\nP2: r1[x]â€¦w2[x]â€¦(c1 or a1) (Fuzzy or Non-Repeatable Read)\nP3: r1[P]â€¦w2[y in P]â€¦(c1 or a1) (Phantom)\n\næ­¤æ—¶å®šä¹‰å·²ç»å¾ˆä¸¥æ ¼äº†ï¼Œç›´æ¥é˜»æ­¢äº†å¯¹åº”çš„è¯»å†™ç»„åˆé¡ºåºã€‚ä»”ç»†å¯ä»¥çœ‹å‡ºï¼Œæ­¤æ—¶å¾—åˆ°çš„å…¶å®å°±æ˜¯åŸºäºé”çš„å®šä¹‰:\n\nRead Uncommittedï¼Œé˜»æ­¢P0ï¼šæ•´ä¸ªäº‹åŠ¡é˜¶æ®µå¯¹xåŠ é•¿å†™é”\nRead Commitedï¼Œé˜»æ­¢P0ï¼ŒP1ï¼šçŸ­è¯»é” + é•¿å†™é”\nRepeatable Readï¼Œé˜»æ­¢P0ï¼ŒP1ï¼ŒP2ï¼šé•¿è¯»é” + çŸ­è°“è¯é” + é•¿å†™é”\nSerializableï¼Œé˜»æ­¢P0ï¼ŒP1ï¼ŒP2ï¼ŒP3ï¼šé•¿è¯»é” + é•¿è°“è¯é” + é•¿å†™é”\n\nå››ã€é—®é¢˜æœ¬è´¨å¯ä»¥çœ‹å‡ºï¼Œè¿™ç§æ–¹å¼çš„éš”ç¦»æ€§å®šä¹‰ä¿è¯äº†æ­£ç¡®æ€§ï¼Œä½†å´äº§ç”Ÿäº†ä¾èµ–å®ç°æ–¹å¼çš„é—®é¢˜ï¼šå¤ªè¿‡ä¸¥æ ¼çš„éš”ç¦»æ€§å®šä¹‰ï¼Œé˜»æ­¢äº†Optimizeæˆ–Multi-versionçš„å®ç°æ–¹å¼ä¸­çš„ä¸€äº›æ­£å¸¸çš„æƒ…å†µï¼š\n\né’ˆå¯¹P0ï¼šOptimizeçš„å®ç°æ–¹å¼å¯èƒ½ä¼šè®©å¤šä¸ªäº‹åŠ¡å„è‡ªå†™è‡ªå·±çš„æœ¬åœ°å‰¯æœ¬ï¼Œæäº¤çš„æ—¶å€™åªè¦é¡ºåºåˆé€‚æ˜¯å¯ä»¥æˆåŠŸçš„ï¼Œåªåœ¨éœ€è¦çš„æ—¶å€™æ‰abortï¼Œä½†è¿™ç§é€‰æ‹©è¢«P0é˜»æ­¢ï¼›\né’ˆå¯¹P2ï¼šåªè¦T1æ²¡æœ‰åœ¨è¯»xï¼Œåç»­æ²¡æœ‰ä¸xç›¸å…³çš„æ“ä½œï¼Œä¸”å…ˆäºT2æäº¤ã€‚åœ¨Optimizeçš„å®ç°ä¸­æ˜¯å¯ä»¥æ¥å—çš„ï¼Œå´è¢«P2é˜»æ­¢ã€‚\n\nå›å¿†Critique of ANSIä¸­æŒ‡å‡ºçš„ANSIæ ‡å‡†é—®é¢˜ï¼ŒåŒ…æ‹¬Dirty Writeå’Œæ­§ä¹‰ï¼Œå…¶å®éƒ½æ˜¯ç”±äºå¤šObjectä¹‹é—´æœ‰ç›¸äº’çº¦æŸå…³ç³»å¯¼è‡´çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå›¾ä¸­é»‘è‰²éƒ¨åˆ†è¡¨ç¤ºçš„æ˜¯ANSIä¸­é’ˆå¯¹æŸä¸€ä¸ªå¼‚è±¡æè¿°çš„å¼‚å¸¸æƒ…å†µï¼Œç°è‰²éƒ¨åˆ†ç”±äºå¤šObjectçº¦æŸå¯¼è‡´çš„å¼‚å¸¸éƒ¨åˆ†ï¼Œä½†è¿™éƒ¨åˆ†åœ¨ä¼ ç»Ÿçš„å¼‚è±¡å®šä¹‰æ–¹å¼ä¸­å¹¶ä¸èƒ½æè¿°ï¼Œå› æ­¤å…¶åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ï¼Œæ‰©å¤§é™åˆ¶çš„èŒƒå›´åˆ°é»„è‰²éƒ¨åˆ†ï¼Œä»è€Œé™åˆ¶äº†æ­£å¸¸çš„æƒ…å†µã€‚ï¼š\n\nç”±æ­¤ï¼Œå¯ä»¥çœ‹å‡ºé—®é¢˜çš„æœ¬è´¨ï¼šç”±äºå¼‚è±¡çš„æè¿°åªé’ˆå¯¹å•ä¸ªobjectï¼Œç¼ºå°‘æè¿°å¤šobjectä¹‹é—´çš„çº¦æŸå…³ç³»ï¼Œå¯¼è‡´éœ€è¦ç”¨é”çš„æ–¹å¼æ¥ä½œå‡ºè¶…å‡ºå¿…é¡»çš„é™åˆ¶ã€‚ç›¸åº”åœ°ï¼Œè§£å†³é—®é¢˜çš„å…³é”®ï¼šè¦æœ‰æ–°çš„å®šä¹‰å¼‚è±¡çš„æ¨¡å‹ï¼Œä½¿ä¹‹èƒ½ç²¾å‡†çš„æè¿°å¤šobjectä¹‹é—´çš„çº¦æŸå…³ç³»ï¼Œä»è€Œä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿç²¾å‡†åœ°é™åˆ¶ä¸Šè¿°ç°è‰²éƒ¨åˆ†ï¼Œè€Œå°†é»„è‰²çš„éƒ¨åˆ†è§£æ”¾å‡ºæ¥ã€‚Adyaç»™å‡ºçš„ç­”æ¡ˆæ˜¯åºåˆ—åŒ–å›¾ã€‚\näº”ã€A Generalized Theory(1999)ï¼šåŸºäºåºåˆ—åŒ–å›¾Adyaåœ¨Weak Consistency: A Generalized Theory and Optimistic Implementations for Distributed Transactionsä¸­ç»™å‡ºäº†åŸºäºåºåˆ—åŒ–å›¾å¾—å®šä¹‰ï¼Œæ€è·¯ä¸ºå…ˆå®šä¹‰å†²çªå…³ç³»ï¼›å¹¶ä»¥å†²çªå…³ç³»ä¸ºæœ‰å‘è¾¹å½¢æˆåºåˆ—åŒ–å›¾ï¼›å†ä»¥å›¾ä¸­çš„ç¯ç±»å‹å®šä¹‰ä¸åŒçš„å¼‚è±¡ï¼›æœ€åé€šè¿‡é˜»æ­¢ä¸åŒçš„å¼‚è±¡æ¥å®šä¹‰éš”ç¦»çº§åˆ«ã€‚\nåºåˆ—åŒ–å›¾ï¼ˆDirect Serialization Graph, DSGï¼‰åºåˆ—åŒ–å›¾æ˜¯ç”¨æœ‰å‘å›¾çš„æ–¹å¼æ¥è¡¨ç¤ºäº‹åŠ¡ç›¸äº’ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œå›¾ä¸­æ¯ä¸ªèŠ‚ç‚¹è¡¨ç¤ºä¸€ä¸ªäº‹åŠ¡ï¼Œæœ‰å‘è¾¹è¡¨ç¤ºå­˜åœ¨ä¸€ç§ä¾èµ–å…³ç³»ï¼Œäº‹åŠ¡éœ€è¦ç­‰åˆ°æ‰€æœ‰æŒ‡å‘å…¶çš„äº‹åŠ¡å…ˆè¡Œæäº¤ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºå†å²çš„åˆæ³•çš„æäº¤é¡ºåºåº”è¯¥ä¸ºï¼šT1ï¼ŒT2ï¼ŒT3ï¼š\n\nè¿™é‡Œçš„æœ‰å‘è¾¹åŒ…æ‹¬ä¸‰ç§æƒ…å†µï¼š\n\nå†™å†™å†²çªwwï¼ˆDirectly Write-Dependsï¼‰ï¼šè¡¨ç¤ºä¸¤ä¸ªäº‹åŠ¡å…ˆåä¿®æ”¹åŒä¸€ä¸ªæ•°æ®åº“Object(w1[x]â€¦w2[x]â€¦)ï¼›\nå…ˆå†™åè¯»å†²çªwrï¼ˆDirectly Read-Dependsï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡ä¿®æ”¹æŸä¸ªæ•°æ®åº“Objectåï¼Œå¦ä¸€ä¸ªå¯¹è¯¥Objectè¿›è¡Œè¯»æ“ä½œï¼ˆw1[x]â€¦r2[x]â€¦ï¼‰ï¼›\nå…ˆè¯»åå†™å†²çªrwï¼ˆDirectly Anti-Dependsï¼‰ï¼šä¸€ä¸ªäº‹åŠ¡è¯»å–æŸä¸ªObjectæˆ–è€…æŸä¸ªRangeåï¼Œå¦ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œäº†ä¿®æ”¹ï¼ˆr1[x]â€¦w2[x]â€¦ or r1[P]â€¦w2[y in P]ï¼‰ï¼›\n\n\nåŸºäºåºåˆ—åŒ–å›¾çš„å¼‚è±¡å®šä¹‰ï¼šæ ¹æ®æœ‰å‘å›¾çš„å®šä¹‰ï¼Œæˆ‘ä»¬å¯ä»¥å°†äº‹åŠ¡å¯¹ä¸åŒObjectçš„ä¾èµ–å…³ç³»è¡¨ç¤ºåˆ°ä¸€å¼ åŒä¸€å¼ å›¾ä¸­ï¼Œè€Œæ‰€è°“å¼‚è±¡å°±æ˜¯åœ¨å›¾ä¸­æ‰¾ä¸åˆ°ä¸€ä¸ªæ­£ç¡®çš„åºåˆ—åŒ–é¡ºåºï¼Œå³å­˜åœ¨æŸç§ç¯ã€‚è€Œè¿™ç§åŸºäºç¯çš„å®šä¹‰å…¶å®å°±æ˜¯å°†åŸºäºLockå®šä¹‰çš„å¼‚è±¡æœ€å°åŒ–åˆ°å›¾ä¸­ç°è‰²éƒ¨åˆ†ï¼š\n1ï¼ŒP0(Dirty Write) æœ€å°åŒ–ä¸º G0(Write Cycles)ï¼šåºåˆ—åŒ–å›¾ä¸­åŒ…å«ä¸¤æ¡è¾¹éƒ½ä¸ºwwå†²çªç»„æˆçš„ç¯ï¼Œå¦‚H0ï¼š\n\nH0: w1[x] w2[x] w2[y] c2 w1[y] c1\n\nå¯ä»¥çœ‹å‡ºT1åœ¨xä¸Šä¸T2å†™å†™å†²çªï¼ŒT2åˆåœ¨yä¸Šä¸T1å†™å†™å†²çªï¼Œå½¢æˆäº†å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç¯ã€‚\n\n2ï¼ŒP1(Dirty Read) æœ€å°åŒ–ä¸º G1ï¼šDirty Readå¼‚è±¡çš„æœ€å°é›†åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†G1a(Aborted Reads)ï¼Œè¯»åˆ°çš„uncommittedæ•°æ®æœ€ç»ˆè¢«abortï¼›G1b(Intermediate Reads) ï¼šè¯»åˆ°å…¶ä»–äº‹åŠ¡ä¸­é—´ç‰ˆæœ¬çš„æ•°æ®ï¼›ä»¥åŠG1c(Circular Information Flow)ï¼šDSGä¸­åŒ…å«wwå†²çªå’Œwrå†²çªå½¢æˆçš„ç¯ã€‚\n3ï¼ŒP2(Fuzzy or Non-Repeatable Read) æœ€å°åŒ–ä¸º G2-item(Item Anti-dependency Cycles) ï¼šDSGä¸­åŒ…å«ç¯ï¼Œä¸”å…¶ä¸­è‡³å°‘æœ‰ä¸€æ¡å…³äºæŸä¸ªobjectçš„rwå†²çª\n4ï¼ŒP3(Phantom) æœ€å°åŒ–ä¸º G2(Anti-dependency Cycles): DSGä¸­åŒ…å«ç¯ï¼Œå¹¶ä¸”å…¶ä¸­è‡³å°‘æœ‰ä¸€æ¡æ˜¯rwå†²çªï¼Œä»ç„¶ä»¥ä¸Šé¢çš„H3ä¸ºä¾‹ï¼š\n\nH3ï¼šr1[P] w2[insert y to P] r2[z] w2[z] c2 r1[z] c1\n\nT1åœ¨è°“è¯Pä¸Šä¸T2 rwå†²çªï¼Œåè¿‡æ¥T2åˆåœ¨zä¸Šä¸T1wrå†²çªï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå¯¹åº”çš„éš”ç¦»çº§åˆ«ï¼šé€šè¿‡ä¸Šé¢çš„è®¨è®ºå¯ä»¥çœ‹å‡ºï¼Œé€šè¿‡ç¯çš„æ–¹å¼æˆ‘ä»¬æˆåŠŸæœ€å°åŒ–äº†å¼‚è±¡çš„é™åˆ¶èŒƒå›´ï¼Œé‚£ä¹ˆæ’é™¤è¿™äº›å¼‚è±¡å°±å¾—åˆ°äº†æ›´å®½æ¾çš„ï¼Œé€šç”¨çš„éš”ç¦»çº§åˆ«å®šä¹‰ï¼š\n\nPL-1ï¼ˆRead Uncommittedï¼‰ï¼šé˜»æ­¢G0\nPL-2ï¼ˆRead Commitedï¼‰ï¼šé˜»æ­¢G1\nPL-2.99ï¼ˆRepeatable Readï¼‰ï¼šé˜»æ­¢G1ï¼ŒG2-item\nPL-3ï¼ˆSerializableï¼‰ï¼šé˜»æ­¢G1ï¼ŒG2\n\nå…­ã€å…¶ä»–éš”ç¦»çº§åˆ«ï¼šé™¤äº†ä¸Šè¿°çš„éš”ç¦»çº§åˆ«å¤–ï¼Œåœ¨æ­£ç¡®æ€§çš„é¢‘è°±ä¸­è¿˜æœ‰ç€å¤§é‡ç©ºç™½ï¼Œä¹Ÿå°±å­˜åœ¨ç€å„ç§å…¶ä»–éš”ç¦»çº§åˆ«çš„ç©ºé—´ï¼Œå•†ä¸šæ•°æ®åº“çš„å®ç°ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒå¸¸è§ï¼š\n1ï¼ŒCursor Stabilityè¯¥éš”ç¦»ç•Œåˆ«ä»‹äºRead Committedå’ŒRepeatable Readä¹‹é—´ï¼Œé€šè¿‡å¯¹æ¸¸æ ‡åŠ é”è€Œä¸æ˜¯å¯¹objectåŠ è¯»é”çš„æ–¹å¼é¿å…äº†Lost Writeå¼‚è±¡ã€‚\n2ï¼Œ Snapshot Ioslationäº‹åŠ¡å¼€å§‹çš„æ—¶å€™æ‹¿ä¸€ä¸ªStart-Timestampçš„snapshotï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½åœ¨è¿™ä¸ªsnapshotä¸Šåšï¼Œå½“commitçš„æ—¶å€™æ‹¿Commit-Timestampï¼Œæ£€æŸ¥æ‰€æœ‰æœ‰å†²çªçš„å€¼ä¸èƒ½å†[Start- Timestamp, Commit-Timestamp]è¢«æäº¤ï¼Œå¦åˆ™abortã€‚é•¿ä¹…ä»¥æ¥ï¼ŒSnapshot Ioslationä¸€ç›´è¢«è®¤ä¸ºæ˜¯Serializableï¼Œä½†å…¶å®Snapshot Ioslationä¸‹è¿˜ä¼šå‡ºç°Write Skewçš„å¼‚è±¡ã€‚ä¹‹åçš„æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»å¦‚ä½•ä»Snapshot Ioslationå‡ºå‘è·å¾—Serializableã€‚\næ€»ç»“å¯¹äºäº‹åŠ¡éš”ç¦»çº§åˆ«çš„æ ‡å‡†ï¼Œæ•°æ®åº“çš„å‰è¾ˆä»¬è¿›è¡Œäº†é•¿ä¹…çš„æ¢ç´¢ï¼š\n\nANSI isolation levelså®šä¹‰äº†å¼‚è±¡æ ‡å‡†ï¼Œå¹¶æ ¹æ®æ‰€æ’é™¤çš„å¼‚è±¡ï¼Œå®šä¹‰äº†ï¼ŒRead Uncommittedã€Read Committedã€Repeatable Readã€Serializableå››ä¸ªéš”ç¦»çº§åˆ«ï¼›\nA Critique of ANSI SQL Isolation Levelsè®¤ä¸ºANSIçš„å®šä¹‰å¹¶æ²¡å°†æœ‰å¤šobjectçº¦æŸçš„å¼‚è±¡æ’é™¤åœ¨å¤–ï¼Œå¹¶é€‰æ‹©ç”¨æ›´ä¸¥æ ¼çš„åŸºäºLockçš„å®šä¹‰æ‰©å¤§äº†æ¯ä¸ªçº§åˆ«é™åˆ¶çš„èŒƒå›´ï¼›\nWeak Consistency: A Generalized Theory and Optimistic Implementations for Distributed Transactionsè®¤ä¸ºåŸºäºLockçš„å®šä¹‰è¿‡å¤šçš„æ‰©å¤§äº†é™åˆ¶çš„èŒƒå›´ï¼Œå¯¼è‡´æ­£å¸¸æƒ…å†µè¢«æ’é™¤åœ¨å¤–ï¼Œä»è€Œé™åˆ¶äº†Optimizeç±»å‹å¹¶è¡Œæ§åˆ¶çš„ä½¿ç”¨ï¼›æŒ‡å‡ºè§£å†³è¯¥é—®é¢˜çš„å…³é”®æ˜¯è¦æœ‰æ¨¡å‹èƒ½å‡†ç¡®åœ°æè¿°è¿™ç§å¤šObjectçº¦æŸï¼›å¹¶ç»™å‡ºäº†åŸºäºåºåˆ—åŒ–å›¾çš„å®šä¹‰æ–¹å¼ï¼Œå°†æ¯ä¸ªçº§åˆ«é™åˆ¶çš„èŒƒå›´æœ€å°åŒ–ã€‚\n\n","categories":["MySQL"]},{"title":"æ•°æ®åº“æ•…éšœæ¢å¤æœºåˆ¶çš„å‰ä¸–ä»Šç”Ÿ","url":"/posts/26383/","content":"èƒŒæ™¯åœ¨æ•°æ®åº“ç³»ç»Ÿå‘å±•çš„å†å²é•¿æ²³ä¸­ï¼Œæ•…éšœæ¢å¤é—®é¢˜å§‹ç»ˆä¼´éšå·¦å³ï¼Œä¹Ÿæ·±åˆ»å½±å“ç€æ•°æ®åº“ç»“æ„çš„å‘å±•å˜åŒ–ã€‚\né€šè¿‡æ•…éšœæ¢å¤æœºåˆ¶ï¼Œå¯ä»¥å®ç°æ•°æ®åº“çš„ä¸¤ä¸ªè‡³å…³é‡è¦çš„ç‰¹æ€§ï¼šDurability of Updates ä»¥åŠ Failure Atomicï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„çš„ACIDä¸­çš„Aå’ŒDã€‚\nç£ç›˜æ•°æ®åº“ç”±äºå…¶å“è¶Šçš„æ€§ä»·æ¯”ä¸€ç›´ä»¥æ¥éƒ½å æ®æ•°æ®åº“åº”ç”¨çš„ä¸»æµä½ç½®ã€‚ç„¶è€Œï¼Œç”±äºéœ€è¦åè°ƒå†…å­˜å’Œç£ç›˜ä¸¤ç§æˆªç„¶ä¸åŒçš„å­˜å‚¨ä»‹è´¨ï¼Œåœ¨å¤„ç†æ•…éšœæ¢å¤é—®é¢˜æ—¶ä¹Ÿå¢åŠ äº†å¾ˆå¤šçš„å¤æ‚åº¦ã€‚éšç€å­¦æœ¯ç•ŒåŠå·¥ç¨‹ç•Œçš„å…±åŒåŠªåŠ›åŠç¡¬ä»¶æœ¬èº«çš„å˜åŒ–ï¼Œç£ç›˜æ•°æ®åº“çš„æ•…éšœæ¢å¤æœºåˆ¶ä¹Ÿä¸æ–­çš„è¿­ä»£æ›´æ–°ï¼Œå°¤å…¶è¿‘äº›å¹´æ¥ï¼Œéšç€NVMçš„æµ®ç°ï¼Œå›´ç»•æ–°ç¡¬ä»¶çš„ç ”ç©¶ä¹Ÿå¦‚é›¨åæ˜¥ç¬‹å‡ºç°ã€‚\næœ¬æ–‡å¸Œæœ›é€šè¿‡åˆ†æä¸åŒæ—¶é—´ç‚¹çš„å…³é”®ç ”ç©¶æˆæœï¼Œæ¥æ¢³ç†æ•°æ®åº“æ•…éšœæ¢å¤é—®é¢˜çš„æœ¬è´¨ï¼Œå…¶å‘å±•åŠä¼˜åŒ–æ–¹å‘ï¼Œä»¥åŠéšç€ç¡¬ä»¶å˜åŒ–è€Œå‘ç”Ÿçš„å˜åŒ–ã€‚\n æ–‡ç« å°†é¦–å…ˆæè¿°æ•…éšœæ¢å¤é—®é¢˜æœ¬èº«ï¼›ç„¶åæŒ‰ç…§åŸºæœ¬çš„æ—¶é—´é¡ºåºä»‹ç»ä¼ ç»Ÿæ•°æ®åº“ä¸­æ•…éšœæ¢å¤æœºåˆ¶çš„æ¼”è¿›åŠä¼˜åŒ–ï¼›ä¹‹åæ€è€ƒæ–°ç¡¬ä»¶å¸¦æ¥çš„æœºé‡ä¸æŒ‘æˆ˜ï¼›å¹¶å¼•å‡ºå›´ç»•æ–°ç¡¬ä»¶çš„ä¸¤ä¸ªä¸åŒæ–¹å‘çš„ç ”ç©¶æˆæœï¼›æœ€åè¿›è¡Œæ€»ç»“ã€‚\né—®é¢˜æ•°æ®åº“ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„æ•…éšœç±»å‹ä¸»è¦åŒ…æ‹¬ï¼ŒTransaction Failureï¼ŒProcess Failureï¼ŒSystem Failureä»¥åŠMedia Failureã€‚å…¶ä¸­Transaction Failureå¯èƒ½æ˜¯ä¸»åŠ¨å›æ»šæˆ–è€…å†²çªåå¼ºåˆ¶Abortï¼›Process FailureæŒ‡çš„æ˜¯ç”±äºå„ç§åŸå› å¯¼è‡´çš„è¿›ç¨‹é€€å‡ºï¼Œè¿›ç¨‹å†…å­˜å†…å®¹ä¼šä¸¢å¤±ï¼›System Failureæ¥æºäºæ“ä½œç³»ç»Ÿæˆ–ç¡¬ä»¶æ•…éšœï¼›è€ŒMedia Failureåˆ™æ˜¯å­˜å‚¨ä»‹è´¨çš„ä¸å¯æ¢å¤æŸåã€‚æ•°æ®åº“ç³»ç»Ÿéœ€è¦æ­£ç¡®åˆç†çš„å¤„ç†è¿™äº›æ•…éšœï¼Œä»è€Œä¿è¯ç³»ç»Ÿçš„æ­£ç¡®æ€§ã€‚ä¸ºæ­¤éœ€è¦æä¾›ä¸¤ä¸ªç‰¹æ€§ï¼š\n\nDurability of Updatesï¼šå·²ç»Commitçš„äº‹åŠ¡çš„ä¿®æ”¹ï¼Œæ•…éšœæ¢å¤åä»ç„¶å­˜åœ¨ï¼›\nFailure Atomicï¼šå¤±è´¥äº‹åŠ¡çš„æ‰€æœ‰ä¿®æ”¹éƒ½ä¸å¯è§ã€‚\n\nå› æ­¤ï¼Œæ•…éšœæ¢å¤çš„é—®é¢˜æè¿°ä¸ºï¼šå³ä½¿åœ¨å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œæ•°æ®åº“ä¾ç„¶èƒ½å¤Ÿé€šè¿‡æä¾›DurabilityåŠAtomicç‰¹æ€§ï¼Œä¿è¯æ¢å¤åçš„æ•°æ®åº“çŠ¶æ€æ­£ç¡®ã€‚ç„¶è€Œï¼Œè¦è§£å†³è¿™ä¸ªé—®é¢˜å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„äº‹æƒ…ï¼Œä¸ºäº†ä¸æ˜¾è‘—ç‰ºç‰²æ•°æ®åº“æ€§èƒ½ï¼Œé•¿ä¹…ä»¥æ¥äººä»¬å¯¹æ•…éšœæ¢å¤æœºåˆ¶è¿›è¡Œäº†ä¸€ç³»åˆ—çš„æ¢ç´¢ã€‚\nä¸€ã€Shadow Paging1981å¹´ï¼ŒJIM GRAYç­‰äººåœ¨ã€ŠThe Recovery Manager of the System R Database Managerã€‹ä¸­é‡‡ç”¨äº†ä¸€ç§éå¸¸ç›´è§‚çš„è§£å†³æ–¹å¼Shadow Paging[1]ã€‚System Rçš„ç£ç›˜æ•°æ®é‡‡ç”¨Pageä¸ºæœ€å°çš„ç»„ç»‡å•ä½ï¼Œä¸€ä¸ªFileç”±å¤šä¸ªPageç»„æˆï¼Œå¹¶é€šè¿‡ç§°ä¸ºDirecotryçš„å…ƒæ•°æ®è¿›è¡Œç´¢å¼•ï¼Œæ¯ä¸ªDirectoryé¡¹çºªå½•äº†å½“å‰æ–‡ä»¶çš„Page Tableï¼ŒæŒ‡å‘å…¶åŒ…å«çš„æ‰€æœ‰Pageã€‚é‡‡ç”¨Shadow Pagingçš„æ–‡ä»¶ç§°ä¸ºShadow Fileï¼Œå¦‚ä¸‹å›¾ä¸­çš„File Bæ‰€ç¤ºï¼Œè¿™ç§æ–‡ä»¶ä¼šåŒ…å«ä¸¤ä¸ªDirectoryé¡¹ï¼ŒCurrentåŠShadowã€‚\näº‹åŠ¡å¯¹æ–‡ä»¶è¿›è¡Œä¿®æ”¹æ—¶ï¼Œä¼šè·å¾—æ–°çš„Pageï¼Œå¹¶åŠ å…¥Currentçš„Page Tableï¼Œæ‰€æœ‰çš„ä¿®æ”¹éƒ½åªå‘ç”Ÿåœ¨Current Directoryï¼›äº‹åŠ¡Commitæ—¶ï¼ŒCurrentæŒ‡å‘çš„Pageåˆ·ç›˜ï¼Œå¹¶é€šè¿‡åŸå­çš„æ“ä½œå°†Currentçš„Page Tableåˆå¹¶åˆ°Shadow Directoryä¸­ï¼Œä¹‹åå†è¿”å›åº”ç”¨CommitæˆåŠŸï¼›äº‹åŠ¡Abortæ—¶åªéœ€è¦ç®€å•çš„ä¸¢å¼ƒCurrentæŒ‡å‘çš„Pageï¼›å¦‚æœè¿‡ç¨‹ä¸­å‘ç”Ÿæ•…éšœï¼Œåªéœ€è¦æ¢å¤Shadow Directoryï¼Œç›¸å½“äºå¯¹æ‰€æœ‰æœªæäº¤äº‹åŠ¡çš„å›æ»šæ“ä½œã€‚Shadow Pagingå¾ˆæ–¹ä¾¿çš„å®ç°äº†ï¼š\n\nDurability of Updatesï¼šäº‹åŠ¡å®ŒæˆCommitåï¼Œæ‰€æœ‰ä¿®æ”¹çš„Pageå·²ç»è½ç›˜ï¼Œåˆå¹¶åˆ°Shadowåï¼Œå…¶æ‰€æœ‰çš„ä¿®æ”¹å¯ä»¥åœ¨æ•…éšœåæ¢å¤å‡ºæ¥ã€‚\nFailure Atomicï¼šå›æ»šçš„äº‹åŠ¡ç”±äºæ²¡æœ‰Commitï¼Œä»æœªå½±å“Shadow Directoryï¼Œå› æ­¤å…¶æ‰€æœ‰ä¿®æ”¹ä¸å¯è§ã€‚\n\nè™½ç„¶Shadow Pagingè®¾è®¡ç®€å•ç›´è§‚ï¼Œä½†å®ƒçš„ä¸€äº›ç¼ºç‚¹å¯¼è‡´å…¶å¹¶æ²¡æœ‰æˆä¸ºä¸»æµï¼Œé¦–å…ˆï¼Œä¸æ”¯æŒPageå†…å¹¶å‘ï¼Œä¸€ä¸ªCommitæ“ä½œä¼šå¯¼è‡´å…¶Pageä¸Šæ‰€æœ‰äº‹åŠ¡çš„ä¿®æ”¹è¢«æäº¤ï¼Œå› æ­¤ä¸€ä¸ªPageå†…åªèƒ½åŒ…å«ä¸€ä¸ªäº‹åŠ¡çš„ä¿®æ”¹ï¼›å…¶æ¬¡ï¼Œä¸æ–­ä¿®æ”¹Pageçš„ç‰©ç†ä½ç½®ï¼Œå¯¼è‡´å¾ˆéš¾å°†ç›¸å…³çš„é¡µç»´æŠ¤åœ¨ä¸€èµ·ï¼Œç ´åå±€éƒ¨æ€§ï¼›å¦å¤–ï¼Œå¯¹å¤§äº‹åŠ¡è€Œè¨€ï¼ŒCommitè¿‡ç¨‹åœ¨å…³é”®è·¯å¾„ä¸Šä¿®æ”¹Shadow Directoryçš„å¼€é”€å¯èƒ½å¾ˆå¤§ï¼ŒåŒæ—¶è¿™ä¸ªæ“ä½œè¿˜å¿…é¡»ä¿è¯åŸå­ï¼›æœ€åï¼Œå¢åŠ äº†åƒåœ¾å›æ”¶çš„è´Ÿæ‹…ï¼ŒåŒ…æ‹¬å¯¹å¤±è´¥äº‹åŠ¡çš„Current Pageså’Œæäº¤äº‹åŠ¡çš„Old Pagesçš„å›æ”¶ã€‚\näºŒã€WALç”±äºä¼ ç»Ÿç£ç›˜é¡ºåºè®¿é—®æ€§èƒ½è¿œå¥½äºéšæœºè®¿é—®ï¼Œé‡‡ç”¨Loggingçš„æ•…éšœæ¢å¤æœºåˆ¶æ„å›¾åˆ©ç”¨é¡ºåºå†™çš„Logæ¥è®°å½•å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå¹¶åœ¨æ•…éšœæ¢å¤åé€šè¿‡Logå†…å®¹å°†æ•°æ®åº“æ¢å¤åˆ°æ­£ç¡®çš„çŠ¶æ€ã€‚ç®€å•çš„è¯´ï¼Œæ¯æ¬¡ä¿®æ”¹æ•°æ®å†…å®¹å‰å…ˆé¡ºåºå†™å¯¹åº”çš„Logï¼ŒåŒæ—¶ä¸ºäº†ä¿è¯æ¢å¤æ—¶å¯ä»¥ä»Logä¸­çœ‹åˆ°æœ€æ–°çš„æ•°æ®åº“çŠ¶æ€ï¼Œè¦æ±‚Logå…ˆäºæ•°æ®å†…å®¹è½ç›˜ï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„Write Ahead Logï¼ŒWALã€‚é™¤æ­¤ä¹‹å¤–ï¼Œäº‹åŠ¡å®ŒæˆCommitå‰è¿˜éœ€è¦åœ¨Logä¸­è®°å½•å¯¹åº”çš„Commitæ ‡è®°ï¼Œä»¥ä¾›æ¢å¤æ—¶äº†è§£å½“å‰çš„äº‹åŠ¡çŠ¶æ€ï¼Œå› æ­¤è¿˜éœ€è¦å…³æ³¨Commitæ ‡è®°å’Œäº‹åŠ¡ä¸­æ•°æ®å†…å®¹çš„è½ç›˜é¡ºåºã€‚æ ¹æ®Logä¸­è®°å½•çš„å†…å®¹å¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼šUndo-Onlyï¼ŒRedo-Onlyï¼ŒRedo-Undoã€‚\nUndo-Only Logging\nUndo-Only Loggingçš„Logè®°å½•å¯ä»¥è¡¨ç¤ºæœª&lt;T, X, v&gt;ï¼Œäº‹åŠ¡Tä¿®æ”¹äº†Xçš„å€¼ï¼ŒXçš„æ—§å€¼æ˜¯vã€‚äº‹åŠ¡æäº¤æ—¶ï¼Œéœ€è¦é€šè¿‡å¼ºåˆ¶Flushä¿è¯Commitæ ‡è®°è½ç›˜å‰ï¼Œå¯¹åº”äº‹åŠ¡çš„æ‰€æœ‰æ•°æ®è½ç›˜ï¼Œå³è½ç›˜é¡ºåºä¸ºLogè®°å½•-&gt;Data-&gt;Commitæ ‡è®°ã€‚æ¢å¤æ—¶å¯ä»¥æ ¹æ®Commitæ ‡è®°åˆ¤æ–­äº‹åŠ¡çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡Undo Logä¸­è®°å½•çš„æ—§å€¼å°†æœªæäº¤äº‹åŠ¡çš„ä¿®æ”¹å›æ»šã€‚æˆ‘ä»¬æ¥å®¡è§†ä¸€ä¸‹Undo-Onlyå¯¹DurabilityåŠAtomicçš„ä¿è¯ï¼š\n\nDurability of Updatesï¼šDataå¼ºåˆ¶åˆ·ç›˜ä¿è¯ï¼Œå·²ç»Commitçš„äº‹åŠ¡ç”±äºå…¶æ‰€æœ‰Dataéƒ½å·²ç»åœ¨Commitæ ‡è®°ä¹‹å‰è½ç›˜ï¼Œå› æ­¤ä¼šä¸€ç›´å­˜åœ¨ï¼›\nFailure Atomicï¼šUndo Logå†…å®¹ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„å·²åˆ·ç›˜çš„ä¿®æ”¹ä¼šåœ¨æ¢å¤é˜¶æ®µé€šè¿‡Undoæ—¥å¿—å›æ»šï¼Œä¸å†å¯è§ã€‚\n\nç„¶è€ŒUndo-Onlyä¾ç„¶æœ‰ä¸èƒ½Pageå†…å¹¶å‘çš„é—®é¢˜ï¼Œå¦‚æœä¸¤ä¸ªäº‹åŠ¡çš„ä¿®æ”¹è½åˆ°ä¸€ä¸ªPageä¸­ï¼Œä¸€ä¸ªäº‹åŠ¡æäº¤å‰éœ€è¦çš„å¼ºåˆ¶Flushæ“ä½œï¼Œä¼šå¯¼è‡´åŒPageæ‰€æœ‰äº‹åŠ¡çš„Dataè½ç›˜ï¼Œå¯èƒ½ä¼šæ—©äºå¯¹åº”çš„Logé¡¹ä»è€ŒæŸå®³WALã€‚åŒæ—¶ï¼Œä¹Ÿä¼šå¯¼è‡´å…³é”®è·¯å¾„ä¸Šè¿‡äºé¢‘ç¹çš„ç£ç›˜éšæœºè®¿é—®ã€‚\nRedo-Only Logging\nä¸åŒäºUndo-Onlyï¼Œé‡‡ç”¨Redo-Onlyçš„Logä¸­è®°å½•çš„æ˜¯ä¿®æ”¹åçš„æ–°å€¼ã€‚å¯¹åº”åœ°ï¼ŒCommitæ—¶éœ€è¦ä¿è¯ï¼ŒLogä¸­çš„Commitæ ‡è®°åœ¨äº‹åŠ¡çš„ä»»ä½•æ•°æ®ä¹‹å‰è½ç›˜ï¼Œå³è½ç›˜é¡ºåºä¸ºLogè®°å½•-&gt;Commitæ ‡è®°-&gt;Dataã€‚æ¢å¤æ—¶åŒæ ·æ ¹æ®Commitæ ‡è®°åˆ¤æ–­äº‹åŠ¡çŠ¶æ€ï¼Œå¹¶é€šè¿‡Redo Logä¸­è®°å½•çš„æ–°å€¼å°†å·²ç»Commitï¼Œä½†æ•°æ®æ²¡æœ‰è½ç›˜çš„äº‹åŠ¡ä¿®æ”¹é‡æ”¾ã€‚\n\nDurability of Updatesï¼šRedo Logå†…å®¹ä¿è¯ï¼Œå·²æäº¤äº‹åŠ¡çš„æœªåˆ·ç›˜çš„ä¿®æ”¹ï¼Œåˆ©ç”¨Redo Logä¸­çš„å†…å®¹é‡æ”¾ï¼Œä¹‹åå¯è§ï¼›\nFailure Atomicï¼šé˜»æ­¢Commitå‰Dataè½ç›˜ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„ä¿®æ”¹ä¸ä¼šå‡ºç°åœ¨ç£ç›˜ä¸Šï¼Œè‡ªç„¶ä¸å¯è§ã€‚\n\nRedo-OnlyåŒæ ·æœ‰ä¸èƒ½Pageå†…å¹¶å‘çš„é—®é¢˜ï¼ŒPageä¸­çš„å¤šä¸ªä¸åŒäº‹åŠ¡ï¼Œåªè¦æœ‰ä¸€ä¸ªæœªæäº¤å°±ä¸èƒ½åˆ·ç›˜ï¼Œè¿™äº›æ•°æ®å…¨éƒ¨éƒ½éœ€è¦ç»´æŠ¤åœ¨å†…å­˜ä¸­ï¼Œé€ æˆè¾ƒå¤§çš„å†…å­˜å‹åŠ›ã€‚\nRedo-Undo Logging\nå¯ä»¥çœ‹å‡ºçš„åªæœ‰Undoæˆ–Redoçš„é—®é¢˜ï¼Œä¸»è¦æ¥è‡ªäºå¯¹Commitæ ‡è®°åŠDataè½ç›˜é¡ºåºçš„é™åˆ¶ï¼Œè€Œè¿™ç§é™åˆ¶å½’æ ¹ç»“åº•æ¥æºäºLogä¿¡æ¯ä¸­å¯¹æ–°å€¼æˆ–æ—§å€¼çš„ç¼ºå¤±ã€‚å› æ­¤Redo-Undoé‡‡ç”¨åŒæ—¶è®°å½•æ–°å€¼å’Œæ—§å€¼çš„æ–¹å¼ï¼Œæ¥æ¶ˆé™¤Commitå’ŒDataä¹‹é—´åˆ·ç›˜é¡ºåºçš„é™åˆ¶ã€‚\n\nDurability of Updatesï¼šRedo å†…å®¹ä¿è¯ï¼Œå·²æäº¤äº‹åŠ¡çš„æœªåˆ·ç›˜çš„ä¿®æ”¹ï¼Œåˆ©ç”¨Redo Logä¸­çš„å†…å®¹é‡æ”¾ï¼Œä¹‹åå¯è§ï¼›\nFailure Atomicï¼šUndoå†…å®¹ä¿è¯ï¼Œå¤±è´¥äº‹åŠ¡çš„å·²åˆ·ç›˜çš„ä¿®æ”¹ä¼šåœ¨æ¢å¤é˜¶æ®µé€šè¿‡Undoæ—¥å¿—å›æ»šï¼Œä¸å†å¯è§ã€‚\n\nå¦‚æ­¤ä¸€æ¥ï¼ŒåŒPageçš„ä¸åŒäº‹åŠ¡æäº¤å°±å˜å¾—éå¸¸ç®€å•ã€‚åŒæ—¶å¯ä»¥å°†è¿ç»­çš„æ•°æ®æ”’ç€è¿›è¡Œæ‰¹é‡çš„åˆ·ç›˜å·²åˆ©ç”¨ç£ç›˜è¾ƒé«˜çš„é¡ºåºå†™æ€§èƒ½ã€‚\nä¸‰ã€Force and Stealä»ä¸Šé¢çœ‹å‡ºï¼ŒRedoå’ŒUndoå†…å®¹åˆ†åˆ«å¯ä»¥ä¿è¯Durabilityå’ŒAtomicä¸¤ä¸ªç‰¹æ€§ï¼Œå…¶ä¸­ä¸€ç§ä¿¡æ¯çš„ç¼ºå¤±éœ€è¦ç”¨ä¸¥æ ¼çš„åˆ·ç›˜é¡ºåºæ¥å¼¥è¡¥ã€‚è¿™é‡Œå…³æ³¨çš„åˆ·ç›˜é¡ºåºåŒ…å«ä¸¤ä¸ªç»´åº¦ï¼š\n\nForce or No-Forceï¼šCommitæ—¶æ˜¯å¦éœ€è¦å¼ºåˆ¶åˆ·ç›˜ï¼Œé‡‡ç”¨Forceçš„æ–¹å¼ç”±äºæ‰€æœ‰çš„å·²æäº¤äº‹åŠ¡çš„æ•°æ®ä¸€å®šå·²ç»å­˜åœ¨äºç£ç›˜ï¼Œè‡ªç„¶è€Œç„¶åœ°ä¿è¯äº†Durabilityï¼›\nNo-Steal or Stealï¼ŒCommitå‰æ•°æ®æ˜¯å¦å¯ä»¥æå‰åˆ·ç›˜ï¼Œé‡‡ç”¨No-Stealçš„æ–¹å¼ç”±äºä¿è¯äº‹åŠ¡æäº¤å‰ä¿®æ”¹ä¸ä¼šå‡ºç°åœ¨ç£ç›˜ä¸Šï¼Œè‡ªç„¶è€Œç„¶åœ°ä¿è¯äº†Atomicã€‚\n\næ€»ç»“ä¸€ä¸‹ï¼Œå®ç°Durabilityå¯ä»¥é€šè¿‡è®°å½•Redoä¿¡æ¯æˆ–è¦æ±‚Forceåˆ·ç›˜é¡ºåºï¼Œå®ç°Atomicéœ€è¦è®°å½•Undoä¿¡æ¯æˆ–è¦æ±‚No-Stealåˆ·ç›˜é¡ºåºï¼Œç»„åˆå¾—åˆ°å¦‚ä¸‹å››ç§æ¨¡å¼ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nå››ã€ARIESï¼Œä¸€ç»Ÿæ±Ÿæ¹–1992å¹´ï¼ŒIBMçš„ç ”ç©¶å‘˜ä»¬å‘è¡¨äº†ã€ŠARIES: a transaction recovery method supporting fine-granularity locking and partial rollbacks using write-ahead loggingã€‹[2]ï¼Œå…¶ä¸­æå‡ºçš„ARIESé€æ­¥æˆä¸ºç£ç›˜æ•°æ®åº“å®ç°æ•…éšœæ¢å¤çš„æ ‡é…ï¼ŒARIESæœ¬è´¨æ˜¯ä¸€ç§Redo-Undoçš„WALå®ç°ã€‚ Normalè¿‡ç¨‹ï¼šä¿®æ”¹æ•°æ®ä¹‹å‰å…ˆè¿½åŠ Logè®°å½•ï¼ŒLogå†…å®¹åŒæ—¶åŒ…æ‹¬Redoå’ŒUndoä¿¡æ¯ï¼Œæ¯ä¸ªæ—¥å¿—è®°å½•äº§ç”Ÿä¸€ä¸ªæ ‡è®°å…¶åœ¨æ—¥å¿—ä¸­ä½ç½®çš„é€’å¢LSNï¼ˆLog Sequence Numberï¼‰ï¼›æ•°æ®Pageä¸­è®°å½•æœ€åä¿®æ”¹çš„æ—¥å¿—é¡¹LSNï¼Œä»¥æ­¤æ¥åˆ¤æ–­Pageä¸­çš„å†…å®¹çš„æ–°æ—§ç¨‹åº¦ï¼Œå®ç°å¹‚ç­‰ã€‚æ•…éšœæ¢å¤é˜¶æ®µéœ€è¦é€šè¿‡Logä¸­çš„å†…å®¹æ¢å¤æ•°æ®åº“çŠ¶æ€ï¼Œä¸ºäº†å‡å°‘æ¢å¤æ—¶éœ€è¦å¤„ç†çš„æ—¥å¿—é‡ï¼ŒARIESä¼šåœ¨æ­£å¸¸è¿è¡ŒæœŸé—´å‘¨æœŸæ€§çš„ç”ŸæˆCheckpointï¼ŒCheckpointä¸­é™¤äº†å½“å‰çš„æ—¥å¿—LSNä¹‹å¤–ï¼Œè¿˜éœ€è¦è®°å½•å½“å‰æ´»è·ƒäº‹åŠ¡çš„æœ€æ–°LSNï¼Œä»¥åŠæ‰€æœ‰è„é¡µï¼Œä¾›æ¢å¤æ—¶å†³å®šé‡æ”¾Redoçš„å¼€å§‹ä½ç½®ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äºç”ŸæˆCheckpointæ—¶æ•°æ®åº“è¿˜åœ¨æ­£å¸¸æä¾›æœåŠ¡ï¼ˆFuzzy Checkpointï¼‰ï¼Œå…¶ä¸­è®°å½•çš„æ´»è·ƒäº‹åŠ¡åŠDirty Pageä¿¡æ¯å¹¶ä¸ä¸€å®šå‡†ç¡®ï¼Œå› æ­¤éœ€è¦Recoveryé˜¶æ®µé€šè¿‡Logå†…å®¹è¿›è¡Œä¿®æ­£ã€‚\nRecoverè¿‡ç¨‹ï¼šæ•…éšœæ¢å¤åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼šAnalysisï¼ŒRedoå’ŒUndoã€‚Analysisé˜¶æ®µçš„ä»»åŠ¡ä¸»è¦æ˜¯åˆ©ç”¨CheckpointåŠLogä¸­çš„ä¿¡æ¯ç¡®è®¤åç»­Redoå’ŒUndoé˜¶æ®µçš„æ“ä½œèŒƒå›´ï¼Œé€šè¿‡Logä¿®æ­£Checkpointä¸­è®°å½•çš„Dirty Pageé›†åˆä¿¡æ¯ï¼Œå¹¶ç”¨å…¶ä¸­æ¶‰åŠæœ€å°çš„LSNä½ç½®ä½œä¸ºä¸‹ä¸€æ­¥Redoçš„å¼€å§‹ä½ç½®RedoLSNã€‚åŒæ—¶ä¿®æ­£Checkpointä¸­è®°å½•çš„æ´»è·ƒäº‹åŠ¡é›†åˆï¼ˆæœªæäº¤äº‹åŠ¡ï¼‰ï¼Œä½œä¸ºUndoè¿‡ç¨‹çš„å›æ»šå¯¹è±¡ï¼›Redoé˜¶æ®µä»Analysisè·å¾—çš„RedoLSNå‡ºå‘ï¼Œé‡æ”¾æ‰€æœ‰çš„Logä¸­çš„Redoå†…å®¹ï¼Œæ³¨æ„è¿™é‡Œä¹ŸåŒ…å«äº†æœªCommitäº‹åŠ¡ï¼›æœ€åUndoé˜¶æ®µå¯¹æ‰€æœ‰æœªæäº¤äº‹åŠ¡åˆ©ç”¨Undoä¿¡æ¯è¿›è¡Œå›æ»šï¼Œé€šè¿‡Logçš„PrevLSNå¯ä»¥é¡ºåºæ‰¾åˆ°äº‹åŠ¡æ‰€æœ‰éœ€è¦å›æ»šçš„ä¿®æ”¹ã€‚\né™¤æ­¤ä¹‹å¤–ï¼ŒARIESè¿˜åŒ…å«äº†è®¸å¤šä¼˜åŒ–è®¾è®¡ï¼Œä¾‹å¦‚é€šè¿‡ç‰¹æ®Šçš„æ—¥å¿—è®°å½•ç±»å‹CLRsé¿å…åµŒå¥—Recoveryå¸¦æ¥çš„æ—¥å¿—è†¨èƒ€ï¼Œæ”¯æŒç»†ç²’åº¦é”ï¼Œå¹¶å‘Recoveryç­‰ã€‚[3]è®¤ä¸ºï¼ŒARIESæœ‰ä¸¤ä¸ªä¸»è¦çš„è®¾è®¡ç›®æ ‡ï¼š\n\nFeatureï¼šæä¾›ä¸°å¯Œçµæ´»çš„å®ç°äº‹åŠ¡çš„æ¥å£ï¼šåŒ…æ‹¬æä¾›çµæ´»çš„å­˜å‚¨æ–¹å¼ã€æä¾›ç»†ç²’åº¦çš„é”ã€æ”¯æŒåŸºäºSavepointçš„äº‹åŠ¡éƒ¨åˆ†å›æ»šã€é€šè¿‡Logical Undoä»¥è·å¾—æ›´é«˜çš„å¹¶å‘ã€é€šè¿‡Page-Oriented Redoå®ç°ç®€å•çš„å¯å¹¶å‘çš„Recoveryè¿‡ç¨‹ã€‚\nPerformanceï¼šå……åˆ†åˆ©ç”¨å†…å­˜å’Œç£ç›˜ä»‹è´¨ç‰¹æ€§ï¼Œè·å¾—æè‡´çš„æ€§èƒ½ï¼šé‡‡ç”¨No-Forceé¿å…å¤§é‡åŒæ­¥çš„ç£ç›˜éšæœºå†™ã€é‡‡ç”¨StealåŠæ—¶é‡ç”¨å®è´µçš„å†…å­˜èµ„æºã€åŸºäºPageæ¥ç®€åŒ–æ¢å¤å’Œç¼“å­˜ç®¡ç†ã€‚\n\näº”ã€NVMå¸¦æ¥çš„æœºé‡ä¸æŒ‘æˆ˜ä»Shadow Pagingåˆ°WALï¼Œå†åˆ°ARIESï¼Œä¸€ç›´å›´ç»•ç€ä¸¤ä¸ªä¸»é¢˜ï¼šå‡å°‘åŒæ­¥å†™ä»¥åŠå°½é‡ç”¨é¡ºåºå†™ä»£æ›¿éšæœºå†™ã€‚è€Œè¿™äº›æ­£æ˜¯ç”±äºç£ç›˜æ€§èƒ½è¿œå°äºå†…å­˜ï¼Œä¸”ç£ç›˜é¡ºåºè®¿é—®è¿œå¥½äºéšæœºè®¿é—®ã€‚ç„¶è€Œéšç€NVMç£ç›˜çš„å‡ºç°ä»¥åŠå¯¹å…¶æˆä¸ºä¸»æµçš„é¢„æœŸï¼Œä½¿å¾—æˆ‘ä»¬å¿…é¡»è¦é‡æ–°å®¡è§†æˆ‘ä»¬æ‰€åšçš„ä¸€åˆ‡ã€‚ç›¸å¯¹äºä¼ ç»Ÿçš„HDDåŠSSDï¼ŒNVMæœ€å¤§çš„ä¼˜åŠ¿åœ¨äºï¼š\n\næ¥è¿‘å†…å­˜çš„é«˜æ€§èƒ½\né¡ºåºè®¿é—®å’Œéšæœºè®¿é—®å·®è·ä¸å¤§\næŒ‰å­—èŠ‚å¯»å€è€Œä¸æ˜¯Block\n\nåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå†æ¥çœ‹ARIESçš„å®ç°ï¼š\n\nNo-force and Stealï¼šåŒæ—¶ç»´æŠ¤Redoï¼Œ Undoå’Œæ•°æ®é€ æˆçš„ä¸‰å€å†™æ”¾å¤§ï¼Œæ¥æ¢å–ç£ç›˜é¡ºåºå†™çš„æ€§èƒ½ï¼Œä½†åœ¨NVMä¸Šè¿™ç§å–èˆå˜å¾—å¾ˆä¸åˆ’ç®—ï¼›\nPagesï¼šä¸ºäº†è¿å°±ç£ç›˜åŸºäºBlockçš„è®¿é—®æ¥å£ï¼Œé‡‡ç”¨Pageçš„å­˜å‚¨ç®¡ç†æ–¹å¼ï¼Œè€Œå†…å­˜æœ¬èº«æ˜¯æŒ‰å­—èŠ‚å¯»å€çš„ï¼Œå› æ­¤ï¼Œè¿™ç§é€‚é…ä¹Ÿå¸¦æ¥å¾ˆå¤§çš„å¤æ‚åº¦ã€‚åœ¨åŒæ ·æŒ‰å­—èŠ‚å¯»å€çš„NVMä¸Šå¯ä»¥æ¶ˆé™¤ã€‚\n\nè¿‘å¹´æ¥ï¼Œä¼—å¤šçš„ç ”ç©¶å°è¯•ä¸ºNVMé‡èº«å®šåˆ¶æ›´åˆç†çš„æ•…éšœæ¢å¤æœºåˆ¶ï¼Œæˆ‘ä»¬è¿™é‡Œä»‹ç»å…¶ä¸­ä¸¤ç§æ¯”è¾ƒæœ‰ä»£è¡¨æ€§çš„ç ”ç©¶æˆæœï¼ŒMARSå¸Œæœ›å……åˆ†åˆ©ç”¨NVMå¹¶å‘åŠå†…éƒ¨å¸¦å®½çš„ä¼˜åŠ¿ï¼Œå°†æ›´å¤šçš„ä»»åŠ¡äº¤ç»™ç¡¬ä»¶å®ç°ï¼›è€ŒWBLåˆ™å°è¯•é‡æ„å½“å‰çš„Logæ–¹å¼ã€‚\nå…­ã€MARSå‘è¡¨åœ¨2013å¹´çš„SOSPä¸Šçš„ã€Šâ€œFrom ARIES to MARS: Transaction support for next-generation, solid-state drives.â€ ã€‹æå‡ºäº†ä¸€ç§å°½é‡ä¿ç•™ARIESç‰¹æ€§ï¼Œä½†æ›´é€‚åˆNVMçš„æ•…éšœæ¢å¤ç®—æ³•MARS[3]ã€‚MARSå–æ¶ˆäº†Undo Logï¼Œä¿ç•™çš„Redo Logä¹Ÿä¸åŒäºä¼ ç»Ÿçš„Append-Onlyï¼Œè€Œæ˜¯å¯ä»¥éšæœºè®¿é—®çš„ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ¯ä¸ªäº‹åŠ¡ä¼šå æœ‰ä¸€ä¸ªå”¯ä¸€çš„TIDï¼Œå¯¹åº”çš„Metadataä¸­è®°å½•äº†Logå’ŒDataçš„ä½ç½®ã€‚æ­£å¸¸è®¿é—®æ—¶ï¼Œæ‰€æœ‰çš„æ•°æ®ä¿®æ”¹éƒ½åœ¨å¯¹åº”çš„Redo Logä¸­è¿›è¡Œï¼Œä¸å½±å“çœŸå®æ•°æ®ï¼Œç”±äºæ²¡æœ‰Undo Logï¼Œéœ€è¦é‡‡ç”¨No-Stealçš„æ–¹å¼ï¼Œé˜»æ­¢Commitå‰çš„æ•°æ®å†™å›ï¼›Commitæ—¶ä¼šå…ˆè®¾ç½®äº‹åŠ¡çŠ¶æ€ä¸ºCOMMITTEDï¼Œä¹‹ååˆ©ç”¨NVMçš„å†…éƒ¨å¸¦å®½å°†Redoä¸­çš„æ‰€æœ‰å†…å®¹å¹¶å‘æ‹·è´å›Metadataä¸­è®°å½•çš„æ•°æ®ä½ç½®ã€‚å¦‚æœåœ¨COMMITEDæ ‡è®°è®¾ç½®åå‘ç”Ÿæ•…éšœï¼Œæ¢å¤æ—¶å¯ä»¥æ ¹æ®Redo Logä¸­çš„å†…å®¹é‡æ”¾ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ç§RedoåŠ No-Stealçš„å®ç°æ–¹å¼ï¼š\n\nDurability of Updatesï¼š Redoå®ç°ï¼Œæ•…éšœåé‡æ”¾Redoï¼›\nFailure Atomicï¼šæœªCommitäº‹åŠ¡çš„ä¿®æ”¹åªå­˜åœ¨äºRedo Logï¼Œé‡å¯åä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚\n\nå¯ä»¥çœ‹å‡ºï¼ŒMARSçš„Redoè™½ç„¶ç§°ä¹‹ä¸ºLogï¼Œä½†å…¶å®å·²ç»ä¸åŒäºä¼ ç»Ÿæ„ä¹‰ä¸Šçš„é¡ºåºå†™æ–‡ä»¶ï¼Œå…è®¸éšæœºè®¿é—®ï¼Œæ›´åƒæ˜¯ä¸€ç§ä¸´æ—¶çš„å­˜å‚¨ç©ºé—´ï¼Œç±»ä¼¼äºShadowçš„ä¸œè¥¿ã€‚ä¹‹æ‰€ä»¥åœ¨Commitæ—¶è¿›è¡Œæ•°æ®æ‹·è´è€Œä¸æ˜¯åƒShadow Pagingä¸€æ ·çš„å…ƒä¿¡æ¯ä¿®æ”¹ï¼Œç¬”è€…è®¤ä¸ºæ˜¯ä¸ºäº†ä¿æŒæ•°æ®çš„å±€éƒ¨æ€§ï¼Œå¹¶ä¸”å¾—ç›Šäºç¡¬ä»¶ä¼˜å¼‚çš„å†…éƒ¨å¸¦å®½ã€‚\nä¸ƒã€WBLä¸åŒäºMARSä¿ç•™Redoä¿¡æ¯çš„æ€è·¯ï¼Œ2016å¹´VLDBä¸Šçš„ã€Š â€œWrite Behind Loggingâ€ ã€‹åªä¿ç•™äº†Undoä¿¡æ¯ã€‚ç¬”è€…è®¤ä¸ºè¿™ç¯‡è®ºæ–‡ä¸­å…³äºWBLçš„ä»‹ç»é‡Œï¼Œç”¨å¤§é‡ç¬”å¢¨ä»‹ç»äº†ç®—æ³•ä¸Šçš„ä¼˜åŒ–éƒ¨åˆ†ï¼Œä¸ºäº†æŠ“ä½å…¶æœ¬è´¨ï¼Œè¿™é‡Œå…ˆä»‹ç»æœ€åŸºæœ¬çš„WBLç®—æ³•ï¼šWBLå»æ‰äº†ä¼ ç»Ÿçš„Append Onlyçš„Redoå’ŒUndoæ—¥å¿—ï¼Œä½†ä»ç„¶éœ€è¦ä¿ç•™Undoä¿¡æ¯ç”¨æ¥å›æ»šæœªæäº¤äº‹åŠ¡ã€‚äº‹åŠ¡Commitå‰éœ€è¦å°†å…¶æ‰€æœ‰çš„ä¿®æ”¹å¼ºåˆ¶åˆ·ç›˜ï¼Œä¹‹ååœ¨Logä¸­è®°å½•Commitæ ‡è®°ï¼Œä¹Ÿå°±æ˜¯è¿™é‡Œè¯´çš„Write Behind Logã€‚æ¢å¤è¿‡ç¨‹ä¸­é€šè¿‡åˆ†æCommitæ ‡è®°å°†ä¸ºæäº¤çš„äº‹åŠ¡é€šè¿‡Undoä¿¡æ¯å›æ»šã€‚å¯ä»¥çœ‹å‡ºWBLç®—æ³•æœ¬èº«éå¸¸ç®€å•ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼ŒWBLåšäº†å¦‚ä¸‹ä¼˜åŒ–ï¼š\n\nGroup Commitï¼šå‘¨æœŸæ€§çš„æ£€æŸ¥å†…å­˜ä¸­çš„ä¿®æ”¹ï¼ŒåŒæ ·åœ¨æ‰€æœ‰ä¿®æ”¹åˆ·ç›˜ä¹‹åå†å†™Logï¼ŒLogé¡¹ä¸­è®°å½•Commitå¹¶è½ç›˜çš„æœ€æ–°äº‹åŠ¡TimeStamp cpï¼Œä¿è¯æ—©äºcpçš„æ‰€æœ‰äº‹åŠ¡ä¿®æ”¹éƒ½å·²ç»è½ç›˜ï¼›åŒæ—¶è®°å½•å½“å‰åˆ†é…å‡ºå»çš„æœ€å¤§TimeStamp cdï¼›ä¹Ÿå°±æ˜¯è¯´æ­¤æ—¶æ‰€æœ‰æœ‰ä¿®æ”¹ä½†æœªæäº¤çš„äº‹åŠ¡Timestampéƒ½è½åœ¨cpå’Œcdä¹‹é—´ã€‚Reoveryçš„æ—¶å€™åªéœ€å¯¹è¿™éƒ¨åˆ†æ•°æ®è¿›è¡Œå›æ»šï¼›\né’ˆå¯¹å¤šç‰ˆæœ¬æ•°æ®åº“ï¼Œå¤šç‰ˆæœ¬ä¿¡æ¯å·²ç»èµ·åˆ°äº†undoçš„ä½œç”¨ï¼Œå› æ­¤ä¸éœ€è¦å†é¢å¤–è®°å½•undoä¿¡æ¯ï¼›\nå»¶è¿Ÿå›æ»šï¼šRecoveryåä¸æ€¥äºå¯¹æœªæäº¤äº‹åŠ¡è¿›è¡Œå›æ»šï¼Œè€Œæ˜¯ç›´æ¥æä¾›æœåŠ¡ï¼Œä¸€ç»„(cp, cd)ç§°ä¸ºä¸€ä¸ªgapï¼Œæ¯ä¸€æ¬¡æ•…éšœæ¢å¤éƒ½å¯èƒ½å¼•å…¥æ–°çš„gapï¼Œé€šè¿‡å¯¹æ¯”äº‹åŠ¡Timestampå’Œgapé›†åˆï¼Œæ¥åˆ¤æ–­æ•°æ®çš„å¯è§æ€§ï¼Œéœ€è¦ä¾é åå°åƒåœ¾å›æ”¶çº¿ç¨‹çœŸæ­£çš„è¿›è¡Œå›æ»šå’Œå¯¹gapçš„æ¸…ç†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›\nå¯ä»¥çœ‹å‡ºï¼ŒWBLæœ¬è´¨å¹¶æ²¡æœ‰ä»€ä¹ˆæ–°é¢–ï¼Œæ˜¯ä¸€ä¸ªForceåŠ Undoçš„å®ç°æ–¹å¼ï¼Œå…¶æ­£ç¡®æ€§ä¿è¯å¦‚ä¸‹ï¼š\nDurability of Updatesï¼šCommitäº‹åŠ¡çš„æ•°æ®åˆ·ç›˜åæ‰è¿›è¡ŒCommitï¼Œå› æ­¤Commitäº‹åŠ¡çš„æ•°æ®ä¸€å®šåœ¨Recoveryåå­˜åœ¨\nFailure Atomicï¼šé€šè¿‡è®°å½•çš„Undoä¿¡æ¯æˆ–å¤šç‰ˆæœ¬æ—¶çš„å†å²ç‰ˆæœ¬ä¿¡æ¯ï¼Œåœ¨Recoveryåä¾é åå°åƒåœ¾å›æ”¶çº¿ç¨‹è¿›è¡Œå›æ»šã€‚\n\næ€»ç»“æ•°æ®åº“æ•…éšœæ¢å¤é—®é¢˜æœ¬è´¨æ˜¯è¦åœ¨å®¹å¿æ•…éšœå‘ç”Ÿçš„æƒ…å†µä¸‹ä¿è¯æ•°æ®åº“çš„æ­£ç¡®æ€§ï¼Œè€Œè¿™ç§æ­£ç¡®æ€§éœ€è¦é€šè¿‡æä¾›Durability of Updateså’ŒFailure Atomicæ¥ä¿è¯ã€‚å…¶ä¸­Duribility of Updateè¦ä¿è¯Commitäº‹åŠ¡æ•°æ®åœ¨æ¢å¤åå­˜åœ¨ï¼Œå¯ä»¥é€šè¿‡Forceæœºåˆ¶æˆ–è€…é€šè¿‡Redoä¿¡æ¯å›æ”¾æ¥ä¿è¯ï¼›å¯¹åº”çš„ï¼ŒFailure Atomicéœ€è¦ä¿è¯æœªCommitäº‹åŠ¡çš„ä¿®æ”¹å†æ¢å¤åæ¶ˆå¤±ï¼Œå¯ä»¥é€šè¿‡No-Stealæœºåˆ¶æˆ–è€…é€šè¿‡Undoä¿¡æ¯å›æ»šæ¥ä¿è¯ã€‚æ ¹æ®ä¿è¯Durabilityå’ŒAtomicçš„ä¸åŒæ–¹å¼ï¼Œå¯¹æœ¬æ–‡æåˆ°çš„ç®—æ³•è¿›è¡Œåˆ†ç±»ï¼Œå¦‚ä¸‹ï¼š\n\n\nShadow Pagingå¯ä»¥çœ‹åšæ˜¯é‡‡ç”¨äº†ForceåŠ No-Stealçš„æ–¹å¼ï¼Œæ²¡æœ‰Logä¿¡æ¯ï¼Œåœ¨Commitæ—¶ï¼Œé€šè¿‡åŸå­çš„ä¿®æ”¹Directoryå…ƒä¿¡æ¯å®Œæˆæ•°æ®çš„æŒä¹…åŒ–æ›´æ–°ï¼Œä½†ç”±äºå…¶å¯¹Pageå†…å¹¶å‘çš„é™åˆ¶ç­‰é—®é¢˜ï¼Œæ²¡æœ‰æˆä¸ºä¸»æµï¼›\nLoggingçš„å®ç°æ–¹å¼å¢åŠ äº†Redoæˆ–Undoæ—¥å¿—ï¼Œè®°å½•æ¢å¤éœ€è¦çš„ä¿¡æ¯ï¼Œä»è€Œæ”¾æ¾Forceæˆ–No-Stealæœºåˆ¶å¯¹åˆ·ç›˜é¡ºåºçš„é™åˆ¶ï¼Œä»è€Œå°½é‡ç”¨ç£ç›˜é¡ºåºå†™ä»£æ›¿éšæœºå†™è·å¾—è¾ƒå¥½çš„æ€§èƒ½ã€‚ARIESç®—æ³•æ˜¯åœ¨è¿™ä¸€æ–¹å‘ä¸Šçš„é›†å¤§æˆè€…ï¼Œå…¶å¯¹ä¸Šå±‚åº”ç”¨æä¾›äº†ä¸°å¯Œçµæ´»çš„æ¥å£ï¼Œé‡‡ç”¨äº†No-ForceåŠ Stealæœºåˆ¶ï¼Œå°†ä¼ ç»Ÿç£ç›˜ä¸Šçš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ï¼Œä»è€Œæˆä¸ºä¼ ç»Ÿç£ç›˜æ•°æ®æ•…éšœæ¢å¤é—®é¢˜çš„æ ‡å‡†è§£å†³æ–¹æ¡ˆï¼›\néšç€NVMè®¾å¤‡çš„é€æ­¥å‡ºç°ï¼Œå…¶æ¥è¿‘å†…å­˜çš„æ€§èƒ½ã€åŒæ ·ä¼˜å¼‚çš„é¡ºåºè®¿é—®å’Œéšæœºè®¿é—®è¡¨ç°ï¼Œä»¥åŠåŸºäºå­—èŠ‚çš„å¯»å€æ–¹å¼ï¼Œä¿ƒä½¿äººä»¬å¼€å§‹é‡æ–°å®¡è§†æ•°æ®åº“æ•…éšœæ¢å¤çš„å®ç°ã€‚å…¶æ ¸å¿ƒæ€è·¯åœ¨äºå……åˆ†åˆ©ç”¨NVMç¡¬ä»¶ç‰¹æ€§ï¼Œå‡å°‘Logæœºåˆ¶å¯¼è‡´çš„å†™æ”¾å¤§ä»¥åŠè®¾è®¡è¾ƒå¤æ‚çš„é—®é¢˜ï¼›\nMARSä½œä¸ºå…¶ä¸­çš„ä½¼ä½¼è€…ä¹‹ä¸€ï¼Œåœ¨NVMä¸Šç»´æŠ¤å¯ä»¥éšæœºè®¿é—®çš„Redoæ—¥å¿—ï¼ŒåŒæ—¶é‡‡ç”¨ForceåŠ Stealçš„ç¼“å­˜ç­–ç•¥ï¼Œå……åˆ†åˆ©ç”¨NVMä¼˜å¼‚çš„éšæœºå†™æ€§èƒ½å’Œå†…éƒ¨å¸¦å®½ã€‚\nWBLä»å¦ä¸€ä¸ªæ–¹å‘è¿›è¡Œæ”¹é€ ï¼Œä¿ç•™Undoä¿¡æ¯ï¼Œé‡‡ç”¨No-ForceåŠ No-Stealçš„ç¼“å­˜ç­–ç•¥ï¼Œå¹¶é€šè¿‡Group CommitåŠå»¶è¿Ÿå›æ»šç­‰ä¼˜åŒ–ï¼Œå‡å°‘æ—¥å¿—ä¿¡æ¯ï¼Œç¼©çŸ­æ¢å¤æ—¶é—´ã€‚\n\næœ¬æ–‡ä»‹ç»äº†ç£ç›˜æ•°æ®åº“ä¸€è·¯èµ°æ¥çš„æ ¸å¿ƒå‘å±•æ€è·¯ï¼Œä½†è·ç¦»çœŸæ­£çš„å®ç°è¿˜æœ‰å·¨å¤§çš„è·ç¦»å’Œä¼—å¤šçš„è®¾è®¡ç»†èŠ‚ï¼Œå¦‚å¯¹Logical Logæˆ–Physical Logçš„é€‰æ‹©ã€å¹¶å‘Recoveryã€Fuzzy Checkpoingã€Nested Top Actionsç­‰ï¼Œä¹‹åä¼šç”¨å•ç‹¬çš„æ–‡ç« ä»¥InnoDBä¸ºä¾‹æ¥æ·±å…¥æ¢ç©¶å…¶è®¾è®¡å’Œå®ç°ç»†èŠ‚ã€‚\n","categories":["MySQL"]},{"title":"æµ…ææ•°æ®åº“å¹¶å‘æ§åˆ¶æœºåˆ¶","url":"/posts/10983/","content":"æ•°æ®åº“äº‹åŠ¡éš”ç¦»å‘å±•æ ‡å‡†ä¸€æ–‡ä¸­ï¼Œä»æ ‡å‡†åˆ¶å®šçš„è§’åº¦ä»‹ç»äº†æ•°æ®åº“çš„éš”ç¦»çº§åˆ«ï¼Œä»‹ç»äº†Read Uncommittedã€Read Committedã€Repeatable Readã€Serializableç­‰éš”ç¦»çº§åˆ«çš„å®šä¹‰ã€‚æœ¬æ–‡å°±æ¥çœ‹çœ‹ç©¶ç«Ÿæœ‰å“ªäº›å¸¸è§çš„å®ç°äº‹åŠ¡éš”ç¦»çš„æœºåˆ¶ï¼Œç§°ä¹‹ä¸ºå¹¶å‘æ§åˆ¶ï¼ˆConcurrency Controlï¼‰ã€‚\nåŸç†æ‰€è°“å¹¶å‘æ§åˆ¶ï¼Œå°±æ˜¯ä¿è¯å¹¶å‘æ‰§è¡Œçš„äº‹åŠ¡åœ¨æŸä¸€éš”ç¦»çº§åˆ«ä¸Šçš„æ­£ç¡®æ‰§è¡Œçš„æœºåˆ¶ã€‚éœ€è¦æŒ‡å‡ºçš„æ˜¯å¹¶å‘æ§åˆ¶ç”±æ•°æ®åº“çš„è°ƒåº¦å™¨è´Ÿè´£ï¼Œäº‹åŠ¡æœ¬èº«å¹¶ä¸æ„ŸçŸ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒSchedulerå°†å¤šä¸ªäº‹åŠ¡çš„è¯»å†™è¯·æ±‚ï¼Œæ’åˆ—ä¸ºåˆæ³•çš„åºåˆ—ï¼Œä½¿ä¹‹ä¾æ¬¡æ‰§è¡Œï¼š\n\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå¯¹å¯èƒ½ç ´åæ•°æ®æ­£ç¡®æ€§çš„å†²çªäº‹åŠ¡ï¼Œè°ƒåº¦å™¨å¯èƒ½é€‰æ‹©ä¸‹é¢ä¸¤ç§å¤„ç†æ–¹å¼ï¼š\n\nDelayï¼šå»¶è¿ŸæŸä¸ªäº‹åŠ¡çš„æ‰§è¡Œåˆ°åˆæ³•çš„æ—¶åˆ»\nAbortï¼šç›´æ¥æ”¾å¼ƒäº‹åŠ¡çš„æäº¤ï¼Œå¹¶å›æ»šè¯¥äº‹åŠ¡å¯èƒ½é€ æˆçš„å½±å“\n\nå¯ä»¥çœ‹å‡ºAbortæ¯”Delayå¸¦æ¥æ›´é«˜çš„æˆæœ¬ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±ä»‹ç»ä¸åŒçš„å¹¶å‘æ§åˆ¶æœºåˆ¶åœ¨ä¸åŒæƒ…å†µä¸‹çš„å¤„ç†æ–¹å¼ã€‚\nåˆ†ç±»\nè¿™é‡Œä»ä¸¤ä¸ªç»´åº¦ï¼Œå¯¹å¸¸è§çš„å¹¶å‘æ§åˆ¶æœºåˆ¶è¿›è¡Œåˆ†ç±»ï¼š\n1. ä¹è§‚ç¨‹åº¦ä¸åŒçš„å®ç°æœºåˆ¶ï¼ŒåŸºäºä¸åŒçš„å¯¹å‘ç”Ÿå†²çªæ¦‚ç‡çš„å‡è®¾ï¼Œæ‚²è§‚æ–¹å¼è®¤ä¸ºåªè¦ä¸¤ä¸ªäº‹åŠ¡è®¿é—®ç›¸åŒçš„æ•°æ®åº“å¯¹è±¡ï¼Œå°±ä¸€å®šä¼šå‘ç”Ÿå†²çªï¼Œå› è€Œåº”è¯¥å°½æ—©é˜»æ­¢ï¼›è€Œä¹è§‚çš„æ–¹å¼è®¤ä¸ºï¼Œå†²çªå‘ç”Ÿçš„æ¦‚ç‡ä¸å¤§ï¼Œå› æ­¤ä¼šå»¶åå¤„ç†å†²çªçš„æ—¶æœºã€‚å¦‚ä¸Šå›¾æ¨ªåæ ‡æ‰€ç¤ºï¼Œä¹è§‚ç¨‹åº¦ä»å·¦å‘å³å¢é«˜ï¼š\n\nåŸºäºLockï¼šæœ€æ‚²è§‚çš„å®ç°ï¼Œéœ€è¦åœ¨æ“ä½œå¼€å§‹å‰ï¼Œç”šè‡³æ˜¯äº‹åŠ¡å¼€å§‹å‰ï¼Œå¯¹è¦è®¿é—®çš„æ•°æ®åº“å¯¹è±¡åŠ é”ï¼Œå¯¹å†²çªæ“ä½œDelayï¼›\nåŸºäºTimestampï¼šä¹è§‚çš„å®ç°ï¼Œæ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶è·å¾—å…¨å±€é€’å¢çš„æ—¶é—´æˆ³ï¼ŒæœŸæœ›æŒ‰ç…§å¼€å§‹æ—¶çš„æ—¶é—´æˆ³ä¾æ¬¡æ‰§è¡Œï¼Œåœ¨æ“ä½œæ•°æ®åº“å¯¹è±¡æ—¶æ£€æŸ¥å†²çªå¹¶é€‰æ‹©Delayæˆ–è€…Abortï¼›\nåŸºäºValidationï¼šæ›´ä¹è§‚çš„å®ç°ï¼Œä»…åœ¨Commitå‰è¿›è¡ŒValidateï¼Œå¯¹å†²çªçš„äº‹åŠ¡Abort\n\nå¯ä»¥çœ‹å‡ºï¼Œä¸åŒä¹è§‚ç¨‹åº¦çš„æœºåˆ¶æœ¬è´¨çš„åŒºåˆ«åœ¨äºï¼Œæ£€æŸ¥æˆ–é¢„åˆ¤å†²çªçš„æ—¶æœºï¼ŒLockåœ¨äº‹åŠ¡å¼€å§‹æ—¶ï¼ŒTimestampåœ¨æ“ä½œè¿›è¡Œæ—¶ï¼Œè€ŒValidationåœ¨æœ€ç»ˆCommitå‰ã€‚ç›¸å¯¹äºæ‚²è§‚çš„æ–¹å¼ï¼Œä¹è§‚æœºåˆ¶å¯ä»¥è·å¾—æ›´é«˜çš„å¹¶å‘åº¦ï¼Œè€Œä¸€æ—¦å†²çªå‘ç”Ÿï¼ŒAbortäº‹åŠ¡ä¹Ÿä¼šæ¯”Delayå¸¦æ¥æ›´å¤§çš„å¼€é”€ã€‚\n2. å•ç‰ˆæœ¬ VS å¤šç‰ˆæœ¬å¦‚ä¸Šå›¾çºµåæ ‡æ‰€ç¤ºï¼Œç›¸åŒçš„ä¹è§‚ç¨‹åº¦ä¸‹ï¼Œè¿˜å­˜åœ¨å¤šç‰ˆæœ¬çš„å®ç°ã€‚æ‰€è°“å¤šç‰ˆæœ¬ï¼Œå°±æ˜¯åœ¨æ¯æ¬¡éœ€è¦å¯¹æ•°æ®åº“å¯¹è±¡ä¿®æ”¹æ—¶ï¼Œç”Ÿæˆæ–°çš„æ•°æ®ç‰ˆæœ¬ï¼Œæ¯ä¸ªå¯¹è±¡çš„å¤šä¸ªç‰ˆæœ¬å…±å­˜ã€‚è¯»è¯·æ±‚å¯ä»¥ç›´æ¥è®¿é—®å¯¹åº”ç‰ˆæœ¬çš„æ•°æ®ï¼Œä»è€Œé¿å…è¯»å†™äº‹åŠ¡å’Œåªè¯»äº‹åŠ¡çš„ç›¸äº’é˜»å¡ã€‚å½“ç„¶å¤šç‰ˆæœ¬ä¹Ÿä¼šå¸¦æ¥å¯¹ä¸åŒç‰ˆæœ¬çš„ç»´æŠ¤æˆæœ¬ï¼Œå¦‚éœ€è¦åƒåœ¾å›æ”¶æœºåˆ¶æ¥é‡Šæ”¾ä¸è¢«ä»»ä½•äº‹ç‰©å¯è§çš„ç‰ˆæœ¬ã€‚\néœ€è¦æŒ‡å‡ºçš„æ˜¯è¿™äº›å¹¶å‘æ§åˆ¶æœºåˆ¶å¹¶ä¸ä¸å…·ä½“çš„éš”ç¦»çº§åˆ«ç»‘å®šï¼Œé€šè¿‡å†²çªåˆ¤æ–­çš„ä¸åŒè§„åˆ™ï¼Œå¯ä»¥å®ç°ä¸åŒå¼ºåº¦çš„éš”ç¦»çº§åˆ«ï¼Œä¸‹é¢åŸºäºSerializableå…·ä½“ä»‹ç»æ¯ç§æœºåˆ¶çš„å®ç°æ–¹å¼ã€‚\nåŸºäºLockåŸºäºLockå®ç°çš„Scheduleréœ€è¦åœ¨äº‹åŠ¡è®¿é—®æ•°æ®å‰åŠ ä¸Šå¿…è¦çš„é”ä¿æŠ¤ï¼Œä¸ºäº†æé«˜å¹¶å‘ï¼Œä¼šæ ¹æ®å®é™…è®¿é—®æƒ…å†µåˆ†é…ä¸åŒæ¨¡å¼çš„é”ï¼Œå¸¸è§çš„æœ‰è¯»å†™é”ï¼Œæ›´æ–°é”ç­‰ã€‚æœ€ç®€å•åœ°ï¼Œéœ€è¦é•¿æœŸæŒæœ‰é”åˆ°äº‹åŠ¡ç»“æŸï¼Œä¸ºäº†å°½å¯èƒ½çš„åœ¨ä¿è¯æ­£ç¡®æ€§çš„åŸºç¡€ä¸Šæé«˜å¹¶è¡Œåº¦ï¼Œæ•°æ®åº“ä¸­å¸¸ç”¨çš„åŠ é”æ–¹å¼ç§°ä¸ºä¸¤é˜¶æ®µé”ï¼ˆ2PLï¼‰ï¼ŒGrowingé˜¶æ®µå¯ä»¥ç”³è¯·åŠ é”ï¼ŒShrinkingé˜¶æ®µåªèƒ½é‡Šæ”¾ï¼Œå³åœ¨ç¬¬ä¸€æ¬¡é‡Šæ”¾é”ä¹‹åä¸èƒ½å†æœ‰ä»»ä½•åŠ é”è¯·æ±‚ã€‚éœ€è¦æ³¨æ„çš„æ˜¯2PLå¹¶ä¸èƒ½è§£å†³æ­»é”çš„é—®é¢˜ï¼Œå› æ­¤è¿˜éœ€è¦æœ‰æ­»é”æ£€æµ‹åŠå¤„ç†çš„æœºåˆ¶ï¼Œé€šå¸¸æ˜¯é€‰æ‹©æ­»é”çš„äº‹åŠ¡è¿›è¡ŒAbortã€‚\n\nSchedulerå¯¹å†²çªçš„åˆ¤æ–­è¿˜éœ€è¦é…åˆLock Tableï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºæ˜¯ä¸€ä¸ªå¯èƒ½å¾—Lock Tableä¿¡æ¯ç¤ºæ„ï¼Œæ¯ä¸€ä¸ªè¢«è®¿é—®çš„æ•°æ®åº“å¯¹è±¡éƒ½ä¼šåœ¨Lock Tableä¸­æœ‰å¯¹åº”çš„è¡¨é¡¹ï¼Œå…¶ä¸­è®°å½•äº†å½“å‰æœ€é«˜çš„æŒæœ‰é”çš„æ¨¡å¼ã€æ˜¯å¦æœ‰äº‹åŠ¡åœ¨Delayã€ä»¥åŠæŒæœ‰æˆ–ç­‰å¾…å¯¹åº”é”çš„äº‹åŠ¡é“¾è¡¨ï¼›åŒæ—¶å¯¹é“¾è¡¨ä¸­çš„æ¯ä¸ªäº‹åŠ¡è®°å½•å…¶äº‹åŠ¡IDï¼Œè¯·æ±‚é”çš„æ¨¡å¼ä»¥åŠæ˜¯å¦å·²ç»æŒæœ‰è¯¥é”ã€‚Schedulerä¼šåœ¨åŠ é”è¯·æ±‚åˆ°æ¥æ—¶ï¼Œé€šè¿‡æŸ¥æ‰¾Lock Tableåˆ¤æ–­èƒ½å¦åŠ é”æˆ–æ˜¯Delayï¼Œå¦‚æœDelayéœ€è¦æ’å…¥åˆ°é“¾è¡¨ä¸­ã€‚å¯¹åº”çš„å½“äº‹åŠ¡Commitæˆ–Abortåéœ€è¦å¯¹å…¶æŒæœ‰çš„é”è¿›è¡Œé‡Šæ”¾ï¼Œå¹¶æŒ‰ç…§ä¸åŒçš„ç­–ç•¥å”¤é†’ç­‰å¾…é˜Ÿåˆ—ä¸­Delayçš„äº‹åŠ¡ã€‚\n\nåŸºäºTimestampåŸºäºTimestampçš„Schedulerä¼šåœ¨äº‹åŠ¡å¼€å§‹æ—¶å€™åˆ†é…ä¸€ä¸ªå…¨å±€è‡ªå¢çš„Timestampï¼Œè¿™ä¸ªTimestampé€šå¸¸ç”±ç‰©ç†æ—¶é—´æˆ³æˆ–ç³»ç»Ÿç»´æŠ¤çš„è‡ªå¢idäº§ç”Ÿï¼Œç”¨äºåŒºåˆ†äº‹åŠ¡å¼€å§‹çš„å…ˆåã€‚åŒæ—¶ï¼Œæ¯ä¸ªæ•°æ®åº“å¯¹è±¡éœ€è¦å¢åŠ ä¸€äº›é¢å¤–çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯ä¼šç”±å¯¹åº”çš„äº‹åŠ¡åœ¨è®¿é—®åæ›´æ–°ï¼ŒåŒ…æ‹¬:\n\nRT(X): æœ€å¤§çš„è¯»äº‹åŠ¡çš„Timestamp\nWT(X): æœ€å¤§çš„å†™äº‹åŠ¡çš„Timestamp\nC(X): æœ€æ–°ä¿®æ”¹çš„äº‹åŠ¡æ˜¯å¦å·²ç»æäº¤\n\nåŸºäºTimestampå‡è®¾å¼€å§‹æ—¶Timestampçš„é¡ºåºå°±æ˜¯äº‹åŠ¡æ‰§è¡Œçš„é¡ºåºï¼Œå½“äº‹åŠ¡è®¿é—®æ•°æ®åº“å¯¹è±¡æ—¶ï¼Œé€šè¿‡å¯¹æ¯”äº‹åŠ¡è‡ªå·±çš„Timestampå’Œè¯¥å¯¹è±¡çš„ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°ä¸è¿™ç§ä¸å¼€å§‹é¡ºåºä¸ä¸€è‡´çš„æƒ…å†µï¼Œå¹¶ä½œå‡ºåº”å¯¹ï¼š\n\nRead Lateï¼šæ¯”è‡ªå·±Timestampæ™šçš„äº‹åŠ¡åœ¨è‡ªå·±æƒ³è¦Readä¹‹å‰å¯¹è¯¥æ•°æ®è¿›è¡Œäº†å†™å…¥ï¼Œå¹¶ä¿®æ”¹äº†WT(X)ï¼Œæ­¤æ—¶ä¼šReadä¸ä¸€è‡´çš„æ•°æ®ã€‚\nWrite Late: æ¯”è‡ªå·±Timestampæ™šçš„äº‹åŠ¡åœ¨è‡ªå·±æƒ³è¦Writeä¹‹å‰è¯»å–äº†è¯¥æ•°æ®ï¼Œå¹¶ä¿®æ”¹äº†RT(X)ï¼Œå¦‚æœç»§ç»­å†™å…¥ä¼šå¯¼è‡´å¯¹æ–¹è¯»åˆ°ä¸ä¸€è‡´æ•°æ®ã€‚\n\nè¿™ä¸¤ç§æƒ…å†µéƒ½æ˜¯ç”±äºå®é™…è®¿é—®æ•°æ®çš„é¡ºåºä¸å¼€å§‹é¡ºåºä¸åŒå¯¼è‡´çš„ï¼ŒScheduleréœ€è¦å¯¹å†²çªçš„äº‹åŠ¡è¿›è¡ŒAbortã€‚\n\nRead Dirtyï¼šé€šè¿‡å¯¹æ¯”C(X)ï¼Œå¯ä»¥å‘ç°æ˜¯å¦çœ‹åˆ°çš„æ˜¯å·²ç»Commitçš„æ•°æ®ï¼Œå¦‚æœéœ€è¦ä¿è¯Read Commitï¼Œåˆ™éœ€è¦Delayäº‹åŠ¡åˆ°å¯¹æ–¹Commitä¹‹åå†è¿›è¡Œæäº¤ã€‚\n\nåŸºäºValidationï¼ˆOCCï¼‰åŸºäºValidationçš„æ–¹å¼ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸ºOptimistic Concurrency Control(OCC)ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºå®ƒæ¯”åŸºäºTimestampçš„æ–¹å¼è¦æ›´åŠ çš„ä¹è§‚ï¼Œå°†å†²çªæ£€æµ‹æ¨è¿Ÿåˆ°Commitå‰æ‰è¿›è¡Œã€‚ä¸åŒäºTimestampæ–¹å¼è®°å½•æ¯ä¸ªå¯¹è±¡çš„è¯»å†™æ—¶é—´ï¼ŒValidationçš„æ–¹å¼è®°å½•çš„æ˜¯æ¯ä¸ªäº‹ç‰©çš„è¯»å†™æ“ä½œé›†åˆã€‚å¹¶å°†äº‹ç‰©åˆ’åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š\n\nReadé˜¶æ®µï¼šä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®å¹¶åœ¨ç§æœ‰ç©ºé—´å®Œæˆå†™æ“ä½œï¼Œè¿™ä¸ªæ—¶å€™å…¶å®å¹¶æ²¡æœ‰å®é™…å†™å…¥æ•°æ®åº“ã€‚ç»´æŠ¤å½“å‰äº‹åŠ¡çš„è¯»å†™é›†åˆï¼ŒRSã€WSï¼›\nValidateé˜¶æ®µï¼šå¯¹æ¯”å½“å‰äº‹åŠ¡ä¸å…¶ä»–æœ‰æ—¶é—´é‡å çš„äº‹åŠ¡çš„è¯»å†™é›†åˆï¼Œåˆ¤æ–­èƒ½å¦æäº¤ï¼›\nWriteé˜¶æ®µï¼šè‹¥ValidateæˆåŠŸï¼Œè¿›å…¥Writeé˜¶æ®µï¼Œè¿™é‡Œæ‰çœŸæ­£å†™å…¥æ•°æ®åº“ã€‚\n\n\nåŒæ—¶ï¼ŒSchedulerä¼šè®°å½•æ¯ä¸ªäº‹åŠ¡çš„å¼€å§‹æ—¶é—´START(T)ï¼ŒéªŒè¯æ—¶é—´VAL(T)ï¼Œå®Œæˆå†™å…¥æ—¶é—´FIN(T)\nåŸºäºValidataionçš„æ–¹å¼å‡è®¾äº‹åŠ¡Validationçš„é¡ºåºå°±æ˜¯äº‹åŠ¡æ‰§è¡Œçš„é¡ºåºï¼Œå› æ­¤éªŒè¯çš„æ—¶å€™éœ€è¦æ£€æŸ¥è®¿é—®æ•°æ®é¡ºåºå¯èƒ½å¾—ä¸ä¸€è‡´ï¼š\n\nRS(T)å’ŒWS(U) æ˜¯å¦æœ‰äº¤é›†ï¼Œå¯¹ä»»ä½•äº‹åŠ¡Uï¼ŒFIN(U) &gt; START(T)ï¼Œå¦‚æœæœ‰äº¤é›†ï¼Œåˆ™Tçš„è¯»å¯èƒ½ä¸Uçš„å†™ä¹±åºï¼›\nWS(T)å’ŒWS({U) æ˜¯å¦æœ‰äº¤é›†ï¼Œå¯¹ä»»ä½•äº‹åŠ¡Uï¼Œ Fin(U) &gt; VAL(T)ï¼Œå¦‚æœæœ‰äº¤é›†ï¼Œåˆ™Tçš„å†™å¯èƒ½ä¸Uçš„å†™ä¹±åºã€‚\n\nMultiversionï¼ˆMVCCï¼‰å¯¹åº”ä¸Šè¿°æ¯ç§ä¹è§‚ç¨‹åº¦ï¼Œéƒ½å¯ä»¥æœ‰å¤šç‰ˆæœ¬çš„å®ç°æ–¹å¼ï¼Œå¤šç‰ˆæœ¬çš„ä¼˜åŠ¿åœ¨äºï¼Œå¯ä»¥è®©è¯»å†™äº‹åŠ¡ä¸åªè¯»äº‹åŠ¡äº’ä¸å¹²æ‰°ï¼Œå› è€Œè·å¾—æ›´å¥½çš„å¹¶è¡Œåº¦ï¼Œä¹Ÿæ­£æ˜¯ç”±äºè¿™ä¸€ç‚¹æˆä¸ºå‡ ä¹æ‰€æœ‰ä¸»æµæ•°æ®åº“çš„é€‰æ‹©ã€‚ä¸ºäº†å®ç°å¤šç‰ˆæœ¬çš„å¹¶å‘æ§åˆ¶ï¼Œéœ€è¦ç»™æ¯ä¸ªäº‹åŠ¡åœ¨å¼€å§‹æ—¶åˆ†é…ä¸€ä¸ªå”¯ä¸€æ ‡è¯†TIDï¼Œå¹¶å¯¹æ•°æ®åº“å¯¹è±¡å¢åŠ ä»¥ä¸‹ä¿¡æ¯ï¼š\n\ntxd-idï¼Œåˆ›å»ºè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡TID\nbegin-tsåŠend-tsåˆ†åˆ«è®°å½•è¯¥ç‰ˆæœ¬åˆ›å»ºå’Œè¿‡æœŸæ—¶çš„äº‹åŠ¡TID\npointer: æŒ‡å‘è¯¥å¯¹è±¡å…¶ä»–ç‰ˆæœ¬çš„é“¾è¡¨\n\n\nå…¶åŸºæœ¬çš„å®ç°æ€è·¯æ˜¯ï¼Œæ¯æ¬¡å¯¹æ•°æ®åº“å¯¹è±¡çš„å†™æ“ä½œéƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„ç‰ˆæœ¬ï¼Œç”¨è‡ªå·±çš„TIDæ ‡è®°æ–°ç‰ˆæœ¬begin-tsåŠä¸Šä¸€ä¸ªç‰ˆæœ¬çš„end-tsï¼Œå¹¶å°†è‡ªå·±åŠ å…¥é“¾è¡¨ã€‚è¯»æ“ä½œå¯¹æ¯”è‡ªå·±çš„TIDä¸æ•°æ®ç‰ˆæœ¬çš„begin-tsï¼Œend-tsï¼Œæ‰¾åˆ°å…¶å¯è§æœ€æ–°çš„ç‰ˆæœ¬è¿›è¡Œè®¿é—®ã€‚æ ¹æ®ä¹è§‚ç¨‹åº¦å¤šç‰ˆæœ¬çš„æœºåˆ¶ä¹Ÿåˆ†ä¸ºä¸‰ç±»ï¼š\n1. Two-phase Locking (MV2PL)ä¸å•ç‰ˆæœ¬çš„2PLæ–¹å¼ç±»ä¼¼ï¼ŒåŒæ ·éœ€è¦Lock Tableè·Ÿè¸ªå½“å‰çš„åŠ é”åŠç­‰å¾…ä¿¡æ¯ï¼Œå¦å¤–ç»™æ•°æ®åº“å¯¹è±¡å¢åŠ äº†å¤šç‰ˆæœ¬éœ€è¦çš„begin-tså’Œend-tsä¿¡æ¯ã€‚å†™æ“ä½œéœ€è¦å¯¹æœ€æ–°çš„ç‰ˆæœ¬åŠ å†™é”ï¼Œå¹¶ç”Ÿæˆæ–°çš„æ•°æ®ç‰ˆæœ¬ã€‚è¯»æ“ä½œå¯¹æ‰¾åˆ°çš„æœ€æ–°çš„å¯è§ç‰ˆæœ¬åŠ è¯»é”è®¿é—®ã€‚\n2. Timestamp Ordering (MVTO)å¯¹æ¯”å•ç‰ˆæœ¬çš„Timestampæ–¹å¼å¯¹æ¯ä¸ªæ•°æ®åº“å¯¹è±¡è®°å½•çš„Read TimeStamp(RT)ï¼ŒWrite TimeStamp(WT)ï¼ŒCommited flag(C)ä¿¡æ¯å¤–å¢åŠ äº†æ ‡è¯†ç‰ˆæœ¬çš„begin-tså’Œend-tsï¼ŒåŒæ ·åœ¨äº‹åŠ¡å¼€å§‹å‰è·å¾—å”¯ä¸€é€’å¢çš„Start TimeStampï¼ˆTSï¼‰ï¼Œå†™äº‹åŠ¡éœ€è¦å¯¹æ¯”è‡ªå·±çš„TSå’Œå¯è§æœ€æ–°ç‰ˆæœ¬çš„RTæ¥éªŒè¯é¡ºåºï¼Œå†™å…¥æ˜¯åˆ›å»ºæ–°ç‰ˆæœ¬ï¼Œå¹¶ç”¨è‡ªå·±çš„TSæ ‡è®°æ–°ç‰ˆæœ¬çš„WTï¼Œä¸åŒäºå•ç‰ˆæœ¬ï¼Œè¿™ä¸ªWTä¿¡æ¯æ°¸ä¸æ”¹å˜ã€‚è¯»è¯·æ±‚è¯»å–è‡ªå·±å¯è§çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¹¶åœ¨è®¿é—®åä¿®æ”¹å¯¹åº”ç‰ˆæœ¬çš„RTï¼ŒåŒæ ·é€šè¿‡åˆ¤æ–­C flagä¿¡æ¯é¿å…Read Uncommittedã€‚\n3. Optimistic Concurrency Control (MVOCC)å¯¹æ¯”å•ç‰ˆæœ¬çš„Validataionï¼ˆOCCï¼‰æ–¹å¼ï¼ŒåŒæ ·åˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼ŒReadé˜¶æ®µæ ¹æ®begin-tsï¼Œend-tsæ‰¾åˆ°å¯è§æœ€æ–°ç‰ˆæœ¬ï¼Œä¸åŒçš„æ˜¯åœ¨å¤šç‰ˆæœ¬ä¸‹Readé˜¶æ®µçš„å†™æ“ä½œä¸åœ¨ç§æœ‰ç©ºé—´å®Œæˆï¼Œè€Œæ˜¯ç›´æ¥ç”Ÿæˆæ–°çš„ç‰ˆæœ¬ï¼Œå¹¶åœ¨å…¶ä¹‹ä¸Šè¿›è¡Œæ“ä½œï¼Œç”±äºå…¶commitå‰begin-tsä¸ºINFï¼Œæ‰€ä»¥ä¸è¢«å…¶ä»–äº‹åŠ¡è¯¾ä»¶ï¼›Validationé˜¶æ®µåˆ†é…æ–°çš„Commit TIDï¼Œå¹¶ä»¥ä¹‹åˆ¤æ–­æ˜¯å¦å¯ä»¥æäº¤ï¼›é€šè¿‡Validationçš„äº‹åŠ¡è¿›å…¥Writeé˜¶æ®µå°†begin-tsä¿®æ”¹ä¸ºCommit TIDã€‚\næ€»ç»“ç›¸å¯¹äºæ‚²è§‚çš„é”å®ç°ï¼Œä¹è§‚çš„æœºåˆ¶å¯ä»¥åœ¨å†²çªå‘ç”Ÿè¾ƒå°‘çš„æƒ…å†µä¸‹è·å¾—æ›´å¥½çš„å¹¶å‘æ•ˆæœï¼Œç„¶è€Œä¸€æ—¦å†²çªï¼Œéœ€è¦äº‹åŠ¡å›æ»šå¸¦æ¥çš„å¼€é”€è¦è¿œå¤§äºæ‚²è§‚å®ç°çš„é˜»å¡ï¼Œå› æ­¤ä»–ä»¬å„è‡ªé€‚åº”äºä¸åŒçš„åœºæ™¯ã€‚è€Œå¤šç‰ˆæœ¬ç”±äºé¿å…è¯»å†™äº‹åŠ¡ä¸åªè¯»äº‹åŠ¡çš„äº’ç›¸é˜»å¡ï¼Œ åœ¨å¤§å¤šæ•°æ•°æ®åº“åœºæ™¯ä¸‹éƒ½å¯ä»¥å–å¾—å¾ˆå¥½çš„å¹¶å‘æ•ˆæœï¼Œå› æ­¤è¢«å¤§å¤šæ•°ä¸»æµæ•°æ®åº“é‡‡ç”¨ã€‚å¯ä»¥çœ‹å‡ºæ— è®ºæ˜¯ä¹è§‚æ‚²è§‚çš„é€‰æ‹©ï¼Œå¤šç‰ˆæœ¬çš„å®ç°ï¼Œè¯»å†™é”ï¼Œä¸¤é˜¶æ®µé”ç­‰å„ç§å¹¶å‘æ§åˆ¶çš„æœºåˆ¶ï¼Œå½’æ ¹æ¥åœ°éƒ½æ˜¯åœ¨ç¡®å®šçš„éš”ç¦»çº§åˆ«ä¸Šå°½å¯èƒ½çš„æé«˜ç³»ç»Ÿååï¼Œå¯ä»¥è¯´éš”ç¦»çº§åˆ«é€‰æ‹©å†³å®šä¸Šé™ï¼Œè€Œå¹¶å‘æ§åˆ¶å®ç°å†³å®šä¸‹é™ã€‚\næœ¬æ–‡ä»ä¹è§‚æ‚²è§‚çš„ç¨‹åº¦ä»¥åŠå•ç‰ˆæœ¬å¤šç‰ˆæœ¬é€‰æ‹©ä¸Šå¯¹å¯ç”¨çš„å¹¶å‘æ§åˆ¶æœºåˆ¶é€‰æ‹©è¿›è¡Œäº†åˆ’åˆ†ï¼Œå¹¶ä»‹ç»äº†å„ç§æœºåˆ¶å¤§ä½“çš„è®¾è®¡æ€è·¯ï¼Œè€Œè·ç¦»çœŸæ­£çš„å®ç°è¿˜æœ‰æ¯”è¾ƒå¤§çš„è·ç¦»ï¼ŒåŒ…æ‹¬å®ç°ç»†èŠ‚å’Œé…å¥—æœºåˆ¶ã€‚æ¯”å¦‚å¸¸ç”¨çš„å„ç§ç±»å‹çš„MVCCä¸­ï¼Œç”±äºå¤šç‰ˆæœ¬çš„å­˜åœ¨è€Œå¸¦æ¥çš„ä¸€äº›åˆ—å¦‚åƒåœ¾å›æ”¶ã€ç´¢å¼•ç®¡ç†ã€ç‰ˆæœ¬å­˜å‚¨ç­‰ç›¸å…³é—®é¢˜ã€‚æˆ‘ä»¬ä¹‹åå°†ä»¥MyRocksä¸ºä¾‹çœ‹çœ‹å¹¶å‘æ§åˆ¶åœ¨å·¥ç¨‹ä¸Šçš„å…·ä½“å®ç°ã€‚\n","categories":["MySQL"]},{"title":"åˆ†å¸ƒå¼å…±è¯†ï¼ˆPaxosï¼‰","url":"/posts/61338/","content":"åœ¨æ­£å¼æ¢è®¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­é¢ä¸´çš„å„ç§æŠ€æœ¯é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆå‰ï¼Œæˆ‘ä»¬å…ˆæŠŠç›®å…‰ä»å·¥ä¸šç•Œè½¬åˆ°å­¦æœ¯ç•Œã€å­¦ä¹ å‡ ç§å…·æœ‰ä»£è¡¨æ€§çš„åˆ†å¸ƒå¼å…±è¯†ç®—æ³•ï¼Œä¸ºåç»­åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­æ“ä½œå…±äº«æ•°æ®å‡†å¤‡å¥½ç†è®ºåŸºç¡€ã€‚ä¸‹é¢ç¬”è€…ä»ä¸€ä¸ªæœ€æµ…æ˜¾çš„åœºæ™¯å¼€å§‹ï¼Œå¼•å‡ºæœ¬ç« çš„ä¸»é¢˜:\n\nå¦‚æœä½ æœ‰ä¸€ä»½å¾ˆé‡è¦çš„æ•°æ®ï¼Œè¦ç¡®ä¿å®ƒé•¿æœŸå­˜å‚¨åœ¨ç”µè„‘ä¸Šä¸ä¼šä¸¢å¤±ï¼Œä½ ä¼šæ€ä¹ˆåš?\n\nè¿™ä¸æ˜¯ä»€ä¹ˆè„‘ç­‹æ€¥è½¬å¼¯çš„å¤æ€ªé—®é¢˜ï¼Œç­”æ¡ˆå°±æ˜¯å»ä¹°å‡ å—ç¡¬ç›˜ï¼Œåœ¨ä¸åŒç¡¬ç›˜ä¸Šå¤šå¤‡ä»½å‡ ä¸ªå‰¯æœ¬ã€‚å‡è®¾ä¸€å—ç¡¬ç›˜æ¯å¹´æŸåçš„æ¦‚ç‡æ˜¯ 5%ï¼ŒæŠŠæ–‡ä»¶å¤åˆ¶åˆ°å¦ä¸€å—å¤‡ä»½ç›˜ä¸Šï¼Œä¸¤å—ç¡¬ç›˜åŒæ—¶æŸåè€Œä¸¢å¤±æ•°æ®çš„æ¦‚ç‡å°±åªæœ‰ 0.25%ï¼Œå¦‚æœä½¿ç”¨ä¸‰å—ç¡¬ç›˜å­˜å‚¨åˆ™ä¸¢å¤±æ•°æ®çš„æ¦‚ç‡æ˜¯ 0.00125%ï¼Œå››å—æ˜¯ 0.0000625%ï¼Œæ¢è¨€ä¹‹ï¼Œå››å—ç¡¬ç›˜å°±å¯ä»¥ä¿è¯æ•°æ®åœ¨ä¸€å¹´å†…æœ‰è¶…è¿‡ 99.9999% çš„æ¦‚ç‡æ˜¯å®‰å…¨å¯é çš„ã€‚\nåœ¨è½¯ä»¶ç³»ç»Ÿé‡Œï¼Œè¦ä¿éšœç³»ç»Ÿçš„å¯é æ€§ï¼Œé‡‡ç”¨çš„åŠæ³•ä¸ä¸Šé¢ç”¨å‡ ä¸ªå¤‡ä»½ç¡¬ç›˜æ¥ä¿éšœçš„æ–¹æ³•å¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚å•ä¸ªèŠ‚ç‚¹çš„ç³»ç»Ÿå®•æœºå¯¼è‡´æ•°æ®æ— æ³•è®¿é—®çš„åŸå› å¯èƒ½æœ‰å¾ˆå¤šï¼Œè­¬å¦‚ç¨‹åºå‡ºé”™ã€ç¡¬ä»¶æŸåã€ç½‘ç»œåˆ†åŒºã€ç”µæºæ•…éšœï¼Œç­‰ç­‰ï¼Œä¸€å¹´ä¸­å‡ºç°ç³»ç»Ÿå®•æœºçš„æ¦‚ç‡ä¹Ÿè®¸è¿˜è¦é«˜äº 5%ï¼Œè¿™å†³å®šäº†è½¯ä»¶ç³»ç»Ÿä¹Ÿå¿…é¡»æœ‰å¤šå°æœºå™¨ï¼Œå¹¶ä¸”å®ƒä»¬æ‹¥æœ‰ä¸€è‡´çš„æ•°æ®å‰¯æœ¬ï¼Œæ‰æœ‰å¯èƒ½å¯¹å¤–æä¾›å¯é çš„æœåŠ¡ã€‚\nåœ¨è½¯ä»¶ç³»ç»Ÿé‡Œï¼Œè¦ä¿éšœç³»ç»Ÿçš„å¯ç”¨æ€§ï¼Œé¢ä¸´çš„å›°éš¾ä¸ç¡¬ç›˜å¤‡ä»½é¢ä¸´çš„å›°éš¾åˆæœ‰ç€æœ¬è´¨çš„åŒºåˆ«ã€‚ç¡¬ç›˜ä¹‹é—´æ˜¯å­¤ç«‹çš„ï¼Œä¸éœ€è¦äº’ç›¸é€šä¿¡ï¼Œå¤‡ä»½æ•°æ®æ˜¯é™æ€çš„ï¼Œåˆå§‹åŒ–åçŠ¶æ€å°±ä¸ä¼šå‘ç”Ÿæ”¹å˜ï¼Œç”±äººå·¥è¿›è¡Œçš„æ–‡ä»¶å¤åˆ¶æ“ä½œï¼Œå¾ˆå®¹æ˜“å°±ä¿éšœäº†æ•°æ®åœ¨å„ä¸ªå¤‡ä»½ç›˜ä¸­çš„ä¸€è‡´æ€§ã€‚ç„¶è€Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å¿…é¡»è€ƒè™‘åŠ¨æ€çš„æ•°æ®å¦‚ä½•åœ¨ä¸å¯é çš„ç½‘ç»œé€šä¿¡æ¡ä»¶ä¸‹ï¼Œä¾ç„¶èƒ½åœ¨å„ä¸ªèŠ‚ç‚¹ä¹‹é—´æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ã€‚å°†æˆ‘ä»¬è¦è®¨è®ºçš„åœºæ™¯åšå¦‚ä¸‹ä¿®æ”¹:\n\nå¦‚æœä½ æœ‰ä¸€ä»½ä¼šéšæ—¶å˜åŠ¨çš„æ•°æ®ï¼Œè¦ç¡®ä¿å®ƒæ­£ç¡®åœ°å­˜å‚¨äºç½‘ç»œä¸­çš„å‡ å°ä¸åŒæœºå™¨ä¹‹ä¸Šï¼Œä½ ä¼šæ€ä¹ˆåš?\n\nç›¸ä¿¡æœ€å®¹æ˜“æƒ³åˆ°çš„ç­”æ¡ˆä¸€å®šæ˜¯ â€œæ•°æ®åŒæ­¥â€ï¼šæ¯å½“æ•°æ®å‘ç”Ÿå˜åŒ–ï¼ŒæŠŠå˜åŒ–æƒ…å†µåœ¨å„ä¸ªèŠ‚ç‚¹é—´çš„å¤åˆ¶è§†ä½œä¸€ç§äº‹åŠ¡æ€§çš„æ“ä½œï¼Œåªæœ‰ç³»ç»Ÿé‡Œæ¯ä¸€å°æœºå™¨éƒ½åé¦ˆæˆåŠŸã€å®Œæˆç£ç›˜å†™äººï¼Œæ•°æ®çš„å˜åŒ–æ‰å®£å‘ŠæˆåŠŸã€‚ç¬”è€…æ›¾ç»åœ¨3.2èŠ‚ä¸­ä»‹ç»è¿‡ï¼Œä½¿ç”¨ 2PC/3PC å°±å¯ä»¥å®ç°è¿™ç§åŒæ­¥æ“ä½œã€‚ä¸€ç§çœŸå®çš„æ•°æ®åŒæ­¥åº”ç”¨åœºæ™¯æ˜¯æ•°æ®åº“çš„ä¸»ä»å…¨åŒæ­¥å¤åˆ¶ï¼ˆFully Synchronous Replicationï¼‰ï¼Œè­¬å¦‚ MySQL é›†ç¾¤ï¼Œå®ƒåœ¨è¿›è¡Œå…¨åŒæ­¥å¤åˆ¶æ—¶ï¼Œä¼šç­‰å¾…æ‰€æœ‰ Slave èŠ‚ç‚¹çš„ Binlog éƒ½å®Œæˆå†™äººåï¼Œæ‰ä¼šæäº¤MasterèŠ‚ç‚¹çš„äº‹åŠ¡ã€‚ï¼ˆè¿™ä¸ªåœºæ™¯ä¸­Binlogæœ¬èº«å°±æ˜¯è¦åŒæ­¥çš„çŠ¶æ€æ•°æ®ï¼Œä¸åº”å°†å®ƒçœ‹ä½œæŒ‡ä»¤æ—¥å¿—çš„é›†åˆã€‚ç„¶è€Œè¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„ç¼ºé™·ï¼Œå°½ç®¡å¯ä»¥ç¡®ä¿ Master èŠ‚ç‚¹å’Œ Slave èŠ‚ç‚¹ä¸­çš„æ•°æ®æ˜¯ç»å¯¹ä¸€è‡´çš„ï¼Œä½†ä»»ä½•ä¸€ä¸ª Slave èŠ‚ç‚¹å› ä¸ºä»»ä½•åŸå› æœªå“åº”å‡ä¼šé˜»å¡æ•´ä¸ªäº‹åŠ¡ï¼Œæ¯å¢åŠ ä¸€ä¸ª Slave èŠ‚ç‚¹ï¼Œéƒ½ä¼šé€ æˆæ•´ä¸ªç³»ç»Ÿå¯ç”¨æ€§é£é™©å¢åŠ ä¸€åˆ†ã€‚\nä»¥åŒæ­¥ä¸ºä»£è¡¨çš„æ•°æ®å¤åˆ¶æ–¹æ³•ï¼Œè¢«ç§°ä¸ºçŠ¶æ€è½¬ç§»ï¼ˆState Transferï¼‰ï¼Œæ˜¯è¾ƒç¬¦åˆäººç±»æ€å‡†çš„å¯é æ€§ä¿éšœæ‰‹æ®µï¼Œä½†é€šå¸¸è¦ä»¥ç‰ºç‰²å¯ç”¨æ€§ä¸ºä»£ä»·ã€‚æˆ‘ä»¬åœ¨å»ºè®¾åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ—¶å€™ï¼Œå¾€å¾€ä¸èƒ½æ‰¿å—è¿™æ ·çš„ä»£ä»·ï¼Œä¸€äº›å…³é”®ç³»ç»Ÿï¼Œåœ¨å¿…é¡»ä¿éšœæ•°æ®æ­£ç¡®å¯é çš„å‰æä¸‹ï¼Œä¹Ÿå¯¹å¯ç”¨æ€§æœ‰éå¸¸é«˜çš„è¦æ±‚ï¼Œè­¬å¦‚ç³»ç»Ÿè¦ä¿è¯æ•°æ®è¾¾åˆ° 99.999999% å¯é ï¼ŒåŒæ—¶ç³»ç»Ÿè‡ªèº«ä¹Ÿè¦è¾¾åˆ° 99.999% å¯ç”¨çš„ç¨‹åº¦ã€‚è¿™å°±å¼•å‡ºäº†æˆ‘ä»¬çš„ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼š\n\nå¦‚æœä½ æœ‰ä¸€ä»½ä¼šéšæ—¶å˜åŠ¨çš„æ•°æ®ï¼Œè¦ç¡®ä¿å®ƒæ­£ç¡®åœ°å­˜å‚¨äºç½‘ç»œä¸­çš„å‡ å°ä¸åŒæœºå™¨ä¹‹ä¸Šï¼Œå¹¶ä¸”è¦å°½å¯èƒ½ä¿è¯æ•°æ®æ˜¯éšæ—¶å¯ç”¨çš„ï¼Œä½ ä¼šæ€ä¹ˆåš?\n\nå¯é æ€§ä¸å¯ç”¨æ€§çš„çŸ›ç›¾é€ æˆäº†å¢åŠ æœºå™¨æ•°é‡åè€Œå¸¦æ¥å¯ç”¨æ€§çš„é™ä½ã€‚ä¸ºç¼“è§£è¿™ä¸ªçŸ›ç›¾åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œä¸»æµçš„æ•°æ®å¤åˆ¶æ–¹æ³•æ˜¯ä»¥ æ“ä½œè½¬ç§»ï¼ˆOperation Transferï¼‰ä¸ºåŸºç¡€çš„ã€‚æˆ‘ä»¬æƒ³è¦æ”¹å˜æ•°æ®çš„çŠ¶æ€ï¼Œé™¤äº†ç›´æ¥å°†ç›®æ ‡çŠ¶æ€èµ‹äºˆå®ƒä¹‹å¤–ï¼Œè¿˜æœ‰å¦ä¸€ç§å¸¸ç”¨çš„æ–¹æ³•æ˜¯é€šè¿‡æŸç§æ“ä½œï¼Œä»¤æºçŠ¶æ€è½¬æ¢ä¸ºç›®æ ‡çŠ¶æ€ã€‚èƒ½å¤Ÿä½¿ç”¨ç¡®å®šçš„æ“ä½œä¿ƒä½¿çŠ¶æ€é—´äº§ç”Ÿç¡®å®šçš„è½¬ç§»ç»“æœçš„è®¡ç®—æ¨¡å‹ï¼Œåœ¨è®¡ç®—æœºç§‘å­¦ä¸­è¢«ç§°ä¸ºçŠ¶æ€æœºï¼ˆState Machineï¼‰ã€‚\n\nçŠ¶æ€æœºçš„ç‰¹æ€§\nçŠ¶æ€æœºæœ‰ä¸€ä¸ªç‰¹æ€§ï¼šä»»ä½•åˆå§‹çŠ¶æ€ä¸€æ ·çš„çŠ¶æ€æœºï¼Œå¦‚æœæ‰§è¡Œçš„å‘½ä»¤åºåˆ—ä¸€æ ·ï¼Œåˆ™æœ€ç»ˆè¾¾åˆ°çš„çŠ¶æ€ä¹Ÿä¸€æ ·ã€‚å¦‚æœå°†æ­¤ç‰¹æ€§åº”ç”¨åœ¨å¤šå‚ä¸è€…çš„åå•†å…±è¯†ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿä¸­å­˜åœ¨å¤šä¸ªå…·æœ‰å®Œå…¨ç›¸åŒçš„çŠ¶æ€æœºï¼ˆå‚ä¸è€…ï¼‰ï¼Œè¿™äº›çŠ¶æ€æœºèƒ½æœ€ç»ˆä¿æŒä¸€è‡´çš„å…³é”®å°±æ˜¯èµ·å§‹çŠ¶æ€å®Œå…¨ä¸€è‡´å’Œæ‰§è¡Œå‘½ä»¤åºåˆ—å®Œå…¨ä¸€è‡´ã€‚\n\næ ¹æ®çŠ¶æ€æœºçš„ç‰¹æ€§ï¼Œè¦è®©å¤šå°æœºå™¨çš„æœ€ç»ˆçŠ¶æ€ä¸€è‡´ï¼Œåªè¦ç¡®ä¿å®ƒä»¬çš„åˆå§‹çŠ¶æ€æ˜¯ä¸€è‡´çš„ã€‚å¹¶ä¸”æ¥æ”¶åˆ°çš„æ“ä½œæŒ‡ä»¤åºåˆ—ä¹Ÿæ˜¯ä¸€è‡´çš„å³å¯ï¼Œæ— è®ºè¿™ä¸ªæ“ä½œæŒ‡ä»¤æ˜¯æ–°å¢ã€ä¿®æ”¹ã€åˆ é™¤ä¸­æˆ–æ˜¯å…¶ä»–ä»»ä½•å¯èƒ½çš„ç¨‹åºè¡Œä¸ºï¼Œéƒ½å¯ä»¥ç†è§£ä¸ºè¦å°†ä¸€è¿ä¸²çš„æ“ä½œæ—¥å¿—æ­£ç¡®åœ°å¹¿æ’­ç»™å„ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ã€‚åœ¨å¹¿æ’­æŒ‡ä»¤ä¸æŒ‡ä»¤æ‰§è¡ŒæœŸé—´ï¼Œå…è®¸ç³»ç»Ÿå†…éƒ¨çŠ¶æ€å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå³å¹¶ä¸è¦æ±‚æ‰€æœ‰èŠ‚ç‚¹çš„æ¯ä¸€æ¡æŒ‡ä»¤éƒ½æ˜¯åŒæ—¶å¼€å§‹ã€åŒæ­¥å®Œæˆçš„ï¼Œåªè¦æ±‚åœ¨æ­¤æœŸé—´çš„å†…éƒ¨çŠ¶æ€ä¸èƒ½è¢«å¤–éƒ¨è§‚å¯Ÿåˆ°ï¼Œä¸”å½“æ“ä½œæŒ‡ä»¤åºåˆ—æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œæ‰€æœ‰èŠ‚ç‚¹çš„æœ€ç»ˆçŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œåˆ™è¿™ç§æ¨¡å‹å°±è¢«ç§°ä¸º çŠ¶æ€æœºå¤åˆ¶ ï¼ˆState Machine Replicationï¼‰ã€‚\nè€ƒè™‘åˆ°åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ç½‘ç»œåˆ†åŒºç°è±¡æ˜¯ä¸å¯èƒ½æ¶ˆé™¤çš„ï¼Œç”šè‡³å…è®¸ä¸å†è¿½æ±‚ç³»ç»Ÿå†…æ‰€æœ‰èŠ‚ç‚¹åœ¨ä»»ä½•æƒ…å†µä¸‹çš„æ•°æ®çŠ¶æ€éƒ½ä¸€è‡´ï¼Œè€Œæ˜¯é‡‡ç”¨â€œå°‘æ•°æœä»å¤šæ•°â€çš„åŸåˆ™ï¼Œä¸€æ—¦ç³»ç»Ÿä¸­è¿‡åŠæ•°çš„èŠ‚ç‚¹å®Œæˆäº†çŠ¶æ€çš„è½¬æ¢ï¼Œå°±è®¤ä¸ºæ•°æ®çš„å˜åŒ–å·²ç»è¢«æ­£ç¡®åœ°å­˜å‚¨åœ¨äº†ç³»ç»Ÿä¸­ï¼Œè¿™æ ·å°±å¯ä»¥å®¹å¿å°‘æ•°ï¼ˆé€šå¸¸æ˜¯ä¸è¶…è¿‡åŠæ•°ï¼‰çš„èŠ‚ç‚¹å¤±è”ï¼Œå‡å¼±å¢åŠ æœºå™¨æ•°é‡å¯¹ç³»ç»Ÿæ•´ä½“å¯ç”¨æ€§çš„å½±å“ï¼Œè¿™ç§æ€æƒ³åœ¨åˆ†å¸ƒå¼ä¸­è¢«ç§°ä¸º â€œQuorum æœºåˆ¶â€ã€‚\næ ¹æ®ä¸Šè¿°è®¨è®ºï¼Œæˆ‘ä»¬éœ€è¦è®¾è®¡å‡ºä¸€ç§ç®—æ³•ï¼Œèƒ½å¤Ÿè®©åˆ†å¸ƒå¼ç³»ç»Ÿå†…éƒ¨æš‚æ—¶å®¹å¿ä¸åŒçš„çŠ¶æ€ï¼Œä½†æœ€ç»ˆä¿è¯å¤§å¤šæ•°èŠ‚ç‚¹çš„çŠ¶æ€è¾¾æˆä¸€è‡´ï¼›åŒæ—¶ï¼Œèƒ½å¤Ÿè®©åˆ†å¸ƒå¼ç³»ç»Ÿåœ¨å¤–éƒ¨çœ‹æ¥å§‹ç»ˆè¡¨ç°å‡ºæ•´ä½“ä¸€è‡´çš„ç»“æœã€‚è¿™ä¸ªè®©ç³»ç»Ÿå„èŠ‚ç‚¹ä¸å—å±€éƒ¨çš„ç½‘ç»œåˆ†åŒºã€æœºå™¨å´©æºƒã€æ‰§è¡Œæ€§èƒ½æˆ–è€…å…¶ä»–å› ç´ å½±å“ï¼Œéƒ½èƒ½æœ€ç»ˆè¡¨ç°å‡ºæ•´ä½“ä¸€è‡´çš„è¿‡ç¨‹ï¼Œå°±è¢«ç§°ä¸ºå„ä¸ªèŠ‚ç‚¹çš„ åå•†å…±è¯†ï¼ˆConsensusï¼‰ã€‚\næœ€åï¼Œç¬”è€…è¿˜è¦æé†’ä½ æ³¨æ„å…±è¯†ä¸ä¸€è‡´æ€§çš„åŒºåˆ«ï¼šä¸€è‡´æ€§æ˜¯æŒ‡æ•°æ®ä¸åŒå‰¯æœ¬ä¹‹é—´çš„å·®å¼‚ï¼Œè€Œå…±è¯†æ˜¯æŒ‡è¾¾æˆä¸€è‡´æ€§çš„æ–¹æ³•ä¸è¿‡ç¨‹ã€‚ç”±äºç¿»è¯‘çš„å…³ç³»ï¼Œå¾ˆå¤šä¸­æ–‡èµ„æ–™æŠŠConsensusåŒæ ·ç¿»è¯‘ä¸ºä¸€è‡´æ€§ï¼Œå¯¼è‡´ç½‘ç»œä¸Šå¤§é‡çš„â€œäºŒæ‰‹ä¸­æ–‡èµ„æ–™â€å°†è¿™ä¸¤ä¸ªæ¦‚å¿µæ··æ·†èµ·æ¥ï¼Œå¦‚æœä½ åœ¨ç½‘ä¸Šçœ‹åˆ°â€œåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•â€ï¼Œåº”æ˜ç™½å…¶æŒ‡çš„å…¶å®æ˜¯â€œDistributed Consensus Algorithmâ€ã€‚\nä¸€ã€Paxos\nä¸–ç•Œä¸Šåªæœ‰ä¸€ç§å…±è¯†åè®®ï¼Œå°±æ˜¯ Paxosï¼Œå…¶ä»–æ‰€æœ‰å…±è¯†ç®—æ³•éƒ½æ˜¯ Paxos çš„é€€åŒ–ç‰ˆæœ¬ã€‚                                                                            â€”â€”Mike Burrowsï¼ŒGoogle Chubby ä½œè€…\n\nPaxos æ˜¯ç”± Leslie Lamport ï¼ˆå°±æ˜¯å¤§åé¼é¼çš„LaTeXä¸­çš„ â€œLaâ€ ï¼‰æå‡ºçš„ä¸€ç§åŸºäºæ¶ˆæ¯ä¸“é€’çš„åå•†å…±è¯†ç®—æ³•ï¼Œæ˜¯å½“ä»Šåˆ†å¸ƒå¼ç³»ç»Ÿæœ€é‡è¦çš„ç†è®ºåŸºç¡€ï¼Œå‡ ä¹å°±æ˜¯â€œå…±è¯†â€äºŒå­—çš„ä»£åè¯ã€‚è¿™ä¸ªæé«˜çš„è¯„ä»·å‡ºè‡ªäºæå‡ºRaftç®—æ³•çš„è®ºæ–‡ï¼Œæ›´æ˜¾åˆ†é‡åè¶³ã€‚è™½ç„¶ç¬”è€…è®¤ä¸º Mike3urrows æ‰€è¨€æœ‰äº›å¤¸å¼ ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰ Paxosï¼Œé‚£åç»­çš„ Raftã€ZAB ç­‰ç®—æ³•ï¼ŒZooKeeperã€ etcd ç­‰åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ã€Hadoopã€Consul ç­‰åœ¨æ­¤åŸºç¡€ä¸Šçš„å„ç±»åˆ†å¸ƒå¼åº”ç”¨éƒ½å¾ˆå¯èƒ½ä¼šå»¶åå¥½å‡ å¹´é¢ä¸–ã€‚\n1. Paxos çš„è¯ç”Ÿä¸ºäº†è§£é‡Šæ¸…æ¥š Paxos ç®—æ³•ï¼ŒLamport è™šæ„äº†ä¸€ä¸ªåä¸º â€œPaxosâ€ çš„å¸Œè…ŠåŸé‚¦ï¼Œè¿™ä¸ªåŸé‚¦æŒ‰ç…§æ°‘ä¸»åˆ¶åº¦åˆ¶å®šæ³•å¾‹ï¼Œå´æ²¡æœ‰ä¸€ä¸ªä¸­å¿ƒåŒ–çš„ä¸“èŒç«‹æ³•æœºæ„ï¼Œè€Œæ˜¯é ç€ â€œå…¼èŒè®®ä¼šâ€ï¼ˆPart- Time Parliamentï¼‰æ¥å®Œæˆç«‹æ³•ï¼Œæ— æ³•ä¿è¯æ‰€æœ‰åŸé‚¦å±…æ°‘éƒ½èƒ½å¤ŸåŠæ—¶äº†è§£æ–°çš„æ³•å¾‹ææ¡ˆï¼Œä¹Ÿæ— æ³•ä¿è¯å±…æ°‘ä¼šåŠæ—¶ä¸ºææ¡ˆæŠ•ç¥¨ã€‚Paxos ç®—æ³•çš„ç›®æ ‡å°±æ˜¯è®©åŸé‚¦èƒ½å¤Ÿåœ¨æ¯ä¸€ä½å±…æ°‘éƒ½ä¸æ‰¿è¯ºä¸€å®šä¼šåŠæ—¶å‚ä¸çš„æƒ…å†µä¸‹ï¼Œä¾ç„¶å¯ä»¥æŒ‰ç…§å°‘æ•°æœä»å¤šæ•°çš„åŸåˆ™ï¼Œæœ€ç»ˆè¾¾æˆä¸€è‡´æ„è§ã€‚ä½†æ˜¯ Paxos ç®—æ³•å¹¶ä¸è€ƒè™‘æ‹œå åº­å°†å†›é—®é¢˜ï¼Œå³å‡è®¾ä¿¡æ¯å¯èƒ½ä¸¢å¤±ä¹Ÿå¯èƒ½å»¶è¿Ÿï¼Œä½†ä¸ä¼šè¢«é”™è¯¯ä¼ é€’ã€‚\nLamport åœ¨1990å¹´é¦–æ¬¡å‘è¡¨äº† Paxos ç®—æ³•ï¼Œé€‰çš„è®ºæ–‡é¢˜ç›®å°±æ˜¯ â€œThe Part-Time Parliamentâ€ ç”±äºç®—æ³•æœ¬èº«æä¸ºå¤æ‚ï¼Œç”¨å¸Œè…ŠåŸé‚¦ä½œä¸ºæ¯”å–»åè€Œä½¿å¾—æè¿°æ›´æ™¦æ¶©ï¼Œè®ºæ–‡çš„ä¸‰ä¸ªå®¡ç¨¿äººä¸€è‡´è¦æ±‚ä»–æŠŠå¸Œè…ŠåŸé‚¦çš„æ•…äº‹åˆ æ‰ã€‚è¿™ä»¤Lamportæ„Ÿè§‰é¢‡ä¸ºä¸çˆ½ï¼Œå¹²è„†å°±æ’¤ç¨¿ä¸å‘äº†ï¼Œæ‰€ä»¥ Paxosåˆšåˆšè¢«æå‡ºçš„æ—¶å€™å¹¶æ²¡æœ‰å¼•èµ·ä»€ä¹ˆåå“ã€‚å…«å¹´ä¹‹åï¼ˆ1998å¹´ï¼‰ï¼ŒLamport å°†æ­¤æ–‡ç« é‡æ•´ç†åæŠ•åˆ° ACM Transactions on Computer Systemsã€‚è¿™æ¬¡è®ºæ–‡æˆåŠŸå‘è¡¨ï¼ŒLamportçš„åä¹Ÿç¡®å®å¸å¼•äº†ä¸€äº›äººå»ç ”ç©¶ï¼Œä½†å¹¶æ²¡æœ‰å¤šå°‘äººèƒ½å¼„æ‡‚ä»–åœ¨è¯´ä»€ä¹ˆã€‚æ—¶é—´åˆè¿‡å»äº†ä¸‰å¹´ï¼ˆ200å¹´ï¼‰ï¼ŒLamportè®¤ä¸ºå‰ä¸¤æ¬¡çš„è®ºæ–‡æ²¡æœ‰å¼•èµ·åå“ï¼Œæ˜¯å› ä¸ºåŒè¡Œä»¬æ— æ³•ç†è§£ä»–ä»¥â€œå¸Œè…ŠåŸé‚¦â€æ¥è®²æ•…äº‹çš„å¹½é»˜æ„Ÿï¼Œæ‰€ä»¥è¿™ä¸€æ¬¡ä»–ä»¥â€œPaxos Made Simpleâ€ä¸ºé¢˜ï¼Œåœ¨SIGACT News æ‚å¿—ä¸Šè¡¨æ–‡ç« ï¼Œæ”¾å¼ƒäº†â€œå¸Œè…ŠåŸé‚¦â€çš„æ¯”å–»ï¼Œå°½å¯èƒ½ç”¨ï¼ˆä»–è®¤ä¸ºï¼‰ç®€å•ç›´æ¥ã€ï¼ˆä»–è®¤ä¸ºï¼‰å¯è¯»æ€§è¾ƒå¼ºçš„æ–¹å¼å»ä»‹ç»Paxosç®—æ³•ã€‚æƒ…å†µè™½ç„¶æ¯”å‰ä¸¤æ¬¡è¦å¥½ä¸Šä¸€äº›ï¼Œä½†ä»¥Paxosæœ¬åº”è·å¾—çš„é‡è§†ç¨‹æ¥è¯´ï¼Œè¿™æ¬¡ä¾ç„¶åªèƒ½ç®—æ˜¯åº”è€…å¯¥å¯¥ã€‚è¿™ä¸€æ®µå¬èµ·æ¥å¦‚åŒç½‘ç»œæ®µå­ä¸€èˆ¬çš„ç»å†è¢«Lamport ä»¥è‡ªå˜²çš„å½¢å¼æ”¾åˆ°äº†ä»–çš„ä¸ªäººç½‘ç«™ä¸Šã€‚å°½ç®¡æˆ‘ä»¬ä½œä¸ºåè¾ˆåº”è¯¥å°Šé‡Lamportè€çˆ·å­ï¼Œä½†å½“ç¬”ç¿»å¼€â€œPaxos Made Simpleâ€çš„è®ºæ–‡ï¼Œè§åˆ°åªæœ‰â€œThe Paxos algorithm, when presented in plain English, is very simple.â€è¿™ä¸€å¥è¯çš„â€œæ‘˜è¦â€æ—¶ï¼Œå¿ƒé‡Œå®åœ¨æ˜¯ä¸å¾—ä¸æ€€ç–‘Lamport è¿™æ ·å†™è®ºæ–‡æ˜¯ä¸æ˜¯åœ¨æ¶æå®¡ç¨¿äººå’Œè¯»è€…ï¼Œåœ¨å˜²è®½â€œä½ ä»¬è¿™äº›æ„šè ¢çš„äººç±»â€ã€‚\nè™½ç„¶Lamportæœ¬äººè¿å‘ä¸‰ç¯‡æ–‡ç« éƒ½æ²¡èƒ½è®©å¤§å¤šæ•°åŒè¡Œç†è§£Paxosï¼Œä½†2006å¹´ï¼Œåœ¨ Googleçš„Chubbyã€Megastoreä»¥åŠSpannerç­‰åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½ä½¿ç”¨Paxos è§£å†³äº†åˆ†å¸ƒå¼å…±è¯†çš„é—®é¢˜ï¼Œå¹¶å°†å…¶æ•´ç†æˆæ­£å¼çš„è®ºæ–‡å‘è¡¨ä¹‹åï¼Œå¾—ç›ŠäºGoogleçš„è¡Œä¸šå½±å“åŠ›ï¼Œè¾…ä»¥Chubbyä½œè€…Mike Burrowsé‚£ç•¥æ˜¾å¤¸å¼ ä½†è¶³å¤Ÿå¸å¼•çœ¼çƒçš„è¯„ä»·æ¨æ³¢åŠ©æ¾œï¼ŒPaxosç®—æ³•ä¸€å¤œé—´æˆä¸ºè®¡ç®—æœºç§‘å­¦åˆ†å¸ƒå¼è¿™æ¡åˆ†æ”¯ä¸­æœ€ç‚™æ‰‹å¯çƒ­çš„æ¦‚å¿µï¼Œå¼€å§‹è¢«å­¦æœ¯ç•Œä¼—äººäº‰ç›¸ç ”ç©¶ã€‚Lamport æœ¬äººå› å…¶å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ°å‡ºç†è®ºè´¡çŒ®è·å¾—äº†2013å¹´çš„å›¾çµå¥–ï¼Œéšåæ‰æœ‰äº† Paxos åœ¨åŒºå—é“¾ã€åˆ†å¸ƒå¼ç³»ç»Ÿã€äº‘è®¡ç®—ç­‰å¤šä¸ªé¢†åŸŸå¤§æ”¾å¼‚å½©çš„æ•…äº‹ã€‚\n2. ç®—æ³•æµç¨‹ä¸‹é¢ï¼Œæˆ‘ä»¬æ¥æ­£å¼å­¦ä¹  Paxos ç®—æ³•ï¼ˆåœ¨æœ¬èŠ‚ä¸­ Paxos å‡ç‰¹æŒ‡æœ€æ—©çš„ Basic Paxos ç®—æ³•ï¼‰ã€‚\nPaxos ç®—æ³•å°†åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç±»ã€‚\n\nææ¡ˆèŠ‚ç‚¹ï¼ˆProposerï¼‰ï¼šæå‡ºå¯¹æŸä¸ªå€¼è¿›è¡Œè®¾ç½®æ“ä½œçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å€¼è¿™ä¸ªè¡Œä¸ºå°±è¢«ç§°ä¸ºææ¡ˆï¼ˆProposalï¼‰ï¼Œå€¼ä¸€æ—¦è®¾ç½®æˆåŠŸï¼Œå°±æ˜¯ä¸ä¼šä¸¢å¤±ä¹Ÿä¸å¯å˜çš„ã€‚æ³¨æ„ï¼ŒPaxosæ˜¯å…¸å‹çš„åŸºäºæ“ä½œè½¬ç§»æ¨¡å‹è€ŒéçŠ¶æ€è½¬ç§»æ¨¡å‹æ¥è®¾è®¡çš„ç®—æ³•ï¼Œä¸è¦æŠŠè¿™é‡Œçš„â€œè®¾ç½®å€¼â€ç±»æ¯”æˆç¨‹åºä¸­å˜é‡èµ‹å€¼æ“ä½œã€‚è€Œåº”è¯¥ç±»æ¯”æˆæ—¥å¿—è®°å½•æ“ä½œï¼Œåœ¨åé¢ä»‹ç»çš„Raftç®—æ³•ä¸­å°±ç›´æ¥æŠŠâ€œææ¡ˆâ€å«ä½œâ€œæ—¥å¿—â€äº†ã€‚\nå†³ç­–èŠ‚ç‚¹ï¼ˆAcceptorï¼‰ï¼šæ˜¯åº”ç­”ææ¡ˆçš„èŠ‚ç‚¹ï¼Œå†³å®šè¯¥ææ¡ˆæ˜¯å¦å¯è¢«æŠ•ç¥¨ã€æ˜¯å¦å¯è¢«æ¥å—ã€‚ææ¡ˆä¸€æ—¦å¾—åˆ°è¿‡åŠæ•°å†³ç­–èŠ‚ç‚¹çš„æ¥å—ï¼Œå³ç§°è¯¥ææ¡ˆè¢«æ‰¹å‡†ï¼ˆAcceptï¼‰ã€‚ææ¡ˆè¢«æ‰¹å‡†å³æ„å‘³ç€è¯¥å€¼ä¸èƒ½è¢«æ›´æ”¹ï¼Œä¹Ÿä¸ä¼šä¸¢å¤±ï¼Œä¸”æœ€ç»ˆæ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ¥å—å®ƒã€‚\nè®°å½•èŠ‚ç‚¹ï¼ˆLearnerï¼‰ï¼šä¸å‚ä¸ææ¡ˆï¼Œä¹Ÿä¸å‚ä¸å†³ç­–ï¼Œåªæ˜¯å•çº¯åœ°ä»ææ¡ˆã€å†³ç­–èŠ‚ç‚¹ä¸­å­¦ä¹ å·²ç»è¾¾æˆå…±è¯†çš„ææ¡ˆï¼Œè­¬å¦‚å°‘æ•°æ´¾èŠ‚ç‚¹ä»ç½‘ç»œåˆ†åŒºä¸­æ¢å¤æ—¶ï¼Œå°†ä¼šè¿›å…¥è¿™ç§çŠ¶æ€ã€‚\n\nåœ¨ä½¿ç”¨Paxosç®—æ³•çš„åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æ˜¯å¹³ç­‰çš„ï¼Œå®ƒä»¬éƒ½å¯ä»¥æ‰¿æ‹…ä»¥ä¸ŠæŸä¸€ç§æˆ–è€…å¤šç§çš„è§’è‰²ã€‚ä¸è¿‡ä¸ºäº†ä¾¿äºç¡®ä¿æœ‰æ˜ç¡®çš„å¤šæ•°æ´¾ï¼Œå†³ç­–èŠ‚ç‚¹çš„æ•°é‡åº”è¯¥è¢«è®¾å®šä¸ºå¥‡æ•°ä¸ªï¼Œä¸”åœ¨ç³»ç»Ÿåˆå§‹åŒ–æ—¶ï¼Œç½‘ç»œä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½åº”è¯¥çŸ¥é“æ•´ä¸ªç½‘ç»œæ‰€æœ‰å†³ç­–èŠ‚ç‚¹çš„æ•°é‡åœ°å€ç­‰ä¿¡æ¯ã€‚\nåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå¦‚æœæˆ‘ä»¬è¯´å„ä¸ªèŠ‚ç‚¹ â€œå°±æŸä¸ªå€¼ï¼ˆææ¡ˆï¼‰è¾¾æˆä¸€è‡´â€ï¼ŒæŒ‡çš„æ˜¯ â€œä¸å­˜åœ¨æŸä¸ªæ—¶åˆ»æœ‰ä¸€ä¸ªå€¼ä¸ºAï¼Œå¦ä¸€ä¸ªæ—¶åˆ»åˆä¸ºBçš„æƒ…æ™¯â€ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„å¤æ‚åº¦ä¸»è¦æ¥æºäºä»¥ä¸‹ä¸¤ä¸ªæ–¹é¢å› ç´ çš„å…±åŒå½±å“ã€‚\n\nç³»ç»Ÿå†…éƒ¨å„ä¸ªèŠ‚ç‚¹é€šä¿¡æ˜¯ä¸å¯é çš„ï¼Œä¸è®ºæ˜¯å¯¹äºç³»ç»Ÿä¸­ä¼å›¾è®¾ç½®æ•°æ®çš„ææ¡ˆèŠ‚ç‚¹æŠ‘æˆ–æ˜¯å†³å®šæ˜¯å¦æ‰¹å‡†è®¾ç½®æ“ä½œçš„å†³ç­–èŠ‚ç‚¹ï¼Œå…¶å‘å‡ºã€æ”¶åˆ°çš„ä¿¡æ¯å¯èƒ½å»¶è¿Ÿé€è¾¾ã€å¯èƒ½ä¸¢å¤±ï¼Œä½†ä¸å»è€ƒè™‘æ¶ˆæ¯æœ‰ä¼ é€’é”™è¯¯çš„æƒ…å†µã€‚\nç³»ç»Ÿå¤–éƒ¨å„ä¸ªç”¨æˆ·è®¿é—®æ˜¯å¯å¹¶å‘çš„ï¼Œå¦‚æœç³»ç»Ÿåªä¼šæœ‰ä¸€ä¸ªç”¨æˆ·ï¼Œæˆ–è€…æ¯æ¬¡åªå¯¹ç³»ç»Ÿè¿›è¡Œä¸²è¡Œè®¿é—®ï¼Œé‚£å•çº¯åœ°åº”ç”¨ Quorum æœºåˆ¶ï¼Œå°‘æ•°èŠ‚ç‚¹æœä»å¤šæ•°èŠ‚ç‚¹ï¼Œå°±è¶³ä»¥ä¿è¯å€¼è¢«æ­£ç¡®åœ°è¯»å†™ã€‚\n\nç¬¬ä¸€ç‚¹æ˜¯ç½‘ç»œé€šä¿¡ä¸­å®¢è§‚å­˜åœ¨çš„ç°è±¡ï¼Œä¹Ÿæ˜¯æ‰€æœ‰å…±è¯†ç®—æ³•éƒ½è¦é‡ç‚¹è§£å†³çš„é—®é¢˜ã€‚å¯¹äºç¬¬äºŒç‚¹ï¼Œè¯¦ç»†è§£é‡Šå¦‚ä¸‹ã€‚ç°åœ¨æˆ‘ä»¬è®¨è®ºçš„æ˜¯ â€œåˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¹¶å‘æ“ä½œçš„å…±äº«æ•°æ®â€ çš„é—®é¢˜å³ä½¿å…ˆä¸è€ƒè™‘æ˜¯å¦åœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼Œåªè€ƒè™‘å¹¶å‘æ“ä½œï¼Œå‡è®¾æœ‰ä¸€ä¸ªå˜é‡ i å½“å‰åœ¨ç³»ç»Ÿä¸­å­˜å‚¨çš„æ•°å€¼ä¸º2ï¼ŒåŒæ—¶æœ‰å¤–éƒ¨è¯·æ±‚Aã€Båˆ†åˆ«å¯¹ç³»ç»Ÿå‘é€æ“ä½œæŒ‡ä»¤ï¼Œâ€œæŠŠ i çš„å€¼åŠ 1â€ å’Œ â€œæŠŠ i çš„å€¼ä¹˜3â€ï¼Œå¦‚æœä¸åŠ ä»»ä½•å¹¶å‘æ§åˆ¶ï¼Œå°†å¯èƒ½å¾—åˆ° â€œ(2+1)x3=9â€ ä¸ â€œ2x3+1=7â€ è¿™ä¸¤ç§å¯èƒ½çš„ç»“æœã€‚å› æ­¤ï¼Œå¯¹åŒä¸€ä¸ªå˜é‡çš„å¹¶å‘ä¿®æ”¹å¿…é¡»å…ˆåŠ é”åæ“ä½œï¼Œä¸èƒ½è®©Aã€Bçš„è¯·æ±‚è¢«äº¤æ›¿å¤„ç†ï¼Œè¿™ä¹Ÿå¯ä»¥è¯´æ˜¯ç¨‹åºè®¾è®¡çš„åŸºæœ¬å¸¸è¯†ã€‚è€Œåœ¨åˆ†å¸ƒå¼çš„ç¯å¢ƒä¸‹ï¼Œç”±äºè¦åŒæ—¶è€ƒè™‘åˆ°åˆ†å¸ƒå¼ç³»ç»Ÿå†…å¯èƒ½åœ¨ä»»ä½•æ—¶åˆ»å‡ºç°çš„é€šä¿¡æ•…éšœï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹åœ¨å–å¾—é”ä¹‹åã€åœ¨é‡Šæ”¾é”ä¹‹å‰å‘ç”Ÿå´©æºƒå¤±è”ï¼Œè¿™å°†å¯¼è‡´æ•´ä¸ªæ“ä½œè¢«æ— é™æœŸçš„ç­‰å¾…æ‰€é˜»å¡ï¼Œå› æ­¤ç®—æ³•ä¸­çš„åŠ é”å°±ä¸å®Œå…¨ç­‰åŒäºå¹¶å‘æ§åˆ¶ä¸­ä»¥äº’æ–¥é‡æ¥å®ç°çš„åŠ é”ï¼Œè¿˜å¿…é¡»æä¾›ä¸€ä¸ªå…¶ä»–èŠ‚ç‚¹èƒ½æŠ¢å é”çš„æœºåˆ¶ï¼Œä»¥é¿å…å› é€šä¿¡é—®é¢˜è€Œå‡ºç°æ­»é”ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„é”å¿…é¡»æ˜¯å¯æŠ¢å çš„ã€‚Paxosç®—æ³•åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼Œä¸€é˜¶æ®µâ€œå‡†å¤‡â€ï¼ˆPrepareï¼‰å°±ç›¸å½“äºä¸Šé¢æŠ¢å é”çš„è¿‡ç¨‹ã€‚å¦‚æœæŸä¸ªææ¡ˆèŠ‚ç‚¹å‡†å¤‡å‘èµ·ææ¡ˆã€‚å¿…é¡»å…ˆå‘æ‰€æœ‰çš„å†³ç­–èŠ‚ç‚¹å¹¿æ’­ä¸€ä¸ªè®¸å¯ç”³è¯·ï¼ˆç§°ä¸ºPrepare è¯·æ±‚ï¼‰ã€‚ææ¡ˆèŠ‚ç‚¹çš„ Prepare è¯·æ±‚ä¸­ä¼šé™„å¸¦ä¸€ä¸ªå…¨å±€å”¯ä¸€ä¸”å•è°ƒé€’å¢çš„æ•°å­—nä½œä¸ºææ¡ˆIDï¼Œå†³ç­–èŠ‚ç‚¹æ”¶åˆ°åï¼Œå°†ä¼šç»™äºˆææ¡ˆèŠ‚ç‚¹ä¸¤ä¸ªæ‰¿è¯ºä¸ä¸€ä¸ªåº”ç­”ã€‚\nä¸¤ä¸ªæ‰¿è¯ºæ˜¯æŒ‡ï¼š\n\næ‰¿è¯ºä¸ä¼šå†æ¥å—ææ¡ˆIDå°äºæˆ–ç­‰äº n çš„ Prepare è¯·æ±‚:\næ‰¿è¯ºä¸ä¼šå†æ¥å—ææ¡ˆIDå°äº n çš„ Accept è¯·æ±‚ã€‚\n\nä¸€ä¸ªåº”ç­”æ˜¯æŒ‡ï¼š\n\nåœ¨ä¸è¿èƒŒä»¥å‰çš„æ‰¿è¯ºçš„å‰æä¸‹ï¼Œå›å¤å·²ç»æ‰¹å‡†è¿‡çš„ææ¡ˆä¸­IDæœ€å¤§çš„é‚£ä¸ªææ¡ˆæ‰€å®šçš„å€¼å’Œææ¡ˆIDï¼Œå¦‚æœè¯¥å€¼ä»æ¥æ²¡æœ‰è¢«ä»»ä½•ææ¡ˆè®¾å®šè¿‡ï¼Œåˆ™è¿”å›ç©ºå€¼ã€‚å¦‚æœè¿åæ­¤å‰åšå‡ºçš„æ‰¿è¯ºï¼Œå³æ”¶åˆ°çš„ææ¡ˆIDå¹¶ä¸æ˜¯å†³ç­–èŠ‚ç‚¹æ”¶åˆ°çš„æœ€å¤§çš„IDï¼Œé‚£å…è®¸ç›´æ¥å¯¹æ­¤ Prepare è¯·æ±‚ä¸äºˆç†ä¼šã€‚\n\nå½“ææ¡ˆèŠ‚ç‚¹æ”¶åˆ°äº†å¤šæ•°æ´¾å†³ç­–èŠ‚ç‚¹çš„åº”ç­”ï¼ˆç§°ä¸º Promise åº”ç­”ï¼‰åï¼Œå°±å¯ä»¥å¼€å§‹ç¬¬äºŒé˜¶æ®µçš„â€œæ‰¹å‡†â€ï¼ˆ Accept ï¼‰è¿‡ç¨‹ï¼Œè¿™æ—¶æœ‰å¦‚ä¸‹ä¸¤ç§å¯èƒ½çš„ç»“æœ:\n\nå¦‚æœææ¡ˆèŠ‚ç‚¹å‘ç°æ‰€æœ‰å“åº”çš„å†³ç­–èŠ‚ç‚¹æ­¤å‰éƒ½æ²¡æœ‰æ‰¹å‡†è¿‡è¯¥å€¼ï¼ˆå³ä¸ºç©ºï¼‰ï¼Œé‚£è¯´æ˜å®ƒæ˜¯ç¬¬ä¸€ä¸ªè®¾ç½®å€¼çš„èŠ‚ç‚¹ï¼Œå¯ä»¥éšæ„åœ°å†³å®šè¦è®¾å®šçš„å€¼ï¼Œå°†è‡ªå·±é€‰å®šçš„å€¼ä¸ææ¡ˆIDç»„æˆä¸€ä¸ªäºŒå…ƒç»„â€œï¼ˆid, valueï¼‰â€ï¼Œå†æ¬¡å¹¿æ’­ç»™å…¨éƒ¨å†³ç­–èŠ‚ç‚¹ï¼ˆç§°ä¸º Accept è¯·æ±‚ï¼‰;\nå¦‚æœææ¡ˆèŠ‚ç‚¹å‘ç°å“åº”çš„å†³ç­–èŠ‚ç‚¹ä¸­å·²ç»æœ‰è‡³å°‘ä¸€ä¸ªèŠ‚ç‚¹çš„åº”ç­”ä¸­åŒ…å«å€¼äº†ï¼Œé‚£å®ƒå°±ä¸èƒ½å¤Ÿéšæ„å–å€¼ï¼Œè€Œæ˜¯å¿…é¡»æ— æ¡ä»¶åœ°ä»åº”ç­”ä¸­æ‰¾å‡ºææ¡ˆIDæœ€å¤§çš„é‚£ä¸ªå€¼å¹¶æ¥æ”¶ï¼Œç»„æˆä¸€ä¸ªäºŒå…ƒç»„â€œï¼ˆid, maxAcceptValueï¼‰â€ï¼Œå†æ¬¡å¹¿æ’­ç»™å…¨éƒ¨å†³ç­–èŠ‚ç‚¹ï¼ˆç§°ä¸º Accept è¯·æ±‚ï¼‰ã€‚\n\nå½“æ¯ä¸€ä¸ªå†³ç­–èŠ‚ç‚¹æ”¶åˆ° Accept è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåœ¨ä¸è¿èƒŒä»¥å‰çš„æ‰¿è¯ºçš„å‰æä¸‹ã€‚æ¥æ”¶å¹¶æŒä¹…åŒ–å½“å‰ææ¡ˆIDå’Œææ¡ˆé™„å¸¦çš„å€¼ã€‚å¦‚æœè¿åæ­¤å‰åšå‡ºçš„æ‰¿è¯ºï¼Œå³æ”¶åˆ°çš„ææ¡ˆIDå¹¶ä¸æ˜¯å†³ç­–èŠ‚ç‚¹æ”¶åˆ°è¿‡çš„æœ€å¤§çš„IDï¼Œé‚£å…è®¸ç›´æ¥å¯¹æ­¤Acceptè¯·æ±‚ä¸äºˆç†ä¼šã€‚\nå½“ææ¡ˆèŠ‚ç‚¹æ”¶åˆ°äº†å¤šæ•°æ´¾å†³ç­–èŠ‚ç‚¹çš„åº”ç­”ï¼ˆç§°ä¸º Accepted åº”ç­”ï¼‰åï¼Œåå•†ç»“æŸï¼Œå…±è¯†å†³è®®å½¢æˆï¼Œç„¶åå°†å½¢æˆçš„å†³è®®å‘é€ç»™æ‰€æœ‰è®°å½•èŠ‚ç‚¹è¿›è¡Œå­¦ä¹ ã€‚æ•´ä¸ªè¿‡ç¨‹çš„æ—¶åºå›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\næ•´ä¸ª Paxos ç®—æ³•çš„å·¥ä½œæµç¨‹è‡³æ­¤ç»“æŸï¼Œå¦‚æœä½ æ­¤å‰å¹¶æœªä¸“é—¨å­¦ä¹ è¿‡åˆ†å¸ƒå¼çš„çŸ¥è¯†ï¼Œå¯èƒ½è¿˜ä¸èƒ½å¯¹Paxosç®—æ³•ç©¶ç«Ÿæ˜¯å¦‚ä½•è§£å†³åå•†å…±è¯†çš„å½¢æˆå…·ä½“çš„æ¦‚å¿µã€‚ä¸‹é¢ç¬”è€…ä»¥ä¸€ä¸ªæ›´å…·ä½“ä¾‹å­æ¥è®²è§£ Paxosã€‚\n3. å·¥ä½œå®ä¾‹å‡è®¾ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿæœ‰äº”ä¸ªèŠ‚ç‚¹ï¼Œåˆ†åˆ«å‘½åä¸ºS1ã€S2ã€S3ã€S4ã€S5ï¼Œäº”ä¸ªèŠ‚ç‚¹éƒ½åŒæ—¶æ‰®æ¼”ç€ææ¡ˆèŠ‚ç‚¹å’Œå†³ç­–èŠ‚ç‚¹çš„è§’è‰²ã€‚è¿™ä¸ªä¾‹å­ä¸­åªè®¨è®ºæ­£å¸¸é€šä¿¡çš„åœºæ™¯ï¼Œä¸æ¶‰åŠç½‘ç»œåˆ†åŒºã€‚\næ­¤æ—¶ï¼Œæœ‰ä¸¤ä¸ªå¹¶å‘çš„è¯·æ±‚å¸Œæœ›å°†åŒä¸€ä¸ªå€¼åˆ†åˆ«è®¾å®šä¸º Xï¼ˆç”± S1 ä½œä¸ºææ¡ˆèŠ‚ç‚¹æå‡ºï¼‰å’Œ Y ï¼ˆç”± S5 ä½œä¸ºææ¡ˆèŠ‚ç‚¹æå‡ºï¼‰ï¼Œä»¥ P ä»£è¡¨å‡†å¤‡é˜¶æ®µï¼Œä»¥ A ä»£è¡¨æ‰¹å‡†é˜¶æ®µï¼Œè¿™æ—¶å¯èƒ½å‘ç”Ÿä»¥ä¸‹å‡ ç§æƒ…å†µã€‚\n\næƒ…å†µä¸€ï¼šè­¬å¦‚ï¼ŒS1 é€‰å®šçš„ææ¡ˆIDæ˜¯ 3.1 ï¼ˆå…¨å±€å”¯ä¸€IDåŠ ä¸ŠèŠ‚ç‚¹ç¼–å·ï¼‰ï¼Œå…ˆå–å¾—äº†å¤šæ•°æ´¾å†³ç­–èŠ‚ç‚¹çš„ Promise å’Œ Accepted åº”ç­”ï¼Œæ­¤æ—¶ S5 é€‰å®šææ¡ˆID 4.5ï¼Œå‘èµ· Prepare è¯·æ±‚ï¼Œæ”¶åˆ°çš„å¤šæ•°åº”ç­”ä¸­è‡³å°‘ä¼šåŒ…å« 1 ä¸ªæ­¤å‰åº”ç­”è¿‡ S1 çš„å†³ç­–èŠ‚ç‚¹ï¼Œå‡è®¾æ˜¯ S3ï¼Œé‚£ä¹ˆ S3 æä¾›çš„ Promise ä¸­å¿…å°†åŒ…å« S1 å·²è®¾å®šå¥½çš„å€¼ Xï¼ŒS5 å°±å¿…é¡»æ— æ¡ä»¶åœ°ç”¨ X ä»£æ›¿ Y ä½œä¸ºè‡ªå·±ææ¡ˆçš„å€¼ï¼Œç”±æ­¤æ•´ä¸ªç³»ç»Ÿå¯¹ â€œå–å€¼ä¸º Xâ€ è¿™ä¸ªäº‹å®è¾¾æˆä¸€è‡´ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\n\næƒ…å†µäºŒï¼šäº‹å®ä¸Šï¼Œå¯¹äºæƒ…å†µä¸€ï¼ŒX è¢«é€‰å®šä¸ºæœ€ç»ˆå€¼æ˜¯å¿…ç„¶ç»“æœï¼Œä½†ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒX è¢«é€‰å®šä¸ºæœ€ç»ˆå€¼å¹¶ä¸æ˜¯å¿…é¡»å¾—åˆ°å¤šæ•°æ´¾çš„å…±åŒæ‰¹å‡†ï¼Œè€Œæ˜¯åªå–å†³äº S5 ææ¡ˆæ—¶ Promise åº”ç­”ä¸­æ˜¯å¦å·²åŒ…å«äº†æ‰¹å‡†è¿‡ X çš„å†³ç­–èŠ‚ç‚¹ï¼Œè­¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒS5 å‘èµ·ææ¡ˆçš„ Prepare è¯·æ±‚æ—¶ï¼ŒX å¹¶æœªè·å¾—å¤šæ•°æ´¾æ‰¹å‡†ï¼Œä½†ç”±äº S3 å·²ç»æ‰¹å‡†ï¼Œæ‰€ä»¥æœ€ç»ˆå…±è¯†çš„ç»“æœä»æ˜¯ Xã€‚\n\n\n\n\næƒ…å†µä¸‰ï¼šå¦å¤–ä¸€ç§å¯èƒ½çš„ç»“æœæ˜¯ S5 ææ¡ˆæ—¶ Promise åº”ç­”ä¸­å¹¶æœªåŒ…å«æ‰¹å‡†è¿‡ X çš„å†³ç­–èŠ‚ç‚¹ï¼Œè­¬å¦‚åº”ç­” S5 ææ¡ˆæ—¶ï¼ŒèŠ‚ç‚¹ S1 å·²ç»æ‰¹å‡†äº† Xï¼ŒèŠ‚ç‚¹ S2ã€S3 æœªæ‰¹å‡†ä½†è¿”å›äº† Promise åº”ç­”ï¼Œæ­¤æ—¶ S5 ä»¥æ›´å¤§çš„ææ¡ˆ ID è·å¾—äº† S3ã€S4ã€S5 çš„ Promise åº”ç­”ï¼Œç”±äºè¿™ä¸‰ä¸ªèŠ‚ç‚¹å‡æœªæ‰¹å‡†è¿‡ä»»ä½•å€¼ï¼Œæ‰€ä»¥ S3 å°†ä¸å†æ¥æ”¶æ¥è‡ª S1 çš„ Accept è¯·æ±‚ï¼Œå› ä¸ºå®ƒçš„ææ¡ˆ ID å·²ç»ä¸æ˜¯æœ€å¤§çš„äº†ï¼Œè¿™ä¸‰ä¸ªèŠ‚ç‚¹å°†æ‰¹å‡† Y çš„å–å€¼ï¼Œæ•´ä¸ªç³»ç»Ÿæœ€ç»ˆä¼šå¯¹ â€œå–å€¼ä¸ºYâ€ è¾¾æˆä¸€è‡´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n\n\næƒ…å†µå››ï¼šä»æƒ…å†µä¸‰å¯ä»¥æ¨å¯¼å‡ºå¦ä¸€ç§æç«¯çš„æƒ…å†µï¼Œå¦‚æœä¸¤ä¸ªææ¡ˆèŠ‚ç‚¹äº¤æ›¿ä½¿ç”¨æ›´å¤§çš„ææ¡ˆ IDï¼Œä½¿å¾—å‡†å¤‡é˜¶æ®µæˆåŠŸã€æ‰¹å‡†é˜¶æ®µå¤±è´¥ï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹ç†è®ºä¸Šå¯ä»¥æ— é™æŒç»­ä¸‹å»ã€å½¢æˆæ´»é”ï¼ˆLive Lockï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚åœ¨ç®—æ³•å®ç°ä¸­ä¼šå¼•å…¥éšæœºè¶…æ—¶æ—¶é—´æ¥é¿å…æ´»é”çš„äº§ç”Ÿã€‚\n\n\nè™½ç„¶ Paxos æ˜¯ä»¥å¤æ‚è‘—ç§°çš„ç®—æ³•ï¼Œä½†ä»¥ä¸Šä»‹ç»éƒ½æ˜¯åŸºäº Basic Paxosã€ä»¥æ­£å¸¸æµç¨‹ï¼ˆæœªå‡ºç°ç½‘ç»œåˆ†åŒºç­‰å¼‚å¸¸ï¼‰ã€é€šä¿—æ–¹å¼è®²è§£çš„ Paxos ç®—æ³•ï¼Œå¹¶æœªæ¶‰åŠä¸¥è°¨çš„é€»è¾‘å’Œæ•°å­¦åŸç†ï¼Œä¹Ÿæœªè®¨è®º Paxos çš„æ¨å¯¼è¯æ˜è¿‡ç¨‹ï¼Œç†è§£èµ·æ¥åº”è¯¥ä¸ç®—å¤ªå›°éš¾ã€‚\nBasic Paxos çš„ä»·å€¼åœ¨äºå¼€æ‹“äº†åˆ†å¸ƒå¼å…±è¯†ç®—æ³•çš„å‘å±•æ€è·¯ï¼Œä½†ç”±äºå®ƒæœ‰å¦‚ä¸‹ç¼ºé™·ã€‚ä¸€èˆ¬ä¸ä¼šç›´æ¥ç”¨äºå®è·µï¼š\nBasic Paxos åªèƒ½å¯¹å•ä¸ªå€¼å½¢æˆå†³è®®ï¼Œå¹¶ä¸”å†³è®®çš„å½¢æˆè‡³å°‘éœ€è¦ä¸¤æ¬¡ç½‘ç»œè¯·æ±‚å’Œåº”ç­”ï¼ˆå‡†å¤‡å’Œæ‰¹å‡†é˜¶æ®µå„ä¸€æ¬¡ï¼‰ï¼Œé«˜å¹¶å‘æƒ…å†µä¸‹å°†äº§ç”Ÿè¾ƒå¤§çš„ç½‘ç»œå¼€é”€ï¼Œæç«¯æƒ…å†µä¸‹ç”šè‡³å¯èƒ½å½¢æˆæ´»é”ã€‚æ€»ä¹‹ï¼ŒBasic Paxos æ˜¯ä¸€ç§å¾ˆå­¦æœ¯åŒ–ä½†å¯¹å·¥ä¸šåŒ–å¹¶ä¸å‹å¥½çš„ç®—æ³•ç°åœ¨å‡ ä¹åªç”¨æ¥åšç†è®ºç ”ç©¶ï¼Œå®é™…çš„åº”ç”¨éƒ½æ˜¯åŸºäº Multi Paxos å’Œ Fast Paxos ç®—æ³•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ä¼šäº†è§£ Multi Paxos ä»¥åŠä¸€äº›ä¸å®ƒçš„ç†è®ºç­‰ä»·çš„ç®—æ³•ï¼ˆå¦‚ Raftã€ZAB ç­‰ç®—æ³•ï¼‰ã€‚\näºŒã€ Multi Paxosåœ¨ä¸Šä¸€èŠ‚çš„æœ€åï¼Œä¸¾ä¾‹ä»‹ç»äº† Basic Paxos çš„æ´»é”é—®é¢˜ï¼Œå³ä¸¤ä¸ªææ¡ˆèŠ‚ç‚¹äº‰ç›¸æå‡ºè‡ªå·±çš„ææ¡ˆï¼ŒæŠ¢å åŒä¸€ä¸ªå€¼çš„ä¿®æ”¹æƒé™ï¼Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿåœ¨æŒç»­æ€§åœ° â€œåå¤æ¨ªè·³â€ï¼Œå¤–éƒ¨çœ‹èµ·æ¥å°±åƒè¢«é”ä½äº†ä¸€æ ·ã€‚æ­¤å¤–ï¼Œç¬”è€…è¿˜è®²è¿°è¿‡ä¸€ä¸ªè§‚ç‚¹ï¼Œåˆ†å¸ƒå¼å…±è¯†çš„å¤æ‚æ€§ä¸»è¦æ¥æºäºç½‘ç»œçš„ä¸å¯é ä¸è¯·æ±‚çš„å¯å¹¶å‘ä¸¤å¤§å› ç´ ï¼Œæ´»é”é—®é¢˜ä¸è®¸å¤š Basic Paxos å¼‚å¸¸åœºæ™¯ä¸­æ‰€é­é‡çš„éº»çƒ¦ï¼Œéƒ½å¯ä»¥çœ‹ä½œæºäºä»»ä½•ä¸€ä¸ªææ¡ˆèŠ‚ç‚¹éƒ½èƒ½å¤Ÿå®Œå…¨å¹³ç­‰åœ°ã€ä¸å…¶ä»–èŠ‚ç‚¹å¹¶å‘åœ°æå‡ºææ¡ˆè€Œå¸¦æ¥çš„å¤æ‚é—®é¢˜ã€‚ä¸ºæ­¤ï¼ŒLamport æå‡ºäº†ä¸€ç§ Paxos çš„æ”¹è¿›ç‰ˆæœ¬â€”â€” Multi Paxos ç®—æ³•ï¼Œæœ›èƒ½å¤Ÿæ‰¾åˆ°ä¸€ç§ä¸¤å…¨å…¶ç¾çš„åŠæ³•ï¼Œæ—¢ä¸ç ´å Paxos ä¸­ â€œä¼—èŠ‚ç‚¹å¹³ç­‰â€ çš„åŸåˆ™ï¼Œåˆèƒ½åœ¨æèŠ‚ç‚¹ä¸­å®ç°ä¸»æ¬¡ä¹‹åˆ†ï¼Œé™åˆ¶æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸å—æ§çš„ææ¡ˆæƒåˆ©ã€‚è¿™ä¸¤ä¸ªç›®æ ‡å¬èµ·æ¥ä¼¼ä¹æ˜¯çŸ›ç›¾çš„ï¼Œä½†ç°å®ä¸–ç•Œä¸­çš„é€‰ä¸¾å°±å¾ˆç¬¦åˆè¿™ç§åœ¨å¹³ç­‰èŠ‚ç‚¹ä¸­æŒ‘é€‰æ„è§é¢†è¢–çš„æƒ…æ™¯ã€‚\nMulti Paxos å¯¹ Basic Paxos çš„æ ¸å¿ƒæ”¹è¿›æ˜¯å¢åŠ äº†â€œé€‰ä¸»â€çš„è¿‡ç¨‹ï¼Œææ¡ˆèŠ‚ç‚¹ä¼šé€šè¿‡å®šæ—¶è½®è¯¢ï¼ˆå¿ƒè·³ï¼‰ï¼Œç¡®å®šå½“å‰ç½‘ç»œä¸­çš„æ‰€æœ‰èŠ‚ç‚¹é‡Œæ˜¯å¦å­˜åœ¨ä¸€ä¸ªä¸»ææ¡ˆèŠ‚ç‚¹ï¼Œä¸€æ—¦æ²¡æœ‰å‘ç°ä¸»èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹å°±ä¼šåœ¨å¿ƒè·³è¶…æ—¶åä½¿ç”¨ Basic Paxos ä¸­å®šä¹‰çš„å‡†å¤‡ã€æ‰¹å‡†çš„ä¸¤è½®ç½‘ç»œäº¤äº’è¿‡ç¨‹ï¼Œå‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹å¹¿æ’­è‡ªå·±å¸Œæœ›ç«é€‰ä¸»èŠ‚ç‚¹çš„è¯·æ±‚ï¼Œå¸Œæœ›æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹ â€œç”±æˆ‘ä½œä¸ºä¸»èŠ‚ç‚¹â€œ è¿™ä»¶äº‹æƒ…åå•†è¾¾æˆä¸€è‡´å…±è¯†ï¼Œå¦‚æœå¾—åˆ°äº†å†³ç­–èŠ‚ç‚¹ä¸­å¤šæ•°æ´¾çš„æ‰¹å‡†ï¼Œä¾¿å®£å‘Šç«é€‰æˆåŠŸã€‚é€‰ä¸»å®Œæˆä¹‹åï¼Œé™¤éä¸»èŠ‚ç‚¹å¤±è”ä¹‹åå‘èµ·é‡æ–°ç«é€‰ï¼Œå¦åˆ™ä»æ­¤å¾€åï¼Œå°±åªæœ‰ä¸»èŠ‚ç‚¹æœ¬èº«æ‰èƒ½å¤Ÿæå‡ºææ¡ˆã€‚æ­¤æ—¶ï¼Œæ— è®ºå“ªä¸ªææ¡ˆèŠ‚ç‚¹æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„æ“ä½œè¯·æ±‚ï¼Œéƒ½ä¼šå°†è¯·æ±‚è½¬å‘ç»™ä¸»èŠ‚ç‚¹æ¥å®Œæˆææ¡ˆï¼Œè€Œä¸»èŠ‚ç‚¹ææ¡ˆæ—¶ï¼Œå°±æ— é¡»å†æ¬¡ç»è¿‡å‡†å¤‡è¿‡ç¨‹ï¼Œå› ä¸ºå¯ä»¥è®¤ä¸ºåœ¨ç»è¿‡é€‰ä¸¾æ—¶çš„é‚£ä¸€æ¬¡å‡†å¤‡ä¹‹åï¼Œåç»­çš„ææ¡ˆéƒ½æ˜¯å¯¹ç›¸åŒææ¡ˆIDçš„ä¸€è¿ä¸²çš„æ‰¹å‡†è¿‡ç¨‹ã€‚ä¹Ÿå¯ä»¥é€šä¿—ç†è§£ä¸ºé€‰ä¸»è¿‡åï¼Œå°±ä¸ä¼šå†æœ‰å…¶ä»–èŠ‚ç‚¹ä¸å®ƒç«äº‰ï¼Œç›¸å½“äºå¤„äºæ— å¹¶å‘çš„ç¯å¢ƒå½“ä¸­çš„æœ‰åºæ“ä½œï¼Œæ‰€ä»¥æ­¤æ—¶ç³»ç»Ÿä¸­è¦å¯¹æŸä¸ªå€¼è¾¾æˆä¸€è‡´ï¼Œåªéœ€è¦è¿›è¡Œä¸€æ¬¡æ‰¹å‡†çš„äº¤äº’å³å¯ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚\n\nå¯èƒ½æœ‰äººæ³¨æ„åˆ°è¿™æ—¶å€™çš„äºŒå…ƒç»„ï¼ˆid, valueï¼‰å·²ç»å˜æˆäº†ä¸‰å…ƒç»„ï¼ˆid, i, valueï¼‰ï¼Œè¿™æ˜¯å› ä¸ºéœ€è¦ç»™ä¸»èŠ‚ç‚¹å¢åŠ ä¸€ä¸ª â€œä»»æœŸç¼–å·â€ï¼Œè¿™ä¸ªç¼–å·å¿…é¡»æ˜¯ä¸¥æ ¼å•è°ƒé€’å¢çš„ï¼Œä»¥åº”ä»˜ä¸»èŠ‚ç‚¹é™·äººç½‘ç»œåˆ†åŒºåé‡æ–°æ¢å¤ï¼Œä½†å¦å¤–ä¸€éƒ¨åˆ†èŠ‚ç‚¹ä»ç„¶æœ‰å¤šæ•°æ´¾ï¼Œä¸”å·²ç»å®Œæˆäº†é‡æ–°é€‰ä¸»çš„æƒ…å†µï¼Œæ­¤æ—¶å¿…é¡»ä»¥ä»»æœŸç¼–å·å¤§çš„ä¸»èŠ‚ç‚¹ä¸ºå‡†ã€‚èŠ‚ç‚¹æœ‰äº†é€‰ä¸»æœºåˆ¶çš„æ”¯æŒåï¼Œåœ¨æ•´ä½“æ¥çœ‹ï¼Œå°±å¯ä»¥è¿›ä¸€æ­¥ç®€åŒ–èŠ‚ç‚¹è§’è‰²ï¼Œä¸å»åŒºåˆ†ææ¡ˆã€å†³ç­–å’Œè®°å½•èŠ‚ç‚¹ï¼Œè€Œæ˜¯ç»Ÿç»Ÿä»¥ â€œèŠ‚ç‚¹â€ æ¥ä»£æ›¿ï¼ŒèŠ‚ç‚¹åªæœ‰ä¸»ï¼ˆLeaderï¼‰å’Œä»ï¼ˆFollowerï¼‰çš„åŒºåˆ«ï¼Œæ­¤æ—¶åå•†å…±è¯†çš„æ—¶åºå›¾å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nä¸‹é¢æˆ‘ä»¬æ¢ä¸€ä¸ªè§’åº¦æ¥é‡æ–°æ€è€ƒ â€œåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¦‚ä½•å¯¹æŸä¸ªå€¼è¾¾æˆä¸€è‡´â€ è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥æŠŠè¯¥é—®é¢˜åˆ’åˆ†ä¸ºä¸‰ä¸ªå­é—®é¢˜æ¥è€ƒè™‘ï¼Œå¯ä»¥è¯æ˜ï¼ˆå…·ä½“è¯æ˜å°±ä¸åˆ—åœ¨è¿™é‡Œäº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯å‚è€ƒ Raft çš„è®ºæ–‡ï¼‰å½“ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜åŒæ—¶è¢«è§£å†³æ—¶ï¼Œå³ç­‰ä»·äºè¾¾æˆå…±è¯†:\n\nå¦‚ä½•é€‰ä¸»ï¼ˆLeader Electionï¼‰\nå¦‚ä½•æŠŠæ•°æ®å¤åˆ¶åˆ°å„ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆEntityReplicationï¼‰\nå¦‚ä½•ä¿è¯è¿‡ç¨‹æ˜¯å®‰å…¨çš„ï¼ˆSafetyï¼‰\n\nå°½ç®¡é€‰ä¸»é—®é¢˜è¿˜æ¶‰åŠè®¸å¤šå·¥ç¨‹ä¸Šçš„ç»†èŠ‚ï¼Œè­¬å¦‚å¿ƒè·³ã€éšæœºè¶…æ—¶ã€å¹¶è¡Œç«é€‰ç­‰ï¼Œä½†åªè®ºåŸç†çš„è¯ï¼Œå¦‚æœä½ å·²ç»ç†è§£äº†Paxosç®—æ³•çš„æ“ä½œæ­¥éª¤ï¼Œç›¸ä¿¡å¯¹é€‰ä¸»å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆç–‘æƒ‘ï¼Œå› ä¸ºè¿™æœ¬è´¨ä¸Šä»…ä»…æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿå¯¹ â€œè°æ¥å½“ä¸»èŠ‚ç‚¹â€ è¿™ä»¶äº‹æƒ…è¾¾æˆçš„å…±è¯†è€Œå·²ï¼Œæˆ‘ä»¬åœ¨å‰ä¸€èŠ‚å·²ç»è®²è¿°äº†åˆ†å¸ƒå¼ç³»ç»Ÿè¯¥å¦‚ä½•å¯¹ä¸€ä»¶äº‹æƒ…è¾¾æˆå…±è¯†ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ï¼Œä¸‹é¢ç›´æ¥æ¥è§£å†³æ•°æ®ï¼ˆPaxos ä¸­çš„ææ¡ˆã€Raftä¸­çš„æ—¥å¿—ï¼‰åœ¨ç½‘ç»œå„èŠ‚ç‚¹é—´çš„å¤åˆ¶é—®é¢˜ã€‚\nåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å‘ä¸»èŠ‚ç‚¹å‘èµ·ä¸€ä¸ªæ“ä½œè¯·æ±‚ï¼Œè­¬å¦‚æå‡º â€œå°†æŸä¸ªå€¼è®¾ç½®ä¸ºXâ€ ã€‚æ­¤æ—¶ä¸»èŠ‚ç‚¹å°† X å†™å…¥è‡ªå·±çš„å˜æ›´æ—¥å¿—ï¼Œä½†å…ˆä¸æäº¤ï¼Œæ¥ç€åœ¨ä¸‹ä¸€æ¬¡å¿ƒè·³åŒ…ä¸­æŠŠå˜æ›´ X çš„ä¿¡æ¯å¹¿æ’­ç»™æ‰€æœ‰çš„ä»èŠ‚ç‚¹ï¼Œå¹¶è¦æ±‚ä»èŠ‚ç‚¹å›å¤ â€œç¡®è®¤æ”¶åˆ°â€ çš„æ¶ˆæ¯ï¼Œä»èŠ‚ç‚¹æ”¶åˆ°ä¿¡æ¯åï¼Œå°†æ“ä½œå†™å…¥è‡ªå·±çš„å˜æ›´æ—¥å¿—ï¼Œç„¶åå‘ä¸»èŠ‚ç‚¹å‘é€ â€œç¡®è®¤ç­¾æ”¶â€ çš„æ¶ˆæ¯ï¼Œä¸»èŠ‚ç‚¹æ”¶åˆ°è¿‡åŠæ•°çš„ç­¾æ”¶æ¶ˆæ¯åï¼Œæäº¤è‡ªå·±çš„å˜æ›´ã€åº”ç­”å®¢æˆ·ç«¯å¹¶ä¸”ç»™ä»èŠ‚ç‚¹å¹¿æ’­å¯ä»¥æäº¤çš„æ¶ˆæ¯ï¼Œä»èŠ‚ç‚¹æ”¶åˆ°æäº¤æ¶ˆæ¯åæäº¤è‡ªå·±çš„å˜æ›´ï¼Œè‡³æ­¤ï¼Œæ•°æ®åœ¨èŠ‚ç‚¹é—´çš„å¤åˆ¶å®£å‘Šå®Œæˆã€‚\nåœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œç½‘ç»œå‡ºç°äº†åˆ†åŒºï¼Œéƒ¨åˆ†èŠ‚ç‚¹å¤±è”ï¼Œä½†åªè¦ä»èƒ½æ­£å¸¸å·¥ä½œçš„èŠ‚ç‚¹çš„æ•°é‡èƒ½å¤Ÿæ»¡è¶³å¤šæ•°æ´¾ï¼ˆè¿‡åŠæ•°ï¼‰çš„è¦æ±‚ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿå°±å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œè¿™æ—¶çš„æ•°æ®å¤åˆ¶è¿‡ç¨‹å¦‚ä¸‹ã€‚\n\nå‡è®¾æœ‰S1ã€S2ã€S3ã€S4ã€S5 äº”ä¸ªèŠ‚ç‚¹ï¼Œs1 æ˜¯ä¸»èŠ‚ç‚¹ï¼Œç”±äºç½‘ç»œæ•…éšœï¼Œå¯¼è‡´S1ã€s2 å’Œ S3ã€S4ã€s5 ä¹‹é—´å½¼æ­¤æ— æ³•é€šä¿¡ï¼Œå½¢æˆç½‘ç»œåˆ†åŒºã€‚\n\nä¸€æ®µæ—¶é—´åï¼ŒS3ã€S4ã€s5 ä¸‰ä¸ªèŠ‚ç‚¹ä¸­çš„æŸä¸€ä¸ªï¼ˆè­¬å¦‚æ˜¯S3ï¼‰æœ€å…ˆè¾¾åˆ°å¿ƒè·³è¶…æ—¶çš„é˜™å€¼ï¼Œè·çŸ¥å½“å‰åˆ†åŒºä¸­å·²ç»ä¸å­˜åœ¨ä¸»èŠ‚ç‚¹ï¼Œåˆ™å®ƒå‘æ‰€æœ‰èŠ‚ç‚¹å‘å‡ºè‡ªå·±è¦ç«é€‰çš„å¹¿æ’­ï¼Œå¹¶æ”¶åˆ°äº†S4ã€S5 èŠ‚ç‚¹çš„æ‰¹å‡†å“åº”ï¼ŒåŠ ä¸Šè‡ªå·±ä¸€å…±ä¸‰ç¥¨ï¼Œå³å¾—åˆ°äº†å¤šæ•°æ´¾çš„æ‰¹å‡†ï¼Œç«é€‰æˆåŠŸï¼Œæ­¤æ—¶ç³»ç»Ÿä¸­ä¼šåŒæ—¶å­˜åœ¨ S1 å’Œ S3 ä¸¤ä¸ªä¸»èŠ‚ç‚¹ï¼Œä½†ç”±äºç½‘ç»œåˆ†åŒºï¼Œå®ƒä»¬ä¸ä¼šçŸ¥é“å¯¹æ–¹çš„å­˜åœ¨ã€‚\n\nè¿™ç§æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å‘èµ·æ“ä½œè¯·æ±‚ã€‚\n\nå¦‚æœå®¢æˆ·ç«¯è¿æ¥åˆ°äº† S1ã€S2 å…¶ä¸­ä¹‹ä¸€ï¼Œéƒ½å°†ç”± S1 å¤„ç†ã€‚ä½†ç”±äºæ“ä½œåªèƒ½è·å¾—æœ€å¤šä¸¤ä¸ªèŠ‚ç‚¹çš„å“åº”ï¼Œä¸æ„æˆå¤šæ•°æ´¾çš„æ‰¹å‡†ï¼Œæ‰€ä»¥ä»»ä½•å˜æ›´éƒ½æ— æ³•æˆåŠŸæäº¤ã€‚\n\nå¦‚æœå®¢æˆ·ç«¯è¿æ¥åˆ°äº† S3ã€S4ã€s5 å…¶ä¸­ä¹‹ä¸€ï¼Œéƒ½å°†ç”± S3 å¤„ç†ï¼Œæ­¤æ—¶æ“ä½œå¯ä»¥è·å¾—æœ€å¤šä¸‰ä¸ªèŠ‚ç‚¹çš„å“åº”ã€æ„æˆå¤šæ•°æ´¾çš„æ‰¹å‡†ï¼Œæ˜¯æœ‰æ•ˆçš„ï¼Œå˜æ›´å¯ä»¥è¢«æäº¤ï¼Œå³ç³»ç»Ÿå¯ä»¥ç»§ç»­æä¾›æœåŠ¡ã€‚\n\näº‹å®ä¸Šï¼Œä»¥ä¸Šä¸¤ç§æƒ…æ™¯å¾ˆå°‘èƒ½å¤Ÿå¹¶å­˜ã€‚ç½‘ç»œåˆ†åŒºæ˜¯ç”±äºè½¯ã€ç¡¬ä»¶æˆ–è€…ç½‘ç»œæ•…éšœé¢å¯¼è‡´çš„ã€å†…éƒ¨ç½‘ç»œå‡ºç°äº†åˆ†åŒºï¼Œä½†ä¸¤ä¸ªåˆ†åŒºä»ç„¶èƒ½åˆ†åˆ«ä¸å¤–éƒ¨ç½‘ç»œçš„å®¢æˆ·ç«¯æ­£å¸¸é€šä¿¡çš„æƒ…å†µç”šä¸ºå°‘è§ã€‚æ›´å¤šçš„åœºæ™¯æ˜¯ç®—æ³•èƒ½å®¹å¿ç½‘ç»œé‡Œä¸‹çº¿äº†ä¸€éƒ¨åˆ†èŠ‚ç‚¹ï¼ŒæŒ‰ç…§è¿™ä¸ªä¾‹å­æ¥è¯´ï¼Œå¦‚æœä¸‹çº¿äº†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œç³»ç»Ÿä»èƒ½æ­£å¸¸å·¥ä½œï¼Œå¦‚æœä¸‹çº¿äº†ä¸‰ä¸ªèŠ‚ç‚¹ï¼Œé‚£å‰©ä½™çš„ä¸¤ä¸ªèŠ‚ç‚¹å°±ä¸å¯èƒ½ç»§ç»­æä¾›æœåŠ¡äº†ã€‚\n\n\n\nå‡è®¾ç°åœ¨éšœå¤ï¼Œåˆ†åŒºè§£é™¤ï¼Œäº”ä¸ªèŠ‚ç‚¹å¯ä»¥é‡æ–°é€šä¿¡ï¼š\n\nS1 å’Œ S3 éƒ½å‘æ‰€æœ‰èŠ‚ç‚¹å‘é€å¿ƒè·³åŒ…ï¼Œä»å„è‡ªçš„å¿ƒè·³ä¸­å¯ä»¥å¾—çŸ¥ä¸¤ä¸ªä¸»èŠ‚ç‚¹é‡Œ S3 çš„ä»»æœŸç¼–å·æ›´å¤§ï¼Œå®ƒæ˜¯æœ€æ–°çš„ï¼Œæ­¤æ—¶äº”ä¸ªèŠ‚ç‚¹å‡åªæ‰¿è®¤ S3 æ˜¯å”¯ä¸€çš„ä¸»èŠ‚ç‚¹ã€‚ \nS1ã€S2 å›æ»šå®ƒä»¬æ‰€æœ‰æœªè¢«æäº¤çš„å˜æ›´ã€‚\nS1ã€S2 ä»ä¸»èŠ‚ç‚¹å‘é€çš„å¿ƒè·³åŒ…ä¸­è·å¾—å®ƒä»¬å¤±è”æœŸé—´å‘ç”Ÿçš„æ‰€æœ‰å˜æ›´ï¼Œå°†å˜æ›´æäº¤å¹¶å†™äººæœ¬åœ°ç£ç›˜ã€‚\næ­¤æ—¶åˆ†å¸ƒå¼ç³»ç»Ÿå„èŠ‚ç‚¹çš„çŠ¶æ€è¾¾æˆæœ€ç»ˆä¸€è‡´ã€‚\n\n\n\nä¸‹é¢æˆ‘ä»¬æ¥çœ‹ç¬¬ä¸‰ä¸ªé—®é¢˜ï¼šâ€œå¦‚ä½•ä¿è¯è¿‡ç¨‹æ˜¯å®‰å…¨çš„â€ã€‚ä¸çŸ¥ä½ æ˜¯å¦æ„Ÿè§‰åˆ°è¿™ä¸ªé—®é¢˜ä¸å‰ä¸¤ä¸ªé—®é¢˜çš„å·®å¼‚å‘¢ï¼Ÿé€‰ä¸»ã€æ•°æ®å¤åˆ¶éƒ½æ˜¯å¾ˆå…·ä½“çš„è¡Œä¸ºï¼Œä½†æ˜¯ â€œå®‰å…¨â€ å°±å¾ˆæ¨¡ç³Šï¼Œä»€ä¹ˆç®—å®‰å…¨æˆ–è€…ç®—ä¸å®‰å…¨ï¼Ÿ\nåœ¨åˆ†å¸ƒå¼ç†è®ºä¸­ï¼ŒSafety å’Œ Liveness ä¸¤ç§å±æ€§æ˜¯æœ‰é¢„å®šä¹‰çš„æœ¯è¯­ï¼Œåœ¨ä¸“ä¸šçš„èµ„æ–™ä¸­ä¸€èˆ¬ç¿»è¯‘æˆ â€œåå®šæ€§â€ å’Œ â€œç»ˆæ­¢æ€§â€ ã€‚è¿™ä¸¤ä¸ªæ¦‚å¿µä¹Ÿæ˜¯ç”± Lamport æœ€å…ˆæå‡ºï¼Œå½“æ—¶ç»™å‡ºçš„å®šä¹‰å¦‚ä¸‹ã€‚\n\nåå®šæ€§ï¼ˆSafetyï¼‰ï¼šæ‰€æœ‰çš„åäº‹éƒ½ä¸ä¼šå‘ç”Ÿã€‚\nç»ˆæ­¢æ€§ï¼ˆLivenessï¼‰ï¼šæ‰€æœ‰çš„å¥½äº‹éƒ½ç»ˆå°†å‘ç”Ÿï¼Œä½†ä¸çŸ¥é“æ˜¯ä»€ä¹ˆæ—¶å€™ã€‚\n\nè¿™é‡Œæˆ‘ä»¬ä¸å»çº ç»“ä¸¥è°¨çš„å®šä¹‰ï¼Œä»é€šè¿‡ä¸¾ä¾‹æ¥è¯´æ˜å®ƒä»¬çš„å…·ä½“å«ä¹‰ã€‚è­¬å¦‚ä»¥é€‰ä¸»é—®é¢˜ä¸ºä¾‹ï¼Œåå®šæ€§ä¿è¯äº†é€‰ä¸»çš„ç»“æœä¸€å®šæœ‰ä¸”åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œä¸å¯èƒ½åŒæ—¶å‡ºç°ä¸¤ä¸ªä¸»èŠ‚ç‚¹ï¼›è€Œç»ˆæ­¢æ€§åˆ™è¦ä¿è¯é€‰ä¸»è¿‡ç¨‹ä¸€å®šå¯ä»¥åœ¨æŸä¸ªæ—¶åˆ»ç»“æŸã€‚ç”±å‰é¢å¯¹æ´»é”çš„ä»‹ç»å¯çŸ¥ï¼Œåœ¨ç»ˆæ­¢æ€§è¿™ä¸ªå±æ€§ä¸Šé€‰ä¸»é—®é¢˜æ˜¯å­˜åœ¨ç†è®ºä¸Šçš„ç‘•ç–µçš„ï¼Œå¯èƒ½ä¼šç”±äºæ´»é”è€Œå¯¼è‡´ä¸€ç›´æ— æ³•é€‰å‡ºæ˜ç¡®çš„ä¸»èŠ‚ç‚¹ã€‚æ‰€ä»¥ Raft è®ºæ–‡ä¸­åªå†™äº†å¯¹ Safety çš„ä¿è¯ï¼Œä½†ç”±äºå·¥ç¨‹å®ç°ä¸Šçš„å¤„ç†ï¼Œç°å®ä¸­å‡ ä¹ä¸å¯èƒ½ä¼šå‡ºç°ç»ˆæ­¢æ€§çš„é—®é¢˜ã€‚\nä»¥ä¸Šè¿™ç§æŠŠå…±è¯†é—®é¢˜åˆ†è§£ä¸º â€œé€‰ä¸»â€ã€â€œå¤åˆ¶â€ å’Œ â€œå®‰å…¨â€ ä¸‰ä¸ªé—®é¢˜æ¥æ€è€ƒã€è§£å†³çš„æ€è·¯ï¼Œå³ â€œRaftç®—æ³•â€ ï¼ˆåœ¨ Raft çš„ã€Šä¸€ç§å¯ä»¥è®©äººç†è§£çš„å…±è¯†ç®—æ³•ã€‹ä¸­æå‡ºï¼‰ï¼Œå¹¶è·å¾—äº† USENIX ATC 2014 å¤§ä¼šçš„ Best Paperï¼Œåæ¥æ›´æ˜¯æˆä¸ºetedã€LogCabinã€Consul ç­‰é‡è¦åˆ†å¸ƒå¼ç¨‹åºçš„å®ç°åŸºç¡€ï¼ŒZooKeeper çš„ ZAB ç®—æ³•ä¸ Raft çš„æ€è·¯ä¹Ÿéå¸¸ç±»ä¼¼ï¼Œè¿™äº›ç®—æ³•éƒ½è¢«è®¤ä¸ºæ˜¯ Multi Paxos çš„ç­‰ä»·æ´¾ç”Ÿå®ç°ã€‚\nä¸‰ã€Gossipåè®®Paxosã€Rafã€ZAB ç­‰åˆ†å¸ƒå¼ç®—æ³•ç»å¸¸ä¼šè¢«ç§°ä½œ â€œå¼ºä¸€è‡´æ€§â€ çš„åˆ†å¸ƒå¼å…±è¯†åè®®ï¼Œå…¶å®æ ·çš„æè¿°æœ‰è¯­ç—…å«Œç–‘ã€‚ä½†æˆ‘ä»¬éƒ½æ˜ç™½å®ƒçš„æ„æ€å…¶å®æ˜¯ï¼šâ€œå°½ç®¡ç³»ç»Ÿå†…éƒ¨èŠ‚ç‚¹å¯ä»¥å­˜åœ¨ä¸ä¸€çš„çŠ¶æ€ã€‚ä½†ä»ç³»ç»Ÿå¤–éƒ¨çœ‹æ¥ï¼Œä¸ä¸€è‡´çš„æƒ…å†µå¹¶ä¸ä¼šè¢«è§‚å¯Ÿåˆ°ï¼Œæ‰€ä»¥æ•´ä½“ä¸Šçœ‹ç³»ç»Ÿæ˜¯å¼ºä¸€è‡´æ€§çš„ã€‚â€\nä¸å®ƒä»¬ç›¸å¯¹çš„ï¼Œè¿˜æœ‰å¦ä¸€ç±»è¢«å† ä»¥ â€œæœ€ç»ˆä¸€è‡´æ€§â€ çš„åˆ†å¸ƒå¼å…±è¯†åè®®ï¼Œè¿™è¡¨æ˜ç³»ç»Ÿä¸­ä¸ä¸€è‡´çš„çŠ¶æ€æœ‰å¯èƒ½ä¼šåœ¨ä¸€å®šæ—¶é—´å†…è¢«å¤–éƒ¨ç›´æ¥è§‚å¯Ÿåˆ°ã€‚ä¸€ç§å…¸å‹ä¸”æä¸ºå¸¸è§çš„æœ€ç»ˆä¸€è‡´çš„åˆ†å¸ƒå¼ç³»ç»Ÿå°±æ˜¯DNSç³»ç»Ÿï¼Œåœ¨å„èŠ‚ç‚¹ç¼“å­˜çš„ TTL åˆ°æœŸä¹‹å‰ï¼Œéƒ½æœ‰å¯èƒ½ä¸çœŸå®çš„åŸŸåç¿»è¯‘ç»“æœä¸ä¸€è‡´ã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œç¬”è€…å°†ä»‹ç»åœ¨æ¯”ç‰¹å¸ç½‘ç»œå’Œè®¸å¤šé‡è¦åˆ†å¸ƒå¼æ¡†æ¶ä¸­éƒ½æœ‰åº”ç”¨çš„å¦ä¸€ç§å…·æœ‰ä»£è¡¨æ€§çš„ â€œæœ€ç»ˆä¸€è‡´æ€§â€ çš„åˆ†å¸ƒå¼å…±è¯†åè®®ï¼šGossip åè®®ã€‚\nGossip æœ€æ—©ç”±æ–½ä¹å…¬å¸Palo Alto ç ”ç©¶ä¸­å¿ƒåœ¨è®ºæ–‡ â€œEpidemic Algorithms for Replicated Database Maintenanceâ€ ä¸­æå‡ºçš„ä¸€ç§ç”¨äºåˆ†å¸ƒå¼æ•°æ®åº“åœ¨å¤šèŠ‚ç‚¹é—´å¤åˆ¶åŒæ­¥æ•°æ®çš„ç®—æ³•ã€‚ä»è®ºæ–‡é¢˜ç›®ä¸­å¯ä»¥çœ‹å‡ºï¼Œæœ€åˆå®ƒæ˜¯è¢«ç§°ä½œ â€œæµè¡Œç—…ç®—æ³•â€ ï¼ˆEpidemic Algorithmï¼‰çš„ï¼Œåªæ˜¯ä¸å¤ªé›…è§‚ï¼Œä»Šå¤© Gossip è¿™ä¸ªåå­—ç”¨å¾—æ›´ä¸ºæ™®éï¼Œé™¤æ­¤ä»¥å¤–ï¼Œå®ƒè¿˜æœ‰â€œæµè¨€ç®—æ³•â€ â€œå…«å¦ç®—æ³•â€ â€œç˜Ÿç–«ç®—æ³•â€ ç­‰åˆ«åï¼Œè¿™äº›åå­—éƒ½å¾ˆå½¢è±¡åœ°åæ˜ äº† Gossip çš„ç‰¹ç‚¹ï¼šè¦åŒæ­¥çš„ä¿¡æ¯å¦‚åŒæµè¨€ä¸€èˆ¬ä¼ æ’­ï¼Œç—…æ¯’ä¸€èˆ¬æ‰©æ•£ã€‚\nç¬”è€…æŒ‰ç…§ä¹ æƒ¯ä¹ŸæŠŠ Gossip ç§°ä½œ â€œå…±è¯†åè®®â€ï¼Œä½†é¦–å…ˆå¿…é¡»å¼ºè°ƒå®ƒå¹¶ä¸æ˜¯ç›´æ¥ä¸ Paxos Raft è¿™äº›å…±è¯†ç®—æ³•ç­‰ä»·çš„ï¼Œåªæ˜¯åŸºäº Gossip ä¹‹ä¸Šå¯ä»¥é€šè¿‡æŸäº›æ–¹æ³•å»å®ç°ä¸ Paxosã€Raft ç±»ä¼¼çš„ç›®æ ‡è€Œå·²ã€‚ä¸€ä¸ªæœ€å…¸å‹çš„ä¾‹å­æ˜¯æ¯”ç‰¹å¸ç½‘ç»œä¸­ä½¿ç”¨äº† Gossip åè®®ï¼Œç”¨äºåœ¨å„ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹ä¸­äº’ç›¸åŒæ­¥åŒºå—å¤´å’ŒåŒºå—ä½“çš„ä¿¡æ¯ï¼Œè¿™æ˜¯æ•´ä¸ªç½‘ç»œèƒ½å¤Ÿæ­£å¸¸äº¤æ¢ä¿¡æ¯çš„åŸºç¡€ï¼Œä½†å¹¶ä¸èƒ½ç§°ä½œå…±è¯†ï¼›ç„¶åæ¯”ç‰¹å¸ä½¿ç”¨å·¥ä½œé‡è¯æ˜ï¼ˆProofofWorkï¼ŒPoWï¼‰æ¥å¯¹ â€œè¿™ä¸ªåŒºå—ç”±è°æ¥è®°è´¦â€ è¿™ä¸€ä»¶äº‹æƒ…åœ¨å…¨ç½‘è¾¾æˆå…±è¯†ï¼Œè¿™æ ·è¿™ä¸ªç›®æ ‡æ‰å¯ä»¥è®¤ä¸ºä¸ Paxosã€Raft çš„ç›®æ ‡æ˜¯ä¸€è‡´çš„ã€‚\nä¸‹é¢ï¼Œæˆ‘ä»¬æ¥äº†è§£ Gossip çš„å…·ä½“å·¥ä½œè¿‡ç¨‹ã€‚ç›¸æ¯” Paxosã€Raft ç­‰ç®—æ³•ï¼ŒGossip çš„è¿‡ç¨‹ååˆ†ç®€å•ï¼Œå®ƒå¯ä»¥çœ‹ä½œä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤çš„ç®€å•å¾ªç¯ã€‚\n\nå¦‚æœæœ‰æŸä¸€é¡¹ä¿¡æ¯éœ€è¦åœ¨æ•´ä¸ªç½‘ç»œçš„æ‰€æœ‰èŠ‚ç‚¹ä¸­ä¼ æ’­ï¼Œé‚£ä»ä¿¡æ¯æºå¼€å§‹ï¼Œé€‰æ‹©ä¸€ä¸ªå›ºå®šçš„ä¼ æ’­å‘¨æœŸï¼ˆè­¬å¦‚1ç§’ï¼‰ã€‚éšæœºé€‰æ‹©å®ƒç›¸è¿æ¥çš„ k ä¸ªèŠ‚ç‚¹ï¼ˆç§°ä¸º Fan-Outï¼‰æ¥ä¼ æ’­æ¶ˆæ¯ã€‚\næ¯ä¸€ä¸ªèŠ‚ç‚¹æ”¶åˆ°æ¶ˆæ¯åï¼Œå¦‚æœè¿™ä¸ªæ¶ˆæ¯æ˜¯å®ƒä¹‹å‰æ²¡æœ‰æ”¶åˆ°è¿‡çš„ï¼Œåˆ™åœ¨ä¸‹ä¸€ä¸ªå‘¨æœŸå†…ï¼Œè¯¥èŠ‚ç‚¹å°†å‘é™¤äº†å‘é€æ¶ˆæ¯ç»™å®ƒçš„é‚£ä¸ªèŠ‚ç‚¹å¤–çš„å…¶ä»–ç›¸é‚»çš„ k ä¸ªèŠ‚ç‚¹å‘é€ç›¸åŒçš„æ¶ˆæ¯ï¼Œç›´åˆ°æœ€ç»ˆç½‘ç»œä¸­æ‰€æœ‰èŠ‚ç‚¹éƒ½æ”¶åˆ°äº†æ¶ˆæ¯ã€‚å°½ç®¡è¿™ä¸ªè¿‡ç¨‹éœ€è¦ä¸€å®šæ—¶é—´ï¼Œä½†æ˜¯ç†è®ºä¸Šæœ€ç»ˆç½‘ç»œçš„æ‰€æœ‰èŠ‚ç‚¹éƒ½ä¼šæ‹¥æœ‰ç›¸åŒçš„æ¶ˆæ¯ã€‚\n\næ ¹æ® Gossip çš„è¿‡ç¨‹æè¿°ï¼Œæˆ‘ä»¬å¾ˆå®¹æ˜“å‘ç° Gossip å¯¹ç½‘ç»œèŠ‚ç‚¹çš„è¿é€šæ€§å’Œç¨³å®šæ€§å‡ ä¹æ²¡æœ‰ä»»ä½•è¦æ±‚ï¼Œå®ƒä¸€å¼€å§‹å°±å°†ç½‘ç»œæŸäº›èŠ‚ç‚¹åªèƒ½ä¸ä¸€éƒ¨åˆ†èŠ‚ç‚¹éƒ¨åˆ†è¿é€šï¼ˆPartially Connected Networkï¼‰è€Œä¸æ˜¯ä»¥å…¨è¿é€šç½‘ç»œï¼ˆFully Connected Networkï¼‰ä½œä¸ºå‰æï¼›èƒ½å¤Ÿå®¹å¿ç½‘ç»œä¸ŠèŠ‚ç‚¹éšæ„åœ°å¢åŠ æˆ–è€…å‡å°‘ï¼Œéšæ„åœ°å®•æœºæˆ–è€…é‡å¯ï¼›æ–°å¢åŠ æˆ–è€…é‡å¯çš„èŠ‚ç‚¹çš„çŠ¶æ€æœ€ç»ˆä¼šä¸å…¶ä»–èŠ‚ç‚¹åŒæ­¥è¾¾æˆä¸€è‡´ã€‚Gossip æŠŠç½‘ç»œä¸Šæ‰€æœ‰èŠ‚ç‚¹éƒ½è§†ä¸ºå¹³ç­‰è€Œæ™®é€šçš„ä¸€å‘˜ï¼Œæ²¡æœ‰ä»»ä½•ä¸­å¿ƒåŒ–èŠ‚ç‚¹æˆ–è€…ä¸»èŠ‚ç‚¹çš„æ¦‚å¿µï¼Œè¿™äº›ç‰¹ç‚¹ä½¿å¾— Gossip å…·æœ‰æå¼ºçš„é²æ£’æ€§ï¼Œè€Œä¸”éå¸¸é€‚åˆåœ¨å…¬ä¼—äº’è”ç½‘ä¸­åº”ç”¨ã€‚\nåŒæ—¶æˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“æ‰¾åˆ° Gossip çš„ç¼ºç‚¹ã€‚æ¶ˆæ¯æœ€ç»ˆæ˜¯é€šè¿‡å¤šä¸ªè½®æ¬¡çš„æ•£æ’­åˆ°è¾¾å…¨ç½‘çš„å› æ­¤å®ƒå¿…ç„¶ä¼šå­˜åœ¨å…¨ç½‘å„èŠ‚ç‚¹çŠ¶æ€ä¸ä¸€è‡´çš„æƒ…å†µï¼Œè€Œä¸”ç”±äºæ˜¯éšæœºé€‰å–å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°½ç®¡å¯ä»¥åœ¨æ•´ä½“ä¸Šæµ‹ç®—å‡ºç»Ÿè®¡å­¦æ„ä¹‰ä¸Šçš„ä¼ æ’­é€Ÿç‡ï¼Œä½†å¯¹äºä¸ªä½“æ¶ˆæ¯æ¥è¯´ï¼Œæ— æ³•å‡†ç¡®åœ°é¢„è®¡éœ€è¦å¤šé•¿æ—¶é—´æ‰èƒ½è¾¾æˆå…¨ç½‘ä¸€è‡´ã€‚å¦å¤–ä¸€ä¸ªç¼ºç‚¹æ˜¯æ¶ˆæ¯çš„å†—ä½™ï¼ŒåŒæ ·æ˜¯ç”±äºéšæœºé€‰å–å‘é€æ¶ˆæ¯çš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥å°±ä¸å¯é¿å…åœ°å­˜åœ¨æ¶ˆæ¯é‡å¤å‘é€ç»™åŒä¸€èŠ‚ç‚¹çš„æƒ…å†µï¼Œå¢åŠ äº†ç½‘ç»œçš„ä¼ è¾“å‹åŠ›ï¼Œä¹Ÿç»™æ¶ˆæ¯èŠ‚ç‚¹å¸¦æ¥äº†é¢å¤–çš„å¤„ç†è´Ÿè½½ã€‚\nè¾¾åˆ°ä¸€è‡´æ€§è€—è´¹çš„æ—¶é—´ä¸ç½‘ç»œä¼ æ’­ä¸­æ¶ˆæ¯å†—ä½™é‡è¿™ä¸¤ä¸ªç¼ºç‚¹å­˜åœ¨ä¸€å®šå¯¹ç«‹ï¼Œå¦‚æœè¦æ”¹å–„å…¶ä¸­ä¸€ä¸ªï¼Œå°±ä¼šæ¶åŒ–å¦å¤–ä¸€ä¸ªï¼Œç”±æ­¤ï¼ŒGossip è®¾è®¡äº†ä¸¤ç§å¯èƒ½çš„æ¶ˆæ¯ä¼ æ’­æ¨¡å¼ï¼šåç†µï¼ˆAnti-Entropyï¼‰å’Œä¼ è°£ï¼ˆRumor-Mongeringï¼‰ã€‚ç†µï¼ˆEntropyï¼‰æ˜¯ç”Ÿæ´»ä¸­å°‘è§ä½†ç§‘å­¦ä¸­å¾ˆå¸¸ç”¨çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨ç€äº‹ç‰©çš„æ··ä¹±ç¨‹åº¦ã€‚åç†µçš„æ„æ€å°±æ˜¯åæ··ä¹±ï¼Œä»¥æå‡ç½‘ç»œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„ç›¸ä¼¼åº¦ä¸ºç›®æ ‡ã€‚æ‰€ä»¥åœ¨åç†µæ¨¡å¼ä¸‹ï¼Œä¼šåŒæ­¥èŠ‚ç‚¹çš„å…¨éƒ¨æ•°æ®ï¼Œä»¥æ¶ˆé™¤å„èŠ‚ç‚¹ä¹‹é—´çš„å·®å¼‚ï¼Œç›®æ ‡æ˜¯ä½¿æ•´ä¸ªç½‘ç»œå„èŠ‚ç‚¹å®Œå…¨ä¸€è‡´ã€‚ä½†æ˜¯ï¼Œåœ¨èŠ‚ç‚¹æœ¬èº«å°±ä¼šå‘ç”Ÿå˜åŠ¨çš„å‰æä¸‹ï¼Œè¿™ä¸ªç›®æ ‡å°†ä½¿å¾—æ•´ä¸ªç½‘ç»œä¸­æ¶ˆæ¯çš„æ•°é‡éå¸¸åºå¤§ï¼Œç»™ç½‘ç»œå¸¦æ¥å·¨å¤§çš„ä¼ è¾“å¼€é”€ã€‚è€Œä¼ è°£æ¨¡å¼æ˜¯ä»¥ä¼ æ’­æ¶ˆæ¯ä¸ºç›®æ ‡ï¼Œåªå‘é€æ–°åˆ°è¾¾èŠ‚ç‚¹çš„æ•°æ®ï¼Œå³åªå¯¹å¤–å‘é€å˜æ›´æ¶ˆæ¯ï¼Œè¿™æ ·æ¶ˆæ¯æ•°æ®é‡å°†æ˜¾è‘—ç¼©å‡ï¼Œç½‘ç»œå¼€é”€ä¹Ÿç›¸å¯¹å‡å°ã€‚\n","categories":["åˆ†å¸ƒå¼"],"tags":["å‡¤å‡°æ¶æ„"]},{"title":"åˆ†å¸ƒå¼ç³»ç»Ÿã€æ‹œå åº­å°†å†›é—®é¢˜ä¸åŒºå—é“¾","url":"/posts/15204/","content":"ä»æŠ€æœ¯çš„è§’åº¦çœ‹ï¼ŒåŒºå—é“¾æ˜¯ä¸€ç§ä¸åˆ†å¸ƒå¼ç³»ç»Ÿæœ‰å…³çš„æŠ€æœ¯ã€‚å®ƒä¸åˆ†å¸ƒå¼ç³»ç»Ÿçš„å„ä¸ªæ¦‚å¿µä¹‹é—´æœ‰ä»€ä¹ˆè”ç³»ï¼Ÿä»Šå¤©æœ¬æ–‡å°±å€Ÿè¿™ä¸ªæœºä¼šï¼Œè·Ÿå¤§å®¶ä¸€èµ·è®¨è®ºä¸€ä¸‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒé—®é¢˜å’Œæ¦‚å¿µã€‚æœ€åï¼Œæˆ‘ä»¬å°†å°½é‡æ²¿ç€é€»è¾‘ä¸Šå‰åä¸€è´¯çš„æ€è·¯ï¼Œè®¨è®ºä¸€ä¸‹åŒºå—é“¾æŠ€æœ¯ã€‚\nåˆ†å¸ƒå¼ç³»ç»Ÿå’Œä¸€è‡´æ€§é—®é¢˜ä¸€ä¸ªç”±åŒºå—é“¾æŠ€æœ¯æ”¯æ’‘çš„ç³»ç»Ÿï¼Œæ¯”å¦‚æ¯”ç‰¹å¸ç½‘ç»œæˆ–ä»¥å¤ªåŠï¼Œä»æŠ€æœ¯ä¸Šçœ‹ï¼Œæ˜¯ä¸€ä¸ªå¾ˆåºå¤§çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å› æ­¤ï¼Œæˆ‘ä»¬é¦–å…ˆä»åˆ†å¸ƒå¼ç³»ç»Ÿå¼€å§‹è¯´èµ·ã€‚\nå¯¹äºæŠ€æœ¯äººå‘˜æ¥è¯´ï¼Œç‰¹åˆ«æ˜¯æœåŠ¡å™¨å¼€å‘äººå‘˜ï¼Œå‡ ä¹æ¯ä¸ªäººéƒ½ç»å¸¸å’Œåˆ†å¸ƒå¼ç³»ç»Ÿæ‰“äº¤é“ã€‚å½“æœåŠ¡çš„è§„æ¨¡è¶Šæ¥è¶Šå¤§çš„æ—¶å€™ï¼Œå®ƒå¿…ç„¶å‘å±•æˆä¸€ä¸ªå¤æ‚çš„åˆ†å¸ƒå¼ç³»ç»Ÿã€‚å¾ˆå…¸å‹çš„ï¼Œå°±æ˜¯å„ç§åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œå®ƒä»¬é€šå¸¸èƒ½å°†æ•°æ®ä»¥æŸç§æ–¹å¼åœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šå­˜å‚¨ï¼Œåœ¨é«˜å¯ç”¨çš„åŸºç¡€ä¸Šä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚\nå®é™…ä¸Šï¼Œä¸€è‡´æ€§é—®é¢˜(consensus problem)æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦è§£å†³çš„ä¸€ä¸ªæ ¸å¿ƒé—®é¢˜ã€‚åˆ†å¸ƒå¼ç³»ç»Ÿä¸€èˆ¬æ˜¯ç”±å¤šä¸ªåœ°ä½ç›¸ç­‰çš„èŠ‚ç‚¹ç»„æˆï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„äº¤äº’å°±å¥½æ¯”å‡ ä¸ªäººèšåœ¨ä¸€èµ·è®¨è®ºé—®é¢˜ã€‚è®©æˆ‘ä»¬è®¾æƒ³ä¸€ä¸ªæ›´å…·ä½“çš„åœºæ™¯ï¼Œæ¯”å¦‚ä¸‰ä¸ªäººè®¨è®ºä¸­åˆå»å“ªé‡Œåƒé¥­ï¼Œç¬¬ä¸€ä¸ªäººè¯´é™„è¿‘åˆšå¼€äº†ä¸€ä¸ªç«é”…åº—ï¼Œå¬è¯´å‘³é“éå¸¸ä¸é”™ï¼›ä½†ç¬¬äºŒä¸ªäººè¯´ï¼Œä¸å¥½ï¼Œåƒç«é”…èŠ±çš„æ—¶é—´å¤ªä¹…äº†ï¼Œè¿˜æ˜¯éšä¾¿å–ç‚¹ç²¥ç®—äº†ï¼›è€Œç¬¬ä¸‰ä¸ªäººè¯´ï¼Œé‚£ä¸ªç²¥åº—æˆ‘æ˜¨å¤©åˆšå»è¿‡ï¼Œå¤ªéš¾å–äº†ï¼Œè¿˜ä¸å¦‚å»åƒéº¦å½“åŠ³ã€‚ç»“æœï¼Œä¸‰ä¸ªäººåƒµæŒä¸ä¸‹ï¼Œå§‹ç»ˆè¾¾ä¸æˆä¸€è‡´ã€‚\næœ‰äººè¯´ï¼Œè¿™è¿˜ä¸å¥½è§£å†³ï¼ŒæŠ•ç¥¨å‘—ã€‚äºæ˜¯ä¸‰ä¸ªäººæŠ•äº†ä¸€è½®ç¥¨ï¼Œç»“æœæ¯ä¸ªäººä»ç„¶åšæŒè‡ªå·±çš„æè®®ï¼Œé—®é¢˜è¿˜æ˜¯æ²¡æœ‰è§£å†³ã€‚æœ‰äººåˆæƒ³äº†ä¸ªä¸»æ„ï¼Œå¹²è„†æˆ‘ä»¬é€‰å‡ºä¸€ä¸ªleaderï¼Œè¿™ä¸ªleaderè¯´ä»€ä¹ˆï¼Œæˆ‘ä»¬å°±å¬ä»–çš„ï¼Œè¿™æ ·å¤§å®¶å°±ä¸ç”¨äº‰äº†ã€‚äºæ˜¯ï¼Œå¤§å®¶å¼€å§‹æŠ•ç¥¨é€‰leaderã€‚ç»“æœå¾ˆæ‚²å‰§ï¼Œæ¯ä¸ªäººéƒ½è§‰å¾—è‡ªå·±åº”è¯¥åšè¿™ä¸ªleaderã€‚ä¸‰ä¸ªäººç»ˆäºå‘ç°ï¼Œã€Œé€‰leaderã€è¿™ä»¶äº‹ä»ç„¶å’ŒåŸæ¥çš„ã€Œå»å“ªé‡Œåƒé¥­ã€è¿™ä¸ªé—®é¢˜åœ¨æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼ŒåŒæ ·éš¾ä»¥è§£å†³ã€‚\nè¿™æ—¶ææ€•æœ‰äº›è¯»è€…ä»¬å¿ƒé‡Œåœ¨æƒ³ï¼Œè¿™ä¸‰ä¸ªäººæ˜¯æœ‰æ¯›ç—…å§â€¦â€¦å°±åƒä¸ªé¥­è¿™ä¹ˆç‚¹å°äº‹ï¼Œç”¨å¾—ç€äº‰æˆè¿™æ ·å—ï¼Ÿå®é™…ä¸Šï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¹‹é—´ï¼Œå¦‚æœæ²¡æœ‰æŸç§ä¸¥æ ¼å®šä¹‰çš„è§„åˆ™å’Œåè®®ï¼Œå®ƒä»¬ä¹‹é—´çš„äº¤äº’å°±çœŸçš„æœ‰å¯èƒ½åƒä¸Šé¢è¯´çš„æƒ…å½¢ä¸€æ ·ã€‚æ•´ä¸ªç³»ç»Ÿè¾¾ä¸æˆä¸€è‡´ï¼Œå°±æ ¹æœ¬æ²¡æ³•å·¥ä½œã€‚\næ‰€ä»¥ï¼Œå°±æœ‰èªæ˜äººè®¾è®¡å‡ºäº†ä¸€è‡´æ€§åè®®(consensus protocol)ï¼Œåƒæˆ‘ä»¬å¸¸è§çš„æ¯”å¦‚Paxosã€Raftã€Zabä¹‹ç±»ã€‚ä¸å‰é¢å‡ ä¸ªäººå•†é‡é—®é¢˜ç±»ä¼¼ï¼Œå¦‚æœç¿»è¯‘æˆPaxosçš„æœ¯è¯­ï¼Œç›¸å½“äºæ¯ä¸ªèŠ‚ç‚¹å¯ä»¥æå‡ºè‡ªå·±çš„æè®®(ç§°ä¸ºproposalï¼Œé‡Œé¢åŒ…å«æè®®çš„å…·ä½“å€¼)ï¼Œåè®®çš„æœ€ç»ˆç›®æ ‡å°±æ˜¯å„ä¸ªèŠ‚ç‚¹æ ¹æ®ä¸€å®šçš„è§„åˆ™è¾¾æˆç›¸åŒçš„proposalã€‚ä½†ä»¥è°çš„æè®®ä¸ºå‡†å‘¢ï¼Ÿæˆ‘ä»¬å®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªè§„åˆ™å¯èƒ½æ˜¯è¿™æ ·ï¼šå“ªä¸ªèŠ‚ç‚¹å…ˆæå‡ºæè®®ï¼Œå°±ä»¥è°çš„ä¸ºå‡†ï¼Œåæå‡ºçš„æè®®æ— æ•ˆã€‚ä½†æ˜¯ï¼Œåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„æƒ…å†µå¯æ¯”å‡ ä¸ªäººèšåœ¨ä¸€èµ·è®¨è®ºé—®é¢˜å¤æ‚å¤šäº†ï¼Œè¿™é‡Œè¾¹è¿˜æœ‰ç½‘ç»œå»¶è¿Ÿçš„é—®é¢˜ï¼Œå¯¼è‡´ä½ å¾ˆéš¾å¯¹å‘ç”Ÿçš„æ‰€æœ‰äº‹ä»¶è¿›è¡Œå…¨å±€åœ°æ’åºã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾èŠ‚ç‚¹Aå’ŒBåˆ†åˆ«å‡ ä¹åŒæ—¶åœ°å‘èŠ‚ç‚¹Xå’ŒYå‘å‡ºäº†è‡ªå·±çš„proposalï¼Œä½†ç”±äºæ¶ˆæ¯åœ¨ç½‘ç»œä¸­çš„å»¶è¿Ÿæƒ…å†µä¸åŒï¼Œæœ€åç»“æœæ˜¯ï¼šXå…ˆæ”¶åˆ°äº†Açš„proposalï¼Œåæ”¶åˆ°äº†Bçš„proposalï¼›ä½†æ˜¯Yæ­£å¥½ç›¸åï¼Œå®ƒå…ˆæ”¶åˆ°äº†Bçš„proposalï¼Œåæ”¶åˆ°äº†Açš„proposalã€‚è¿™æ ·åœ¨Xå’ŒYåˆ†åˆ«çœ‹æ¥ï¼Œè°å…ˆè°åå°±éš¾ä»¥è¾¾æˆä¸€è‡´äº†ã€‚\næ­¤å¤–ï¼Œå¦‚æœè€ƒè™‘åˆ°èŠ‚ç‚¹å®•æœºå’Œæ¶ˆæ¯ä¸¢å¤±çš„å¯èƒ½æ€§ï¼Œæƒ…å†µè¿˜ä¼šæ›´å¤æ‚ã€‚èŠ‚ç‚¹å®•æœºå¯ä»¥çœ‹æˆæ˜¯æ¶ˆæ¯ä¸¢å¤±çš„ç‰¹ä¾‹ï¼Œç›¸å½“äºå‘ç»™è¿™ä¸ªèŠ‚ç‚¹çš„æ¶ˆæ¯å…¨éƒ¨ä¸¢å¤±äº†ã€‚è¿™åœ¨CAPçš„ç†è®ºæ¡†æ¶ä¸‹ï¼Œç›¸å½“äºå‘ç”Ÿäº†ç½‘ç»œåˆ†å‰²(network partitioning)ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”CAPä¸­çš„Pã€‚ä¸ºä»€ä¹ˆèŠ‚ç‚¹å®•æœºå’Œæ¶ˆæ¯ä¸¢å¤±éƒ½èƒ½å½’ç»“åˆ°ç½‘ç»œåˆ†å‰²çš„æƒ…å†µä¸Šå»å‘¢ï¼Ÿæ˜¯å› ä¸ºè¿™å‡ ç§æƒ…å†µå®é™…ä¸Šæ— æ³•åŒºåˆ†ã€‚æ¯”å¦‚ï¼Œæœ‰è‹¥å¹²ä¸ªèŠ‚ç‚¹è”ç³»ä¸ä¸Šäº†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºå…¶å®ƒèŠ‚ç‚¹æ¥è¯´ï¼Œå®ƒä»¬å‘é€ç»™è¿™äº›èŠ‚ç‚¹çš„æ¶ˆæ¯æ”¶ä¸åˆ°ä»»ä½•å›åº”ã€‚çœŸæ­£çš„åŸå› ï¼Œå¯èƒ½æ˜¯ç½‘ç»œä¸­é—´ä¸é€šäº†ï¼Œä¹Ÿå¯èƒ½æ˜¯é‚£äº›ç›®çš„èŠ‚ç‚¹å®•æœºäº†ï¼Œä¹Ÿå¯èƒ½æ˜¯æ¶ˆæ¯æ— é™æœŸåœ°è¢«å»¶è¿Ÿäº†ã€‚æ€»ä¹‹ï¼Œå°±æ˜¯ç³»ç»Ÿä¸­æœ‰äº›èŠ‚ç‚¹è”ç³»ä¸ä¸Šäº†ï¼Œå®ƒä»¬ä¸èƒ½å†å‚ä¸å†³ç­–ï¼Œä½†ä¹Ÿä¸ä»£è¡¨å®ƒä»¬è¿‡ä¸€æ®µæ—¶é—´ä¸èƒ½é‡æ–°è”ç³»ä¸Šã€‚\nä¸ºäº†è¡¨è¾¾ä¸Šæ›´ç›´è§‚ï¼Œä¸‹é¢æˆ‘ä»¬è¿˜æ˜¯å‡è®¾æŸäº›èŠ‚ç‚¹å®•æœºäº†ã€‚é‚£åœ¨è¿™ä¸ªæ—¶å€™ï¼Œå‰©ä¸‹çš„èŠ‚ç‚¹åœ¨ç¼ºå°‘äº†æŸäº›èŠ‚ç‚¹å‚ä¸å†³ç­–çš„æƒ…å†µä¸‹ï¼Œè¿˜èƒ½ä¸èƒ½å¯¹äºæè®®è¾¾æˆä¸€è‡´å‘¢ï¼Ÿå³ä½¿æ˜¯è¾¾æˆäº†ä¸€è‡´ï¼Œé‚£ä¹ˆåœ¨é‚£äº›å®•æœºçš„èŠ‚ç‚¹é‡æ–°æ¢å¤è¿‡æ¥ä¹‹åï¼ˆæ³¨æ„è¿™æ—¶å€™å®ƒä»¬å¯¹äºå…¶å®ƒèŠ‚ç‚¹ä¹‹é—´å·²ç»è¾¾æˆä¸€è‡´çš„æè®®å¯èƒ½ä¸€æ— æ‰€çŸ¥ï¼‰ï¼Œå®ƒä»¬ä¼šä¸ä¼šå¯¹äºå·²ç»è¾¾æˆçš„ä¸€è‡´æè®®é‡æ–°æå‡ºå¼‚è®®ï¼Œä»è€Œé€ æˆæ··ä¹±ï¼Ÿæ‰€æœ‰è¿™äº›é—®é¢˜ï¼Œéƒ½æ˜¯åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®éœ€è¦è§£å†³çš„ã€‚\næˆ‘ä»¬è¿™é‡Œæ²¡æœ‰è¶³å¤Ÿçš„ç¯‡å¹…æ¥è¯¦ç»†è®¨è®ºè¿™äº›åè®®å…·ä½“çš„å®ç°äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»æŸ¥é˜…ç›¸å…³çš„è®ºæ–‡ã€‚å®é™…ä¸Šï¼Œç†è§£é—®é¢˜æœ¬èº«æ¯”ç†è§£é—®é¢˜çš„ç­”æ¡ˆè¦é‡è¦çš„å¤šã€‚æ€»ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼Œæˆ‘ä»¬å·²ç»æœ‰äº†ä¸€äº›ç°æˆçš„åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ƒä»¬èƒ½è§£å†³ä¸Šé¢è®¨è®ºçš„è¿™äº›é—®é¢˜ï¼Œä¿è¯åœ¨ä¸€ä¸ªå»ä¸­å¿ƒåŒ–çš„ç½‘ç»œä¸­ï¼Œå„ä¸ªèŠ‚ç‚¹ä¹‹é—´æœ€ç»ˆèƒ½å¤Ÿå¯¹äºæè®®è¾¾æˆä¸€è‡´ã€‚è€Œä¸”ï¼Œè¿™äº›åè®®éƒ½å…·æœ‰ä¸€å®šçš„å®¹é”™æ€§ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåªè¦ç½‘ç»œä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹(æˆ–ä¸€ä¸ªquorum)ä»ç„¶å­˜æ´»ï¼ˆå³å®ƒä»¬ç›¸äº’é—´å¯ä»¥æ”¶å‘æ¶ˆæ¯ï¼‰ï¼Œè¿™ä¸ªä¸€è‡´æ€§çš„æè®®å°±å¯ä»¥è¾¾æˆã€‚\næ‹œå åº­å°†å†›é—®é¢˜æˆ‘ä»¬å‰é¢è®¨è®ºçš„ä¸€è‡´æ€§åè®®ï¼Œæœ‰ä¸€ä¸ªé‡è¦çš„å‰ææ¡ä»¶ï¼Œå°±æ˜¯ï¼šå„ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å¯ä»¥ä¿¡ä»»çš„ï¼Œå®ƒä»¬éƒ½ä¸¥æ ¼éµå®ˆåŒæ ·çš„ä¸€å¥—è§„åˆ™ã€‚è¿™ä¸ªæ¡ä»¶ï¼Œåœ¨ä¸€ä¸ªå…¬å¸çš„å†…éƒ¨ç½‘ç»œä¸­å¯ä»¥è®¤ä¸ºæ˜¯åŸºæœ¬èƒ½æ»¡è¶³çš„ã€‚ä½†å¦‚æœè¿™ä¸ªæ¡ä»¶ä¸æ»¡è¶³ä¼šæ€ä¹ˆæ ·å‘¢ï¼Ÿå‡è®¾ç½‘ç»œä¸­æœ‰äº›èŠ‚ç‚¹æ˜¯æ¶æ„çš„ï¼Œå®ƒä»¬ä¸ä½†ä¸éµå®ˆåè®®ï¼Œè¿˜æ•…æ„æ£ä¹±ï¼ˆæ¯”å¦‚èƒ¡ä¹±å‘é€æ¶ˆæ¯ï¼‰ï¼Œé‚£ä¹ˆå…¶å®ƒæ­£å¸¸çš„èŠ‚ç‚¹è¿˜èƒ½å¤Ÿé¡ºåˆ©å·¥ä½œå—ï¼Ÿ\nåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿç†è®ºä¸­ï¼Œè¿™ä¸ªé—®é¢˜è¢«æŠ½è±¡æˆäº†ä¸€ä¸ªè‘—åçš„é—®é¢˜â€”â€”æ‹œå åº­å°†å†›é—®é¢˜(Byzantine Generals Problem)ã€‚è¿™ä¸ªé—®é¢˜ç”±å¤§åé¼é¼çš„Leslie Lamportæå‡ºï¼Œä¹Ÿå°±æ˜¯Paxosçš„ä½œè€…ã€‚åŒæ—¶ï¼ŒLamportè¿˜æ˜¯2013å¹´çš„å›¾çµå¥–å¾—ä¸»ã€‚\nè¿™è¦ä»ä¸€ä¸ªæ•…äº‹å¼€å§‹è¯´èµ·ï¼ˆå½“ç„¶è¿™ä¸ªæ•…äº‹æ˜¯Lamportç¼–å‡ºæ¥çš„ï¼‰ã€‚æ‹œå åº­å¸å›½çš„å‡ æ”¯å†›é˜Ÿæ”»æ‰“åˆ°äº†æ•Œäººçš„åŸå¸‚å¤–é¢ï¼Œç„¶ååˆ†å¼€é©»æ‰ã€‚æ¯ä¸€æ”¯å†›é˜Ÿç”±ä¸€ä½æ‹œå åº­å°†å†›(Byzantine general)ç‡é¢†ã€‚ä¸ºäº†åˆ¶å®šå‡ºä¸€ä¸ªç»Ÿä¸€çš„ä½œæˆ˜è®¡åˆ’ï¼Œæ¯ä¸€ä½å°†å†›éœ€è¦é€šè¿‡ä¿¡å·®(messenger)ä¸å…¶å®ƒå°†å†›äº’é€šæ¶ˆæ¯ã€‚ä½†æ˜¯ï¼Œåœ¨æ‹œå åº­å°†å†›ä¹‹é—´å¯èƒ½å‡ºç°äº†å›å¾’(traitor)ã€‚è¿™äº›å›å¾’å°†å†›çš„ç›®çš„æ˜¯é˜»æŒ å…¶ä»–å¿ è¯šçš„å°†å†›(loyal generals)è¾¾æˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ã€‚ä¸ºäº†è¿™ä¸€ç›®çš„ï¼Œä»–ä»¬å¯èƒ½åšä»»ä½•äº‹ï¼Œæ¯”å¦‚ä¸²é€šèµ·æ¥ï¼Œæ•…æ„ä¼ å‡ºè™šå‡æ¶ˆæ¯ï¼Œæˆ–è€…ä¸ä¼ å‡ºä»»ä½•æ¶ˆæ¯ã€‚\næˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚å‡è®¾æœ‰5ä½å°†å†›ï¼Œä»–ä»¬æŠ•ç¥¨æ¥å†³å®šæ˜¯è¿›æ”»è¿˜æ˜¯æ’¤é€€ã€‚å…¶ä¸­ä¸¤ä½è®¤ä¸ºåº”è¯¥è¿›æ”»ï¼Œè¿˜æœ‰ä¸¤ä½è®¤ä¸ºåº”è¯¥æ’¤é€€ï¼Œè¿™æ—¶å€™è¿›æ”»å’Œæ’¤é€€çš„ç¥¨æ•°æ˜¯2:2æ‰“å¹³äº†ã€‚ç¬¬äº”ä½å°†å†›æ°å¥½æ˜¯ä¸ªå›å¾’ï¼Œä»–å‘Šè¯‰å‰ä¸¤ä½åº”è¯¥è¿›æ”»ï¼Œä½†å‘Šè¯‰åä¸¤ä½åº”è¯¥æ’¤é€€ï¼Œç»“æœå‰ä¸¤ä½å°†å†›æœ€ç»ˆå†³å®šè¿›æ”»ï¼Œè€Œåä¸¤ä½å°†å†›å´å†³å®šæ’¤é€€ã€‚æ²¡æœ‰è¾¾æˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ã€‚\nè¿™ä¸ªé—®é¢˜æ˜¾ç„¶æ¯”æˆ‘ä»¬åœ¨å‰ä¸€ç« è®¨è®ºçš„å¯ä¿¡ä»»ç¯å¢ƒä¸‹çš„ä¸€è‡´æ€§é—®é¢˜è¦æ›´éš¾ã€‚è¦è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯å¸Œæœ›èƒ½æ‰¾åˆ°ä¸€ä¸ªç®—æ³•ï¼Œä¿è¯åœ¨å­˜åœ¨å›å¾’é˜»æŒ çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä»ç„¶èƒ½å¤Ÿè¾¾æˆå¦‚ä¸‹ç›®æ ‡ï¼š\n\nA. æ‰€æœ‰å¿ è¯šçš„å°†å†›éƒ½å¾—åˆ°äº†ç›¸åŒï¼ˆä¸€è‡´ï¼‰çš„ä½œæˆ˜è®¡åˆ’ã€‚æ¯”å¦‚éƒ½å†³å®šè¿›æ”»ï¼Œæˆ–éƒ½å†³å®šæ’¤é€€ï¼Œè€Œä¸æ˜¯æœ‰äº›å°†å†›è®¤ä¸ºåº”è¯¥è¿›æ”»ï¼Œå…¶ä»–å°†å†›å´å†³å®šæ’¤é€€ã€‚\nB. å¿ è¯šçš„å°†å†›ä¸ä»…å¾—åˆ°äº†ç›¸åŒçš„ä½œæˆ˜è®¡åˆ’ï¼Œè¿˜åº”è¯¥ä¿è¯å¾—åˆ°çš„ä½œæˆ˜è®¡åˆ’æ˜¯åˆç†çš„(reasonable)ã€‚æ¯”å¦‚ï¼Œæœ¬æ¥è¿›æ”»æ˜¯æ›´æœ‰åˆ©çš„ä½œæˆ˜è®¡åˆ’ï¼Œä½†ç”±äºå›å¾’çš„é˜»æŒ ï¼Œæœ€ç»ˆå´åˆ¶å®šå‡ºäº†ä¸€èµ·æ’¤é€€çš„è®¡åˆ’ã€‚è¿™æ ·æˆ‘ä»¬çš„ç®—æ³•ä¹Ÿç®—å¤±è´¥äº†ã€‚\n\nå¯ä»¥çœ‹å‡ºï¼Œä¸Šé¢çš„ç›®æ ‡Aï¼Œæ˜¯æ¯”è¾ƒæ˜ç¡®çš„ï¼Œè‡³å°‘ç»™å®šä¸€ä¸ªç®—æ³•å¾ˆå®¹æ˜“åˆ¤å®šå®ƒæœ‰æ²¡æœ‰è¾¾åˆ°è¿™ä¸ªç›®æ ‡ã€‚ä½†ç›®æ ‡Bå´è®©äººæ— ä»ä¸‹æ‰‹ã€‚ä¸€ä¸ªä½œæˆ˜è®¡åˆ’æ˜¯ä¸æ˜¯ã€Œåˆç†ã€çš„ï¼Œæœ¬æ¥å°±ä¸å¥½å®šä¹‰ã€‚å³ä½¿æ²¡æœ‰å›å¾’çš„å­˜åœ¨ï¼Œå¿ è¯šçš„å°†å†›ä»¬ä¹Ÿæœªå¿…å°±ä¸€å®šèƒ½åˆ¶å®šå‡ºåˆç†çš„è®¡åˆ’ã€‚è¿™æ¶‰åŠåˆ°ç§‘å­¦ç ”ç©¶ä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„é—®é¢˜ï¼Œå¦‚æœä¸€ä¸ªäº‹æƒ…ä¸èƒ½ç”¨ä¸€ç§å½¢å¼åŒ–çš„æ–¹å¼æ¸…æ™°çš„å®šä¹‰å‡ºæ¥ï¼Œå¯¹äºå®ƒçš„ç ”ç©¶ä¹Ÿå°±æ— ä»è°ˆèµ·ï¼Œè¿™ä¸ªäº‹æƒ…æœ¬èº«ä¹Ÿæ— æ³•ä¸Šå‡åˆ°ç§‘å­¦çš„å±‚é¢ã€‚Lamportåœ¨å¯¹æ‹œå åº­å°†å†›é—®é¢˜çš„ç ”ç©¶ä¸­ï¼Œä¸€ä¸ªçªå‡ºçš„è´¡çŒ®å°±æ˜¯ï¼ŒæŠŠè¿™ä¸ªçœ‹ä¼¼ä¸å¤ªå¥½ç•Œå®šçš„é—®é¢˜ï¼Œå·§å¦™åœ°å½’çº¦åˆ°äº†ä¸€ä¸ªèƒ½ç”¨æ•°å­¦è¯­è¨€ç²¾ç¡®æè¿°çš„é—®é¢˜ä¸Šå»ã€‚ä¸‹é¢æˆ‘ä»¬å°±çœ‹ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹æ˜¯æ€ä¹ˆåšçš„ã€‚\né¦–å…ˆæˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹å°†å†›ä»¬åˆ¶å®šä½œæˆ˜è®¡åˆ’çš„è¿‡ç¨‹ï¼ˆå…ˆå‡è®¾æ²¡æœ‰å›å¾’ï¼‰ã€‚æ¯ä¸€ä½å°†å†›æ ¹æ®è‡ªå·±å¯¹æˆ˜å±€çš„è§‚å¯Ÿï¼Œç»™å‡ºä»–å»ºè®®çš„ä½œæˆ˜è®¡åˆ’â€”â€”æ˜¯è¿›æ”»è¿˜æ˜¯æ’¤é€€ï¼Œè¿™ç§°ä¸ºä½œæˆ˜æè®®ã€‚ç„¶åï¼Œæ¯ä½å°†å†›æŠŠè‡ªå·±çš„ä½œæˆ˜æè®®é€šè¿‡ä¿¡å·®ä¼ è¾¾ç»™å…¶ä»–æ¯ä¸€ä½å°†å†›ã€‚ç°åœ¨æ¯ä¸€ä½å°†å†›éƒ½çŸ¥é“äº†å…¶ä»–å°†å†›çš„ä½œæˆ˜æè®®ï¼Œå†åŠ ä¸Šä»–è‡ªå·±çš„ä½œæˆ˜æè®®ï¼Œä»–éœ€è¦æ ¹æ®æ‰€æœ‰è¿™äº›ä¿¡æ¯å¾—åˆ°æœ€ç»ˆçš„ä¸€ä¸ªä½œæˆ˜è®¡åˆ’ã€‚ä¸ºäº†è¡¨è¾¾ä¸Šæ›´æ¸…æ™°ï¼Œæˆ‘ä»¬ç»™æ¯ä½å°†å†›è¿›è¡Œç¼–å·ï¼Œåˆ†åˆ«æ˜¯1, 2, â€¦, nï¼Œæ¯ä½å°†å†›æå‡ºçš„ä½œæˆ˜æè®®è®°ä¸ºv(1), v(2), â€¦, v(n)ï¼Œä¸€å…±æ˜¯nä¸ªå€¼ï¼Œè¿™å…¶ä¸­æœ‰äº›ä»£è¡¨ã€Œè¿›æ”»ã€ï¼Œæœ‰äº›ä»£è¡¨ã€Œæ’¤é€€ã€ã€‚ç»è¿‡ä¿¡å·®ä¼ é€’æ¶ˆæ¯ä¹‹åï¼Œæ¯ä½å°†å†›éƒ½çœ‹åˆ°äº†ç›¸åŒçš„ä½œæˆ˜æè®®åºåˆ—v(1), v(2), â€¦, v(n)ï¼Œå½“ç„¶è¿™å…¶ä¸­çš„ä¸€ä¸ªæ˜¯å½“å‰è¿™ä½å°†å†›è‡ªå·±æå‡ºæ¥çš„ã€‚ç„¶ååªè¦æ¯ä½å°†å†›é‡‡ç”¨åŒæ ·çš„æ–¹æ³•ï¼Œå¯¹æ‰€æœ‰çš„v(1), v(2), â€¦, v(n)è¿™äº›ä¿¡æ¯è¿›è¡Œæ±‡æ€»ï¼Œå°±èƒ½å¾—åˆ°åŒæ ·çš„æœ€ç»ˆä½œæˆ˜è®¡åˆ’ã€‚æ¯”å¦‚ï¼Œå®¹æ˜“æƒ³åˆ°çš„ä¸€ä¸ªæ–¹æ³•æ˜¯æŠ•ç¥¨æ³•ï¼Œå³å¯¹v(1), v(2), â€¦, v(n)ä¸­ä¸åŒçš„ä½œæˆ˜æè®®è¿›è¡ŒæŠ•ç¥¨ï¼Œæœ€åé€‰æ‹©å¾—ç¥¨æœ€å¤šçš„ä½œä¸ºæœ€ç»ˆä½œæˆ˜è®¡åˆ’ã€‚\nå½“ç„¶ï¼Œè¿™æ ·å¾—åˆ°çš„æœ€ç»ˆä½œæˆ˜è®¡åˆ’ä¹Ÿä¸èƒ½ä¿è¯å°±æ˜¯æœ€å¥½çš„ï¼Œä½†è¿™åº”è¯¥æ˜¯æˆ‘ä»¬èƒ½åšåˆ°çš„æœ€å¥½çš„äº†ã€‚æˆ‘ä»¬ç°åœ¨ä»ç„¶å‡è®¾å°†å†›é‡Œæ²¡æœ‰å›å¾’ã€‚æˆ‘ä»¬å‘ç°ï¼Œå‰é¢æåˆ°çš„ç›®æ ‡Aå’Œç›®æ ‡Bçš„è¦æ±‚å¯ä»¥é€‚å½“ã€Œé™ä½ã€ä¸€äº›ï¼šæˆ‘ä»¬ä¸å†å…³æ³¨å°†å†›ä»¬æ˜¯å¦èƒ½è¾¾æˆæœ€ç»ˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ï¼Œå¹¶ä¸”è¿™ä¸ªè®¡åˆ’æ˜¯ä¸æ˜¯ã€Œåˆç†ã€ï¼›æˆ‘ä»¬åªå…³æ³¨æ¯ä¸ªå°†å†›æ˜¯å¦æ”¶åˆ°äº†å®Œå…¨ç›¸åŒçš„ä½œæˆ˜æè®®v(1), v(2), â€¦, v(n)ã€‚åªè¦æ¯ä½å°†å†›æ”¶åˆ°çš„è¿™äº›ä½œæˆ˜æè®®æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œä»–ä»¬å†ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œæ±‡æ€»ï¼Œå°±å¾ˆå®¹æ˜“å¾—åˆ°æœ€ç»ˆä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ã€‚è‡³äºè¿™ä¸ªæœ€ç»ˆçš„ä½œæˆ˜è®¡åˆ’æ˜¯ä¸æ˜¯æœ€å¥½çš„ï¼Œé‚£å°±è·Ÿå¾ˆå¤šã€Œäººä¸ºã€çš„å› ç´ æœ‰å…³äº†ï¼Œæˆ‘ä»¬ä¸å»ç®¡å®ƒã€‚\nç°åœ¨æˆ‘ä»¬è€ƒè™‘å°†å†›ä¸­å‡ºç°äº†å›å¾’ã€‚éµå¾ªå‰é¢çš„æ€è·¯ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ›æ¯ä½å°†å†›èƒ½å¤Ÿæ”¶åˆ°å®Œå…¨ç›¸åŒçš„ä½œæˆ˜æè®®v(1), v(2), â€¦, v(n)ã€‚ç°åœ¨æˆ‘ä»¬ä»”ç»†å®¡è§†ä¸€ä¸‹å…¶ä¸­çš„ä¸€ä¸ªå€¼ï¼Œv(i)ï¼Œåœ¨å‰é¢çš„æè¿°ä¸­ï¼Œå®ƒè¡¨ç¤ºæ¥è‡ªç¬¬iä¸ªå°†å†›çš„ä½œæˆ˜æè®®ã€‚å¦‚æœç¬¬iä¸ªå°†å†›æ˜¯å¿ è¯šçš„ï¼Œé‚£ä¹ˆè¿™ä¸ªå®šä¹‰æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚ä½†æ˜¯ï¼Œå¦‚æœç¬¬iä¸ªå°†å†›æ˜¯å›å¾’ï¼Œé‚£ä¹ˆå°±æœ‰é—®é¢˜äº†ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºå›å¾’å¯ä»¥ä¸ºæ‰€æ¬²ä¸ºï¼Œä»–ä¸ºäº†æ‰°ä¹±æ•´ä¸ªä½œæˆ˜è®¡åˆ’çš„åˆ¶å®šï¼Œå®Œå…¨å¯èƒ½å‘ä¸åŒçš„å°†å†›ç»™å‡ºä¸åŒçš„ä½œæˆ˜æè®®ã€‚è¿™æ ·çš„è¯ï¼Œä¸åŒçš„å¿ è¯šå°†å†›æ”¶åˆ°çš„æ¥è‡ªç¬¬iä¸ªå°†å†›çš„v(i)å¯èƒ½æ˜¯ä¸åŒçš„å€¼ã€‚è¿™æ ·v(i)è¿™ä¸ªå®šä¹‰å°±ä¸å¯¹äº†ï¼Œå®ƒéœ€è¦æ”¹ä¸€æ”¹ã€‚\nä¸ç®¡æ€ä¹ˆæ ·ï¼Œå³ä½¿å­˜åœ¨å›å¾’ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›æ¯ä½å°†å†›æœ€ç»ˆæ˜¯åŸºäºå®Œå…¨ç›¸åŒçš„ä½œæˆ˜æè®®æ¥åšæ±‡æ€»ï¼Œè¿™äº›ä½œæˆ˜æè®®ä»ç„¶è®°ä¸ºv(1), v(2), â€¦, v(n)ã€‚ä¸è¿‡ï¼Œè¿™é‡Œçš„v(i)ä¸å†è¡¨ç¤ºæ¥è‡ªç¬¬iä¸ªå°†å†›çš„ä½œæˆ˜æè®®ï¼Œè€Œæ˜¯è¡¨ç¤ºç»è¿‡æˆ‘ä»¬è®¾è®¡çš„æŸä¸ªä¸€è‡´æ€§ç®—æ³•å¤„ç†ä¹‹åï¼Œæ¯ä½å°†å†›æœ€ç»ˆçœ‹åˆ°çš„ç¬¬iä¸ªæè®®ã€‚è¿™é‡Œéœ€è¦åˆ†ä¸¤ç§æƒ…å†µè®¨è®ºã€‚é¦–å…ˆç¬¬ä¸€ç§æƒ…å†µï¼Œå¦‚æœç¬¬iä¸ªå°†å†›æ˜¯å¿ è¯šçš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬è‡ªç„¶å¸Œæœ›è¿™ä¸ªv(i)å°±æ˜¯ç¬¬iä¸ªå°†å†›å‘é€å‡ºæ¥çš„ä½œæˆ˜æè®®ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›ç»è¿‡ä¸€è‡´æ€§ç®—æ³•å¤„ç†ä¹‹åï¼Œç¬¬iä¸ªå°†å†›å¦‚æœæ˜¯å¿ è¯šçš„ï¼Œé‚£ä¹ˆå®ƒçš„æè®®èƒ½å¤Ÿè¢«å¦‚å®åœ°ä¼ è¾¾ç»™å…¶ä»–å°†å†›ï¼Œè€Œä¸ä¼šè¢«å›å¾’çš„è¡Œä¸ºæ‰€å¹²æ‰°ã€‚è¿™æ˜¯å¯èƒ½åˆ¶å®šå‡ºã€Œåˆç†ã€ä½œæˆ˜è®¡åˆ’çš„å‰æã€‚ç¬¬äºŒç§æƒ…å†µï¼Œå¦‚æœç¬¬iä¸ªå°†å†›æ˜¯å›å¾’ï¼Œé‚£ä¹ˆä»–æœ‰å¯èƒ½å‘ä¸åŒçš„å°†å†›å‘é€ä¸åŒçš„æè®®ã€‚è¿™æ—¶å€™æˆ‘ä»¬ä¸èƒ½å¤Ÿåªå¬ä»–çš„ä¸€é¢ä¹‹è¯ï¼Œè€Œæ˜¯å¸Œæœ›ç»è¿‡ä¸€è‡´æ€§ç®—æ³•å¤„ç†ä¹‹åï¼Œå„ä¸ªå°†å†›ä¹‹é—´å……åˆ†äº¤æ¢æ„è§ï¼Œç„¶åæ ¹æ®å…¶ä»–å„ä¸ªå°†å†›è½¬è¿°çš„ä¿¡æ¯ï¼Œç»¼åˆåˆ¤æ–­å¾—åˆ°ä¸€ä¸ªv(i)ã€‚è¿™ä¸ªv(i)æ˜¯è¿›æ”»è¿˜æ˜¯æ’¤é€€ï¼Œå¹¶ä¸å¤ªé‡è¦ï¼Œå…³é”®æ˜¯è¦ä¿è¯æ¯ä½å°†å†›å¾—åˆ°çš„v(i)æ˜¯ç›¸åŒçš„ã€‚åªæœ‰è¿™æ ·ï¼Œå„ä½å°†å†›ç»è¿‡æ±‡æ€»æ‰€æœ‰çš„v(1), v(2), â€¦, v(n)ä¹‹åæ‰èƒ½å¾—åˆ°æœ€ç»ˆçš„å®Œå…¨ä¸€è‡´çš„ä½œæˆ˜è®¡åˆ’ã€‚\næ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨è¿™ä¸¤ç§æƒ…å†µä¸­ï¼Œæˆ‘ä»¬éƒ½åªéœ€è¦å…³æ³¨å•ä¸ªå°†å†›ï¼ˆä¹Ÿå°±æ˜¯ç¬¬iä¸ªå°†å†›ï¼‰æ‰€å‘å‡ºçš„æè®®å¦‚ä½•ä¼ è¾¾ç»™å…¶ä»–å°†å†›ã€‚é‡ç‚¹ç»ˆäºæ¥äº†ï¼è‡³æ­¤ï¼Œæˆ‘ä»¬å°±èƒ½å¤ŸæŠŠåŸæ¥çš„é—®é¢˜å½’çº¦åˆ°ä¸€ä¸ªå­é—®é¢˜ä¸Šã€‚è¿™ä¸ªå­é—®é¢˜ï¼Œæ‰æ˜¯Leslie Lamportåœ¨ä»–çš„è®ºæ–‡ä¸­è¢«çœŸæ­£å‘½åä¸ºã€Œæ‹œå åº­å°†å†›é—®é¢˜(Byzantine Generals Problem)ã€çš„é‚£ä¸ªé—®é¢˜ã€‚åœ¨è¿™ä¸ªé—®é¢˜ä¸­ï¼Œæˆ‘ä»¬åªå…³æ³¨å‘é€å‘½ä»¤çš„å•ä¸ªå°†å†›ï¼Œç§°ä»–ä¸ºä¸»å°†(commanding general)ï¼Œè€Œå…¶ä»–æ¥å—å‘½ä»¤çš„å°†å†›ç§°ä¸ºå‰¯å®˜(lieutenant)ã€‚ä¸‹é¢æ˜¯ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„ç²¾ç¡®æè¿°ã€‚\nä¸€ä¸ªä¸»å°†å‘é€å‘½ä»¤ç»™n-1ä¸ªå‰¯å®˜ï¼Œå¦‚ä½•æ‰èƒ½ç¡®ä¿ä¸‹é¢ä¸¤ä¸ªæ¡ä»¶ï¼š\n\n(IC1) æ‰€æœ‰å¿ è¯šçš„å‰¯å®˜æœ€ç»ˆéƒ½æ¥å—ç›¸åŒçš„å‘½ä»¤ã€‚\n(IC2) å¦‚æœä¸»å°†æ˜¯å¿ è¯šçš„ï¼Œé‚£ä¹ˆæ‰€æœ‰å¿ è¯šçš„å‰¯å®˜éƒ½æ¥å—ä¸»å°†å‘å‡ºçš„å‘½ä»¤ã€‚\n\nè¿™å…¶å®æ­£å¥½å¯¹åº”äº†æˆ‘ä»¬å‰é¢å·²ç»è®¨è®ºè¿‡çš„ä¸¤ç§æƒ…å†µã€‚å¦‚æœä¸»å°†æ˜¯å¿ è¯šçš„ï¼Œé‚£ä¹ˆæ¡ä»¶IC2ä¿è¯äº†å‘½ä»¤å¦‚å®åœ°ä¼ é€’ï¼Œè¿™æ—¶å€™æ¡ä»¶IC1è‡ªç„¶ä¹Ÿæ»¡è¶³äº†ï¼›å¦‚æœä¸»å°†æ˜¯å›å¾’ï¼Œé‚£ä¹ˆæ¡ä»¶IC2æ²¡æœ‰æ„ä¹‰äº†ï¼Œè€Œæ¡ä»¶IC1ä¿è¯äº†ï¼Œå³ä½¿å›å¾’ä¸»å°†å¯¹æ¯ä¸ªå‰¯å®˜å‘å‡ºä¸åŒçš„å‘½ä»¤ï¼Œæ¯ä¸ªå‰¯å®˜ä»ç„¶èƒ½æœ€ç»ˆè·å¾—ä¸€è‡´çš„å‘½ä»¤ã€‚\nè¿™é‡Œæœ‰ä¸¤ä¸ªåœ°æ–¹å¯èƒ½è®©äººäº§ç”Ÿç–‘æƒ‘ã€‚\nç¬¬ä¸€ï¼Œæœ‰äº›äººä¼šé—®äº†ï¼Œéš¾é“ä¸»å°†è¿˜èƒ½æ˜¯å›å¾’ï¼Ÿä¸»å°†éƒ½æ˜¯å›å¾’äº†ï¼Œè¿˜æœ‰å•¥æå¤´å•Šï¼Ÿå…¶å®æ˜¯è¿™æ ·çš„ï¼Œè¿™ä¸ªã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€åªæ˜¯åŸé—®é¢˜çš„ä¸€ä¸ªå­é—®é¢˜ã€‚å½“nä¸ªå°†å†›é€šè¿‡ä¼ é€’æ¶ˆæ¯æ¥å†³ç­–ä½œæˆ˜è®¡åˆ’çš„æ—¶å€™ï¼Œå¯ä»¥åˆ†è§£æˆnä¸ªã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ï¼Œå³åˆ†åˆ«ä»¥æ¯ä½å°†å†›ä½œä¸ºä¸»å°†ï¼Œä»¥å…¶ä½™n-1ä½å°†å†›ä½œä¸ºå‰¯å®˜ã€‚å¦‚æœæœ‰ä¸€ä¸ªç®—æ³•èƒ½å¤Ÿè§£å†³ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ï¼Œé‚£ä¹ˆåŒæ—¶è¿è¡Œnä¸ªç®—æ³•å®ä¾‹ï¼Œå°±èƒ½ä½¿å¾—æ¯ä½å°†å†›éƒ½è·å¾—å®Œå…¨ç›¸åŒçš„ä½œæˆ˜æè®®åºåˆ—ï¼Œå³å‰é¢æˆ‘ä»¬æåˆ°çš„v(1), v(2), â€¦, v(n)ã€‚æœ€åï¼Œæ¯ä½å°†å†›å°†v(1), v(2), â€¦, v(n)ä½¿ç”¨ç›¸åŒçš„æ–¹æ³•è¿›è¡Œæ±‡æ€»ï¼ˆæ¯”å¦‚æŒ‰å¤šæ•°æŠ•ç¥¨ï¼‰ï¼Œå°±èƒ½å¾—åˆ°æœ€ç»ˆçš„ä½œæˆ˜è®¡åˆ’ã€‚\nç¬¬äºŒï¼Œå½“ä¸»å°†æ˜¯å›å¾’çš„æ—¶å€™ï¼Œä»–å¯ä»¥å‘ä¸åŒçš„å‰¯å®˜å‘é€ä¸åŒçš„å‘½ä»¤ï¼Œæ€ä¹ˆå¯èƒ½æ¯ä¸ªå‰¯å®˜ä»ç„¶èƒ½æœ€ç»ˆè·å¾—ä¸€è‡´çš„å‘½ä»¤å‘¢ï¼Ÿè¿™æ­£æ˜¯ç®—æ³•éœ€è¦è§£å†³çš„ã€‚å…¶å®è¿™ä¹Ÿå®¹æ˜“è§£é‡Šï¼ˆæˆ‘ä»¬å‰é¢ä¹Ÿæåˆ°è¿‡è¿™ä¸ªæ€è·¯ï¼‰ï¼Œç”±äºä¸»å°†å¯èƒ½å‘ä¸åŒçš„å‰¯å®˜å‘é€ä¸åŒçš„å‘½ä»¤ï¼Œæ‰€ä»¥å‰¯å®˜ä¸èƒ½ç›´æ¥é‡‡ç”¨ä¸»å°†å‘æ¥çš„å‘½ä»¤ï¼Œè€Œæ˜¯ä¹Ÿè¦çœ‹çœ‹å…¶ä»–å‰¯å®˜è½¬è¿°æ¥çš„ä¸»å°†çš„å‘½ä»¤æ˜¯ä»€ä¹ˆã€‚ç„¶åï¼Œä¸€ä¸ªå‰¯å®˜ç»¼åˆäº†ç”±æ‰€æœ‰å‰¯å®˜è½¬è¿°çš„å‘½ä»¤ï¼ˆå†åŠ ä¸Šä¸»å°†ç›´æ¥å‘æ¥çš„å‘½ä»¤ï¼‰ä¹‹åï¼Œå°±å¯èƒ½å¾—åˆ°æ¯”è¾ƒå…¨é¢çš„ä¿¡æ¯ï¼Œä»è€Œåšå‡ºä¸€è‡´çš„åˆ¤æ–­ï¼ˆåœ¨å®é™…ä¸­æ˜¯ä¸ªä¸æ–­è¿­ä»£çš„è¿‡ç¨‹ï¼‰ã€‚\nå¥½äº†ï¼Œæˆ‘ä»¬ç”¨äº†è¿™ä¹ˆå¤šç¯‡å¹…ï¼Œç»ˆäºæŠŠã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€æœ¬èº«æè¿°æ¸…æ¥šäº†ã€‚è¿™å®é™…ä¸Šä¹Ÿæ˜¯æœ€éš¾çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬ä¸Šä¸€ç« æåˆ°è¿‡ï¼Œç†è§£é—®é¢˜æœ¬èº«æ¯”ç†è§£é—®é¢˜çš„ç­”æ¡ˆæ›´é‡è¦ã€‚åªè¦é—®é¢˜æœ¬èº«åˆ†ææ¸…æ¥šäº†ï¼Œå¦‚ä½•è®¾è®¡ä¸€ä¸ªèƒ½è§£å†³å®ƒçš„ç®—æ³•å°±åªæ˜¯ç»†èŠ‚é—®é¢˜äº†ã€‚æˆ‘ä»¬è¿™é‡Œä¸æ·±å…¥ç®—æ³•çš„ç»†èŠ‚äº†ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å»æŸ¥é˜…ä¸‹åˆ—è®ºæ–‡ï¼š\n\nã€ŠThe Byzantine Generals Problemã€‹ï¼Œä¸‹è½½åœ°å€ï¼šhttp://lamport.azurewebsites.net/pubs/byz.pdf\nã€ŠReaching Agreement in the Presence of Faultsã€‹ï¼Œä¸‹è½½åœ°å€ï¼šhttp://lamport.azurewebsites.net/pubs/reaching.pdf\n\næˆ‘ä»¬è¿™é‡Œåªæä¸€ä¸‹è®ºæ–‡ç»™å‡ºçš„ç®—æ³•çš„ç»“è®ºã€‚\nä½¿ç”¨ä¸åŒçš„æ¶ˆæ¯æ¨¡å‹ï¼Œã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€æœ‰ä¸åŒçš„è§£æ³•ã€‚\n\nå¦‚æœå°†å†›ä¹‹é—´ä½¿ç”¨å£å¤´æ¶ˆæ¯(oral messages)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯è¢«è½¬è¿°çš„æ—¶å€™æ˜¯å¯èƒ½è¢«ç¯¡æ”¹çš„ï¼Œé‚£ä¹ˆè¦å¯¹ä»˜mä¸ªå›å¾’ï¼Œéœ€è¦è‡³å°‘æœ‰3m+1ä¸ªå°†å†›ï¼ˆå…¶ä¸­è‡³å°‘2m+1ä¸ªå°†å†›æ˜¯å¿ è¯šçš„ï¼‰ã€‚\nå¦‚æœå°†å†›ä¹‹é—´ä½¿ç”¨ç­¾åæ¶ˆæ¯(signed messages)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ¶ˆæ¯è¢«å‘å‡ºæ¥ä¹‹åæ˜¯æ— æ³•ä¼ªé€ çš„ï¼Œåªè¦è¢«ç¯¡æ”¹å°±ä¼šè¢«å‘ç°ï¼Œé‚£ä¹ˆå¯¹ä»˜mä¸ªå›å¾’ï¼Œåªéœ€è¦è‡³å°‘m+2ä¸ªå°†å†›ï¼Œä¹Ÿå°±æ˜¯è¯´è‡³å°‘2ä¸ªå¿ è¯šçš„å°†å†›ï¼ˆå¦‚æœåªæœ‰1ä¸ªå¿ è¯šçš„å°†å†›ï¼Œæ˜¾ç„¶è¿™ä¸ªé—®é¢˜æ²¡æœ‰æ„ä¹‰ï¼‰ã€‚è¿™ç§æƒ…å†µå®é™…ç›¸å½“äºå¯¹å¿ è¯šå°†å†›çš„æ•°ç›®æ²¡æœ‰é™åˆ¶ã€‚\n\nå®¹é”™æ€§(fault tolerance)æˆ‘ä»¬å‰é¢æåˆ°è¿‡ï¼Œä»¥Paxosä¸ºä»£è¡¨çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œæ˜¯åœ¨å¯ä¿¡ä»»çš„ç¯å¢ƒä¸‹è¿è¡Œçš„ã€‚è€Œåœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¸­ï¼Œç½‘ç»œä¸­åˆ™å­˜åœ¨æ¶æ„èŠ‚ç‚¹ã€‚å› æ­¤æˆ‘ä»¬å¾ˆå®¹æ˜“äº§ç”Ÿä¸€ä¸ªæƒ³æ³•ï¼šPaxosæ˜¯ä¸æ˜¯ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€åœ¨å›å¾’æ•°ä¸ºé›¶æ—¶çš„ä¸€ä¸ªç‰¹ä¾‹è§£ï¼Ÿ\nè¿™æ ·çœ‹å…¶å®æœ‰ç‚¹é—®é¢˜ã€‚åœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¸­ï¼Œé™¤äº†å›å¾’ï¼Œå‰©ä¸‹çš„æ˜¯å¿ è¯šçš„å°†å†›ã€‚ã€Œå¿ è¯šã€è¿™ä¸ªè¯ï¼Œå…¶å®æš—å«äº†ä¸€ä¸ªæ„æ€ï¼šä»–æ˜¯èƒ½å¤Ÿæ­£å¸¸å·¥ä½œçš„ï¼ˆå³ä½ å¯ä»¥éšæ—¶é€šè¿‡æ¶ˆæ¯è·Ÿä»–è¿›è¡Œäº¤äº’ï¼‰ã€‚ä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Ÿæˆ‘ä»¬çŸ¥é“ï¼Œä¸€ä¸ªå›å¾’å¯ä»¥åšä»»ä½•äº‹ï¼ŒåŒ…æ‹¬å‘é€é”™è¯¯æ¶ˆæ¯ï¼Œä¹ŸåŒ…æ‹¬ä¸å‘é€ä»»ä½•æ¶ˆæ¯ã€‚ã€Œä¸å‘é€ä»»ä½•æ¶ˆæ¯ã€ï¼Œç›¸å½“äºä¸èƒ½æ­£å¸¸å·¥ä½œï¼Œæˆ–è€…è¯´ï¼Œå‘ç”Ÿäº†æŸç§æ•…éšœã€‚æ‰€ä»¥ï¼Œä¸ä»…ä»…æ˜¯æ•…æ„çš„æ¶æ„è¡Œä¸ºï¼Œå³ä½¿æ˜¯å•çº¯çš„æ•…éšœï¼Œä¹Ÿåº”è¯¥èƒ½å½’å…¥å›å¾’çš„è¡Œä¸ºã€‚è¿™åœ¨å…¶ä»–å°†å†›çœ‹æ¥æ²¡æœ‰åŒºåˆ«ã€‚\næŒ‰ç…§è¿™ç§ç†è§£ï¼Œã€Œå¿ è¯šã€è¿™ä¸ªè¯å¹¶ä¸æ˜¯å¾ˆæ°å½“ã€‚å›å¾’æ•°ä¸ºé›¶ï¼Œç›¸å½“äºç½‘ç»œä¸­æ¯ä¸ªèŠ‚ç‚¹éƒ½åœ¨æ­£å¸¸å·¥ä½œã€‚ä½†æ˜¯Paxosçš„è®¾è®¡ä¹Ÿæ˜¯èƒ½å¤Ÿå®¹é”™çš„ï¼Œå°±åƒæˆ‘ä»¬åœ¨å‰é¢è®¨è®ºçš„ä¸€æ ·ï¼Œç½‘ç»œä¸­çš„å°‘æ•°èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼ˆæ¯”å¦‚å®•æœºï¼‰ï¼ŒPaxosä»ç„¶èƒ½æ­£å¸¸å·¥ä½œã€‚å¯è§ï¼ŒPaxoså¹¶ä¸èƒ½çœ‹æˆæ˜¯ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€åœ¨å›å¾’æ•°ä¸ºé›¶æ—¶çš„ä¸€ä¸ªç‰¹ä¾‹è§£ã€‚\né‚£ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€å’ŒPaxosè¿™ç±»åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•çš„å…³ç³»åº”è¯¥å¦‚ä½•çœ‹å¾…å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»å®¹é”™æ€§çš„å¼ºå¼±ç¨‹åº¦ä¸Šæ¥åˆ†æã€‚\nä¸€èˆ¬æ¥è¯´ï¼Œè®¾è®¡ä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿï¼Œå°åˆ°ä¸€å—èŠ¯ç‰‡ï¼Œå¤§åˆ°ä¸€ä¸ªåˆ†å¸ƒå¼ç½‘ç»œï¼Œéƒ½éœ€è¦è€ƒè™‘ä¸€å®šçš„å®¹é”™æ€§(fault tolerance)ã€‚ä½†æ ¹æ®é”™è¯¯ä¸åŒçš„æ€§è´¨ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š\n\næ‹œå åº­é”™è¯¯(Byzantine fault)ã€‚è¿™ç§é”™è¯¯ï¼Œåœ¨ä¸åŒçš„è§‚å¯Ÿè€…çœ‹æ¥ï¼Œä¼šæœ‰å‰åä¸ä¸€è‡´çš„è¡¨ç°ã€‚\néæ‹œå åº­é”™è¯¯(non-Byzantine fault)ã€‚ä»å­—é¢æ„æ€çœ‹ï¼Œæ˜¯æŒ‡é‚£äº›ä¸å±äºå‰ä¸€ç±»é”™è¯¯çš„å…¶å®ƒé”™è¯¯ã€‚\n\nè¿™ä¸¤ç±»é”™è¯¯çš„å«ä¹‰å¹¶æ²¡æœ‰å­—é¢ä¸Šé‚£ä¹ˆå¥½ç†è§£ã€‚\nå…ˆè¯´è¯´æ‹œå åº­é”™è¯¯ã€‚åœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¸­ï¼Œå›å¾’çš„æ¶æ„è¡Œä¸ºå›ºç„¶æ˜¯å±äºè¿™ä¸€ç±»é”™è¯¯çš„ã€‚åœ¨ä¸åŒçš„å°†å†›çœ‹æ¥ï¼Œå›å¾’å¯èƒ½å‘é€å®Œå…¨ä¸ä¸€è‡´çš„ä½œæˆ˜æè®®ã€‚è€Œåœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œå‡ºç°æ•…éšœçš„èŠ‚ç‚¹æˆ–éƒ¨ä»¶ä¹Ÿå¯èƒ½è¡¨ç°å‡ºå‰åä¸ä¸€è‡´çš„è¡Œä¸ºï¼Œè™½ç„¶è¿™å¹¶éæ¶æ„ï¼Œä½†ä¹Ÿå±äºè¿™ä¸€ç±»é”™è¯¯ã€‚æ¯”å¦‚ä¿¡é“ä¸ç¨³å®šï¼Œå¯¼è‡´èŠ‚ç‚¹å‘é€ç»™å…¶å®ƒèŠ‚ç‚¹çš„æ¶ˆæ¯å‘ç”Ÿäº†éšæœºé”™è¯¯ï¼Œæˆ–è€…è¯´ï¼Œæ¶ˆæ¯æŸåäº†(corrupted)ã€‚å†æ¯”å¦‚ï¼Œåœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œcommitä¹‹åçš„æ•°æ®æ˜æ˜å·²ç»åŒæ­¥ç»™ç£ç›˜äº†ï¼ˆé€šè¿‡æ“ä½œç³»ç»Ÿçš„fsyncï¼‰ï¼Œä½†ç”±äºçªç„¶æ–­ç”µç­‰åŸå› ï¼Œæœ€ç»ˆæ•°æ®è¿˜æ˜¯æ²¡æœ‰çœŸæ­£è½ç›˜æˆåŠŸï¼Œç”šè‡³å‡ºç°æ•°æ®é”™ä¹±ã€‚\nå†çœ‹ä¸€ä¸‹éæ‹œå åº­é”™è¯¯ã€‚Lamportåœ¨ä»–å…³äºPaxosçš„ä¸€ç¯‡è®ºæ–‡ä¸­ä¹Ÿä½¿ç”¨äº†non-Byzantineè¿™ä¸ªè¯ï¼ˆè§ã€ŠPaxos Made Simpleã€‹ï¼‰ã€‚ä½†æ˜¯è¿™ä¸ªè¯çš„å‘½åçš„ç¡®è®©äººæœ‰ç‚¹ä¸å¥½ç†è§£ã€‚åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¦‚æœèŠ‚ç‚¹å®•æœºäº†ï¼Œæˆ–è€…ç½‘ç»œä¸é€šäº†ï¼Œéƒ½ä¼šå¯¼è‡´æŸäº›èŠ‚ç‚¹ä¸èƒ½å·¥ä½œã€‚å…¶å®ƒèŠ‚ç‚¹å…¶å®æ²¡æ³•åŒºåˆ†è¿™ä¸¤ç§æƒ…å†µï¼Œåœ¨å®ƒçœ‹æ¥ï¼Œåªæ˜¯å‘ç°æŸä¸ªèŠ‚ç‚¹æš‚æ—¶è”ç³»ä¸ä¸Šäº†ï¼ˆå³æ¥æ”¶æ¶ˆæ¯è¶…æ—¶äº†ï¼‰ã€‚è‡³äºæ˜¯å› ä¸ºé‚£ä¸ªèŠ‚ç‚¹æœ¬èº«å‡ºé—®é¢˜äº†ï¼Œè¿˜æ˜¯ç½‘ç»œä¸é€šäº†ï¼Œæˆ–è€…æ˜¯æ¶ˆæ¯å‡ºç°äº†ä¸¥é‡çš„å»¶è¿Ÿï¼Œæ˜¯æ— æ³•åŒºåˆ†çš„ã€‚è€Œä¸”ï¼Œè¿‡ä¸€ä¼šä¹‹åï¼ŒèŠ‚ç‚¹å¯èƒ½ä¼šé‡æ–°æ¢å¤ï¼ˆæˆ–æ˜¯è‡ªå·±æ¢å¤äº†ï¼Œæˆ–ç»è¿‡äº†äººå·¥å¹²é¢„ï¼‰ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºå‡ºç°è¿™ç§é”™è¯¯çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬åªæ˜¯æ”¶ä¸åˆ°å®ƒçš„æ¶ˆæ¯äº†ï¼Œè€Œä¸ä¼šæ”¶åˆ°æ¥è‡ªå®ƒçš„é”™è¯¯æ¶ˆæ¯ã€‚ç›¸åï¼Œåªè¦æ”¶åˆ°äº†æ¥è‡ªå®ƒçš„æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ¶ˆæ¯æœ¬èº«æ˜¯ã€Œå¿ å®ã€çš„ã€‚\nå¯è§ï¼Œæ‹œå åº­é”™è¯¯æ˜¯æ›´å¼ºçš„ä¸€ç±»é”™è¯¯ã€‚åœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¸­ï¼Œå›å¾’å‘é€å‰åä¸ä¸€è‡´çš„ä½œæˆ˜æè®®ï¼Œå±äºæ‹œå åº­é”™è¯¯ï¼›è€Œä¸å‘é€ä»»ä½•æ¶ˆæ¯ï¼Œå±äºéæ‹œå åº­é”™è¯¯ã€‚æ‰€ä»¥ï¼Œè§£å†³ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„ç®—æ³•ï¼Œæ—¢èƒ½å¤„ç†æ‹œå åº­é”™è¯¯ï¼Œåˆèƒ½å¤„ç†éæ‹œå åº­é”™è¯¯ã€‚è¿™å¬èµ·æ¥ç¨å¾®æœ‰äº›å¥‡æ€ªï¼Œä¸è¿‡è¿™åªæ˜¯å‘½åå¸¦æ¥çš„é—®é¢˜ã€‚\næ€»ä¹‹ï¼Œã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„è§£æ³•åº”è¯¥æ˜¯æœ€å¼ºçš„ä¸€ç±»åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ï¼Œå®ƒç†è®ºä¸Šèƒ½å¤Ÿå¤„ç†ä»»ä½•é”™è¯¯ã€‚è€ŒPaxosåªèƒ½å¤„ç†éæ‹œå åº­é”™è¯¯ã€‚é€šå¸¸æŠŠèƒ½å¤Ÿå¤„ç†æ‹œå åº­é”™è¯¯çš„è¿™ç§å®¹é”™æ€§ç§°ä¸ºã€ŒByzantine fault toleranceã€ï¼Œç®€ç§°ä¸ºBFTã€‚\nè¿™æ ·è¯´æ¥ï¼ŒBFTçš„ç®—æ³•åº”è¯¥å¯ä»¥è§£å†³ä»»ä½•é”™è¯¯ä¸‹çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜ï¼Œä¹ŸåŒ…æ‹¬Paxosæ‰€è§£å†³çš„é—®é¢˜ã€‚é‚£ä¸ºä»€ä¹ˆä¸ç»Ÿä¸€ä½¿ç”¨BFTçš„ç®—æ³•æ¥è§£å†³æ‰€æœ‰çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§é—®é¢˜å‘¢ï¼Ÿä¸ºä»€ä¹ˆè¿˜éœ€è¦å†è´¹åŠ›æ°”è®¾è®¡Paxosä¹‹ç±»çš„ä¸€äº›ç®—æ³•å‘¢ï¼Ÿæˆ‘ä»¬å‰é¢æ²¡æœ‰ä»”ç»†è®¨è®ºè§£å†³ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„ç®—æ³•ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿä¸åšä»”ç»†çš„åˆ†æäº†ã€‚ä½†å®¹æ˜“æƒ³è±¡çš„æ˜¯ï¼Œæä¾›BFTè¿™ä¹ˆå¼ºçš„é”™è¯¯å®¹å¿æ€§ï¼Œè‚¯å®šéœ€è¦ä»˜å‡ºå¾ˆé«˜çš„ä»£ä»·ã€‚æ¯”å¦‚éœ€è¦æ¶ˆæ¯çš„å¤§é‡ä¼ é€’ã€‚è€ŒPaxosä¸éœ€è¦æä¾›é‚£ä¹ˆå¼ºçš„å®¹é”™æ€§ï¼Œå› æ­¤å¯ä»¥æ¯”è¾ƒé«˜æ•ˆåœ°è¿è¡Œã€‚å¦å¤–ï¼Œå…·ä½“åˆ°Lamportåœ¨è®ºæ–‡ä¸­ç»™å‡ºçš„è§£å†³ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„ç®—æ³•ï¼Œå®ƒè¿˜å¯¹ç³»ç»Ÿçš„è®°æ—¶å‡è®¾(timing assumption)æœ‰æ›´å¼ºçš„è¦æ±‚ã€‚è¿™ä¹Ÿå®¹æ˜“ç†è§£ï¼Œæ—¢ç„¶ç®—æ³•çš„å®¹é”™æ€§è¦æ±‚è¿™ä¹ˆé«˜ï¼Œè‡ªç„¶å¯¹äºè¿è¡Œç¯å¢ƒçš„å‡è®¾(assumption)ä¹Ÿæœ‰å¯èƒ½è¦é«˜ä¸€ç‚¹ã€‚ç”±äºè¿™ä¸ªé—®é¢˜æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¸€ä¸ªæŒºå…³é”®çš„é—®é¢˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œå•ç‹¬æ‹¿å‡ºæ¥è®¨è®ºä¸€ä¸‹ã€‚åœ¨Lamportåœ¨è®ºæ–‡ä¸­ï¼Œç®—æ³•å¯¹äºç³»ç»Ÿçš„å‡è®¾æœ‰è¿™ä¹ˆä¸€æ¡ï¼š\n\nThe absence of a message can be detected.\n\nè¿™æ¡å‡è®¾è¦æ±‚ï¼Œå¦‚æœæŸä½å›å¾’å°†å†›æ²¡æœ‰å‘é€ä»»ä½•æ¶ˆæ¯ï¼ˆå½“ç„¶ä¹Ÿå¯èƒ½æ˜¯æ¶ˆæ¯ä¸¢å¤±äº†ï¼‰ï¼Œé‚£ä¹ˆè¿™ä»¶äº‹æ˜¯å¯ä»¥æ£€æµ‹å‡ºæ¥çš„ã€‚æ˜¾ç„¶ï¼Œè¿™åªèƒ½ä¾èµ–æŸç§è¶…æ—¶æœºåˆ¶(time-out)ï¼Œä¾èµ–èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é’Ÿè¾¾åˆ°ä¸€å®šç¨‹åº¦çš„åŒæ­¥ï¼Œå³æ—¶é’Ÿçš„åç§»ä¸èƒ½è¶…è¿‡ä¸€ä¸ªæœ€å¤§å€¼ã€‚è¿™å®é™…ä¸Šæ˜¯ä¸€ç§åŒæ­¥æ¨¡å‹(synchronous model)ã€‚è€ŒPaxosçš„ç³»ç»Ÿå‡è®¾åœ¨è¿™ä¸€ç‚¹ä¸Šå°±æ²¡æœ‰è¿™ä¹ˆå¼ºï¼Œå®ƒæ˜¯åŸºäºå¼‚æ­¥æ¨¡å‹(asynchronous model)ï¼Œå¯¹ç³»ç»Ÿæ—¶é’Ÿæ²¡æœ‰ç‰¹å®šçš„è¦æ±‚ã€‚æˆ‘åœ¨ä¹‹å‰çš„å¦ä¸€ç¯‡æ–‡ç« ã€ŠåŸºäºRedisçš„åˆ†å¸ƒå¼é”åˆ°åº•å®‰å…¨å—ï¼Ÿã€‹ä¸€æ–‡ä¸­ä¹Ÿæœ‰æåˆ°è¿‡è¿™ä¸ªé—®é¢˜ã€‚è¿™æœ‰æ—¶å€™ä¼šæˆä¸ºä¸€äº›åˆ†å¸ƒå¼ç®—æ³•äº§ç”Ÿäº‰è®®çš„æ ¹æºã€‚\nå…·ä½“æ¥è¯´ï¼Œæ ¹æ®Paxosçš„è®ºæ–‡æ‰€è¯´ï¼ŒPaxosçš„è®¾è®¡æ˜¯åŸºäºå¼‚æ­¥(asynchronous)ã€éæ‹œå åº­(non-Byzantine)çš„ç³»ç»Ÿæ¨¡å‹ï¼Œå³ï¼š\n\nèŠ‚ç‚¹å¯ä»¥ä»¥ä»»æ„é€Ÿåº¦è¿è¡Œï¼Œå¯èƒ½å®•æœºã€é‡å¯ã€‚ä½†æ˜¯ï¼Œç®—æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦è®°å½•çš„ä¸€äº›å˜é‡ï¼Œåœ¨é‡å¯ååº”è¯¥èƒ½å¤Ÿæ¢å¤ã€‚\næ¶ˆæ¯å¯ä»¥å»¶è¿Ÿä»»æ„é•¿æ—¶é—´ï¼Œå¯ä»¥é‡å¤(duplicated)ï¼Œå¯ä»¥ä¸¢å¤±(lost)ï¼Œä½†ä¸èƒ½æŸå(corrupted)ã€‚\n\nä¸Šé¢ç¬¬ä¸€æ¡å…¶å®æ˜¯è¦æ±‚æ•°æ®åœ¨æ•°æ®åº“ä¸­æŒä¹…åŒ–ï¼Œå¹¶ä¸”è¦ä¿è¯åœ¨è½ç›˜è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿæ‹œå åº­é”™è¯¯ï¼ˆæˆ‘ä»¬å‰é¢åˆšæåˆ°è¿‡ï¼‰ã€‚ä½†å®é™…ä¸­ç”±äºçªç„¶æ–­ç”µã€ç£ç›˜ç¼“å­˜ç­‰ç°å®é—®é¢˜ï¼Œæ‹œå åº­é”™è¯¯æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ï¼ˆè™½ç„¶æ¦‚ç‡å¾ˆä½ï¼‰ï¼Œæ‰€ä»¥è¿™å°±è¦æ±‚å·¥ç¨‹ä¸Šåšä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚\nä¸Šé¢ç¬¬äºŒæ¡ï¼Œæ¶ˆæ¯æŸåï¼Œå±äºæ‹œå åº­é”™è¯¯ã€‚æ‰€ä»¥Paxosè¦æ±‚ä¸èƒ½æœ‰æ¶ˆæ¯æŸåå‘ç”Ÿã€‚è¿™åœ¨ä½¿ç”¨TCPåè®®è¿›è¡Œæ¶ˆæ¯ä¼ è¾“çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯èƒ½å¤Ÿæ»¡è¶³è¦æ±‚çš„ã€‚\nç»¼ä¸Šåˆ†æï¼Œè§£å†³ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„ç®—æ³•ï¼Œæä¾›äº†æœ€å¼ºçš„å®¹é”™æ€§ï¼Œå³BFTï¼Œè€ŒPaxosåªèƒ½å®¹å¿éæ‹œå åº­é”™è¯¯ã€‚ä½†æ˜¯ï¼Œåœ¨åªæœ‰éæ‹œå åº­é”™è¯¯å‡ºç°çš„å‰æä¸‹ï¼ŒPaxosåŸºäºå¼‚æ­¥æ¨¡å‹ï¼Œæ˜¯æ¯”åŒæ­¥æ¨¡å‹æ›´å¼±çš„ç³»ç»Ÿå‡è®¾ï¼Œå› æ­¤ç®—æ³•æ›´é²æ£’ã€‚å½“ç„¶ï¼ŒPaxosä¹Ÿæ›´é«˜æ•ˆã€‚\nåŒºå—é“¾åœ¨ç°å®ä¸­ï¼ŒçœŸæ­£éœ€è¦è¾¾åˆ°BFTå®¹é”™æ€§çš„ç³»ç»Ÿå¾ˆå°‘ï¼Œé™¤éæ˜¯ä¸€äº›å®¹é”™æ€§è¦æ±‚éå¸¸é«˜çš„ç³»ç»Ÿï¼Œæ¯”å¦‚æ³¢éŸ³é£æœºä¸Šçš„æ§åˆ¶ç³»ç»Ÿï¼Œæˆ–è€…SpaceX Dragonå¤ªç©ºèˆ¹è¿™ç±»ç³»ç»Ÿï¼ˆå‚è§https://www.weusecoins.com/bitcoin-byzantine-generals-problem/ï¼‰ã€‚\næˆ‘ä»¬å¹³å¸¸èƒ½æ¥è§¦åˆ°çš„BFTçš„ä¸€ä¸ªå…¸å‹çš„ä¾‹å­ï¼Œå°±æ˜¯åŒºå—é“¾äº†ã€‚ä¸€ä¸ªåŒºå—é“¾ç½‘ç»œæ˜¯ä¸€ä¸ªå®Œå…¨å¼€æ”¾çš„ç½‘ç»œï¼Œå…¶ä¸­çš„çŸ¿å·¥èŠ‚ç‚¹(miner)æ˜¯å¯ä»¥è‡ªç”±åŠ å…¥å’Œè‡ªç”±é€€å‡ºçš„ã€‚è¿™äº›èŠ‚ç‚¹å½“ç„¶æœ‰å¯èƒ½æ˜¯æ¶æ„çš„ï¼Œæ‰€ä»¥åŒºå—é“¾ç½‘ç»œåœ¨è®¾è®¡çš„æ—¶å€™å¿…é¡»è¦è€ƒè™‘è¿™ä¸ªé—®é¢˜ã€‚è¿™å®é™…ä¸Šå°±æ˜¯å…¸å‹çš„ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ã€‚\næ¥ä¸‹æ¥ä¸ºäº†å°†åŒºå—é“¾ä¸ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¹‹é—´çš„è”ç³»è®¨è®ºå¾—æ›´åŠ æ¸…æ¥šï¼Œæˆ‘ä»¬å…ˆæ¥éå¸¸ç²—ç•¥åœ°ä»‹ç»ä¸€ä¸‹åŒºå—é“¾æŠ€æœ¯ã€‚\nä»¥æ¯”ç‰¹å¸ç½‘ç»œä¸ºä¾‹ï¼Œå®ƒçš„æ ¸å¿ƒæ“ä½œå°±æ˜¯è¿›è¡Œæ¯”ç‰¹å¸äº¤æ˜“ï¼Œå³æŸä¸ªæ¯”ç‰¹å¸çš„æ‹¥æœ‰è€…å°†è‡ªå·±ä¸€å®šæ•°é‡çš„æ¯”ç‰¹å¸è½¬ç§»ç»™å…¶ä»–äººã€‚é¦–å…ˆï¼Œæ¯”ç‰¹å¸çš„æ‹¥æœ‰è€…è¦å‘èµ·äº¤æ˜“(transaction)ï¼Œä»–éœ€è¦å…ˆç”¨è‡ªå·±çš„ç§é’¥å¯¹äº¤æ˜“è¿›è¡Œç­¾åï¼Œç„¶åå°†äº¤æ˜“è¯·æ±‚å‘ç»™çŸ¿å·¥èŠ‚ç‚¹ã€‚çŸ¿å·¥å°†æ”¶åˆ°çš„æ‰€æœ‰äº¤æ˜“æ‰“åŒ…åˆ°ä¸€ä¸ªåŒºå—(block)å½“ä¸­ï¼Œå¹¶é€šè¿‡ä¸€ç³»åˆ—å¤æ‚åº¦å¾ˆé«˜çš„è¿ç®—æ‰¾åˆ°ä¸€ä¸ªnonceå€¼ï¼Œä¿è¯å¯¹äºå®ƒå’ŒåŒºå—å†…å…¶å®ƒä¿¡æ¯è¿›è¡Œhashè®¡ç®—åçš„ç»“æœèƒ½å¤Ÿç¬¦åˆé¢„å®šçš„è¦æ±‚ã€‚è¿™ä¸€æ­¥å¯¹äºæ•´ä¸ªåŒºå—é“¾ç½‘ç»œè‡³å…³é‡è¦ï¼Œè¢«ç§°ä¸ºå·¥ä½œé‡è¯æ˜(Proof of Work)ã€‚ç„¶åçŸ¿å·¥æŠŠè¯¥åŒºå—åœ¨å…¨ç½‘å‘å¸ƒï¼Œç”±å…¶å®ƒçŸ¿å·¥æ¥éªŒè¯è¿™ä¸ªåŒºå—ã€‚è¿™ä¸ªéªŒè¯æ—¢åŒ…æ‹¬å¯¹äº¤æ˜“ç­¾åè¿›è¡ŒéªŒè¯ï¼ˆä½¿ç”¨æ¯”ç‰¹å¸æ‹¥æœ‰è€…çš„å…¬é’¥ï¼‰ï¼Œä¹ŸåŒ…æ‹¬å¯¹å·¥ä½œé‡è¯æ˜çš„æœ‰æ•ˆæ€§è¿›è¡ŒéªŒè¯ã€‚å¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±æŠŠè¿™ä¸ªåŒºå—æŒ‚åœ¨å½“å‰æœ€é•¿çš„åŒºå—é“¾ä¸Šã€‚\nå¦‚æœä¸¤ä¸ªçŸ¿å·¥å‡ ä¹åŒæ—¶å®Œæˆäº†åŒºå—çš„æ‰“åŒ…å’Œå·¥ä½œé‡è¯æ˜ï¼Œå®ƒä»¬å¯èƒ½éƒ½ä¼šå°†åŒºå—è¿›è¡Œå‘å¸ƒï¼Œè¿™æ—¶åŒºå—é“¾å°±ä¼šåˆ†å‰(fork)ã€‚ä½†çŸ¿å·¥ä»¬ä¼šä¸åœåœ°äº§ç”Ÿæ–°åŒºå—ï¼Œå¹¶å°†æ–°åŒºå—æŒ‚åœ¨å½“å‰æœ€é•¿çš„åŒºå—é“¾ä¸Šï¼Œæ‰€ä»¥æœ€ç»ˆå“ªä¸ªåˆ†å‰å˜å¾—æ›´é•¿ï¼Œå“ªä¸ªåˆ†å‰å°±ä¼šè¢«å¤šæ•°çŸ¿å·¥èŠ‚ç‚¹æ‰¿è®¤ã€‚è¿™ä¹ˆçœ‹æ¥ï¼ŒåŒºå—é“¾å…¶å®ä¸æ˜¯ä¸€ä¸ªé“¾ï¼Œè€Œæ˜¯ä¸€æ£µæ ‘ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ ‘è¿™ç§æ•°æ®ç»“æ„ä¸­ï¼Œä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹åªæœ‰å”¯ä¸€çš„ä¸€æ¡è·¯å¾„ã€‚å› æ­¤ï¼Œå½“å‰æœ‰æ•ˆçš„åŒºå—é“¾å…¶å®æ˜¯è¿™æ£µæ ‘ä¸­ä»æ ¹èŠ‚ç‚¹åˆ°å¶å­èŠ‚ç‚¹æœ€é•¿çš„é‚£æ¡è·¯å¾„ã€‚åªè¦ä¸€ä¸ªåŒºå—åœ¨æœ€é•¿çš„é“¾ä¸Šï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯æœ‰æ•ˆçš„ï¼Œå®ƒé‡Œé¢åŒ…å«çš„æ‰€æœ‰äº¤æ˜“å°±è¢«å›ºåŒ–ä¸‹æ¥äº†ï¼ˆè¢«å¤šæ•°èŠ‚ç‚¹æ‰¿è®¤ï¼‰ã€‚\næˆ‘ä»¬åªæ˜¯éå¸¸ç²—ç•¥åœ°ä»‹ç»äº†ä¸€ä¸‹åŒºå—é“¾çš„å·¥ä½œåŸç†ã€‚å¦‚æœæƒ³äº†è§£ç»†èŠ‚ï¼Œå»ºè®®ç ”ç©¶ä¸€ä¸‹ä»¥å¤ªåŠçš„å®˜æ–¹wikiï¼Œåœ°å€æ˜¯ï¼š\n\nhttps://github.com/ethereum/wiki/wiki\n\nä¸‹é¢æˆ‘ä»¬å¼€å§‹è®¨è®ºåŒºå—é“¾æŠ€æœ¯ä¸ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„å…³è”ã€‚\nå‰é¢æˆ‘ä»¬è®¨è®ºã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„æ—¶å€™ï¼Œå¾—åˆ°è¿‡ä»¥ä¸‹ç»“è®ºï¼š\n\nå¦‚æœä½¿ç”¨å£å¤´æ¶ˆæ¯ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦å¤šäº2/3çš„å°†å†›æ˜¯å¿ è¯šçš„ã€‚\nå¦‚æœä½¿ç”¨ç­¾åæ¶ˆæ¯ï¼Œé‚£ä¹ˆå¯¹å¿ è¯šå°†å†›çš„æ•°é‡æ˜¯æ²¡æœ‰è¦æ±‚çš„ã€‚\n\næ ¹æ®å‰é¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬åœ¨åŒºå—é“¾ä¸­ä½¿ç”¨çš„æ¶ˆæ¯åº”è¯¥å±äºç­¾åæ¶ˆæ¯ã€‚å…·ä½“ä½“ç°åœ¨ï¼šæ¯ä¸€ä¸ªåŒºå—ä¸­çš„äº¤æ˜“éƒ½è¿›è¡Œäº†ç­¾åï¼Œä¿è¯æ— æ³•è¢«ç¯¡æ”¹ï¼Œä¹Ÿèƒ½ä¿è¯è¿™ä¸ªæ¶ˆæ¯åªèƒ½æ˜¯ç”±æœ€åˆçš„å‘èµ·è€…å‘å‡ºçš„ã€‚é‚£ä¹ˆï¼Œè¿™å±äºä¸Šè¿°ç¬¬äºŒç§æƒ…å†µï¼Œéš¾é“è¯´åŒºå—é“¾ç½‘ç»œä¸­å¿ è¯šèŠ‚ç‚¹çš„æ•°ç›®æ²¡æœ‰è¦æ±‚ï¼Ÿæ˜¾ç„¶ä¸æ˜¯è¿™æ ·ã€‚æ¯”å¦‚åœ¨æ¯”ç‰¹å¸ç½‘ç»œä¸­ï¼Œè¦æ±‚æ¶æ„èŠ‚ç‚¹ä¸èƒ½æŒæ¡å¤šäº50%çš„ç®—åŠ›ã€‚ä¸ºä»€ä¹ˆä¸¤è€…ä¹‹é—´ä¼¼ä¹ä¸ä¸€è‡´å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€åªæ˜¯å…³æ³¨ä¸€ä¸ªå­é—®é¢˜ï¼Œå®ƒå…³æ³¨çš„æ˜¯å…¶ä¸­ä¸€ä¸ªå°†å†›ï¼ˆç§°ä¸ºä¸»å°†ï¼‰å‘å…¶ä»–æ‰€æœ‰å°†å†›ï¼ˆç§°ä¸ºå‰¯å®˜ï¼‰å‘é€å‘½ä»¤çš„æƒ…å†µã€‚è€Œæœ€ç»ˆå¯¹æ‰€æœ‰å‘½ä»¤è¿›è¡Œæ±‡æ€»åˆ™è¦æ±‚æ‰€æœ‰å¿ è¯šçš„å°†å†›è¾¾æˆå…±è¯†ã€‚å¦‚æœå¿ è¯šçš„å°†å†›æ•°ç›®å¤ªå°‘ï¼Œä¸ç®¡æœ€ç»ˆç¡®å®šçš„ä½œæˆ˜è®¡åˆ’æ˜¯ä»€ä¹ˆï¼Œè¿˜æ˜¯ä¼šå¤±è´¥ï¼Œå› ä¸ºå›å¾’å¯èƒ½ä¸æ‰§è¡Œè¿™ä¸ªä½œæˆ˜è®¡åˆ’ã€‚è¿™ç±»ä¼¼äºæ¯”ç‰¹å¸ç½‘ç»œä¸­çš„æƒ…å†µï¼Œå…¶ä¸­å¯¹äºæœ€é•¿é“¾çš„é€‰æ‹©è¿‡ç¨‹ï¼Œå°±ç›¸å½“äºå°†å†›ä»¬å¯¹æ‰€æœ‰å‘½ä»¤è¿›è¡Œæ±‡æ€»çš„æ“ä½œï¼ˆæŒ‰å¤šæ•°æŠ•ç¥¨ï¼‰ã€‚\nåœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€ä¸­ï¼Œä¸€ä¸ªå›å¾’å¯èƒ½å‘ä¸åŒçš„å°†å†›å‘é€ä¸ä¸€è‡´çš„å‘½ä»¤ã€‚å¦‚æœç®—æ³•è®¾è®¡å¾—ä¸å¥½ï¼Œå°±å¯èƒ½é€ æˆæœ€ç»ˆæ— æ³•è¾¾æˆä¸€è‡´ã€‚åœ¨åŒºå—é“¾ç½‘ç»œä¸­ï¼Œç±»ä¼¼çš„è¡Œä¸ºå°†ä¼šæˆæœ¬å¾ˆé«˜ã€‚è¿™æ˜¯ç”±äºçŸ¿å·¥èŠ‚ç‚¹å‘å¸ƒåŒºå—çš„æ¶ˆæ¯å¿…é¡»ç»è¿‡å·¥ä½œé‡è¯æ˜ï¼Œå®ƒå¦‚æœå‘å¸ƒä¸ä¸€è‡´çš„åŒºå—ï¼Œæ¯ä¸ªåŒºå—éƒ½éœ€è¦å·¥ä½œé‡è¯æ˜ï¼Œè¿™å°†è€—è´¹å®ƒå¤§é‡çš„ç®—åŠ›ã€‚å¦å¤–ï¼Œè¿™æ ·åšä¹Ÿæ²¡æœ‰åŠ¨æœºï¼Œå®ƒåªä¼šäº§ç”Ÿæ›´å¤šåˆ†å‰ï¼Œä¸ä¼šäº§ç”Ÿæœ€é•¿é“¾ã€‚\nåœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„æ¡†æ¶ä¸‹ï¼Œå¦‚ä½•çœ‹å¾…å·¥ä½œé‡è¯æ˜å‘¢ï¼Ÿå®ƒå…¶å®ç›¸å½“äºæé«˜äº†åšå›å¾’çš„æˆæœ¬ï¼Œä»è€Œæå¤§é™ä½äº†å›å¾’è¶…è¿‡åŠæ•°çš„å¯èƒ½æ€§ã€‚è¿™é‡Œå¯ä»¥åšä¸€ä¸ªå¯¹æ¯”ï¼Œå‡è®¾å†å²ä¸Šå­˜åœ¨çœŸå®çš„æ‹œå åº­å°†å†›é—®é¢˜ï¼Œé‚£ä¹ˆå¯ä»¥æƒ³è±¡ï¼Œæ•Œå†›çš„é—´è°æ‰“å…¥æ‹œå åº­å°†å†›è¿™ä¸ªç¾¤ä½“ä¸­çš„æˆæœ¬åº”è¯¥æ˜¯å¾ˆé«˜çš„ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è®¤ä¸ºå°†å†›ä¸­çš„å›å¾’ä¸è‡³äºå¤ªå¤šã€‚ä½†å¯¹åº”åˆ°è®¡ç®—æœºç½‘ç»œä¸­ï¼Œå¦‚æœæ²¡æœ‰ç±»ä¼¼å·¥ä½œé‡è¯æ˜çš„æœºåˆ¶ï¼Œé‚£ä¹ˆæˆä¸ºå›å¾’çŸ¿å·¥çš„æˆæœ¬å°±æ˜¯éå¸¸ä½çš„ã€‚è¿™å°±å¾ˆæœ‰å¯èƒ½ä½¿å¾—å›å¾’æ¯”å¿ è¯šçš„çŸ¿å·¥è¿˜è¦æ›´å¤šã€‚\nå½“ç„¶ï¼Œä»ç»æµå­¦çš„è§’åº¦çœ‹ï¼Œåœ¨éœ€è¦å·¥ä½œé‡è¯æ˜çš„å‰æä¸‹ï¼Œæˆä¸ºå›å¾’çŸ¿å·¥ä¹Ÿæ˜¯ä¸æ˜æ™ºçš„ã€‚å› ä¸ºå®ƒæ—¢ç„¶æ‹¥æœ‰æ¯”è¾ƒå¼ºçš„ç®—åŠ›ï¼Œè¿˜ä¸å¦‚æŒ‰ç…§åˆç†çš„æ–¹å¼é€šè¿‡æŒ–çŸ¿èµšå–æ”¶ç›Šæ›´ä¸ºç¨³å¦¥ã€‚ä¸è¿‡è¿™æ˜¯æŠ€æœ¯ä¹‹å¤–çš„å› ç´ äº†ã€‚\né™¤äº†å·¥ä½œé‡è¯æ˜è¿™ç§æœºåˆ¶(Proof of Work)ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§è¢«ç§°ä¸ºProof of Stakeçš„æœºåˆ¶ã€‚è™½ç„¶æœ‰äººè´¨ç–‘è¿™ç§æœºåˆ¶å­˜åœ¨ç¼ºç‚¹(æ¯”å¦‚nothing at stake)ï¼Œä½†ç«™åœ¨ã€Œæ‹œå åº­å°†å†›é—®é¢˜ã€çš„è§’åº¦ï¼Œå®ƒä¹Ÿæ˜¯ç›¸å½“äºæé«˜äº†åšå›å¾’çš„æˆæœ¬ã€‚è¿™å°±å¥½æ¯”ä¸€ä¸ªé—´è°è¦æ··å…¥è‘£äº‹ä¼šï¼Œæˆæœ¬è‚¯å®šæ˜¯æ¯”è¾ƒé«˜çš„ï¼Œå› ä¸ºä»–éœ€è¦é¦–å…ˆæŒæœ‰å¤§é‡è‚¡ç¥¨ã€‚\nåŒºå—é“¾åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿæœ‰äººè¯´æ˜¯ä¸ªæ— æ³•ç¯¡æ”¹çš„è¶…çº§è´¦æœ¬ï¼Œä¹Ÿæœ‰äººè¯´æ˜¯ä¸ªå»ä¸­å¿ƒåŒ–çš„äº¤æ˜“ç³»ç»Ÿï¼Œè¿˜æœ‰äººè¯´å®ƒæ˜¯æ„å»ºæ•°å­—è´§å¸çš„åº•å±‚å·¥å…·ã€‚ä½†æ˜¯ï¼Œä»æŠ€æœ¯çš„è§’åº¦æ¥è¯´ï¼Œå®ƒé¦–å…ˆæ˜¯ä¸ªè§£å†³äº†æ‹œå åº­å°†å†›é—®é¢˜çš„åˆ†å¸ƒå¼ç½‘ç»œï¼Œåœ¨å®Œå…¨å¼€æ”¾çš„ç¯å¢ƒä¸­ï¼Œå®ç°äº†æ•°æ®çš„ä¸€è‡´æ€§å’Œå®‰å…¨æ€§ã€‚è€Œå…¶å®ƒçš„å±æ€§ï¼Œéƒ½é™„ç€äºè¿™ä¸€æŠ€æœ¯æœ¬è´¨ä¹‹ä¸Šã€‚\n","categories":["åˆ†å¸ƒå¼"]},{"title":"åˆ°åº•ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§ï¼Ÿ","url":"/posts/27504/","content":"å‡¡æ˜¯åšæœåŠ¡å™¨å¼€å‘çš„æŠ€æœ¯åŒå­¦ï¼Œä¼°è®¡éƒ½å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿä»¥åŠç›¸å…³çš„ç†è®ºæ„Ÿå…´è¶£ã€‚è€Œå¯¹äºåˆ†å¸ƒå¼ç†è®ºï¼Œå¤§å®¶è®¨è®ºçš„æœ€å¤šçš„ææ€•å°±æ˜¯ã€Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ã€é—®é¢˜äº†ã€‚ç„¶è€Œï¼Œä¸ç®¡æ˜¯å­¦æœ¯ç•Œè¿˜æ˜¯ä¸šç•Œçš„å‘å±•å†å²ä¸Šï¼Œå¯¹äºã€Œä¸€è‡´æ€§ã€è¿™ä¸ªæ¦‚å¿µçš„ç†è§£ï¼Œå§‹ç»ˆå……æ»¡äº†æ··ä¹±ã€‚\nå¦‚æœä½ é—®ä¸€ä¸ªæŠ€æœ¯åŒå­¦ï¼Œåˆ°åº•ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ä¸€è‡´æ€§ï¼Œä¼°è®¡ä¼šå¾—åˆ°äº”èŠ±å…«é—¨çš„ç­”æ¡ˆã€‚è¿™å…¶ä¸­æ¯”è¾ƒå¸¸è§çš„è¯´æ³•å¯èƒ½æ˜¯è¿™æ ·çš„ï¼šä¸€è‡´æ€§å°±æ˜¯å¤šä¸ªæœåŠ¡å™¨èŠ‚ç‚¹ä¸­çš„æ•°æ®ä¿æŒä¸€è‡´ï¼ˆè‡³å°‘ç™¾åº¦ç™¾ç§‘ä¸Šå·®ä¸å¤šå°±æ˜¯è¿™ä¹ˆè¯´çš„ï¼‰ã€‚è€Œå¦‚æœå†è®¨è®ºå¾—æ·±å…¥ä¸€ç‚¹ï¼Œå¯èƒ½å°±ä¼šè°ˆåˆ°æ‰€è°“çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œæ¯”å¦‚Paxosä¹‹ç±»çš„ï¼›è¿˜æœ‰CAPå®šç†ï¼Œä¹Ÿè·Ÿã€Œä¸€è‡´æ€§ã€æœ‰å…³ã€‚\nä½†æ˜¯ï¼Œã€Œä¸€è‡´æ€§ã€è¿™ä¸ªè¯æ˜¯éå¸¸æœ‰è¿·æƒ‘æ€§çš„ã€‚å¦‚æœç”¨è‹±æ–‡æ¥è¡¨è¾¾çš„è¯ï¼Œè·Ÿã€Œä¸€è‡´æ€§ã€æœ‰å…³çš„è‡³å°‘æœ‰ä¸¤ä¸ªè¯ï¼šconsistencyå’Œconsensusã€‚å®ƒä»¬ç»å¸¸éƒ½è¢«ç¿»è¯‘æˆã€Œä¸€è‡´æ€§ã€ï¼Œè¿™è¿›ä¸€æ­¥åŠ å‰§äº†è¿™ä¸ªæ¦‚å¿µè¢«æ»¥ç”¨çš„ç¨‹åº¦ã€‚ä¸ºäº†æ¥ä¸‹æ¥è®¨è®ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬å…ˆç®€å•åœ°æ¾„æ¸…ä¸€ä¸‹ï¼š\n\nç½‘ä¸Šé€šå¸¸æåˆ°çš„è¯¸å¦‚Paxosä¹‹ç±»çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ï¼Œå…¶å®æ˜¯consensusè¿™ä¸ªè¯ã€‚å®ƒå¦‚æœè¢«ç¿»è¯‘æˆã€Œå…±è¯†ã€ï¼Œå¯èƒ½ä¼šæ›´å¥½ä¸€äº›ã€‚ä¸ºäº†è¡¨è¾¾æ¸…æ™°ï¼Œæœ¬æ–‡åé¢åœ¨è®¨è®ºconsensusé—®é¢˜çš„æ—¶å€™ï¼Œå°½é‡ä½¿ç”¨ã€Œå…±è¯†ã€è¿™ä¸ªè¯ã€‚\nACIDæˆ–CAPé‡ŒCï¼Œç”¨çš„éƒ½æ˜¯consistencyè¿™ä¸ªè¯ï¼Œä½†çœŸå®å«ä¹‰è¿¥ç„¶ä¸åŒã€‚\næ­¤å¤–ï¼Œè¿˜ç»å¸¸ä¼šå¬åˆ°äººä»¬å…³äºã€Œå¼ºä¸€è‡´æ€§ã€çš„è¯´æ³•ï¼Œè€Œä¸”è¿™ç§è¯´æ³•é€šå¸¸éƒ½ä¼šç‰µæ¶‰åˆ°CAPå®šç†æˆ–è€…ã€Œåˆ†å¸ƒå¼äº‹åŠ¡ã€çš„æ¦‚å¿µã€‚ã€Œå¼ºä¸€è‡´æ€§ã€ä¸CAPå®šç†ç¡®å®å…³ç³»å¯†åˆ‡ï¼Œä½†ä¸ã€Œåˆ†å¸ƒå¼äº‹åŠ¡ã€çš„å…³ç³»å´ä¸çŸ¥ä»ä½•è€Œæ¥ã€‚\n\nä¸‹é¢ï¼Œæˆ‘ä»¬å°±å¯¹è¿™äº›æ¦‚å¿µè¿›è¡Œè¯¦ç»†çš„è§£æã€‚\nACIDä¸­çš„ä¸€è‡´æ€§ACIDæ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››ä¸ªç‰¹æ€§ï¼Œåˆ†åˆ«æ˜¯åŸå­æ€§ (Atomicity)ã€ä¸€è‡´æ€§ (Consistency)ã€éš”ç¦»æ€§ (Isolation)å’ŒæŒä¹…æ€§ (Durability)ã€‚\næˆ‘ä»¬ç°åœ¨å…³æ³¨çš„æ˜¯å…¶ä¸­çš„Cï¼Œå³ä¸€è‡´æ€§Consistencyã€‚å®ƒæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿé€šä¿—åœ°è¯´ï¼Œå®ƒæŒ‡çš„æ˜¯ä»»ä½•ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡çš„æ‰§è¡Œï¼Œéƒ½åº”è¯¥è®©æ•´ä¸ªæ•°æ®åº“ä¿æŒåœ¨ã€Œä¸€è‡´ã€çš„çŠ¶æ€ã€‚é‚£æ€æ ·çš„çŠ¶æ€æ‰ç®—ã€Œä¸€è‡´ã€å‘¢ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾åœ¨é“¶è¡Œè´¦æˆ·ä¹‹é—´è¿›è¡Œè½¬è´¦ã€‚æ˜¾ç„¶ï¼Œã€Œè½¬è´¦ã€è¿™ä¸ªæ“ä½œåº”è¯¥ç¡®ä¿åœ¨è½¬è´¦å‰åè´¦æˆ·æ€»é¢ä¿æŒä¸å˜ï¼Œè¿™æ˜¯ä»»ä½•ä¸€ä¸ªè½¬è´¦æ“ä½œå¿…é¡»è¦éµå®ˆçš„è§„å®šã€‚ç°åœ¨å‡è®¾è¦ä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬è´¦100å…ƒï¼Œäºæ˜¯æˆ‘ä»¬å¯åŠ¨äº†ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡ã€‚åœ¨è¿™ä¸ªäº‹åŠ¡ä¸­ï¼Œå¯ä»¥å…ˆä»è´¦å·Aä¸­å‡å»100å…ƒï¼Œå†å¾€è´¦æˆ·Bä¸­å¢åŠ 100å…ƒã€‚è¿™æ ·çš„ä¸€ä¸ªäº‹åŠ¡æ“ä½œï¼Œæ»¡è¶³äº†â€œè½¬è´¦å‰åè´¦æˆ·æ€»é¢ä¿æŒä¸å˜â€çš„è§„å®šï¼Œå› æ­¤æˆ‘ä»¬è¯´ï¼šè¿™ä¸ªäº‹åŠ¡æ“ä½œä¿æŒäº†æ•°æ®åº“çš„ã€Œä¸€è‡´æ€§ã€ï¼›åŒæ—¶ï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®åº“éƒ½å¤„äºä¸€ç§ã€Œä¸€è‡´ã€çš„çŠ¶æ€ã€‚\nä»ä¸Šä¸€æ®µçš„æè¿°ä¸­ï¼Œæˆ‘ä»¬å®¹æ˜“çœ‹å‡ºï¼š\n\nACIDä¸­çš„ã€Œä¸€è‡´æ€§ã€ï¼Œæ˜¯å¯¹äºæ•´ä¸ªæ•°æ®åº“çš„ã€Œä¸€è‡´ã€çŠ¶æ€çš„ç»´æŒã€‚æŠ½è±¡æ¥çœ‹ï¼Œå¯¹æ•°æ®åº“æ¯è¿›è¡Œä¸€æ¬¡äº‹åŠ¡æ“ä½œï¼Œå®ƒçš„çŠ¶æ€å°±å‘ç”Ÿä¸€æ¬¡å˜åŒ–ã€‚è¿™ç›¸å½“äºæŠŠæ•°æ®åº“çœ‹æˆäº†çŠ¶æ€æœºï¼Œåªè¦æ•°æ®åº“çš„èµ·å§‹çŠ¶æ€æ˜¯ã€Œä¸€è‡´ã€çš„ï¼Œå¹¶ä¸”æ¯æ¬¡äº‹åŠ¡æ“ä½œéƒ½èƒ½ä¿æŒã€Œä¸€è‡´æ€§ã€ï¼Œé‚£ä¹ˆæ•°æ®åº“å°±èƒ½å§‹ç»ˆä¿æŒåœ¨ã€Œä¸€è‡´ã€çš„çŠ¶æ€ä¸Š (Consistency Preservation)ã€‚\næ‰€è°“çŠ¶æ€æ˜¯ä¸æ˜¯ã€Œä¸€è‡´ã€ï¼Œå…¶å®æ˜¯ç”±ä¸šåŠ¡å±‚è§„å®šçš„ã€‚æ¯”å¦‚å‰é¢è¿™ä¸ªè½¬è´¦çš„ä¾‹å­ï¼Œâ€œè½¬è´¦å‰åè´¦æˆ·æ€»é¢ä¿æŒä¸å˜â€ï¼Œè¿™ä¸ªè§„å®šåªå¯¹äºã€Œè½¬è´¦ã€è¿™ä¸ªç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯æœ‰æ•ˆã€‚å¦‚æœæ¢ä¸€ä¸ªä¸šåŠ¡åœºæ™¯ï¼Œã€Œä¸€è‡´ã€çš„æ¦‚å¿µå°±ä¸æ˜¯è¿™æ ·è§„å®šäº†ã€‚æ‰€ä»¥è¯´ï¼ŒACIDä¸­çš„ã€Œä¸€è‡´æ€§ã€ï¼Œå…¶å®æ˜¯ä½“ç°äº†ä¸šåŠ¡é€»è¾‘ä¸Šçš„åˆç†æ€§ï¼Œå¹¶ä¸æ˜¯ç”±æ•°æ®åº“æœ¬èº«çš„æŠ€æœ¯ç‰¹æ€§æ‰€å†³å®šçš„ã€‚\n\næˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹ï¼Œä¸ºäº†è®©äº‹åŠ¡æ€»æ˜¯èƒ½ä¿æŒACIDçš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å®ç°ä¸Šè€ƒè™‘å“ªäº›å› ç´ å‘¢ï¼Ÿ\nè‡³å°‘ä¸¤ä¸ªæ–¹é¢éœ€è¦è€ƒè™‘ï¼šä¸€ä¸ªæ˜¯å‡ºé”™æƒ…å†µ (failure/error)ï¼›ä¸€ä¸ªæ˜¯å¹¶å‘ (concurrency) è¡Œä¸ºã€‚\né¦–å…ˆï¼Œå¯¹äºä»»ä½•ç³»ç»Ÿæ¥è¯´ï¼Œé”™è¯¯éƒ½æ˜¯åœ¨æ‰€éš¾å…çš„ã€‚è€Œé”™è¯¯åˆå¯ä»¥ç»†åˆ†ä¸ºä¸¤ç±»ã€‚\nç¬¬ä¸€ç±»ï¼Œäº‹åŠ¡æœ¬èº«çš„å®ç°é€»è¾‘å¯èƒ½å­˜åœ¨é”™è¯¯ã€‚æ¯”å¦‚ï¼Œä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬è´¦100å…ƒï¼Œåœ¨è¿™ä¸ªäº‹åŠ¡ä¸­ï¼Œå¦‚æœæˆ‘ä»¬åªä»è´¦å·Aä¸­å‡å»äº†100å…ƒï¼Œä½†å¿˜è®°äº†å¾€è´¦æˆ·Bä¸­å¢åŠ 100å…ƒï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹åŠ¡å°±æ˜¯é”™è¯¯çš„ã€‚æ˜¾ç„¶ï¼Œé¿å…ç¬¬ä¸€ç±»é”™è¯¯ï¼Œæ˜¯ä¿æŒä¸€è‡´æ€§çš„å‰æï¼Œè¿™éœ€è¦åº”ç”¨å±‚è¿›è¡Œæ°å½“çš„ç¼–ç æ¥ä¿è¯ã€‚\nç¬¬äºŒç±»ï¼Œåˆ™æ˜¯æ„æƒ³ä¸åˆ°çš„å„ç§è½¯ç¡¬ä»¶é”™è¯¯ã€‚æ¯”å¦‚ï¼Œè¿˜æ˜¯ä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬è´¦100å…ƒï¼Œäº‹åŠ¡æœ¬èº«çš„å®ç°é€»è¾‘æ²¡æœ‰é—®é¢˜ï¼Œå®ƒå…ˆæ‰§è¡Œäº†ä»è´¦å·Aä¸­å‡å»äº†100å…ƒï¼Œä½†åœ¨æ‰§è¡Œå¾€è´¦æˆ·Bä¸­å¢åŠ 100å…ƒä¹‹å‰ï¼Œå´å‘ç”Ÿäº†æ„æƒ³ä¸åˆ°çš„é”™è¯¯ï¼Œæ¯”å¦‚è¿›ç¨‹çªç„¶crashäº†ï¼Œæˆ–æ˜¯ç£ç›˜æ»¡äº†ï¼Œæˆ–æ˜¯ç½‘ç»œçªç„¶ä¸é€šäº†ï¼Œæˆ–æ˜¯å…¶å®ƒä»»ä½•å¯èƒ½çš„ç¡¬ä»¶é”™è¯¯ã€‚è¿™æ—¶å€™ï¼Œäº‹åŠ¡åªæ‰§è¡Œäº†å‰ä¸€åŠï¼ŒåŠ¿å¿…ä¼šç ´åæ•°æ®åº“æ•´ä½“çŠ¶æ€çš„ä¸€è‡´æ€§ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿè¿™å…¶å®å°±éœ€è¦ACIDä¸­çš„Aï¼ˆåŸå­æ€§ï¼‰æ¥ä¿éšœäº†ã€‚ç®€è¨€ä¹‹ï¼ŒåŸå­æ€§ä¿éšœäº†äº‹åŠ¡çš„æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œè€Œä¸å…è®¸å‡ºç°â€œåªæ‰§è¡Œäº†ä¸€åŠâ€è¿™ç§â€œéƒ¨åˆ†æˆåŠŸâ€çš„æƒ…å†µã€‚\nå…¶æ¬¡ï¼Œå¹¶å‘è¡Œä¸ºä¹Ÿå¯èƒ½ä¼šå½±å“äº‹åŠ¡çš„ä¸€è‡´æ€§ã€‚åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œå¹¶å‘è¡Œä¸ºä½“ç°åœ¨å¯èƒ½å­˜åœ¨å¤šä¸ªäº‹åŠ¡åŒæ—¶æ“ä½œåŒä¸€ä»½æ•°æ®çš„æƒ…å†µã€‚è¿˜æ˜¯æ‹¿å‰é¢è½¬è´¦çš„ä¾‹å­æ¥è¯´ï¼Œå‡è®¾æœ‰ä¸¤ä¸ªäº‹åŠ¡ï¼šäº‹åŠ¡1ä»è´¦æˆ·Aå‘è´¦æˆ·Bè½¬è´¦100å…ƒï¼Œäº‹åŠ¡2ä»è´¦æˆ·Aå‘è´¦æˆ·Cè½¬è´¦50å…ƒã€‚å¦‚æœä¸¤ä¸ªäº‹åŠ¡å…ˆåé¡ºåºæ‰§è¡Œï¼Œè‡ªç„¶æ²¡æœ‰é—®é¢˜ã€‚ä½†å¦‚æœä¸¤ä¸ªäº‹åŠ¡åŒæ—¶æ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„æ‰§è¡Œåºåˆ—ï¼ˆå‡è®¾è´¦å·Açš„åˆå§‹ä½™é¢ä¸ºxå…ƒï¼‰ï¼š\n\n&lt;äº‹åŠ¡1&gt;ï¼šè¯»å–è´¦æˆ·Açš„ä½™é¢ï¼Œè¯»åˆ°äº†xå…ƒï¼›\n&lt;äº‹åŠ¡2&gt;ï¼šè¯»å–è´¦æˆ·Açš„ä½™é¢ï¼Œä¹Ÿè¯»åˆ°äº†xå…ƒï¼›\n&lt;äº‹åŠ¡1&gt;ï¼šå‘è´¦æˆ·Aä¸­å†™å…¥(x-100)å…ƒï¼›\n&lt;äº‹åŠ¡2&gt;ï¼šå‘è´¦æˆ·Aä¸­å†™å…¥(x-50)å…ƒï¼›\nâ€¦â€¦\n\nä¸Šé¢çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè´¦æˆ·Aä¸­æœ€åè¢«å†™å…¥çš„å€¼æ˜¯(x-50)å…ƒï¼Œæ˜¾ç„¶æ˜¯ä¸å¯¹çš„ï¼ˆäº‹åŠ¡çš„ä¸€è‡´æ€§ä¼šè¢«ç ´åï¼‰ã€‚å¦‚æœä¸¤ä¸ªè½¬è´¦çš„äº‹åŠ¡èƒ½æ­£ç¡®æ‰§è¡Œå®Œï¼Œé‚£ä¹ˆè´¦æˆ·Açš„ä½™é¢åº”è¯¥æ˜¯(x-150)å…ƒæ‰å¯¹ã€‚\nè¿™ä¸ªå¹¶å‘çš„é—®é¢˜æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿè¿™å°±éœ€è¦ACIDä¸­çš„Iï¼ˆéš”ç¦»æ€§ï¼‰æ¥ä¿éšœäº†ã€‚ä»€ä¹ˆæ˜¯éš”ç¦»æ€§å‘¢ï¼Ÿå®ƒå¯¹äºå¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡è¿›è¡Œåˆç†çš„æ’åºï¼Œä¿éšœäº†ä¸åŒäº‹åŠ¡çš„æ‰§è¡Œäº’ä¸å¹²æ‰°ã€‚æ¢è¨€ä¹‹ï¼Œéš”ç¦»æ€§è¿™ç§ç‰¹æ€§ï¼Œèƒ½å¤Ÿè®©å¹¶å‘æ‰§è¡Œçš„å¤šä¸ªäº‹åŠ¡å°±å¥½åƒæ˜¯æŒ‰ç…§ã€Œå…ˆåé¡ºåºã€æ‰§è¡Œçš„ä¸€æ ·ã€‚\nç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œç°åœ¨å…³äºACIDä¸­çš„ä¸€è‡´æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€äº›ç»“è®ºäº†ï¼š\n\nACIDä¸­çš„ä¸€è‡´æ€§ï¼Œæ˜¯ä¸ªå¾ˆååº”ç”¨å±‚çš„æ¦‚å¿µã€‚è¿™è·ŸACIDä¸­çš„åŸå­æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§æœ‰å¾ˆå¤§çš„ä¸åŒã€‚åŸå­æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ï¼Œéƒ½æ˜¯æ•°æ®åº“æœ¬èº«æ‰€æä¾›çš„æŠ€æœ¯ç‰¹æ€§ï¼›è€Œä¸€è‡´æ€§ï¼Œåˆ™æ˜¯ç”±ç‰¹å®šçš„ä¸šåŠ¡åœºæ™¯è§„å®šçš„ã€‚æ€ªä¸å¾—ã€ŠDesigning Data-Intensive Applicationsã€‹[1]ä¸€ä¹¦çš„ä½œè€…åœ¨ä¹¦ä¸­å†™é“ï¼šâ€The letter C doesnâ€™t really belong in ACIDâ€œã€‚\nè¦çœŸæ­£åšåˆ°ACIDä¸­çš„ä¸€è‡´æ€§ï¼Œå®ƒæ˜¯è¦ä¾èµ–æ•°æ®åº“çš„åŸå­æ€§å’Œéš”ç¦»æ€§çš„ï¼ˆåº”å¯¹é”™è¯¯å’Œå¹¶å‘ï¼‰ã€‚ä½†æ˜¯ï¼Œå°±ç®—æ•°æ®åº“æä¾›äº†æ‰€æœ‰ä½ æ‰€éœ€è¦çš„æŠ€æœ¯ç‰¹æ€§ï¼Œä¹Ÿä¸ä¸€å®šèƒ½ä¿è¯ACIDçš„ä¸€è‡´æ€§ã€‚è¿™è¿˜å–å†³äºä½ åœ¨åº”ç”¨å±‚å¯¹äºäº‹åŠ¡æœ¬èº«çš„å®ç°é€»è¾‘æ˜¯å¦æ­£ç¡®æ— è¯¯ã€‚\næœ€åï¼ŒACIDä¸­çš„ä¸€è‡´æ€§ï¼Œç”šè‡³è·Ÿåˆ†å¸ƒå¼éƒ½æ²¡ä»€ä¹ˆç›´æ¥å…³ç³»ã€‚å®ƒè·Ÿåˆ†å¸ƒå¼çš„å”¯ä¸€å…³è”åœ¨äºï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œå®ƒæ‰€ä¾èµ–çš„æ•°æ®åº“åŸå­æ€§å’Œéš”ç¦»æ€§æ›´éš¾å®ç°ã€‚\n\næ€»ä¹‹ï¼ŒACIDä¸­çš„ä¸€è‡´æ€§ï¼Œæ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„æ¦‚å¿µã€‚é™¤äº†æ•°æ®åº“äº‹åŠ¡å¤„ç†ï¼Œå®ƒå¾ˆéš¾æ‰©å±•åˆ°å…¶å®ƒåœºæ™¯ï¼Œä¹Ÿè·Ÿåˆ†å¸ƒå¼ç†è®ºä¸­çš„å…¶å®ƒã€Œä¸€è‡´æ€§ã€æ¦‚å¿µæ²¡æœ‰ä»€ä¹ˆå…³ç³»ã€‚\nåˆ†å¸ƒå¼äº‹åŠ¡ä¸å…±è¯†ç®—æ³•çš„å…³ç³»å…ˆè¯´å…±è¯†é—®é¢˜ (consensus problem)ã€‚è¿™æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„ä¸€ä¸ªååˆ†åŸºç¡€è€Œæ ¸å¿ƒçš„é—®é¢˜ï¼Œå®ƒè¡¨ç¤ºå¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å°±æŸäº‹è¾¾æˆå…±è¯†ã€‚\nç½‘ä¸Šé€šå¸¸æåˆ°çš„ã€Œåˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®ã€ï¼Œæˆ–è€…ã€Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•ã€ï¼Œä¸€èˆ¬æ¥è¯´å°±æ˜¯è§£å†³è¿™é‡Œçš„å…±è¯†é—®é¢˜çš„ç®—æ³•ã€‚ç”¨è¯çš„ä¸åŒï¼Œæ˜¯ç”±äºä¸­è‹±æ–‡ç¿»è¯‘é€ æˆçš„ã€‚è¿™äº›ç®—æ³•æˆ–åè®®ï¼Œç»å¸¸åŒ…å«Paxosä¹‹ç±»ï¼Œä½†ä¹Ÿå¯èƒ½åŒ…æ‹¬ä¸¤é˜¶æ®µæäº¤åè®®(2PC)æˆ–ä¸‰é˜¶æ®µæäº¤åè®®(3PC)ã€‚\näººä»¬æ—¢ç„¶ç»å¸¸å°†Paxosã€2PCã€3PCè¿™äº›ç®—æ³•æ”¾åœ¨ä¸€èµ·è®¨è®ºï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹é—´åŠ¿å¿…å­˜åœ¨ç€æŸç§ç›¸ä¼¼æ€§çš„ã€‚ä½†è¿™ç§ç›¸ä¼¼æ€§æ˜¯æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿæˆ‘ä»¬ä»”ç»†åˆ†æä¸€ä¸‹ã€‚Paxosï¼Œæ˜¯è§£å†³å…±è¯†é—®é¢˜çš„é€šç”¨ç®—æ³•ã€‚å®ƒå…è®¸æ¯ä¸ªèŠ‚ç‚¹æå‡ºè‡ªå·±çš„æè®®(ç§°ä¸ºproposalï¼‰ï¼Œè€ŒPaxosç®—æ³•èƒ½å¤Ÿä¸å€ŸåŠ©äºä»»ä½•ä¸­å¿ƒåŒ–èŠ‚ç‚¹ï¼Œä¿è¯å„ä¸ªèŠ‚ç‚¹ä¹‹é—´å¯¹äºæè®®æœ€ç»ˆè¾¾æˆä¸€è‡´ã€‚è¿™é‡Œçš„proposalï¼Œæ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå¯ä»¥åŒ…å«ä»»ä½•ä½ æƒ³è¾¾æˆå…±è¯†çš„æ•°å€¼ã€‚2PCå’Œ3PCï¼Œåˆ™æ˜¯ä¸ºäº†è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡æäº¤é—®é¢˜çš„ã€‚\nè¿™æ ·ä»è¡¨é¢çœ‹èµ·æ¥ï¼ŒPaxoså’Œ2PCã€3PCï¼Œè¿™ä¸¤ç±»ç®—æ³•ä¼¼ä¹æ²¡æœ‰å¤šå°‘ç›¸ä¼¼æ€§ã€‚2PCå’Œ3PCæ˜¯è·Ÿåˆ†å¸ƒå¼äº‹åŠ¡å¼ºç›¸å…³çš„ï¼Œè€ŒPaxosè·Ÿåˆ†å¸ƒå¼äº‹åŠ¡æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„å…³ç³»ã€‚ä¸ºäº†åˆ†ææ›´æ·±å±‚æ¬¡çš„æœ¬è´¨ï¼Œæˆ‘ä»¬æ¢ç©¶ä¸€ä¸‹2PCå’Œ3PCäº§ç”Ÿçš„èƒŒæ™¯ã€‚\nå›åˆ°äº‹åŠ¡çš„æ¦‚å¿µã€‚äº‹åŠ¡æœ¬æ¥å’Œåˆ†å¸ƒå¼æ²¡ä»€ä¹ˆç›´æ¥å…³ç³»çš„ï¼Œå°±ç®—åœ¨ä¸€ä¸ªå•èŠ‚ç‚¹çš„æ•°æ®åº“ä¸Šï¼Œè¦å®ç°å‡ºäº‹åŠ¡çš„ACIDç‰¹æ€§ï¼Œä¹Ÿä¸æ˜¯é‚£ä¹ˆå®¹æ˜“çš„ã€‚åªæ˜¯ï¼Œå¦‚åŒåœ¨å‰ä¸€ç« èŠ‚çš„ç»“å°¾æˆ‘ä»¬æåˆ°çš„ï¼Œåœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ï¼Œäº‹åŠ¡çš„ACIDç‰¹æ€§æ›´éš¾å®ç°ã€‚åœ¨å‰ä¸€ç« ä¸­æˆ‘ä»¬ä¸»è¦å…³æ³¨ACIDä¸­çš„ä¸€è‡´æ€§ï¼Œç°åœ¨æˆ‘ä»¬å…³æ³¨ä¸€ä¸‹ACIDä¸­çš„åŸå­æ€§ (Atomicity)ã€‚\nACIDä¸­çš„åŸå­æ€§ï¼Œè¦æ±‚äº‹åŠ¡çš„æ‰§è¡Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œè€Œä¸å…è®¸å‡ºç°â€œéƒ¨åˆ†æˆåŠŸâ€çš„æƒ…å†µã€‚åœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼Œè¿™è¦æ±‚å‚ä¸äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒCommitæ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒAbortæ“ä½œã€‚æ¢å¥è¯è¯´ï¼Œå‚ä¸äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦åœ¨â€œæ‰§è¡ŒCommitè¿˜æ˜¯Abortâ€è¿™ä¸€ç‚¹ä¸Šè¾¾æˆä¸€è‡´ï¼ˆå…¶å®å°±æ˜¯å…±è¯†ï¼‰ã€‚è¿™ä¸ªé—®é¢˜åœ¨å­¦æœ¯ç•Œè¢«ç§°ä¸ºåŸå­æäº¤é—®é¢˜ï¼ˆAtomic Commitment Problemï¼‰[2]ï¼Œè€Œèƒ½å¤Ÿè§£å†³åŸå­æäº¤é—®é¢˜çš„ç®—æ³•ï¼Œåˆ™è¢«ç§°ä¸ºåŸå­æäº¤åè®®ï¼ˆAtomic Commitment Protocalï¼Œç®€ç§°ACPï¼‰[3]ã€‚2PCå’Œ3PCï¼Œå±äºåŸå­æäº¤åè®®ä¸¤ç§ä¸åŒçš„å…·ä½“å®ç°ã€‚\nåˆ†æåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬ä¼¼ä¹å‘ç°äº†åŸå­æäº¤é—®é¢˜ä¸å…±è¯†é—®é¢˜çš„å…³è”æ€§ï¼š\n\nå…±è¯†é—®é¢˜ï¼Œè§£å†³çš„æ˜¯å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å°±æŸä¸ªæè®®è¾¾æˆå…±è¯†ã€‚\nåŸå­æäº¤é—®é¢˜ï¼Œè§£å†³çš„æ˜¯å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨â€œæ‰§è¡ŒCommitè¿˜æ˜¯Abortâ€è¿™ä¸€ç‚¹ä¸Šè¾¾æˆå…±è¯†ã€‚\næ‰€ä»¥ï¼ŒåŸå­æäº¤é—®é¢˜æ˜¯å…±è¯†é—®é¢˜çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚\n\nè¿™ä¸ªé…·ä¼¼ã€Œä¸‰æ®µè®ºã€å¼çš„è®ºè¿°ï¼Œçœ‹èµ·æ¥â€œåˆæƒ…åˆç†â€ã€‚å®é™…ä¸Šï¼Œå­¦æœ¯ç•Œåœ¨å¾ˆé•¿ä¸€æ®µæ—¶é—´å†…éƒ½è®¤ä¸ºï¼Œåˆ†å¸ƒå¼äº‹åŠ¡çš„åŸå­æäº¤é—®é¢˜æ˜¯æ‹œå åº­å°†å†›é—®é¢˜ï¼ˆByzantine Generals Problemï¼‰çš„ä¸€ä¸ªé€€åŒ–å½¢å¼[4]ã€‚ä»€ä¹ˆæ˜¯æ‹œå åº­å°†å†›é—®é¢˜å‘¢ï¼Ÿç®€å•æ¥è¯´ï¼Œå®ƒä¹Ÿæ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ç§å…±è¯†é—®é¢˜ï¼Œè€Œä¸”æ˜¯å®¹é”™æ€§è¦æ±‚æœ€é«˜çš„ä¸€ç§å…±è¯†é—®é¢˜ã€‚æˆ‘ä»¬åœ¨è¿™é‡Œä¸å±•å¼€è®¨è®ºæ‹œå åº­å°†å†›é—®é¢˜äº†ï¼Œå¦‚æœä½ å¯¹ç»†èŠ‚æ„Ÿå…´è¶£ï¼Œæ¬¢è¿é˜…è¯»æˆ‘ä¹‹å‰çš„å¦ä¸€ç¯‡æ–‡ç« â€œæ¼«è°ˆåˆ†å¸ƒå¼ç³»ç»Ÿã€æ‹œå åº­å°†å†›é—®é¢˜ä¸åŒºå—é“¾â€ã€‚æ€»ä¹‹ï¼Œå­¦æœ¯ç•Œä»¥å‰çš„è¿™ç§è§‚ç‚¹ï¼Œè·Ÿæˆ‘ä»¬åˆšåˆšåˆ†æå¾—åˆ°çš„ç»“è®ºï¼ˆåŸå­æäº¤é—®é¢˜æ˜¯å…±è¯†é—®é¢˜çš„ä¸€ä¸ªç‰¹ä¾‹ï¼‰å·®ä¸å¤šã€‚\nä½†æ˜¯ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„è¯¡å¼‚ä¹‹å¤„å°±è¦ä½“ç°åœ¨è¿™é‡Œï¼Œä¸€äº›ç»†èŠ‚çš„ä¸åŒï¼Œå¯èƒ½å¯¼è‡´éå¸¸å¤§çš„å·®å¼‚ã€‚å¦‚æœä½ ä»”ç»†çœ‹å‰æ–‡çš„æè¿°ï¼Œä¼šå‘ç°è¿™æ ·ä¸€ä¸ªç»†èŠ‚ï¼šå½“æˆ‘ä»¬æè¿°å…±è¯†é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´çš„æ˜¯åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´è¾¾æˆå…±è¯†ï¼›è€Œå½“æˆ‘ä»¬æè¿°åŸå­æäº¤é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´çš„æ˜¯åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¹‹é—´è¾¾æˆå…±è¯†ã€‚è¿™ä¸ªç»†å¾®çš„å·®åˆ«ï¼Œè®©è¿™ä¸¤ç±»é—®é¢˜ï¼Œå‡ ä¹å˜æˆäº†å®Œå…¨ä¸åŒçš„é—®é¢˜ï¼ˆè°ä¹Ÿæ›¿ä»£ä¸äº†è°ï¼‰ã€‚\nä»ä¸¤ç±»é—®é¢˜å„è‡ªçš„åº”ç”¨åœºæ™¯æ¥çœ‹ï¼Œè¿™ä¸ªå·®å¼‚æ˜¯åˆç†çš„ï¼Œä¹Ÿæ˜¯å®¹æ˜“ç†è§£çš„ã€‚ä»¥è§£å†³å…±è¯†é—®é¢˜çš„Paxosåè®®ä¸ºä¾‹ï¼Œå®ƒåªè¦æ±‚ç½‘ç»œä¸­çš„å¤§éƒ¨åˆ†èŠ‚ç‚¹è¾¾æˆå…±è¯†å°±å¯ä»¥äº†ï¼Œè¿™æ ·Paxosæ‰èƒ½æä¾›ä¸€å®šçš„å®¹é”™æ€§ï¼Œåªè¦ç½‘ç»œä¸­å‘ç”Ÿæ•…éšœçš„èŠ‚ç‚¹ä¸è¶…è¿‡ä¸€åŠä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼ˆä¸ä¼šè¢«é˜»å¡ï¼‰ã€‚ç„¶è€Œï¼Œè§£å†³åŸå­æäº¤é—®é¢˜çš„2PCæˆ–3PCåˆ™ä¸åŒã€‚å³ä½¿åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å‘ç”Ÿæ•…éšœäº†ï¼Œå…¶å®ƒèŠ‚ç‚¹ä¹Ÿä¸èƒ½æ“…è‡ªå†³ç­–è¿›è¡ŒCommitæ“ä½œã€‚å› ä¸ºè¿™æ ·çš„è¯ï¼Œè¿™ä¸ªäº‹åŠ¡å°±åªæ˜¯ã€Œéƒ¨åˆ†åœ°æ‰§è¡ŒæˆåŠŸäº†ã€ï¼Œè¿åäº†ACIDåŸå­æ€§çš„è¦æ±‚ã€‚æ‰€ä»¥ï¼ŒåŸå­æäº¤åè®®å¿…é¡»ä¿è¯åœ¨å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬æ•…éšœçš„èŠ‚ç‚¹ï¼‰ä¸Šå¯¹äºâ€œæ‰§è¡ŒCommitè¿˜æ˜¯Abortâ€è¾¾æˆå…±è¯†ã€‚\næ•…éšœçš„èŠ‚ç‚¹å¯èƒ½ä»€ä¹ˆéƒ½åšä¸äº†ï¼Œå¦‚ä½•å‚ä¸è¾¾æˆå…±è¯†å‘¢ï¼Ÿè¿™é‡Œçš„æ„æ€æ˜¯ï¼Œç­‰æ•…éšœèŠ‚ç‚¹æ¢å¤ä¹‹åï¼Œå®ƒçš„å†³ç­–ï¼ˆCommitæˆ–æ˜¯Abortï¼‰å¿…é¡»ä¸å…¶å®ƒæ‰€æœ‰èŠ‚ç‚¹ä¿æŒä¸€è‡´ã€‚é‚£ä¹ˆï¼Œè¿™æ˜¯ä¸æ˜¯æ„å‘³ç€ï¼Œåªè¦æœ‰èŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼ŒåŸå­æäº¤åè®®å°±ä¸€å®šä¼šé˜»å¡å‘¢ï¼Ÿè¿™é‡Œæœ‰ç‚¹è®©äººå¥‡æ€ªï¼Œç­”æ¡ˆæ˜¯ã€Œä¸ä¸€å®šã€ã€‚æ ¹æºå°±åœ¨äºAbortå’ŒCommitå¹¶ä¸æ˜¯å¯¹ç­‰çš„å†³ç­–ã€‚å‡è®¾æœ‰ä¸€ä¸ªèŠ‚ç‚¹å®•æœºäº†ï¼Œå…¶å®ƒèŠ‚ç‚¹å¤§å¯ä»¥é€‰æ‹©Abortå†³ç­–ï¼ˆæ³¨æ„ä¸èƒ½é€‰æ‹©Commitï¼‰ï¼Œä»è€Œè®©æ•´ä¸ªäº‹åŠ¡Abortæ‰ï¼ˆæ²¡æœ‰è¢«é˜»å¡ä½ï¼Œç­‰å¾…å®•æœºçš„èŠ‚ç‚¹æ¢å¤ï¼‰ã€‚ç­‰å®•æœºçš„é‚£ä¸ªèŠ‚ç‚¹æ¢å¤äº†ï¼Œå®ƒä¼šå‘ç°ç›¸åº”çš„äº‹åŠ¡å·²ç»æ‰§è¡ŒAbortäº†ï¼Œé‚£ä¹ˆå®ƒä¹ŸæŒ‰ç…§Abortå¤„ç†å°±å¥½äº†ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬å®•æœºçš„è¿™ä¸ªèŠ‚ç‚¹ï¼‰å¯¹äºâ€œæ‰§è¡ŒCommitè¿˜æ˜¯Abortâ€ä¹Ÿæ˜¯è¾¾æˆäº†å…±è¯†çš„ï¼ˆè¿™ä¸ªå…±è¯†æ˜¯Abortï¼‰ã€‚æ­£æ˜¯è¿™äº›ç»†å¾®å´è‡³å…³é‡è¦çš„ç»†èŠ‚ï¼Œè®©2PCå’Œ3PCè¿™ç§çœ‹ä¼¼ç®€å•çš„åè®®å®ç°èµ·æ¥æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ã€‚\nè®ºæ–‡[5]è¿›ä¸€æ­¥æ¾„æ¸…äº†è¿™ä¸€é—®é¢˜ï¼ŒåŸå­æäº¤é—®é¢˜è¢«æŠ½è±¡æˆä¸€ä¸ªæ–°çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œç§°ä¸ºuniform consensusé—®é¢˜ï¼Œå®ƒæ˜¯ä¸é€šå¸¸çš„å…±è¯†é—®é¢˜ï¼ˆconsensus problemï¼‰ä¸åŒçš„é—®é¢˜ï¼Œè€Œä¸”æ˜¯æ›´éš¾çš„é—®é¢˜ã€‚uniform consensusï¼Œè¦æ±‚æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬æ•…éšœèŠ‚ç‚¹ï¼‰éƒ½è¦è¾¾æˆå…±è¯†ï¼›è€Œconsensusé—®é¢˜åªå…³æ³¨æ²¡æœ‰å‘ç”Ÿæ•…éšœçš„èŠ‚ç‚¹è¾¾æˆå…±è¯†ã€‚\nè‡³æ­¤ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹æœ¬ç« èŠ‚çš„ç»“è®ºï¼š\n\nå…±è¯†é—®é¢˜ï¼ˆconsensus problemï¼‰ï¼Œè§£å†³çš„æ˜¯å¦‚ä½•åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´å°±æŸä¸ªæè®®è¾¾æˆå…±è¯†ã€‚å®ƒåªå…³æ³¨æ²¡æœ‰å‘ç”Ÿæ•…éšœçš„èŠ‚ç‚¹è¾¾æˆå…±è¯†å°±å¯ä»¥äº†ã€‚\nåœ¨åˆ†å¸ƒå¼äº‹åŠ¡ä¸­ï¼ŒACIDä¸­çš„åŸå­æ€§ï¼Œå¼•å‡ºäº†åŸå­æäº¤é—®é¢˜ï¼Œå®ƒè§£å†³çš„æ˜¯å‚ä¸åˆ†å¸ƒå¼äº‹åŠ¡çš„æ‰€æœ‰èŠ‚ç‚¹åœ¨â€œæ‰§è¡ŒCommitè¿˜æ˜¯Abortâ€è¿™ä¸€ç‚¹ä¸Šè¾¾æˆå…±è¯†ã€‚åŸå­æäº¤é—®é¢˜å±äºuniform consensusé—®é¢˜ï¼Œè¦æ±‚æ‰€æœ‰èŠ‚ç‚¹ï¼ˆåŒ…æ‹¬æ•…éšœèŠ‚ç‚¹ï¼‰éƒ½è¦è¾¾æˆå…±è¯†ï¼Œæ˜¯æ¯”consensusé—®é¢˜æ›´éš¾çš„ä¸€ç±»é—®é¢˜ã€‚\nPaxoså’Œè§£å†³æ‹œå åº­å°†å†›é—®é¢˜çš„ç®—æ³•ï¼Œè§£å†³çš„æ˜¯consensusé—®é¢˜ï¼›2PC/3PCï¼Œè§£å†³çš„æ˜¯ä¸€ä¸ªç‰¹å®šçš„uniform consensusé—®é¢˜ã€‚\n\nCAPä¸çº¿æ€§ä¸€è‡´æ€§CAPçš„ä¸‰ä¸ªå­—æ¯åˆ†åˆ«ä»£è¡¨äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸‰ä¸ªç‰¹æ€§ï¼šä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition-toleranceï¼‰ã€‚è€ŒCAPå®šç†æŒ‡å‡ºï¼šä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿåªèƒ½åŒæ—¶æ»¡è¶³ä¸‰ä¸ªç‰¹æ€§ä¸­çš„ä¸¤ä¸ªã€‚ä½†æ˜¯ï¼Œè¿™ä¸€æè¿°æ›¾ç»å¼•å‘äº†éå¸¸å¤šçš„è¯¯è§£ã€‚\nä¸ºäº†è¿›ä¸€æ­¥å±•å¼€è®¨è®ºï¼Œæˆ‘ä»¬å…ˆå…³æ³¨CAPä¸­çš„Cï¼Œä¹Ÿå°±æ˜¯ä¸€è‡´æ€§ã€‚å®ƒæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿåœ¨è¯æ˜CAPå®šç†çš„åŸå§‹è®ºæ–‡ä¸­[6]ï¼ŒCæŒ‡çš„æ˜¯linearizable consistencyï¼Œä¹Ÿå°±æ˜¯ã€Œçº¿æ€§ä¸€è‡´æ€§ã€ã€‚æ›´ç²¾ç®€çš„è‹±æ–‡è¡¨è¾¾åˆ™æ˜¯linearizabilityã€‚\nè¿™å¬èµ·æ¥å¯èƒ½ç¨å¾®æœ‰ç‚¹å¥‡æ€ªï¼Œä½†äº‹å®å°±æ˜¯è¿™æ ·ã€‚çº¿æ€§ä¸€è‡´æ€§ï¼ˆlinearizabilityï¼‰æ˜¯CAPä¸­çš„Cçš„åŸå§‹å®šä¹‰ã€‚è€Œå¾ˆå¤šäººåœ¨è°ˆåˆ°CAPæ—¶ï¼Œåˆ™ä¼šæŠŠè¿™ä¸ªCçœ‹æˆæ˜¯å¼ºä¸€è‡´æ€§ï¼ˆstrong consistencyï¼‰ã€‚è¿™å…¶å®ä¹Ÿæ²¡é”™ï¼Œå› ä¸ºçº¿æ€§ä¸€è‡´æ€§çš„å¦ä¸€ä¸ªåå­—ï¼Œå°±æ˜¯å¼ºä¸€è‡´æ€§[1]ã€‚åªä¸è¿‡ï¼Œç›¸æ¯”ã€Œçº¿æ€§ä¸€è‡´æ€§ã€æ¥è¯´ï¼Œã€Œå¼ºä¸€è‡´æ€§ã€å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½åå­—ã€‚å› ä¸ºï¼Œä»è¿™ä¸ªåå­—ä½ çœ‹ä¸å‡ºæ¥å®ƒçœŸå®çš„å«ä¹‰ï¼ˆåˆ°åº•ã€Œå¼ºã€åœ¨å“ªï¼Ÿï¼‰ã€‚åœ¨ä¸‹é¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬ç»Ÿä¸€ä½¿ç”¨çº¿æ€§ä¸€è‡´æ€§(linearizability)è¿™ä¸ªè¯æ±‡ã€‚\né‚£çº¿æ€§ä¸€è‡´æ€§æ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒç²¾ç¡®çš„å½¢å¼åŒ–å®šä¹‰[7]éå¸¸æŠ½è±¡ï¼Œä¸”éš¾ä»¥ç†è§£ã€‚å¤§ä½“ä¸Šæ˜¯è¯´ï¼Œåœ¨ä¸€ä¸ªå¹¶å‘æ‰§è¡Œçš„ç¯å¢ƒä¸­ï¼Œä¸åŒçš„æ“ä½œä¹‹é—´å¯èƒ½æ˜¯æœ‰ä¸¥æ ¼çš„å…ˆåå…³ç³»çš„ï¼ˆä¸€ä¸ªæ“ä½œæ‰§è¡Œç»“æŸä¹‹åå¦ä¸€ä¸ªæ“ä½œæ‰å¼€å§‹æ‰§è¡Œï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯å¹¶å‘æ‰§è¡Œçš„ï¼ˆä¸€ä¸ªæ“ä½œè¿˜æ²¡æ‰§è¡Œç»“æŸï¼Œå¦ä¸€ä¸ªæ“ä½œå°±å¼€å§‹æ‰§è¡Œäº†ï¼‰ï¼›å¦‚æœèƒ½å¤ŸæŠŠæ‰€æœ‰æ“ä½œæ’åˆ—æˆä¸€ä¸ªã€Œåˆæ³•ã€çš„å…¨å±€çº¿æ€§é¡ºåºï¼Œé‚£ä¹ˆè¿™äº›æ“ä½œå°±æ˜¯æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ã€‚å½“ç„¶ï¼Œåœ¨è¿™ä¸ªé‡æ–°æ’åˆ—çš„è¿‡ç¨‹ä¸­ï¼ŒåŸæ¥å°±å­˜åœ¨çš„ä¸¥æ ¼çš„å…ˆåå…³ç³»ï¼Œå¿…é¡»å¾—ä»¥ä¿æŒã€‚\nä½†æ˜¯ï¼Œæ€ä¹ˆæ‰ç®—åˆæ³•å‘¢ï¼Ÿæˆ‘ä»¬å…·ä½“åˆ°ä¸€ä¸ªå­˜å‚¨ç³»ç»Ÿä¸­é€šè¿‡ä¾‹å­æ¥è¯´æ˜ã€‚å‡å¦‚æˆ‘ä»¬å…ˆå¾€æŸä¸ªæ•°æ®å¯¹è±¡ä¸­å†™å…¥äº†ä¸€ä¸ªå€¼ï¼ˆå‡è®¾æ˜¯1ï¼‰ï¼Œç„¶ååœ¨å†™å…¥æ“ä½œç»“æŸä¹‹åï¼Œæˆ‘ä»¬å†æŠŠè¿™ä¸ªæ•°æ®å¯¹è±¡è¯»å‡ºæ¥ï¼ˆåœ¨å†™å…¥å’Œè¯»å–æ“ä½œä¹‹é—´æ²¡æœ‰å…¶å®ƒçš„å†™å…¥æ“ä½œäº†ï¼‰ã€‚å¦‚æœæˆ‘ä»¬å‘ç°è¯»å–åˆ°çš„å€¼æ˜¯1ï¼Œé‚£ä¹ˆå°±æ˜¯åˆæ³•çš„ï¼›è€Œå¦‚æœè¯»å‡ºæ¥çš„å€¼ä¸æ˜¯1ï¼Œé‚£ä¹ˆå°±æ˜¯éæ³•çš„ã€‚å†å‡è®¾ï¼Œæˆ‘ä»¬åˆæ‰§è¡Œäº†ä¸€æ¬¡è¯»å–æ“ä½œï¼Œå‘ç°è¯»å‡ºæ¥çš„å€¼ä»ç„¶æ˜¯1ï¼Œé‚£ä¹ˆå°±æ˜¯åˆæ³•çš„ï¼›å¦åˆ™å°±æ˜¯éæ³•çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸€ä¸ªè¯»æ“ä½œå·²ç»è¯»åˆ°äº†æŸä¸ªå€¼ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªå¯¹äºåŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„è¯»æ“ä½œå°±å¿…é¡»è¯»å–åˆ°åŒæ ·çš„å€¼ï¼ˆé™¤éåœ¨ä¸¤æ¬¡è¯»æ“ä½œä¹‹é—´è¿˜å­˜åœ¨åˆ«çš„å†™å…¥æ“ä½œï¼‰ã€‚\nè¿™äº›ä¾‹å­éƒ½æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œå› ä¸ºç«™åœ¨è§‚å¯Ÿè€…çš„è§’åº¦å®ƒä»¬æ˜¯ç¬¦åˆé€»è¾‘çš„ã€‚å› æ­¤ï¼Œå¯¹äºä¸€ä¸ªåˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿæ¥è¯´ï¼Œçº¿æ€§ä¸€è‡´æ€§çš„å«ä¹‰å¯ä»¥ç”¨ä¸€ä¸ªå…·ä½“çš„æè¿°æ¥å–ä»£ï¼šå¯¹äºä»»ä½•ä¸€ä¸ªæ•°æ®å¯¹è±¡æ¥è¯´ï¼Œç³»ç»Ÿè¡¨ç°å¾—å°±åƒå®ƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬ä¸€æ ·[1]ã€‚â€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ï¼Œä¹Ÿå°±ç›¸å½“äºæ»¡è¶³äº†å‰é¢çš„ã€Œåˆæ³•ã€æ¡ä»¶ã€‚æ˜¾ç„¶ï¼Œå¦‚æœç³»ç»Ÿå¯¹äºæ¯ä¸ªæ•°æ®å¯¹è±¡çœŸçš„åªå­˜ä¸€ä¸ªå‰¯æœ¬ï¼Œé‚£ä¹ˆè‚¯å®šæ˜¯æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ã€‚ä½†æ˜¯å•ä¸€å‰¯æœ¬ä¸å…·æœ‰å®¹é”™æ€§ï¼Œæ‰€ä»¥åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿä¸€èˆ¬éƒ½ä¼šå¯¹æ•°æ®è¿›è¡Œå¤åˆ¶ï¼ˆreplicationï¼‰ï¼Œä¹Ÿå°±æ˜¯ä¿å­˜å¤šä¸ªå‰¯æœ¬ã€‚è¿™æ—¶ï¼Œåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼å¤šå‰¯æœ¬çš„å­˜å‚¨ç³»ç»Ÿä¸­ï¼Œè¦æä¾›çº¿æ€§ä¸€è‡´æ€§çš„ä¿è¯ï¼Œå°±éœ€è¦ä»˜å‡ºé¢å¤–çš„æˆæœ¬äº†ã€‚\nç½‘ä¸Šå¯¹äºCAPçš„ä¸€è‡´æ€§çš„é€šä¿—è§£é‡Šï¼Œé€šå¸¸æœ‰ä¸¤ç§ï¼š\n\nä¸€è‡´æ€§æ˜¯æŒ‡ï¼šåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå®ŒæˆæŸå†™æ“ä½œåçš„ä»»ä½•è¯»æ“ä½œï¼Œéƒ½åº”è¯¥è·å–åˆ°è¯¥å†™æ“ä½œå†™å…¥çš„é‚£ä¸ªæœ€æ–°çš„å€¼ã€‚æ˜¾ç„¶ï¼Œå¦‚æœç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ä¸€æ ·ï¼Œè¿™ä¸ªæè¿°æ˜¯æˆç«‹çš„ã€‚ä¸è¿‡è¿™åªæ˜¯æè¿°äº†çº¿æ€§ä¸€è‡´æ€§çš„ä¸€ä¸ªç‰¹ä¾‹è€Œå·²ï¼Œæœ‰ä»¥åæ¦‚å…¨çš„å«Œç–‘ã€‚\nä¸€è‡´æ€§æ˜¯æŒ‡ï¼šä¿æŒæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€ä¸ªæ—¶åˆ»å…·æœ‰ç›¸åŒçš„ã€é€»è¾‘ä¸€è‡´çš„æ•°æ®ã€‚æ˜¾ç„¶è¿™ç§è§£é‡Šå¹¶ä¸æ˜¯ä»è§‚å¯Ÿè€…çš„è§’åº¦æ¥æè¿°çš„ï¼Œè€Œæ˜¯è¯•å›¾ä»ç³»ç»Ÿå†…éƒ¨çš„è¡Œä¸ºï¼ˆå†…éƒ¨å®ç°ï¼‰æ¥æè¿°çš„ã€‚ã€Œæ‰€æœ‰èŠ‚ç‚¹ã€ï¼Œå¯èƒ½æŒ‡çš„æ˜¯ã€Œæ‰€æœ‰å‰¯æœ¬ã€ï¼›è‡³äºâ€œåœ¨åŒä¸€ä¸ªæ—¶åˆ»å…·æœ‰ç›¸åŒçš„ã€é€»è¾‘ä¸€è‡´çš„æ•°æ®â€è¿™ä¸ªè¯´æ³•ï¼Œåˆ™ä¼¼ä¹ç¦»çº¿æ€§ä¸€è‡´æ€§çš„æœ¬æ¥å«ä¹‰åç¦»å¤ªè¿œäº†ã€‚ä»é€»è¾‘ä¸Šè¯´ï¼Œâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ï¼Œå¹¶ä¸ä¸€å®šéœ€è¦ç³»ç»Ÿâ€œåœ¨åŒä¸€ä¸ªæ—¶åˆ»å…·æœ‰ç›¸åŒçš„ã€é€»è¾‘ä¸€è‡´çš„æ•°æ®â€ã€‚çº¿æ€§ä¸€è‡´æ€§å¯èƒ½æœ‰å¾ˆå¤šç§å®ç°æ–¹å¼ï¼Œè€Œè¿™ç§è§£é‡Šè§„å®šäº†ä¸€ç§å…·ä½“çš„ç³»ç»Ÿå®ç°ï¼ŒåŒæ ·æœ‰ä»¥åæ¦‚å…¨çš„å«Œç–‘ã€‚\n\næˆ‘ä»¬å‰é¢æåˆ°ï¼Œçº¿æ€§ä¸€è‡´æ€§ï¼Œä¹Ÿè¢«ç§°ä¸ºå¼ºä¸€è‡´æ€§ã€‚ä¹‹æ‰€ä»¥è¿™ä¹ˆè¯´ï¼Œå¤§æ¦‚æ˜¯å› ä¸ºçº¿æ€§ä¸€è‡´æ€§è¦æ±‚å¤šä¸ªå‰¯æœ¬ä¸Šçš„æ•°æ®å¿…é¡»ä¿æŒå¦‚æ­¤ä¹‹ã€Œå¼ºã€çš„ä¸€è‡´æ€§ï¼Œä»¥è‡³äºâ€œè®©ç³»ç»Ÿè¡¨ç°å¾—å°±åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ã€‚\nå¦å¤–ï¼Œç½‘ä¸Šçš„èµ„æ–™æåˆ°å¼ºä¸€è‡´æ€§çš„æ—¶å€™ï¼Œè¿˜æœ‰å¯èƒ½ä¼šå…³è”åˆ°åˆ†å¸ƒå¼äº‹åŠ¡ä¸Šé¢ï¼Œæ¯”å¦‚2PC/3PCè¿™äº›åŸå­æäº¤åè®®ã€‚ä½†æŠŠå®ƒä»¬å…³è”åˆ°ä¸€èµ·çš„è¯´æ³•ï¼Œå…¶æ·±å±‚æ¬¡å«ä¹‰åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œåªèƒ½é çŒœæµ‹ã€‚åˆ†å¸ƒå¼äº‹åŠ¡å¤„ç†çš„å¹¶ä¸æ˜¯åŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„å¤šä¸ªå‰¯æœ¬çš„é—®é¢˜ï¼Œè€ŒæŒ‡çš„æ˜¯å°†é’ˆå¯¹å¤šä¸ªæ•°æ®å¯¹è±¡çš„å„ç§æ“ä½œç»„åˆèµ·æ¥ï¼Œæä¾›ACIDçš„ç‰¹æ€§ã€‚å°†åˆ†å¸ƒå¼äº‹åŠ¡çœ‹æˆæ˜¯å¼ºä¸€è‡´æ€§çš„ä¿è¯ï¼ŒçŒœæµ‹å¯èƒ½å®é™…ä¸ŠæŒ‡çš„å°±æ˜¯ACIDçš„åŸå­æ€§ã€‚æ€»ä¹‹ï¼Œã€Œå¼ºä¸€è‡´æ€§ã€è¿™ä¸ªè¯å¾ˆå®¹æ˜“äº§ç”Ÿè¯¯è§£ï¼Œæ‰€ä»¥å»ºè®®è°¨æ…ä½¿ç”¨ã€‚\nåœ¨å†å²ä¸Šï¼ŒCAPå®šç†å…·æœ‰å·¨å¤§çš„çŸ¥ååº¦ï¼Œä½†å®ƒå®é™…çš„å½±å“åŠ›å´æ²¡æœ‰æƒ³è±¡çš„é‚£ä¹ˆå¤§ã€‚éšç€åˆ†å¸ƒå¼ç†è®ºçš„å‘å±•ï¼Œæˆ‘ä»¬é€æ¸è®¤è¯†åˆ°ï¼ŒCAPå¹¶ä¸æ˜¯ä¸€ä¸ªã€Œå¤§ä¸€ç»Ÿã€çš„ç†è®ºï¼Œè¿œä¸èƒ½æ¶µç›–åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡ä¸­æ–¹æ–¹é¢é¢çš„é—®é¢˜ã€‚ç›¸åï¼ŒCAPå¼•å‘äº†å¾ˆå¤šè¯¯è§£å’Œç†è§£ä¸Šçš„æ··ä¹±ï¼ˆç»†èŠ‚ä¸è®¨è®ºäº†ï¼‰ã€‚å› æ­¤ï¼Œå¯ä»¥é¢„è§åˆ°ï¼Œæœªæ¥CAPå®šç†çš„å½±å“å°†ä¼šè¿›ä¸€æ­¥è¢«å‰Šå¼±ã€‚\n","categories":["åˆ†å¸ƒå¼"]},{"title":"æ¶æ„å®‰å…¨æ€§","url":"/posts/27668/","content":"å³ä½¿åªé™å®šåœ¨ â€œè½¯ä»¶æ¶æ„è®¾è®¡â€ è¿™ä¸ªè¯­å¢ƒä¸‹ï¼Œç³»ç»Ÿå®‰å…¨ä»ç„¶æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„è¯é¢˜ã€‚æˆ‘ä»¬è®¨è®ºçš„è®¡ç®—æœºç³»ç»Ÿå®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯æŒ‡ â€œé˜²å¾¡ç³»ç»Ÿè¢«é»‘å®¢æ”»å‡»â€ è¿™æ ·ç‹­éš˜çš„å®‰å…¨ï¼Œè¿˜è‡³å°‘åº”åŒ…æ‹¬ï¼ˆä¸é™äºï¼‰ä»¥ä¸‹è¿™äº›é—®é¢˜çš„å…·ä½“è§£å†³æ–¹æ¡ˆã€‚\n\nè®¤è¯ï¼ˆAuthenticationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•æ­£ç¡®åˆ†è¾¨å‡ºæ“ä½œç”¨æˆ·çš„çœŸå®èº«ä»½ï¼Ÿ\næˆæƒï¼ˆAuthorizationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•æ§åˆ¶ä¸€ä¸ªç”¨æˆ·è¯¥çœ‹åˆ°å“ªäº›æ•°æ®ï¼Œæ“ä½œå“ªäº›åŠŸèƒ½ï¼Ÿ\nå‡­è¯ï¼ˆCredentialï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯å®ƒä¸ç”¨æˆ·ä¹‹é—´çš„æ‰¿è¯ºæ˜¯åŒæ–¹å½“æ—¶çœŸå®æ„å›¾çš„ä½“ç°æ˜¯å‡†ç¡®ã€å®Œæ•´ä¸”ä¸å¯æŠµèµ–çš„ï¼Ÿ\nä¿å¯†ï¼ˆConfidentialityï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯æ•æ„Ÿæ•°æ®æ— æ³•è¢«åŒ…æ‹¬ç³»ç»Ÿç®¡ç†å‘˜åœ¨å†…çš„å†…å¤–éƒ¨äººå‘˜æ‰€çªƒå–ã€æ»¥ç”¨ï¼Ÿ\nä¼ è¾“ï¼ˆTransport Securityï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ä¿è¯é€šè¿‡ç½‘ç»œä¼ è¾“çš„ä¿¡æ¯æ— æ³•è¢«ç¬¬ä¸‰æ–¹çªƒå¬ã€ç¯¡æ”¹å’Œå†’å……ï¼Ÿ\néªŒè¯ï¼ˆVerificationï¼‰ï¼šç³»ç»Ÿå¦‚ä½•ç¡®ä¿æäº¤åˆ°æ¯é¡¹æœåŠ¡ä¸­çš„æ•°æ®æ˜¯åˆä¹è§„åˆ™çš„ï¼Œä¸ä¼šå¯¹ç³»ç»Ÿç¨³å®šæ€§ã€æ•°æ®ä¸€è‡´æ€§ã€æ­£ç¡®æ€§äº§ç”Ÿé£é™©ï¼Ÿ\n\nä¸å®‰å…¨ç›¸å…³çš„é—®é¢˜ï¼Œä¸€èˆ¬ä¸ä¼šç›´æ¥åˆ›é€ ä»·å€¼ï¼Œè§£å†³èµ·æ¥åˆçƒ¦çå¤æ‚ï¼Œè´¹æ—¶è´¹åŠ›ï¼Œå¾ˆå®¹æ˜“è¢«å¼€å‘äººå‘˜å¿½ç•¥ï¼Œä½†åº†å¹¸çš„æ˜¯è¿™äº›é—®é¢˜åŸºæœ¬ä¸Šä¹Ÿéƒ½æ˜¯ä¸å…·ä½“ç³»ç»Ÿã€å…·ä½“ä¸šåŠ¡æ— å…³çš„é€šç”¨æ€§é—®é¢˜ï¼Œè¿™æ„å‘³ç€å®ƒä»¬å¾€å¾€ä¼šå­˜åœ¨ä¸šç•Œé€šè¡Œçš„ã€å·²è¢«éªŒè¯è¿‡æ˜¯è¡Œä¹‹æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆï¼Œç”šè‡³å·²ç»å½¢æˆè¡Œä¸šæ ‡å‡†ï¼Œä¸éœ€è¦å¼€å‘è€…è‡ªå·±ä»å¤´å»æ„æ€å¦‚ä½•è§£å†³ã€‚\næ­¤å¤–ï¼Œè¿˜æœ‰å…¶ä»–ä¸€äº›ä¸å®‰å…¨ç›¸å…³çš„å†…å®¹ä¸»è¦æ˜¯ç”±ç®¡ç†ã€è¿ç»´ã€å®¡è®¡é¢†åŸŸä¸ºä¸»å¯¼ï¼Œå°½ç®¡ä¹Ÿéœ€è¦è½¯ä»¶æ¶æ„å’Œå¼€å‘äººå‘˜çš„é…åˆå‚ä¸ï¼Œä½†ä¸åˆ—äººæœ¬ç« çš„è®¨è®ºèŒƒå›´ä¹‹å†…ï¼Œè­¬å¦‚å®‰å…¨å®¡è®¡ã€ç³»ç»Ÿå¤‡ä»½ä¸æ¢å¤ã€ä¿¡æ¯ç³»ç»Ÿå®‰å…¨æ³•è§„ä¸åˆ¶åº¦è®¡ç®—æœºé˜²ç—…æ¯’åˆ¶åº¦ã€ä¿æŠ¤ç§æœ‰ä¿¡æ¯è§„åˆ™ç­‰ã€‚\nä¸€ã€è®¤è¯è®¤è¯ã€æˆæƒå’Œå‡­è¯å¯ä»¥è¯´æ˜¯ä¸€ä¸ªç³»ç»Ÿä¸­æœ€åŸºç¡€çš„å®‰å…¨è®¾è®¡ï¼Œå“ªæ€•å†ç®€é™‹çš„ä¿¡æ¯ç³»ç»Ÿå¤§æ¦‚ä¹Ÿä¸å¯èƒ½å¿½ç•¥ â€œç”¨æˆ·ç™»å½•â€ åŠŸèƒ½ã€‚ä¿¡æ¯ç³»ç»Ÿä¸ºç”¨æˆ·æä¾›æœåŠ¡ä¹‹å‰ï¼Œæ€»æ˜¯å¸Œæœ›å…ˆå¼„æ¸…æ¥š â€œä½ æ˜¯è°â€ï¼ˆè®¤è¯ï¼‰ã€â€œä½ èƒ½å¹²ä»€ä¹ˆâ€ï¼ˆæˆæƒï¼‰ä»¥åŠ â€œä½ å¦‚ä½•è¯æ˜â€ï¼ˆå‡­è¯ï¼‰è¿™ä¸‰ä¸ªåŸºæœ¬é—®é¢˜ã€‚ç„¶è€Œï¼Œè¿™ä¸‰ä¸ªåŸºæœ¬é—®é¢˜åˆä¸åƒéƒ¨åˆ†å¼€å‘è€…è®¤ä¸ºçš„é‚£æ ·ï¼Œåªæ˜¯ä¸€ä¸ª â€œç³»ç»Ÿç™»å½•â€ åŠŸèƒ½ï¼Œä»…ä»…æ˜¯æ ¡éªŒä¸€ä¸‹ç”¨æˆ·åã€å¯†ç æ˜¯å¦æ­£ç¡®è¿™ä¹ˆç®€å•ã€‚è´¦æˆ·å’Œæƒé™ä½œä¸ºä¸€ç§å¿…é¡»æœ€å¤§é™åº¦ä¿éšœå®‰å…¨å’Œéšç§ï¼ŒåŒæ—¶åˆè¦å…¼é¡¾å„ä¸ªç³»ç»Ÿæ¨¡å—ç”šè‡³ç³»ç»Ÿé—´å…±äº«è®¿é—®çš„åŸºç¡€ä¸»æ•°æ®ï¼Œå®ƒçš„å­˜å‚¨ã€ç®¡ç†ä¸ä½¿ç”¨éƒ½é¢ä¸´ä¸€ç³»åˆ—å¤æ‚çš„é—®é¢˜ã€‚å¯¹äºæŸäº›å¤§è§„æ¨¡çš„ä¿¡æ¯ç³»ç»Ÿï¼Œè´¦æˆ·å’Œæƒé™çš„ç®¡ç†å¾€å¾€è¦ç”±ä¸“é—¨çš„åŸºç¡€è®¾æ–½æ¥è´Ÿè´£ï¼Œè­¬å¦‚å¾®è½¯çš„æ´»åŠ¨ç›®å½•ï¼ˆActive Directoryï¼ŒADï¼‰æˆ–è€…è½»é‡ç›®å½•è®¿é—®åè®®ï¼ˆLightweight Directory Access Protocolï¼ŒLDAPï¼‰ï¼Œè·¨ç³»ç»Ÿçš„å…±äº«ä½¿ç”¨ç”šè‡³ä¼šç”¨åˆ°åŒºå—é“¾æŠ€æœ¯ã€‚\nå¦å¤–è¿˜æœ‰ä¸€ä¸ªè®¤çŸ¥åå·®ï¼šå°½ç®¡ â€œè®¤è¯â€ æ˜¯è§£å†³ â€œä½ æ˜¯è°â€ çš„é—®é¢˜ï¼Œä½†è¿™é‡Œçš„ â€œä½ â€ å¹¶ä¸ä¸€å®šæ˜¯æŒ‡äººï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å¤–éƒ¨çš„ä»£ç ï¼Œå³ç¬¬ä¸‰æ–¹çš„ç±»åº“æˆ–è€…æœåŠ¡ã€‚æœ€åˆï¼Œå¯¹ä»£ç è®¤è¯çš„é‡è¦ç¨‹åº¦ç”šè‡³é«˜äºå¯¹æœ€ç»ˆç”¨æˆ·çš„è®¤è¯ï¼Œè­¬å¦‚åœ¨æ—©æœŸçš„ Java ç³»ç»Ÿé‡Œï¼Œå®‰å…¨è®¤è¯é»˜è®¤æ˜¯ç‰¹æŒ‡ â€œä»£ç çº§å®‰å…¨â€ï¼Œå³ä½ æ˜¯å¦ä¿¡ä»»è¦åœ¨ç”µè„‘ä¸­è¿è¡Œçš„ä»£ç ã€‚è¿™æ˜¯ç”± Java å½“æ—¶çš„ä¸»è¦åº”ç”¨å½¢å¼â€”â€” Java Applets æ‰€å†³å®šçš„ï¼šç±»åŠ è½½å™¨ä»è¿œç«¯ä¸‹è½½ä¸€æ®µå­—èŠ‚ç ï¼Œä»¥ Applets çš„å½¢å¼åœ¨ç”¨æˆ·çš„æµè§ˆå™¨ä¸­è¿è¡Œï¼Œç”±äºJavaæ“æ§è®¡ç®—æœºèµ„æºçš„èƒ½åŠ›è¦è¿œè¿œå¼ºäº JavaScriptï¼Œå› æ­¤å¿…é¡»å…ˆç¡®ä¿è¿™äº›ä»£ç ä¸ä¼šæŸå®³ç”¨æˆ·çš„è®¡ç®—æœºã€‚è¿™ä¸€é˜¶æ®µçš„å®‰å…¨è§‚å¿µå‚¬ç”Ÿäº†ç°åœ¨ä»ç„¶å­˜åœ¨äº Java æŠ€æœ¯ä½“ç³»ä¸­çš„ â€œå®‰å…¨ç®¡ç†å™¨â€ï¼ˆjava.lang.SecurityManagerï¼‰ã€â€œä»£ç æƒé™è®¸å¯â€ï¼ˆjava.lang.RuntimePermissionï¼‰ç­‰æ¦‚å¿µã€‚å¦‚ä»Šï¼Œå¯¹å¤–éƒ¨ç±»åº“å’ŒæœåŠ¡çš„è®¤è¯éœ€æ±‚ä¾ç„¶æ™®éï¼Œä½†ç›¸æ¯”èµ·äº”èŠ±å…«é—¨çš„æœ€ç»ˆç”¨æˆ·è®¤è¯æ¥è¯´ï¼Œä»£ç è®¤è¯çš„ç ”ç©¶æ–¹å‘å·²ç»å¾ˆå›ºå®šï¼ŒåŸºæœ¬ä¸Šéƒ½ç»Ÿä¸€åˆ°è¯ä¹¦ç­¾åä¸Šã€‚åœ¨æœ¬èŠ‚ä¸­ï¼Œè®¤è¯çš„èŒƒå›´åªé™äºå¯¹æœ€ç»ˆç”¨æˆ·çš„è®¤è¯ï¼Œè€Œä»£ç è®¤è¯ä¼šå®‰æ’åœ¨åé¢9.2èŠ‚ä¸­è®²è§£ã€‚\n1. è®¤è¯çš„æ ‡å‡†ä¸–çºªä¹‹äº¤ï¼ŒJava è¿æ¥äº† Web çš„è¾‰ç…Œæ—¶ä»£ï¼Œäº’è”ç½‘çš„è¿…é€Ÿå…´èµ·ä¿ƒä½¿ Java è¿›äººå¿«é€Ÿå‘å±•æ—¶æœŸã€‚è¿™æ—¶å€™ï¼ŒåŸºäº HTML å’Œ JavaScript çš„è¶…æ–‡æœ¬Web åº”ç”¨è¿…é€Ÿè¶…è¿‡äº† â€œJava 2 æ—¶ä»£â€ ä¹‹å‰çš„ Java Applets åº”ç”¨ï¼ŒB/S ç³»ç»Ÿå¯¹æœ€ç»ˆç”¨æˆ·è®¤è¯çš„éœ€æ±‚ä½¿å¾— â€œå®‰å…¨è®¤è¯â€ çš„é‡ç‚¹é€æ¸ä» â€œä»£ç çº§å®‰å…¨â€ è½¬ä¸º â€œç”¨æˆ·çº§å®‰å…¨â€ï¼Œå³ä½ æ˜¯å¦ä¿¡ä»»æ­£åœ¨æ“ä½œçš„ç”¨æˆ·ã€‚åœ¨1999å¹´ï¼Œéš J2EE 1.2 å‘å¸ƒçš„ Servlet 2.2 ä¸­æ·»åŠ äº†ä¸€ç³»åˆ—ç”¨äºè®¤è¯çš„ APIï¼Œä¸»è¦åŒ…æ‹¬ä¸‹åˆ—ä¸¤éƒ¨åˆ†å†…å®¹ï¼š\n\næ ‡å‡†æ–¹é¢ï¼Œæ·»åŠ äº†å››ç§å†…ç½®çš„ã€ä¸å¯æ‰©å±•çš„è®¤è¯æ–¹æ¡ˆï¼Œå³ Client-Certã€Basicã€Digest å’Œ Formï¼›\nå®ç°æ–¹é¢ï¼Œæ·»åŠ äº†ä¸€å¥—ä¸è®¤è¯å’Œæˆæƒç›¸å…³çš„ç¨‹åºæ¥å£ï¼Œè­¬å¦‚ HttpServletRequest::isUserInRole()ã€HttpServletRequest::getUserPrincipal()ç­‰æ–¹æ³•ã€‚\n\nä¸€é¡¹å‘å¸ƒè¶…è¿‡20å¹´çš„è€æ—§æŠ€æœ¯ï¼ŒåŸæœ¨å¹¶æ²¡æœ‰ä»€ä¹ˆä¸“é—¨æèµ·çš„å¿…è¦æ€§ï¼Œç¬”è€…ä¹‹æ‰€ä»¥å¼•ç”¨è¿™ä»¶äº‹ï¼Œæ˜¯å¸Œæœ›ä»å®ƒåŒ…å«çš„ä¸¤éƒ¨åˆ†å†…å®¹ä¸­å¼•å‡ºä¸€ä¸ªæ¶æ„å®‰å…¨æ€§çš„ç»éªŒåŸåˆ™ï¼šä»¥æ ‡å‡†è§„èŒƒä¸ºæŒ‡å¯¼ã€ä»¥æ ‡å‡†æ¥å£å»å®ç°ã€‚å®‰å…¨æ¶‰åŠçš„é—®é¢˜å¾ˆéº»çƒ¦ï¼Œä½†è§£å†³æ–¹æ¡ˆå·²ç›¸å½“æˆç†Ÿï¼Œå¯¹äº99%çš„ç³»ç»Ÿæ¥è¯´ã€åœ¨å®‰å…¨ä¸Šä¸å»åšè½®å­ï¼Œä¸å»æƒ³å‘æ˜åˆ›é€ ï¼Œä¸¥æ ¼éµå¾ªæ ‡å‡†ï¼Œå°±æ˜¯æœ€æ°å½“çš„å®‰å…¨è®¾è®¡ã€‚\nå¼•ç”¨ J2EE1.2 å¯¹å®‰å…¨çš„æ”¹è¿›è¿˜æœ‰å¦ä¸€ä¸ªåŸå› ï¼Œå®ƒå†…ç½®çš„ Client-Certã€Basicã€Digest å’Œ Form è¿™å››ç§è®¤è¯æ–¹æ¡ˆéƒ½å¾ˆæœ‰ä»£è¡¨æ€§ï¼Œåˆšå¥½åˆ†åˆ«è¦†ç›–äº†é€šä¿¡ä¿¡é“ã€åè®®å’Œå†…å®¹å±‚é¢çš„è®¤è¯ã€‚è€Œè¿™ä¸‰ç§å±‚é¢çš„è®¤è¯æ°å¥½æ¶µç›–äº†ä¸»æµçš„ä¸‰ç§è®¤è¯æ–¹å¼ï¼Œå…·ä½“å«ä¹‰å’Œåº”ç”¨åœºæ™¯åˆ—ä¸¾å¦‚ä¸‹ã€‚\n\né€šä¿¡ä¿¡é“ä¸Šçš„è®¤è¯ï¼šä½ å’Œæˆ‘å»ºç«‹é€šä¿¡è¿æ¥ä¹‹å‰ï¼Œè¦å…ˆè¯æ˜ä½ æ˜¯è°ã€‚åœ¨ç½‘ç»œä¼ è¾“ï¼ˆNetworkï¼‰åœºæ™¯ä¸­çš„å…¸å‹åº”ç”¨æ˜¯åŸºäº SSL/TLS ä¼ è¾“å®‰å…¨å±‚çš„è®¤è¯ã€‚\né€šä¿¡åè®®ä¸Šçš„è®¤è¯ï¼šä½ è¯·æ±‚è·å–æˆ‘çš„èµ„æºä¹‹å‰ï¼Œè¦å…ˆè¯æ˜ä½ æ˜¯è°ã€‚åœ¨äº’è”ç½‘ï¼ˆInternetï¼‰åœºæ™¯ä¸­çš„å…¸å‹åº”ç”¨æ˜¯åŸºäº HTTP åè®®çš„è®¤è¯ã€‚\né€šä¿¡å†…å®¹ä¸Šçš„è®¤è¯ï¼šä½ ä½¿ç”¨æˆ‘æä¾›çš„æœåŠ¡ä¹‹å‰ï¼Œè¦å…ˆè¯æ˜ä½ æ˜¯è°ã€‚åœ¨ä¸‡ç»´ç½‘ï¼ˆWorld Wide Webï¼‰åœºæ™¯ä¸­çš„å…¸å‹åº”ç”¨æ˜¯åŸºäºWebå†…å®¹çš„è®¤è¯ã€‚\n\nå…³äºé€šä¿¡ä¿¡é“ä¸Šçš„è®¤è¯ï¼Œç”±äºå†…å®¹è¾ƒå¤šï¼Œåˆä¸åç»­ä»‹ç»å¾®æœåŠ¡å®‰å…¨æ–¹é¢çš„è¯é¢˜å¯†åˆ‡ç›¸å…³ï¼Œæ‰€ä»¥å°†ç‹¬ç«‹æ”¾åˆ°5.5èŠ‚ä»‹ç»ã€è€Œä¸”J2EEä¸­çš„Client-Cert å…¶å®å¹¶ä¸æ˜¯ç”¨äºTLSçš„ï¼Œä»¥å®ƒå¼•å‡º TLS å¹¶ä¸åˆé€‚ã€‚ä¸‹é¢é‡ç‚¹äº†è§£åŸºäºé€šä¿¡åè®®å’Œé€šä¿¡å†…å®¹çš„ä¸¤ç§è®¤è¯æ–¹å¼ã€‚\n1ï¼‰HTTP è®¤è¯å‰æ–‡å·²ç»æå‰ç”¨åˆ°äº†ä¸€ä¸ªæŠ€æœ¯åè¯â€”â€”è®¤è¯æ–¹æ¡ˆï¼ˆAuthentication Schemeï¼‰ï¼Œå®ƒæ˜¯æŒ‡ç”Ÿæˆç”¨æˆ·èº«ä»½å‡­è¯çš„æŸç§æ–¹æ³•ï¼Œè¿™ä¸ªæ¦‚å¿µæœ€åˆæºäº  HTTP åè®®çš„è®¤è¯æ¡†æ¶ï¼ˆAuthentication Frameworkï¼‰ã€‚IETF åœ¨ RFC 7235 ä¸­å®šä¹‰äº† HTTP åè®®çš„é€šç”¨è®¤è¯æ¡†æ¶ï¼Œè¦æ±‚æ‰€æœ‰æ”¯æŒ HTTP åè®®çš„æœåŠ¡å™¨ï¼Œåœ¨æœªæˆæƒçš„ç”¨æˆ·æ„å›¾è®¿é—®æœåŠ¡ç«¯ä¿æŠ¤åŒºåŸŸçš„èµ„æºæ—¶ï¼Œåº”è¿”å› 401 Unauthorized çš„çŠ¶æ€ç ï¼ŒåŒæ—¶åº”åœ¨å“åº”æŠ¥æ–‡å¤´é‡Œé™„å¸¦ä»¥ä¸‹ä¸¤ä¸ªåˆ†åˆ«ä»£è¡¨ç½‘é¡µè®¤è¯å’Œä»£ç†è®¤è¯çš„ Header ä¹‹ä¸€ï¼Œå‘ŠçŸ¥å®¢æˆ·ç«¯åº”è¯¥é‡‡å–ä½•ç§æ–¹å¼äº§ç”Ÿèƒ½ä»£è¡¨è®¿é—®è€…èº«ä»½çš„å‡­è¯ä¿¡æ¯ï¼š\n\nWWW-Authenticateï¼š&lt;è®¤è¯æ–¹æ¡ˆ&gt; realm=&lt;ä¿æŠ¤åŒºåŸŸçš„æè¿°ä¿¡æ¯&gt;\nProxy-Authenticateï¼š&lt;è®¤è¯æ–¹æ¡ˆ&gt; realm=&lt;ä¿æŠ¤åŒºåŸŸçš„æè¿°ä¿¡æ¯&gt;\n\næ¥æ”¶åˆ°è¯¥å“åº”åï¼Œå®¢æˆ·ç«¯å¿…é¡»éµå¾ªæœåŠ¡ç«¯æŒ‡å®šçš„è®¤è¯æ–¹æ¡ˆï¼Œåœ¨è¯·æ±‚èµ„æºçš„æŠ¥æ–‡å¤´åŠ å…¥èº«ä»½å‡­è¯ä¿¡æ¯ï¼Œç”±æœåŠ¡ç«¯æ ¸å®é€šè¿‡åæ‰ä¼šå…è®¸è¯¥è¯·æ±‚æ­£å¸¸è¿”å›ï¼Œå¦åˆ™å°†è¿”å› 403 Forbidden é”™è¯¯ã€‚è¯·æ±‚å¤´æŠ¥æ–‡åº”åŒ…å«ä»¥ä¸‹Headeré¡¹ä¹‹ä¸€ï¼š\n\nAuthorizationï¼š &lt;è®¤è¯æ–¹æ¡ˆ&gt; &lt;å‡­è¯å†…å®¹&gt;Proxy-Authorizationï¼š&lt;è®¤è¯æ–¹æ¡ˆ&gt; &lt;å‡­è¯å†…å®¹&gt;\n\nHTTP è®¤è¯æ¡†æ¶æå‡ºè®¤è¯æ–¹æ¡ˆæ˜¯å¸Œæœ›èƒ½æŠŠè®¤è¯ â€œè¦äº§ç”Ÿèº«ä»½å‡­è¯â€ çš„ç›®çš„ä¸ â€œå…·ä½“å¦‚ä½•äº§ç”Ÿå‡­è¯â€ çš„å®ç°åˆ†ç¦»å¼€æ¥ï¼Œæ— è®ºå®¢æˆ·ç«¯é€šè¿‡ç”Ÿç‰©ä¿¡æ¯ï¼ˆæŒ‡çº¹ã€äººè„¸ï¼‰ã€ç”¨æˆ·å¯†ç ã€æ•°å­—è¯ä¹¦æŠ‘æˆ–å…¶ä»–æ–¹å¼æ¥ç”Ÿæˆå‡­è¯ï¼Œéƒ½å±äºå¦‚ä½•ç”Ÿæˆå‡­è¯çš„å…·ä½“å®ç°ï¼Œéƒ½å¯ä»¥åŒ…å«åœ¨HTTPåè®®é¢„è®¾çš„æ¡†æ¶ä¹‹å†…ã€‚HTTPè®¤è¯æ¡†æ¶çš„å·¥ä½œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nä»¥ä¸Šæ¦‚å¿µæ€§çš„ä»‹ç»å¯èƒ½ä¼šæœ‰äº›æ¯ç‡¥æŠ½è±¡ï¼Œä¸‹é¢ç¬”è€…å°†ä»¥æœ€åŸºç¡€çš„è®¤è¯æ–¹æ¡ˆ â€œHTTP Basic è®¤è¯â€ ä¸ºä¾‹æ¥ä»‹ç»è®¤è¯æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚HTTP Basic è®¤è¯æ˜¯ä¸€ç§ä¸»è¦ä»¥æ¼”ç¤ºä¸ºç›®çš„çš„è®¤è¯æ–¹æ¡ˆï¼Œä¹Ÿåº”ç”¨äºä¸€äº›ä¸è¦æ±‚å®‰å…¨æ€§çš„åœºåˆï¼Œè­¬å¦‚å®¶é‡Œçš„è·¯ç”±å™¨ç™»å½•ç­‰ã€‚Basic è®¤è¯äº§ç”Ÿç”¨æˆ·èº«ä»½å‡­è¯çš„æ–¹æ³•æ˜¯è®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œç»è¿‡ Base64 ç¼–ç  â€œåŠ å¯†â€ åä½œä¸ºèº«ä»½å‡­è¯ã€‚è­¬å¦‚è¯·æ±‚èµ„æºâ€œGET/adminâ€åï¼Œæµè§ˆå™¨ä¼šæ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å¦‚ä¸‹å“åº”ï¼š\n\nHTTP/1.1 401 UnauthorizedDate:  Mon, 24 Feb 2020 16ï¼š50ï¼š53 GMTWWW-Authenticate: Basic realm=â€example from icyfenix.cnâ€\n\næ­¤æ—¶ï¼Œæµè§ˆå™¨å¿…é¡»è¯¢é—®æœ€ç»ˆç”¨æˆ·ï¼Œå³å¼¹å‡ºå¦‚å›¾æ‰€ç¤ºçš„ HTTP Basic è®¤è¯å¯¹è¯æ¡†ï¼Œè¦æ±‚æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚\n\nç”¨æˆ·åœ¨å¯¹è¯æ¡†ä¸­è¾“å…¥å¯†ç ä¿¡æ¯ï¼Œè­¬å¦‚è¾“å…¥ç”¨æˆ·å â€œicyfenixâ€ï¼Œå¯†ç  â€œ123456â€ï¼Œæµè§ˆå™¨ä¼šå°†å­—ç¬¦ä¸² â€œicyfenixï¼š123456â€ ç¼–ç ä¸ºâ€œaWN5ZmVuaXg6MTIzNDU2â€ï¼Œç„¶åå‘é€ç»™æœåŠ¡ç«¯ï¼ŒHTTP è¯·æ±‚å¦‚ä¸‹æ‰€ç¤ºï¼š\n\nGET /admin HTTP/1.1Authorizationï¼š Basic aWN5zmVuaXg6MTIzNDU2\n\næœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚ï¼Œè§£ç åæ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç æ˜¯å¦åˆæ³•ï¼Œå¦‚æœåˆæ³•å°±è¿”å› â€œ/adminâ€œçš„èµ„æºï¼Œå¦åˆ™å°±è¿”å› 403 Forbidden é”™è¯¯ï¼Œç¦æ­¢ä¸‹ä¸€æ­¥æ“ä½œã€‚æ³¨æ„ Base64 åªæ˜¯ä¸€ç§ç¼–ç æ–¹å¼ï¼Œå¹¶éä»»ä½•å½¢å¼çš„åŠ å¯†ï¼Œæ‰€ä»¥ Basic è®¤è¯çš„é£é™©æ˜¯æ˜¾è€Œæ˜“è§çš„ã€‚é™¤ Basic è®¤è¯å¤–ï¼ŒIETF è¿˜å®šä¹‰äº†å¾ˆå¤šç§å¯ç”¨äºå®é™…ç”Ÿäº§ç¯å¢ƒçš„è®¤è¯æ–¹æ¡ˆï¼Œåˆ—ä¸¾å¦‚ä¸‹ã€‚\n\nDigestï¼šRFC 7616ï¼ŒHTTPæ‘˜è¦è®¤è¯ï¼Œå¯è§†ä¸ºBasicè®¤è¯çš„æ”¹è‰¯ç‰ˆæœ¬ã€‚é’ˆå¯¹Base64æ˜æ–‡å‘é€çš„é£é™©ï¼ŒDigestè®¤è¯æŠŠç”¨æˆ·åå’Œå¯†ç åŠ ç›ï¼ˆä¸€ä¸ªè¢«ç§°ä¸º Nonce çš„å˜åŒ–å€¼ä½œä¸ºç›å€¼ï¼‰åå†é€šè¿‡MD5/SHAç­‰å“ˆå¸Œç®—æ³•å–æ‘˜è¦å‘é€å‡ºå»ã€‚ä½†æ˜¯è¿™ç§è®¤è¯æ–¹å¼ä¾ç„¶æ˜¯ä¸å®‰å…¨çš„ï¼Œæ— è®ºå®¢æˆ·ç«¯ä½¿ç”¨ä½•ç§åŠ å¯†ç®—æ³•åŠ å¯†ï¼Œæ— è®ºæ˜¯å¦é‡‡ç”¨äº†Nonce è¿™æ ·çš„åŠ¨æ€ç›å€¼å»æŠµå¾¡é‡æ”¾å’Œå†’è®¤ï¼Œé‡åˆ°ä¸­é—´äººæ”»å‡»æ—¶ä¾ç„¶å­˜åœ¨æ˜¾è‘—çš„å®‰å…¨é£é™©ã€‚å…³äºåŠ è§£å¯†çš„é—®é¢˜ï¼Œå°†åœ¨åè¾¹è¯¦ç»†è®¨è®ºã€‚\nBearerï¼šRFC 6750ï¼ŒåŸºäº OAuth2 è§„èŒƒæ¥å®Œæˆè®¤è¯ã€‚OAuth 2 æ˜¯ä¸€ä¸ªåŒæ—¶æ¶‰åŠè®¤è¯ä¸æˆæƒçš„åè®®ï¼Œå…·ä½“å°†åœ¨åè¾¹èŠ‚è¯¦ç»†ä»‹ç»ã€‚\nHOBAï¼ˆHTTP Origin-Bound Authenticationï¼‰ï¼šRFC 7486ï¼Œä¸€ç§åŸºäºè‡ªç­¾åè¯ä¹¦çš„è®¤è¯æ–¹æ¡ˆã€‚åŸºäºæ•°å­—è¯ä¹¦çš„ä¿¡ä»»å…³ç³»ä¸»è¦æœ‰ä¸¤ç±»æ¨¡å‹ï¼šä¸€ç±»æ˜¯é‡‡ç”¨ CAï¼ˆCertification Authorityï¼Œè®¤è¯æœºæ„ï¼‰å±‚æ¬¡ç»“æ„çš„æ¨¡å‹ï¼Œç”±CAä¸­å¿ƒç­¾å‘è¯ä¹¦ï¼›å¦ä¸€ç§æ˜¯ä»¥ IETFçš„ Token Binding åè®®ä¸ºåŸºç¡€çš„ OBCï¼ˆOrigin Bound Certificateï¼ŒåŸäº§åœ°è¯ä¹¦ï¼‰è‡ªç­¾åè¯ä¹¦æ¨¡å‹ã€‚åè¾¹å°†è¯¦ç»†ä»‹ç»æ•°å­—è¯ä¹¦ã€‚\n\nHTTPè®¤è¯æ¡†æ¶ä¸­çš„è®¤è¯æ–¹æ¡ˆæ˜¯å…è®¸è‡ªè¡Œæ‰©å±•çš„ï¼Œå¹¶ä¸è¦æ±‚ä¸€å®šç”±RFCè§„èŒƒæ¥å®šä¹‰ï¼Œåªè¦ç”¨æˆ·ä»£ç†ï¼ˆUserAgentï¼Œé€šå¸¸æ˜¯æµè§ˆå™¨ã€æ³›æŒ‡ä»»ä½•ä½¿ç”¨HTTPåè®®çš„ç¨‹åºï¼‰èƒ½å¤Ÿè¯†åˆ«ç§ç§æœ‰çš„è®¤è¯æ–¹æ¡ˆå³å¯ã€‚å› æ­¤ï¼Œå¾ˆå¤šå‚å•†ä¹Ÿæ‰©å±•äº†è‡ªå·±çš„è®¤è¯æ–¹æ¡ˆã€‚\n\nAWS4-HMAC-SHA256ï¼šäºšé©¬é€Š AWS åŸºäº HMAC-SHA256 å“ˆå¸Œç®—æ³•çš„è®¤è¯ã€‚\nNTLM / Negotiateï¼šå¾®è½¯å…¬å¸ NTLAN Managerï¼ˆNTLMï¼‰ç”¨åˆ°çš„ä¸¤ç§è®¤è¯æ–¹å¼ã€‚\nWindows Live IDï¼šå¾®è½¯å…¬å¸å¼€å‘å¹¶æä¾›çš„ â€œç»Ÿä¸€ç™»äººâ€ è®¤è¯ã€‚\nTwitter Basicï¼šTwitter æ”¹è‰¯çš„ HTTP åŸºç¡€è®¤è¯ã€‚\n\n2ï¼‰Web è®¤è¯lETF ä¸º HTTP è®¤è¯æ¡†æ¶è®¾è®¡äº†å¯æ’æ‹”ï¼ˆPluggableï¼‰çš„è®¤è¯æ–¹æ¡ˆï¼ŒåŸæœ¬æ˜¯å¸Œæœ›èƒ½æ¶Œç°å‡ºå„å¼å„æ ·çš„è®¤è¯æ–¹æ¡ˆå»æ”¯æŒä¸åŒçš„åº”ç”¨åœºæ™¯ã€‚å°½ç®¡ä¸ŠèŠ‚åˆ—ä¸¾äº†ä¸€äº›è¿˜ç®—å¸¸ç”¨çš„è®¤è¯æ–¹æ¡ˆã€‚ä½†ç›®å‰çš„ä¿¡æ¯ç³»ç»Ÿï¼Œå°¤å…¶æ˜¯åœ¨ç³»ç»Ÿå¯¹ç»ˆç«¯ç”¨æˆ·çš„è®¤è¯åœºæ™¯ä¸­ï¼Œç›´æ¥é‡‡ç”¨ HTTP è®¤è¯æ¡†æ¶çš„æ¯”ä¾‹å…¶å®ååˆ†ä½ã€‚è¿™ä¸éš¾ç†è§£ï¼ŒHTTP æ˜¯â€œè¶…æ–‡æœ¬ä¼ è¾“åè®®â€ï¼Œä¼ è¾“åè®®çš„æ ¹æœ¬èŒè´£æ˜¯æŠŠèµ„æºä»æœåŠ¡ç«¯ä¼ è¾“åˆ°å®¢æˆ·ç«¯ï¼Œè‡³äºèµ„æºå…·ä½“æ˜¯ä»€ä¹ˆå†…å®¹ï¼Œåªèƒ½ç”±å®¢æˆ·ç«¯è‡ªè¡Œè§£æé©±åŠ¨ã€‚ä»¥ HTTP åè®®ä¸ºåŸºç¡€çš„è®¤è¯æ¡†æ¶ä¹Ÿåªèƒ½é¢å‘ä¼ è¾“åè®®è€Œä¸æ˜¯å…·ä½“ä¼ è¾“å†…å®¹æ¥è®¾è®¡ï¼Œå¦‚æœç”¨æˆ·æƒ³è¦ä»æœåŠ¡å™¨ä¸­ä¸‹è½½æ–‡ä»¶ï¼Œå¼¹å‡ºä¸€ä¸ª HTTP æœåŠ¡å™¨çš„å¯¹è¯æ¡†ï¼Œè®©ç”¨æˆ·ç™»å½•æ˜¯å¯æ¥å—çš„ï¼›ä½†å¦‚æœç”¨æˆ·æƒ³è®¿é—®ä¿¡æ¯ç³»ç»Ÿä¸­çš„å…·ä½“æœåŠ¡ï¼Œè‚¯å®šå¸Œæœ›èº«ä»½è®¤è¯æ˜¯ç”±ç³»ç»Ÿæœ¬èº«çš„åŠŸèƒ½å»å®Œæˆï¼Œè€Œä¸æ˜¯ç”± HTTP æœåŠ¡å™¨æ¥è´Ÿè´£è®¤è¯ã€‚è¿™ç§ä¾é å†…å®¹è€Œä¸æ˜¯ä¼ è¾“åè®®æ¥å®ç°çš„è®¤è¯æ–¹å¼ï¼Œåœ¨ä¸‡ç»´ç½‘é‡Œè¢«ç§°ä¸ºâ€œWebè®¤è¯â€ï¼Œç”±äºå®ç°å½¢å¼ä¸Šç™»å½•è¡¨å•å äº†ç»å¯¹çš„ä¸»æµï¼Œå› æ­¤é€šå¸¸ä¹Ÿè¢«ç§°ä¸ºâ€œè¡¨å•è®¤è¯â€ï¼ˆForm Authenticationï¼‰ã€‚\nç›´è‡³2019å¹´ä»¥å‰ï¼Œè¡¨å•è®¤è¯éƒ½æ²¡æœ‰ä»€ä¹ˆè¡Œä¸šæ ‡å‡†å¯å¾ªï¼Œå¦‚è¡¨å•æ˜¯ä»€ä¹ˆæ ·ï¼Œå…¶ä¸­çš„ç”¨æˆ·å­—æ®µã€å¯†ç å­—æ®µã€éªŒè¯ç å­—æ®µæ˜¯å¦è¦åœ¨å®¢æˆ·ç«¯åŠ å¯†ï¼Œé‡‡ç”¨ä½•ç§æ–¹å¼åŠ å¯†ï¼Œæ¥å—è¡¨å•çš„æœåŠ¡åœ°å€æ˜¯ä»€ä¹ˆï¼Œç­‰ç­‰ï¼Œéƒ½å®Œå…¨ç”±æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯çš„å¼€å‘è€…è‡ªè¡Œåå•†å†³å®šã€‚â€œæ²¡æœ‰æ ‡å‡†çš„çº¦æŸâ€åå€’æˆäº†è¡¨å•è®¤è¯çš„ä¸€å¤§ä¼˜ç‚¹ï¼Œå®ƒå…è®¸æˆ‘ä»¬åšå‡ºäº”èŠ±å…«é—¨çš„é¡µé¢ï¼Œå„ç§ç¨‹åºè¯­è¨€ã€æ¡†æ¶æˆ–å¼€å‘è€…æœ¬èº«éƒ½å¯ä»¥è‡ªè¡Œå†³å®šè®¤è¯çš„å…¨å¥—äº¤äº’ç»†èŠ‚ã€‚\nå¯èƒ½ä½ è¿˜è®°å¾—å¼€ç¯‡è¯´çš„ â€œéµå¾ªè§„èŒƒã€åˆ«é€ è½®å­å°±æ˜¯æœ€æ°å½“çš„å®‰å…¨â€ï¼Œè¿™é‡Œåˆå°†è¡¨å•è®¤è¯çš„é«˜è‡ªç”±åº¦è¯´æˆæ˜¯ä¸€å¤§ä¼˜ç‚¹ï¼Œå¥½è¯éƒ½è®©ç¬”è€…ç»™è¯´å…¨äº†ã€‚ç¬”è€…æå€¡ç”¨æ ‡å‡†è§„èŒƒå»è§£å†³å®‰å…¨é¢†åŸŸçš„å…±æ€§é—®é¢˜ï¼Œè¿™æ¡åŸåˆ™å®Œå…¨æ²¡æœ‰å¿…è¦ä¸ç•Œé¢æ˜¯å¦ç¾è§‚åˆç†ã€æ“ä½œæµç¨‹æ˜¯å¦çµæ´»ä¾¿æ·è¿™äº›åº”ç”¨éœ€æ±‚å¯¹ç«‹èµ·æ¥ã€‚è­¬å¦‚ï¼Œæƒ³è¦æ”¯æŒå¯†ç æˆ–æ‰«ç ç­‰å¤šç§ç™»å½•æ–¹å¼ã€æƒ³è¦æ”¯æŒå›¾å½¢éªŒè¯ç æ¥é©±é€çˆ¬è™«ä¸æœºå™¨äººã€æƒ³è¦æ”¯æŒåœ¨ç™»å½•è¡¨å•æäº¤ä¹‹å‰è¿›è¡Œå¿…è¦çš„è¡¨å•æ ¡éªŒï¼Œç­‰ç­‰ï¼Œè¿™äº›éœ€æ±‚ååˆ†å…·ä½“ï¼Œä¸å…·å¤‡å†™å…¥æ ‡å‡†è§„èŒƒçš„é€šç”¨æ€§ï¼Œå´å…·å¤‡è¶³å¤Ÿçš„åˆç†æ€§ï¼Œåº”å½“åœ¨å®ç°å±‚é¢å»æ»¡è¶³ã€‚åŒæ—¶ï¼Œå¦‚ä½•æ§åˆ¶æƒé™ä¿è¯ä¸äº§ç”Ÿè¶Šæƒæ“ä½œã€å¦‚ä½•ä¼ è¾“ä¿¡æ¯ä¿è¯å†…å®¹ä¸è¢«çªƒå¬ç¯¡æ”¹ã€å¦‚ä½•åŠ å¯†æ•æ„Ÿå†…å®¹ä¿è¯å³ä½¿æ³„æ¼ä¹Ÿä¸è¢«é€†æ¨å‡ºæ˜æ–‡ï¼Œç­‰ç­‰ï¼Œè¿™äº›é—®é¢˜å·²æœ‰é€šè¡Œçš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æ˜ç¡®å®šä¹‰åœ¨è§„èŒƒä¹‹ä¸­ï¼Œä¹Ÿåº”å½“åœ¨æ¶æ„å±‚é¢å»éµå¾ªã€‚\nè¡¨å•è®¤è¯ä¸ HTTP è®¤è¯ä¸ä¸€å®šæ˜¯å®Œå…¨å¯¹ç«‹çš„ï¼Œä¸¤è€…æœ‰ä¸åŒçš„å…³æ³¨ç‚¹ï¼Œå¯ä»¥ç»“åˆä½¿ç”¨ã€‚ä»¥ Fenixâ€™s Bookstore çš„ç™»å½•åŠŸèƒ½ä¸ºä¾‹ï¼Œé¡µé¢è¡¨å•æ˜¯ä¸€ä¸ªè‡ªè¡Œè®¾è®¡çš„ Vue.js é¡µé¢ã€‚ä½†è®¤è¯çš„æ•´ä¸ªäº¤äº’è¿‡ç¨‹éµå¾ª OAuth2 è§„èŒƒçš„å¯†ç æ¨¡å¼ã€‚\n2019å¹´3æœˆï¼Œä¸‡ç»´ç½‘è”ç›Ÿï¼ˆWorld Wide Web Consortium.w3Cï¼‰æ‰¹å‡†äº†ç”± FIDOï¼ˆFast IDentity Onlineï¼Œä¸€ä¸ªå®‰å…¨ã€å¼€æ”¾ã€é˜²é’“é±¼ã€æ— å¯†ç è®¤è¯æ ‡å‡†çš„è”ç›Ÿï¼‰é¢†å¯¼èµ·è‰çš„ä¸–ç•Œé¦–ä»½ Web å†…å®¹è®¤è¯çš„æ ‡å‡† â€œWebAuthnâ€ï¼Œè¿™é‡Œä¹Ÿè®¸æœ‰è¯»è€…ä¼šæ„Ÿåˆ°çŸ›ç›¾ä¸å¥‡æ€ªï¼Œä¸æ˜¯åˆšè¯´äº† Web è¡¨å•æ˜¯ä»€ä¹ˆæ ·ã€è¦ä¸è¦éªŒè¯ç ã€ç™»å½•è¡¨å•æ˜¯å¦åœ¨å®¢æˆ·ç«¯æ ¡éªŒç­‰æ˜¯ååˆ†å…·ä½“çš„éœ€æ±‚ï¼Œä¸å¤ªå¯èƒ½å®šä¹‰åœ¨è§„èŒƒä¸Šå—ï¼Ÿç¡®å®å¦‚æ­¤ï¼Œæ‰€ä»¥ WebAuthn å½»åº•æŠ›å¼ƒäº†ä¼ ç»Ÿçš„å¯†ç ç™»å½•æ–¹å¼ï¼Œæ”¹ä¸ºç›´æ¥é‡‡ç”¨ç”Ÿç‰©è¯†åˆ«ï¼ˆæŒ‡çº¹ã€äººè„¸ã€è™¹è†œã€å£°çº¹ï¼‰æˆ–è€…å®ä½“å¯†é’¥ï¼ˆä»¥USBã€è“ç‰™ã€NFCè¿æ¥çš„ç‰©ç†å¯†é’¥å®¹å™¨ï¼‰æ¥ä½œä¸ºèº«ä»½å‡­è¯ï¼Œä»æ ¹æœ¬ä¸Šæ¶ˆç­äº†ç”¨æˆ·è¾“å…¥é”™è¯¯äº§ç”Ÿçš„æ ¡éªŒéœ€æ±‚å’Œé˜²æ­¢æœºå™¨äººæ¨¡æ‹Ÿäº§ç”Ÿçš„éªŒè¯ç éœ€æ±‚ç­‰é—®é¢˜ï¼Œç”šè‡³å¯ä»¥çœæ‰è¡¨å•ç•Œé¢ã€‚\nç”±äº WebAuthn ç›¸å¯¹å¤æ‚ï¼Œåœ¨é˜…è¯»ä¸‹é¢å†…å®¹ä¹‹å‰ï¼Œå¦‚æœä½ çš„è®¾å¤‡å’Œç¯å¢ƒå…è®¸ï¼Œå»ºè®®åŠ¡åœ¨ GitHub ç½‘ç«™çš„ 2FA è®¤è¯åŠŸèƒ½ä¸­å®é™…ä½“éªŒä¸€ä¸‹å¦‚ä½•é€šè¿‡ WebAuthn å®Œæˆä¸¤æ®µå¼ç™»å½•ï¼Œå†ç»§ç»­é˜…è¯»åé¢çš„å†…å®¹ã€‚ç¡¬ä»¶æ–¹é¢ï¼Œè¦æ±‚ç”¨å¸¦æœ‰ TouchID çš„ MacBookï¼Œæˆ–è€…å…¶ä»–æ”¯æŒæŒ‡çº¹ FacelD éªŒè¯çš„æ‰‹æœº(ç›®å‰åœ¨å”®çš„ç§»åŠ¨è®¾å¤‡åŸºæœ¬éƒ½å¸¦æœ‰ç”Ÿç‰©è¯†åˆ«è£…ç½®)ã€‚è½¯ä»¶æ–¹é¢ï¼Œç›´è‡³ ios13.6.iPhone å’Œ iPad ä»æœªæ”¯æŒ WebAuthnï¼Œä½† Android å’Œ Mac OSç³»ç»Ÿä¸­çš„ Chromeï¼Œä»¥åŠ Windows çš„ Edge æµè§ˆå™¨éƒ½å·²ç»æ”¯æŒä½¿ç”¨ WebAuthnäº†ã€‚\nWebAuthn è§„èŒƒæ¶µç›–äº†â€œæ³¨å†Œâ€ä¸â€œè®¤è¯â€ä¸¤å¤§æµç¨‹ã€‚å…ˆæ¥ä»‹ç»æ³¨å†Œæµç¨‹ï¼Œå®ƒå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ã€‚\n\nç”¨æˆ·è¿›å…¥ç³»ç»Ÿçš„æ³¨å†Œé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢çš„æ ¼å¼ã€å†…å®¹å’Œç”¨æˆ·æ³¨å†Œæ—¶éœ€è¦å¡«å†™çš„ä¿¡æ¯å‡ä¸åŒ…å«åœ¨ WebAuthn æ ‡å‡†çš„å®šä¹‰èŒƒå›´å†…ã€‚\nå½“ç”¨æˆ·å¡«å†™å®Œä¿¡æ¯ã€ç‚¹å‡»æäº¤æ³¨å†Œä¿¡æ¯çš„æŒ‰é’®åï¼ŒæœåŠ¡ç«¯å…ˆæš‚å­˜ç”¨æˆ·æäº¤çš„æ•°æ®ï¼Œç”Ÿæˆä¸€ä¸ªéšæœºå­—ç¬¦ä¸²ï¼ˆåœ¨è§„èŒƒä¸­ç§°ä½œ Challengeï¼‰å’Œç”¨æˆ·çš„ UserID ï¼ˆåœ¨è§„èŒƒä¸­ç§°ä½œå‡­è¯IDï¼‰ï¼Œå¹¶è¿”å›å®¢æˆ·ç«¯ã€‚\nå®¢æˆ·ç«¯çš„ WebAuthnAPI æ¥æ”¶åˆ° Challenge å’Œ UserID åï¼ŒæŠŠè¿™äº›ä¿¡æ¯å‘é€ç»™éªŒè¯å™¨ï¼ˆAuthenticatorï¼‰ã€‚éªŒè¯å™¨å¯ç†è§£ä¸ºç”¨æˆ·è®¾å¤‡ä¸Š TouchIDã€FaceIDã€å®ä½“å¯†é’¥ç­‰è®¤è¯è®¾å¤‡çš„ç»Ÿä¸€æ¥å£ã€‚\néªŒè¯å™¨æç¤ºç”¨æˆ·è¿›è¡ŒéªŒè¯ã€‚å¦‚æœæ”¯æŒå¤šç§è®¤è¯è®¾å¤‡ï¼Œè¿˜ä¼šæç¤ºç”¨æˆ·é€‰æ‹©ä¸€ä¸ªæƒ³è¦ä½¿ç”¨çš„è®¾å¤‡ã€‚éªŒè¯çš„ç»“æœæ˜¯ç”Ÿæˆä¸€ä¸ªå¯†é’¥å¯¹ï¼ˆå…¬é’¥å’Œç§é’¥ï¼‰ï¼Œç”±éªŒè¯å™¨å­˜å‚¨ç§é’¥ã€ç”¨æˆ·ä¿¡æ¯ä»¥åŠå½“å‰çš„åŸŸåã€‚ç„¶åä½¿ç”¨ç§é’¥å¯¹ Challenge è¿›è¡Œç­¾åï¼Œå¹¶å°†ç­¾åç»“æœã€UserID å’Œå…¬é’¥ä¸€èµ·è¿”å›å®¢æˆ·ç«¯ã€‚\næµè§ˆå™¨å°†éªŒè¯å™¨è¿”å›çš„ç»“æœè½¬å‘ç»™æœåŠ¡å™¨ã€‚\næœåŠ¡å™¨æ ¸éªŒä¿¡æ¯ï¼Œæ£€æŸ¥ UserID ä¸ä¹‹å‰å‘é€çš„æ˜¯å¦ä¸€è‡´ï¼Œå¹¶ç”¨å…¬é’¥è§£å¯†åå¾—åˆ°çš„ç»“æœä¸ä¹‹å‰å‘é€çš„ Challenge ä½œå¯¹æ¯”ï¼Œä¸€è‡´å³è¡¨æ˜æ³¨å†Œé€šè¿‡ï¼Œç”±æœåŠ¡ç«¯å­˜å‚¨è¯¥UserlD å¯¹åº”çš„å…¬é’¥ã€‚\n\n\nç™»å½•æµç¨‹ä¸æ³¨å†Œæµç¨‹ç±»ä¼¼ï¼Œå¤§è‡´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹æ­¥éª¤ã€‚\n\nç”¨æˆ·è®¿é—®ç™»å½•é¡µé¢ï¼Œå¡«å…¥ç”¨æˆ·ååå³å¯ç‚¹å‡»ç™»å½•æŒ‰é’®ã€‚\næœåŠ¡å™¨è¿”å›éšæœºå­—ç¬¦ä¸² Challengeã€ç”¨æˆ· UserIDã€‚\næµè§ˆå™¨å°† Challenge å’Œ UserID è½¬å‘ç»™éªŒè¯å™¨ã€‚\néªŒè¯å™¨æç¤ºç”¨æˆ·è¿›è¡Œè®¤è¯æ“ä½œã€‚ç”±äºåœ¨æ³¨å†Œé˜¶æ®µéªŒè¯å™¨å·²ç»å­˜å‚¨äº†è¯¥åŸŸåçš„ç§é’¥å’Œæˆ·ä¿¡æ¯ã€‚æ‰€ä»¥å¦‚æœåŸŸåå’Œç”¨æˆ·éƒ½ç›¸åŒçš„è¯ï¼Œå°±ä¸éœ€è¦ç”Ÿæˆå¯†é’¥å¯¹äº†ï¼Œç›´æ¥ä»¥å­˜å‚¨çš„ç§é’¥åŠ å¯† Challengeï¼Œç„¶åè¿”å›æµè§ˆå™¨ã€‚\næœåŠ¡ç«¯æ¥æ”¶åˆ°æµè§ˆå™¨è½¬å‘æ¥çš„è¢«ç§é’¥åŠ å¯†çš„ Challengeï¼Œå¹¶ä»¥æ­¤å‰æ³¨å†Œæ—¶å­˜å‚¨çš„å…¬é’¥è¿›è¡Œè§£å¯†ï¼Œå¦‚æœè§£å¯†æˆåŠŸåˆ™å®£å‘Šç™»å½•æˆåŠŸã€‚\n\nWebAuthn é‡‡ç”¨éå¯¹ç§°åŠ å¯†çš„å…¬é’¥ã€ç§é’¥æ›¿ä»£ä¼ ç»Ÿçš„å¯†ç ï¼Œè¿™æ˜¯éå¸¸ç†æƒ³çš„è®¤è¯æ–¹æ¡ˆã€‚é’¥æ˜¯ä¿å¯†çš„ï¼Œåªæœ‰éªŒè¯å™¨éœ€è¦çŸ¥é“å®ƒï¼Œè¿ç”¨æˆ·æœ¬äººéƒ½ä¸éœ€è¦çŸ¥é“ï¼Œä¹Ÿå°±æ²¡æœ‰äººä¸ºæ³„æ¼çš„å¯èƒ½ã€‚å…¬é’¥æ˜¯å…¬å¼€çš„ï¼Œå¯ä»¥è¢«ä»»ä½•äººçœ‹åˆ°æˆ–å­˜å‚¨ã€‚å…¬é’¥å¯ç”¨äºéªŒè¯ç§é’¥ç”Ÿæˆçš„ç­¾åï¼Œä½†ä¸èƒ½ç”¨æ¥ç­¾åï¼Œé™¤äº†å¾—çŸ¥ç§é’¥å¤–ï¼Œæ²¡æœ‰å…¶ä»–é€”å¾„èƒ½å¤Ÿç”Ÿæˆå¯è¢«å…¬é’¥éªŒè¯ä¸ºæœ‰æ•ˆçš„ç­¾åï¼Œè¿™æ ·æœåŠ¡å™¨å°±å¯ä»¥é€šè¿‡å…¬é’¥æ˜¯å¦èƒ½å¤Ÿè§£å¯†æ¥åˆ¤æ–­æœ€ç»ˆç”¨æˆ·çš„èº«ä»½æ˜¯å¦åˆæ³•ã€‚\nWebAuthn è¿˜è§£å†³äº†ä¼ ç»Ÿå¯†ç åœ¨ç½‘ç»œä¼ è¾“ä¸Šçš„é£é™©é—®é¢˜ï¼Œåç»­5.4èŠ‚æˆ‘ä»¬ä¼šè®²åˆ°æ— è®ºå¯†ç æ˜¯å¦åœ¨å®¢æˆ·ç«¯è¿›è¡ŒåŠ å¯†ä»¥åŠå¦‚ä½•åŠ å¯†ï¼Œå¯¹é˜²å¾¡ä¸­é—´äººæ”»å‡»æ¥è¯´éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚æ›´å€¼å¾—å¤¸èµçš„æ˜¯ï¼ŒWebAuthnä¸ºç™»å½•è¿‡ç¨‹å¸¦æ¥æå¤§çš„ä¾¿æ·æ€§ï¼Œä¸ä»…æ³¨å†Œå’ŒéªŒè¯çš„ç”¨æˆ·ä½“éªŒååˆ†ä¼˜ç§€è€Œä¸”å½»åº•é¿å…äº†ç”¨æˆ·åœ¨ä¸€ä¸ªç½‘ç«™ä¸Šæ³„æ¼å¯†ç ï¼Œæ‰€æœ‰ä½¿ç”¨ç›¸åŒå¯†ç çš„ç½‘ç«™éƒ½å—åˆ°æ”»å‡»çš„é—®é¢˜è¿™ä¸ªä¼˜ç‚¹ä½¿å¾—ç”¨æˆ·æ— é¡»å†ä¸ºæ¯ä¸ªç½‘ç«™æƒ³ä¸åŒçš„å¯†ç ã€‚å½“å‰çš„ WebAuthn è¿˜å¾ˆå¹´è½»ï¼Œæ™®åŠç‡æš‚æ—¶è¿˜å¾ˆæœ‰é™ï¼Œä½†ç¬”è€…ç›¸ä¿¡å‡ å¹´ä¹‹å†…å®ƒå¿…å®šä¼šå‘å±•æˆWebè®¤è¯çš„ä¸»æµæ–¹å¼ï¼Œè¢«å¤§å¤šæ•°ç½‘ç«™å’Œç³»ç»Ÿæ‰€æ”¯æŒã€‚\n2. è®¤è¯çš„å®ç°äº†è§£äº†ä¸šç•Œæ ‡å‡†çš„è®¤è¯è§„èŒƒä»¥åï¼Œæœ¬èŠ‚å°†ç®€è¦ä»‹ç»ä¸€ä¸‹åœ¨ Java æŠ€æœ¯ä½“ç³»å†…é€šå¸¸æ˜¯å¦‚ä½•å®ç°å®‰å…¨è®¤è¯çš„ã€‚Java å…¶å®ä¹Ÿæœ‰è‡ªå·±çš„è®¤è¯è§„èŒƒï¼Œç¬¬ä¸€ä¸ªç³»ç»Ÿæ€§çš„ Java è®¤è¯è§„èŒƒå‘å¸ƒäº Java 1.3æ—¶ä»£ï¼Œæ˜¯ç”± Sun å…¬å¸æå‡ºçš„åŒæ—¶é¢å‘ä»£ç çº§å®‰å…¨å’Œç”¨æˆ·çº§å®‰å…¨çš„è®¤è¯æˆæƒæœåŠ¡â€”â€” JAASï¼ˆJava Authentication and Authorization Serviceï¼ŒJava è®¤è¯å’ŒæˆæƒæœåŠ¡ï¼ŒJava 1.3 æ—¶å¤„äºæ‰©å±•åŒ…ä¸­ï¼ŒJava 1.4 æ—¶è¢«çº³äººæ ‡å‡†åŒ…ï¼‰ã€‚å°½ç®¡JAAS å·²ç»è€ƒè™‘åˆ°æœ€ç»ˆç”¨æˆ·çš„è®¤è¯ï¼Œä½†ä»£ç çº§å®‰å…¨åœ¨è§„èŒƒä¸­ä»ç„¶å æ›´ä¸»è¦çš„åœ°ä½ã€‚å¯èƒ½ä»Šå¤©ç”¨è¿‡ç”šè‡³å¬è¿‡ JAAS çš„ Java ç¨‹åºå‘˜å·²ç»ä¸å¤šäº†ï¼Œä½†æ˜¯è¿™ä¸ªè§„èŒƒæå‡ºäº†å¾ˆå¤šåœ¨ä»Šå¤©ä»ç„¶æ´»è·ƒäºä¸»æµ Java å®‰å…¨æ¡†æ¶ä¸­çš„æ¦‚å¿µï¼Œè­¬å¦‚ä¸€èˆ¬æŠŠç”¨æˆ·å­˜æ”¾åœ¨ â€œPrincipalâ€ ä¹‹ä¸­ã€å¯†ç å­˜æ”¾åœ¨ â€œCredentialsâ€ ä¹‹ä¸­ã€ç™»å½•åä»å®‰å…¨ä¸Šä¸‹æ–‡ â€œContextâ€ ä¸­è·å–çŠ¶æ€ç­‰å¸¸è§çš„å®‰å…¨æ¦‚å¿µï¼Œéƒ½å¯ä»¥è¿½æº¯åˆ°è¿™ä¸€æ—¶æœŸæ‰€å®šä¸‹çš„ APIï¼š\n\nLoginModuleï¼ˆjavax.security.auth.spi.LoginModuleï¼‰ï¼›\nLoginContextï¼ˆjavax.security.auth.login.LoginContextï¼‰ï¼›\nSubjectï¼ˆjavax.security.auth.Subjectï¼‰ï¼›\nPrincipalï¼ˆjava.securityPrincipalï¼‰ï¼›\nCredentialsï¼ˆjavax.security.auth.Destroyableã€javax.security.auth.Refreshableï¼‰ã€‚\n\nè™½ç„¶ JAAS å¼€åˆ›äº†è¿™äº›æ²¿ç”¨è‡³ä»Šçš„å®‰å…¨æ¦‚å¿µï¼Œä½†è§„èŒƒæœ¬èº«å®è´¨ä¸Šå¹¶æ²¡æœ‰å¾—åˆ°å¹¿æ³›åº”ç”¨ç¬”è€…è®¤ä¸ºæœ‰ä¸¤å¤§åŸå› ã€‚ä¸€æ–¹é¢æ˜¯ç”±äº JAAS åŒæ—¶é¢å‘ä»£ç çº§å’Œç”¨æˆ·çº§çš„å®‰å…¨æœºåˆ¶ï¼Œä½¿å¾—å®ƒè¿‡åº¦å¤æ‚åŒ–ï¼Œéš¾ä»¥æ¨å¹¿ã€‚åœ¨è¿™ä¸ªé—®é¢˜ä¸Š Java ç¤¾åŒºä¸€ç›´æœ‰åšæŒç»­çš„å¢å¼ºå’Œè¡¥æ•‘ï¼Œè­¬å¦‚ Java EE6 ä¸­çš„JASPICã€Java EE8 ä¸­çš„ EE Securityã€‚\n\nJSR 115: Java Authorization Contract for Containers (JACC)ã€‚\nJSR 196: Java Authentication Service Provider Interface for Containers (JASPIC)ã€‚\nJSR 375: Java EE Security API (EE Security)ã€‚\n\nè€Œå¦ä¸€æ–¹é¢ã€‚å¯èƒ½æ˜¯æ›´é‡è¦çš„ä¸€ä¸ªåŸå› ï¼Œåœ¨21ä¸–çºªçš„ç¬¬ä¸€ä¸ªåå¹´é‡Œï¼Œä»¥ â€œWith EJBâ€œ ä¸ºå£å·ï¼Œä»¥ WebSphereã€JBoss ç­‰ä¸ºä»£è¡¨çš„ J2EE å®¹å™¨ç¯å¢ƒï¼Œä¸ä»¥ â€œWithout EJBâ€ ä¸ºå£å·ä»¥ Springã€Hibernate ç­‰ä¸ºä»£è¡¨çš„è½»é‡åŒ–å¼€å‘æ¡†æ¶äº§ç”Ÿäº†æ¿€çƒˆçš„ç«äº‰ï¼Œç»“æœæ˜¯åè€…è·å¾—äº†å…¨é¢èƒœåˆ©ã€‚è¿™ä¸ªç»“æœä½¿å¾—ä¾èµ–å®¹å™¨å®‰å…¨çš„ JAAS æ— æ³•å¾—åˆ°å¤§å¤šæ•°äººçš„è®¤å¯ã€‚\nåœ¨ä»Šæ—¶ä»Šæ—¥ï¼Œå®é™…æ´»è·ƒäº Java å®‰å…¨é¢†åŸŸçš„æ˜¯ä¸¤ä¸ªç§æœ‰çš„ï¼ˆç§æœ‰çš„æ„æ€æ˜¯ä¸ç”± JSR æ‰€è§„èŒƒçš„ï¼Œå³æ²¡æœ‰ java/javax.* ä½œä¸ºåŒ…åï¼‰çš„å®‰å…¨æ¡†æ¶ï¼šApache Shiro å’Œ Spring Securityã€‚\nç›¸è¾ƒè€Œè¨€ï¼ŒApache Shiro æ›´ä¾¿æ·æ˜“ç”¨ï¼Œè€Œ Spring Security çš„åŠŸèƒ½åˆ™æ›´å¤æ‚å¼ºå¤§ä¸€äº›ã€‚æ— è®ºæ˜¯å•ä½“æ¶æ„è¿˜æ˜¯å¾®æœåŠ¡æ¶æ„çš„ Fenixâ€™s Bookstoreï¼Œç¬”è€…éƒ½é€‰æ‹©äº† Spring Security ä½œä¸ºå®‰å…¨æ¡†æ¶ï¼Œè¿™ä¸ªé€‰æ‹©ä¸åŠŸèƒ½ã€æ€§èƒ½ä¹‹ç±»çš„è€ƒé‡æ²¡ä»€ä¹ˆå…³ç³»ï¼Œå°±åªæ˜¯å› ä¸º SpringBootã€Spring Cloud å…¨å®¶æ¡¶çš„ç¼˜æ•…ã€‚è¿™é‡Œä¸æ‰“ç®—ç½—åˆ—ä»£ç æ¥ä»‹ç» Apache Shiro ä¸ Spring Security çš„å…·ä½“ä½¿ç”¨æ–¹æ³•ã€‚åªä»ç›®æ ‡ä¸Šçœ‹ï¼Œä¸¤ä¸ªå®‰å…¨æ¡†æ¶æä¾›çš„åŠŸèƒ½éƒ½å¾ˆç±»ä¼¼ï¼Œå¤§è‡´åŒ…æ‹¬ä»¥ä¸‹å››ç±»ã€‚\n\nè®¤è¯åŠŸèƒ½ï¼šä»¥HTTPåè®®ä¸­å®šä¹‰çš„å„ç§è®¤è¯ã€è¡¨å•ç­‰è®¤è¯æ–¹å¼ç¡®è®¤ç”¨æˆ·èº«ä»½ï¼Œè¿™æ˜¯æœ¬èŠ‚çš„ä¸»è¦è¯é¢˜ã€‚\nå®‰å…¨ä¸Šä¸‹æ–‡ï¼šç”¨æˆ·è·å¾—è®¤è¯ä¹‹åï¼Œè¦å¼€æ”¾ä¸€äº›æ¥å£ï¼Œè®©åº”ç”¨å¯ä»¥å¾—çŸ¥è¯¥ç”¨æˆ·çš„åŸºæœ¬èµ„æ–™ï¼Œæ‹¥æœ‰çš„æƒé™ã€è§’è‰²ï¼Œç­‰ç­‰ã€‚\næˆæƒåŠŸèƒ½ï¼šåˆ¤æ–­å¹¶æ§åˆ¶è®¤è¯åçš„ç”¨æˆ·å¯¹ä»€ä¹ˆèµ„æºæ‹¥æœ‰å“ªäº›æ“ä½œè®¸å¯ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šæ”¾åˆ°ä¸‹ä¸€èŠ‚ä»‹ç»ã€‚\nå¯†ç çš„å­˜å‚¨ä¸éªŒè¯ï¼šå¯†ç æ˜¯ â€œçƒ«æ‰‹çš„å±±èŠ‹â€ï¼Œæ— è®ºæ˜¯å­˜å‚¨ã€ä¼ è¾“è¿˜æ˜¯éªŒè¯éƒ½åº”è°¨æ…å¤„ç†ï¼Œè¿™éƒ¨åˆ†å†…å®¹ä¼šæ”¾åˆ°ç¬¬å››èŠ‚å…·ä½“è®¨è®ºã€‚\n\näºŒã€æˆæƒæˆæƒè¿™ä¸ªæ¦‚å¿µé€šå¸¸ä¼´éšç€è®¤è¯ã€å®¡è®¡ã€è´¦å·ä¸€åŒå‡ºç°ï¼Œå¹¶ç§°ä¸º AAAAï¼ˆAuthentication Authorizationã€Auditã€Accountï¼Œä¹Ÿæœ‰ä¸€äº›é¢†åŸŸæŠŠ Account è§£é‡Šä¸ºè®¡è´¹çš„æ„æ€ï¼‰ã€‚æˆæƒè¡Œä¸ºåœ¨ç¨‹åºä¸­çš„åº”ç”¨éå¸¸å¹¿æ³›ï¼Œç»™æŸä¸ªç±»æˆ–æŸä¸ªæ–¹æ³•è®¾ç½®èŒƒå›´æ§åˆ¶ç¬¦ï¼ˆpublicã€protectedã€privateã€&lt;Package&gt;ï¼‰åœ¨æœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ç§æˆæƒï¼ˆè®¿é—®æ§åˆ¶ï¼‰è¡Œä¸ºã€‚è€Œåœ¨å®‰å…¨é¢†åŸŸä¸­æ‰€è¯´çš„æƒå°±æ›´å…·ä½“ä¸€äº›ã€‚é€šå¸¸æ¶‰åŠä»¥ä¸‹ä¸¤ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é—®é¢˜ã€‚\n\nç¡®ä¿æˆæƒçš„è¿‡ç¨‹å¯é ï¼šå¯¹äºå•ä¸€ç³»ç»Ÿæ¥è¯´ï¼Œæˆæƒçš„è¿‡ç¨‹æ˜¯æ¯”è¾ƒå®¹æ˜“æ§åˆ¶çš„ï¼Œä»¥å‰å¤šè¯­å¢ƒä¸Šæåˆ°æˆæƒã€‚å®è´¨ä¸Šè®²çš„éƒ½æ˜¯è®¿é—®æ§åˆ¶ï¼Œä½†ç†è®ºä¸Šä¸¤è€…æ˜¯åº”è¯¥åˆ†å¼€çš„ã€‚åœ¨æ¶‰åŠå¤šæ–¹çš„ç³»ç»Ÿä¸­ï¼Œæˆæƒè¿‡ç¨‹åˆ™æ˜¯ä¸€ä¸ªæ¯”è¾ƒå›°éš¾å´å¿…é¡»ä¸¥è‚ƒå¯¹å¾…çš„é—®é¢˜ï¼šå¦‚ä½•æ—¢èƒ½è®©ç¬¬ä¸‰æ–¹ç³»ç»Ÿè®¿é—®åˆ°æ‰€éœ€çš„èµ„æºï¼Œåˆèƒ½ä¿è¯å…¶ä¸æ³„éœ²ç”¨æˆ·çš„æ•æ„Ÿæ•°æ®å‘¢ï¼Ÿå¸¸ç”¨çš„å¤šæˆæƒåè®®ä¸»è¦æœ‰ OAuth2 å’Œ SAML2.0ã€‚\nç¡®ä¿æˆæƒçš„ç»“æœå¯æ§ï¼šæˆæƒçš„ç»“æœç”¨äºå¯¹ç¨‹åºåŠŸèƒ½æˆ–è€…èµ„æºçš„è®¿é—®æ§åˆ¶ï¼ˆAccess Controlï¼‰ï¼Œæˆç†è®ºä½“ç³»çš„æƒé™æ§åˆ¶æ¨¡å‹æœ‰å¾ˆå¤šï¼Œè­¬å¦‚è‡ªä¸»è®¿é—®æ§åˆ¶ï¼ˆDiscretionary Access Controlï¼ŒDACï¼‰ã€å¼ºåˆ¶è®¿é—®æ§åˆ¶ï¼ˆMandatory Access Controlï¼ŒMACï¼‰ã€åŸºäºå±æ€§çš„è®¿é—®æ§åˆ¶ï¼ˆAttribute-Based Access Controlï¼ŒABACï¼‰ï¼Œè¿˜æœ‰æœ€ä¸ºå¸¸ç”¨çš„åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ï¼ˆRole-Based Access Controlï¼ŒRBACï¼‰ã€‚\n\nç”±äºç¯‡å¹…åŸå› ï¼Œåœ¨è¿™ä¸€èŠ‚æˆ‘ä»¬åªä»‹ç» Fenixâ€™s Bookstore çš„ä»£ç ä¸­ç›´æ¥ä½¿ç”¨åˆ°çš„ï¼Œä¹Ÿæ˜¯æ—¥å¸¸å¼€å‘ä¸­æœ€å¸¸ç”¨åˆ°çš„ RBAC å’Œ OAuth2 è¿™ä¸¤ç§è®¿é—®æ§åˆ¶å’Œæˆæƒæ–¹æ¡ˆã€‚\n1. RBACæ‰€æœ‰çš„è®¿é—®æ§åˆ¶æ¨¡å‹ï¼Œå®è´¨ä¸Šéƒ½æ˜¯åœ¨è§£å†³åŒä¸€ä¸ªé—®é¢˜ï¼šâ€œè°ï¼ˆUserï¼‰æ‹¥æœ‰ä»€ä¹ˆæƒé™ï¼ˆAuthorityï¼‰å»æ“ä½œï¼ˆOperationï¼‰å“ªäº›èµ„æºï¼ˆResourceï¼‰ã€‚â€\nè¿™ä¸ªé—®é¢˜åˆçœ‹èµ·æ¥å¹¶ä¸éš¾ï¼Œä¸€ç§ç›´è§‚çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯åœ¨ç”¨æˆ·å¯¹è±¡ä¸Šè®¾å®šä¸€äº›æƒé™ï¼Œå½“ç”¨æˆ·ä½¿ç”¨èµ„æºæ—¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å¯¹åº”çš„æ“ä½œæƒé™å³å¯ã€‚å¾ˆå¤šè‘—åçš„å®‰å…¨æ¡†æ¶ï¼Œè­¬å¦‚ Spring Security çš„è®¿é—®æ§åˆ¶æœ¬è´¨ä¸Šå°±æ˜¯è¿™ä¹ˆåšçš„ã€‚ä¸è¿‡ï¼Œè¿™ç§æŠŠæƒé™ç›´æ¥å…³è”åœ¨ç”¨æˆ·èº«ä¸Šçš„ç®€å•è®¾è®¡ï¼Œåœ¨å¤æ‚ç³»ç»Ÿä¸Šç¡®å®ä¼šå¯¼è‡´ä¸€äº›æ¯”è¾ƒçƒ¦ççš„é—®é¢˜ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæŸä¸ªç³»ç»Ÿæ¶‰åŠæˆç™¾ä¸Šåƒçš„èµ„æºï¼Œåˆæœ‰æˆåƒä¸Šä¸‡çš„ç”¨æˆ·ï¼Œè‹¥è¦ä¸ºæ¯ä¸ªç”¨æˆ·è®¿é—®æ¯ä¸ªèµ„æºéƒ½åˆ†é…åˆé€‚çš„æƒé™ï¼Œå¿…å®šå¯¼è‡´å·¨å¤§çš„æ“ä½œé‡å’Œæé«˜çš„å‡ºé”™æ¦‚ç‡ï¼Œè¿™ä¹Ÿæ­£æ˜¯ RBAC æ‰€å…³æ³¨çš„é—®é¢˜ä¹‹ä¸€ã€‚\nRBAC æ¨¡å‹åœ¨ä¸šç•Œä¸­æœ‰å¤šç§è¯´æ³•ï¼Œå…¶ä¸­ä»¥ç¾å›½ George Mason å¤§å­¦ä¿¡æ¯å®‰å…¨æŠ€æœ¯å®éªŒå®¤æå‡ºçš„ RBAC96 æ¨¡å‹æœ€å…·ç³»ç»Ÿæ€§ã€å¾—åˆ°äº†æ™®éçš„è®¤å¯ã€‚ä¸ºäº†é¿å…å¯¹æ¯ä¸€ä¸ªç”¨æˆ·è®¾å®šæƒé™ï¼ŒRBAC å°†æƒé™ä»ç”¨æˆ·èº«ä¸Šå‰¥ç¦»ã€‚æ”¹ä¸ºç»‘å®šåˆ° â€œè§’è‰²â€ï¼ˆRoleï¼‰ä¸Šï¼Œå°†æƒé™æ§åˆ¶å˜ä¸ºå¯¹ â€œè§’æ‹¥æœ‰æ“ä½œå“ªäº›èµ„æºçš„è®¸å¯â€ è¿™ä¸ªé€»è¾‘è¡¨è¾¾å¼çš„å€¼æ˜¯å¦ä¸ºçœŸçš„æ±‚è§£è¿‡ç¨‹ã€‚RBAC çš„ä¸»è¦å…ƒç´ çš„å…³ç³»å›¾å¦‚ä¸‹ã€‚\n\nä¸Šå›¾ä¸­å‡ºç°äº†ä¸€ä¸ªæ–°çš„åè¯ â€œè®¸å¯â€ã€‚è®¸å¯æ˜¯æŠ½è±¡æƒé™çš„å…·è±¡åŒ–ä½“ç°ï¼Œæƒé™åœ¨ RBAC ç³»ç»Ÿä¸­çš„å«ä¹‰æ˜¯ â€œå…è®¸ä½•ç§æ“ä½œä½œç”¨äºå“ªäº›èµ„æºä¹‹ä¸Šâ€ ï¼Œè¿™å¥è¯çš„å…·ä½“å®ä¾‹å³ä¸º â€œè®¸å¯â€ã€‚æå‡ºè®¸å¯è¿™ä¸ªæ¦‚å¿µçš„ç›®çš„å…¶å®ä¸æå‡ºè§’è‰²çš„ç›®çš„æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œåªæ˜¯æ›´ä¸ºæŠ½è±¡ã€‚è§’è‰²ä¸ºçš„æ˜¯è§£è€¦ç”¨æˆ·ä¸æƒé™ä¹‹é—´çš„å¤šå¯¹å¤šå…³ç³»ï¼Œè€Œè®¸å¯ä¸ºçš„æ˜¯è§£è€¦æ“ä½œä¸èµ„æºä¹‹é—´çš„å¤šå¯¹å¤šå…³ç³»è­¬å¦‚ä¸åŒçš„æ•°æ®éƒ½èƒ½å¤Ÿæœ‰å¢ã€åˆ ã€æ”¹ç­‰æ“ä½œï¼Œå¦‚æœå°†æ•°æ®ä¸æ“ä½œæ…å’Œåœ¨ä¸€èµ·ä¹Ÿä¼šé¢ä¸´é…ç½®è†¨èƒ€é—®é¢˜ã€‚è¿™é‡Œä¸¾ä¸ªæ›´å…·ä½“çš„ä¾‹å­å¸®åŠ©ä½ ç†æ¸…ä¼—å¤šåè¯ä¹‹é—´çš„å…³ç³»ã€‚è­¬å¦‚æŸä¸ªè®ºæ–‡ç®¡ç†ç³»ç»Ÿçš„ UserStory ä¸­ï¼Œä¸è®¿é—®æ§åˆ¶ç›¸å…³çš„ Backlog å¯èƒ½ä¼šæ˜¯è¿™æ ·æè¿°çš„ï¼š\n\nBacklogå‘¨åŒå­¦ï¼ˆUserï¼‰æ˜¯æŸSCIæ‚å¿—çš„å®¡ç¨¿äººï¼ˆRoleï¼‰ï¼ŒèŒè´£ä¹‹ä¸€æ˜¯åœ¨ç³»ç»Ÿä¸­å®¡æ ¸è®ºæ–‡ï¼ˆAuthorityï¼‰ã€‚åœ¨å®¡ç¨¿è¿‡ç¨‹ï¼ˆSessionï¼‰ä¸­ï¼Œå½“ä»–è®¤ä¸ºæŸç¯‡è®ºæ–‡ï¼ˆResourceï¼‰è¾¾åˆ°äº†å¯ä»¥å…¬å¼€å‘è¡¨çš„æ ‡å‡†æ—¶ï¼Œå°±ä¼šåœ¨åå°ç‚¹å‡»é€šè¿‡æŒ‰é’®ï¼ˆOperationï¼‰æ¥å®Œæˆå®¡æ ¸\n\nä»¥ä¸Š Backlog ä¸­ â€œç»™è®ºæ–‡ç‚¹å‡»é€šè¿‡æŒ‰é’®â€ å°±æ˜¯ä¸€ç§è®¸å¯ï¼Œå®ƒæ˜¯ â€œå®¡æ ¸è®ºæ–‡â€ è¿™é¡¹æƒé™çš„å…·è±¡åŒ–ä½“ç°ã€‚\né‡‡ç”¨ RBAC ä¸ä»…æ˜¯ä¸ºäº†ç®€åŒ–é…ç½®æ“ä½œï¼Œè¿˜å¤©ç„¶åœ°æ»¡è¶³äº†è®¡ç®—æœºå®‰å…¨ä¸­çš„ â€œæœ€å°ç‰¹æƒåŸåˆ™â€ ï¼ˆLeast Privilegeï¼‰ã€‚åœ¨ RBAC æ¨¡å‹ä¸­ï¼Œè§’è‰²æ‹¥æœ‰è®¸å¯çš„æ•°é‡æ˜¯æ ¹æ®å®Œæˆè¯¥è§’è‰²å·¥ä½œèŒè´£æ‰€éœ€çš„æœ€å°æƒé™æ¥èµ‹äºˆçš„ï¼Œæœ€å…¸å‹çš„ä¾‹å­æ˜¯æ“ä½œç³»ç»Ÿæƒé™ç®¡ç†ä¸­çš„ç”¨æˆ·ç»„ï¼Œæ ¹æ®å¯¹ä¸åŒè§’è‰²çš„èŒè´£åˆ†å·¥ï¼Œå¦‚ç®¡ç†å‘˜ï¼ˆAdministratorï¼‰ã€ç³»ç»Ÿç”¨æˆ·ï¼ˆSystemï¼‰ã€éªŒè¯ç”¨æˆ·ï¼ˆAuthenticated Userï¼‰ã€æ™®é€šç”¨æˆ·ï¼ˆUserï¼‰ã€æ¥å®¾ç”¨æˆ·ï¼ˆGuestï¼‰ç­‰åˆ†é…å„è‡ªçš„æƒé™ï¼Œæ—¢ä¿è¯ç”¨æˆ·èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚ä¹Ÿé¿å…ç”¨æˆ·å‡ºç°è¶Šæƒæ“ä½œçš„é£é™©ã€‚å½“ç”¨æˆ·çš„èŒè´£å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåœ¨ç³»ç»Ÿä¸­å°±ä½“ç°ä¸ºå®ƒæ‰€éš¶å±çš„è§’è‰²è¢«æ”¹å˜ï¼Œè­¬å¦‚å°† â€œæ™®é€šç”¨æˆ·è§’è‰²â€ æ”¹å˜ â€œç®¡ç†å‘˜è§’è‰²â€ï¼Œä»è€Œè¿…é€Ÿè®©è¯¥ç”¨æˆ·å…·å¤‡ç®¡ç†å‘˜çš„å¤šä¸ªç»†åˆ†æƒé™ï¼Œé™ä½æƒé™åˆ†é…é”™è¯¯çš„é£é™©ã€‚\nRBAC è¿˜å…è®¸å¯¹ä¸åŒè§’è‰²ä¹‹é—´å®šä¹‰å…³è”ä¸çº¦æŸå…³ç³»ï¼Œè¿›ä¸€æ­¥å¼ºåŒ–å®ƒçš„æŠ½è±¡æè¿°èƒ½åŠ›ã€‚å¦‚ä¸åŒçš„è§’è‰²ä¹‹é—´å¯ä»¥æœ‰ç»§æ‰¿æ€§ï¼Œå…¸å‹çš„æ˜¯ RBAC-1 æ¨¡å‹çš„è§’è‰²æƒé™ç»§æ‰¿å…³ç³»ã€‚è­¬å¦‚æè¿°å¼€å‘ç»ç†åº”è¯¥å’Œå¼€å‘äººå‘˜ä¸€æ ·å…·æœ‰ä»£ç æäº¤çš„æƒé™ï¼Œæè¿°å¼€å‘äººå‘˜éƒ½åº”è¯¥å’Œä»»ä½•å…¬å¸å‘˜å·¥ä¸€æ ·å…·æœ‰é£Ÿå ‚å°±é¤çš„æƒé™ï¼Œå°±å¯ä»¥ç›´æ¥å°†é£Ÿå ‚å°±é¤èµ‹äºˆåˆ°å…¬å¸å‘˜å·¥çš„è§’è‰²ä¸Šï¼ŒæŠŠä»£ç æäº¤èµ‹äºˆåˆ°å¼€å‘äººå‘˜çš„è§’è‰²ä¸Šï¼Œå†è®©å¼€å‘äººå‘˜çš„è§’è‰²ä»å…¬å¸å‘˜å·¥æ´¾ç”Ÿï¼Œå¼€å‘ç»ç†çš„è§’è‰²ä»å¼€å‘äººå‘˜ä¸­æ´¾ç”Ÿã€‚\nä¸åŒè§’è‰²ä¹‹é—´ä¹Ÿå¯ä»¥å…·æœ‰äº’æ–¥æ€§ï¼Œå…¸å‹çš„æ˜¯ RBAC-2 æ¨¡å‹çš„è§’è‰²èŒè´£åˆ†ç¦»å…³ç³»ã€‚äº’æ–¥æ€§è¦æ±‚æƒé™è¢«èµ‹äºˆè§’è‰²æ—¶ï¼Œæˆ–è§’è‰²è¢«èµ‹äºˆç”¨æˆ·æ—¶åº”éµå¾ªçš„å¼ºåˆ¶æ€§èŒè´£åˆ†ç¦»è§„å®šã€‚ä¸¾ä¸ªä¾‹å­ã€‚è§’è‰²çš„äº’æ–¥çº¦æŸå¯é™åˆ¶åŒä¸€ç”¨æˆ·åªèƒ½åˆ†é…åˆ°ä¸€ç»„äº’æ–¥è§’è‰²é›†åˆä¸­è‡³å¤šä¸€ä¸ªè§’è‰²ï¼Œè­¬å¦‚ä¸èƒ½è®©åŒä¸€åå‘˜å·¥æ—¢å½“ä¼šè®¡ï¼Œä¹Ÿå½“å‡ºçº³ï¼Œå¦åˆ™èµ„é‡‘å®‰å…¨æ— æ³•ä¿è¯ã€‚è§’è‰²çš„åŸºæ•°çº¦æŸå¯é™åˆ¶æŸä¸ªç”¨æˆ·æ‹¥æœ‰çš„æœ€å¤§è§’è‰²æ•°ç›®ï¼Œè­¬å¦‚ä¸èƒ½è®©åŒä¸€åå‘˜å·¥åŒ…æ½äº§å“ã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•è§’è‰²ï¼Œå¦åˆ™äº§å“è´¨é‡æ— æ³•ä¿è¯ã€‚\nå»ºç«‹è®¿é—®æ§åˆ¶æ¨¡å‹çš„åŸºæœ¬ç›®çš„æ˜¯ç®¡ç†å‚ç›´æƒé™å’Œæ°´å¹³æƒé™ã€‚å‚ç›´æƒé™å³åŠŸèƒ½æƒé™ï¼Œè­¬å¦‚å‰é¢æåˆ°çš„å®¡ç¨¿ç¼–è¾‘æœ‰é€šè¿‡å®¡æ ¸çš„æƒé™ã€å¼€å‘ç»ç†æœ‰ä»£ç æäº¤çš„æƒé™ã€å‡ºçº³æœ‰ä»è´¦æˆ·æŠ¥å–èµ„é‡‘çš„æƒé™ï¼Œè¿™ä¸€ç±»æŸä¸ªè§’è‰²å®ŒæˆæŸé¡¹æ“ä½œçš„è®¸å¯ï¼Œéƒ½å¯ä»¥ç›´æ¥ç¿»è¯‘ä¸ºåŠŸèƒ½æƒé™ã€‚ç”±äºå®é™…åº”ç”¨ä¸æƒé™æ¨¡å‹å…·æœ‰é«˜åº¦å¯¹åº”å…³ç³»ï¼Œå°†æƒé™ä»å…·ä½“çš„åº”ç”¨ä¸­æŠ½ç¦»å‡ºæ¥ï¼Œæ”¾åˆ°é€šç”¨çš„æ¨¡å‹ä¸­æ˜¯ç›¸å¯¹å®¹æ˜“çš„ Spring Securityã€Apache Shiro ç­‰æƒé™æ¡†æ¶å°±æ˜¯è¿™æ ·çš„æŠ½è±¡äº§ç‰©ï¼Œå¤§å¤šæ•°ç³»ç»Ÿéƒ½èƒ½é‡‡ç”¨è¿™äº›æƒé™æ¡†æ¶æ¥ç®¡ç†åŠŸèƒ½æƒé™ã€‚\nä¸æ­¤ç›¸å¯¹ï¼Œæ°´å¹³æƒé™å³æ•°æ®æƒé™ï¼Œä½†ç®¡ç†èµ·æ¥è¦å›°éš¾è®¸å¤šã€‚è­¬å¦‚ç”¨æˆ· Aã€B éƒ½å±äºåŒä¸€ä¸ªè§’è‰²ã€‚ä½†å®ƒä»¬å„è‡ªåœ¨ç³»ç»Ÿä¸­äº§ç”Ÿçš„æ•°æ®å®Œå…¨æœ‰å¯èƒ½æ˜¯ç§æœ‰çš„ï¼ŒA è®¿é—®æˆ–åˆ é™¤äº† B çš„æ•°æ®ä¹Ÿç…§æ ·å±äºè¶Šæƒã€‚ä¸€èˆ¬æ¥è¯´ã€æ•°æ®æƒé™æ˜¯å¾ˆéš¾æŠ½è±¡ä¸é€šç”¨çš„ï¼Œä»…åœ¨è§’è‰²å±‚é¢æ§åˆ¶å¹¶ä¸èƒ½æ»¡è¶³å…¨éƒ¨ä¸šåŠ¡çš„éœ€è¦ï¼Œå¾ˆå¤šæ—¶å€™åªèƒ½å…·ä½“åˆ°ç”¨æˆ·ï¼Œç”šè‡³è¦å…·ä½“ç®¡ç†åˆ°å‘ç”Ÿæ•°æ®çš„æŸä¸€è¡Œã€ä¸€åˆ—ä¹‹ä¸Šï¼Œå› æ­¤æ•°æ®æƒé™åŸºæœ¬åªèƒ½ç”±ä¿¡æ¯ç³»ç»Ÿè‡ªä¸»å®Œæˆï¼Œå¹¶ä¸å­˜åœ¨èƒ½æ”¾ä¹‹å››æµ·çš†å‡†çš„é€šç”¨æ•°æ®æƒé™æ¡†æ¶ã€‚\næœ¬ä¹¦åé¢ç« èŠ‚ä¸­çš„ â€œé‡è¦è§’è‰²â€ â€”â€” Kubernetes å®Œå…¨éµå¾ªäº† RBAC æ¥è¿›è¡ŒæœåŠ¡è®¿é—®æ§åˆ¶ï¼ŒFenixâ€™s Bookstore æ‰€ä½¿ç”¨çš„ Spring Security ä¹Ÿå‚è€ƒäº†ï¼ˆä½†å¹¶æ²¡æœ‰å®Œå…¨éµå¾ªï¼‰RBAC æ¥è®¾è®¡å®ƒçš„è®¿é—®æ§åˆ¶åŠŸèƒ½ã€‚åœ¨ Spring Security çš„è®¾è®¡é‡Œï¼Œç”¨æˆ·å’Œè§’è‰²éƒ½å¯ä»¥æ‹¥æœ‰æƒé™ï¼Œè­¬å¦‚åœ¨å®ƒçš„ HttpSecurity æ¥å£å°±åŒæ—¶æœ‰ hasRole() å’Œ hasAuthority() æ–¹æ³•ã€‚Spring Security çš„è®¿é—®æ§åˆ¶æ¨¡å‹å¦‚å›¾5-6æ‰€ç¤ºï¼Œå¯ä¸å‰é¢ RBAC çš„å…³ç³»å›¾å¯¹æ¯”ä¸€ä¸‹ã€‚\n\nä»å®ç°è§’åº¦æ¥çœ‹ï¼ŒSpring Security ä¸­çš„è§’è‰²å’Œæƒé™çš„å·®å¼‚å¾ˆå°ï¼Œå®ƒä»¬å®Œå…¨å…±äº«åŒä¸€å¥—å­˜å‚¨ç»“æ„ã€‚å”¯ä¸€çš„å·®åˆ«ä»…æ˜¯è§’è‰²ä¼šåœ¨å­˜å‚¨æ—¶è‡ªåŠ¨å¸¦ä¸Šâ€œROLEâ€ å‰ç¼€ç½¢äº†ã€‚ä½†ä»ä½¿ç”¨è§’åº¦æ¥çœ‹ï¼Œè§’è‰²å’Œæƒé™çš„å·®å¼‚å¯ä»¥å¾ˆå¤§ï¼Œç”¨æˆ·å¯ä»¥è‡ªè¡Œå†³å®šç³»ç»Ÿä¸­è®¸å¯æ˜¯åªèƒ½å¯¹åº”åˆ°è§’è‰²èº«ä¸Šï¼Œè¿˜æ˜¯å¯ä»¥è®©ç”¨æˆ·ä¹Ÿæ‹¥æœ‰æŸäº›è§’è‰²ä¸­æ²¡æœ‰çš„æƒé™ã€‚è¿™ä¸€ç‚¹ä¸ç¬¦åˆ RBAC çš„æ€æƒ³ï¼Œä½†ç¬”è€…ä¸ªäººè®¤åŒè¿™æ˜¯ä¸€ç§åˆ›æ–°è€Œéç ´åï¼Œåœ¨ Spring Security çš„æ–‡æ¡£ä¸Šè¯´å¾—å¾ˆæ¸…æ¥šï¼šè¿™å–å†³äºä½ è‡ªå·±ä½•ä½¿ç”¨ã€‚\n\n è§’è‰²å’Œæƒé™çš„æ ¸å¿ƒå·®å¼‚å–å†³äºç”¨æˆ·æ‰“ç®—å¦‚ä½•ä½¿ç”¨è¿™äº›ç‰¹æ€§ï¼Œåœ¨æ¡†æ¶å±‚é¢å®ƒä»¬çš„å·®åˆ«æ˜¯æå°çš„ï¼ŒåŸºæœ¬é‡‡ç”¨äº†å®Œå…¨ç›¸åŒçš„æ–¹å¼æ¥è¿›è¡Œå¤„ç†\n\né€šè¿‡ RBAC å¾ˆå®¹æ˜“æ§åˆ¶æœ€ç»ˆç”¨æˆ·åœ¨å¹¿ä¹‰å’Œç²¾ç»†çº§åˆ«ä¸Šèƒ½å¤Ÿåšä»€ä¹ˆï¼Œå¯ä»¥æŒ‡å®šç”¨æˆ·æ˜¯ç®¡ç†å‘˜ã€ä¸“å®¶ç”¨æˆ·æŠ‘æˆ–æ™®é€šç”¨æˆ·ï¼Œå¹¶ä½¿è§’è‰²å’Œè®¿é—®æƒé™ä¸ç»„ç»‡ä¸­å‘˜å·¥çš„èº«ä»½èŒä½ä¿æŒä¸€è‡´ï¼Œä»…æ ¹æ®éœ€è¦ä¸ºå‘˜å·¥å®Œæˆå·¥ä½œçš„æœ€ä½é™åº¦æ¥åˆ†é…æƒé™ã€‚è¿™äº›éƒ½æ˜¯å¤§é‡è½¯ä»¶ç³»ç»Ÿã€é•¿æ—¶é—´ç§¯ç´¯ä¸‹æ¥çš„ç»éªŒï¼Œå°†è¿™äº›ç»éªŒè¿ç”¨åœ¨è½¯ä»¶äº§å“ä¸Šï¼Œç»å¤§å¤šæ•°æƒ…å†µä¸‹è¦æ¯”è‡ªå·±å‘æ˜ã€åˆ›é€ ä¸€ä¸ªæ–°çš„è½®å­æ›´åŠ å®‰å…¨ã€‚\n2. OAuth2äº†è§£è¿‡ RBAC çš„å†…å®¹åï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹ç›¸å¯¹æ›´å¤æ‚çƒ¦ççš„ OAuth2 è®¤è¯æˆæƒåè®®ï¼ˆæ›´çƒ¦ççš„ OAuth1 å·²ç»å®Œå…¨è¢«åºŸå¼ƒäº†ï¼‰ã€‚OAuth2 æ˜¯åœ¨RFC 6749ä¸­å®šä¹‰çš„å›½é™…æ ‡å‡†ï¼Œåœ¨ RFC 6749 æ­£æ–‡çš„ç¬¬ä¸€å¥å°±é˜æ˜äº† OAuth2 æ˜¯é¢å‘äºè§£å†³ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆThird-Party Applicationï¼‰çš„è®¤è¯æˆæƒåè®®ã€‚å¦‚æœä½ çš„ç³»ç»Ÿå¹¶ä¸æ¶‰åŠç¬¬ä¸‰æ–¹ï¼Œè­¬å¦‚æˆ‘ä»¬å•ä½“æ¶æ„çš„ Fenixâ€™s Bookstore ä¸­å°±æ—¢ä¸ä¸ºç¬¬ä¸‰æ–¹æä¾›æœåŠ¡ï¼Œä¹Ÿä¸ä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æœåŠ¡ï¼Œé‚£å¼•å…¥ OAuth2 å…¶å®å¹¶æ— å¿…è¦ã€‚ä¸ºä»€ä¹ˆå¼ºè°ƒç¬¬ä¸‰æ–¹ï¼Ÿåœ¨å¤šæ–¹ç³»ç»Ÿæˆæƒè¿‡ç¨‹å…·ä½“ä¼šæœ‰ä»€ä¹ˆé—®é¢˜éœ€è¦ä¸“é—¨åˆ¶è®¢ä¸€ä¸ªæ ‡å‡†åè®®æ¥è§£å†³å‘¢ï¼Ÿç¬”è€…ä¸¾ä¸ªç°å®çš„ä¾‹å­æ¥è§£é‡Šã€‚\nè­¬å¦‚ä½ ç°åœ¨æ­£åœ¨é˜…è¯»çš„è¿™ä¸ªç½‘ç«™ï¼ˆhttps://icyfenix.cnï¼‰ï¼Œå®ƒçš„å»ºè®¾å’Œæ›´æ–°å¤§è‡´æµç¨‹æ˜¯ï¼šç¬”è€…ä»¥ Markdown å½¢å¼å†™å¥½äº†æŸç¯‡æ–‡ç« ï¼Œä¸Šä¼ åˆ°ç”±GitHub æä¾›çš„ä»£ç ä»“åº“ï¼Œæ¥ç€ç”±Travis-CIæä¾›çš„æŒç»­é›†æˆæœåŠ¡ä¼šæ£€æµ‹åˆ°è¯¥ä»“åº“å‘ç”Ÿäº†å˜åŒ–ï¼Œè§¦å‘ä¸€æ¬¡ Vuepress ç¼–è¯‘æ´»åŠ¨ï¼Œç”Ÿæˆç›®å½•å’Œé™æ€çš„ HTML é¡µé¢ï¼Œç„¶åæ¨é€å›GitHub Pagesï¼Œå†è§¦å‘å›½å†…çš„ CDN ç¼“å­˜åˆ·æ–°ã€‚è¿™ä¸ªè¿‡ç¨‹è¦èƒ½é¡ºåˆ©è¿›è¡Œï¼Œå°±å­˜åœ¨ä¸€ç³»åˆ—å¿…é¡»è§£å†³çš„æˆæƒé—®é¢˜ï¼ŒTravis-CI åªæœ‰å¾—åˆ°äº†æˆ‘çš„æ˜ç¡®æˆæƒï¼ŒGitHub æ‰èƒ½åŒæ„å®ƒè¯»å–æˆ‘ä»£ç ä»“åº“ä¸­çš„å†…å®¹ï¼Œé—®é¢˜æ˜¯å®ƒè¯¥å¦‚ä½•è·å¾—æˆ‘çš„æˆæƒå‘¢ï¼Ÿä¸€ç§æœ€ç®€å•ç²—æš´çš„æ–¹æ¡ˆæ˜¯æŠŠæˆ‘çš„ç”¨æˆ·è´¦å·å’Œå¯†ç éƒ½å‘Šè¯‰ Travis-CIï¼Œä½†è¿™æ˜¾ç„¶å¯¼è‡´äº†ä»¥ä¸‹è¿™äº›é—®é¢˜ï¼š\n\nå¯†ç æ³„æ¼ï¼šå¦‚æœ Travis-CI è¢«é»‘å®¢æ”»ç ´ï¼Œå°†å¯¼è‡´æˆ‘çš„ GitHub çš„å¯†ç ä¹ŸåŒæ—¶è¢«æ³„æ¼ã€‚\nè®¿é—®èŒƒå›´ï¼šTravis-CI å°†æœ‰èƒ½åŠ›è¯»å–ã€ä¿®æ”¹ã€åˆ é™¤ã€æ›´æ–°æˆ‘æ”¾åœ¨ GitHub ä¸Šçš„æ‰€æœ‰ä»£ç ä»“åº“ï¼Œè€Œæˆ‘å¹¶ä¸å¸Œæœ›å®ƒèƒ½å¤Ÿä¿®æ”¹åˆ é™¤æ–‡ä»¶ã€‚\næˆæƒå›æ”¶ï¼šåªæœ‰ä¿®æ”¹å¯†ç æ‰èƒ½å›æ”¶æˆ‘æˆäºˆç»™ Travis-CI çš„æƒåŠ›ï¼Œå¯æ˜¯æˆ‘åœ¨ GitHub çš„å¯†ç åªæœ‰ä¸€ä¸ªï¼Œæˆæƒçš„åº”ç”¨é™¤äº† Travis-CI ä¹‹å¤–å´è¿˜æœ‰è®¸å¤šï¼Œä¿®æ”¹äº†æ„å‘³ç€æ‰€æœ‰åˆ«çš„ç¬¬ä¸‰æ–¹çš„åº”ç”¨ç¨‹åºä¼šå…¨éƒ¨å¤±æ•ˆã€‚\n\nä»¥ä¸Šåˆ—ä¸¾çš„è¿™äº›é—®é¢˜ï¼Œä¹Ÿæ­£æ˜¯ OAuth2 æ‰€è¦è§£å†³çš„é—®é¢˜ï¼Œå°¤å…¶æ˜¯è¦æ±‚ç¬¬ä¸‰æ–¹ç³»ç»Ÿæ²¡æœ‰æ”¯æŒ HTTPS ä¼ è¾“å®‰å…¨çš„ç¯å¢ƒä¸‹ä¾ç„¶èƒ½å¤Ÿè§£å†³è¿™äº›é—®é¢˜ï¼Œè¿™å¹¶éæ˜“äº‹ã€‚\nOAuth2 ç»™å‡ºäº†å¤šç§è§£å†³åŠæ³•ï¼Œè¿™äº›åŠæ³•çš„å…±åŒç‰¹å¾æ˜¯ä»¥ä»¤ç‰Œï¼ˆTokenï¼‰ä»£æ›¿ç”¨æˆ·å¯†ç ä½œä¸ºæˆæƒçš„å‡­è¯ã€‚æœ‰äº†ä»¤ç‰Œä¹‹åï¼Œå“ªæ€•ä»¤ç‰Œè¢«æ³„æ¼ï¼Œä¹Ÿä¸ä¼šå¯¼è‡´å¯†ç çš„æ³„æ¼ï¼›ä»¤ç‰Œä¸Šå¯ä»¥è®¾å®šè®¿é—®èµ„æºçš„èŒƒå›´ä»¥åŠæ—¶æ•ˆæ€§ï¼›æ¯ä¸ªåº”ç”¨éƒ½æŒæœ‰ç‹¬ç«‹çš„ä»¤ç‰Œï¼Œå“ªä¸ªå¤±æ•ˆéƒ½ä¸ä¼šæ³¢åŠå…¶ä»–ã€‚è¿™æ ·ä¸Šé¢æå‡ºçš„ä¸‰ä¸ªé—®é¢˜å°±éƒ½è§£å†³äº†ã€‚æœ‰äº†ä¸€å±‚ä»¤ç‰Œä¹‹åï¼Œæ•´ä¸ªæˆæƒçš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nè¿™ä¸ªæ—¶åºå›¾é‡Œé¢æ¶‰åŠåˆ°äº† OAuth2 ä¸­å‡ ä¸ªå…³é”®æœ¯è¯­ï¼Œæˆ‘ä»¬é€šè¿‡å‰é¢é‚£ä¸ªå…·ä½“çš„ä¸Šä¸‹æ–‡è¯­å¢ƒæ¥è§£é‡Šå…¶å«ä¹‰ï¼Œè¿™å¯¹ç†è§£åç»­å‡ ç§è®¤è¯æµç¨‹ååˆ†é‡è¦ï¼š\n\nç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆThird-Party Applicationï¼‰ï¼šéœ€è¦å¾—åˆ°æˆæƒè®¿é—®æˆ‘èµ„æºçš„é‚£ä¸ªåº”ç”¨ï¼Œå³æ­¤åœºæ™¯ä¸­çš„â€œTravis-CIâ€ã€‚\næˆæƒæœåŠ¡å™¨ï¼ˆAuthorization Serverï¼‰ï¼šèƒ½å¤Ÿæ ¹æ®æˆ‘çš„æ„æ„¿æä¾›æˆæƒï¼ˆæˆæƒä¹‹å‰è‚¯å®šå·²ç»è¿›è¡Œäº†å¿…è¦çš„è®¤è¯è¿‡ç¨‹ï¼Œä½†å®ƒä¸æˆæƒå¯ä»¥æ²¡æœ‰ç›´æ¥å…³ç³»ï¼‰çš„æœåŠ¡å™¨ï¼Œå³æ­¤åœºæ™¯ä¸­çš„â€œGitHubâ€ã€‚\nèµ„æºæœåŠ¡å™¨ï¼ˆResource Serverï¼‰ï¼šèƒ½å¤Ÿæä¾›ç¬¬ä¸‰æ–¹åº”ç”¨æ‰€éœ€èµ„æºçš„æœåŠ¡å™¨ï¼Œå®ƒä¸è®¤è¯æœåŠ¡å¯ä»¥æ˜¯ç›¸åŒçš„æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ï¼Œæ­¤åœºæ™¯ä¸­çš„â€œæˆ‘çš„ä»£ç ä»“åº“â€ã€‚\nèµ„æºæ‰€æœ‰è€…ï¼ˆResource Ownerï¼‰ï¼š æ‹¥æœ‰æˆæƒæƒé™çš„äººï¼Œå³æ­¤åœºæ™¯ä¸­çš„â€œæˆ‘â€ã€‚\næ“ä½œä»£ç†ï¼ˆUser Agentï¼‰ï¼šæŒ‡ç”¨æˆ·ç”¨æ¥è®¿é—®æœåŠ¡å™¨çš„å·¥å…·ï¼Œå¯¹äºäººç±»ç”¨æˆ·æ¥è¯´ï¼Œè¿™ä¸ªé€šå¸¸æ˜¯æŒ‡æµè§ˆå™¨ï¼Œä½†åœ¨å¾®æœåŠ¡ä¸­ä¸€ä¸ªæœåŠ¡ç»å¸¸ä¼šä½œä¸ºå¦ä¸€ä¸ªæœåŠ¡çš„ç”¨æˆ·ï¼Œæ­¤æ—¶æŒ‡çš„å¯èƒ½å°±æ˜¯ HttpClientã€RPCClient æˆ–è€…å…¶ä»–è®¿é—®é€”å¾„ã€‚\n\nâ€œç”¨ä»¤ç‰Œä»£æ›¿å¯†ç â€ç¡®å®æ˜¯è§£å†³é—®é¢˜çš„å¥½æ–¹æ³•ï¼Œä½†è¿™å……å…¶é‡åªèƒ½ç®—ä¸ªæ€è·¯ï¼Œè·ç¦»å¯å®æ–½çš„æ­¥éª¤è¿˜æ˜¯ä¸å¤Ÿå…·ä½“çš„ï¼Œæ—¶åºå›¾ä¸­çš„â€œè¦æ±‚/åŒæ„æˆæƒâ€ã€â€œè¦æ±‚/åŒæ„å‘æ”¾ä»¤ç‰Œâ€ã€â€œè¦æ±‚/åŒæ„å¼€æ”¾èµ„æºâ€å‡ ä¸ªæœåŠ¡è¯·æ±‚ã€å“åº”è¯¥å¦‚ä½•è®¾è®¡ï¼Œè¿™å°±æ˜¯æ‰§è¡Œæ­¥éª¤çš„å…³é”®äº†ã€‚å¯¹æ­¤ï¼ŒOAuth2 ä¸€å…±æå‡ºäº†å››ç§ä¸åŒçš„æˆæƒæ–¹å¼ï¼ˆè¿™ä¹Ÿæ˜¯ OAuth2 å¤æ‚çƒ¦ççš„ä¸»è¦åŸå› ï¼‰ï¼Œåˆ†åˆ«ä¸ºï¼š\n\næˆæƒç æ¨¡å¼ï¼ˆAuthorization Codeï¼‰\néšå¼æˆæƒæ¨¡å¼ï¼ˆImplicitï¼‰\nå¯†ç æ¨¡å¼ï¼ˆResource Owner Password Credentialsï¼‰\nå®¢æˆ·ç«¯æ¨¡å¼ï¼ˆClient Credentialsï¼‰\n\n1ï¼‰æˆæƒç æ¨¡å¼æˆæƒç æ¨¡å¼æ˜¯å››ç§æ¨¡å¼ä¸­æœ€ä¸¥ï¼ˆluÅï¼‰è°¨ï¼ˆsuÅï¼‰çš„ï¼Œå®ƒè€ƒè™‘åˆ°äº†å‡ ä¹æ‰€æœ‰æ•æ„Ÿä¿¡æ¯æ³„æ¼çš„é¢„é˜²å’Œåæœã€‚å…·ä½“æ­¥éª¤çš„æ—¶åºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nå¼€å§‹è¿›è¡Œæˆæƒè¿‡ç¨‹ä»¥å‰ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å…ˆè¦åˆ°æˆæƒæœåŠ¡å™¨ä¸Šè¿›è¡Œæ³¨å†Œï¼Œæ‰€è°“æ³¨å†Œï¼Œæ˜¯æŒ‡å‘è®¤è¯æœåŠ¡å™¨æä¾›ä¸€ä¸ªåŸŸååœ°å€ï¼Œç„¶åä»æˆæƒæœåŠ¡å™¨ä¸­è·å– ClientID å’Œ ClientSecretï¼Œä»¥ä¾¿èƒ½å¤Ÿé¡ºåˆ©å®Œæˆå¦‚ä¸‹æˆæƒè¿‡ç¨‹ï¼š\n\nç¬¬ä¸‰æ–¹åº”ç”¨å°†èµ„æºæ‰€æœ‰è€…ï¼ˆç”¨æˆ·ï¼‰å¯¼å‘æˆæƒæœåŠ¡å™¨çš„æˆæƒé¡µé¢ï¼Œå¹¶å‘æˆæƒæœåŠ¡å™¨æä¾› ClientID åŠç”¨æˆ·åŒæ„æˆæƒåçš„å›è°ƒ URIï¼Œè¿™æ˜¯ä¸€æ¬¡å®¢æˆ·ç«¯é¡µé¢è½¬å‘ã€‚\næˆæƒæœåŠ¡å™¨æ ¹æ® ClientID ç¡®è®¤ç¬¬ä¸‰æ–¹åº”ç”¨çš„èº«ä»½ï¼Œç”¨æˆ·åœ¨æˆæƒæœåŠ¡å™¨ä¸­å†³å®šæ˜¯å¦åŒæ„å‘è¯¥èº«ä»½çš„åº”ç”¨è¿›è¡Œæˆæƒï¼Œç”¨æˆ·è®¤è¯çš„è¿‡ç¨‹æœªå®šä¹‰åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œåœ¨æ­¤ä¹‹å‰åº”è¯¥å·²ç»å®Œæˆã€‚\nå¦‚æœç”¨æˆ·åŒæ„æˆæƒï¼ŒæˆæƒæœåŠ¡å™¨å°†è½¬å‘ç¬¬ä¸‰æ–¹åº”ç”¨åœ¨ç¬¬ 1 æ­¥è°ƒç”¨ä¸­æä¾›çš„å›è°ƒ URIï¼Œå¹¶é™„å¸¦ä¸Šä¸€ä¸ªæˆæƒç å’Œè·å–ä»¤ç‰Œçš„åœ°å€ä½œä¸ºå‚æ•°ï¼Œè¿™æ˜¯ç¬¬äºŒæ¬¡å®¢æˆ·ç«¯é¡µé¢è½¬å‘ã€‚\nç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡å›è°ƒåœ°å€æ”¶åˆ°æˆæƒç ï¼Œç„¶åå°†æˆæƒç ä¸è‡ªå·±çš„ ClientSecret ä¸€èµ·ä½œä¸ºå‚æ•°ï¼Œé€šè¿‡æœåŠ¡å™¨å‘æˆæƒæœåŠ¡å™¨æä¾›çš„è·å–ä»¤ç‰Œçš„æœåŠ¡åœ°å€å‘èµ·è¯·æ±‚ï¼Œæ¢å–ä»¤ç‰Œã€‚è¯¥æœåŠ¡å™¨çš„åœ°å€åº”ä¸æ³¨å†Œæ—¶æä¾›çš„åŸŸåå¤„äºåŒä¸€ä¸ªåŸŸä¸­ã€‚\næˆæƒæœåŠ¡å™¨æ ¸å¯¹æˆæƒç å’Œ ClientSecretï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨æˆäºˆä»¤ç‰Œã€‚ä»¤ç‰Œå¯ä»¥æ˜¯ä¸€ä¸ªæˆ–è€…ä¸¤ä¸ªï¼Œå…¶ä¸­å¿…å®šè¦æœ‰çš„æ˜¯è®¿é—®ä»¤ç‰Œï¼ˆAccess Tokenï¼‰ï¼Œå¯é€‰çš„æ˜¯åˆ·æ–°ä»¤ç‰Œï¼ˆRefresh Tokenï¼‰ã€‚è®¿é—®ä»¤ç‰Œç”¨äºåˆ°èµ„æºæœåŠ¡å™¨è·å–èµ„æºï¼Œæœ‰æ•ˆæœŸè¾ƒçŸ­ï¼Œåˆ·æ–°ä»¤ç‰Œç”¨äºåœ¨è®¿é—®ä»¤ç‰Œå¤±æ•ˆåé‡æ–°è·å–ï¼Œæœ‰æ•ˆæœŸè¾ƒé•¿ã€‚\nèµ„æºæœåŠ¡å™¨æ ¹æ®è®¿é—®ä»¤ç‰Œæ‰€å…è®¸çš„æƒé™ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨æä¾›èµ„æºã€‚\n\nè¿™ä¸ªè¿‡ç¨‹è®¾è®¡ï¼Œå·²ç»è€ƒè™‘åˆ°äº†å‡ ä¹æ‰€æœ‰åˆç†çš„æ„å¤–æƒ…å†µï¼Œç¬”è€…å†ä¸¾å‡ ä¸ªæœ€å®¹æ˜“é‡åˆ°çš„æ„å¤–çŠ¶å†µï¼Œä»¥ä¾¿ä½ èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£ä¸ºä½•è¦è¿™æ ·è®¾è®¡ OAuth2ã€‚\n\nä¼šä¸ä¼šæœ‰å…¶ä»–åº”ç”¨å†’å……ç¬¬ä¸‰æ–¹åº”ç”¨éª—å–æˆæƒï¼ŸClientID ä»£è¡¨ä¸€ä¸ªç¬¬ä¸‰æ–¹åº”ç”¨çš„â€œç”¨æˆ·åâ€ï¼Œè¿™é¡¹ä¿¡æ¯æ˜¯å¯ä»¥å®Œå…¨å…¬å¼€çš„ã€‚ä½† ClientSecret åº”å½“åªæœ‰åº”ç”¨è‡ªå·±æ‰çŸ¥é“ï¼Œè¿™ä¸ªä»£è¡¨äº†ç¬¬ä¸‰æ–¹åº”ç”¨çš„â€œå¯†ç â€ã€‚åœ¨ç¬¬ 5 æ­¥å‘æ”¾ä»¤ç‰Œæ—¶ï¼Œè°ƒç”¨è€…å¿…é¡»èƒ½å¤Ÿæä¾› ClientSecret æ‰èƒ½æˆåŠŸå®Œæˆã€‚åªè¦ç¬¬ä¸‰æ–¹åº”ç”¨å¦¥å–„ä¿ç®¡å¥½ ClientSecretï¼Œå°±æ²¡æœ‰äººèƒ½å¤Ÿå†’å……å®ƒã€‚\nä¸ºä»€ä¹ˆè¦å…ˆå‘æ”¾æˆæƒç ï¼Œå†ç”¨æˆæƒç æ¢ä»¤ç‰Œï¼Ÿè¿™æ˜¯å› ä¸ºå®¢æˆ·ç«¯è½¬å‘ï¼ˆé€šå¸¸å°±æ˜¯ä¸€æ¬¡ HTTP 302 é‡å®šå‘ï¼‰å¯¹äºç”¨æˆ·æ˜¯å¯è§çš„ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œæˆæƒç å¯èƒ½ä¼šæš´éœ²ç»™ç”¨æˆ·ä»¥åŠç”¨æˆ·æœºå™¨ä¸Šçš„å…¶ä»–ç¨‹åºï¼Œä½†ç”±äºç”¨æˆ·å¹¶æ²¡æœ‰ ClientSecretï¼Œå…‰æœ‰æˆæƒç ä¹Ÿæ˜¯æ— æ³•æ¢å–åˆ°ä»¤ç‰Œçš„ï¼Œæ‰€ä»¥é¿å…äº†ä»¤ç‰Œåœ¨ä¼ è¾“è½¬å‘è¿‡ç¨‹ä¸­è¢«æ³„æ¼çš„é£é™©ã€‚\nä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸€ä¸ªæ—¶é™è¾ƒé•¿çš„åˆ·æ–°ä»¤ç‰Œå’Œæ—¶é™è¾ƒçŸ­çš„è®¿é—®ä»¤ç‰Œï¼Ÿä¸èƒ½ç›´æ¥æŠŠè®¿é—®ä»¤ç‰Œçš„æ—¶é—´è°ƒé•¿å—ï¼Ÿè¿™æ˜¯ä¸ºäº†ç¼“è§£ OAuth2 åœ¨å®é™…åº”ç”¨ä¸­çš„ä¸€ä¸ªä¸»è¦ç¼ºé™·ï¼Œé€šå¸¸è®¿é—®ä»¤ç‰Œä¸€æ—¦å‘æ”¾ï¼Œé™¤éè¶…è¿‡äº†ä»¤ç‰Œä¸­çš„æœ‰æ•ˆæœŸï¼Œå¦åˆ™å¾ˆéš¾ï¼ˆéœ€è¦ä»˜å‡ºè¾ƒå¤§ä»£ä»·ï¼‰æœ‰å…¶ä»–æ–¹å¼è®©å®ƒå¤±æ•ˆï¼Œæ‰€ä»¥è®¿é—®ä»¤ç‰Œçš„æ—¶æ•ˆæ€§ä¸€èˆ¬è®¾è®¡çš„æ¯”è¾ƒçŸ­ï¼Œè­¬å¦‚å‡ ä¸ªå°æ—¶ï¼Œå¦‚æœè¿˜éœ€è¦ç»§ç»­ç”¨ï¼Œé‚£å°±å®šæœŸç”¨åˆ·æ–°ä»¤ç‰Œå»æ›´æ–°ï¼ŒæˆæƒæœåŠ¡å™¨å°±å¯ä»¥åœ¨æ›´æ–°è¿‡ç¨‹ä¸­å†³å®šæ˜¯å¦è¿˜è¦ç»§ç»­ç»™äºˆæˆæƒã€‚è‡³äºä¸ºä»€ä¹ˆè¯´å¾ˆéš¾è®©å®ƒå¤±æ•ˆï¼Œæˆ‘ä»¬å°†æ”¾åˆ°ä¸‹ä¸€èŠ‚â€œå‡­è¯â€ä¸­å»è§£é‡Šã€‚\n\nå°½ç®¡æˆæƒç æ¨¡å¼æ˜¯ä¸¥è°¨çš„ï¼Œä½†æ˜¯å®ƒå¹¶ä¸å¤Ÿå¥½ç”¨ï¼Œè¿™ä¸ä»…ä»…ä½“ç°åœ¨å®ƒé‚£ç¹å¤çš„è°ƒç”¨è¿‡ç¨‹ä¸Šï¼Œè¿˜ä½“ç°åœ¨å®ƒå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨æå‡ºäº†ä¸€ä¸ªâ€œè²Œä¼¼ä¸éš¾â€çš„è¦æ±‚ï¼šç¬¬ä¸‰æ–¹åº”ç”¨å¿…é¡»æœ‰åº”ç”¨æœåŠ¡å™¨ï¼Œå› ä¸ºç¬¬ 4 æ­¥è¦å‘èµ·æœåŠ¡ç«¯è½¬å‘ï¼Œè€Œä¸”è¦æ±‚æœåŠ¡ç«¯çš„åœ°å€å¿…é¡»ä¸æ³¨å†Œæ—¶æä¾›çš„åœ°å€åœ¨åŒä¸€ä¸ªåŸŸå†…ã€‚ä¸è¦è§‰å¾—è¦æ±‚ä¸€ä¸ªç³»ç»Ÿè¦æœ‰åº”ç”¨æœåŠ¡å™¨æ˜¯å¤©ç»åœ°ä¹‰ç†æ‰€å½“ç„¶çš„äº‹æƒ…ï¼Œä½ ç°åœ¨é˜…è¯»æ–‡ç« çš„è¿™ä¸ªç½‘ç«™å°±æ²¡æœ‰ä»»ä½•åº”ç”¨æœåŠ¡å™¨çš„æ”¯æŒï¼Œé‡Œé¢ä½¿ç”¨åˆ°äº† Gitalk ä½œä¸ºæ¯ç¯‡æ–‡ç« çš„ç•™è¨€æ¿ï¼Œå®ƒå¯¹ GitHub æ¥è¯´ç…§æ ·æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œéœ€è¦ OAuth2 æˆæƒæ¥è§£å†³ã€‚é™¤åŸºäºæµè§ˆå™¨çš„åº”ç”¨å¤–ï¼Œç°åœ¨è¶Šæ¥è¶Šæ™®éçš„æ˜¯ç§»åŠ¨æˆ–æ¡Œé¢ç«¯çš„å®¢æˆ·ç«¯ Web åº”ç”¨ï¼ˆClient-Side Web Applicationsï¼‰ï¼Œè­¬å¦‚ç°åœ¨å¤§é‡çš„åŸºäº Cordovaã€Electronã€Node-Webkit.js çš„PWA åº”ç”¨ï¼Œå®ƒä»¬éƒ½æ²¡æœ‰åº”ç”¨æœåŠ¡å™¨çš„æ”¯æŒã€‚ç”±äºæœ‰è¿™æ ·çš„å®é™…éœ€æ±‚ï¼Œå› æ­¤å¼•å‡ºäº† OAuth2 çš„ç¬¬äºŒç§æˆæƒæ¨¡å¼ï¼šéšå¼æˆæƒã€‚\n2ï¼‰éšå¼æˆæƒæ¨¡å¼éšå¼æˆæƒçœç•¥æ‰äº†é€šè¿‡æˆæƒç æ¢å–ä»¤ç‰Œçš„æ­¥éª¤ï¼Œæ•´ä¸ªæˆæƒè¿‡ç¨‹éƒ½ä¸éœ€è¦æœåŠ¡ç«¯æ”¯æŒï¼Œä¸€æ­¥åˆ°ä½ã€‚ä»£ä»·æ˜¯åœ¨éšå¼æˆæƒä¸­ï¼ŒæˆæƒæœåŠ¡å™¨ä¸ä¼šå†å»éªŒè¯ç¬¬ä¸‰æ–¹åº”ç”¨çš„èº«ä»½ï¼Œå› ä¸ºå·²ç»æ²¡æœ‰åº”ç”¨æœåŠ¡å™¨äº†ï¼ŒClientSecret æ²¡æœ‰äººä¿ç®¡ï¼Œå°±æ²¡æœ‰å­˜åœ¨çš„æ„ä¹‰äº†ã€‚ä½†å…¶å®è¿˜æ˜¯ä¼šé™åˆ¶ç¬¬ä¸‰æ–¹åº”ç”¨çš„å›è°ƒ URI åœ°å€å¿…é¡»ä¸æ³¨å†Œæ—¶æä¾›çš„åŸŸåä¸€è‡´ï¼Œå°½ç®¡æœ‰å¯èƒ½è¢« DNS æ±¡æŸ“ä¹‹ç±»çš„æ”»å‡»æ‰€æ”»ç ´ï¼Œä½†ä»ç®—æ˜¯å°½å¯èƒ½åŠªåŠ›ä¸€ä¸‹ã€‚åŒæ ·çš„åŸå› ï¼Œä¹Ÿä¸èƒ½é¿å…ä»¤ç‰Œæš´éœ²ç»™èµ„æºæ‰€æœ‰è€…ï¼Œä¸èƒ½é¿å…ç”¨æˆ·æœºå™¨ä¸Šå¯èƒ½æ„å›¾ä¸è½¨çš„å…¶ä»–ç¨‹åºã€HTTP çš„ä¸­é—´äººæ”»å‡»ç­‰é£é™©äº†ã€‚\néšå¼æˆæƒçš„è°ƒç”¨æ—¶åºå¦‚ä¸‹å›¾ï¼ˆä»æ­¤ä¹‹åçš„æˆæƒæ¨¡å¼ï¼Œæ—¶åºä¸­ç¬”è€…å°±ä¸å†ç”»å‡ºèµ„æºè®¿é—®éƒ¨åˆ†çš„å†…å®¹äº†ï¼Œå°±æ˜¯å‰é¢ opt æ¡†ä¸­çš„é‚£ä¸€éƒ¨åˆ†ï¼Œä»¥ä¾¿æ›´èšç„¦é‡ç‚¹ï¼‰æ‰€ç¤ºã€‚\n\nåœ¨æ—¶åºå›¾æ‰€ç¤ºçš„äº¤äº’è¿‡ç¨‹é‡Œï¼Œéšå¼æ¨¡å¼ä¸æˆæƒç æ¨¡å¼çš„æ˜¾è‘—åŒºåˆ«æ˜¯æˆæƒæœåŠ¡å™¨åœ¨å¾—åˆ°ç”¨æˆ·æˆæƒåï¼Œç›´æ¥è¿”å›äº†è®¿é—®ä»¤ç‰Œï¼Œè¿™æ˜¾è‘—åœ°é™ä½äº†å®‰å…¨æ€§ï¼Œä½† OAuth2 ä»ç„¶åŠªåŠ›å°½å¯èƒ½åœ°åšåˆ°ç›¸å¯¹å®‰å…¨ï¼Œè­¬å¦‚åœ¨å‰é¢æåˆ°çš„éšå¼æˆæƒä¸­ï¼Œå°½ç®¡ä¸éœ€è¦ç”¨åˆ°æœåŠ¡ç«¯ï¼Œä½†ä»ç„¶éœ€è¦åœ¨æ³¨å†Œæ—¶æä¾›å›è°ƒåŸŸåï¼Œæ­¤æ—¶ä¼šè¦æ±‚è¯¥åŸŸåä¸æ¥å—ä»¤ç‰Œçš„æœåŠ¡å¤„äºåŒä¸€ä¸ªåŸŸå†…ã€‚æ­¤å¤–ï¼ŒåŒæ ·åŸºäºå®‰å…¨è€ƒè™‘ï¼Œåœ¨éšå¼æ¨¡å¼ä¸­æ˜ç¡®ç¦æ­¢å‘æ”¾åˆ·æ–°ä»¤ç‰Œã€‚\nè¿˜æœ‰ä¸€ç‚¹ï¼Œåœ¨ RFC 6749 å¯¹éšå¼æˆæƒçš„æè¿°ä¸­ï¼Œç‰¹åˆ«å¼ºè°ƒäº†ä»¤ç‰Œå¿…é¡»æ˜¯â€œé€šè¿‡ Fragment å¸¦å›â€çš„ã€‚éƒ¨åˆ†å¯¹è¶…æ–‡æœ¬åè®®æ²¡æœ‰äº†è§£çš„è¯»è€…ï¼Œå¯èƒ½è¿˜æ ¹æœ¬ä¸çŸ¥é“Fragmentæ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Ÿ\n\n é¢å¤–çŸ¥è¯†ï¼šFragment\nIn computer hypertext, a fragment identifier is a string of characters that refers to a resource that is subordinate to another, primary resource. The primary resource is identified by a Uniform Resource Identifier (URI), and the fragment identifier points to the subordinate resource.\nâ€‹                                                                                                                                                                        â€”â€”URI Fragmentï¼ŒWikipedia\n\nçœ‹äº†è¿™æ®µè‹±æ–‡å®šä¹‰è¿˜æ˜¯è§‰å¾—æ¦‚å¿µä¸å¥½çš„è¯ï¼Œæˆ‘ç®€å•å‘Šè¯‰ä½ ï¼ŒFragment å°±æ˜¯åœ°å€ä¸­#å·åé¢çš„éƒ¨åˆ†ï¼Œè­¬å¦‚è¿™ä¸ªåœ°å€ï¼š\nhttp://bookstore.icyfenix.cn/#/detail/1\n\nåé¢çš„/detail/1ä¾¿æ˜¯ Fragmentï¼Œè¿™ä¸ªè¯­æ³•æ˜¯åœ¨RFC 3986ä¸­å®šä¹‰çš„ï¼ŒRFC 3986 ä¸­è§£é‡Šäº† Fragment æ˜¯ç”¨äºå®¢æˆ·ç«¯å®šä½çš„ URI ä»å±èµ„æºï¼Œè­¬å¦‚ HTML ä¸­å°±å¯ä»¥ä½¿ç”¨ Fragment æ¥åšæ–‡æ¡£å†…çš„è·³è½¬è€Œä¸ä¼šå‘èµ·æœåŠ¡ç«¯è¯·æ±‚ï¼Œä½ ç°åœ¨å¯ä»¥ç‚¹å‡»ä¸€ä¸‹è¿™ç¯‡æ–‡ç« å·¦è¾¹èœå•ä¸­çš„å‡ ä¸ªå­æ ‡é¢˜ï¼Œçœ‹çœ‹æµè§ˆå™¨åœ°å€æ çš„å˜åŒ–ã€‚æ­¤å¤–ï¼ŒRFC 3986 è¿˜è§„å®šäº†å¦‚æœæµè§ˆå™¨å¯¹ä¸€ä¸ªå¸¦æœ‰ Fragment çš„åœ°å€å‘å‡º Ajax è¯·æ±‚ï¼Œé‚£ Fragment æ˜¯ä¸ä¼šè·Ÿéšè¯·æ±‚è¢«å‘é€åˆ°æœåŠ¡ç«¯çš„ï¼Œåªèƒ½åœ¨å®¢æˆ·ç«¯é€šè¿‡ Script è„šæœ¬æ¥è¯»å–ã€‚æ‰€ä»¥éšå¼æˆæƒå·§å¦™åœ°åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œå°½æœ€å¤§åŠªåŠ›åœ°é¿å…äº†ä»¤ç‰Œä»æ“ä½œä»£ç†åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ä¹‹é—´çš„é“¾è·¯å­˜åœ¨è¢«æ”»å‡»è€Œæ³„æ¼å‡ºå»çš„å¯èƒ½æ€§ã€‚è‡³äºè®¤è¯æœåŠ¡å™¨åˆ°æ“ä½œä»£ç†ä¹‹é—´çš„è¿™ä¸€æ®µé“¾è·¯çš„å®‰å…¨ï¼Œåˆ™åªèƒ½é€šè¿‡ TLSï¼ˆå³ HTTPSï¼‰æ¥ä¿è¯ä¸­é—´ä¸ä¼šå—åˆ°æ”»å‡»äº†ï¼Œæˆ‘ä»¬å¯ä»¥è¦æ±‚è®¤è¯æœåŠ¡å™¨å¿…é¡»éƒ½æ˜¯å¯ç”¨ HTTPS çš„ï¼Œä½†æ— æ³•è¦æ±‚ç¬¬ä¸‰æ–¹åº”ç”¨åŒæ ·éƒ½æ”¯æŒ HTTPSã€‚\n3ï¼‰å¯†ç æ¨¡å¼å‰é¢æ‰€è¯´çš„æˆæƒç æ¨¡å¼å’Œéšç§æ¨¡å¼å±äºçº¯ç²¹çš„æˆæƒæ¨¡å¼ï¼Œå®ƒä»¬ä¸è®¤è¯æ²¡æœ‰ç›´æ¥çš„è”ç³»ï¼Œå¦‚ä½•è®¤è¯ç”¨æˆ·çš„çœŸå®èº«ä»½æ˜¯ä¸è¿›è¡Œæˆæƒäº’ç›¸ç‹¬ç«‹çš„è¿‡ç¨‹ã€‚ä½†åœ¨å¯†ç æ¨¡å¼é‡Œï¼Œè®¤è¯å’Œæˆæƒå°±è¢«æ•´åˆæˆäº†åŒä¸€ä¸ªè¿‡ç¨‹äº†ã€‚\nå¯†ç æ¨¡å¼åŸæœ¬çš„è®¾è®¡æ„å›¾æ˜¯ä»…é™äºç”¨æˆ·å¯¹ç¬¬ä¸‰æ–¹åº”ç”¨æ˜¯é«˜åº¦å¯ä¿¡ä»»çš„åœºæ™¯ä¸­ä½¿ç”¨ï¼Œå› ä¸ºç”¨æˆ·éœ€è¦æŠŠå¯†ç æ˜æ–‡æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹ä»¥æ­¤å‘æˆæƒæœåŠ¡å™¨è·å–ä»¤ç‰Œã€‚è¿™ç§é«˜åº¦å¯ä¿¡çš„ç¬¬ä¸‰æ–¹æ˜¯æä¸ºè¾ƒç½•è§çš„ï¼Œå°½ç®¡ä»‹ç» OAuth2 çš„ææ–™ä¸­ï¼Œç»å¸¸ä¸¾çš„ä¾‹å­æ˜¯â€œæ“ä½œç³»ç»Ÿä½œä¸ºç¬¬ä¸‰æ–¹åº”ç”¨å‘æˆæƒæœåŠ¡å™¨ç”³è¯·èµ„æºâ€ï¼Œä½†çœŸå®åº”ç”¨ä¸­æå°‘é‡åˆ°è¿™æ ·çš„æƒ…å†µï¼Œåˆç†æ€§ä¾ç„¶ååˆ†æœ‰é™ã€‚\nç¬”è€…è®¤ä¸ºï¼Œå¦‚æœè¦é‡‡ç”¨å¯†ç æ¨¡å¼ï¼Œé‚£â€œç¬¬ä¸‰æ–¹â€å±æ€§å°±å¿…é¡»å¼±åŒ–ï¼ŒæŠŠâ€œç¬¬ä¸‰æ–¹â€è§†ä½œæ˜¯ç³»ç»Ÿä¸­ä¸æˆæƒæœåŠ¡å™¨ç›¸å¯¹ç‹¬ç«‹çš„å­æ¨¡å—ï¼Œåœ¨ç‰©ç†ä¸Šç‹¬ç«‹äºæˆæƒæœåŠ¡å™¨éƒ¨ç½²ï¼Œä½†æ˜¯åœ¨é€»è¾‘ä¸Šä¸æˆæƒæœåŠ¡å™¨ä»åŒå±ä¸€ä¸ªç³»ç»Ÿï¼Œè¿™æ ·å°†è®¤è¯å’Œæˆæƒä¸€å¹¶å®Œæˆçš„å¯†ç æ¨¡å¼æ‰ä¼šæœ‰åˆç†çš„åº”ç”¨åœºæ™¯ã€‚\nè­¬å¦‚ Fenixâ€™s Bookstore ä¾¿ç›´æ¥é‡‡ç”¨äº†å¯†ç æ¨¡å¼ï¼Œå°†è®¤è¯å’Œæˆæƒç»Ÿä¸€åˆ°ä¸€ä¸ªè¿‡ç¨‹ä¸­å®Œæˆï¼Œå°½ç®¡ Fenixâ€™s Bookstore ä¸­çš„ Frontend å·¥ç¨‹å’Œ Account å·¥ç¨‹éƒ½èƒ½ç›´æ¥æ¥è§¦åˆ°ç”¨æˆ·åå’Œå¯†ç ï¼Œä½†å®ƒä»¬äº‹å®ä¸Šéƒ½æ˜¯æ•´ä¸ªç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œè¿™ä¸ªå‰æä¸‹å¯†ç æ¨¡å¼æ‰å…·æœ‰å¯ç”¨æ€§ã€‚å…³äºåˆ†å¸ƒå¼ç³»ç»Ÿå„ä¸ªæœåŠ¡ä¹‹é—´çš„ä¿¡ä»»å…³ç³»ï¼Œåç»­ä¼šåœ¨â€œé›¶ä¿¡ä»»ç½‘ç»œâ€ä¸â€œæœåŠ¡å®‰å…¨â€ä¸­ä½œè¿›ä¸€æ­¥è®¨è®ºã€‚\nç†è§£äº†å¯†ç æ¨¡å¼çš„ç”¨é€”ï¼Œå®ƒçš„è°ƒç”¨è¿‡ç¨‹å°±å¾ˆç®€å•äº†ï¼Œå°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨æ‹¿ç€ç”¨æˆ·åå’Œå¯†ç å‘æˆæƒæœåŠ¡å™¨æ¢ä»¤ç‰Œè€Œå·²ã€‚å…·ä½“æ—¶åºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nå¯†ç æ¨¡å¼ä¸‹â€œå¦‚ä½•ä¿éšœå®‰å…¨â€çš„èŒè´£æ— æ³•ç”± OAuth2 æ¥æ‰¿æ‹…ï¼Œåªèƒ½ç”±ç”¨æˆ·å’Œç¬¬ä¸‰æ–¹åº”ç”¨æ¥è‡ªè¡Œä¿éšœï¼Œå°½ç®¡ OAuth2 åœ¨è§„èŒƒä¸­å¼ºè°ƒåˆ°â€œæ­¤æ¨¡å¼ä¸‹ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ä¸å¾—ä¿å­˜ç”¨æˆ·çš„å¯†ç â€ï¼Œä½†è¿™å¹¶æ²¡æœ‰ä»»ä½•æŠ€æœ¯ä¸Šçš„çº¦æŸåŠ›ã€‚\n4ï¼‰å®¢æˆ·ç«¯æ¨¡å¼å®¢æˆ·ç«¯æ¨¡å¼æ˜¯å››ç§æ¨¡å¼ä¸­æœ€ç®€å•çš„ï¼Œå®ƒåªæ¶‰åŠåˆ°ä¸¤ä¸ªä¸»ä½“ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨å’ŒæˆæƒæœåŠ¡å™¨ã€‚å¦‚æœä¸¥è°¨ä¸€ç‚¹ï¼Œç°åœ¨ç§°â€œç¬¬ä¸‰æ–¹åº”ç”¨â€å…¶å®å·²ç»ä¸åˆé€‚äº†ï¼Œå› ä¸ºå·²ç»æ²¡æœ‰äº†â€œç¬¬äºŒæ–¹â€çš„å­˜åœ¨ï¼Œèµ„æºæ‰€æœ‰è€…ã€æ“ä½œä»£ç†åœ¨å®¢æˆ·ç«¯æ¨¡å¼ä¸­éƒ½æ˜¯ä¸å¿…å‡ºç°çš„ã€‚ç”šè‡³ä¸¥æ ¼æ¥è¯´å«â€œæˆæƒâ€éƒ½å·²ä¸å¤ªæ°å½“ï¼Œèµ„æºæ‰€æœ‰è€…éƒ½æ²¡æœ‰äº†ï¼Œä¹Ÿå°±ä¸ä¼šæœ‰è°æˆäºˆè°æƒé™çš„è¿‡ç¨‹ã€‚\nå®¢æˆ·ç«¯æ¨¡å¼æ˜¯æŒ‡ç¬¬ä¸‰æ–¹åº”ç”¨ï¼ˆè¡Œæ–‡ä¸€è‡´è€ƒè™‘ï¼Œè¿˜æ˜¯ç»§ç»­æ²¿ç”¨è¿™ä¸ªç§°å‘¼ï¼‰ä»¥è‡ªå·±çš„åä¹‰ï¼Œå‘æˆæƒæœåŠ¡å™¨ç”³è¯·èµ„æºè®¸å¯ã€‚æ­¤æ¨¡å¼é€šå¸¸ç”¨äºç®¡ç†æ“ä½œæˆ–è€…è‡ªåŠ¨å¤„ç†ç±»å‹çš„åœºæ™¯ä¸­ã€‚ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œè­¬å¦‚ç¬”è€…å¼€äº†ä¸€å®¶å« Fenixâ€™s Bookstore çš„ä¹¦åº—ï¼Œå› ä¸ºå°æœ¬ç»è¥ï¼Œä¸åƒäº¬ä¸œé‚£æ ·å…¨å›½å¤šä¸ªä»“åº“å¯ä»¥è°ƒè´§ï¼Œå› æ­¤å¿…é¡»ä¿è¯åªè¦å®¢æˆ·æˆåŠŸè´­ä¹°ï¼Œä¹¦åº—å°±å¿…é¡»æœ‰è´§å¯å‘ï¼Œä¸å…è®¸è¶…å–ã€‚ä½†ç»å¸¸æœ‰é¡¾å®¢ä¸‹äº†è®¢å•åˆæ‹–ç€ä¸ä»˜æ¬¾ï¼Œå¯¼è‡´éƒ¨åˆ†è´§ç‰©å¤„äºå†»ç»“çŠ¶æ€ã€‚æ‰€ä»¥ Fenixâ€™s Bookstore ä¸­æœ‰ä¸€ä¸ªè®¢å•æ¸…ç†çš„å®šæ—¶æœåŠ¡ï¼Œè‡ªåŠ¨æ¸…ç†è¶…è¿‡ä¸¤åˆ†é’Ÿè¿˜æœªä»˜æ¬¾çš„è®¢å•ã€‚åœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œè®¢å•è‚¯å®šæ˜¯å±äºä¸‹å•ç”¨æˆ·è‡ªå·±çš„èµ„æºï¼Œå¦‚æœæŠŠè®¢å•æ¸…ç†æœåŠ¡çœ‹ä½œä¸€ä¸ªç‹¬ç«‹çš„ç¬¬ä¸‰æ–¹åº”ç”¨çš„è¯ï¼Œå®ƒæ˜¯ä¸å¯èƒ½å‘ä¸‹å•ç”¨æˆ·å»ç”³è¯·æˆæƒæ¥åˆ æ‰è®¢å•çš„ï¼Œè€Œåº”è¯¥ç›´æ¥ä»¥è‡ªå·±çš„åä¹‰å‘æˆæƒæœåŠ¡å™¨ç”³è¯·ä¸€ä¸ªèƒ½æ¸…ç†æ‰€æœ‰ç”¨æˆ·è®¢å•çš„æˆæƒã€‚å®¢æˆ·ç«¯æ¨¡å¼çš„æ—¶åºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nå¾®æœåŠ¡æ¶æ„å¹¶ä¸æå€¡åŒä¸€ä¸ªç³»ç»Ÿçš„å„æœåŠ¡é—´æœ‰é»˜è®¤çš„ä¿¡ä»»å…³ç³»ï¼Œæ‰€ä»¥æœåŠ¡ä¹‹é—´è°ƒç”¨ä¹Ÿéœ€è¦å…ˆè¿›è¡Œè®¤è¯æˆæƒï¼Œç„¶åæ‰èƒ½é€šä¿¡ã€‚æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯æ¨¡å¼ä¾¿æ˜¯ä¸€ç§å¸¸ç”¨çš„æœåŠ¡é—´è®¤è¯æˆæƒçš„è§£å†³æ–¹æ¡ˆã€‚Spring Cloud ç‰ˆæœ¬çš„ Fenixâ€™s Bookstoreæ˜¯é‡‡ç”¨è¿™ç§æ–¹æ¡ˆæ¥ä¿è¯å¾®æœåŠ¡ä¹‹é—´çš„åˆæ³•è°ƒç”¨çš„ï¼ŒIstio ç‰ˆæœ¬çš„ Fenixâ€™s Bookstoreåˆ™å¯ç”¨äº†åŒå‘ mTLS é€šä¿¡ï¼Œä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦æ¥ä¿éšœå®‰å…¨ï¼Œå®ƒä»¬å¯ä½œä¸ºä¸Šä¸€èŠ‚ä»‹ç»è®¤è¯æ—¶æåˆ°çš„â€œé€šä¿¡ä¿¡é“è®¤è¯â€å’Œâ€œé€šä¿¡å†…å®¹è®¤è¯â€ä¾‹å­ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å¯¹æ¯”ä¸€ä¸‹è¿™ä¸¤ç§æ–¹å¼çš„å·®å¼‚ä¼˜åŠ£ã€‚\nOAuth2 ä¸­è¿˜æœ‰ä¸€ç§ä¸å®¢æˆ·ç«¯æ¨¡å¼ç±»ä¼¼çš„æˆæƒæ¨¡å¼ï¼Œåœ¨RFC 8628ä¸­å®šä¹‰ä¸ºâ€œè®¾å¤‡ç æ¨¡å¼â€ï¼ˆDevice Codeï¼‰ï¼Œè¿™é‡Œé¡ºå¸¦æä¸€ä¸‹ã€‚è®¾å¤‡ç æ¨¡å¼ç”¨äºåœ¨æ— è¾“å…¥çš„æƒ…å†µä¸‹åŒºåˆ†è®¾å¤‡æ˜¯å¦è¢«è®¸å¯ä½¿ç”¨ï¼Œå…¸å‹çš„åº”ç”¨ä¾¿æ˜¯æ‰‹æœºé”ç½‘è§£é”ï¼ˆé”ç½‘åœ¨å›½å†…è¾ƒå°‘ï¼Œä½†åœ¨å›½å¤–å¾ˆå¸¸è§ï¼‰æˆ–è€…è®¾å¤‡æ¿€æ´»ï¼ˆè­¬å¦‚æŸæ¸¸æˆæœºæ³¨å†Œåˆ°æŸä¸ªæ¸¸æˆå¹³å°ï¼‰çš„è¿‡ç¨‹ã€‚å®ƒçš„æ—¶åºå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nè¿›è¡ŒéªŒè¯æ—¶ï¼Œè®¾å¤‡éœ€è¦ä»æˆæƒæœåŠ¡å™¨è·å–ä¸€ä¸ª URI åœ°å€å’Œä¸€ä¸ªç”¨æˆ·ç ï¼Œç„¶åéœ€è¦ç”¨æˆ·æ‰‹åŠ¨æˆ–è®¾å¤‡è‡ªåŠ¨åœ°åˆ°éªŒè¯ URI ä¸­è¾“å…¥ç”¨æˆ·ç ã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œè®¾å¤‡ä¼šä¸€ç›´å¾ªç¯ï¼Œå°è¯•å»è·å–ä»¤ç‰Œï¼Œç›´åˆ°æ‹¿åˆ°ä»¤ç‰Œæˆ–è€…ç”¨æˆ·ç è¿‡æœŸä¸ºæ­¢ã€‚\nä¸‰ã€å‡­è¯åœ¨å‰é¢ä»‹ç» OAuth2 çš„å†…å®¹ä¸­ï¼Œæ¯ä¸€ç§æˆæƒæ¨¡å¼çš„æœ€ç»ˆç›®æ ‡éƒ½æ˜¯æ‹¿åˆ°è®¿é—´ä»¤ç‰Œï¼Œä½†æœªæ¶‰åŠè¿‡æ‹¿å›æ¥çš„ä»¤ç‰Œåº”è¯¥é•¿ä»€ä¹ˆæ ·å­ã€‚åè€Œè¿˜æŒ–äº†ä¸€äº›å‘æ²¡æœ‰å¡«ï¼ˆä¸ºä½•è¯´ OAuth2 çš„ä¸€ä¸ªä¸»è¦ç¼ºé™·æ˜¯ä»¤ç‰Œéš¾ä»¥ä¸»åŠ¨å¤±æ•ˆï¼‰ã€‚è¿™èŠ‚è®¨è®ºçš„ä¸»è§’æ˜¯ä»¤ç‰Œï¼ŒåŒæ—¶ï¼Œè¿˜ä¼šè®¨è®ºå¦‚æœä¸ä½¿ç”¨ OAuth2ï¼Œå¦‚ä½•ä»¥æœ€ä¼ ç»Ÿçš„æ–¹å¼å®Œæˆè®¤è¯ã€æˆæƒã€‚\nå¯¹ â€œå¦‚ä½•æ‰¿è½½è®¤è¯æˆæƒä¿¡æ¯â€ è¿™ä¸ªé—®é¢˜çš„ä¸åŒçœ‹æ³•ï¼Œä»£è¡¨äº†è½¯ä»¶æ¶æ„å¯¹å¾…å…±äº«çŠ¶æ€ä¿¡æ¯çš„ä¸¤ç§ä¸åŒæ€è·¯ï¼šçŠ¶æ€åº”è¯¥ç»´æŠ¤åœ¨æœåŠ¡ç«¯ï¼Œè¿˜æ˜¯åœ¨å®¢æˆ·ç«¯ä¹‹ä¸­ï¼Ÿåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå´›èµ·ä»¥å‰ï¼Œè¿™ä¸ªé—®é¢˜åŸæœ¬å·²æœ‰äº†è¾ƒä¸ºç»Ÿä¸€çš„ç»“è®ºï¼Œå³ä»¥ HTTP åè®®çš„ Cookie-Session æœºåˆ¶ä¸ºä»£è¡¨çš„æœåŠ¡ç«¯çŠ¶æ€å­˜å‚¨åœ¨åˆ†å¸ƒå¼å´›èµ·å‰çš„ä¸‰åå¹´ä¸­éƒ½æ˜¯ä¸»æµçš„è§£å†³æ–¹æ¡ˆã€‚ä¸è¿‡ï¼Œåˆ°äº†æœ€è¿‘åå¹´ï¼Œç”±äºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…±äº«æ•°æ®å¿…ç„¶ä¼šå—åˆ° CAP ä¸å…¼å®¹åŸç†çš„æ‰“å‡»é™åˆ¶ï¼Œè¿«ä½¿äººä»¬é‡æ–°å»å®¡è§†ä¹‹å‰å·²åŸºæœ¬æ”¾å¼ƒæ‰çš„å®¢æˆ·ç«¯çŠ¶æ€å­˜å‚¨ã€è¿™å°±è®©åŸæœ¬åªåœ¨å¤šæ–¹ç³»ç»Ÿä¸­é‡‡ç”¨çš„ JWT ä»¤ç‰Œæ–¹æ¡ˆï¼Œåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ä¹Ÿæœ‰äº†å¦ä¸€å—ç”¨æ­¦ä¹‹åœ°ã€‚æœ¬èŠ‚å°†å›´ç»• Cookie-Session å’Œ JWT ä¹‹é—´çš„ç›¸åŒä¸ä¸åŒè€Œå±•å¼€ã€‚\n1. Cookie-Sessionå¤§å®¶çŸ¥é“HTTPåè®®æ˜¯ä¸€ç§æ— çŠ¶æ€çš„ä¼ è¾“åè®®ï¼Œæ— çŠ¶æ€æ˜¯æŒ‡åè®®å¯¹äº‹åŠ¡å¤„ç†æ²¡æœ‰ä¸Šä¸‹æ–‡çš„è®°å¿†èƒ½åŠ›ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚éƒ½æ˜¯å®Œå…¨ç‹¬ç«‹çš„ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸­è‚¯å®šæœ‰è®¸å¤šäººå¹¶æ²¡æœ‰æ„è¯†åˆ° HTTP åè®®æ— çŠ¶æ€çš„é‡è¦æ€§ã€‚å‡å¦‚ä½ åšäº†ä¸€ä¸ªç®€å•çš„ç½‘é¡µï¼Œå…¶ä¸­åŒ…å«1 ä¸ª HTMLã€2 ä¸ªScriptè„šæœ¬ã€3ä¸ªCSSï¼Œè¿˜æœ‰ 10 å¼ å›¾ç‰‡ï¼Œè‹¥è¦è¿™ä¸ªç½‘é¡µæˆåŠŸå±•ç¤ºåœ¨ç”¨æˆ·å±å¹•å‰ï¼Œéœ€è¦å®Œæˆ 16 æ¬¡ä¸æœåŠ¡ç«¯çš„äº¤äº’æ¥è·å–ä¸Šè¿°èµ„æºï¼Œç”±äºç½‘ç»œä¼ è¾“ç­‰å„ç§å› ç´ çš„å½±å“ï¼ŒæœåŠ¡å™¨å‘é€çš„é¡ºåºä¸å®¢æˆ·ç«¯è¯·æ±‚çš„å…ˆåå¹¶æ²¡æœ‰å¿…ç„¶çš„è”ç³»ï¼ŒæŒ‰ç…§å¯èƒ½å‡ºç°çš„å“åº”é¡ºåºï¼Œç†è®ºä¸Šæœ€å¤šä¼šæœ‰ P(16ï¼Œ16)ï¼20922789888000 ç§å¯èƒ½æ€§ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœ HTTP åè®®ä¸æ˜¯è®¾è®¡æˆæ— çŠ¶æ€çš„ï¼Œè¿™ 16 æ¬¡è¯·æ±‚æ¯ä¸€æ¬¡éƒ½æœ‰ä¾èµ–å…³è”ï¼Œå…ˆè°ƒç”¨å“ªä¸€ä¸ªã€å…ˆè¿”å›å“ªä¸€ä¸ªï¼Œéƒ½ä¼šå¯¹ç»“æœäº§ç”Ÿå½±å“çš„è¯ï¼Œé‚£åè°ƒå·¥ä½œä¼šå¤šä¹ˆå¤æ‚ã€‚\nå¯æ˜¯ï¼ŒHTTP åè®®çš„æ— çŠ¶æ€ç‰¹æ€§åˆæœ‰æ‚–äºæˆ‘ä»¬æœ€å¸¸è§çš„ç½‘ç»œåº”ç”¨åœºæ™¯ï¼Œå…¸å‹å°±æ˜¯è®¤è¯æˆæƒï¼Œç³»ç»Ÿæ€»å¾—è¦è·çŸ¥ç”¨æˆ·èº«ä»½æ‰èƒ½æä¾›åˆé€‚çš„æœåŠ¡ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ› HTTP èƒ½æœ‰ä¸€ç§æ‰‹æ®µï¼Œè®©æœåŠ¡å™¨è‡³å°‘èƒ½å¤ŸåŒºåˆ†å‡ºå‘é€è¯·æ±‚çš„ç”¨æˆ·æ˜¯è°ã€‚ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„ï¼ŒRFC6265è§„èŒƒå®šä¹‰äº†HTTPçš„çŠ¶æ€ç®¡ç†æœºåˆ¶ï¼Œåœ¨ HTTP åè®®ä¸­å¢åŠ äº† Set-Cookie æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤çš„å«ä¹‰æ˜¯ä»¥é”®å€¼å¯¹çš„æ–¹å¼å‘å®¢æˆ·ç«¯å‘é€ä¸€ç»„ä¿¡æ¯ï¼Œæ­¤ä¿¡æ¯å°†åœ¨æ­¤åä¸€æ®µæ—¶é—´å†…çš„æ¯æ¬¡ HTTP è¯·æ±‚ä¸­ï¼Œä»¥åä¸º Cookie çš„ Header é™„å¸¦ç€é‡æ–°å‘ç»™æœåŠ¡ç«¯ï¼Œä»¥ä¾¿æœåŠ¡ç«¯åŒºåˆ†æ¥è‡ªä¸åŒå®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚ä¸€ä¸ªå…¸å‹çš„ Set-Cookie æŒ‡ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š\n\nSet-Cookie:idï¼icyfenixï¼›Expiresï¼Wedï¼Œ21 Feb 2020 07:28:00 GMTï¼›Secureï¼›Httponly\n\næ”¶åˆ°è¯¥æŒ‡ä»¤ä»¥åï¼Œå®¢æˆ·ç«¯å†å¯¹åŒä¸€ä¸ªåŸŸçš„è¯·æ±‚å›ä¼ æ—¶å°±ä¼šè‡ªåŠ¨é™„å¸¦é”®å€¼å¯¹ä¿¡æ¯ â€œidï¼icyfenixâ€ï¼Œè­¬å¦‚ä»¥ä¸‹ä»£ç æ‰€ç¤ºï¼š\n\nGET /index.html HTTP/2.0Host: icyfenix.cnCookie: idï¼icyfenix\n\næ ¹æ®æ¯æ¬¡è¯·æ±‚ä¼ åˆ°æœåŠ¡ç«¯çš„ Cookieï¼ŒæœåŠ¡ç«¯å°±èƒ½åˆ†è¾¨å‡ºè¯·æ±‚æ¥è‡ªäºå“ªä¸€ä¸ªç”¨æˆ·ã€‚ç”±äº Cookie æ˜¯æ”¾åœ¨è¯·æ±‚å¤´ä¸Šçš„ï¼Œå±äºé¢å¤–çš„ä¼ è¾“è´Ÿæ‹…ï¼Œä¸åº”è¯¥æºå¸¦è¿‡å¤šçš„å†…å®¹ï¼Œè€Œä¸”æ”¾åœ¨ Cookie ä¸­ä¼ è¾“å¹¶ä¸å®‰å…¨ï¼Œå®¹æ˜“è¢«ä¸­é—´äººçªƒå–æˆ–è¢«ç¯¡æ”¹ï¼Œæ‰€ä»¥é€šå¸¸ä¸ä¼šè®¾ç½®ä¾‹å­ä¸­ â€œidï¼icyfenixâ€ è¿™æ ·çš„æ˜æ–‡ä¿¡æ¯ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç³»ç»Ÿä¼šæŠŠçŠ¶æ€ä¿¡æ¯ä¿å­˜åœ¨æœåŠ¡ç«¯ï¼Œåœ¨ Cookie é‡Œåªä¼ è¾“ä¸€ä¸ªæ— å­—é¢æ„ä¹‰çš„ã€ä¸é‡å¤çš„å­—ç¬¦ä¸²ï¼Œä¹ æƒ¯ä¸Šä»¥ sessionid æˆ–è€… jsessionid ä¸ºåï¼Œç„¶åæœåŠ¡ç«¯ä¼šæŠŠè¿™ä¸ªå­—ç¬¦ä¸²ä½œä¸ºKeyï¼Œä»¥ Key/Entity çš„ç»“æ„å­˜å‚¨æ¯ä¸€ä¸ªåœ¨çº¿ç”¨æˆ·çš„ä¸Šä¸‹æ–‡çŠ¶æ€ï¼Œå†è¾…ä»¥ä¸€äº›è¶…æ—¶è‡ªåŠ¨æ¸…ç†ä¹‹ç±»çš„ç®¡ç†æªæ–½ã€‚è¿™ç§æœåŠ¡ç«¯çš„çŠ¶æ€ç®¡ç†æœºåˆ¶å°±æ˜¯ä»Šå¤©å¤§å®¶éå¸¸ç†Ÿæ‚‰çš„ Sessionï¼ŒCookie-Session ä¹Ÿå³æœ€ä¼ ç»Ÿä½†ä»Šå¤©ä¾ç„¶å¹¿æ³›åº”ç”¨äºå¤§é‡ç³»ç»Ÿä¸­çš„ï¼Œç”±æœåŠ¡ç«¯ä¸å®¢æˆ·ç«¯è”åŠ¨æ¥å®Œæˆçš„çŠ¶æ€ç®¡ç†æœºåˆ¶ã€‚\nCookie-Session æ–¹æ¡ˆåœ¨æœ¬ç« çš„ä¸»é¢˜ â€œå®‰å…¨æ€§â€ ä¸Šå…¶å®æ˜¯æœ‰ä¸€å®šå…ˆå¤©ä¼˜åŠ¿çš„ï¼šçŠ¶æ€ä¿¡æ¯éƒ½å­˜å‚¨äºæœåŠ¡ç«¯ï¼Œåªè¦ä¾é å®¢æˆ·ç«¯çš„åŒæºç­–ç•¥å’ŒHTTPS çš„ä¼ è¾“å±‚å®‰å…¨ï¼Œä¿è¯ Cookie ä¸­çš„é”®å€¼ä¸è¢«çªƒå–è€Œå‡ºç°è¢«å†’è®¤èº«ä»½çš„æƒ…å†µï¼Œå°±èƒ½å®Œå…¨è§„é¿æ‰ä¿¡æ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­è¢«æ³„æ¼å’Œç¯¡æ”¹çš„é£é™©ã€‚Cookie-Session æ–¹æ¡ˆçš„å¦ä¸€å¤§ä¼˜ç‚¹æ˜¯æœåŠ¡ç«¯æœ‰ä¸»åŠ¨çš„çŠ¶æ€ç®¡ç†èƒ½åŠ›ï¼Œå¯æ ¹æ®è‡ªå·±çš„æ„æ„¿éšæ—¶ä¿®æ”¹ã€æ¸…é™¤ä»»æ„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè‡‚å¦‚å¾ˆè½»æ˜“å°±èƒ½å®ç°å¼ºåˆ¶æŸç”¨æˆ·ä¸‹çº¿çš„åŠŸèƒ½ã€‚\nSession-Cookie åœ¨å•èŠ‚ç‚¹çš„å•ä½“æœåŠ¡ç¯å¢ƒä¸­æ˜¯æœ€åˆé€‚çš„æ–¹æ¡ˆï¼Œä½†å½“éœ€è¦æ°´å¹³æ‰©å±•æœåŠ¡èƒ½åŠ›ï¼Œè¦éƒ¨ç½²é›†ç¾¤æ—¶å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œç”±äº Session å­˜å‚¨åœ¨æœåŠ¡å™¨çš„å†…å­˜ä¸­ï¼Œå½“æœåŠ¡å™¨æ°´å¹³æ‹“å±•æˆå¤šèŠ‚ç‚¹æ—¶ï¼Œè®¾è®¡è€…å¿…é¡»åœ¨ä»¥ä¸‹ä¸‰ç§æ–¹æ¡ˆä¸­é€‰æ‹©å…¶ä¸€ã€‚\n\nç‰ºç‰²é›†ç¾¤çš„ä¸€è‡´æ€§ï¼Œè®©è´Ÿè½½å‡è¡¡å™¨é‡‡ç”¨äº²å’Œå¼çš„è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œè‡‚å¦‚æ ¹æ®ç”¨æˆ· IP æˆ–è€… Session æ¥åˆ†é…èŠ‚ç‚¹ï¼Œæ¯ä¸€ä¸ªç‰¹å®šç”¨æˆ·å‘å‡ºçš„æ‰€æœ‰è¯·æ±‚éƒ½ä¸€ç›´è¢«åˆ†é…åˆ°å…¶ä¸­æŸä¸ªèŠ‚ç‚¹æ¥æä¾›æœåŠ¡ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¸é‡å¤åœ°ä¿å­˜ç€ä¸€éƒ¨åˆ†ç”¨æˆ·çš„çŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªèŠ‚ç‚¹å´©æºƒäº†ï¼Œé‡Œé¢çš„ç”¨æˆ·çŠ¶æ€ä¾¿å®Œå…¨ä¸¢å¤±ã€‚\nç‰ºç‰²é›†ç¾¤çš„å¯ç”¨æ€§ï¼Œè®©å„ä¸ªèŠ‚ç‚¹ä¹‹é—´é‡‡ç”¨å¤åˆ¶å¼çš„ Sessionï¼Œæ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­çš„ Session å˜åŠ¨éƒ½ä¼šå‘é€åˆ°ç»„æ’­åœ°å€çš„å…¶ä»–æœåŠ¡å™¨ä¸Šï¼Œè¿™æ ·å³ä½¿æŸä¸ªèŠ‚ç‚¹å´©æºƒäº†ï¼Œä¹Ÿä¸ä¼šä¸­æ–­æŸä¸ªç”¨æˆ·çš„æœåŠ¡ï¼Œä½† Session ä¹‹é—´ç»„æ’­å¤åˆ¶çš„åŒæ­¥ä»£ä»·é«˜æ˜‚ï¼ŒèŠ‚ç‚¹è¶Šå¤šæ—¶ï¼ŒåŒæ­¥æˆæœ¬è¶Šé«˜ã€‚\nç‰ºç‰²é›†ç¾¤çš„åˆ†åŒºå®¹å¿æ€§ï¼Œè®©æ™®é€šçš„æœåŠ¡èŠ‚ç‚¹ä¸­ä¸å†ä¿ç•™çŠ¶æ€ï¼Œå°†ä¸Šä¸‹æ–‡é›†ä¸­æ”¾åœ¨ä¸ªæ‰€æœ‰æœåŠ¡èŠ‚ç‚¹éƒ½èƒ½è®¿é—®åˆ°çš„æ•°æ®èŠ‚ç‚¹ä¸­è¿›è¡Œå­˜å‚¨ã€‚æ­¤æ—¶çš„çŸ›ç›¾æ˜¯æ•°æ®èŠ‚ç‚¹æˆä¸ºå•ç‚¹ï¼Œä¸€æ—¦æ•°æ®èŠ‚ç‚¹æŸåæˆ–å‡ºç°ç½‘ç»œåˆ†åŒºï¼Œæ•´ä¸ªé›†ç¾¤å°†éƒ½ä¸èƒ½å†æä¾›æœåŠ¡ã€‚\n\né€šè¿‡å‰é¢ç« èŠ‚çš„å†…å®¹ï¼Œæˆ‘ä»¬å·²ç»çŸ¥é“åªè¦åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…±äº«ä¿¡æ¯ï¼ŒCAP å°±ä¸å¯å…¼å¾—æ‰€ä»¥åˆ†å¸ƒå¼ç¯å¢ƒä¸­çš„çŠ¶æ€ç®¡ç†ä¸€å®šä¼šå—åˆ° CAP çš„é™åˆ¶ï¼Œæ— è®ºæ€æ ·éƒ½ä¸å¯èƒ½å®Œç¾ã€‚ä½†å¦‚æœåªæ˜¯è§£å†³åˆ†å¸ƒå¼ä¸‹çš„è®¤è¯æˆæƒé—®é¢˜ï¼Œå¹¶é¡ºå¸¦è§£å†³å°‘é‡çŠ¶æ€çš„é—®é¢˜ï¼Œå°±ä¸ä¸€å®šåªèƒ½ä¾é å…±äº«ä¿¡æ¯å»å®ç°ã€‚è¿™å¥è¯çš„è¨€å¤–ä¹‹æ„æ˜¯æé†’è¯»è€…ï¼Œæ¥ä¸‹æ¥çš„ JWT ä»¤ç‰Œä¸ Cookie-Session å¹¶ä¸æ˜¯å®Œå…¨å¯¹ç­‰çš„è§£å†³æ–¹æ¡ˆï¼ŒJWT ä»¤ç‰Œåªç”¨æ¥å¤„ç†è®¤è¯æˆæƒé—®é¢˜ï¼Œå……å…¶é‡åªèƒ½æºå¸¦å°‘é‡éæ•æ„Ÿçš„ä¿¡æ¯ï¼Œæ˜¯ Cookie-Session åœ¨è®¤è¯æˆæƒé—®é¢˜ä¸Šçš„æ›¿ä»£å“ï¼Œè€Œä¸èƒ½è¯´ JWT è¦æ¯” Cookie-Session æ›´å…ˆè¿›ï¼Œæ›´ä¸å¯èƒ½è¯´ JWT å¯ä»¥å…¨é¢å–ä»£ Cookie-Session æœºåˆ¶ã€‚\n2. JWTCookie-Session æœºåˆ¶åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹ä¼šé‡åˆ° CAP ä¸å¯å…¼å¾—çš„é—®é¢˜ï¼Œè€Œåœ¨å¤šæ–¹ç³»ç»Ÿä¸­ï¼Œå°±æ›´ä¸å¯èƒ½è°ˆ Session å±‚é¢çš„æ•°æ®å…±äº«äº†ï¼Œå“ªæ€•æœåŠ¡ç«¯ä¹‹é—´èƒ½å…±äº«æ•°æ®ï¼Œå®¢æˆ·ç«¯çš„ Cookie ä¹Ÿæ²¡æ³•è·¨åŸŸã€‚æ‰€ä»¥æˆ‘ä»¬ä¸å¾—ä¸é‡æ–°æ¡èµ·æœ€åˆè¢«æŠ›å¼ƒçš„æ€è·¯ï¼Œå½“æœåŠ¡å™¨å­˜åœ¨å¤šä¸ªï¼Œå®¢æˆ·ç«¯åªæœ‰ä¸€ä¸ªæ—¶ï¼ŒæŠŠçŠ¶æ€ä¿¡æ¯å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œæ¯æ¬¡éšç€è¯·æ±‚å‘å›æœåŠ¡å™¨å»ã€‚å‰é¢è¯´è¿‡ï¼Œè¿™æ ·åšçš„ç¼ºç‚¹æ˜¯æ— æ³•æºå¸¦å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æœ‰æ³„æ¼å’Œç¯¡æ”¹çš„å®‰å…¨é£é™©ã€‚ä¿¡æ¯é‡å—é™çš„é—®é¢˜å¹¶æ²¡æœ‰å¤ªå¥½çš„è§£å†³åŠæ³•ï¼Œä¸è¿‡è¦ç¡®ä¿ä¿¡æ¯ä¸è¢«ä¸­é—´äººç¯¡æ”¹åˆ™è¿˜æ˜¯å¯ä»¥å®ç°çš„ï¼ŒJWT ä¾¿æ˜¯è¿™ä¸ªé—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆã€‚\nJWTï¼ˆJSON Web Tokenï¼‰å®šä¹‰äº RFC7519 æ ‡å‡†ä¹‹ä¸­ï¼Œæ˜¯ç›®å‰å¹¿æ³›ä½¿ç”¨çš„ä¸€ç§ä»¤ç‰Œæ ¼å¼å°¤å…¶ç»å¸¸ä¸ OAuth2 é…åˆåº”ç”¨äºåˆ†å¸ƒå¼çš„ã€æ¶‰åŠå¤šæ–¹çš„åº”ç”¨ç³»ç»Ÿä¸­ã€‚ä»‹ç»JWTçš„å…·ä½“æ„æˆä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥ç›´è§‚åœ°çœ‹ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\nä»¥ä¸Šæˆªå›¾æ¥è‡ª JWT å®˜ç½‘ï¼Œæ•°æ®åˆ™æ˜¯ç¬”è€…éšæ„ç¼–çš„ã€‚å³è¾¹çš„ JSON ç»“æ„æ˜¯ JWT ä»¤ç‰Œä¸­æºå¸¦çš„ä¿¡æ¯ï¼Œå·¦è¾¹çš„å­—ç¬¦ä¸²å‘ˆç°äº† JWT ä»¤ç‰Œçš„æœ¬ä½“ã€‚å®ƒæœ€å¸¸è§çš„ä½¿ç”¨æ–¹å¼æ˜¯é™„åœ¨åä¸º Authorization çš„ Header å‘é€ç»™æœåŠ¡ç«¯ï¼Œå‰ç¼€åœ¨ RFC6750 ä¸­è¢«è§„å®šä¸º Bearereã€‚å¦‚æœä½ æ²¡æœ‰å¿˜è®° â€œè®¤è¯æ–¹æ¡ˆâ€ ä¸ â€œOAuth2â€ çš„å†…å®¹ï¼Œé‚£çœ‹åˆ° Authorization è¿™ä¸ªHeader ä¸ Bearer è¿™ä¸ªå‰ç¼€æ—¶ï¼Œä¾¿åº”æ„è¯†åˆ°å®ƒæ˜¯ HTTP è®¤è¯æ¡†æ¶ä¸­çš„ OAuth2 è®¤è¯æ–¹æ¡ˆã€‚å¦‚ä¸‹ä»£ç å±•ç¤ºäº†ä¸€æ¬¡é‡‡ç”¨ JWT ä»¤ç‰Œçš„ HTTP å®é™…è¯·æ±‚ï¼š\n\nGET /restful/products/1 HTTP/1.1Host: 1cyfenix.cnConnection: keep-aliveAuthorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c\n\nä¸Šå›¾ä¸­å³è¾¹çš„çŠ¶æ€ä¿¡æ¯æ˜¯å¯¹ä»¤ç‰Œä½¿ç”¨ Bas64URL è½¬ç åå¾—åˆ°çš„æ˜æ–‡ï¼Œè¯·ç‰¹åˆ«æ³¨æ„æ˜¯æ˜æ–‡ï¼ŒJWT åªè§£å†³ç¯¡æ”¹çš„é—®é¢˜ï¼Œå¹¶ä¸è§£å†³æ³„æ¼çš„é—®é¢˜ï¼Œå› æ­¤ä»¤ç‰Œé»˜è®¤æ˜¯ä¸åŠ å¯†çš„ã€‚å°½ç®¡ä½ è‡ªå·±è¦åŠ å¯†ä¹Ÿä¸éš¾åšåˆ°ï¼Œæ¥æ”¶æ—¶è‡ªè¡Œè§£å¯†å³å¯ï¼Œä½†è¿™æ ·åšå…¶å®æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå…·ä½“åŸå› å°†åœ¨ç¬¬å››èŠ‚ä¸­é˜è¿°ã€‚\nä»æ˜æ–‡ä¸­å¯ä»¥çœ‹åˆ° JWT ä»¤ç‰Œæ˜¯ä»¥ JSON ç»“æ„ï¼ˆæ¯•ç«Ÿåå­—å°±å« JSON Web Tokenï¼‰å­˜å‚¨çš„ï¼Œè¯¥ç»“æ„æ€»ä½“ä¸Šå¯åˆ’åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†é—´ç”¨ç‚¹å· â€œ.â€ åˆ†éš”å¼€ã€‚ç¬¬ä¸€éƒ¨åˆ†æ˜¯ä»¤ç‰Œå¤´ï¼ˆHeaderï¼‰ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š\n&#123;  &quot;a1g&quot;: &quot;HS256&quot;,  &quot;typ&quot;: &quot;JWT&quot;&#125;\n\nå®ƒæè¿°äº†ä»¤ç‰Œçš„ç±»å‹ï¼ˆç»Ÿä¸€ä¸ºtyp:JWTï¼‰ä»¥åŠä»¤ç‰Œç­¾åçš„ç®—æ³•ï¼Œç¤ºä¾‹ä¸­ HS256 ä¸º HMAC SHA256ç®—æ³•çš„ç¼©å†™ï¼Œå…¶ä»–å„ç§ç³»ç»Ÿæ”¯æŒçš„ç­¾åç®—æ³•åˆ™å¯ä»¥å‚è€ƒJWTå®˜ç½‘ã€‚\n\næ•£åˆ—æ¶ˆæ¯è®¤è¯ç åœ¨æœ¬èŠ‚åŠåé¢å…¶ä»–å…³äºå®‰å…¨çš„å†…å®¹ä¸­ï¼Œç»å¸¸ä¼šåœ¨æŸç§å“ˆå¸Œç®—æ³•å‰å‡ºç° â€œHMACâ€ çš„å‰ç¼€ï¼Œè¿™æ˜¯æŒ‡æ•£åˆ—æ¶ˆæ¯è®¤è¯ç ï¼ˆHash-based Message Authentication Codeï¼ŒHMACï¼‰ã€‚å¯ä»¥ç®€å•å°†å®ƒç†è§£ä¸ºä¸€ç§å¸¦æœ‰å¯†é’¥çš„å“ˆå¸Œæ‘˜è¦ç®—æ³•ï¼Œå…¶å®ç°å½¢å¼ä¸Šé€šå¸¸æ˜¯æŠŠå¯†é’¥ä»¥åŠ ç›æ–¹å¼æ··å…¥ï¼Œä¸å†…å®¹ä¸€èµ·åšå“ˆå¸Œæ‘˜è¦ã€‚\nHMAC å“ˆå¸Œä¸æ™®é€šå“ˆå¸Œç®—æ³•çš„å·®åˆ«æ˜¯æ™®é€šçš„å“ˆå¸Œç®—æ³•é€šè¿‡ Hash å‡½æ•°ç»“æœæ˜“å˜æ€§ä¿è¯äº†åŸæœ‰å†…å®¹æœªè¢«ç¯¡æ”¹ï¼Œè€Œ HMAC ä¸ä»…ä¿è¯äº†å†…å®¹æœªè¢«ç¯¡æ”¹ï¼Œè¿˜ä¿è¯äº†è¯¥å“ˆå¸Œç¡®å®æ˜¯ç”±å¯†é’¥çš„æŒæœ‰äººæ‰€ç”Ÿæˆçš„ã€‚å¦‚å›¾æ‰€ç¤ºã€‚\n\n\nä»¤ç‰Œçš„ç¬¬äºŒéƒ¨åˆ†æ˜¯è´Ÿè½½ï¼ˆPayloadï¼‰ï¼Œè¿™æ˜¯ä»¤ç‰ŒçœŸæ­£éœ€è¦å‘æœåŠ¡ç«¯ä¼ é€’çš„ä¿¡æ¯ã€‚é’ˆå¯¹è®¤è¯é—®é¢˜ï¼Œè´Ÿè½½è‡³å°‘åº”è¯¥åŒ…å«èƒ½å¤Ÿå‘ŠçŸ¥æœåŠ¡ç«¯ â€œè¿™ä¸ªç”¨æˆ·æ˜¯è°â€ çš„ä¿¡æ¯ï¼›é’ˆå¯¹æˆæƒé—®é¢˜ï¼Œä»¤ç‰Œè‡³å°‘åº”è¯¥åŒ…å«èƒ½å¤Ÿå‘ŠçŸ¥æœåŠ¡ç«¯ â€œè¿™ä¸ªç”¨æˆ·æ‹¥æœ‰ä»€ä¹ˆè§’è‰² / æƒé™â€ çš„ä¿¡æ¯ã€‚JWT çš„è´Ÿè½½éƒ¨åˆ†æ˜¯å¯ä»¥å®Œå…¨è‡ªå®šä¹‰çš„ï¼Œæ ¹æ®å…·ä½“è¦è§£å†³çš„é—®é¢˜ä¸åŒï¼Œè®¾è®¡è‡ªå·±æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œåªæ˜¯æ€»å®¹é‡ä¸èƒ½å¤ªå¤§ï¼Œæ¯•ç«Ÿè¦å—åˆ° HTTP Header å¤§å°çš„é™åˆ¶ã€‚ä¸€ä¸ª JWT è´Ÿè½½çš„ä¾‹å­å¦‚ä¸‹æ‰€ç¤ºï¼š\n&#123;  &quot;username&quot;: &quot;icyfenix&quot;,  &quot;authorities&quot;: [  \t&quot;ROLE_USER&quot;,  \t&quot;ROLE_ADMIN&quot;  ],  &quot;scope&quot;: [  \t&quot;ALL&quot;  ],  &quot;exp&quot;: 1584948947,  &quot;jti&quot;: &quot;9d77586a-3f4f-4cbb-9924-fe2f77dfa33d&quot;,  &quot;client_id&quot;: &quot;bookstore frontend&quot;&#125;\n\nJWT åœ¨ RFC 7519 ä¸­æ¨èï¼ˆéå¼ºåˆ¶çº¦æŸï¼‰äº†ä¸ƒé¡¹å£°æ˜åç§°ï¼ˆClaim Nameï¼‰ï¼Œå¦‚éœ€è¦ç”¨åˆ°è¿™äº›å†…å®¹ï¼Œå»ºè®®å­—æ®µåä¸å®˜æ–¹çš„ä¿æŒä¸€è‡´ã€‚\n\nissï¼ˆIssuerï¼‰:ç­¾å‘äººã€‚\nexpï¼ˆExpiration Timeï¼‰:ä»¤ç‰Œè¿‡æœŸæ—¶é—´ã€‚\nsubï¼ˆSubjectï¼‰:ä¸»é¢˜ã€‚\naudï¼ˆAudienceï¼‰:ä»¤ç‰Œå—ä¼—ã€‚\nnbfï¼ˆNot Beforeï¼‰:ä»¤ç‰Œç”Ÿæ•ˆæ—¶é—´ã€‚\niatï¼ˆIssued Atï¼‰:ä»¤ç‰Œç­¾å‘æ—¶é—´ã€‚\njtiï¼ˆJWT IDï¼‰:ä»¤ç‰Œç¼–å·ã€‚\n\næ­¤å¤–åœ¨ RFC 8225ã€RFC 8417ã€RFC 8485 ç­‰è§„èŒƒæ–‡æ¡£ï¼Œä»¥åŠ OpenID ç­‰åè®®ä¸­ï¼Œéƒ½å®šä¹‰äº†çº¦å®šå¥½å…¬æœ‰å«ä¹‰çš„åç§°ï¼Œå†…å®¹æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸å†èµ˜è¿°ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒ â€œIANA  JSON Web Token Registryã€‚\nä»¤ç‰Œçš„ç¬¬ä¸‰éƒ¨åˆ†æ˜¯ç­¾åï¼ˆSignatureï¼‰ï¼Œç­¾åçš„æ„æ€æ˜¯ï¼šä½¿ç”¨åœ¨å¯¹è±¡å¤´ä¸­å…¬å¼€çš„ç‰¹å®šç­¾åç®—æ³•ï¼Œé€šè¿‡ç‰¹å®šçš„å¯†é’¥ï¼ˆç”±æœåŠ¡å™¨è¿›è¡Œä¿å¯†ï¼Œä¸èƒ½å…¬å¼€ï¼‰å¯¹å‰é¢ä¸¤éƒ¨åˆ†å†…å®¹è¿›è¡ŒåŠ å¯†è®¡ç®—ï¼Œä»¥ä¾‹å­é‡Œä½¿ç”¨çš„ JWT é»˜è®¤çš„ HMAC SHA256 ç®—æ³•ä¸ºä¾‹ï¼Œå°†é€šè¿‡ä»¥ä¸‹å…¬å¼äº§ç”Ÿç­¾åå€¼ï¼šHMACSHA256(base64Ur1Encode(header) + &quot;.&quot; + base64UrlEncode (payload), secret) ç­¾åçš„æ„ä¹‰åœ¨äºç¡®ä¿è´Ÿè½½ä¸­çš„ä¿¡æ¯æ˜¯å¯ä¿¡çš„ã€æ²¡æœ‰è¢«ç¯¡æ”¹çš„ï¼Œä¹Ÿæ²¡æœ‰åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±ä»»ä½•ä¿¡æ¯çš„ã€‚å› ä¸ºè¢«ç­¾åçš„å†…å®¹å“ªæ€•å‘ç”Ÿäº†ä¸€ä¸ªå­—èŠ‚çš„å˜åŠ¨ï¼Œä¹Ÿä¼šå¯¼è‡´æ•´ä¸ªç­¾åå‘ç”Ÿæ˜¾è‘—å˜åŒ–ã€‚æ­¤å¤–ï¼Œç”±äºç­¾åè¿™ä»¶äº‹æƒ…åªèƒ½ç”±è®¤è¯æˆæƒæœåŠ¡å™¨å®Œæˆï¼ˆåªæœ‰å®ƒçŸ¥é“å¯†é’¥ï¼‰ï¼Œä»»ä½•äººéƒ½æ— æ³•åœ¨ç¯¡æ”¹åé‡æ–°è®¡ç®—å‡ºåˆæ³•çš„ç­¾åå€¼ï¼Œæ‰€ä»¥æœåŠ¡ç«¯æ‰èƒ½å¤Ÿå®Œå…¨ä¿¡ä»»å®¢æˆ·ç«¯ä¼ ä¸Šæ¥çš„ JWT ä¸­çš„è´Ÿè½½ä¿¡æ¯ã€‚\nJWT é»˜è®¤çš„ç­¾åç®—æ³• HMAC SHA256 æ˜¯ä¸€ç§å¸¦å¯†é’¥çš„å“ˆå¸Œæ‘˜è¦ç®—æ³•ï¼ŒåŠ å¯†ä¸éªŒè¯è¿‡ç¨‹å‡åªèƒ½ç”±ä¸­å¿ƒåŒ–çš„æˆæƒæœåŠ¡æ¥æä¾›ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼ä¸€èˆ¬åªé€‚åˆäºæˆæƒæœåŠ¡ä¸åº”ç”¨æœåŠ¡å¤„äºåŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å•ä½“åº”ç”¨ã€‚åœ¨å¤šæ–¹ç³»ç»Ÿæˆ–è€…æˆæƒæœåŠ¡ä¸èµ„æºæœåŠ¡åˆ†ç¦»çš„åˆ†å¸ƒå¼åº”ç”¨ä¸­ï¼Œé€šå¸¸ä¼šé‡‡ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•æ¥è¿›è¡Œç­¾åï¼Œè¿™æ—¶å€™é™¤äº†æˆæƒæœåŠ¡ç«¯æŒæœ‰çš„å¯ä»¥ç”¨äºç­¾åçš„ç§é’¥è§£å†³ï¼Œè€Œä¸åœ¨æœåŠ¡å±‚æ¬¡ï¼ˆè­¬å¦‚åœ¨ä»¤ç‰Œæˆ–æ¥å£å…¶ä»–å‚æ•°ä¸Šå¢åŠ é¢å¤–é€»è¾‘ï¼‰ä¸Šè§£å†³ã€‚\n\nåªèƒ½æºå¸¦ç›¸å½“æœ‰é™çš„æ•°æ®ï¼šHTTP åè®®å¹¶æ²¡æœ‰å¼ºåˆ¶çº¦æŸ Header çš„æœ€å¤§é•¿åº¦ï¼Œä½†æ˜¯ï¼Œå„ç§æœåŠ¡å™¨ã€æµè§ˆå™¨éƒ½ä¼šæœ‰è‡ªå·±çš„çº¦æŸï¼Œè­¬å¦‚Tomcat å°±è¦æ±‚ Header æœ€å¤§ä¸è¶…è¿‡ 8 KBï¼Œè€Œåœ¨ Nginx ä¸­åˆ™é»˜è®¤ä¸º 4 KBï¼Œå› æ­¤åœ¨ä»¤ç‰Œä¸­å­˜å‚¨è¿‡å¤šçš„æ•°æ®ä¸ä»…è€—è´¹ä¼ è¾“å¸¦å®½ï¼Œè¿˜æœ‰é¢å¤–çš„å‡ºé”™é£é™©ã€‚\nå¿…é¡»è€ƒè™‘ä»¤ç‰Œåœ¨å®¢æˆ·ç«¯å¦‚ä½•å­˜å‚¨ï¼šä¸¥è°¨åœ°è¯´ï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯ JWT çš„é—®é¢˜è€Œæ˜¯ç³»ç»Ÿè®¾è®¡çš„é—®é¢˜ã€‚å¦‚æœæˆæƒä¹‹åï¼Œæ“ä½œå®Œå…³æ‰æµè§ˆå™¨å°±ç»“æŸäº†ï¼Œé‚£æŠŠä»¤ç‰Œæ”¾åˆ°å†…å­˜é‡Œé¢ï¼Œå‹æ ¹ä¸è€ƒè™‘æŒä¹…åŒ–é‚£æ˜¯æœ€ç†æƒ³çš„æ–¹æ¡ˆã€‚ä½†å¹¶ä¸æ˜¯è°éƒ½èƒ½å¿å—ä¸€ä¸ªç½‘ç«™å…³é—­ä¹‹åä¸‹æ¬¡å°±ä¸€å®šå¼ºåˆ¶è¦é‡æ–°ç™»å½•çš„ã€‚è¿™æ ·çš„è¯ï¼Œæƒ³æƒ³å®¢æˆ·ç«¯è¯¥æŠŠä»¤ç‰Œå­˜æ”¾åˆ°å“ªé‡Œï¼ŸCookieï¼ŸlocalStorageï¼ŸIndexed DBï¼Ÿå®ƒä»¬éƒ½æœ‰æ³„æ¼çš„å¯èƒ½ï¼Œè€Œä»¤ç‰Œä¸€æ—¦æ³„æ¼ï¼Œåˆ«äººå°±å¯ä»¥å†’å……ç”¨æˆ·çš„èº«ä»½åšä»»ä½•äº‹æƒ…ã€‚\næ— çŠ¶æ€ä¹Ÿä¸æ€»æ˜¯å¥½çš„ï¼šè¿™ä¸ªå…¶å®ä¹Ÿä¸æ˜¯ JWT çš„é—®é¢˜ã€‚å¦‚æœä¸èƒ½æƒ³è±¡æ— çŠ¶æ€ä¼šæœ‰ä»€ä¹ˆä¸å¥½çš„è¯ï¼Œç¬”è€…å¯ä»¥æä¸ªéœ€æ±‚ï¼šè¯·åŸºäºæ— çŠ¶æ€ JWTçš„æ–¹æ¡ˆï¼Œåšä¸€ä¸ªåœ¨çº¿ç”¨æˆ·å®æ—¶ç»Ÿè®¡åŠŸèƒ½ã€‚\n\nå››ã€ä¿å¯†ä¿å¯†æ˜¯åŠ å¯†å’Œè§£å¯†çš„ç»Ÿç§°ï¼Œæ˜¯æŒ‡ä»¥æŸç§ç‰¹æ®Šçš„ç®—æ³•æ”¹å˜åŸæœ‰çš„ä¿¡æ¯æ•°æ®ï¼Œä½¿å¾—æœªæˆæƒçš„ç”¨æˆ·å³ä½¿è·å¾—äº†å·²åŠ å¯†çš„ä¿¡æ¯ï¼Œä½†å› ä¸çŸ¥è§£å¯†çš„æ–¹æ³•ï¼Œæˆ–è€…çŸ¥æ™“è§£å¯†çš„ç®—æ³•ä½†ç¼ºå°‘è§£å¯†æ‰€éœ€çš„å¿…è¦ä¿¡æ¯ï¼Œä»ç„¶æ— æ³•äº†è§£æ•°æ®çš„çœŸå®å†…å®¹ã€‚\næŒ‰ç…§éœ€è¦ä¿å¯†çš„ä¿¡æ¯æ‰€å¤„çš„ç¯èŠ‚ä¸åŒï¼Œå¯ä»¥åˆ’åˆ†ä¸º â€œä¿¡æ¯åœ¨å®¢æˆ·ç«¯æ—¶çš„ä¿å¯†â€ã€â€œä¿¡æ¯åœ¨ä¼ è¾“æ—¶çš„ä¿å¯†â€ å’Œ â€œä¿¡æ¯åœ¨æœåŠ¡ç«¯æ—¶çš„ä¿å¯†â€ ä¸‰ç±»ï¼Œæˆ–è€…è¿›ä¸€æ­¥æ¦‚æ‹¬ä¸º â€œç«¯çš„ä¿å¯†â€ å’Œ â€œé“¾è·¯çš„ä¿å¯†â€ ä¸¤ç±»ã€‚æˆ‘ä»¬æŠŠæœ€å¤æ‚ã€æœ€æœ‰æ•ˆï¼Œåˆæ—©æœ‰æ ‡å‡†è§£å†³æ–¹æ¡ˆçš„ â€œä¼ è¾“ç¯èŠ‚â€ å•ç‹¬æå–å‡ºæ¥ï¼Œæ”¾åˆ°ä¸‹ä¸€èŠ‚å»è®¨è®ºï¼Œæœ¬èŠ‚å°†ç»“åˆç¬”è€…çš„ä¸€äº›ä¸ªäººè§‚ç‚¹ï¼Œé‡ç‚¹è®¨è®ºå¯†ç ç­‰æ•æ„Ÿä¿¡æ¯å¦‚ä½•ä¿éšœå®‰å…¨ç­‰çº§ã€æ˜¯å¦åº”è¯¥ä»å®¢æˆ·ç«¯å¼€å§‹åŠ å¯†ã€åº”è¯¥å¦‚ä½•å­˜å‚¨åŠå¦‚ä½•éªŒè¯ç­‰å¸¸è§çš„å®‰å…¨ä¿å¯†é—®é¢˜ã€‚\n1. ä¿å¯†çš„å¼ºåº¦ä¿å¯†æ˜¯æœ‰æˆæœ¬çš„ï¼Œè¿½æ±‚è¶Šé«˜çš„å®‰å…¨ç­‰çº§ï¼Œå°±è¦ä»˜å‡ºè¶Šå¤šçš„å·¥ä½œé‡ä¸ç®—åŠ›æ¶ˆè€—ã€‚ç¬”è€…ä»¥ç”¨æˆ·ç™»å½•ä¸ºä¾‹ï¼Œåˆ—ä¸¾å‡ ç§ä¸åŒå¼ºåº¦çš„ä¿å¯†æ‰‹æ®µï¼Œå¹¶è®¨è®ºå®ƒä»¬çš„é˜²å¾¡å…³æ³¨ç‚¹ä¸å¼±ç‚¹ã€‚\n\nä»¥æ‘˜è¦ä»£æ›¿æ˜æ–‡ï¼šå¦‚æœå¯†ç æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œé‚£ä¸€æ¬¡ç®€å•çš„å“ˆå¸Œæ‘˜è¦è‡³å°‘å¯ä»¥ä¿è¯å³ä½¿ä¼ è¾“è¿‡ç¨‹ä¸­æœ‰ä¿¡æ¯æ³„æ¼ï¼Œä¹Ÿä¸ä¼šè¢«é€†æ¨å‡ºåŸä¿¡æ¯ï¼›å³ä½¿å¯†ç åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­æ³„æ¼äº†ï¼Œä¹Ÿä¸è‡³äºå¨èƒåˆ°å…¶ä»–ç³»ç»Ÿçš„ä½¿ç”¨ã€‚ä½†è¿™ç§å¤„ç†ä¸èƒ½é˜²æ­¢å¼±å¯†ç è¢«å½©è™¹è¡¨æ”»å‡»æ‰€ç ´è§£ã€‚\nå…ˆåŠ ç›å€¼å†åšå“ˆå¸Œæ˜¯åº”å¯¹å¼±å¯†ç çš„å¸¸ç”¨æ–¹æ³•ï¼šç›å€¼å¯ä»¥ä¸ºå¼±å¯†ç å»ºç«‹ä¸€é“é˜²å¾¡å±éšœï¼Œä¸€å®šç¨‹åº¦ä¸Šé˜²å¾¡å·²æœ‰çš„å½©è™¹è¡¨æ”»å‡»ï¼Œä½†ä¸èƒ½é˜»æ­¢åŠ å¯†ç»“æœè¢«ç›‘å¬ã€çªƒå–åï¼Œæ”»å‡»è€…ç›´æ¥å‘é€åŠ å¯†ç»“æœç»™æœåŠ¡ç«¯è¿›è¡Œå†’è®¤ã€‚\nå°†ç›å€¼å˜ä¸ºåŠ¨æ€å€¼èƒ½æœ‰æ•ˆé˜²æ­¢å†’è®¤ï¼šå¦‚æœæ¯æ¬¡å¯†ç å‘æœåŠ¡ç«¯ä¼ è¾“æ—¶éƒ½æºå…¥äº†åŠ¨æ€çš„ç›å€¼ï¼Œè®©æ¯æ¬¡åŠ å¯†çš„ç»“æœéƒ½ä¸åŒï¼Œé‚£å³ä½¿ä¼ è¾“ç»™æœåŠ¡ç«¯çš„åŠ å¯†ç»“æœè¢«çªƒå–äº†ï¼Œä¹Ÿä¸èƒ½å†’ç”¨æ¥è¿›è¡Œå¦ä¸€æ¬¡è°ƒç”¨ã€‚å°½ç®¡åœ¨åŒæ–¹é€šä¿¡å‡å¯èƒ½æ³„æ¼çš„å‰æä¸‹åå•†å‡ºåªæœ‰é€šä¿¡åŒæ–¹æ‰çŸ¥é“çš„ä¿å¯†ä¿¡æ¯æ˜¯å®Œå…¨å¯è¡Œçš„ï¼ˆåç»­ç¬¬äº”èŠ‚ä¼šæåˆ°ï¼‰ï¼Œä½†è¿™æ ·åå•†å‡ºç›å€¼çš„è¿‡ç¨‹å°†å˜å¾—æä¸ºå¤æ‚ï¼Œè€Œä¸”æ¯æ¬¡åå•†åªä¿æŠ¤ä¸€æ¬¡æ“ä½œï¼Œä¹Ÿéš¾ä»¥é˜»æ­¢å¯¹å…¶ä»–æœåŠ¡çš„é‡æ”¾æ”»å‡»ã€‚\nç»™æœåŠ¡åŠ å…¥åŠ¨æ€ä»¤ç‰Œï¼Œåœ¨ç½‘å…³æˆ–å…¶ä»–æµé‡å…¬å…±ä½ç½®å»ºç«‹æ ¡éªŒé€»è¾‘ï¼Œè¿™æ ·æœåŠ¡ç«¯åœ¨æ„¿æ„ä»˜å‡ºé›†ç¾¤ä¸­åˆ†å‘ä»¤ç‰Œä¿¡æ¯ç­‰ä»£ä»·çš„å‰æä¸‹ï¼Œå¯ä»¥åšåˆ°é˜²æ­¢é‡æ”¾æ”»å‡»ï¼Œä½†æ˜¯ä¾ç„¶ä¸èƒ½è§£å†³ä¼ è¾“è¿‡ç¨‹ä¸­è¢«å—…æ¢è€Œæ³„æ¼ä¿¡æ¯çš„é—®é¢˜ã€‚\nå¯ç”¨ HTTPS å¯ä»¥é˜²å¾¡é“¾è·¯ä¸Šçš„æ¶æ„å—…æ¢ï¼Œä¹Ÿä»¥åœ¨é€šä¿¡å±‚é¢è§£å†³äº†é‡æ”¾æ”»å‡»çš„é—®é¢˜ã€‚ä½†æ˜¯ä¾ç„¶æœ‰å› å®¢æˆ·ç«¯è¢«æ”»ç ´äº§ç”Ÿä¼ªé€ æ ¹è¯ä¹¦çš„é£é™©ã€å› æœåŠ¡ç«¯è¢«æ”»ç ´äº§ç”Ÿçš„è¯ä¹¦æ³„æ¼è€Œè¢«ä¸­é—´äººå†’è®¤çš„é£é™©ã€å› CRLæ›´æ–°ä¸åŠæ—¶æˆ–è€… OCSP Soft-fail äº§ç”ŸåŠé”€è¯ä¹¦è¢«å†’ç”¨çš„é£é™©ï¼Œä»¥åŠå› TLS çš„ç‰ˆæœ¬è¿‡ä½æˆ–å¯†ç å­¦å¥—ä»¶é€‰ç”¨ä¸å½“äº§ç”ŸåŠ å¯†å¼ºåº¦ä¸è¶³çš„é£é™©ã€‚\nä¸ºäº†æŠµå¾¡ä¸Šè¿°é£é™©ï¼Œä¿å¯†å¼ºåº¦è¿˜è¦è¿›ä¸€æ­¥æå‡ï¼Œè­¬å¦‚é“¶è¡Œä¼šä½¿ç”¨ç‹¬ç«‹äºå®¢æˆ·ç«¯çš„å­˜å‚¨è¯ä¹¦çš„ç‰©ç†è®¾å¤‡ï¼ˆä¿—ç§°çš„Uç›¾ï¼‰æ¥é¿å…æ ¹è¯ä¹¦è¢«å®¢æˆ·ç«¯ä¸­çš„æ¶æ„ç¨‹åºçªƒå–ä¼ªé€ ï¼›å¤§å‹ç½‘ç«™æ¶‰åŠè´¦å·ã€é‡‘é’±ç­‰æ“ä½œæ—¶ï¼Œä¼šä½¿ç”¨åŒé‡éªŒè¯å¼€è¾Ÿä¸€æ¡ç‹¬ç«‹äºç½‘ç»œçš„ä¿¡æ¯é€šé“ï¼ˆå¦‚æ‰‹æœºéªŒè¯ç ã€ç”µå­é‚®ä»¶ï¼‰æ¥æ˜¾è‘—æé«˜å†’è®¤çš„éš¾åº¦ï¼›ç”šè‡³ä¸€äº›å…³é”®ä¼ä¸šï¼ˆå¦‚å›½å®¶ç”µç½‘ï¼‰æˆ–æœºæ„ï¼ˆå¦‚å†›äº‹æœºæ„ï¼‰ä¼šä¸“é—¨å»ºè®¾éå¸ƒå…¨å›½å„åœ°çš„ä¸å…¬ç½‘ç‰©ç†éš”ç¦»çš„ä¸“ç”¨å†…éƒ¨ç½‘ç»œæ¥ä¿éšœé€šä¿¡å®‰å…¨ã€‚\n\nå¬äº†ä¸Šè¿°è¿™äº›é€æ­¥å‡çº§çš„ä¿å¯†æªæ–½ï¼Œä½ åº”è¯¥èƒ½å¯¹â€œæ›´é«˜å®‰å…¨å¼ºåº¦åŒæ—¶ä¹Ÿæ„å‘³ç€æ›´å¤šä»£ä»·â€æœ‰æ›´å…·ä½“çš„ç†è§£ï¼Œä¸æ˜¯ä»»ä½•ä¸€ä¸ªç½‘ç«™ã€ç³»ç»Ÿã€æœåŠ¡éƒ½éœ€è¦æ— é™æ‹”é«˜çš„å®‰å…¨æ€§ã€‚ä¹Ÿè®¸è¿™æ—¶å€™ä½ ä¼šå¥½å¥‡å¦ä¸€ä¸ªé—®é¢˜ï¼šå®‰å…¨çš„å¼ºåº¦æœ‰å°½å¤´å—ï¼Ÿå­˜ä¸å­˜åœ¨æŸç§ç»å¯¹å®‰å…¨çš„ä¿å¯†æ–¹å¼ï¼Ÿç­”æ¡ˆå¯èƒ½å‡ºä¹å¤šæ•°äººçš„æ„æ–™ï¼Œç¡®å®æ˜¯æœ‰çš„ã€‚ä¿¡æ¯è®ºä¹‹çˆ¶é¦™å†œä¸¥æ ¼è¯æ˜äº†ä¸€æ¬¡æ€§å¯†ç ï¼ˆOne TimePasswordï¼‰çš„ç»å¯¹å®‰å…¨æ€§ã€‚ä½†æ˜¯ä½¿ç”¨ä¸€æ¬¡æ€§å¯†ç å¿…é¡»æœ‰ä¸ªå‰æï¼Œå°±æ˜¯å·²ç»æå‰å®‰å…¨åœ°æŠŠå¯†ç æˆ–å¯†ç åˆ—è¡¨ä¼ è¾¾ç»™å¯¹æ–¹ã€‚è­¬å¦‚ï¼Œç»™ä½ çš„æœ‹å‹é€å»ä¸€æœ¬å­˜å‚¨äº†å®Œå…¨éšæœºå¯†ç çš„å¯†ç æœ¬ï¼Œç„¶åæ¯æ¬¡ä½¿ç”¨å…¶ä¸­ä¸€æ¡å¯†ç æ¥è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œç”¨å®Œä¸€æ¡ä¸¢å¼ƒä¸€æ¡ï¼Œç†è®ºä¸Šè¿™æ ·å¯ä»¥åšåˆ°ç»å¯¹çš„å®‰å…¨ï¼Œä½†æ˜¾ç„¶è¿™ç§ç»å¯¹å®‰å…¨å¯¹äºäº’è”ç½‘æ²¡æœ‰ä»»ä½•çš„å¯è¡Œæ€§ã€‚\n2. å®¢æˆ·ç«¯åŠ å¯†å…³äºå®¢æˆ·ç«¯åœ¨ç”¨æˆ·ç™»å½•ã€æ³¨å†Œç±»åœºæ™¯é‡Œæ˜¯å¦éœ€è¦å¯¹å¯†ç è¿›è¡ŒåŠ å¯†çš„é—®é¢˜ä¸€ç›´å­˜æœ‰äº‰è®®ã€‚ç¬”è€…çš„è§‚ç‚¹å¾ˆæ˜ç¡®ï¼šä¸ºäº†ä¿è¯ä¿¡æ¯ä¸è¢«é»‘å®¢çªƒå–è€Œåšå®¢æˆ·ç«¯åŠ å¯†æ²¡æœ‰å¤ªå¤§æ„ä¹‰ï¼Œå¯¹ç»å¤§å¤šæ•°çš„ä¿¡æ¯ç³»ç»Ÿæ¥è¯´ï¼Œå¯ç”¨ HTTPS å¯ä»¥è¯´æ˜¯å”¯ä¸€çš„å®é™…å¯è¡Œçš„æ–¹æ¡ˆã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä¿è¯å¯†ç ä¸åœ¨æœåŠ¡ç«¯è¢«æ»¥ç”¨ï¼Œåœ¨å®¢æˆ·ç«¯å°±å¼€å§‹åŠ å¯†è¿˜æ˜¯å¾ˆæœ‰æ„ä¹‰çš„ã€‚å¤§ç½‘ç«™è¢«æ‹–åº“çš„äº‹æƒ…å±‚å‡ºä¸ç©·ï¼Œå¯†ç æ˜æ–‡è¢«å†™å…¥æ•°æ®åº“ã€è¢«è¾“å‡ºåˆ°æ—¥å¿—ä¸­ä¹‹ç±»çš„äº‹æƒ…ä¹Ÿå±¡è§ä¸é²œï¼Œåšç³»ç»Ÿè®¾è®¡æ—¶å°±åº”è¯¥æŠŠæ˜æ–‡å¯†ç è¿™ç§ä¸œè¥¿å½“æˆæ˜¯æœ€çƒ«æ‰‹çš„å±±èŠ‹æ¥çœ‹å¾…ï¼Œè¶Šæ—©æ¶ˆç­æ‰è¶Šå¥½ï¼Œå°†ä¸€ä¸ªæ½œåœ¨çš„ç‚¸å¼¹ä»å®¢æˆ·ç«¯è¿åˆ°æœåŠ¡ç«¯ï¼Œå¯¹ç»å¤§å¤šæ•°ç³»ç»Ÿæ¥è¯´éƒ½æ²¡æœ‰å¿…è¦ã€‚\nä¸ºä»€ä¹ˆå®¢æˆ·ç«¯åŠ å¯†å¯¹é˜²å¾¡æ³„å¯†æ²¡æœ‰æ„ä¹‰ï¼ŸåŸå› æ˜¯ç½‘ç»œé€šä¿¡å¹¶éç”±å‘é€æ–¹å’Œæ¥æ”¶æ–¹ç‚¹å¯¹ç‚¹è¿›è¡Œçš„ï¼Œå®¢æˆ·ç«¯æ— æ³•å†³å®šç”¨æˆ·é€å‡ºçš„ä¿¡æ¯èƒ½ä¸èƒ½åˆ°è¾¾æœåŠ¡ç«¯ï¼Œæˆ–è€…ä¼šç»è¿‡æ€æ ·çš„è·¯å¾„åˆ°è¾¾æœåŠ¡ç«¯ï¼Œåœ¨ä¼ è¾“é“¾è·¯å¿…å®šæ˜¯ä¸å®‰å…¨çš„å‡è®¾å‰æä¸‹ï¼Œæ— è®ºå®¢æˆ·ç«¯åšä»€ä¹ˆé˜²å¾¡æªæ–½ï¼Œæœ€ç»ˆéƒ½ä¼šæ²¦ä¸º â€œé©¬å…¶è¯ºé˜²çº¿â€ã€‚ä¹‹å‰ç¬”è€…å·²ç»æåˆ°å¤šæ¬¡çš„ä¸­é—´äººæ”»å‡»ï¼Œæ˜¯é€šè¿‡åŠ«æŒå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ä¹‹é—´çš„æŸä¸ªèŠ‚ç‚¹ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºä»£ç†ï¼ˆé€šè¿‡HTTPä»£ç†è¿”å›èµå“ï¼‰ã€è·¯ç”±å™¨ï¼ˆé€šè¿‡è·¯ç”±å¯¼å‘èµå“ï¼‰ã€DNS æœåŠ¡ï¼ˆç›´æ¥å°†ä½ æœºå™¨çš„ DNS æŸ¥è¯¢ç»“æœæ›¿æ¢ä¸ºèµå“åœ°å€ï¼‰ç­‰ï¼Œæ¥ç»™ä½ è®¿é—®çš„é¡µé¢æˆ–æœåŠ¡æ³¨å…¥æ¶æ„çš„ä»£ç ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œç”šè‡³å¯èƒ½ä¼šå–ä»£ä½ è¦è®¿é—®çš„æ•´ä¸ªæœåŠ¡æˆ–é¡µé¢ï¼Œæ­¤æ—¶ä¸è®ºä½ åœ¨é¡µé¢ä¸Šè®¾è®¡äº†å¤šä¹ˆç²¾å·§ä¸¥å¯†çš„åŠ å¯†æªæ–½ï¼Œéƒ½ä¸ä¼šèµ·åˆ°ä»»ä½•ä¿æŠ¤ä½œç”¨ï¼Œè€Œæ”»å‡»è€…åªéœ€åŠ«æŒè·¯ç”±å™¨ï¼Œæˆ–åœ¨å±€åŸŸç½‘å†…å…¶ä»–æœºå™¨é‡Šæ”¾ARPç—…æ¯’ä¾¿æœ‰å¯èƒ½å®Œæˆæ”»å‡»ã€‚\n\nä¸­é—´äººæ”»å‡»ï¼ˆMan-in-the-Middle Attackï¼ŒMitMï¼‰åœ¨æ¶ˆæ¯å‘å‡ºæ–¹å’Œæ¥æ”¶æ–¹ä¹‹é—´æ‹¦æˆªåŒæ–¹é€šä¿¡ã€‚ä»¥æ—¥å¸¸ç”Ÿæ´»ä¸­çš„å†™ä¿¡ä¸ºä¾‹ï¼šä½ ç»™æœ‹å‹å†™äº†ä¸€å°ä¿¡ï¼Œé‚®é€’å‘˜å¯ä»¥æŠŠæ¯ä¸€ä»½ä½ å¯„å‡ºå»çš„ä¿¡éƒ½æ‹†å¼€çœ‹ï¼Œç”šè‡³æŠŠä¿¡çš„å†…å®¹æ”¹æ‰ï¼Œç„¶åé‡æ–°å°èµ·æ¥ï¼Œå†å¯„å‡ºå»ç»™ä½ çš„æœ‹å‹ã€‚æœ‹å‹æ”¶åˆ°ä¿¡ä¹‹åç»™ä½ å›ä¿¡ï¼Œé‚®é€’å‘˜åˆå¯ä»¥æ‹†å¼€çœ‹ï¼Œçœ‹å®Œéšä¾¿æ”¹ï¼Œæ”¹å®Œå°å¥½å†é€åˆ°ä½ æ‰‹ä¸Šã€‚ä½ å…¨ç¨‹éƒ½ä¸çŸ¥é“è‡ªå·±å¯„å‡ºå»çš„ä¿¡å’Œæ”¶åˆ°çš„ä¿¡éƒ½ç»è¿‡é‚®é€’å‘˜è¿™ä¸ª â€œä¸­é—´äººâ€ è½¬æ‰‹å’Œå¤„ç†â€”â€”æ¢å¥è¯è¯´ï¼Œå¯¹äºä½ å’Œä½ æœ‹å‹æ¥è®²ï¼Œé‚®é€’å‘˜è¿™ä¸ªâ€œä¸­é—´äººâ€è§’è‰²æ˜¯ä¸å¯è§çš„ã€‚\n\nå¯¹äº â€œä¸åº”æŠŠæ˜æ–‡ä¼ é€’åˆ°æœåŠ¡ç«¯â€ çš„è§‚ç‚¹ï¼Œä¹Ÿæ˜¯æœ‰ä¸€äº›ä¸åŒæ„è§çš„ã€‚è­¬å¦‚å…¶ä¸­ä¸€ç§ä¿å­˜æ˜æ–‡å¯†ç çš„ç†ç”±æ˜¯ä¾¿äºå®¢æˆ·ç«¯åšåŠ¨æ€åŠ ç›ï¼Œå› ä¸ºåªæœ‰åœ¨æœåŠ¡ç«¯å­˜å‚¨äº†æ˜æ–‡ï¼Œæˆ–è€…æŸç§ç›å€¼/å¯†é’¥æ˜¯å›ºå®šçš„åŠ å¯†ç»“æœçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½æ¯æ¬¡ç”¨æ–°çš„ç›å€¼é‡æ–°åŠ å¯†æ¥ä¸å®¢æˆ·ç«¯ä¼ ä¸Šæ¥çš„åŠ å¯†ç»“æœè¿›è¡Œæ¯”å¯¹ã€‚ç¬”è€…çš„å»ºè®®æ˜¯æ¯æ¬¡ä»æœåŠ¡ç«¯è¯·æ±‚åŠ¨æ€ç›å€¼ï¼Œåœ¨å®¢æˆ·ç«¯åŠ ç›ä¼ è¾“çš„åšæ³•é€šå¸¸éƒ½å¾—ä¸å¿å¤±ï¼Œå› ä¸ºå®¢æˆ·ç«¯æ— è®ºæ˜¯å¦åŠ¨æ€åŠ ç›ï¼Œéƒ½ä¸å¯èƒ½ä»£æ›¿ HTTPSã€‚çœŸæ­£é˜²å¾¡æ€§çš„å¯†ç åŠ å¯†å­˜å‚¨ç¡®å®åº”è¯¥åœ¨æœåŠ¡ç«¯ä¸­è¿›è¡Œï¼Œä½†è¿™æ˜¯ä¸ºäº†é™ä½æœåŠ¡ç«¯è¢«æ”»ç ´è€Œæ‰¹é‡æ³„æ¼å¯†ç çš„é£é™©ï¼Œå¹¶ä¸æ˜¯ä¸ºäº†å¢åŠ ä¼ è¾“è¿‡ç¨‹çš„å®‰å…¨ã€‚\n3. å¯†ç å­˜å‚¨å’ŒéªŒè¯è¿™èŠ‚ç¬”è€…ä»¥ Fenixï¼‡s Bookstore ä¸­çš„çœŸå®ä»£ç ä¸ºä¾‹ï¼Œä»‹ç»ä¸€ä¸ªæ™®é€šå®‰å…¨å¼ºåº¦çš„ä¿¡æ¯ç³»ç»Ÿæ˜¯å¦‚ä½•å°†å¯†ç ä»å®¢æˆ·ç«¯ä¼ è¾“åˆ°æœåŠ¡ç«¯ï¼Œç„¶åå­˜å‚¨åˆ°æ•°æ®åº“çš„å…¨è¿‡ç¨‹ã€‚â€œæ™®é€šå®‰å…¨å¼ºåº¦â€ æ˜¯æŒ‡åœ¨å…·æœ‰ä¸€å®šä¿å¯†å®‰å…¨æ€§çš„åŸºç¡€ä¸Šï¼Œå°½é‡é¿å…æ¶ˆè€—è¿‡å¤šçš„è¿ç®—èµ„æºï¼Œè¿™æ ·åç»­éªŒè¯èµ·æ¥ä¹Ÿç›¸å¯¹ä¾¿æ·ã€‚å¯¹å¤šæ•°ä¿¡æ¯ç³»ç»Ÿæ¥è¯´ï¼Œåªè¦é…åˆä¸€å®šçš„å¯†ç è§„åˆ™çº¦æŸï¼Œè‡‚å¦‚å¯†ç è¦æ±‚é•¿åº¦ã€ç‰¹æ®Šå­—ç¬¦ç­‰ï¼Œå†é…åˆHTTPSä¼ è¾“ï¼Œå·²è¶³ä»¥æŠµå¾¡å¤§å¤šæ•°é£é™©äº†ã€‚å³ä½¿ç”¨æˆ·é‡‡ç”¨äº†å¼±å¯†ç ã€å®¢æˆ·ç«¯é€šä¿¡è¢«ç›‘å¬ã€æœåŠ¡ç«¯è¢«æ‹–åº“ã€æ³„æ¼äº†å­˜å‚¨çš„å¯†æ–‡å’Œç›å€¼ç­‰é—®é¢˜åŒæ—¶å‘ç”Ÿï¼Œä¹Ÿèƒ½å¤Ÿæœ€å¤§é™åº¦é¿å…ç”¨æˆ·æ˜æ–‡å¯†ç è¢«é€†æ¨å‡ºæ¥ã€‚ä¸‹é¢å…ˆä»‹ç»å¯†ç åˆ›å»ºçš„è¿‡ç¨‹ã€‚\n\nç”¨æˆ·åœ¨å®¢æˆ·ç«¯æ³¨å†Œï¼Œè¾“å…¥æ˜æ–‡å¯†ç ï¼š123456ã€‚\npassword ï¼123456\nå®¢æˆ·ç«¯å¯¹ç”¨æˆ·å¯†ç è¿›è¡Œç®€å•çš„å“ˆå¸Œæ‘˜è¦è¿ç®—ï¼Œå¯é€‰çš„ç®—æ³•æœ‰MD2/4/5ã€SHA1/256/512ã€BCryptã€PBKDFI1/2ï¼Œç­‰ç­‰ã€‚ä¸ºäº†çªå‡ºâ€œç®€å•â€çš„å“ˆå¸Œæ‘˜è¦ï¼Œè¿™é‡Œç¬”è€…æ•…æ„æ²¡æœ‰æ’é™¤æ‰ MD è¿™ç±»å·²ç»æœ‰äº†é«˜æ•ˆç¢°æ’æ‰‹æ®µçš„ç®—æ³•ã€‚\nclient hash MD5(password)   //e10adc3949ba59abbe56e057f20f883e\nä¸ºäº†é˜²å¾¡å½©è™¹è¡¨æ”»å‡»ï¼Œåº”åŠ ç›å¤„ç†ï¼Œå®¢æˆ·ç«¯åŠ ç›åªå–å›ºå®šçš„å­—ç¬¦ä¸²å³å¯ï¼Œå¦‚å®åœ¨ä¸å®‰å¿ƒï¼Œä¹Ÿå¯ç”¨ä¼ªåŠ¨æ€çš„ç›å€¼ã€‚\nclient hash MD5(MD5(password) ï¼‹ salt)     //SALT ï¼S2as10So5L.dWYEjZjaejOmN3x4Qu\nå‡è®¾æ”»å‡»è€…æˆªè·äº†å®¢æˆ·ç«¯å‘å‡ºçš„ä¿¡æ¯ï¼Œå¾—åˆ°äº†æ‘˜è¦ç»“æœå’Œé‡‡ç”¨çš„ç›å€¼ï¼Œé‚£æ”»å‡»è€…å°±å¯ä»¥æšä¸¾éå†æ‰€æœ‰8ä½å­—ç¬¦ä»¥å†…çš„å¼±å¯†ç ï¼Œç„¶åå¯¹æ¯ä¸ªå¯†ç å†è¿›è¡ŒåŠ ç›è®¡ç®—ï¼Œå°±å¾—åˆ°ä¸€ä¸ªé’ˆå¯¹å›ºå®šç›å€¼çš„å¯¹ç…§å½©è™¹è¡¨ã€‚ä¸ºäº†åº”å¯¹è¿™ç§æš´åŠ›ç ´è§£ï¼Œå¹¶ä¸æå€¡åœ¨ç›å€¼ä¸ŠåšåŠ¨æ€åŒ–ï¼Œæ›´ç†æƒ³çš„æ–¹å¼æ˜¯å¼•å…¥æ…¢å“ˆå¸Œå‡½æ•°æ¥è§£å†³ã€‚\næ…¢å“ˆå¸Œå‡½æ•°æ˜¯æŒ‡æ‰§è¡Œæ—¶é—´å¯ä»¥è°ƒèŠ‚çš„å“ˆå¸Œå‡½æ•°ï¼Œé€šå¸¸æ˜¯ä»¥æ§åˆ¶è°ƒç”¨æ¬¡æ•°æ¥å®ç°çš„ã€‚BCrypt ç®—æ³•å°±æ˜¯ä¸€ç§å…¸å‹çš„æ…¢å“ˆå¸Œå‡½æ•°ï¼Œå®ƒåšå“ˆå¸Œè®¡ç®—æ—¶æ¥å—ç›å€¼ Salt å’Œæ‰§è¡Œæˆæœ¬ Cost ä¸¤ä¸ªå‚æ•°ã€‚å¦‚æœæˆ‘ä»¬å°† BCrypt çš„æ‰§è¡Œæ—¶é—´æ§åˆ¶åœ¨ 0.1 ç§’å®Œæˆä¸€æ¬¡å“ˆå¸Œè®¡ç®—çš„è¯ï¼ŒæŒ‰ç…§ 1 ç§’ç”Ÿæˆ 10 ä¸ªå“ˆå¸Œå€¼çš„é€Ÿåº¦ï¼Œç®—å®Œæ‰€æœ‰çš„10ä½å¤§å°å†™å­—æ¯å’Œæ•°å­—ç»„æˆçš„å¼±å¯†ç å¤§æ¦‚éœ€è¦P(62ï¼Œ10) / (3600ï¼Š24ï¼Š365) / 0.1ï¼1237204169 å¹´æ—¶é—´ã€‚\nclient_hash BCrypt(MD5(password) + salt)  //MFfTW3uNI4eqhwDkG7HP9p2mzEUu/r2\nä¸‹ä¸€æ­¥å°†å“ˆå¸Œå€¼ä¼ è¾“åˆ°æœåŠ¡ç«¯ï¼Œåœ¨æœåŠ¡ç«¯åªéœ€é˜²å¾¡è¢«æ‹–åº“åé’ˆå¯¹å›ºå®šç›å€¼çš„æ‰¹é‡å½©è™¹è¡¨æ”»å‡»ã€‚å…·ä½“åšæ³•æ˜¯ä¸ºæ¯ä¸€ä¸ªå¯†ç ï¼ˆæŒ‡å®¢æˆ·ç«¯ä¼ æ¥çš„å“ˆå¸Œå€¼ï¼‰äº§ç”Ÿä¸€ä¸ªéšæœºçš„ç›å€¼ã€‚ç¬”è€…å»ºè®®é‡‡ç”¨ â€œå¯†ç å­¦å®‰å…¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨â€ï¼ˆCryptographically Secure Pseudo-Random Number Generatorï¼ŒCSPRNGï¼‰æ¥ç”Ÿæˆä¸€ä¸ªé•¿åº¦ä¸å“ˆå¸Œå€¼é•¿åº¦ç›¸ç­‰çš„éšæœºå­—ç¬¦ä¸²ã€‚å¯¹äºJavaè¯­è¨€ï¼Œä» Java SE7 èµ·æä¾›äº†java.security.SecureRandom ç±»ï¼Œç”¨äºæ”¯æŒ CSPRNG å­—ç¬¦ä¸²ç”Ÿæˆã€‚\nSecureRandom random new SecureRandom();byte server_salt[] new byte[36];random.nextBytes(server_salt);  //tq2pdxrblkbgp8vt8kbdpmzdh1w8bex\nå°†åŠ¨æ€ç›å€¼æ··å…¥å®¢æˆ·ç«¯ä¼ æ¥çš„å“ˆå¸Œå€¼å†åšä¸€æ¬¡å“ˆå¸Œï¼Œäº§ç”Ÿæœ€ç»ˆçš„å¯†æ–‡ï¼Œå¹¶å’Œä¸Šä¸€æ­¥éšæœºç”Ÿæˆçš„ç›å€¼ä¸€èµ·å†™å…¥åŒä¸€æ¡æ•°æ®åº“è®°å½•ä¸­ã€‚ç”±äºæ…¢å“ˆå¸Œç®—æ³•å ç”¨å¤§é‡å¤„ç†å™¨èµ„æºï¼Œç¬”è€…å¹¶ä¸æ¨èåœ¨æœåŠ¡ç«¯ä¸­é‡‡ç”¨ã€‚ä¸è¿‡ï¼Œå¦‚æœä½ é˜…è¯»äº† Fenixï¼‡s Bookstorel çš„æºç ï¼Œä¼šå‘ç°è¿™æ­¥ä¾ç„¶é‡‡ç”¨äº† Spring Security5 ä¸­çš„ BcryptPasswordEncoderï¼Œä½†æ˜¯è¯·æ³¨æ„å®ƒé»˜è®¤æ„é€ å‡½æ•°ä¸­çš„ Cost å‚æ•°å€¼ä¸º -1ï¼Œç»è½¬æ¢åå®é™…åªè¿›è¡Œäº† 1024(2^10) æ¬¡è®¡ç®—ï¼Œå¹¶ä¸ä¼šç»™æœåŠ¡ç«¯å¸¦æ¥å¤ªå¤§çš„å‹åŠ›ã€‚æ­¤å¤–ï¼Œä»£ç ä¸­å¹¶æœªæ˜¾å¼ä¼ å…¥ CSPRNG ç”Ÿæˆçš„ç›å€¼ï¼Œè¿™æ˜¯å› ä¸º  BCryptPasswordEncoder æœ¬èº«å°±ä¼šè‡ªåŠ¨è°ƒç”¨ CSPRNG äº§ç”Ÿç›å€¼ï¼Œå¹¶å°†è¯¥ç›å€¼è¾“å‡ºåœ¨ç»“æœçš„å‰ 32 ä½ä¹‹ä¸­ï¼Œå› æ­¤ä¹Ÿæ— é¡»ä¸“é—¨åœ¨æ•°æ®åº“ä¸­è®¾è®¡å­˜å‚¨ç›å€¼çš„å­—æ®µã€‚è¿™ä¸ªè¿‡ç¨‹ä»¥ä¼ªä»£ç è¡¨ç¤ºå¦‚ä¸‹ï¼š\nserver_hash = SHA256(client hash server salt);   //55b4b5815c216cf80599990e781cd8974a1e384d49fbde7776d096e1dd436f67DB.save(server hashï¼Œserver_salt);\n\nä»¥ä¸ŠåŠ å¯†å­˜å‚¨çš„è¿‡ç¨‹ç›¸å¯¹å¤æ‚ï¼Œä½†æ˜¯è¿ç®—å‹åŠ›æœ€å¤§çš„è¿‡ç¨‹ï¼ˆæ…¢å“ˆå¸Œï¼‰æ˜¯åœ¨å®¢æˆ·ç«¯å®Œæˆçš„ï¼Œå¯¹æœåŠ¡ç«¯å‹åŠ›å¾ˆå°ï¼Œä¹Ÿä¸æƒ§æ€•å› ç½‘ç»œé€šä¿¡è¢«æˆªè·è€Œå¯¼è‡´æ˜æ–‡å¯†ç æ³„æ¼ã€‚å¯†ç å­˜å‚¨åï¼Œä»¥åéªŒè¯çš„è¿‡ç¨‹ä¸åŠ å¯†æ˜¯ç±»ä¼¼çš„ï¼Œå…·ä½“æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºã€‚1ï¼‰å®¢æˆ·ç«¯ï¼šç”¨æˆ·åœ¨ç™»å½•é¡µé¢ä¸­è¾“å…¥å¯†ç æ˜æ–‡ï¼Œ123456ï¼Œç»è¿‡ä¸æ³¨å†Œç›¸åŒçš„åŠ å¯†è¿‡ç¨‹ï¼Œå‘æœåŠ¡ç«¯ä¼ è¾“åŠ å¯†åçš„ç»“æœã€‚\nauthentication_hash = MFfTW3uNI4eqhwDkG7HP9p2mzEUu/r2\n\n2ï¼‰æœåŠ¡ç«¯ï¼šæ¥æ”¶åˆ°å®¢æˆ·ç«¯ä¼ è¾“ä¸Šæ¥çš„å“ˆå¸Œå€¼ï¼Œä»æ•°æ®åº“ä¸­å–å‡ºç™»å½•ç”¨æˆ·å¯¹åº”çš„å¯†æ–‡å’Œç›å€¼ï¼Œé‡‡ç”¨ç›¸åŒçš„å“ˆå¸Œç®—æ³•ï¼Œå¯¹å®¢æˆ·ç«¯ä¼ æ¥çš„å“ˆå¸Œå€¼ã€æœåŠ¡ç«¯å­˜å‚¨çš„ç›å€¼è®¡ç®—æ‘˜è¦ç»“æœã€‚\nresult = SHA256(authentication_hash + server_salt);    //55b4b5815c216cf80599990e781cd8974a1e384d49fbde7776d096e1dd436f67\n\n3ï¼‰æ¯”è¾ƒä¸Šä¸€æ­¥çš„ç»“æœå’Œæ•°æ®åº“å‚¨å­˜çš„å“ˆå¸Œå€¼æ˜¯å¦ç›¸åŒï¼Œå¦‚æœç›¸åŒè¯´æ˜å¯†ç æ­£ç¡®ï¼Œåä¹‹è¯´æ˜å¯†ç é”™è¯¯ã€‚\nauthentication_compare(result, server_hash)     //yes\n\näº”ã€ä¼ è¾“å‰æ–‡ä¸­ç¬”è€…å·²ç»ä¸ºä¼ è¾“å®‰å…¨å±‚æŒ–äº†ä¸å°‘å‘ï¼Œè‡‚å¦‚ï¼šåŸºäºä¿¡é“çš„è®¤è¯æ˜¯æ€æ ·å®ç°çš„ï¼Ÿä¸ºä»€ä¹ˆHTTPSæ˜¯ç»å¤§éƒ¨åˆ†ä¿¡æ¯ç³»ç»Ÿé˜²å¾¡é€šä¿¡è¢«çªƒå¬å’Œç¯¡æ”¹çš„å”¯ä¸€å¯è¡Œæ‰‹æ®µï¼Ÿä¼ è¾“å®‰å…¨å±‚éš¾é“ä¸ä¹Ÿæ˜¯ä¸€ç§è‡ªåŠ¨åŒ–çš„åŠ å¯†å—ï¼Ÿä¸ºä½•è¯´æ— è®ºå®¢æˆ·ç«¯å¦‚ä½•åŠ å¯†éƒ½ä¸èƒ½ä»£æ›¿HTTPSï¼Ÿæœ¬èŠ‚å°†ä»¥ â€œå‡è®¾é“¾è·¯ä¸Šçš„å®‰å…¨å¾—ä¸åˆ°ä¿éšœï¼Œæ”»å‡»è€…å¦‚ä½•æ‘§æ¯ä¹‹å‰è®¤è¯ã€æˆæƒã€å‡­è¯ã€ä¿å¯†ä¸­æ‰€æåˆ°çš„ç§ç§å®‰å…¨æœºåˆ¶â€ ä¸ºåœºæ™¯ï¼Œè®²è§£ä¼ è¾“å®‰å…¨å±‚æ‰€è¦è§£å†³çš„é—®é¢˜ï¼ŒåŒæ—¶ä¹Ÿæ˜¯å¯¹å‰é¢è¿™äº›ç–‘é—®çš„å›ç­”ã€‚\n1. æ‘˜è¦ã€åŠ å¯†ä¸ç­¾åæˆ‘ä»¬ä» JWT ä»¤ç‰Œçš„ä¸€å°æ®µ â€œé¢˜å¤–è¯â€ æ¥å¼•å‡ºç°ä»£å¯†ç å­¦ç®—æ³•çš„ä¸‰ç§ä¸»è¦ç”¨é€”ï¼šæ‘˜è¦ã€åŠ å¯†ä¸ç­¾åã€‚JWT ä»¤ç‰Œæºå¸¦ä¿¡æ¯çš„å¯ä¿¡åº¦æºè‡ªäºå®ƒæ˜¯è¢«ç­¾è¿‡åçš„ä¿¡æ¯ï¼Œæ˜¯ä»¤ç‰Œç­¾å‘è€…çœŸå®æ„å›¾çš„ä½“ç°ï¼Œå› æ­¤æ˜¯ä¸å¯ç¯¡æ”¹çš„ã€‚ç„¶è€Œï¼Œä½ æ˜¯å¦äº†è§£ç­¾åå…·ä½“åšäº†ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆæœ‰ç­¾åå°±èƒ½å¤Ÿè®©è´Ÿè½½ä¸­çš„ä¿¡æ¯å˜å¾—ä¸å¯ç¯¡æ”¹å’Œä¸å¯æŠµèµ–å‘¢ï¼Ÿè¦è§£é‡Šæ•°å­—ç­¾åï¼ˆDigital Signatureï¼‰ï¼Œå¿…é¡»å…ˆä»å¯†ç å­¦ç®—æ³•çš„å¦å¤–ä¸¤ç§åŸºç¡€åº”ç”¨ â€œæ‘˜è¦â€ å’Œ â€œåŠ å¯†â€ è¯´èµ·ã€‚\næ‘˜è¦ä¹Ÿç§°ä¸ºæ•°å­—æ‘˜è¦ï¼ˆDigital Digestï¼‰æˆ–æ•°å­—æŒ‡çº¹ï¼ˆDigital Fingerprintï¼‰ã€‚JWTä»¤ç‰Œä¸­é»˜è®¤çš„ç­¾åä¿¡æ¯æ˜¯å¯¹ä»¤ç‰Œå¤´ã€è´Ÿè½½å’Œå¯†é’¥ä¸‰è€…é€šè¿‡ä»¤ç‰Œå¤´ä¸­æŒ‡å®šçš„å“ˆå¸Œç®—æ³•ï¼ˆHMACSHA256ï¼‰è®¡ç®—å‡ºæ¥çš„æ‘˜è¦å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\nsignature =  Hash(base64UrlEncode(header) ï¼‹ï¼‚.ï¼‚ï¼‹ base64UrlEncode(payload), secret)\n\nç†æƒ³çš„å“ˆå¸Œç®—æ³•éƒ½å…·å¤‡ä¸¤ä¸ªç‰¹æ€§ã€‚ä¸€æ˜¯æ˜“å˜æ€§ï¼Œè¿™æ˜¯æŒ‡ç®—æ³•çš„è¾“å…¥ç«¯å‘ç”Ÿäº†ä»»ä½•ä¸€ç‚¹ç»†å¾®å˜åŠ¨ï¼Œéƒ½ä¼šå¼•å‘é›ªå´©æ•ˆåº”ï¼ˆAvalanche Effectï¼‰ï¼Œä½¿å¾—è¾“å‡ºç«¯çš„ç»“æœäº§ç”Ÿæå¤§çš„å˜åŒ–ã€‚è¿™ä¸ªç‰¹æ€§å¸¸è¢«ç”¨æ¥åšæ ¡éªŒï¼Œä»¥ä¿è¯ä¿¡æ¯æœªè¢«ç¯¡æ”¹ï¼Œè­¬å¦‚äº’è”ç½‘ä¸Šä¸‹è½½å¤§æ–‡ä»¶ï¼Œå¸¸ä¼šé™„æœ‰ä¸€ä¸ªå“ˆå¸Œæ ¡éªŒç ï¼Œä»¥ç¡®ä¿ä¸‹è½½ä¸‹æ¥çš„æ–‡ä»¶æ²¡æœ‰å› ç½‘ç»œæˆ–å…¶ä»–åŸå› ä¸åŸæ–‡ä»¶äº§ç”Ÿä»»ä½•åå·®ã€‚äºŒæ˜¯ä¸å¯é€†æ€§ï¼Œæ‘˜è¦çš„è¿ç®—è¿‡ç¨‹æ˜¯å•å‘çš„ï¼Œä¸å¯èƒ½ä»æ‘˜è¦çš„ç»“æœä¸­é€†å‘è¿˜åŸå‡ºè¾“å…¥å€¼æ¥ã€‚ä¸–é—´çš„ä¿¡æ¯æœ‰æ— ç©·å¤šç§ï¼Œè€Œæ‘˜è¦çš„ç»“æœæ— è®ºå…¶ä½æ•°æ˜¯32ã€128ã€512ä½ï¼Œç”šè‡³æ›´å¤šä½ï¼Œéƒ½æ˜¯ä¸€ä¸ªæœ‰é™çš„æ•°å­—ï¼Œå› æ­¤è¾“å…¥æ•°æ®ä¸è¾“å‡ºçš„æ‘˜è¦ç»“æœå¿…ç„¶ä¸æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ã€‚ä¾‹å¦‚ï¼Œæˆ‘å¯¹ä¸€éƒ¨ç”µå½±åšæ‘˜è¦è¿ç®—å½¢æˆ 256 ä½çš„å“ˆå¸Œå€¼ï¼Œåº”è¯¥æ²¡æœ‰äººä¼šæŒ‡æœ›ä»è¿™ä¸ªå“ˆå¸Œå€¼ä¸­è¿˜åŸå‡ºä¸€éƒ¨ç”µå½±ã€‚å¶å°”èƒ½å¬åˆ° MD5ã€SHA1 æˆ–å…¶ä»–å“ˆå¸Œç®—æ³•è¢«ç ´è§£äº†çš„æ–°é—»ï¼Œä½†è¿™é‡Œçš„ â€œç ´è§£â€ å¹¶ä¸æ˜¯ â€œè§£å¯†â€ çš„æ„æ€ï¼Œè€Œæ˜¯æŒ‡æ‰¾åˆ°äº†è¯¥ç®—æ³•çš„é«˜æ•ˆç‡ç¢°æ’æ–¹æ³•ï¼Œèƒ½å¤Ÿåœ¨åˆç†çš„æ—¶é—´å†…ç”Ÿæˆä¸€ä¸ªæ‘˜è¦ç»“æœä¸ºæŒ‡å®šå†…å®¹çš„è¾“å…¥æ¯”ç‰¹æµï¼Œä½†å¹¶ä¸èƒ½ä»£è¡¨è¿™ä¸ªç¢°æ’äº§ç”Ÿçš„æ¯”ç‰¹æµå°±ä¼šæ˜¯åŸæ¥çš„è¾“å…¥æºã€‚\nç”±è¿™ä¸¤ä¸ªç‰¹æ€§å¯è§ï¼Œæ‘˜è¦çš„æ„ä¹‰æ˜¯åœ¨æºä¿¡æ¯ä¸æ³„æ¼çš„å‰æä¸‹è¾¨åˆ«å…¶çœŸä¼ªã€‚æ˜“å˜æ€§ä¿è¯äº†å¯ä»¥ä»å…¬å¼€çš„ç‰¹å¾ä¸Šç”„åˆ«å‡ºä¿¡æ¯æ˜¯å¦æ¥è‡ªäºæºä¿¡æ¯ï¼Œä¸å¯é€†æ€§ä¿è¯äº†ä¸ä¼šä»å…¬å¼€çš„ç‰¹å¾æš´éœ²å‡ºæºä¿¡æ¯ï¼Œè¿™ä¸ä»Šå¤©ç”¨ä½œèº«ä»½ç”„åˆ«çš„æŒ‡çº¹ã€é¢å®¹å’Œè™¹è†œçš„ç”Ÿç‰©ç‰¹å¾æ˜¯å…·æœ‰é«˜åº¦å¯æ¯”æ€§çš„ã€‚åœ¨ä¸€äº›åœºåˆä¸­ï¼Œæ‘˜è¦ä¹Ÿä¼šè¢«å€Ÿç”¨æ¥åšåŠ å¯†ï¼ˆå¦‚ä¿å¯†ä¸­ä»‹ç»çš„æ…¢å“ˆå¸ŒBeryptç®—æ³•ï¼‰å’Œç­¾åï¼ˆå¦‚JWTç­¾åä¸­çš„HMAC SHA256ç®—æ³•ï¼‰ï¼Œä½†åœ¨ä¸¥æ ¼æ„ä¹‰ä¸Šçœ‹ï¼Œæ‘˜è¦ä¸è¿™ä¸¤è€…æœ‰æœ¬è´¨çš„åŒºåˆ«ã€‚\nåŠ å¯†ä¸æ‘˜è¦çš„æœ¬è´¨åŒºåˆ«åœ¨äºåŠ å¯†æ˜¯å¯é€†çš„ï¼Œé€†è¿‡ç¨‹å°±æ˜¯è§£å¯†ã€‚åœ¨ç»å…¸å¯†ç å­¦æ—¶ä»£ï¼ŒåŠ å¯†çš„å®‰å…¨ä¸»è¦ä¾é æœºå¯†æ€§æ¥ä¿è¯ï¼Œå³ä¾é ä¿æŠ¤åŠ å¯†ç®—æ³•æˆ–ç®—æ³•çš„çƒ­è¡Œå‚æ•°ä¸è¢«æ³„æ¼æ¥ä¿éšœä¿¡æ¯çš„å®‰å…¨ã€‚è€Œç°ä»£å¯†ç å­¦ä¸ä¾é æœºå¯†æ€§ï¼ŒåŠ è§£å¯†ç®—æ³•éƒ½æ˜¯å®Œå…¨å…¬å¼€çš„ï¼Œå®ƒçš„å®‰å…¨æ˜¯å»ºç«‹åœ¨ç‰¹å®šé—®é¢˜çš„è®¡ç®—å¤æ‚åº¦ä¹‹ä¸Šï¼Œå…·ä½“æ˜¯æŒ‡ç®—æ³•æ ¹æ®è¾“å…¥ç«¯è®¡ç®—è¾“å‡ºç»“æœè€—è´¹çš„ç®—åŠ›èµ„æºå¾ˆå°ï¼Œä½†æ ¹æ®è¾“å‡ºç«¯çš„ç»“æœåè¿‡æ¥æ¨ç®—åŸæœ¬çš„è¾“å…¥æ—¶è€—è´¹çš„ç®—åŠ›å°±æå…¶åºå¤§ã€‚ä»¥å¤§æ•°çš„è´¨å› æ•°åˆ†è§£ä¸ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥è½»è€Œæ˜“ä¸¾åœ°ï¼ˆä»¥O(nlogn) çš„å¤æ‚åº¦ï¼‰è®¡ç®—å‡ºä¸¤ä¸ªå¤§ç´ æ•°çš„ä¹˜ç§¯ï¼Œè‡‚å¦‚ï¼š\n97667323933 * 128764321253 = 12576066674829627448049\n\næ ¹æ®ç®—æœ¯åŸºæœ¬å®šç†ï¼Œè´¨å› æ•°çš„åˆ†è§£å½¢å¼æ˜¯å”¯ä¸€çš„ï¼Œä¸”å‰é¢è®¡ç®—æ¡ä»¶ä¸­ç»™å‡ºçš„è¿ç®—å› å­å·²ç»æ˜¯è´¨æ•°ã€æ‰€ä»¥ 12576066674829627448049 çš„åˆ†è§£å½¢å¼å°±åªæœ‰å”¯ä¸€çš„å½¢å¼ï¼Œå³ä¸Šé¢æ‰€ç¤ºçš„å”¯ä¸€ç­”æ¡ˆã€‚ç„¶è€Œå¦‚ä½•å¯¹å¤§æ•°è¿›è¡Œè´¨å› æ•°åˆ†è§£ï¼Œè¿„ä»Šè¿˜æ²¡æœ‰æ‰¾åˆ°å¤šé¡¹å¼æ—¶é—´çš„ç®—æ³•ï¼Œç”šè‡³æ— æ³•ç¡®åˆ‡åœ°çŸ¥é“è¿™ä¸ªé—®é¢˜å±äºå“ªä¸ªå¤æ‚åº¦ç±»ï¼ˆComplexity Classï¼‰ã€‚æ‰€ä»¥å°½ç®¡è¿™ä¸ªè¿‡ç¨‹åœ¨ç†è®ºä¸Šä¸€å®šæ˜¯å¯é€†çš„ï¼Œä½†å®é™…ä¸Šç®—åŠ›å·®å¼‚å†³å®šäº†é€†è¿‡ç¨‹æ— æ³•å®ç°ã€‚\næ ¹æ®åŠ å¯†ä¸è§£å¯†æ˜¯å¦é‡‡ç”¨åŒä¸€ä¸ªå¯†é’¥ï¼Œå¯å°†ç°ä»£å¯†ç å­¦ç®—æ³•åˆ†ä¸ºå¯¹ç§°åŠ å¯†ç®—æ³•å’Œéå¯¹ç§°åŠ å¯†ç®—æ³•ä¸¤å¤§ç±»å‹ï¼Œè¿™ä¸¤ç±»ç®—æ³•å„æœ‰æ˜ç¡®çš„ä¼˜åŠ£åŠ¿ä¸åº”ç”¨åœºæ™¯ã€‚å¯¹ç§°åŠ å¯†ç®—æ³•çš„ç¼ºç‚¹æ˜¾è€Œæ˜“è§ï¼ŒåŠ å¯†å’Œè§£å¯†ä½¿ç”¨ç›¸åŒçš„å¯†é’¥ï¼Œå½“é€šä¿¡çš„æˆå‘˜æ•°é‡å¢åŠ æ—¶ï¼Œä¸ºä¿è¯ä¸¤ä¸¤é€šä¿¡éƒ½é‡‡ç”¨ç‹¬ç«‹çš„å¯†é’¥ï¼Œå¯†é’¥æ•°é‡ä¸æˆå‘˜æ•°é‡çš„å¹³æ–¹æˆæ­£æ¯”ï¼Œè¿™å¿…ç„¶é¢ä¸´å¯†é’¥ç®¡ç†çš„éš¾é¢˜ã€‚è€Œæ›´å°´å°¬çš„éš¾é¢˜æ˜¯å½“é€šä¿¡åŒæ–¹åŸæœ¬ä¸å­˜åœ¨å®‰å…¨çš„ä¿¡é“æ—¶ï¼Œå¦‚ä½•å°†ä¸€ä¸ªåªèƒ½è®©é€šä¿¡åŒæ–¹æ‰èƒ½çŸ¥é“çš„å¯†é’¥ä¼ è¾“ç»™å¯¹æ–¹ï¼Ÿå¦‚æœæœ‰é€šé“å¯ä»¥å®‰å…¨åœ°ä¼ è¾“å¯†é’¥ï¼Œé‚£ä¸ºä½•ä¸ä½¿ç”¨ç°æœ‰çš„é€šé“ä¼ è¾“ä¿¡æ¯ï¼Ÿè¿™ä¸ªâ€œè›‹é¸¡æ‚–è®ºâ€æ›¾åœ¨å¾ˆé•¿çš„æ—¶é—´é‡Œä¸¥é‡é˜»ç¢äº†å¯†ç å­¦åœ¨çœŸå®ä¸–ç•Œçš„æ¨å¹¿åº”ç”¨ã€‚\n20ä¸–çºª70å¹´ä»£ä¸­åæœŸå‡ºç°çš„éå¯¹ç§°åŠ å¯†ç®—æ³•ä»æ ¹æœ¬ä¸Šè§£å†³äº†å¯†é’¥åˆ†å‘çš„éš¾é¢˜ï¼Œå®ƒå°†å¯†é’¥åˆ†æˆå…¬é’¥å’Œç§é’¥ã€‚å…¬é’¥å¯ä»¥å®Œå…¨å…¬å¼€ï¼Œæ— é¡»å®‰å…¨ä¼ è¾“çš„ä¿è¯ã€‚ç§é’¥ç”±ç”¨æˆ·è‡ªè¡Œä¿ç®¡ï¼Œä¸å‚ä¸ä»»ä½•é€šä¿¡ä¼ è¾“ã€‚æ ¹æ®è¿™ä¸¤ä¸ªå¯†é’¥åŠ è§£å¯†æ–¹å¼çš„ä¸åŒï¼Œä½¿å¾—ç®—æ³•å¯ä»¥æä¾›ä¸¤ç§ä¸åŒçš„åŠŸèƒ½ã€‚\n\nå…¬é’¥åŠ å¯†ï¼Œç§é’¥è§£å¯†ï¼Œè¿™ç§å°±æ˜¯åŠ å¯†ï¼Œç”¨äºå‘ç§é’¥æ‰€æœ‰è€…å‘é€ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯å¯èƒ½è¢«ä»–äººç¯¡æ”¹ï¼Œä½†æ˜¯æ— æ³•è¢«ä»–äººå¾—çŸ¥ã€‚å¦‚æœç”²æƒ³ç»™ä¹™å‘ä¸€ä¸ªå®‰å…¨ä¿å¯†çš„æ•°æ®ï¼Œé‚£ä¹ˆç”²ä¹™åº”è¯¥å„æœ‰ä¸€ä¸ªç§é’¥ï¼Œç”²å…ˆç”¨ä¹™çš„å…¬é’¥åŠ å¯†è¿™æ®µæ•°æ®ï¼Œå†ç”¨è‡ªå·±çš„ç§é’¥åŠ å¯†è¿™æ®µåŠ å¯†åçš„æ•°æ®ï¼Œæœ€åå‘ç»™ä¹™ï¼Œè¿™æ ·ç¡®ä¿äº†å†…å®¹æ—¢ä¸ä¼šè¢«è¯»å–ï¼Œä¹Ÿä¸èƒ½è¢«ç¯¡æ”¹ã€‚\nç§é’¥åŠ å¯†ï¼Œå…¬é’¥è§£å¯†ï¼Œè¿™ç§å°±æ˜¯ç­¾åï¼Œç”¨äºè®©æ‰€æœ‰å…¬é’¥æ‰€æœ‰è€…éªŒè¯ç§é’¥æ‰€æœ‰è€…çš„èº«ä»½ï¼Œå¹¶ä¸”é˜²æ­¢ç§é’¥æ‰€æœ‰è€…å‘å¸ƒçš„å†…å®¹è¢«ç¯¡æ”¹ã€‚ä½†æ˜¯å®ƒä¸ç”¨äºä¿è¯å†…å®¹ä¸è¢«ä»–äººè·å¾—ã€‚\n\nè¿™ä¸¤ç§ç”¨é€”åœ¨ç†è®ºä¸Šè‚¯å®šæ˜¯æˆç«‹çš„ï¼Œåœ¨ç°å®ä¸­å´ä¸€èˆ¬ä¸æˆç«‹ã€‚å•é éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œæ—¢åšä¸äº†åŠ å¯†ä¹Ÿåšä¸äº†ç­¾åã€‚å› ä¸ºä¸è®ºæ˜¯åŠ å¯†è¿˜æ˜¯è§£å¯†ï¼Œéå¯¹ç§°åŠ å¯†ç®—æ³•çš„è®¡ç®—å¤æ‚åº¦éƒ½ç›¸å½“é«˜ï¼Œå…¶æ€§èƒ½æ¯”å¯¹ç§°åŠ å¯†è¦å·®ä¸Šå¥½å‡ ä¸ªæ•°é‡çº§ï¼ˆä¸æ˜¯å¥½å‡ å€ï¼‰ã€‚åŠ è§£å¯†æ€§èƒ½ä¸ä»…å½±å“é€Ÿåº¦ï¼Œè¿˜å¯¼è‡´ç°è¡Œçš„éå¯¹ç§°åŠ å¯†ç®—æ³•éƒ½æ²¡æœ‰æ”¯æŒåˆ†ç»„åŠ å¯†æ¨¡å¼ã€‚è¿™å¥è¯çš„å«ä¹‰æ˜¯ï¼šç”±äºæ˜æ–‡é•¿åº¦ä¸å¯†é’¥é•¿åº¦åœ¨å®‰å…¨ä¸Šå…·æœ‰ç›¸å…³æ€§ï¼Œé€šä¿—åœ°è¯´ï¼Œå¤šé•¿çš„å¯†é’¥å†³å®šäº†å®ƒèƒ½åŠ å¯†å¤šé•¿çš„æ˜æ–‡ï¼Œå¦‚æœæ˜æ–‡å¤ªçŸ­å°±éœ€è¦è¿›è¡Œå¡«å……ï¼Œå¤ªé•¿å°±éœ€è¦è¿›è¡Œåˆ†ç»„ã€‚å› éå¯¹ç§°åŠ å¯†æœ¬èº«çš„æ•ˆç‡æ‰€é™ï¼Œéš¾ä»¥æ”¯æŒåˆ†ç»„ï¼Œæ‰€ä»¥ä¸»æµçš„éå¯¹ç§°åŠ å¯†ç®—æ³•éƒ½åªèƒ½åŠ å¯†ä¸è¶…è¿‡å¯†é’¥é•¿åº¦çš„æ•°æ®ï¼Œè¿™ä¹Ÿå†³å®šäº†éå¯¹ç§°åŠ å¯†ä¸èƒ½ç›´æ¥ç”¨äºå¤§é‡æ•°æ®çš„åŠ å¯†ã€‚\nåœ¨åŠ å¯†æ–¹é¢ï¼Œç°åœ¨ä¸€èˆ¬ä¼šç»“åˆå¯¹ç§°ä¸éå¯¹ç§°åŠ å¯†çš„ä¼˜ç‚¹ï¼Œä»¥æ··åˆåŠ å¯†æ¥ä¿æŠ¤ä¿¡é“å®‰å…¨ï¼Œå…·ä½“åšæ³•æ˜¯ç”¨éå¯¹ç§°åŠ å¯†æ¥å®‰å…¨åœ°ä¼ é€’å°‘é‡æ•°æ®ç»™é€šä¿¡çš„å¦ä¸€æ–¹ï¼Œå†ä»¥è¿™äº›æ•°æ®ä¸ºå¯†é’¥ï¼Œé‡‡ç”¨å¯¹ç§°åŠ å¯†æ¥å®‰å…¨é«˜æ•ˆåœ°å¤§é‡åŠ å¯†ä¼ è¾“æ•°æ®ï¼Œè¿™ç§ç”±å¤šç§åŠ å¯†ç®—æ³•ç»„åˆçš„åº”ç”¨å½¢å¼ç§°ä¸º â€œå¯†ç å­¦å¥—ä»¶â€ã€‚éå¯¹ç§°åŠ å¯†åœ¨è¿™ä¸ªåœºæ™¯ä¸­å‘æŒ¥çš„ä½œç”¨ç§°ä¸º â€œå¯†é’¥åå•†â€ã€‚\nåœ¨ç­¾åæ–¹é¢ï¼Œç°åœ¨ä¸€èˆ¬ä¼šç»“åˆæ‘˜è¦ä¸éå¯¹ç§°åŠ å¯†çš„ä¼˜ç‚¹ï¼Œä»¥å¯¹æ‘˜è¦ç»“æœåšåŠ å¯†çš„å½¢å¼æ¥ä¿è¯ç­¾åçš„é€‚ç”¨æ€§ã€‚ç”±äºå¯¹ä»»ä½•é•¿åº¦çš„è¾“å…¥æºåšæ‘˜è¦ä¹‹åéƒ½èƒ½å¾—åˆ°å›ºå®šé•¿åº¦çš„ç»“æœï¼Œæ‰€ä»¥åªè¦å¯¹æ‘˜è¦çš„ç»“æœè¿›è¡Œç­¾åï¼Œå³ç›¸å½“äºå¯¹æ•´ä¸ªè¾“å…¥æºè¿›è¡Œäº†èƒŒä¹¦ï¼Œä¿è¯ä¸€æ—¦å†…å®¹é­åˆ°ç¯¡æ”¹ï¼Œæ‘˜è¦ç»“æœå°±ä¼šå˜åŒ–ï¼Œç­¾åä¹Ÿå°±é©¬ä¸Šå¤±æ•ˆäº†ã€‚\nè¡¨5-1æ±‡æ€»äº†å‰é¢æåˆ°çš„ä¸‰ç§ç®—æ³•ï¼Œå¹¶åˆ—ä¸¾äº†å®ƒä»¬çš„ä¸»è¦ç‰¹å¾ã€ç”¨é€”å’Œå±€é™æ€§ã€‚\n\n\n\nç±»å‹\nç‰¹ç‚¹\nå¸¸è§å®ç°\nä¸»è¦ç”¨é€”\nä¸»è¦å±€é™\n\n\n\nå“ˆå¸Œæ‘˜è¦\n1ï¼‰ä¸å¯é€†ï¼Œå³ä¸èƒ½è§£å¯†ï¼Œæ‰€ä»¥å¹¶ä¸æ˜¯åŠ å¯†ç®—æ³•ï¼Œåªæ˜¯ä¸€äº›åœºæ™¯æŠŠå®ƒå½“ä½œåŠ å¯†ç®—æ³•ä½¿ç”¨2ï¼‰æ˜“å˜æ€§ï¼Œè¾“å…¥å‘ç”Ÿ1ä½å˜åŠ¨ï¼Œå°±å¯èƒ½å¯¼è‡´è¾“å‡ºç»“æœ50ï¼…çš„å†…å®¹å‘ç”Ÿæ”¹å˜3ï¼‰æ— è®ºè¾“å…¥é•¿åº¦å¤šå°‘ï¼Œè¾“å‡ºé•¿åº¦å›ºå®šï¼ˆ2çš„Næ¬¡å¹‚ï¼‰\nMD2/4/5/6ã€SHA0/1/256/512\næ‘˜è¦\næ— æ³•è§£å¯†\n\n\nå¯¹ç§°åŠ å¯†\n1ï¼‰åŠ å¯†å’Œè§£å¯†æ˜¯ä¸€æ ·çš„å¯†é’¥2ï¼‰è®¾è®¡éš¾åº¦ç›¸å¯¹è¾ƒå°ï¼Œæ‰§è¡Œé€Ÿåº¦ç›¸å¯¹è¾ƒå¿«3ï¼‰åŠ å¯†æ˜æ–‡é•¿åº¦ä¸å—é™åˆ¶\nDESã€AESã€RC4ã€IDEA\nåŠ å¯†\nè¦è§£å†³å¦‚ä½•æŠŠå¯†é’¥å®‰å…¨åœ°ä¼ é€’ç»™è§£å¯†è€…\n\n\néå¯¹ç§°åŠ å¯†\n1ï¼‰åŠ å¯†å’Œè§£å¯†ä½¿ç”¨çš„æ˜¯ä¸åŒçš„å¯†é’¥2ï¼‰æ˜æ–‡é•¿åº¦ä¸èƒ½è¶…è¿‡å…¬é’¥é•¿åº¦\nRSAã€BCDSAã€ElGamal\nç­¾åã€ä¼ é€’å¯†é’¥\n\n\n\nç°åœ¨ï¼Œè®©æˆ‘ä»¬å†å›åˆ°å¼€ç¯‡å…³äº JWT ä»¤ç‰Œçš„å‡ ä¸ªé—®é¢˜ä¸­æ¥ã€‚æœ‰äº†å“ˆå¸Œæ‘˜è¦ã€å¯¹ç§°å’Œéå¯¹ç§°åŠ å¯†ç®—æ³•ï¼ŒJWT ä»¤ç‰Œçš„ç­¾åå°±èƒ½ä¿è¯è´Ÿè½½ä¸­çš„ä¿¡æ¯ä¸å¯ç¯¡æ”¹ã€ä¸å¯æŠµèµ–å—ï¼Ÿå…¶å®è¿˜æ˜¯ä¸è¡Œçš„ï¼Œåœ¨è¿™ä¸ªåœºæ™¯é‡Œï¼Œæ•°å­—ç­¾åçš„å®‰å…¨æ€§ä»å­˜åœ¨ä¸€ä¸ªè‡´å‘½çš„æ¼æ´ï¼šå…¬é’¥è™½ç„¶æ˜¯å…¬å¼€çš„ï¼Œä½†åœ¨ç½‘ç»œä¸–ç•Œé‡Œâ€œå…¬å¼€â€å…·ä½“æ˜¯ä¸€ç§ä»€ä¹ˆæ“ä½œï¼Ÿå¦‚ä½•ä¿è¯æ¯ä¸€ä¸ªè·å–å…¬é’¥çš„æœåŠ¡ï¼Œæ‹¿åˆ°çš„å…¬é’¥å°±æ˜¯æˆæƒæœåŠ¡å™¨å¸Œæœ›å®ƒæ‹¿åˆ°çš„ï¼Ÿ\nåœ¨ç½‘ç»œä¼ è¾“æ˜¯ä¸å¯ä¿¡ä»»çš„å‰æä¸‹ï¼Œå…¬é’¥åœ¨ç½‘ç»œä¼ è¾“è¿‡ç¨‹ä¸­å¯èƒ½å·²ç»è¢«ç¯¡æ”¹ï¼Œå¦‚æœè·å–å…¬é’¥çš„ç½‘ç»œè¯·æ±‚è¢«æ”»å‡»è€…æˆªè·å¹¶ç¯¡æ”¹ï¼Œè¿”å›äº†æ”»å‡»è€…è‡ªå·±çš„å…¬é’¥ï¼Œé‚£ä»¥åæ”»å‡»è€…å°±å¯ä»¥ç”¨è‡ªå·±çš„ç§é’¥æ¥ç­¾åï¼Œè®©èµ„æºæœåŠ¡å™¨æ— æ¡ä»¶ä¿¡ä»»å®ƒçš„æ‰€æœ‰è¡Œä¸ºäº†ã€‚ç°å®ä¸–ç•Œä¸­å¯ä»¥é€šè¿‡æ‰“ç”µè¯ã€å‘é‚®ä»¶ã€çŸ­ä¿¡æ¯ã€ç™»æŠ¥çº¸ã€åŒæ—¶å‘å¸ƒåœ¨å¤šä¸ªç½‘ç«™ä¸Šç­‰å¾ˆå¤šç½‘ç»œé€šä¿¡ä¹‹å¤–çš„é€”å¾„æ¥å…¬å¼€å…¬é’¥ï¼Œä½†åœ¨ç¨‹åºä¸ç½‘ç»œçš„ä¸–ç•Œä¸­ï¼Œå°±å¿…é¡»æ‰¾åˆ°ä¸€ç§å¯ä¿¡ä»»çš„å…¬å¼€æ–¹æ³•ï¼Œè€Œä¸”è¿™ç§æ–¹æ³•ä¸èƒ½ä¾èµ–åŠ å¯†æ¥å®ç°ï¼Œå¦åˆ™åˆå°†é™·å…¥ â€œè›‹é¸¡â€ é—®é¢˜ä¹‹ä¸­ã€‚\n2. æ•°å­—è¯ä¹¦å½“æˆ‘ä»¬æ— æ³•ä»¥â€œç­¾åâ€çš„æ‰‹æ®µæ¥è¾¾æˆä¿¡ä»»æ—¶ï¼Œå°±åªèƒ½æ±‚åŠ©äºå…¶ä»–é€”å¾„ã€‚ä¸å¦¨å…ˆæƒ³ä¸€æƒ³çœŸå®çš„ä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬æ˜¯å¦‚ä½•è¾¾æˆä¿¡ä»»çš„ï¼Œå…¶å®ä¸å¤–ä¹ä»¥ä¸‹ä¸¤ç§ã€‚\n\nåŸºäºå…±åŒç§å¯†ä¿¡æ¯çš„ä¿¡ä»»ã€‚è­¬å¦‚æŸä¸ªé™Œç”Ÿå·ç æ‰¾ä½ ï¼Œè¯´æ˜¯ä½ çš„è€åŒå­¦ï¼Œç”Ÿç—…äº†è¦æ‰¾ä½ å€Ÿé’±ã€‚ä½ èƒ½å¤Ÿä¿¡ä»»ä»–çš„æ–¹å¼æ˜¯å‘å¯¹æ–¹è¯¢é—®ä¸€äº›ä½ ä»¬ä¸¤ä¸ªåº”è¯¥çŸ¥é“ï¼Œä¸”åªæœ‰ä½ ä»¬ä¸¤ä¸ªçŸ¥é“çš„ç§å¯†ä¿¡æ¯ï¼Œå¦‚æœå¯¹æ–¹èƒ½å¤Ÿå›ç­”å‡ºæ¥ï¼Œä»–æœ‰å¯èƒ½çœŸçš„æ˜¯ä½ çš„è€åŒå­¦ï¼Œå¦åˆ™ä»–åæœ‰å…«ä¹å°±æ˜¯ä¸ªéª—å­ã€‚\n\nåŸºäºæƒå¨å…¬è¯äººçš„ä¿¡ä»»ã€‚å¦‚æœæœ‰ä¸ªé™Œç”Ÿäººæ‰¾ä½ ï¼Œè¯´ä»–æ˜¯è­¦å¯Ÿï¼Œè®©ä½ æŠŠå­˜æ¬¾è½¬åˆ°ä»–ä»¬çš„å®‰å…¨è´¦å·ä¸Šã€‚ä½ èƒ½å¤Ÿä¿¡ä»»ä»–çš„æ–¹å¼æ˜¯å»ä¸€è¶Ÿå…¬å®‰å±€ï¼Œå¦‚æœå…¬å®‰å±€æ‹…ä¿ä»–ç¡®å®æ˜¯ä¸ªè­¦å¯Ÿï¼Œé‚£ä»–æœ‰å¯èƒ½çœŸçš„æ˜¯è­¦å¯Ÿï¼Œå¦åˆ™ä»–åæœ‰å…«ä¹å°±æ˜¯ä¸ªéª—å­ã€‚\n\n\nå›åˆ°ç½‘ç»œä¸–ç•Œä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½å‡è®¾æˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨æ˜¯äº’ç›¸è®¤è¯†çš„ï¼Œæ‰€ä»¥é€šå¸¸ä¸å¤ªä¼šé‡‡ç”¨ç¬¬ä¸€ç§æ–¹å¼ï¼Œè€Œç¬¬äºŒç§å°±æ˜¯ç›®å‰ä¿è¯å…¬é’¥å¯ä¿¡åˆ†å‘çš„æ ‡å‡†ï¼Œå³å…¬å¼€å¯†é’¥åŸºç¡€è®¾æ–½ï¼ˆPublic Key Infrastructureï¼ŒPKIï¼‰ã€‚\n\nå…¬å¼€å¯†é’¥åŸºç¡€è®¾æ–½\nåˆç§°å…¬å¼€å¯†é’¥åŸºç¡€æ¶æ„ã€å…¬é’¥åŸºç¡€å»ºè®¾ã€å…¬é’¥åŸºç¡€è®¾æ–½ã€å…¬å¼€å¯†é’¥åŸºç¡€å»ºè®¾æˆ–å…¬é’¥åŸºç¡€æ¶æ„ï¼Œæ˜¯ä¸€ç»„ç”±ç¡¬ä»¶ã€è½¯ä»¶ã€å‚ä¸è€…ã€ç®¡ç†æ”¿ç­–ä¸æµç¨‹ç»„æˆçš„åŸºç¡€æ¶æ„ï¼Œå…¶ç›®çš„åœ¨äºåˆ›é€ ã€ç®¡ç†ã€åˆ†é…ã€ä½¿ç”¨ã€å­˜å‚¨ä»¥åŠæ’¤é”€æ•°å­—è¯ä¹¦ã€‚\nåœ¨å¯†ç å­¦ä¸­ï¼Œå…¬å¼€å¯†é’¥åŸºç¡€å»ºè®¾å€Ÿç€æ•°å­—è¯ä¹¦è®¤è¯ä¸­å¿ƒï¼ˆCertificate Authorityï¼ŒCAï¼‰å°†ç”¨æˆ·çš„ä¸ªäººèº«ä»½è·Ÿå…¬å¼€å¯†é’¥é“¾æ¥åœ¨ä¸€èµ·ï¼Œä¸”æ¯ä¸ªè¯ä¹¦ä¸­å¿ƒç”¨æˆ·çš„èº«ä»½å¿…é¡»æ˜¯å”¯ä¸€çš„ã€‚é“¾æ¥å…³ç³»é€šè¿‡æ³¨å†Œå’Œå‘å¸ƒè¿‡ç¨‹åˆ›å»ºï¼Œæ ¹æ®æ‹…ä¿çº§åˆ«çš„å·®å¼‚ï¼Œåˆ›å»ºè¿‡ç¨‹å¯ç”± CA çš„å„ç§è½¯ä»¶æˆ–åœ¨äººä¸ºç›‘ç£ä¸‹å®Œæˆã€‚PKIçš„ç¡®å®šé“¾æ¥å…³ç³»çš„è¿™ä¸€è§’è‰²ç§°ä¸ºæ³¨å†Œç®¡ç†ä¸­å¿ƒï¼ˆRegistration Authorityï¼ŒRAï¼‰ã€‚RAç¡®ä¿å…¬å¼€å¯†é’¥å’Œä¸ªäººèº«ä»½é“¾æ¥ï¼Œå¯ä»¥é˜²æŠµèµ–ã€‚\n\nå’±ä»¬ä¸å¿…çº ç¼ äº PKI æ¦‚å¿µä¸Šçš„å†…å®¹ï¼Œåªè¦çŸ¥é“é‡Œé¢å®šä¹‰çš„ â€œæ•°å­—è¯ä¹¦è®¤è¯ä¸­å¿ƒâ€ ç›¸å½“äºå‰é¢ä¾‹å­ä¸­ â€œæƒå¨å…¬è¯äººâ€ çš„è§’è‰²ï¼Œæ˜¯è´Ÿè´£å‘æ”¾å’Œç®¡ç†æ•°å­—è¯ä¹¦çš„æƒå¨æœºæ„å³å¯ã€‚ä»»ä½•äººåŒ…æ‹¬ä½ æˆ‘éƒ½å¯ä»¥ç­¾å‘è¯ä¹¦ï¼Œåªæ˜¯ä¸æƒå¨ç½¢äº†ã€‚CA ä½œä¸ºå—ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹ï¼Œæ‰¿æ‹…å…¬é’¥ä½“ç³»ä¸­å…¬é’¥çš„åˆæ³•æ€§æ£€éªŒçš„è´£ä»»ã€‚å¯æ˜¯ï¼Œè¿™é‡Œå’Œç°å®ä¸–ç•Œä»ç„¶æœ‰ä¸€äº›åŒºåˆ«ï¼Œåœ¨ç°å®ä¸–ç•Œä½ å»æ‰¾å…¬å®‰å±€ï¼Œå…¶åŠå…¬å¤§æ¥¼ä¸å¤§å¯èƒ½æ˜¯å‰§åœºå¸ƒæ™¯å†’è®¤çš„ï¼›è€Œåœ¨ç½‘ç»œä¸–ç•Œï¼Œåœ¨å‡è®¾æ‰€æœ‰ç½‘ç»œä¼ è¾“éƒ½æœ‰å¯èƒ½è¢«æˆªè·å†’è®¤çš„å‰æä¸‹ï¼Œâ€œå»CAä¸­å¿ƒè¿›è¡Œè®¤è¯â€æœ¬èº«ä¹Ÿæ˜¯ä¸€ç§ç½‘ç»œæ“ä½œï¼Œè¿™ä¸ä¹‹å‰çš„ â€œå»è·å–å…¬é’¥â€ æœ¬è´¨ä¸Šä¸æ˜¯æ²¡ä»€ä¹ˆå·®åˆ«å—ï¼Ÿå…¶å®è¿˜æ˜¯æœ‰å·®åˆ«çš„ï¼Œä¸–é—´å…¬é’¥æˆåƒä¸Šä¸‡ä¸å¯æšä¸¾ï¼Œè€Œæƒå¨çš„CAä¸­å¿ƒåˆ™åº”æ˜¯å¯æ•°çš„ï¼Œâ€œå¯æ•°â€æ„å‘³ç€å¯ä»¥ä¸é€šè¿‡ç½‘ç»œï¼Œè€Œæ˜¯åœ¨æµè§ˆå™¨ä¸æ“ä½œç³»ç»Ÿå‡ºå‚æ—¶å°±é¢„ç½®å¥½ï¼Œæˆ–è€…æå‰å®‰è£…å¥½ï¼ˆå¦‚é“¶è¡Œçš„è¯ä¹¦ï¼‰ã€‚\nåˆ°è¿™é‡Œå‡ºç°äº†æœ¬èŠ‚çš„ä¸»è§’ä¹‹ä¸€ï¼šè¯ä¹¦ï¼ˆCertificateï¼‰ã€‚è¯ä¹¦æ˜¯æƒå¨ CA ä¸­å¿ƒå¯¹ç‰¹å®šå…¬é’¥ä¿¡æ¯çš„ä¸€ç§å…¬è¯è½½ä½“ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæƒå¨ CA å¯¹ç‰¹å®šå…¬é’¥æœªè¢«ç¯¡æ”¹çš„ç­¾åèƒŒä¹¦ã€‚ç”±äºå®¢æˆ·çš„æœºå™¨ä¸Šå·²ç»é¢„ç½®äº†è¿™äº›æƒå¨CAä¸­å¿ƒæœ¬èº«çš„è¯ä¹¦ï¼ˆç§°ä¸ºCAè¯ä¹¦æˆ–è€…æ ¹è¯ä¹¦ï¼‰ï¼Œæ‰€ä»¥æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸ä¾é ç½‘ç»œçš„å‰æä¸‹ï¼Œä½¿ç”¨æ ¹è¯ä¹¦é‡Œé¢çš„å…¬é’¥ä¿¡æ¯å¯¹å…¶æ‰€ç­¾å‘çš„è¯ä¹¦ä¸­çš„ç­¾åè¿›è¡Œç¡®è®¤ã€‚åˆ°æ­¤ï¼Œç»ˆäºæ‰“ç ´äº†é¸¡ç”Ÿè›‹ã€è›‹ç”Ÿé¸¡çš„å¾ªç¯ï¼Œä½¿å¾—æ•´å¥—æ•°å­—ç­¾åä½“ç³»æœ‰äº†åšå®çš„é€»è¾‘åŸºç¡€ã€‚\nPKI ä¸­é‡‡ç”¨çš„è¯ä¹¦æ ¼å¼æ˜¯ X.509 æ ‡å‡†æ ¼å¼ï¼Œå®ƒå®šä¹‰äº†è¯ä¹¦ä¸­åº”è¯¥åŒ…å«å“ªäº›ä¿¡æ¯ï¼Œå¹¶æè¿°äº†è¿™äº›ä¿¡æ¯æ˜¯å¦‚ä½•ç¼–ç çš„ï¼Œå…¶ä¸­æœ€å…³é”®çš„å°±æ˜¯è®¤è¯æœºæ„çš„æ•°å­—ç­¾åå’Œå…¬é’¥ä¿¡æ¯ä¸¤é¡¹å†…å®¹ã€‚ä¸€ä¸ªæ•°å­—è¯ä¹¦å…·ä½“åŒ…å«ä»¥ä¸‹å†…å®¹ã€‚\n\nç‰ˆæœ¬å·ï¼ˆVersionï¼‰ï¼šæŒ‡å‡ºè¯¥è¯ä¹¦ä½¿ç”¨äº†å“ªç§ç‰ˆæœ¬çš„ X.509 æ ‡å‡†ï¼ˆç‰ˆæœ¬1ã€ç‰ˆæœ¬2æˆ–æ˜¯ç‰ˆæœ¬3ï¼‰ï¼Œç‰ˆæœ¬å·ä¼šå½±å“è¯ä¹¦ä¸­çš„ä¸€äº›ç‰¹å®šä¿¡æ¯ï¼Œç›®å‰çš„ç‰ˆæœ¬ä¸º 3ã€‚\n\nVersion:3 ï¼ˆ0x2ï¼‰\n\n\nåºåˆ—å·ï¼ˆSerial Numberï¼‰ï¼šç”±è¯ä¹¦é¢å‘è€…åˆ†é…çš„è¯ä¹¦çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚\n\nSeria1 Number: 04:00:00:00:00:01:15:4b:5a:c3:94\n\n\nç­¾åç®—æ³•æ ‡è¯†ç¬¦ï¼ˆSignature Algorithm IDï¼‰ï¼šç”¨äºç­¾å‘è¯ä¹¦çš„ç®—æ³•æ ‡è¯†ï¼Œç”±å¯¹è±¡æ ‡è¯†ç¬¦åŠ ä¸Šç›¸å…³çš„å‚æ•°ç»„æˆï¼Œç”¨äºè¯´æ˜æœ¬è¯ä¹¦æ‰€ç”¨çš„æ•°å­—ç­¾åç®—æ³•ã€‚è­¬å¦‚ï¼ŒSHA1å’ŒRSAçš„å¯¹è±¡æ ‡è¯†ç¬¦å°±ç”¨æ¥è¯´æ˜è¯¥æ•°å­—ç­¾åæ˜¯åˆ©ç”¨RSAå¯¹SHA1çš„æ‘˜è¦ç»“æœè¿›è¡ŒåŠ å¯†ã€‚\n\nSignature Algorithm: shalWithRSAEncryption\n\n\nè®¤è¯æœºæ„çš„æ•°å­—ç­¾åï¼ˆCertificate Signatureï¼‰ï¼šè¿™æ˜¯ä½¿ç”¨è¯ä¹¦å‘å¸ƒè€…ç§é’¥ç”Ÿæˆçš„ç­¾åï¼Œä»¥ç¡®ä¿è¿™ä¸ªè¯ä¹¦åœ¨å‘æ”¾ä¹‹åæ²¡æœ‰è¢«ç¯¡æ”¹è¿‡ã€‚\n\nè®¤è¯æœºæ„ï¼ˆIssuer Nameï¼‰ï¼šè¯ä¹¦é¢å‘è€…çš„å¯è¯†åˆ«åã€‚\n\nIssuer: Cï¼BEï¼ŒOï¼GlobalSign nv-saï¼ŒCNï¼GlobalSign Organization Validation CA  -SHA256 - G2\n\n\næœ‰æ•ˆæœŸé™ï¼ˆValidity Periodï¼‰ï¼šè¯ä¹¦èµ·å§‹æ—¥æœŸå’Œæ—¶é—´ä»¥åŠç»ˆæ­¢æ—¥æœŸå’Œæ—¶é—´ï¼›æŒ‡æ˜è¯ä¹¦åœ¨è¿™ä¸¤ä¸ªæ—¶é—´å†…æœ‰æ•ˆã€‚\n\nValidity\n  Not Before :Nov 21 08:00:00 2020 GMT\n  Not After   : Nov 22 07:59:59 2021 GMT\n\n\n\nä¸»é¢˜ä¿¡æ¯ï¼ˆSubjectï¼‰ï¼šè¯ä¹¦æŒæœ‰äººå”¯ä¸€çš„æ ‡è¯†ç¬¦ï¼ˆDistinguished Nameï¼‰ï¼Œè¿™ä¸ªåå­—åœ¨æ•´ä¸ªäº’è”ç½‘ä¸Šåº”è¯¥æ˜¯å”¯ä¸€çš„ï¼Œé€šå¸¸ä½¿ç”¨çš„æ˜¯ç½‘ç«™çš„åŸŸåã€‚\n\nSubject:Cï¼CNï¼ŒSTï¼GuangDongï¼ŒLï¼Zhuhaiï¼ŒOï¼Awosome-Fenixï¼ŒCNï¼ï¼Š.icyfenix.cn\n\n\nå…¬é’¥ä¿¡æ¯ï¼ˆPublic-Keyï¼‰ï¼šåŒ…æ‹¬è¯ä¹¦æŒæœ‰äººçš„å…¬é’¥ã€ç®—æ³•ï¼ˆæŒ‡æ˜å¯†é’¥å±äºå“ªç§å¯†ç ç³»ç»Ÿï¼‰çš„æ ‡è¯†ç¬¦å’Œå…¶ä»–ç›¸å…³çš„å¯†é’¥å‚æ•°ã€‚\n\n\n3. ä¼ è¾“å®‰å…¨å±‚è‡³æ­¤ï¼Œæ•°å­—ç­¾åçš„å®‰å…¨æ€§å·²ç»å¯ä»¥å®Œå…¨è‡ªæ´½äº†ï¼Œä½†ç›¸ä¿¡ä½ å¤§æ¦‚ä¹Ÿå·²ç»æ„Ÿå—åˆ°äº†è¿™æ¡ä¿¡ä»»é“¾çš„å¤æ‚ä¸çƒ¦çï¼Œå¦‚æœä»ç¡®å®šåŠ å¯†ç®—æ³•ã€ç”Ÿæˆå¯†é’¥ã€å…¬é’¥åˆ†å‘ã€CAè®¤è¯ã€æ ¸éªŒå…¬é’¥ã€ç­¾ååˆ°éªŒè¯ï¼Œæ¯ä¸€ä¸ªæ­¥éª¤éƒ½è¦ç”±æœ€ç»ˆç”¨æˆ·æ¥å®Œæˆçš„è¯ï¼Œè¿™ç§æ„ä¹‰çš„ â€œå®‰å…¨â€ ä¼°è®¡åªèƒ½ä¸€ç›´æ˜¯å­˜äºå®éªŒå®¤ä¸­çš„é˜³æ˜¥ç™½é›ªã€‚å¦‚ä½•æŠŠè¿™å¥—çƒ¦ççš„æŠ€æœ¯ä½“ç³»è‡ªåŠ¨åŒ–åœ°åº”ç”¨äºæ— å¤„ä¸åœ¨çš„ç½‘ç»œé€šä¿¡ä¹‹ä¸­ï¼Œä¾¿æ˜¯æœ¬èŠ‚çš„ä¸»é¢˜ã€‚\nåœ¨è®¡ç®—æœºç§‘å­¦é‡Œï¼Œéš”ç¦»å¤æ‚æ€§çš„æœ€æœ‰æ•ˆæ‰‹æ®µï¼ˆæ²¡æœ‰ä¹‹ä¸€ï¼‰å°±æ˜¯åˆ†å±‚ï¼Œå¦‚æœä¸€å±‚ä¸å¤Ÿå°±å†åŠ ä¸€å±‚ï¼Œè¿™ç‚¹åœ¨ç½‘ç»œä¸­æ›´æ˜¯ä½“ç°å¾—æ·‹æ¼“å°½è‡´ã€‚OSI æ¨¡å‹ã€TCP/IP æ¨¡å‹å°†ç½‘ç»œä»ç‰©ç†ç‰¹æ€§ï¼ˆæ¯”ç‰¹æµï¼‰å¼€å§‹ï¼Œé€å±‚å°è£…éš”ç¦»ï¼Œåˆ°äº† HTTP åè®®è¿™ç§é¢å‘åº”ç”¨çš„åè®®é‡Œï¼Œä½¿ç”¨è€…å°±å·²ç»ä¸ä¼šå»å…³å¿ƒç½‘å¡/äº¤æ¢æœºå¦‚ä½•å¤„ç†æ•°æ®å¸§ã€MAC åœ°å€ï¼›ä¸ä¼šå»å…³å¿ƒ ARP å¦‚ä½•åšåœ°å€è½¬æ¢ï¼›ä¸ä¼šå»å…³å¿ƒIPå¯»å€ã€TCP ä¼ è¾“æ§åˆ¶ç­‰ç»†èŠ‚ã€‚æƒ³è¦åœ¨ç½‘ç»œä¸–ç•Œä¸­è®©ç”¨æˆ·æ— æ„ŸçŸ¥åœ°å®ç°å®‰å…¨é€šä¿¡ï¼Œæœ€åˆç†çš„åšæ³•å°±æ˜¯åœ¨ä¼ è¾“å±‚ä¹‹ä¸Šã€åº”ç”¨å±‚ä¹‹ä¸‹åŠ å…¥ä¸“é—¨çš„å®‰å…¨å±‚æ¥å®ç°ï¼Œè¿™æ ·å¯¹ä¸Šå±‚åŸæœ¬åŸºäº HTTP çš„ Web åº”ç”¨æ¥è¯´ï¼Œå½±å“ç”šè‡³æ˜¯æ— æ³•å¯Ÿè§‰çš„ã€‚æ„å»ºä¼ è¾“å®‰å…¨å±‚çš„è¿™ä¸ªæƒ³æ³•ï¼Œå‡ ä¹å¯ä»¥è¯´æ˜¯å’Œä¸‡ç»´ç½‘çš„å†å²ä¸€æ ·é•¿ï¼Œæ—©åœ¨1994å¹´ï¼Œå°±å·²ç»æœ‰å…¬å¸å¼€å§‹ç€æ‰‹å»å®è·µäº†ã€‚\n\n1994å¹´ï¼Œç½‘æ™¯ï¼ˆNetscapeï¼‰å…¬å¸å¼€å‘äº†SSLåè®®ï¼ˆSecure Sockets Layerï¼‰çš„1.0ç‰ˆï¼Œè¿™æ˜¯æ„å»ºä¼ è¾“å®‰å…¨å±‚çš„èµ·æºï¼Œä½†æ˜¯SSL1.0ä»æœªæ­£å¼å¯¹å¤–å‘å¸ƒè¿‡ã€‚\n1995å¹´ï¼ŒNetscape æŠŠ SSL å‡çº§åˆ° 2.0 ç‰ˆï¼Œæ­£å¼å¯¹å¤–å‘å¸ƒï¼Œä½†æ˜¯åˆšåˆšå‘å¸ƒä¸ä¹…å°±è¢«å‘ç°æœ‰ä¸¥é‡æ¼æ´ï¼Œæ‰€ä»¥å¹¶æœªå¤§è§„æ¨¡ä½¿ç”¨ã€‚\n1996å¹´ï¼Œä¿®è¡¥å¥½æ¼æ´çš„ SSL3.0 å¯¹å¤–å‘å¸ƒï¼Œè¿™ä¸ªç‰ˆæœ¬å¾—åˆ°äº†å¹¿æ³›åº”ç”¨ï¼Œå¾ˆå¿«æˆä¸ºWebç½‘ç»œå®‰å…¨å±‚çš„äº‹å®æ ‡å‡†ã€‚\n1999å¹´ï¼Œäº’è”ç½‘æ ‡å‡†åŒ–ç»„ç»‡æ¥æ›¿ Netscapeï¼Œå°† SSL æ”¹åä¸º TLSï¼ˆTransport Layer Securityï¼‰åä½œä¸ºä¼ è¾“å®‰å…¨å±‚çš„å›½é™…æ ‡å‡†ã€‚ç¬¬ä¸€ä¸ªæ­£å¼çš„ç‰ˆæœ¬æ˜¯ RFC 2246 å®šä¹‰çš„ TLS1.0ï¼Œè¯¥ç‰ˆ TLS çš„ç”Ÿå‘½å‘¨æœŸæé•¿ï¼Œç›´è‡³ç¬”è€…å†™ä¸‹è¿™æ®µæ–‡å­—çš„ 2020 å¹´ 3 æœˆï¼Œä¸»æµæµè§ˆå™¨ï¼ˆChromeã€Firefoxã€IEã€Safariï¼‰æ‰åˆšåˆšå®£å¸ƒåŒæ—¶åœæ­¢å¯¹ TLS1.0/.1 çš„æ”¯æŒã€‚è€Œè®½åˆºçš„æ˜¯ï¼Œç”±äºåœæ­¢åè®¸å¤šæ”¿åºœç½‘ç«™è¢«æ— æ³•è¢«æµè§ˆï¼Œæ­¤æ—¶åˆæ­£å€¼æ–°å† è‚ºç‚ç–«æƒ…ï¼ˆCOVID-19ï¼‰çˆ†å‘æœŸï¼ŒFirefox ç´§æ€¥å‘å¸ƒå…¬å‘Šå®£å¸ƒæ’¤å›è¯¥æ”¹åŠ¨ï¼ŒTLS1.0 çš„ç”Ÿå‘½è¿˜åœ¨é¡½å¼ºå»¶ç»­ã€‚\n2006å¹´ï¼ŒTLS çš„ç¬¬ä¸€ä¸ªå‡çº§ç‰ˆ 1.1 å‘å¸ƒï¼ˆRFC4346ï¼‰ï¼Œä½†å´æ²¦ä¸ºè¢«é—å¿˜çš„å­©å­ï¼Œå¾ˆå°‘äººä½¿ç”¨ï¼Œç”šè‡³åˆ°äº† TLS1.1 ä»æ¥æ²¡æœ‰å·²çŸ¥çš„åè®®æ¼æ´è¢«æå‡ºçš„ç¨‹åº¦ã€‚\n2008å¹´ï¼Œåœ¨ TLS1.1 å‘å¸ƒ 2 å¹´ä¹‹åï¼ŒTLS1.2 æ ‡å‡†å‘å¸ƒï¼ˆRFC5246ï¼‰ï¼Œè¿„ä»Šè¶…è¿‡90ï¼…çš„äº’è”ç½‘HTTPSæµé‡æ˜¯ç”± TLS1.2 æ‰€æ”¯æŒçš„ï¼Œç°åœ¨ä»åœ¨ä½¿ç”¨çš„æµè§ˆå™¨å‡ ä¹éƒ½å®Œç¾æ”¯æŒäº†è¯¥åè®®ã€‚\n2018å¹´ï¼Œæœ€æ–°çš„ TLS1.3ï¼ˆRFC8446ï¼‰å‘å¸ƒï¼Œæ¯”èµ·å‰é¢ç‰ˆæœ¬ç›¸å¯¹æ¸©å’Œçš„å‡çº§ï¼ŒTLS1.3 åšå‡ºäº†ä¸€äº›æ¿€çƒˆçš„æ”¹åŠ¨ï¼Œä¿®æ”¹äº†ä» 1.0 èµ·ä¸€ç›´æ²¡æœ‰å¤§å˜åŒ–çš„ä¸¤è½®å››æ¬¡ï¼ˆ2-RTTï¼‰æ¡æ‰‹ï¼Œé¦–æ¬¡è¿æ¥ä»…éœ€ä¸€è½®ï¼ˆ1-RTTï¼‰æ¡æ‰‹å³å¯å®Œæˆï¼Œåœ¨è¿æ¥å¤ç”¨æ”¯æŒæ—¶ï¼Œç”šè‡³å°† TLS1.2 åŸæœ¬çš„ 1-RTT ä¸‹é™åˆ° 0-RTTï¼Œæ˜¾è‘—æå‡äº†è®¿é—®é€Ÿåº¦ã€‚\n\næ¥ä¸‹æ¥ï¼Œç¬”è€…ä»¥ TLS1.2 ä¸ºä¾‹ï¼Œä»‹ç»ä¼ è¾“å®‰å…¨å±‚æ˜¯å¦‚ä½•ä¿éšœæ‰€æœ‰ä¿¡æ¯éƒ½æ˜¯ç¬¬ä¸‰æ–¹æ— æ³•çªƒå¬ï¼ˆåŠ å¯†ä¼ è¾“ï¼‰ã€æ— æ³•ç¯¡æ”¹ï¼ˆä¸€æ—¦ç¯¡æ”¹é€šä¿¡ç®—æ³•ä¼šç«‹åˆ»å‘ç°ï¼‰ã€æ— æ³•å†’å……ï¼ˆè¯ä¹¦éªŒè¯èº«ä»½ï¼‰çš„ã€‚TLS1.2 åœ¨ä¼ è¾“ä¹‹å‰çš„æ¡æ‰‹è¿‡ç¨‹ä¸€å…±éœ€è¦è¿›è¡Œä¸Šä¸‹ä¸¤è½®ã€å…±è®¡å››æ¬¡é€šä¿¡ï¼Œæ—¶åºå›¾å¦‚å›¾\n\n1ï¼‰å®¢æˆ·ç«¯è¯·æ±‚ï¼šClient Helloå®¢æˆ·ç«¯å‘æœåŠ¡å™¨è¯·æ±‚è¿›è¡ŒåŠ å¯†é€šä¿¡ï¼Œåœ¨è¿™ä¸ªè¯·æ±‚é‡Œé¢ï¼Œå®ƒä¼šä»¥ æ˜æ–‡ çš„å½¢å¼ï¼Œå‘æœåŠ¡å™¨ç«¯æä¾›ä»¥ä¸‹ä¿¡æ¯ã€‚\n\næ”¯æŒçš„åè®®ç‰ˆæœ¬ï¼Œå¦‚ TLS1.2ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œ1.0 è‡³ 3.0 åˆ†åˆ«ä»£è¡¨ SSL1.0 è‡³ 3.0ï¼ŒTLS1.0 åˆ™æ˜¯ 3.1ï¼Œä¸€ç›´åˆ° TLS1.3 çš„ 3.4ã€‚\nä¸€ä¸ªå®¢æˆ·ç«¯ç”Ÿæˆçš„ 32 å­—èŠ‚éšæœºæ•°ï¼Œè¿™ä¸ªéšæœºæ•°å°†ç¨åç”¨äºäº§ç”ŸåŠ å¯†çš„å¯†é’¥ã€‚\nä¸€ä¸ªå¯é€‰çš„ SessionlDï¼Œæ³¨æ„ä¸è¦å’Œå‰é¢çš„ Cookie-Session æœºåˆ¶æ··æ·†äº†ï¼Œè¿™ä¸ª SessionlD æ˜¯æŒ‡ä¼ è¾“å®‰å…¨å±‚çš„ Sessionï¼Œæ˜¯ä¸ºäº† TLS çš„è¿æ¥å¤ç”¨è€Œè®¾è®¡çš„ã€‚\nä¸€ç³»åˆ—æ”¯æŒçš„å¯†ç å­¦ç®—æ³•å¥—ä»¶ï¼Œä¾‹å¦‚ TLS_RSA_WITH AES128 GCM_SHA256ï¼Œä»£è¡¨å¯†é’¥äº¤æ¢ç®—æ³•æ˜¯ RSAï¼ŒåŠ å¯†ç®—æ³•æ˜¯ AES128-GCMï¼Œæ¶ˆæ¯è®¤è¯ç ç®—æ³•æ˜¯ SHA256\nä¸€ç³»åˆ—æ”¯æŒçš„æ•°æ®å‹ç¼©ç®—æ³•ã€‚\nå…¶ä»–å¯æ‰©å±•çš„ä¿¡æ¯ï¼Œä¸ºäº†ä¿è¯åè®®çš„ç¨³å®šæ€§ï¼Œåç»­å¯¹åè®®çš„åŠŸèƒ½æ‰©å±•å¤§å¤šéƒ½æ·»åŠ åˆ°è¿™ä¸ªå˜é•¿ç»“æ„ä¸­ã€‚è­¬å¦‚ TLS1.0 ä¸­ç”±äºå‘é€çš„æ•°æ®å¹¶ä¸åŒ…å«æœåŠ¡å™¨çš„åŸŸååœ°å€ï¼Œå¯¼è‡´ä¸€å°æœåŠ¡å™¨åªèƒ½å®‰è£…ä¸€å¼ æ•°å­—è¯ä¹¦ï¼Œè¿™å¯¹è™šæ‹Ÿä¸»æœºæ¥è¯´å¾ˆä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥ TLS1.1 èµ·å°±å¢åŠ äº†åä¸º â€œServer Nameâ€ çš„æ‰©å±•ä¿¡æ¯ï¼Œä»¥ä¾¿ä¸€å°æœåŠ¡å™¨ç»™ä¸åŒçš„ç«™ç‚¹å®‰è£…ä¸åŒçš„è¯ä¹¦ã€‚\n\n2ï¼‰æœåŠ¡å™¨å›åº”ï¼šServer HelloæœåŠ¡å™¨æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„é€šä¿¡è¯·æ±‚åï¼Œå¦‚æœå®¢æˆ·ç«¯å£°æ˜æ”¯æŒçš„åè®®ç‰ˆæœ¬å’ŒåŠ å¯†ç®—æ³•ç»„åˆä¸æœåŠ¡ç«¯ç›¸åŒ¹é…çš„è¯ï¼Œå°±å‘å®¢æˆ·ç«¯å‘å‡ºå›åº”ã€‚å¦‚æœä¸åŒ¹é…ï¼Œå°†ä¼šè¿”å›ä¸€ä¸ªæ¡æ‰‹å¤±è´¥çš„è­¦å‘Šæç¤ºã€‚è¿™æ¬¡å›åº”åŒæ ·ä»¥æ˜æ–‡å‘é€ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ã€‚\n\næœåŠ¡ç«¯ç¡®è®¤ä½¿ç”¨çš„ TLS åè®®ç‰ˆæœ¬ã€‚\nç¬¬äºŒä¸ª 32 å­—èŠ‚çš„éšæœºæ•°ï¼Œç¨åç”¨äºäº§ç”ŸåŠ å¯†çš„å¯†é’¥ã€‚\nä¸€ä¸ª SessionIDï¼Œä»¥åå¯é€šè¿‡è¿æ¥å¤ç”¨å‡å°‘ä¸€è½®æ¡æ‰‹ã€‚\næœåŠ¡ç«¯åœ¨åˆ—è¡¨ä¸­é€‰å®šçš„å¯†ç å­¦ç®—æ³•å¥—ä»¶ã€‚\næœåŠ¡ç«¯åœ¨åˆ—è¡¨ä¸­é€‰å®šçš„æ•°æ®å‹ç¼©ç®—æ³•ã€‚\nå…¶ä»–å¯æ‰©å±•çš„ä¿¡æ¯ã€‚\nå¦‚æœåå•†å‡ºçš„åŠ å¯†ç®—æ³•ç»„åˆæ˜¯ä¾èµ–è¯ä¹¦è®¤è¯çš„ï¼ŒæœåŠ¡ç«¯è¿˜è¦å‘é€å‡ºè‡ªå·±çš„ X.509 è¯ä¹¦ï¼Œè€Œè¯ä¹¦ä¸­çš„å…¬é’¥æ˜¯ä»€ä¹ˆï¼Œä¹Ÿå¿…é¡»æ ¹æ®åå•†çš„åŠ å¯†ç®—æ³•ç»„åˆæ¥å†³å®šã€‚\nå¯†é’¥åå•†æ¶ˆæ¯ï¼Œè¿™éƒ¨åˆ†å†…å®¹å¯¹äºä¸åŒå¯†ç å­¦å¥—ä»¶æœ‰ç€ä¸åŒçš„ä»·å€¼ï¼Œè­¬å¦‚å¯¹äº ECDH + anon è¿™æ ·çš„å¯†é’¥åå•†ç®—æ³•ç»„åˆï¼ˆåŸºäºæ¤­åœ†æ›²çº¿çš„ ECDH ç®—æ³•å¯ä»¥åœ¨åŒæ–¹é€šä¿¡éƒ½å…¬å¼€çš„æƒ…å†µä¸‹åå•†å‡ºä¸€ç»„åªæœ‰é€šä¿¡åŒæ–¹çŸ¥é“çš„å¯†é’¥ï¼‰å°±ä¸éœ€è¦ä¾èµ–è¯ä¹¦ä¸­çš„å…¬é’¥ï¼Œè€Œæ˜¯é€šè¿‡ Server Key Exchange æ¶ˆæ¯åå•†å‡ºå¯†é’¥ã€‚\n\n3ï¼‰å®¢æˆ·ç«¯ç¡®è®¤ï¼šClient Handshake Finishedç”±äºå¯†ç å­¦å¥—ä»¶çš„ç»„åˆå¤æ‚å¤šæ ·ï¼Œè¿™é‡Œä»…ä»¥ RSA ç®—æ³•ä¸ºå¯†é’¥äº¤æ¢ç®—æ³•ä¸ºä¾‹ä»‹ç»åç»­è¿‡ç¨‹ã€‚\nå®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡å™¨åº”ç­”åï¼Œå…ˆè¦éªŒè¯æœåŠ¡å™¨çš„è¯ä¹¦åˆæ³•æ€§ã€‚å¦‚æœè¯ä¹¦ä¸æ˜¯å¯ä¿¡æœºæ„é¢å¸ƒçš„ï¼Œæˆ–è€…è¯ä¹¦ä¸­ä¿¡æ¯å­˜åœ¨é—®é¢˜ï¼Œè­¬å¦‚åŸŸåä¸å®é™…åŸŸåä¸ä¸€è‡´ã€è¯ä¹¦å·²ç»è¿‡æœŸã€é€šè¿‡åœ¨çº¿è¯ä¹¦çŠ¶æ€åè®®å¾—çŸ¥è¯ä¹¦å·²è¢«åŠé”€ï¼Œç­‰ç­‰ï¼Œéƒ½ä¼šå‘è®¿é—®è€…æ˜¾ç¤ºä¸€ä¸ª â€œè¯ä¹¦ä¸å¯ä¿¡ä»»â€ çš„è­¦å‘Šï¼Œç”±ç”¨æˆ·è‡ªè¡Œé€‰æ‹©æ˜¯å¦è¿˜è¦ç»§ç»­é€šä¿¡ã€‚å¦‚æœè¯ä¹¦æ²¡æœ‰é—®é¢˜ï¼Œå®¢æˆ·ç«¯å°±ä¼šä»è¯ä¹¦ä¸­å–å‡ºæœåŠ¡å™¨çš„å…¬é’¥ï¼Œå¹¶å‘æœåŠ¡å™¨å‘é€ä»¥ä¸‹ä¿¡æ¯ã€‚\n\nå®¢æˆ·ç«¯è¯ä¹¦ï¼ˆå¯é€‰ï¼‰ã€‚éƒ¨åˆ†æœåŠ¡ç«¯å¹¶ä¸æ˜¯é¢å‘å…¨å…¬ä¼—ï¼Œè€Œæ˜¯åªå¯¹ç‰¹å®šçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯éœ€è¦å‘é€å®ƒè‡ªèº«çš„è¯ä¹¦æ¥è¯æ˜èº«ä»½ã€‚å¦‚æœä¸å‘é€ï¼Œæˆ–è€…éªŒè¯ä¸é€šè¿‡ï¼ŒæœåŠ¡ç«¯å¯è‡ªè¡Œå†³å®šæ˜¯å¦è¦ç»§ç»­æ¡æ‰‹ï¼Œæˆ–è€…è¿”å›ä¸€ä¸ªæ¡æ‰‹å¤±è´¥çš„ä¿¡æ¯ã€‚å®¢æˆ·ç«¯éœ€è¦è¯ä¹¦çš„ TLS é€šä¿¡ä¹Ÿç§°ä¸º â€œåŒå‘TLSâ€ï¼ˆMutual TLSï¼Œå¸¸ç®€å†™ä¸º mTLSï¼‰è¿™æ˜¯äº‘åŸç”ŸåŸºç¡€è®¾æ–½çš„ä¸»è¦è®¤è¯æ–¹æ³•ï¼Œä¹Ÿæ˜¯åŸºäºä¿¡é“è®¤è¯çš„æœ€ä¸»æµå½¢å¼ã€‚\nç¬¬ä¸‰ä¸ª 32 å­—èŠ‚çš„éšæœºæ•°ï¼Œè¿™ä¸ªéšæœºæ•°ä¸å†æ˜¯æ˜æ–‡å‘é€ï¼Œè€Œæ˜¯ä»¥æœåŠ¡ç«¯ä¼ è¿‡æ¥çš„å…¬é’¥åŠ å¯†ï¼Œè¢«ç§°ä¸º PreMasterSecretï¼Œå®ƒå°†ä¸å‰ä¸¤æ¬¡å‘é€çš„éšæœºæ•°ä¸€èµ·ï¼Œæ ¹æ®ç‰¹å®šç®—æ³•è®¡ç®—å‡º 48 å­—èŠ‚çš„ MasterSecretï¼Œè¿™ä¸ª MasterSecretI å³åç»­å†…å®¹ä¼ è¾“æ—¶çš„å¯¹ç§°åŠ å¯†ç®—æ³•æ‰€é‡‡ç”¨çš„ç§é’¥ã€‚\nç¼–ç æ”¹å˜é€šçŸ¥ã€è¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹æ³•å’Œå¯†é’¥å‘é€ã€‚\nå®¢æˆ·ç«¯æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶ä¹Ÿæ˜¯å‰é¢å‘é€çš„æ‰€æœ‰å†…å®¹çš„å“ˆå¸Œå€¼ï¼Œä»¥ä¾›æœåŠ¡å™¨æ ¡éªŒã€‚\n\n4ï¼‰æœåŠ¡ç«¯ç¡®è®¤ï¼šServer Handshake FinishedæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯å›åº”æœ€åçš„ç¡®è®¤é€šçŸ¥ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ä¿¡æ¯ã€‚\n\nç¼–ç æ”¹å˜é€šçŸ¥ï¼Œè¡¨ç¤ºéšåçš„ä¿¡æ¯éƒ½å°†ç”¨åŒæ–¹å•†å®šçš„åŠ å¯†æ–¹æ³•å’Œå¯†é’¥å‘é€ã€‚\n\næœåŠ¡å™¨æ¡æ‰‹ç»“æŸé€šçŸ¥ï¼Œè¡¨ç¤ºæœåŠ¡å™¨çš„æ¡æ‰‹é˜¶æ®µå·²ç»ç»“æŸã€‚è¿™ä¸€é¡¹åŒæ—¶ä¹Ÿæ˜¯å‰é¢å‘é€çš„æ‰€æœ‰å†…å®¹çš„å“ˆå¸Œå€¼ï¼Œä»¥ä¾›å®¢æˆ·ç«¯æ ¡éªŒã€‚\n\n\nè‡³æ­¤ï¼Œæ•´ä¸ª TLS æ¡æ‰‹é˜¶æ®µå®£å‘Šå®Œæˆï¼Œä¸€ä¸ªå®‰å…¨çš„è¿æ¥å°±å·²æˆåŠŸå»ºç«‹ã€‚æ¯ä¸€ä¸ªè¿æ¥å»ºç«‹æ—¶ï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å‡é€šè¿‡ä¸Šé¢çš„æ¡æ‰‹è¿‡ç¨‹åå•†å‡ºäº†è®¸å¤šä¿¡æ¯ï¼Œè­¬å¦‚ä¸€ä¸ªåªæœ‰åŒæ–¹æ‰çŸ¥é“çš„éšæœºäº§ç”Ÿçš„å¯†é’¥ã€ä¼ è¾“è¿‡ç¨‹ä¸­è¦é‡‡ç”¨çš„å¯¹ç§°åŠ å¯†ç®—æ³•ï¼ˆä¾‹å­ä¸­çš„AES128ï¼‰ã€å‹ç¼©ç®—æ³•ç­‰ï¼Œæ­¤åè¯¥è¿æ¥çš„é€šä¿¡å°†ä½¿ç”¨æ­¤å¯†é’¥å’ŒåŠ å¯†ç®—æ³•è¿›è¡ŒåŠ å¯†ã€è§£å¯†å’Œå‹ç¼©ã€‚è¿™ç§å¤„ç†æ–¹å¼å¯¹ä¸Šå±‚åè®®çš„åŠŸèƒ½æ˜¯å®Œå…¨é€æ˜çš„ï¼Œè™½ç„¶åœ¨ä¼ è¾“æ€§èƒ½ä¸Šä¼šæœ‰ä¸‹é™ï¼Œä½†åœ¨åŠŸèƒ½ä¸Šå®Œå…¨ä¸ä¼šæ„ŸçŸ¥åˆ°TSçš„å­˜åœ¨ã€‚å»ºç«‹åœ¨è¿™å±‚ä¼ è¾“å®‰å…¨å±‚ä¹‹ä¸Šçš„ HTTP åè®®ï¼Œè¢«ç§°ä¸º â€œHTTP over SSL/TLSâ€ï¼Œä¹Ÿå³å¤§å®¶æ‰€ç†ŸçŸ¥çš„HTTPSã€‚\nä»ä¸Šé¢æ¡æ‰‹åå•†çš„è¿‡ç¨‹ä¸­æˆ‘ä»¬è¿˜å¯ä»¥å¾—çŸ¥ï¼ŒHTTPS å¹¶éåªæœ‰ â€œå¯ç”¨äº†HTTPSâ€ å’Œ â€œæœªå¯ç”¨HTTPSâ€ çš„å·®åˆ«ï¼Œé‡‡ç”¨ä¸åŒçš„åè®®ç‰ˆæœ¬ã€ä¸åŒçš„å¯†ç å­¦å¥—ä»¶ï¼Œè¯ä¹¦æ˜¯å¦æœ‰æ•ˆï¼ŒæœåŠ¡ç«¯/å®¢æˆ·ç«¯é¢å¯¹æ— æ•ˆè¯ä¹¦æ—¶çš„å¤„ç†ç­–ç•¥ç­‰éƒ½å¯¼è‡´äº†ä¸åŒ HTTPS ç«™ç‚¹çš„å®‰å…¨å¼ºåº¦çš„ä¸åŒï¼Œå› æ­¤å¹¶ä¸èƒ½è¯´åªè¦å¯ç”¨äº† HTTPS å°±å¿…èƒ½å®‰æ•æ— å¿§ã€‚\nå…­ã€éªŒè¯  æ•°æ®éªŒè¯ä¸ç¨‹åºå¦‚ä½•ç¼–ç æ˜¯å¯†åˆ‡ç›¸å…³çš„ï¼Œè®¸å¤šå¼€å‘è€…éƒ½ä¸ä¼šæŠŠå®ƒå½’å…¥å®‰å…¨çš„èŒƒç•´ä¹‹ä¸­ã€‚ ä½†è¯·ç»†æƒ³ä¸€ä¸‹ï¼Œå…³æ³¨ â€œä½ æ˜¯è°â€ï¼ˆè®¤è¯ï¼‰ã€â€œä½ èƒ½åšä»€ä¹ˆâ€ï¼ˆæˆæƒï¼‰ç­‰é—®é¢˜æ˜¯å¾ˆåˆç†çš„å®‰å…¨ï¼Œå…³æ³¨ â€œä½ åšå¾—å¯¹ä¸å¯¹â€ï¼ˆéªŒè¯ï¼‰ä¸ä¹ŸåŒæ ·åˆç†å—ï¼Ÿä»æ•°é‡æ¥è®²ï¼Œæ•°æ®éªŒè¯ä¸ä¸¥è°¨è€Œå¯¼è‡´çš„å®‰å…¨é—®é¢˜æ¯”å…¶ä»–å®‰å…¨æ”»å‡»å¯¼è‡´çš„å®‰å…¨é—®é¢˜è¦å¤šå¾—å¤šï¼›è€Œä»é£é™©ä¸Šè®²ï¼Œç”±æ•°æ®è´¨é‡å¯¼è‡´çš„é—®é¢˜ï¼Œé£é™©æœ‰é«˜æœ‰ä½ï¼ŒçœŸé‡åˆ°é«˜é£é™©çš„æ•°æ®é—®é¢˜æ—¶ï¼Œé¢ä¸´çš„æŸå¤±ä¸ä¸€å®šå°±æ¯”è¢«é»‘å®¢æ‹–åº“æ¥å¾—å°ã€‚ç›¸æ¯”å…¶ä»–å¯Œæœ‰æŒ‘æˆ˜æ€§çš„å®‰å…¨æªæ–½ï¼Œå¦‚é˜²å¾¡ä¸æ”»å‡»ä¸¤è€…ç¼ æ–—çš„ç²¾å½©ï¼Œæ•°å­¦ã€å¿ƒç†ã€ç¤¾ä¼šå·¥ç¨‹å’Œè®¡ç®—æœºç­‰è·¨å­¦ç§‘çŸ¥è¯†çš„ç»“åˆè¿ç”¨ï¼Œæ•°æ®éªŒè¯ç¡®å®æœ‰äº›æ— èŠã€æ¯ç‡¥ï¼Œè¿™é¡¹å¸¸è§„çš„å·¥ä½œåœ¨æ—¥å¸¸çš„å¼€å‘ä¸­è´¯ç©¿äºä»£ç çš„å„ä¸ªå±‚æ¬¡ï¼Œæ¯ä¸ªç¨‹åºå‘˜éƒ½è‚¯å®šå†™è¿‡ã€‚ä½†è¿™ç§å¸¸è§çš„ä»£ç åè€Œæ˜¯è¿«åˆ‡éœ€è¦è¢«æ¶æ„çº¦æŸçš„ï¼Œç¼ºå¤±çš„æ ¡éªŒå½±å“æ•°æ®è´¨é‡ï¼Œè¿‡åº¦çš„æ ¡éªŒä¸ä¼šä½¿å¾—ç³»ç»Ÿæ›´åŠ å¥å£®ï¼ŒæŸç§æ„ä¹‰ä¸Šåè€Œä¼šåˆ¶é€ åƒåœ¾ä»£ç ï¼Œç”šè‡³å¸¦æ¥å‰¯ä½œç”¨ã€‚è¯·æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªå®é™…çš„æ®µå­ã€‚\n\nå‰ç«¯ï¼šæäº¤ä¸€ä»½ç”¨æˆ·æ•°æ®ï¼ˆå§“åï¼šæŸï¼Œæ€§åˆ«ï¼šç”·ï¼Œçˆ±å¥½ï¼šå¥³ï¼Œç­¾åï¼šxxxï¼Œæ‰‹æœºï¼šxxxï¼Œé‚®ç®±ï¼šnullï¼‰æ§åˆ¶å™¨ï¼šå‘ç°é‚®ç®±æ˜¯ç©ºçš„ï¼ŒæŠ› ValidationExceptionï¼ˆï¼‚é‚®ç®±æ²¡å¡«ï¼‚ï¼‰å‰ç«¯ï¼šå·²ä¿®æ”¹ï¼Œé‡æ–°æäº¤å®‰å…¨ï¼šå‘é€éªŒè¯ç æ—¶å‘ç°æ‰‹æœºå·å°‘ä¸€ä½ï¼ŒæŠ› RemoteInvokeExceptionï¼ˆï¼‚æ— æ³•å‘é€éªŒè¯ç â€ï¼‰å‰ç«¯ï¼šå·²ä¿®æ”¹ï¼Œé‡æ–°æäº¤æœåŠ¡å±‚ï¼šé‚®ç®±æ€ä¹ˆæœ‰é‡å¤å•Šï¼ŒæŠ› BusinessRuntimeExceptionï¼ˆï¼‚ä¸å…è®¸å¼€å°å·ï¼‚ï¼‰å‰ç«¯ï¼šå·²ä¿®æ”¹ï¼Œé‡æ–°æäº¤æŒä¹…å±‚ï¼šç­¾åå­—æ®µè¶…é•¿äº†æ’ä¸è¿›å»ï¼ŒæŠ› SQLExceptionï¼ˆï¼‚æ’å…¥æ•°æ®åº“å¤±è´¥ï¼ŒSQL:xxxï¼‚ï¼‰å‰ç«¯ï¼šä½ ä»¬è¿™äº›ç®¡æŒ–å‘ä¸ç®¡åŸ‹çš„åç«¯ï¼Œå„ç§å¼‚å¸¸éƒ½å¾€å‰æŠ›ï¼ç”¨æˆ·ï¼šè¿™ç³»ç»Ÿç‰™è†å‚ç”Ÿäº§çš„ï¼Ÿ\n\næœ€åŸºç¡€çš„æ•°æ®é—®é¢˜å¯ä»¥åœ¨å‰ç«¯åšè¡¨å•æ ¡éªŒæ¥å¤„ç†ï¼Œä½†æœåŠ¡ç«¯éªŒè¯è‚¯å®šä¹Ÿæ˜¯è¦åšçš„ï¼Œçœ‹å®Œäº†ä¸Šé¢çš„æ®µå­åï¼Œé‚£ä¹ˆæœåŠ¡ç«¯åº”è¯¥åœ¨å“ªä¸€å±‚åšæ ¡éªŒå‘¢ï¼Ÿå¯èƒ½ä¼šæœ‰è¿™æ ·çš„ç­”æ¡ˆã€‚\n\nåœ¨æ§åˆ¶å™¨å±‚åšï¼Œåœ¨æœåŠ¡å±‚ä¸åšã€‚ç†ç”±æ˜¯ä»æœåŠ¡å¼€å§‹ä¼šæœ‰åŒçº§é‡ç”¨ï¼Œå‡ºç° ServiceA.foo(params) è°ƒç”¨ ServiceB.bar(params) æ—¶ï¼Œå°±ä¼šå¯¹ params é‡å¤æ ¡éªŒä¸¤æ¬¡ã€‚\nåœ¨æœåŠ¡å±‚åšï¼Œåœ¨æ§åˆ¶å™¨å±‚ä¸åšã€‚ç†ç”±æ˜¯æ— ä¸šåŠ¡å«ä¹‰çš„æ ¼å¼æ ¡éªŒå·²åœ¨å‰ç«¯è¡¨å•éªŒè¯å¤„ç†è¿‡ï¼Œæœ‰ä¸šåŠ¡å«ä¹‰çš„æ ¡éªŒï¼Œæ”¾åœ¨æ§åˆ¶å™¨å±‚æ— è®ºå¦‚ä½•éƒ½ä¸åˆé€‚ã€‚\nåœ¨æ§åˆ¶å™¨å±‚ã€æœåŠ¡å±‚å„åšå„çš„ã€‚æ§åˆ¶å™¨å±‚åšæ ¼å¼æ ¡éªŒï¼ŒæœåŠ¡å±‚åšä¸šåŠ¡æ ¡éªŒï¼Œå¬èµ·æ¥å¾ˆåˆç†ï¼Œä½†è¿™å…¶å®å°±æ˜¯ä¸Šé¢æ®µå­ä¸­è¢«å˜²ç¬‘çš„è¡Œä¸ºã€‚\nè¿˜æœ‰å…¶ä»–ä¸€äº›æ„è§ï¼Œè­¬å¦‚åœ¨æŒä¹…å±‚åšæ ¡éªŒï¼Œç†ç”±æ˜¯æŒä¹…å±‚æ˜¯æœ€ç»ˆå…¥å£ï¼ŒæŠŠå®ˆå¥½å†™å…¥æ•°æ®åº“çš„è´¨é‡æœ€é‡è¦ã€‚\n\nä¸Šè¿°çš„è®¨è®ºå¤§æ¦‚ä¸ä¼šæœ‰ç»Ÿä¸€ã€æ­£ç¡®çš„ç»“è®ºï¼Œä½†æ˜¯åœ¨ Java é‡Œç¡®å®æœ‰éªŒè¯çš„æ ‡å‡†åšæ³•ï¼Œç¬”è€…æå€¡çš„åšæ³•æ˜¯æŠŠæ ¡éªŒè¡Œä¸ºä»åˆ†å±‚ä¸­å‰¥ç¦»å‡ºæ¥ï¼Œä¸æ˜¯åœ¨å“ªä¸€å±‚åšï¼Œè€Œæ˜¯åœ¨ Bean ä¸Šåšï¼Œå³ Java Bean Validationã€‚ä» 2009 å¹´ JSR 303 çš„ 1.0ï¼Œåˆ° 2013 å¹´ JSR 349 æ›´æ–°çš„ 1.1ï¼Œåˆ°ç›®å‰æœ€æ–°çš„ 2017 å¹´å‘å¸ƒçš„ JSR 380ï¼Œå‡å®šä¹‰äº† Bean éªŒè¯çš„å…¨å¥—è§„èŒƒã€‚å•ç‹¬å°†éªŒè¯æå–ã€å°è£…ï¼Œå¯ä»¥è·å¾—ä¸å°‘å¥½å¤„ï¼š\n\nå¯¹äºæ— ä¸šåŠ¡å«ä¹‰çš„æ ¼å¼éªŒè¯ï¼Œå¯ä»¥åšåˆ°é¢„ç½®ã€‚\n\nå¯¹äºæœ‰ä¸šåŠ¡å«ä¹‰çš„ä¸šåŠ¡éªŒè¯ï¼Œå¯ä»¥åšåˆ°é‡ç”¨ï¼Œä¸€ä¸ªBeanè¢«å¤šä¸ªæ–¹æ³•ç”¨ä½œå‚æ•°æˆ–è¿”å›å€¼æ˜¯å¾ˆå¸¸è§çš„ï¼Œé’ˆå¯¹Beanåšæ ¡éªŒæ¯”é’ˆå¯¹æ–¹æ³•åšæ ¡éªŒæ›´æœ‰ä»·å€¼ã€‚\n\nåˆ©äºé›†ä¸­ç®¡ç†ï¼Œè‡‚å¦‚ç»Ÿä¸€è®¤è¯çš„å¼‚å¸¸ä½“ç³»ï¼Œç»Ÿä¸€åšå›½é™…åŒ–ã€ç»Ÿä¸€ç»™å®¢æˆ·ç«¯çš„è¿”å›æ ¼å¼ï¼Œç­‰ç­‰ã€‚\n\né¿å…å¯¹è¾“å…¥æ•°æ®çš„é˜²å¾¡æ±¡æŸ“åˆ°ä¸šåŠ¡ä»£ç ï¼Œå¦‚æœä½ çš„ä»£ç é‡Œæœ‰å¾ˆå¤šä¸‹é¢è¿™æ ·çš„æ¡ä»¶åˆ¤æ–­ï¼Œå°±åº”è¯¥è€ƒè™‘é‡æ„äº†ï¼š\n//ä¸€äº›å·²æ‰§è¡Œçš„é€»è¾‘if (someParam ï¼null) &#123;\tthrow new RuntimeExcetpion(&quot;å®¢å®˜ä¸å¯ä»¥ï¼&quot;)&#125;\nåˆ©äºå¤šä¸ªæ ¡éªŒå™¨ç»Ÿä¸€æ‰§è¡Œï¼Œç»Ÿä¸€è¿”å›æ ¡éªŒç»“æœï¼Œé¿å…ç”¨æˆ·è¸©åœ°é›·ã€æŒ¤ç‰™è†å¼çš„è¯•é”™ä½“éªŒã€‚\n\n\næ®ç¬”è€…æ‰€çŸ¥ï¼Œå›½å†…çš„é¡¹ç›®ä½¿ç”¨Bean Validationçš„å¹¶ä¸å°‘è§ï¼Œä½†å¤šæ•°ç¨‹åºå‘˜éƒ½åªä½¿ç”¨åˆ°å®ƒçš„å†…ç½®çº¦æŸæ³¨è§£ï¼ˆBuilt-In Constraintï¼‰æ¥åšä¸€äº›ä¸ä¸šåŠ¡é€»è¾‘æ— å…³çš„é€šç”¨æ ¡éªŒï¼Œå³ä¸‹é¢è¿™å †æ³¨è§£ï¼š\nï¼ Nullã€ï¼ NotNullã€ï¼ AssertTrueã€ï¼ AssertFalseã€ï¼ Minã€ï¼ Maxã€DecimalMinã€ï¼ DecimalMaxã€ï¼ Negativeã€ï¼ NegativeOrZeroã€ï¼ Positiveã€ï¼ PositiveorZeorã€ï¼ Szieã€ï¼ Digitsã€ï¼ Passã€ï¼ PastorPresentã€ï¼ Futureã€ï¼ FutureOrPresentã€ï¼ Patternã€ï¼ NotEmptyã€NotBlankã€ï¼ Email\n\nä½†æ˜¯ä¸ä¸šåŠ¡ç›¸å…³çš„æ ¡éªŒå¾€å¾€æ‰æ˜¯æœ€å¤æ‚çš„æ ¡éªŒï¼Œå°†ç®€å•çš„æ ¡éªŒäº¤ç»™Bean Validationï¼Œè€ŒæŠŠå¤æ‚çš„æ ¡éªŒç•™ç»™è‡ªå·±ï¼Œè¿™ç®€ç›´æ˜¯ä¹°æ¤Ÿè¿˜ç çš„ç¨‹åºå‘˜ç‰ˆæœ¬ã€‚å…¶å®ä»¥ Bean Validation çš„æ ‡å‡†æ–¹å¼æ¥åšä¸šåŠ¡æ ¡éªŒæ‰æ˜¯éå¸¸ä¼˜é›…çš„ï¼Œä»¥ Fenixï¼‡s Bookstore åœ¨ç”¨æˆ·èµ„æºä¸Šçš„ä¸¤ä¸ªæ–¹æ³•ä¸ºä¾‹ï¼š\n/** * åˆ›å»ºæ–°çš„ç”¨æˆ· */ @POST public Response createUser(@Valid @UniqueAccount Account user) &#123;  return CommonResponse.op(() -&gt; service.createAccount(user));/**  *æ›´æ–°ç”¨æˆ·ä¿¡æ¯  */  @PUT  @CacheEvict(key ï¼ï¼‚ï¼ƒuser.usernameï¼‚ï¼‰  public Response updateUser(@Valid @AuthenticatedAccount @NotConflictAccount Account user) &#123;  \treturn CommonResponse.op(() -&gt; service.updateAccount(user));&#125;\n\næ³¨æ„å…¶ä¸­çš„ä¸‰ä¸ªè‡ªå®šä¹‰æ ¡éªŒæ³¨è§£ï¼Œå®ƒä»¬çš„å«ä¹‰åˆ†åˆ«æ˜¯ï¼š\n\n@UniqueAccountï¼šä¼ äººçš„ç”¨æˆ·å¯¹è±¡å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸ä¸æ•°æ®åº“ä¸­ä»»ä½•å·²æœ‰ç”¨æˆ·çš„åç§°ã€æ‰‹æœºã€é‚®ç®±é‡å¤ã€‚\n@AuthenticatedAccountï¼šä¼ å…¥çš„ç”¨æˆ·å¯¹è±¡å¿…é¡»ä¸å½“å‰ç™»å½•çš„ç”¨æˆ·ä¸€è‡´ã€‚\nï¼ NotConflictAccountï¼šä¼ äººçš„ç”¨æˆ·å¯¹è±¡ä¸­çš„ä¿¡æ¯ä¸å…¶ä»–ç”¨æˆ·æ˜¯æ— å†²çªçš„ï¼Œè­¬å¦‚å°†ä¸€ ä¸ªæ³¨å†Œç”¨æˆ·çš„é‚®ç®±ï¼Œä¿®æ”¹æˆä¸å¦å¤–ä¸€ä¸ªå·²å­˜åœ¨çš„æ³¨å†Œç”¨æˆ·ä¸€è‡´çš„å€¼ï¼Œè¿™ä¾¿æ˜¯å†²çªã€‚\n\nè¿™é‡Œçš„éœ€æ±‚å¾ˆå®¹æ˜“ç†è§£ï¼Œæ³¨å†Œæ–°ç”¨æˆ·æ—¶ï¼Œåº”çº¦æŸä¸ä¸ä»»ä½•å·²æœ‰ç”¨æˆ·çš„å…³é”®ä¿¡æ¯é‡å¤ï¼› è€Œä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯æ—¶ï¼Œåªèƒ½ä¸è‡ªå·±çš„ä¿¡æ¯é‡å¤ï¼Œè€Œä¸”åªèƒ½ä¿®æ”¹å½“å‰ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ã€‚è¿™äº›çº¦æŸè§„åˆ™ä¸ä»…ä»…ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æœåŠ¡ï¼Œè¿˜å¯èƒ½åœ¨ç”¨æˆ·èµ„æºçš„å…¶ä»–å…¥å£è¢«ä½¿ç”¨åˆ°ï¼Œç”šè‡³åœ¨å…¶ä»–åˆ†å±‚çš„ä»£ç ä¸­è¢«ä½¿ç”¨åˆ°ï¼Œåœ¨Beanä¸Šåšæ ¡éªŒå°±èƒ½ä¸€æ½å­åœ°è¦†ç›–ä¸Šè¿°è¿™äº›ä½¿ç”¨åœºæ™¯ã€‚ä¸‹é¢ä»£ç æ˜¯è¿™ä¸‰ä¸ªè‡ªå®šä¹‰æ³¨è§£å¯¹åº”æ ¡éªŒå™¨çš„å®ç°ç±»ï¼š\npublic static class AuthenticatedAccountValidator extends Accountvalidationc&lt;AuthenticatedAccount&gt; &#123;  public void initializeï¼ˆAuthenticatedAccount constraintAnnotation) &#123;    predicate = c -&gt; &#123;      AuthenticAccount loginUser ï¼(AuthenticAccount)        SecurityContextHolder.getContext().getAuthentication()getPrincipal();      return c.getId().equals(loginUser.getId());    &#125;;  &#125;&#125;public static class UniqueAccountValidator extends AccountValidationï¼œUniqueAccountï¼  public void initialize(UniqueAccount constraintAnnotationï¼‰&#123;    predicate = c -&gt; !repository.existsByUsernameOrEmailOrTelephone      (c.getUsername(), c.getEmail(), c.getTelephone());  &#125;&#125;public static class NotConflictAccountValidator extends Accountvalidationï¼œNotConflictAccountï¼  public void initialize(NotConflictAccount constraintAnnotationï¼‰ï½›    predicate = c -&gt; &#123;      Collection&lt;Account&gt; collection repository.findByUsernameOrEmailOrT-elephone(c.getusername(), c.getEmail(), c.getTelephone())ï¼›    //å°†ç”¨æˆ·åã€é‚®ä»¶ã€ç”µè¯æ”¹æˆä¸ç°æœ‰ä¿¡æ¯å®Œå…¨ä¸é‡å¤çš„ï¼Œæˆ–è€…åªä¸è‡ªå·±é‡å¤çš„ï¼Œå°±ä¸ç®—å†²çª    return collection.isEmpty() ||ï¼ˆcollection.size() == 1 &amp;&amp; collection.iterator().next().getId().equals(c.getId()));&#125;;\n\nè¿™æ ·ä¸šåŠ¡æ ¡éªŒä¾¿å’Œä¸šåŠ¡é€»è¾‘å®Œå…¨åˆ†ç¦»å¼€æ¥ï¼Œåœ¨éœ€è¦æ ¡éªŒæ—¶ç”¨ @Valid æ³¨è§£è‡ªåŠ¨è§¦å‘ï¼Œæˆ–è€…é€šè¿‡ä»£ç æ‰‹åŠ¨è§¦å‘æ‰§è¡Œï¼Œå…·ä½“å¯æ ¹æ®å®é™…é¡¹ç›®çš„è¦æ±‚ï¼Œå°†è¿™äº›æ³¨è§£åº”ç”¨äºæ§åˆ¶å™¨ã€æœåŠ¡å±‚ã€æŒä¹…å±‚ç­‰ä»»ä½•å±‚æ¬¡çš„ä»£ç ä¹‹ä¸­ã€‚æ­¤å¤–ï¼Œå¯¹äºæ ¡éªŒç»“æœä¸æ»¡è¶³æ—¶çš„æç¤ºä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç»Ÿä¸€å¤„ç†ï¼Œå¦‚æä¾›é»˜è®¤å€¼ã€å›½é™…åŒ–æ”¯æŒï¼ˆè¿™é‡Œæ²¡åšï¼‰ã€ç»Ÿä¸€çš„å®¢æˆ·ç«¯è¿”å›æ ¼å¼ï¼ˆåˆ›å»ºä¸€ä¸ªç”¨äº ConstraintViolationException çš„å¼‚å¸¸å¤„ç†å™¨æ¥å®ç°ï¼Œä»£ç ä¸­æœ‰ä½†è¿™é‡Œæ²¡æœ‰è´´å‡ºæ¥ï¼‰ï¼Œä»¥åŠæ‰¹é‡æ‰§è¡Œå…¨éƒ¨æ ¡éªŒï¼Œé¿å…ç»™ç”¨æˆ·å¸¦æ¥æŒ¤ç‰™è†å¼çš„ä½“éªŒã€‚\nå¯¹äº Bean ä¸ Bean æ ¡éªŒå™¨ï¼Œç¬”è€…å¦å¤–æœ‰ä¸¤æ¡ç¼–ç å»ºè®®ã€‚ç¬¬ä¸€æ¡æ˜¯å¯¹æ ¡éªŒé¡¹é¢„ç½®å¥½é»˜è®¤çš„æç¤ºä¿¡æ¯ï¼Œè¿™æ ·å½“æ ¡éªŒä¸é€šè¿‡æ—¶ç”¨æˆ·èƒ½è·å¾—æ˜ç¡®çš„ä¿®æ­£æç¤ºï¼Œä»¥ä¸‹æ˜¯ä»£ç ç¤ºä¾‹ï¼š\n/*** è¡¨ç¤ºä¸€ä¸ªç”¨æˆ·çš„ä¿¡æ¯æ˜¯æ— å†²çªçš„* â€œæ— å†²çªâ€æ˜¯æŒ‡è¯¥ç”¨æˆ·çš„æ•æ„Ÿä¿¡æ¯ä¸å…¶ä»–ç”¨æˆ·ä¸é‡åˆï¼Œå¦‚å°†ä¸€ä¸ªæ³¨å†Œç”¨æˆ·çš„é‚®ç®±ï¼Œä¿®æ”¹æˆä¸å¦å¤–ä¸€ä¸ªå·²å­˜åœ¨çš„æ³¨å†Œç”¨æˆ·ä¸€è‡´çš„å€¼ï¼Œè¿™ä¾¿æ˜¯å†²çª*/@Documented@Retention(RUNTIMEï¼‰@Target(&#123;FIELD, METHOD, PARAMETER, TYPE&#125;)@Constraint(validatedBy AccountValidation.NotConflictAccountValidator.class)public @interface NotConflictAccount &#123;\tString message() default &quot;ç”¨æˆ·åç§°ã€é‚®ç®±ã€æ‰‹æœºå·ç ä¸ç°å­˜ç”¨æˆ·äº§ç”Ÿé‡å¤&quot;;\tClass&lt;?[] groups() default &#123;&#125;;\tClass&lt;? extends Payload&gt;[] payload() default &#123;&#125;;&#125;\n\nå¦å¤–ä¸€æ¡å»ºè®®æ˜¯å°†ä¸å¸¦ä¸šåŠ¡å«ä¹‰çš„æ ¼å¼æ ¡éªŒæ³¨è§£æ”¾åˆ°Bcançš„ç±»å®šä¹‰ä¹‹ä¸Šï¼Œå°†å¸¦ä¸šåŠ¡è¾‘çš„æ ¡éªŒæ”¾åˆ°Beançš„ç±»å®šä¹‰çš„å¤–é¢ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«æ˜¯æ”¾åœ¨ç±»å®šä¹‰ä¸­çš„æ³¨è§£èƒ½å¤Ÿè‡ªåŠ¨è¿è¡Œï¼Œè€Œæ”¾åˆ°ç±»å¤–é¢çš„æ³¨è§£éœ€è¦æ˜ç¡®æ ‡å‡ºæ‰ä¼šè¿è¡Œã€‚è­¬å¦‚ç”¨æˆ·è´¦å·å®ä½“ä¸­çš„éƒ¨åˆ†ä»£ç ä¸ºï¼š\npublic class Account extenda BaseEntity &#123;  @NotEmptyï¼ˆmessage = &quot;ç”¨æˆ·ä¸å…è®¸ä¸ºç©º&quot;ï¼‰  private String username  @NotEmptyï¼ˆmessage = &quot;ç”¨æˆ·å§“åä¸å…è®¸ä¸ºç©º&quot;ï¼‰  private String nameï¼›  private String avatarï¼›  @Patternï¼ˆregexpï¼&quot;1\\\\d&#123;10&#125;&quot;ï¼Œmessage = &quot;æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®&quot;ï¼‰  private String telephoneï¼›  @Emai1ï¼ˆmessage = &quot;é‚®ç®±æ ¼å¼ä¸æ­£ç¡®&quot;ï¼‰  private String emailï¼›&#125;\n\nè¿™äº›æ ¡éªŒæ³¨è§£éƒ½ç›´æ¥æ”¾åœ¨ç±»å®šä¹‰ä¸­ï¼Œæ¯æ¬¡æ‰§è¡Œæ ¡éªŒçš„æ—¶å€™å®ƒä»¬éƒ½ä¼šè¢«è¿è¡Œã€‚ç”±äºBaValidationæ˜¯Javaçš„æ ‡å‡†è§„èŒƒï¼Œå®ƒæ‰§è¡Œçš„é¢‘ç‡å¯èƒ½æ¯”ç¼–å†™ä»£ç çš„ç¨‹åºæ‰€é¢„æƒ³çš„æ›´é«˜ï¼Œå¦‚ä½¿ç”¨Hibernateæ¥åšæŒä¹…åŒ–æ—¶ï¼Œä¾¿ä¼šè‡ªåŠ¨æ‰§è¡ŒData Objectä¸Šçš„æ ¡éªŒæ³¨è§£ã€‚å¯¹äºé‚£äº›ä¸å¸¦ä¸šåŠ¡å«ä¹‰çš„æ³¨è§£ï¼Œè¿è¡Œæ˜¯ä¸éœ€è¦å…¶ä»–å¤–éƒ¨èµ„æºå‚ä¸çš„ï¼Œå³ä¸ä¼šè°ƒç”¨è¿œç¨‹æœåŠ¡ã€è®¿é—®æ•°æ®åº“ï¼Œè¿™ç§æ ¡éªŒé‡å¤æ‰§è¡Œä¹Ÿä¸ä¼šäº§ç”Ÿä»€ä¹ˆæˆæœ¬ã€‚\nä½†å¸¦ä¸šåŠ¡é€»è¾‘çš„æ ¡éªŒï¼Œé€šå¸¸å°±éœ€è¦å¤–éƒ¨èµ„æºå‚ä¸æ‰§è¡Œï¼Œè¿™ä¸ä»…ä»…æ˜¯å¤šæ¶ˆè€—ä¸€ç‚¹æ—¶é—´å’Œè¿ç®—èµ„æºçš„é—®é¢˜ï¼Œç”±äºå¾ˆéš¾ä¿è¯ä¾èµ–çš„æ¯ä¸ªæœåŠ¡éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œé‡å¤æ‰§è¡Œæ ¡éªŒå¾ˆå¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„å‰¯ä½œç”¨ã€‚å› æ­¤åº”è¯¥æ”¾åˆ°å¤–é¢è®©ä½¿ç”¨è€…è‡ªè¡Œåˆ¤æ–­æ˜¯å¦è§¦å‘ã€‚\nè¿˜æœ‰ä¸€äº› â€œéœ€è¦è§¦å‘ä¸€éƒ¨åˆ†æ ¡éªŒâ€ çš„éå…¸å‹æƒ…å†µï¼Œè­¦å¦‚ â€œæ–°å¢â€ æ“ä½œ A æ—¶éœ€è¦æ‰§è¡Œå…¨éƒ¨æ ¡éªŒè§„åˆ™ï¼Œâ€œä¿®æ”¹â€æ“ä½œBæ—¶å¸Œæœ›ä¸æ ¡éªŒæŸä¸ªå­—æ®µï¼Œâ€œåˆ é™¤â€ æ“ä½œ C æ—¶å¸Œæœ›æ”¹å˜æŸä¸€æ¡æ ¡éªŒè§„åˆ™ï¼Œè¿™æ—¶å°±è¦å¯ç”¨åˆ†ç»„æ ¡éªŒæ¥å¤„ç†ï¼Œè®¾è®¡ä¸€å¥—â€œæ–°å¢â€â€œä¿®æ”¹â€â€œåˆ é™¤â€è¿™æ ·çš„æ ‡è¯†ç±»ï¼Œç½®å…¥æ ¡éªŒæ³¨è§£çš„ groups å‚æ•°ä¸­å»å®ç°\n","categories":["åˆ†å¸ƒå¼"],"tags":["å‡¤å‡°æ¶æ„","HTTP"]},{"title":"æµ…æå¼ºå¼±ä¸€è‡´æ€§","url":"/posts/54250/","content":"å½“å‰è¿™ç¯‡æ–‡ç« è‡³å°‘æ¯”è®¡åˆ’æ‹–åäº†ä¸¤ä¸ªæœˆã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ã€Šæ¡åˆ†ç¼•æåˆ†å¸ƒå¼ï¼šåˆ°åº•ä»€ä¹ˆæ˜¯ä¸€è‡´æ€§ï¼Ÿã€‹ä¸­ï¼Œæˆ‘ä»¬ä»”ç»†è¾¨æäº†ã€Œä¸€è‡´æ€§ã€ç›¸å…³çš„å‡ ä¸ªå®¹æ˜“æ··æ·†çš„æ¦‚å¿µã€‚è€Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä¼šæ²¿ç€é€æ­¥æ·±å…¥çš„æ€è·¯ï¼Œè·Ÿå¤§å®¶ç»§ç»­è®¨è®ºé¡ºåºä¸€è‡´æ€§ã€çº¿æ€§ä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§ç­‰å‡ ä¸ªæ¦‚å¿µã€‚\nä¸ºäº†é¿å…äº§ç”Ÿæ­§ä¹‰ï¼Œæˆ‘ä»¬å…ˆæ˜ç¡®ä¸€ä¸‹è¿™å‡ ä¸ªæ¦‚å¿µçš„è‹±æ–‡è¡¨è¾¾ï¼š\n\né¡ºåºä¸€è‡´æ€§çš„è‹±æ–‡æ˜¯ï¼šsequential consistencyã€‚\nçº¿æ€§ä¸€è‡´æ€§çš„è‹±æ–‡æ˜¯ï¼šlinearizabilityã€‚å®é™…ä¸Šï¼Œå®ƒå°±æ˜¯CAPå®šç†ä¸­çš„Cï¼Œæˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å·²ç»æåˆ°è¿‡ã€‚\næœ€ç»ˆä¸€è‡´æ€§çš„è‹±æ–‡æ˜¯ï¼ševentual consistencyã€‚\n\nåœ¨è¿›è¡Œè¯¦ç»†çš„æŠ€æœ¯æ€§è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠæœ¬æ–‡è¦è®¨è®ºçš„å‡ ä¸ªé‡ç‚¹é—®é¢˜å’Œç»“è®ºåˆ—å‡ºå¦‚ä¸‹ï¼š\n\nçº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§ï¼Œå±äºåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§æ¨¡å‹ (consistency model)ã€‚è¿™ä»£è¡¨äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ä¸ªéå¸¸éå¸¸é‡è¦çš„æ–¹é¢ã€‚\né€šå¸¸äººä»¬æŠŠçº¿æ€§ä¸€è‡´æ€§ç§°ä¸ºã€Œå¼ºä¸€è‡´æ€§ã€ï¼ŒæŠŠæœ€ç»ˆä¸€è‡´æ€§ç§°ä¸ºã€Œå¼±ä¸€è‡´æ€§ã€ï¼Œä½†çº¿æ€§ä¸€è‡´æ€§å’Œæœ€ç»ˆä¸€è‡´æ€§å…¶å®å­˜åœ¨æœ¬è´¨çš„åŒºåˆ«ã€‚ä¸¥æ ¼æ¥è¯´ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯ä¸€ä¸ªèŒƒç•´çš„æ¦‚å¿µã€‚\nä¸€è‡´æ€§æ¨¡å‹ä¹‹é—´çš„ã€Œå¼ºå¼±ã€æ¯”è¾ƒï¼Œæ˜¯ä¸€ä¸ªç›¸å¯¹çš„æ¦‚å¿µã€‚æ¯”å¦‚ï¼Œçº¿æ€§ä¸€è‡´æ€§æ˜¯æ¯”é¡ºåºä¸€è‡´æ€§æ›´å¼ºçš„ä¸€è‡´æ€§æ¨¡å‹ã€‚å½“ç„¶ï¼Œé™¤äº†çº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§ï¼Œä¹Ÿå­˜åœ¨å…¶å®ƒä¸€äº›ä¸€è‡´æ€§æ¨¡å‹ï¼ˆå…¶ä¸­å¾ˆå¤šéƒ½æ¯”é¡ºåºä¸€è‡´æ€§è¦å¼±ï¼‰ã€‚\næ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œä¹Ÿå¿…å®šæ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œä½†åè¿‡æ¥ä¸ä¸€å®šã€‚è¿™æ˜¯ç”±ä¸€è‡´æ€§æ¨¡å‹ä¹‹é—´çš„å¼ºå¼±å…³ç³»å†³å®šçš„ã€‚\n\nä¸‹é¢ï¼Œæˆ‘ä»¬å°±å¼€å§‹è¯¦ç»†çš„è§£æã€‚\nä¸€è‡´æ€§æ¨¡å‹çš„æ¥å†æˆ‘ä»¬ä¹‹æ‰€ä»¥ä½¿ç”¨åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæ— éæ˜¯å› ä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¸¦æ¥ä¸€äº›ã€Œå¥½å¤„ã€ï¼Œæ¯”å¦‚å®¹é”™æ€§ã€å¯æ‰©å±•æ€§ç­‰ç­‰ã€‚ä¸ºäº†è·å¾—è¿™äº›ã€Œå¥½å¤„ã€ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿå®ç°ä¸Šå¸¸ç”¨çš„æ–¹æ³•æ˜¯å¤åˆ¶ (replication) å’Œåˆ†ç‰‡ (sharding)ã€‚è€Œæˆ‘ä»¬å°†è¦è®¨è®ºçš„ä¸€è‡´æ€§æ¨¡å‹ (consistency model)ï¼Œä¸»è¦æ˜¯ä¸å¤åˆ¶æœ‰å…³ã€‚å› æ­¤è¿™é‡Œæˆ‘ä»¬å…ˆå…³æ³¨ä¸€ä¸‹å¤åˆ¶çš„æœºåˆ¶ã€‚\nå¤åˆ¶æŒ‡çš„æ˜¯å°†åŒä¸€ä»½æ•°æ®ä¿å­˜åœ¨å¤šä¸ªç½‘ç»œèŠ‚ç‚¹ä¸Šã€‚è€Œä¿å­˜åŒä¸€ä»½æ•°æ®æ‹·è´çš„èŠ‚ç‚¹ï¼Œè¢«ç§°ä¸ºå‰¯æœ¬ (replica)ã€‚å¤åˆ¶å¸¦æ¥çš„å…·ä½“ã€Œå¥½å¤„ã€ä¸»è¦æ˜¯ä½“ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼š\n\nå®¹é”™ (fault tolerance)ã€‚å³ä½¿æŸäº›ç½‘ç»œèŠ‚ç‚¹å‘ç”Ÿæ•…éšœï¼Œç”±äºåŸæœ¬ä¿å­˜ç€åœ¨æ•…éšœèŠ‚ç‚¹ä¸Šçš„æ•°æ®åœ¨æ­£å¸¸èŠ‚ç‚¹ä¸Šè¿˜æœ‰å¤‡ä»½ï¼Œæ‰€ä»¥æ•´ä¸ªç³»ç»Ÿä»ç„¶å¯èƒ½æ˜¯å¯ç”¨çš„ã€‚è¿™ä¹Ÿæ˜¯æˆ‘ä»¬æœŸå¾…åˆ†å¸ƒå¼ç³»ç»Ÿèƒ½å¤Ÿæä¾›çš„ã€Œé«˜å¯ç”¨ã€ç‰¹æ€§ã€‚\næå‡ååé‡ã€‚å°†ä¸€ä»½æ•°æ®å¤åˆ¶å¤šä»½å¹¶ä¿å­˜åœ¨å¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸Šï¼Œè¿˜é¡ºä¾¿å¸¦æ¥ä¸€ä¸ªå¥½å¤„ï¼šå¯¹äºåŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„è®¿é—®è¯·æ±‚ï¼ˆè‡³å°‘æ˜¯è¯»è¯·æ±‚ï¼‰å¯ä»¥ç”±å¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹åˆ†æ‹…ï¼Œä»è€Œä½¿å¾—æ•´ä¸ªç³»ç»Ÿå¯ä»¥éšç€è¯·æ±‚é‡çš„å¢åŠ ä¸æ–­æ‰©å±•ã€‚\n\nä¸€æ–¹é¢ï¼Œå¤åˆ¶å¸¦æ¥äº†è¯¸å¤šå¥½å¤„ï¼›å¦ä¸€æ–¹é¢ï¼Œå®ƒä¹Ÿå¸¦æ¥äº†å¾ˆå¤šæŒ‘æˆ˜ï¼Œå…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªå°±æ˜¯æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ã€‚ç”±äºåŒä¸€ä»½æ•°æ®ä¿å­˜åœ¨äº†å¤šä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸Šï¼Œå®ƒä»¬ä¹‹é—´å°±å­˜åœ¨æ•°æ®ä¸ä¸€è‡´çš„é£é™©ã€‚æˆ‘ä»¬å½“ç„¶å¸Œæœ›åŒä¸€ä»½æ•°æ®çš„ä¸åŒå‰¯æœ¬æ€»æ˜¯ä¿æŒä¸€è‡´ã€‚æ¢å¥è¯è¯´ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å…¶ä¸­ä¸€ä¸ªå‰¯æœ¬ä¸Šæ‰€åšçš„ä¿®æ”¹ï¼Œåœ¨å…¶å®ƒå‰¯æœ¬ä¸Šä¹Ÿèƒ½éšæ—¶è§‚å¯Ÿåˆ°ï¼ˆå³è¯»å–åˆ°ï¼‰ã€‚\nå½“ç„¶æˆ‘ä»¬å¿ƒé‡Œéƒ½æ¸…æ¥šï¼Œè®©æ‰€æœ‰å‰¯æœ¬åœ¨ä»»ä½•æ—¶åˆ»éƒ½ä¿æŒä¸€è‡´ï¼Œæ˜¯ä¸å¯èƒ½çš„ã€‚å› ä¸ºå‰¯æœ¬ä¹‹é—´çš„æ•°æ®åŒæ­¥å³ä½¿é€Ÿåº¦å†å¿«ï¼Œä¹Ÿæ˜¯éœ€è¦æ—¶é—´çš„ã€‚ä¸è¿‡å¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬å…¶å®å¹¶ä¸å…³å¿ƒæ‰€æœ‰æ—¶åˆ»çš„æ•°æ®ä¸€è‡´æ€§æƒ…å†µã€‚åªè¦ç³»ç»Ÿèƒ½å¤Ÿä¿è¯ï¼Œæ¯å½“æˆ‘ä»¬å»ã€Œè§‚å¯Ÿã€çš„æ—¶å€™ï¼ˆå³è¯»å–æ•°æ®å‰¯æœ¬çš„æ—¶å€™ï¼‰ï¼Œç³»ç»Ÿè¡¨ç°å‡ºæ¥çš„è¡Œä¸ºæ˜¯ä¸€è‡´çš„ï¼Œå°±å¯ä»¥äº†ã€‚æ¢å¥è¯è¯´ï¼Œå³ä½¿åœ¨ä¸¤æ¬¡ã€Œè§‚å¯Ÿã€ä¹‹é—´ï¼Œç³»ç»Ÿå†…éƒ¨å‡ºç°äº†çŸ­æš‚çš„æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µï¼Œåªè¦ç³»ç»Ÿä¿è¯å¤–éƒ¨ç”¨æˆ·æ— è®ºå¦‚ä½•éƒ½å‘ç°ä¸äº†ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥æ»¡æ„çš„ã€‚\nè¿™æ„å‘³ç€ï¼Œæˆ‘ä»¬åº”è¯¥ä»ç³»ç»Ÿç”¨æˆ·ï¼ˆä½¿ç”¨ç³»ç»Ÿçš„å¼€å‘è€…ï¼‰çš„è§’åº¦ï¼Œæ¥å¯¹æ•°æ®ä¸€è‡´æ€§çš„è¦æ±‚è¿›è¡Œå®šä¹‰ã€‚\nå®é™…ä¸Šï¼Œæ—©æœŸçš„åˆ†å¸ƒå¼ç³»ç»Ÿè®¾è®¡è€…ä»¬å¯¹ç³»ç»Ÿè®¾è®¡çš„è¦æ±‚ï¼Œä¹Ÿæ˜¯æŒ‰ç…§ç±»ä¼¼çš„æ€è·¯è¿›è¡Œçš„ã€‚åœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œç³»ç»Ÿåº”è¯¥ç»´æŒç±»ä¼¼SSI (single-system image)[1]æˆ–distribution transparency[2]çš„ç‰¹æ€§ã€‚è¿™ä¸¤ä¸ªæ¦‚å¿µè¦è¡¨è¾¾çš„æ ¸å¿ƒæ„æ€æ˜¯ï¼Œç³»ç»Ÿå†…éƒ¨æœ‰å…³åˆ†å¸ƒå¼å®ç°çš„å¤æ‚æ€§åº”è¯¥å¯¹ç³»ç»Ÿçš„å¤–éƒ¨ç”¨æˆ·é€æ˜ï¼›ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºç³»ç»Ÿçš„å¤–éƒ¨ç”¨æˆ·æ¥è¯´ï¼Œç³»ç»Ÿåº”è¯¥è¡¨ç°å¾—å°±å¥½åƒåªæœ‰ä¸€ä¸ªå•ä¸€çš„å‰¯æœ¬ä¸€æ ·ã€‚å¦‚æœç³»ç»Ÿèƒ½å¤Ÿæä¾›è¿™ç§ã€Œå•ä¸€ç³»ç»Ÿè§†å›¾ã€æˆ–ã€Œé€æ˜æ€§ã€ï¼Œé‚£ä¹ˆç³»ç»Ÿçš„ä½¿ç”¨è€…å°±èƒ½ä»¥æ¯”è¾ƒç®€å•çš„æ–¹å¼æ¥ä½¿ç”¨ç³»ç»Ÿï¼›å¦åˆ™å°±å¯èƒ½å¸¦æ¥å¾ˆå¤§çš„è´Ÿæ‹…ã€‚\nç³»ç»Ÿâ€œè¡¨ç°å¾—å°±å¥½åƒåªæœ‰ä¸€ä¸ªå•ä¸€çš„å‰¯æœ¬â€ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“ã€Œç¬¼ç»Ÿã€çš„è¯´æ³•ã€‚åœ¨æ­¤æˆ‘ä»¬è®¨è®º3ä¸ªå…·ä½“çš„ä¾‹å­ï¼š\n\næˆ‘ä»¬å…ˆå‘ä¸€ä¸ªå‰¯æœ¬èŠ‚ç‚¹å†™å…¥x=42ï¼Œç„¶åè¯»å–æ•°æ®å¯¹è±¡xçš„å€¼ã€‚æ˜¾ç„¶ï¼Œä¸ç®¡æˆ‘ä»¬ä»å“ªä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸Šè¿›è¡Œè¯»å–ï¼Œæˆ‘ä»¬éƒ½å¸Œæœ›è¯»åˆ°æœ€æ–°å†™å…¥çš„å€¼ï¼ˆä¹Ÿå°±æ˜¯42ï¼‰ã€‚åªæœ‰è¿™æ ·æ‰åˆç†ã€‚\nä¸¤ä¸ªç³»ç»Ÿç”¨æˆ·åˆ†åˆ«åœ¨ä¸¤ä¸ªå‰¯æœ¬èŠ‚ç‚¹ä¸ŠåŒæ—¶æ‰§è¡Œå†™æ“ä½œã€‚å…¶ä¸­ï¼Œç”¨æˆ·Aåœ¨ç¬¬1ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œx=42ï¼›ç”¨æˆ·Båœ¨ç¬¬2ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œx=43ã€‚ç„¶åç”¨æˆ·Cè¯»å–xçš„å€¼ã€‚è™½ç„¶ä¸¤ä¸ªå†™æ“ä½œæ˜¯ã€ŒåŒæ—¶ã€è¿›è¡Œçš„ï¼Œä½†ä¸ºäº†è®©ç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ï¼Œæˆ‘ä»¬è¿˜æ˜¯éœ€è¦å¯¹å®ƒä»¬è¿›è¡Œä¸€ä¸ªå…ˆåæ’åºã€‚åˆå› ä¸ºå®ƒä»¬æ˜¯ã€ŒåŒæ—¶ã€æ‰§è¡Œçš„ï¼Œæ‰€ä»¥è°å…ˆè°åéƒ½æœ‰å¯èƒ½æ˜¯åˆç†çš„ã€‚å¦‚æœæˆ‘ä»¬è®¤ä¸ºx=42åœ¨x=43ä¹‹å‰å…ˆæ‰§è¡Œï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„xçš„å€¼å°±åº”è¯¥æ˜¯43ï¼›åè¿‡æ¥ï¼Œå¦‚æœæˆ‘ä»¬è®¤ä¸ºx=43åœ¨x=42ä¹‹å‰å…ˆæ‰§è¡Œï¼Œé‚£ä¹ˆè¯»å–åˆ°çš„xçš„å€¼å°±åº”è¯¥æ˜¯42ã€‚\nç”¨æˆ·Aå…ˆåœ¨ç¬¬1ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œx=42ï¼Œç„¶åç”¨æˆ·Bå†åœ¨ç¬¬2ä¸ªå‰¯æœ¬ä¸Šæ‰§è¡Œx=43ï¼Œæœ€åç”¨æˆ·Cåœ¨ç¬¬3ä¸ªå‰¯æœ¬ä¸Šè¯»å–xçš„å€¼ã€‚ä»ç„¶ä¸ºäº†è®©ç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ï¼Œç›´è§‰ä¸Šçœ‹ï¼Œç”¨æˆ·Cè¯»å–åˆ°çš„xçš„å€¼ä¼¼ä¹åº”è¯¥æ˜¯43ã€‚ä½†æ˜¯ï¼Œä¹Ÿä¸ä¸€å®šéè¦å¦‚æ­¤ã€‚å› ä¸ºä¸¤ä¸ªå†™æ“ä½œæ˜¯åˆ†åˆ«ç”±ç”¨æˆ·Aå’Œç”¨æˆ·Bå‘èµ·çš„ï¼Œä»–ä»¬å¹¶ä¸çŸ¥é“å½¼æ­¤è°å…ˆè°åï¼ˆè™½ç„¶ä»æ—¶é—´ä¸Šçœ‹ç”¨æˆ·Açš„å†™æ“ä½œç¡®å®åœ¨å…ˆï¼‰ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€‰æ‹©è®¤ä¸ºç”¨æˆ·Bæ‰§è¡Œx=43åœ¨ç”¨æˆ·Aæ‰§è¡Œx=42ä¹‹å‰ã€‚è¿™æ ·çš„è¯ï¼Œç”¨æˆ·Cè¯»å–åˆ°çš„xçš„å€¼å°±åº”è¯¥æ˜¯42ã€‚å½“ç„¶ï¼Œæ ¹æ®æœ¬æ–‡åé¢çš„è®¨è®ºï¼Œè¿™ç§æ’åºå°±ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§äº†ï¼Œä½†å´æ»¡è¶³é¡ºåºä¸€è‡´æ€§ã€‚\n\nä»è¿™äº›ä¾‹å­ä¸éš¾çœ‹å‡ºï¼Œä¸€ä¸ªç³»ç»Ÿåœ¨æ•°æ®ä¸€è‡´æ€§ä¸Šçš„å…·ä½“è¡¨ç°å¦‚ä½•ï¼Œå–å†³äºç³»ç»Ÿå¯¹å…³é”®äº‹ä»¶ï¼ˆè¯»å†™æ“ä½œï¼‰çš„æ’åºå’Œæ‰§è¡Œé‡‡å–ä»€ä¹ˆæ ·çš„è§„åˆ™å’Œé™åˆ¶ã€‚æ¯”å¦‚åœ¨ä¸Šé¢ç¬¬3ä¸ªä¾‹å­ä¸­ï¼Œå‡ºç°äº†ä¸¤ç§å¯¹äºè¯»å†™æ“ä½œçš„æ’åºã€‚å‰ä¸€ç§æ’åºæ˜¯ï¼š\n\nç”¨æˆ·Aæ‰§è¡Œx=42ã€‚\nç”¨æˆ·Bæ‰§è¡Œx=43ã€‚\nç”¨æˆ·Cè¯»å–åˆ°xçš„å€¼æ˜¯43ã€‚\n\nè€Œç¬¬3ä¸ªä¾‹å­ä¸­çš„åä¸€ç§æ’åºæ˜¯ï¼š\n\nç”¨æˆ·Bæ‰§è¡Œx=43ã€‚\nç”¨æˆ·Aæ‰§è¡Œx=42ã€‚\nç”¨æˆ·Cè¯»å–åˆ°xçš„å€¼æ˜¯42ã€‚\n\nè™½ç„¶è¿™ä¸¤ç§æ’åºç»“æœä¸åŒï¼Œä½†å®ƒä»¬éƒ½åšåˆ°äº†è®©ç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ã€‚å®ƒä»¬çš„ä¸åŒåœ¨äºï¼Œå‰ä¸€ç§æ’åºéµå¾ªäº†ä¸åŒç”¨æˆ·çš„æ“ä½œçš„æ—¶é—´å…ˆåé¡ºåºï¼Œè€Œåä¸€ç§æ’åºæ²¡æœ‰ã€‚å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬è¦æ±‚ç³»ç»Ÿæ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ï¼Œå°±åªèƒ½å¾—åˆ°å‰ä¸€ç§æ’åºç»“æœï¼›è€Œå¦‚æœåªè¦æ±‚ç³»ç»Ÿæ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Œå°±æœ‰å¯èƒ½å¾—åˆ°åä¸€ç§æ’åºç»“æœï¼ˆç­‰çœ‹å®Œæœ¬æ–‡åé¢çš„è®¨è®ºï¼Œä½ å°±èƒ½è‡ªå·±å¾—åˆ°è¿™äº›ç»“è®ºï¼‰ã€‚\nå¯ä»¥è¿™ä¹ˆè¯´ï¼Œä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå¯¹äºè¯»å†™æ“ä½œçš„æŸç§æ’åºå’Œæ‰§è¡Œè§„åˆ™ï¼Œå°±å®šä¹‰äº†ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹ (consistency model)ã€‚å½“ä¸€ä¸ªç³»ç»Ÿé€‰å®šäº†æŸç§ç‰¹å®šçš„ä¸€è‡´æ€§æ¨¡å‹ï¼ˆæ¯”å¦‚çº¿æ€§ä¸€è‡´æ€§æˆ–é¡ºåºä¸€è‡´æ€§ï¼‰ï¼Œé‚£ä¹ˆä½ å°±åªèƒ½çœ‹åˆ°è¿™ç§ä¸€è‡´æ€§æ¨¡å‹æ‰€å…è®¸çš„é‚£äº›æ“ä½œåºåˆ—ã€‚è¿˜æ˜¯æ‹¿å‰é¢ç¬¬3ä¸ªä¾‹å­æ¥è¯´æ˜ï¼šå¦‚æœä½ é€‰å®šäº†çº¿æ€§ä¸€è‡´æ€§æ¨¡å‹ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±ä¸ä¼šå‘ä½ å‘ˆç°åä¸€ç§æ’åºï¼Œä½ åªèƒ½çœ‹åˆ°å‰ä¸€ç§æ’åºã€‚\nå¦å¤–ï¼Œåœ¨å‰é¢çš„ä¸‰ä¸ªä¾‹å­ä¸­ï¼Œä¸ç®¡ç³»ç»Ÿæœ€ç»ˆç»™å‡ºäº†å“ªç§æ’åºç»“æœï¼Œæ‰€æœ‰ç³»ç»Ÿçš„ç”¨æˆ·å…¶å®éƒ½å¯¹é‚£ç§æ“ä½œåºåˆ—è¾¾æˆäº†ä¸€è‡´çš„çœ‹æ³•ã€‚è¿˜æœ‰ä¸€äº›ä¸€è‡´æ€§æ¨¡å‹ï¼Œå¹¶ä¸è¦æ±‚æ‰€æœ‰ç”¨æˆ·å¯¹æ“ä½œæ’åºçš„ç»“æœè¾¾æˆå”¯ä¸€çš„ä¸€ç§çœ‹æ³•ã€‚è¿™æ ·çš„ä¸€è‡´æ€§æ¨¡å‹ç¨æ˜¾å¤æ‚ï¼Œæˆ‘ä»¬ä¼šæ”¾åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­å†è®¨è®ºï¼ˆæ¯”å¦‚å› æœä¸€è‡´æ€§ï¼‰ã€‚\næ¥ä¸‹æ¥ï¼Œä¸ºäº†æ›´æ¸…æ™°åœ°è®¤è¯†ä¸€è‡´æ€§æ¨¡å‹ï¼Œæˆ‘ä»¬æ¥æ·±å…¥åˆ°çº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§çš„ä¸€äº›ç»†èŠ‚ä¸­å»ã€‚\nçº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§åœ¨è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæŠŠç»„æˆåˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€äº›å…³é”®æ¦‚å¿µå®šä¹‰æ¸…æ¥šï¼š\n\næ•´ä¸ªç³»ç»Ÿå¯ä»¥çœ‹æˆç”±å¤šä¸ªè¿›ç¨‹å’Œä¸€ä¸ªå…±äº«çš„æ•°æ®å­˜å‚¨ç»„æˆã€‚å¯¹äºæ•°æ®å­˜å‚¨çš„è¯»å†™æ“ä½œç”±è¿›ç¨‹å‘èµ·ã€‚è¿™é‡Œçš„è¿›ç¨‹ï¼Œç›¸å½“äºæœ¬æ–‡å‰é¢æåˆ°çš„ç³»ç»Ÿç”¨æˆ·æˆ–ç³»ç»Ÿä½¿ç”¨è€…ã€‚\nåŒä¸€ä¸ªè¿›ç¨‹å‘èµ·çš„è¯»å†™æ“ä½œæ˜¯å…ˆåé¡ºåºæ‰§è¡Œçš„ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„ã€Œè¿›ç¨‹ã€æ¦‚å¿µè·Ÿæˆ‘ä»¬å¹³å¸¸ç¼–ç¨‹æ—¶ç”¨åˆ°çš„è¿›ç¨‹æœ‰æ‰€ä¸åŒï¼Œè¿›ç¨‹é‡Œé¢ä¸å†åˆ†å¤šä¸ªçº¿ç¨‹äº†ã€‚\næ•°æ®å­˜å‚¨å¯èƒ½æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œä½†æˆ‘ä»¬åœ¨è®¨è®ºä¸€è‡´æ€§æ¨¡å‹çš„æ—¶å€™ï¼ŒæŠŠå®ƒçœ‹æˆä¸€ä¸ªæ•´ä½“æ¥çœ‹å¾…ï¼Œä¸åŒºåˆ†è¯»å†™æ“ä½œæäº¤åˆ°äº†å…·ä½“å“ªä¸ªå‰¯æœ¬ä¸Šã€‚\næ¯ä¸ªæ“ä½œçš„æ‰§è¡Œï¼Œä»å¼€å§‹è°ƒç”¨åˆ°æ‰§è¡Œç»“æŸï¼Œéƒ½éœ€è¦èŠ±ä¸€å®šçš„æ—¶é—´ã€‚å› æ­¤ï¼Œä¸€ä¸ªè¿›ç¨‹å‘èµ·çš„æ“ä½œè¿˜æ²¡æœ‰æ‰§è¡Œå®Œçš„æ—¶å€™ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹çš„æ“ä½œå¯èƒ½å°±å·²ç»å¼€å§‹äº†ã€‚\n\nå¯è§ï¼Œç³»ç»Ÿçš„å¤šä¸ªè¿›ç¨‹æ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è¯´æ˜è¿™ç§å¹¶å‘æ‰§è¡Œçš„æƒ…å†µï¼Œè¿›è€Œè§£é‡Šé¡ºåºä¸€è‡´æ€§çš„æ¦‚å¿µã€‚\n\nä¸Šé¢æ˜¯ä¸€ä¸ªç±»ä¼¼ã€Œæ—¶ç©ºå›¾ã€çš„å›¾åƒï¼Œè¡¨è¾¾äº†3ä¸ªè¿›ç¨‹ï¼ˆP1ã€P2å’ŒP3ï¼‰å¯¹äºæ•°æ®å­˜å‚¨çš„è¯»å†™æ‰§è¡Œè¿‡ç¨‹ã€‚åœ¨è¿™ä¸ªå›¾ä¸­ï¼Œæ¨ªå‘ä»å·¦åˆ°å³è¡¨ç¤ºæ—¶é—´é€’å¢ï¼Œé»‘è‰²çš„çº¿æ®µè¡¨ç¤ºæ¯ä¸ªæ“ä½œçš„æ‰§è¡Œèµ·æ­¢ã€‚çº¿æ®µä¸Šé¢çš„ç¬¦å·è¡¨ç¤ºå…·ä½“çš„è¯»å†™æ“ä½œï¼š\n\nA â€“&gt; w**i(x)ï¼Œè¡¨ç¤ºä¸€ä¸ªå†™æ“ä½œï¼šç¬¬iä¸ªè¿›ç¨‹å‘æ•°æ®å¯¹è±¡xå†™å…¥äº†å€¼Aã€‚\nr**i(x) â€“&gt; Aï¼Œè¡¨ç¤ºä¸€ä¸ªè¯»æ“ä½œï¼šç¬¬iä¸ªè¿›ç¨‹ä»æ•°æ®å¯¹è±¡xä¸­è¯»åˆ°äº†å€¼Aã€‚\n\nç°åœ¨æˆ‘ä»¬è¦è€ƒå¯Ÿçš„é—®é¢˜æ˜¯ï¼šä¸Šå›¾çš„è¿™æ ·ä¸€ä¸ªæ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯å¦æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆå¾—çŸ¥é“é¡ºåºä¸€è‡´æ€§çš„å®šä¹‰æ˜¯ä»€ä¹ˆã€‚\né¡ºåºä¸€è‡´æ€§å®šä¹‰[3,4]ï¼šå¦‚æœä¸€ä¸ªå¹¶å‘æ‰§è¡Œè¿‡ç¨‹æ‰€åŒ…å«çš„æ‰€æœ‰è¯»å†™æ“ä½œèƒ½å¤Ÿé‡æ’æˆä¸€ä¸ªå…¨å±€çº¿æ€§æœ‰åºçš„åºåˆ—ï¼Œå¹¶ä¸”è¿™ä¸ªåºåˆ—æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼Œé‚£ä¹ˆè¿™ä¸ªå¹¶å‘æ‰§è¡Œè¿‡ç¨‹å°±æ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ï¼š\n\næ¡ä»¶Iï¼šé‡æ’åçš„åºåˆ—ä¸­æ¯ä¸€ä¸ªè¯»æ“ä½œè¿”å›çš„å€¼ï¼Œå¿…é¡»ç­‰äºå‰é¢å¯¹åŒä¸€ä¸ªæ•°æ®å¯¹è±¡çš„æœ€è¿‘ä¸€æ¬¡å†™æ“ä½œæ‰€å†™å…¥çš„å€¼ã€‚\næ¡ä»¶IIï¼šåŸæ¥æ¯ä¸ªè¿›ç¨‹ä¸­å„ä¸ªæ“ä½œçš„æ‰§è¡Œå…ˆåé¡ºåºï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­å¿…é¡»ä¿æŒä¸€è‡´ã€‚\n\nä»¥ä¸Šå›¾çš„æ‰§è¡Œè¿‡ç¨‹ä¸ºä¾‹ï¼Œæˆ‘ä»¬é‡æ’æ‰€æœ‰çš„6ä¸ªè¯»å†™æ“ä½œï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æœ‰åºåºåˆ—ï¼š\n\nA â€“&gt; w**1(x)\nr**3(x) â€“&gt; A\nC â€“&gt; w**2(x)\nr**3(x) â€“&gt; C\nB â€“&gt; w**1(x)\nr**3(x) â€“&gt; B\n\nå¾ˆå®¹æ˜“çœ‹å‡ºï¼Œè¿™ä¸ªåºåˆ—æ˜¯æ»¡è¶³å‰é¢é¡ºåºä¸€è‡´æ€§å®šä¹‰ä¸­çš„ä¸¤ä¸ªæ¡ä»¶çš„ï¼š\n\næ¡ä»¶Iï¼šåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­ï¼Œæ¯ä¸ªè¯»æ“ä½œéƒ½è¿”å›äº†å‰é¢æœ€è¿‘ä¸€æ¬¡å†™å…¥çš„å€¼ï¼Œæ¯”å¦‚ç¬¬2ä¸ªæ“ä½œè¯»åˆ°çš„å€¼Aï¼Œæ˜¯å‰é¢ç¬¬1ä¸ªæ“ä½œå†™å…¥çš„ï¼›ç¬¬4ä¸ªæ“ä½œè¯»åˆ°çš„å€¼Cï¼Œæ˜¯å‰é¢ç¬¬3ä¸ªæ“ä½œå†™å…¥çš„ã€‚\næ¡ä»¶IIï¼šåŸæ¥è¿›ç¨‹P1ä¸­çš„ä¸¤ä¸ªå†™æ“ä½œï¼ŒA â€“&gt; w**1(x)å’ŒB â€“&gt; w**1(x)ï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­ä»ç„¶ä¿æŒäº†å…ˆåé¡ºåºã€‚ä¸æ­¤ç±»ä¼¼ï¼ŒåŸæ¥è¿›ç¨‹P3ä¸­çš„3ä¸ªè¯»æ“ä½œï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­ä¹Ÿä¿æŒäº†åŸæ¥çš„å…ˆåé¡ºåºã€‚\n\næ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¯ä»¥å›ç­”å‰é¢çš„é—®é¢˜äº†ï¼šä¸Šå›¾ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ã€‚\nä½ å¯èƒ½ä¼šé—®ï¼Œé¡ºåºä¸€è‡´æ€§ä¸ºä»€ä¹ˆä¼šè¿™æ ·å®šä¹‰å‘¢ï¼Ÿè¿™ä¸ªå®šä¹‰çš„åˆè¡·æ˜¯ä»€ä¹ˆï¼Ÿ\næˆ‘ä»¬å¯ä»¥è¯•ç€è¿™æ ·ç†è§£ï¼šé¦–å…ˆï¼Œé‡æ’æˆä¸€ä¸ªå…¨å±€çº¿æ€§æœ‰åºçš„åºåˆ—ï¼Œç›¸å½“äºç³»ç»Ÿå¯¹å¤–è¡¨ç°å‡ºäº†ä¸€ç§ã€Œå‡è±¡ã€ï¼ŒåŸæœ¬å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œçš„æ“ä½œï¼Œå¥½åƒæ˜¯é¡ºåºæ‰§è¡Œçš„ä¸€æ ·ã€‚æœ¬æ–‡å‰é¢æåˆ°è¿‡ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿåº”è¯¥â€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ä¸€æ ·ã€‚é¡ºåºä¸€è‡´æ€§æ­£æ˜¯éµå¾ªäº†è¿™ç§ã€Œç³»ç»Ÿå‡è±¡ã€ï¼Œç³»ç»Ÿå¯¹å¤–è¡¨ç°å°±å¥½åƒåœ¨æ“ä½œä¸€ä¸ªå•ä¸€çš„å‰¯æœ¬ï¼Œæ‰§è¡Œé¡ºåºä¹Ÿå¿…ç„¶æ˜¯å¯ä»¥çœ‹åšé¡ºåºæ‰§è¡Œçš„ã€‚è€Œæ¡ä»¶Iè§„å®šäº†ç³»ç»Ÿçš„è¡¨ç°æ˜¯åˆç†çš„ï¼ˆå³åˆä¹é€»è¾‘çš„ï¼‰ï¼›æ¡ä»¶IIåˆ™ä¿è¯äº†ä»¥ä»»ä½•è¿›ç¨‹çš„è§†è§’æ¥çœ‹ï¼Œå®ƒæ‰€å‘èµ·çš„æ“ä½œæ‰§è¡Œé¡ºåºéƒ½æ˜¯ç¬¦åˆå®ƒåŸæœ¬çš„é¢„æœŸçš„ã€‚æ€»ä¹‹ï¼Œä¸€ä¸ªæ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œå¯¹å¤–è¡¨ç°å°±å¥½åƒæ€»æ˜¯åœ¨æ“ä½œä¸€ä¸ªå‰¯æœ¬ä¸€æ ·ã€‚\næˆ‘ä»¬å†é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥çœ‹ä¸€çœ‹è¿™ä¸ªé—®é¢˜çš„åé¢â€”â€”ä¸æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯æ€æ ·çš„ã€‚\n\nè¿™ä¸ªå›¾ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œä¸å‰é¢ç¬¬ä¸€ä¸ªå›¾çš„æ‰§è¡Œè¿‡ç¨‹éå¸¸ç›¸ä¼¼ï¼Œåªæ˜¯è¿›ç¨‹P3çš„å‡ ä¸ªæ“ä½œçš„æ‰§è¡Œé¡ºåºç¨æœ‰å˜åŒ–ã€‚\næˆ‘ä»¬æ ¹æ®å‰é¢é¡ºåºä¸€è‡´æ€§çš„å®šä¹‰å†æ¥è¯•ç€å¯¹è¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œè¿›è¡Œé‡æ’ï¼šé¦–å…ˆæ ¹æ®æ¡ä»¶IIå’Œè¿›ç¨‹P1çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬çŸ¥é“ï¼ŒA â€“&gt; w**1(x)ä¸€å®šè¦æ’åœ¨B â€“&gt; w**1(x)å‰é¢ï¼›å†æ ¹æ®æ¡ä»¶Iï¼Œè¿›ç¨‹P1çš„B â€“&gt; w**1(x)ä¸€å®šè¦æ’åœ¨è¿›ç¨‹P3çš„r**3(x) â€“&gt; Bå‰é¢ã€‚æœ€åï¼Œå†ç»“åˆæ¡ä»¶IIå’Œè¿›ç¨‹P3çš„æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬èƒ½å¤Ÿå¾—å‡ºç»“è®ºï¼Œè¿›ç¨‹P1å’Œè¿›ç¨‹P3çš„æ‰€æœ‰æ“ä½œï¼Œåœ¨æœ€ç»ˆé‡æ’åçš„å®Œæ•´åºåˆ—ä¸­ï¼Œå¿…ç„¶ä¿æŒä»¥ä¸‹çš„é¡ºåºï¼š\n\nA â€“&gt; w**1(x)\nB â€“&gt; w**1(x)\nr**3(x) â€“&gt; B\nr**3(x) â€“&gt; C\nr**3(x) â€“&gt; A\n\næˆ‘ä»¬ä¼šå‘ç°ï¼Œä¸Šé¢çš„åºåˆ—æœ‰ä¸¤ä¸ªåœ°æ–¹ä¸æ»¡è¶³æ¡ä»¶Iï¼š\n\nç¬¬4ä¸ªæ“ä½œè¯»åˆ°äº†å€¼Cï¼Œè€Œå‰é¢æœ€è¿‘ä¸€æ¬¡å†™æ“ä½œï¼ˆç¬¬2ä¸ªæ“ä½œï¼‰æ‰€å†™å…¥çš„å€¼æ˜¯Bã€‚\nç¬¬5ä¸ªæ“ä½œè¯»åˆ°äº†å€¼Aï¼Œè€Œå‰é¢æœ€è¿‘ä¸€æ¬¡å†™æ“ä½œï¼ˆä¹Ÿæ˜¯ç¬¬2ä¸ªæ“ä½œï¼‰æ‰€å†™å…¥çš„å€¼æ˜¯Bã€‚\n\næˆ‘ä»¬è¿˜å‰©ä¸€ä¸ªè¿›ç¨‹P2çš„å†™æ“ä½œï¼Œå³C â€“&gt; w**2(x)ï¼Œæ²¡æœ‰æ”¾åˆ°æœ€åè¿™ä¸ªåºåˆ—ä¸­ã€‚ä¹Ÿè®¸æˆ‘ä»¬å¯ä»¥è¯•ç€å°†å®ƒæ”¾ç½®åˆ°ç¬¬3å’Œç¬¬4ä¸ªæ“ä½œä¹‹é—´ï¼Œè¿™æ ·å°±èƒ½æŠŠå‰é¢ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶Içš„åœ°æ–¹ä¿®å¤æ‰ã€‚ä½†æ— è®ºå¦‚ä½•ï¼Œä¹Ÿæ— æ³•å¾—åˆ°ä¸€ä¸ªå®Œå…¨ç¬¦åˆæ¡ä»¶Iå’Œæ¡ä»¶IIçš„å®Œæ•´åºåˆ—äº†ã€‚å› æ­¤ï¼Œå‰é¢ç¬¬äºŒä¸ªå›¾ä¸­çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ä¸æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„ã€‚è¿›ä¸€æ­¥è¯´ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿçš„æ‰§è¡Œå‘ˆç°å‡ºäº†è¿™æ ·çš„ä¸€ç§æ‰§è¡Œè¿‡ç¨‹ï¼ˆå¦‚å‰é¢ç¬¬äºŒä¸ªå›¾æ‰€ç¤ºï¼‰ï¼Œé‚£æˆ‘ä»¬å¯ä»¥è‚¯å®šåœ°è¯´ï¼Œè¿™ä¸ªç³»ç»Ÿæ˜¯æ²¡æœ‰éµå®ˆé¡ºåºä¸€è‡´æ€§çš„ã€‚\næˆ‘ä»¬å†æ¥è€ƒå¯Ÿä¸€ä¸‹çº¿æ€§ä¸€è‡´æ€§çš„æ¦‚å¿µã€‚çº¿æ€§ä¸€è‡´æ€§çš„å®šä¹‰[5]ï¼Œä¸é¡ºåºä¸€è‡´æ€§éå¸¸ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯è¯•å›¾æŠŠæ‰€æœ‰è¯»å†™æ“ä½œé‡æ’æˆä¸€ä¸ªå…¨å±€çº¿æ€§æœ‰åºçš„åºåˆ—ï¼Œä½†é™¤äº†æ»¡è¶³å‰é¢çš„æ¡ä»¶Iå’Œæ¡ä»¶IIä¹‹å¤–ï¼Œè¿˜è¦åŒæ—¶æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼š\n\næ¡ä»¶IIIï¼šä¸åŒè¿›ç¨‹çš„æ“ä½œï¼Œå¦‚æœåœ¨æ—¶é—´ä¸Šä¸é‡å ï¼Œé‚£ä¹ˆå®ƒä»¬çš„æ‰§è¡Œå…ˆåé¡ºåºï¼Œåœ¨è¿™ä¸ªé‡æ’åçš„åºåˆ—ä¸­å¿…é¡»ä¿æŒä¸€è‡´ã€‚\n\næ ¹æ®æœ€æ–°å®šä¹‰çš„æ¡ä»¶IIIï¼Œæˆ‘ä»¬æ¥é‡æ–°è¯„åˆ¤ä¸€ä¸‹å‰é¢ç¬¬ä¸€ä¸ªå›¾æ‰€å±•ç°å‡ºæ¥çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯ä¸æ˜¯æ»¡è¶³å®ƒã€‚ä¸ºäº†é˜…è¯»å’Œè®¨è®ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬æŠŠç¬¬ä¸€ä¸ªå›¾é‡æ–°å±•ç¤ºåœ¨ä¸‹é¢ï¼š\n\né’ˆå¯¹æ¡ä»¶IIIï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹å„ä¸ªæ“ä½œä¹‹é—´çš„å…ˆåé¡ºåºï¼š\n\nè¿›ç¨‹P1çš„B â€“&gt; w**1(x)å’Œè¿›ç¨‹P2çš„C â€“&gt; w**2(x)ï¼Œåœ¨æ‰§è¡Œæ—¶é—´ä¸Šæ˜¯é‡å çš„ï¼Œæ‰€ä»¥å®ƒä»¬çš„æ’åºä¸å—æ¡ä»¶IIIçš„çº¦æŸã€‚å³ï¼Œåœ¨é‡æ’åçš„åºåˆ—ä¸­ï¼Œè¿™ä¸¤ä¸ªæ“ä½œè°å…ˆè°åéƒ½å¯ä»¥ã€‚åŒæ ·ï¼Œè¿›ç¨‹P1çš„B â€“&gt; w**1(x)å’Œè¿›ç¨‹P3çš„r**3(x) â€“&gt; Aï¼Œä¹Ÿæ˜¯å¦‚æ­¤ã€‚\nè¿›ç¨‹P1çš„A â€“&gt; w**1(x)å’Œè¿›ç¨‹P2çš„C â€“&gt; w**2(x)ï¼Œåœ¨æ‰§è¡Œæ—¶é—´ä¸Šæ˜¯ä¸é‡å çš„ï¼Œå³å‰ä¸€ä¸ªæ“ä½œéƒ½æ‰§è¡Œå®Œäº†ï¼Œåä¸€ä¸ªæ“ä½œæ‰å¼€å§‹æ‰§è¡Œã€‚é‚£ä¹ˆï¼Œè¿™ä¸¤ä¸ªæ“ä½œå°±å¿…é¡»æ»¡è¶³æ¡ä»¶IIIäº†ï¼šåœ¨é‡æ’åçš„åºåˆ—ä¸­ï¼ŒA â€“&gt; w**1(x)å¿…é¡»æ’åœ¨C â€“&gt; w**2(x)å‰é¢ã€‚\nä¸ä¸Šé¢åŒæ ·çš„é“ç†ï¼Œåœ¨é‡æ’åçš„åºåˆ—ä¸­ï¼Œè¿›ç¨‹P2çš„C â€“&gt; w**2(x)å¿…é¡»æ’åœ¨è¿›ç¨‹P3çš„r**3(x) â€“&gt; Aä¹‹å‰ã€‚\n\nå®¹æ˜“çœ‹å‡ºï¼Œåœ¨éµå®ˆè¿™æ ·çš„å…ˆåå…³ç³»çº¦æŸçš„å‰æä¸‹ï¼Œä¸ç®¡æ€ä¹ˆé‡æ’ï¼Œéƒ½æ— æ³•å¾—åˆ°ä¸€ä¸ªæ»¡è¶³æ¡ä»¶Içš„å®Œæ•´åºåˆ—äº†ã€‚æ‰€ä»¥è¯´ï¼Œå‰é¢ç¬¬ä¸€ä¸ªå›¾æ‰€ç¤ºçš„æ»¡è¶³é¡ºåºä¸€è‡´æ€§çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ä¸æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ã€‚\nä¸‹é¢æˆ‘ä»¬ä¸¾ä¸€ä¸ªæ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„ä¾‹å­ï¼š\n\nä¸Šå›¾çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œæ‰€æœ‰æ“ä½œé‡æ’åï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹çš„æœ‰åºåºåˆ—ï¼š\n\nA â€“&gt; w**1(x)\nr**3(x) â€“&gt; A\nC â€“&gt; w**2(x)\nr**3(x) â€“&gt; C\nB â€“&gt; w**1(x)\nr**3(x) â€“&gt; B\n\nä¸éš¾çœ‹å‡ºï¼Œè¿™ä¸ªåºåˆ—æ˜¯æ»¡è¶³æ‰€æœ‰çš„æ¡ä»¶Iã€æ¡ä»¶IIå’Œæ¡ä»¶IIIè¿™ä¸‰ä¸ªæ¡ä»¶çš„ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ‰§è¡Œè¿‡ç¨‹æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§ã€‚\nç»†å¿ƒçš„ä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼Œæœ€åè¿™ä¸ªçº¿æ€§ä¸€è‡´æ€§çš„ä¾‹å­ï¼Œå¾—åˆ°çš„é‡æ’åçš„åºåˆ—ï¼Œä¸å¼€å§‹ç¬¬ä¸€ä¸ªé¡ºåºä¸€è‡´æ€§çš„ä¾‹å­é‡æ’åçš„åºåˆ—ï¼Œå®Œå…¨ç›¸åŒã€‚å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªä¾‹å­ä¸­åŸå§‹çš„å¤šè¿›ç¨‹å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ï¼Œæ˜¯ä¸åŒçš„ã€‚è¿™æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼ˆæ²¡æœ‰ä»€ä¹ˆå¯å¥‡æ€ªçš„ï¼‰ã€‚\nç°åœ¨æˆ‘ä»¬å¯ä»¥ä»”ç»†åˆ†æä¸€ä¸‹æ¡ä»¶IIå’Œæ¡ä»¶IIIï¼Œå®ƒä»¬å›Šæ‹¬äº†ä»»æ„ä¸¤ä¸ªæ“ä½œä¹‹é—´æ‰€æœ‰å¯èƒ½çš„å…ˆåå…³ç³»ï¼š\n\nè¿›ç¨‹å†…çš„ä»»æ„ä¸¤ä¸ªæ“ä½œä¹‹é—´ï¼Œæ€»æ˜¯å…ˆåé¡ºåºæ‰§è¡Œçš„ï¼ˆæ‰§è¡Œæ—¶é—´ä¸Šä¸å¯èƒ½é‡å ï¼‰ï¼›è€Œæ ¹æ®æ¡ä»¶IIï¼Œå®ƒä»¬çš„å…ˆåé¡ºåºåœ¨æœ€åé‡æ’åçš„åºåˆ—ä¸­ä¹Ÿä¼šä¿æŒã€‚\nä¸åŒè¿›ç¨‹çš„ä¸åŒæ“ä½œä¹‹é—´ï¼Œåœ¨æ‰§è¡Œæ—¶é—´ä¸Šå¯èƒ½é‡å ï¼ˆå¹¶å‘æ‰§è¡Œï¼‰ï¼Œä¹Ÿå¯èƒ½ä¸é‡å ã€‚æ ¹æ®æ¡ä»¶IIIï¼Œä¸é‡å çš„ä¸¤ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨æ—¶é—´ä¸Šçš„å…ˆåé¡ºåºï¼Œåœ¨æœ€åé‡æ’åçš„åºåˆ—ä¸­ä¼šå¾—ä»¥ä¿æŒã€‚è€Œå¯¹äºæ‰§è¡Œæ—¶é—´ä¸Šé‡å çš„ä¸¤ä¸ªæ“ä½œï¼Œå®ƒä»¬åœ¨æœ€åé‡æ’åçš„åºåˆ—ä¸­çš„å…ˆåé¡ºåºæ²¡æœ‰è§„å®šã€‚\n\næœ€åï¼Œæˆ‘ä»¬æ¯”è¾ƒä¸€ä¸‹é¡ºåºä¸€è‡´æ€§å’Œçº¿æ€§ä¸€è‡´æ€§ï¼š\n\nå®ƒä»¬éƒ½è¯•å›¾è®©ç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ä¸€æ ·ã€‚\nå®ƒä»¬éƒ½ä¿è¯äº†ç¨‹åºæ‰§è¡Œé¡ºåºä¸ä¼šè¢«æ‰“ä¹±ã€‚ä½“ç°åœ¨æ¡ä»¶IIå¯¹äºè¿›ç¨‹å†…å„ä¸ªæ“ä½œçš„æ’åºä¿æŒä¸Šã€‚\nçº¿æ€§ä¸€è‡´æ€§è€ƒè™‘äº†æ—¶é—´å…ˆåé¡ºåºï¼Œè€Œé¡ºåºä¸€è‡´æ€§æ²¡æœ‰ã€‚\næ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè‚¯å®šéƒ½æ»¡è¶³é¡ºåºä¸€è‡´æ€§ï¼›åä¹‹ä¸ä¸€å®šã€‚\n\næ³¨æ„ä¸€ä¸‹ä¸Šé¢ç¬¬3ç‚¹ä¸¤è€…åœ¨æ—¶é—´å…ˆåé¡ºåºä¸Šçš„ä¸åŒã€‚è¿™æ„å‘³ç€ï¼š\n\nçº¿æ€§ä¸€è‡´æ€§éšå«äº†æ—¶æ•ˆæ€§ä¿è¯ï¼ˆrecency guaranteeï¼‰ã€‚å®ƒä¿è¯æˆ‘ä»¬æ€»æ˜¯èƒ½è¯»åˆ°æ•°æ®æœ€æ–°çš„å€¼ã€‚\nåœ¨é¡ºåºä¸€è‡´æ€§ä¸­ï¼Œæˆ‘ä»¬æœ‰å¯èƒ½è¯»åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ã€‚æ¯”å¦‚ï¼Œåœ¨æœ¬æ–‡ç¬¬ä¸€ä¸ªé¡ºåºä¸€è‡´æ€§çš„ä¾‹å­ä¸­ï¼Œåœ¨è¿›ç¨‹P2å°†æ•°æ®å¯¹è±¡xçš„å€¼å†™æˆäº†Cä¹‹åï¼Œè¿›ç¨‹P3ä»ç„¶è¯»åˆ°äº†æ—§çš„å€¼ï¼ˆAï¼‰ã€‚\n\næœ€ç»ˆä¸€è‡´æ€§å’Œå®ƒçš„ç‰¹æ®Šæ€§æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°è¿‡ï¼ŒCAPå®šç†[6]ä¸­çš„Cï¼ŒæŒ‡çš„å°±æ˜¯çº¿æ€§ä¸€è‡´æ€§ (linearizability)ã€‚å®ƒä¹Ÿç»å¸¸è¢«ç§°ä¸ºã€Œå¼ºä¸€è‡´æ€§ã€ã€‚\næ ¹æ®CAPå®šç†ï¼Œå½“å­˜åœ¨ç½‘ç»œåˆ†åŒºçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å¯ç”¨æ€§ (availability) å’Œå¼ºä¸€è‡´æ€§ä¹‹é—´è¿›è¡Œå–èˆã€‚\nå¦å¤–ï¼Œå³ä½¿åœ¨æ²¡æœ‰ç½‘ç»œåˆ†åŒºå­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»åœ¨å»¶è¿Ÿ (latency) å’Œå¼ºä¸€è‡´æ€§ä¹‹é—´è¿›è¡Œå–èˆ[7]ã€‚è¿™æ˜¯å› ä¸ºï¼Œç³»ç»Ÿç»´æŒå¼ºä¸€è‡´æ€§æ˜¯æœ‰æˆæœ¬çš„ã€‚æƒ³è¦ç»´æŒè¶Šå¼ºçš„ä¸€è‡´æ€§ï¼Œå°±éœ€è¦åœ¨å‰¯æœ¬èŠ‚ç‚¹ä¹‹é—´åšæ›´å¤šçš„é€šä¿¡å’Œåè°ƒå·¥ä½œï¼Œå› æ­¤ä¼šå¢åŠ æ“ä½œçš„æ€»å»¶è¿Ÿï¼Œè¿›è€Œé™ä½æ•´ä¸ªç³»ç»Ÿçš„æ€§èƒ½ã€‚\nä»20ä¸–çºª90å¹´ä»£ä¸­æœŸå¼€å§‹ï¼Œäº’è”ç½‘å¼€å§‹è“¬å‹ƒå‘å±•ï¼Œç³»ç»Ÿçš„è§„æ¨¡ä¹Ÿå˜å¾—è¶Šæ¥è¶Šå¤§ã€‚äººä»¬è®¾è®¡å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿçš„æŒ‡å¯¼æ€æƒ³ï¼Œä¹Ÿé€æ­¥å¼€å§‹æ›´å€¾å‘äºç³»ç»Ÿçš„é«˜å¯ç”¨æ€§å’Œé«˜æ€§èƒ½ã€‚å–èˆçš„ç»“æœå°±æ˜¯ï¼Œé™ä½ç³»ç»Ÿæä¾›çš„ä¸€è‡´æ€§ä¿éšœã€‚è¿™å…¶ä¸­éå¸¸é‡è¦çš„ä¸€æ¡æ€è·¯å°±æ˜¯æœ€ç»ˆä¸€è‡´æ€§[2]ã€‚\næœ€ç»ˆä¸€è‡´æ€§çš„è®¾è®¡æ€è·¯ï¼Œä¸å†è¯•å›¾æä¾›å•ä¸€ç³»ç»Ÿè§†å›¾ (SSI)ï¼Œå³ä¸å†è¯•å›¾è®©ç³»ç»Ÿâ€œè¡¨ç°å¾—åƒåªæœ‰ä¸€ä¸ªå‰¯æœ¬â€ä¸€æ ·ã€‚å®ƒå…è®¸è¯»åˆ°æ—§ç‰ˆæœ¬çš„æ•°æ®ã€‚æœ€ç»ˆä¸€è‡´æ€§çš„åŸå§‹å‡ºå¤„æ˜¯è®ºæ–‡[2]ï¼Œä½œè€…åœ¨è®ºæ–‡ä¸­ç»™å‡ºçš„æœ€ç»ˆä¸€è‡´æ€§çš„å®šä¹‰å¦‚ä¸‹ï¼š\n\nEventual consistency. This is a specific form of weak consistency; the storage system guarantees that if no new updates are made to the object, eventually all accesses will return the last updated value.(è¯‘æ–‡ï¼šæœ€ç»ˆä¸€è‡´æ€§æ˜¯å¼±ä¸€è‡´æ€§çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ï¼›å­˜å‚¨ç³»ç»Ÿä¿è¯ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰æ–°çš„ä¿®æ”¹æ“ä½œï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è®¿é—®æœ€ç»ˆéƒ½ä¼šè¿”å›æœ€æ–°å†™å…¥çš„å€¼ã€‚)\n\næˆ‘ä»¬å‘ç°ï¼Œè™½ç„¶æœ€ç»ˆä¸€è‡´æ€§å’Œæœ¬æ–‡å‰é¢è®¨è®ºçš„çº¿æ€§ä¸€è‡´æ€§æˆ–é¡ºåºä¸€è‡´æ€§åœ¨å‘½åä¸Šéå¸¸ç›¸ä¼¼ï¼Œä½†å®ƒçš„å®šä¹‰å´ä¸åä¸¤è€…å­˜åœ¨éå¸¸å¤§çš„å·®åˆ«ã€‚æ·±å±‚çš„åŸå› åœ¨äºï¼Œå®ƒä»¬å…¶å®å±äºä¸åŒç±»åˆ«çš„ç³»ç»Ÿå±æ€§ (property)ã€‚çº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§å±äºsafety propertyï¼ˆå®‰å…¨æ€§ï¼‰ï¼›è€Œæœ€ç»ˆä¸€è‡´æ€§å±äºliveness propertyï¼ˆæ´»æ€§ï¼‰[8]ã€‚\nä¸€ä¸ªå¹¶å‘ç¨‹åºæˆ–è€…ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œå®ƒä»¬çš„æ‰§è¡Œæ‰€å±•ç°å‡ºæ¥çš„ç³»ç»Ÿå±æ€§ï¼Œå¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼š\n\n***safety**ï¼šå®ƒè¡¨ç¤ºã€Œåäº‹ã€æ°¸è¿œä¸ä¼šå‘ç”Ÿã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿå¦‚æœéµå®ˆçº¿æ€§ä¸€è‡´æ€§æˆ–é¡ºåºä¸€è‡´æ€§ï¼Œé‚£ä¹ˆå°±æ°¸è¿œä¸ä¼šå‡ºç°è¿åä¸‰ä¸ªï¼ˆå¯¹äºé¡ºåºä¸€è‡´æ€§æ¥è¯´æ˜¯ä¸¤ä¸ªï¼‰æ¡ä»¶çš„æ‰§è¡Œè¿‡ç¨‹ã€‚è€Œä¸€æ—¦ç³»ç»Ÿå‡ºç°é—®é¢˜ï¼Œsafety*è¢«è¿åäº†ï¼Œæˆ‘ä»¬ä¹Ÿèƒ½æ˜ç¡®æŒ‡å‡ºæ˜¯åœ¨å“ªä¸ªæ—¶é—´ç‚¹ä¸Šå‡ºç°æ„å¤–çš„ã€‚\n**liveness**ï¼šå®ƒè¡¨ç¤ºã€Œå¥½äº‹ã€æœ€ç»ˆä¼šå‘ç”Ÿã€‚è¿™ç§å±æ€§å¬èµ·æ¥ä¼šæ¯”è¾ƒç¥å¥‡ï¼šåœ¨ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œä½ éƒ½æ— æ³•åˆ¤å®šliveness*è¢«è¿åäº†ã€‚å› ä¸ºï¼Œå³ä½¿ä½ æœŸæœ›çš„ã€Œå¥½äº‹ã€è¿˜æ²¡æœ‰å‘ç”Ÿï¼Œä¹Ÿä¸ä»£è¡¨å®ƒæœªæ¥ä¸ä¼šå‘ç”Ÿã€‚å°±åƒæœ€ç»ˆä¸€è‡´æ€§ä¸€æ ·ï¼Œå³ä½¿å½“å‰ç³»ç»Ÿå¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ï¼Œä¹Ÿä¸ä»£è¡¨æœªæ¥ç³»ç»Ÿå°±ä¸ä¼šè¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚è€Œåªè¦ç³»ç»Ÿå­˜åœ¨â€œåœ¨æœªæ¥æŸä¸ªæ—¶åˆ»è¾¾åˆ°ä¸€è‡´çŠ¶æ€â€çš„å¯èƒ½æ€§ï¼Œæœ€ç»ˆä¸€è‡´æ€§å°±æ²¡æœ‰è¢«è¿åã€‚å¦å¤–ï¼Œå¯ç”¨æ€§ (availability) ä¹Ÿå±äºliveness*å±æ€§ã€‚\n\nç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬åœ¨å‰ä¸€å°èŠ‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿå°†çº¿æ€§ä¸€è‡´æ€§å’Œé¡ºåºä¸€è‡´æ€§æ”¾åœ¨ä¸€èµ·è®¨è®ºå’Œæ¯”è¾ƒï¼Œæ˜¯å› ä¸ºå®ƒä»¬éƒ½å±äºsafetyå±æ€§ã€‚è€Œæœ€ç»ˆä¸€è‡´æ€§å±äºlivenesså±æ€§ï¼Œè·Ÿè¿™ä¸¤è€…å­˜åœ¨æœ¬è´¨çš„åŒºåˆ«ã€‚å®é™…ä¸Šï¼Œæœ€ç»ˆä¸€è‡´æ€§æœ‰ç‚¹åä¸å‰¯å®ï¼Œå®ƒæ›´å¥½çš„åå­—å¯èƒ½æ˜¯æ”¶æ•›æ€§ (convergence)ï¼Œè¡¨ç¤ºæ‰€æœ‰å‰¯æœ¬æœ€ç»ˆéƒ½ä¼šæ”¶æ•›åˆ°ç›¸åŒçš„å€¼[9]ã€‚\né€šå¸¸æ¥è¯´ï¼Œåªæœ‰å½“safetyå’Œlivenessè¿™ä¸¤ç§å±æ€§è¢«åŒæ—¶è€ƒè™‘æ—¶ï¼Œä¸€ä¸ªç³»ç»Ÿæ‰èƒ½æä¾›æœ‰æ„ä¹‰çš„ç³»ç»Ÿä¿è¯[1]ã€‚è€Œå½“ç³»ç»Ÿè®¾è®¡è€…éµå¾ªæœ€ç»ˆä¸€è‡´æ€§çš„è®¾è®¡æ€è·¯æ—¶ï¼Œç›¸å½“äºæ”¾å¼ƒäº†æ‰€æœ‰çš„safetyå±æ€§ã€‚è¿™æ„å‘³ç€ï¼Œå¯¹äºç³»ç»Ÿä½¿ç”¨è€…æ¥è¯´ï¼Œä½ å¿…é¡»é’ˆå¯¹æ•°æ®ä¸ä¸€è‡´çš„å¯èƒ½æ€§åšå¥½è¡¥å¿æªæ–½ (compensation)ã€‚è¿™ä¹Ÿæ˜¯æœ€ç»ˆä¸€è‡´æ€§ç³»ç»Ÿéš¾ç”¨çš„åœ°æ–¹ã€‚ä½†ä¸ç®¡æ€ä¹ˆè¯´ï¼Œæœ€ç»ˆä¸€è‡´æ€§ä»ç„¶è¢«è®¤ä¸ºæ˜¯ç³»ç»Ÿæä¾›æ•°æ®ä¸€è‡´æ€§çš„æœ€ä½è¦æ±‚[1]ã€‚\nä¸€è‡´æ€§çš„å¼ºå¼±å…³ç³»åœ¨æœ¬æ–‡å¼€å¤´ï¼Œæˆ‘ä»¬æåˆ°è¿‡ï¼Œé€šå¸¸äººä»¬æŠŠçº¿æ€§ä¸€è‡´æ€§ç§°ä¸ºã€Œå¼ºä¸€è‡´æ€§ã€ï¼ŒæŠŠæœ€ç»ˆä¸€è‡´æ€§ç§°ä¸ºã€Œå¼±ä¸€è‡´æ€§ã€ã€‚ä½†å¯¹äºæŒ‡ä»£ç‰¹å®šçš„ä¸€ç§ä¸€è‡´æ€§æ¨¡å‹æ¥è¯´ï¼Œã€Œå¼ºä¸€è‡´æ€§ã€å’Œã€Œå¼±ä¸€è‡´æ€§ã€éƒ½ä¸æ˜¯ä¸€ä¸ªå¥½åå­—ã€‚å› ä¸ºå¼ºå’Œå¼±ï¼Œæ˜¯ä¸ªç›¸å¯¹çš„æ¦‚å¿µã€‚\næ ¹æ®æœ¬æ–‡å‰é¢çš„è®¨è®ºï¼Œä»çº¿æ€§ä¸€è‡´æ€§ï¼Œåˆ°é¡ºåºä¸€è‡´æ€§ï¼Œå†åˆ°æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸€è‡´æ€§çš„å¼ºåº¦ä¾æ¬¡å‡å¼±ã€‚ä½†æ˜¯ï¼Œä¸€è‡´æ€§æ¨¡å‹çš„å¼ºå¼±å…³ç³»ï¼Œå…¶å®æ˜¯æœ‰æ›´ä¸¥æ ¼çš„å®šä¹‰çš„ï¼š\n\nå½“ä¸”ä»…å½“ä¸€ä¸ªä¸€è‡´æ€§æ¨¡å‹æ‰€èƒ½æ¥å—çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œéƒ½èƒ½è¢«å¦ä¸€ä¸ªä¸€è‡´æ€§æ¨¡å‹æ‰€æ¥å—æ—¶ï¼ˆå‰è€…çš„é›†åˆæ˜¯åè€…é›†åˆçš„å­é›†ï¼‰ï¼Œæˆ‘ä»¬å°±è¯´å‰è€…æ˜¯æ¯”åè€…ã€Œæ›´å¼ºã€(stronger) çš„ä¸€è‡´æ€§æ¨¡å‹ã€‚\n\næŒ‰ç…§è¿™ä¸ªæ›´ä¸¥æ ¼çš„å¼ºå¼±å…³ç³»å®šä¹‰ï¼Œçº¿æ€§ä¸€è‡´æ€§æ˜¯æ¯”é¡ºåºä¸€è‡´æ€§æ›´å¼ºçš„ä¸€è‡´æ€§æ¨¡å‹ã€‚è¿™æ˜¯å› ä¸ºï¼Œçº¿æ€§ä¸€è‡´æ€§æ¯”é¡ºåºä¸€è‡´æ€§å¤šäº†ä¸€ä¸ªæ¡ä»¶IIIï¼Œæ‰€ä»¥å‡¡æ˜¯æ»¡è¶³çº¿æ€§ä¸€è‡´æ€§çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œè‚¯å®šä¹Ÿæ»¡è¶³é¡ºåºä¸€è‡´æ€§ã€‚\næˆ‘ä»¬ä»”ç»†åˆ†æä¸€ä¸‹ä¹Ÿèƒ½çŸ¥é“ï¼Œä¸€è‡´æ€§æ¨¡å‹çš„å¼ºå¼±å…³ç³»å®šä¹‰ï¼Œæ˜¯åŸºäºsafetyå±æ€§å®šä¹‰çš„ã€‚æ‰€ä»¥ï¼Œå°†çº¿æ€§ä¸€è‡´æ€§æˆ–é¡ºåºä¸€è‡´æ€§ä¸æœ€ç»ˆä¸€è‡´æ€§æ¯”è¾ƒå¼ºå¼±ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„åšæ³•ã€‚å®é™…ä¸Šï¼Œå°±åƒæˆ‘ä»¬å‰ä¸€å°èŠ‚æ‰€è®¨è®ºçš„ï¼Œæœ€ç»ˆä¸€è‡´æ€§åœ¨safetyæ–¹é¢æä¾›çš„ä¿è¯ä¸ºé›¶ï¼Œå®ƒæ˜¯å±äºlivenessçš„æ¦‚å¿µã€‚ä¸€ä¸ªç³»ç»Ÿå¯ä»¥åœ¨æä¾›æœ€ç»ˆä¸€è‡´æ€§çš„åŒæ—¶ï¼Œä¹Ÿæä¾›å¦å¤–ä¸€ç§æ›´å¼ºä¸€ç‚¹çš„å¸¦æœ‰safetyå±æ€§çš„ä¸€è‡´æ€§ï¼ˆæ¯”å¦‚å› æœä¸€è‡´æ€§ï¼‰ã€‚\nå°ç»“å°±å¦‚åŒæˆ‘åœ¨ä¹‹å‰å¦å¤–ä¸€ç¯‡æ–‡ç« ã€Šæ¼«è°ˆåˆ†å¸ƒå¼ç³»ç»Ÿã€æ‹œå åº­å°†å†›é—®é¢˜ä¸åŒºå—é“¾ã€‹ä¸­æ‰€æŒ‡å‡ºçš„ï¼Œç†è§£é—®é¢˜æœ¬èº«æ¯”çŸ¥é“é—®é¢˜çš„ç­”æ¡ˆè¦é‡è¦çš„å¤šã€‚æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬è¾¨æäº†çº¿æ€§ä¸€è‡´æ€§ã€é¡ºåºä¸€è‡´æ€§ã€æœ€ç»ˆä¸€è‡´æ€§è¿™äº›æ¦‚å¿µï¼Œä»¥åŠä»–ä»¬çš„å…³ç³»å’ŒåŒºåˆ«ã€‚ç”±æ­¤æˆ‘ä»¬äº†è§£åˆ°äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€äº›æ ¸å¿ƒé—®é¢˜ï¼Œä½†æˆ‘ä»¬å¹¶æœªè®¨è®ºæ€ä¹ˆè§£å†³è¿™äº›é—®é¢˜ã€‚æ¯”å¦‚ï¼Œé‡‡ç”¨ä»€ä¹ˆç®—æ³•æ‰èƒ½æä¾›çº¿æ€§ä¸€è‡´æ€§ï¼›é¢å¯¹æœ€ç»ˆä¸€è‡´æ€§çš„ç³»ç»Ÿï¼Œåº”è¯¥æ€æ ·ç¼–ç¨‹ï¼ŒåŒ…æ‹¬æ€æ ·å¤„ç†è¾¹ç•Œæƒ…å†µï¼Œç­‰ç­‰ã€‚ç›¸å¯¹äºç†è§£é—®é¢˜æœ¬èº«è€Œè¨€ï¼Œè¿™äº›åè€Œéƒ½æ˜¯ç»†èŠ‚ã€‚\n","categories":["åˆ†å¸ƒå¼"]},{"title":"ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡","url":"/posts/48330/","content":"ä¸€ã€ä»€ä¹ˆæ˜¯ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡&emsp;&emsp;ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡å°±æ˜¯æŠŠæœ¬åœ°æ¶ˆæ¯è¡¨ç‹¬ç«‹æˆä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶ç‹¬ç«‹æˆä¸€ä¸ªæœåŠ¡ã€‚è¿™æ ·åšå°±æ˜¯ä¸ºäº†é«˜å†…èšä½è€¦åˆã€‚è€Œä¸”è§£å†³äº†é‡å¤åˆ©ç”¨æ€§çš„é—®é¢˜ã€‚\näºŒã€ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåš&emsp;&emsp;æœ¬åœ°æ¶ˆæ¯è¡¨åˆ†å¸ƒå¼äº‹åŠ¡äº2008å¹´eBayæå‡ºæ¥ï¼Œå¾—åˆ°äº†ä¸šç•Œçš„å¹¿æ³›ä½¿ç”¨ï¼Œä½†è¯¥æ–¹æ¡ˆçš„ç¼ºé™·éå¸¸æ˜æ˜¾ï¼šä¸ºäº†è¾¾åˆ°æœ¬åœ°äº‹åŠ¡çš„æ•ˆæœï¼Œæ¶ˆæ¯æ•°æ®å’Œä¸šåŠ¡æ•°æ®å¿…é¡»åŒä¸€ä¸ªæ•°æ®åº“ï¼›è¿™ç§é—®é¢˜æ¯”è¾ƒå¤§ï¼Œè€¦åˆåº¦é«˜ï¼Œä¸å¯é‡å¤åˆ©ç”¨ã€‚\n&emsp;&emsp;ä¸ºæ­¤ï¼Œç»è¿‡10å¹´çš„å‘å±•ï¼Œä¸šç•Œåœ¨è¿™åŸºç¡€ä¸Šåšäº†å‡çº§ï¼Œå³å‡çº§ä¸º ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡åˆ†å¸ƒå¼\nä¸‰ã€ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡ä¸ä¸»åŠ¨è€…ä¹‹é—´çš„é€šä¿¡\n\nä¸»åŠ¨è€…å‘é€â€œå¾…å‘é€â€æ¶ˆæ¯ç»™æ¶ˆæ¯æœåŠ¡ã€‚\næ¶ˆæ¯æœåŠ¡æ”¶åˆ°æ¶ˆæ¯åï¼Œä¿æŒâ€œå¾…å‘é€â€æ¶ˆæ¯ï¼Œå¹¶è¿”å›ã€‚\næ”¯ä»˜æœåŠ¡ï¼Œç›´æ¥æ‰§è¡Œæœ¬åœ°ä¸šåŠ¡ã€‚\nå½“æœ¬åœ°ä¸šåŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œé€šçŸ¥æ¶ˆæ¯æœåŠ¡ï¼Œå‘Šè¯‰æ¶ˆæ¯æœåŠ¡ï¼Œå¯ä»¥å‘é€æ¶ˆæ¯äº†ã€‚\næ¶ˆæ¯æœåŠ¡æ”¶åˆ°æ”¯ä»˜æœåŠ¡çš„è¯·æ±‚ï¼Œå°†è¯¥æ¶ˆæ¯æ”¹ä¸ºâ€œå·²å‘é€â€ï¼ŒåŒæ—¶å‘é€MQæ¶ˆæ¯ã€‚\nä»¥ä¸Š5ä¸ªæ­¥éª¤éƒ½æˆåŠŸåï¼ŒæŠŠæ¶ˆæ¯æŠ•é€’ç»™æ¶ˆæ¯ä¸­é—´ä»¶MQã€‚\n\nå››ã€ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡ä¸è¢«åŠ¨è€…ä¹‹é—´çš„é€šä¿¡\n7.è¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰ï¼Œç›‘å¬MQæ¶ˆæ¯ï¼Œå¹¶è·å–æ¶ˆæ¯å†…å®¹ã€‚\n8.è¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰ï¼ŒæŒ‰MQæ¶ˆæ¯å†…å®¹ï¼Œå¤„ç†æœ¬åœ°ä¸šåŠ¡ï¼Œmq client ä¸»åŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶MQè¿”å›ACKæ¶ˆæ¯ã€‚\n9.è¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰ï¼Œæ¶ˆè´¹æˆåŠŸåï¼Œé€šçŸ¥æ¶ˆæ¯æœåŠ¡ï¼Œæˆ‘å·²ç»æˆåŠŸæ¶ˆè´¹äº†ï¼›æ¶ˆæ¯æœåŠ¡æŠŠæ¶ˆæ¯çŠ¶æ€æ”¹ä¸ºâ€œå·²å®Œæˆâ€æˆ–ç›´æ¥åˆ é™¤å³å¯ã€‚\näº”ã€ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡çš„é€šä¿¡å¼‚å¸¸åˆ†æç¬¬1ã€2æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šæ— å½±å“ï¼Œå› ä¸ºå½“å‰æ¶ˆæ¯æœåŠ¡çš„æ¶ˆæ¯æœªè½åœ°ã€‚\nç¬¬3æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šæœ‰å½±å“ï¼Œå½“å‰æ¶ˆæ¯æœåŠ¡çš„æ¶ˆæ¯ä¸ºâ€œå¾…å‘é€â€ï¼Œä¸»åŠ¨è€…ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰æ²¡æœ‰æ‰§è¡Œä¸šåŠ¡ï¼Œå¯¼è‡´è¯¥æ¡æ•°æ®ä¸ºè„æ•°æ®ã€‚\nç¬¬4ã€5æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šä¸¥é‡ï¼Œå°†å¯¼è‡´æ¶ˆæ¯æœåŠ¡çš„æ¶ˆæ¯ä¸ºâ€œå¾…å‘é€â€ï¼Œä½†ä¸»åŠ¨è€…ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰æ‰§è¡Œäº†ä¸šåŠ¡ï¼Œæœ€ç»ˆæ¶ˆæ¯å‘ä¸å‡ºå»ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚\nç¬¬6æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šä¸¥é‡ï¼Œæ¶ˆæ¯å‘ä¸å‡ºå»ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´ã€‚\nç¬¬7æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šä¸¥é‡ï¼Œå½“å‰æ¶ˆæ¯æœåŠ¡çš„â€œå·²å‘é€â€æ¶ˆæ¯ï¼Œæ— æ³•æ¶ˆè´¹ã€‚\nç¬¬8æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šä¸¥é‡ï¼Œå½“å‰æ¶ˆæ¯æœåŠ¡çš„â€œå·²å‘é€â€æ¶ˆæ¯ï¼Œæ— æ³•æ¶ˆè´¹ã€‚\nç¬¬9æ­¥éª¤å‘ç”Ÿå¼‚å¸¸ï¼šä¸¥é‡ï¼Œè¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰å·²ç»æ¶ˆè´¹æˆåŠŸåï¼Œä½†æ˜¯æ¶ˆæ¯æœåŠ¡ä¸çŸ¥é“ã€‚\näº”ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯100%å‘é€æˆåŠŸ\næŠ•é€’ä¸æˆåŠŸçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸»è¦æ˜¯é’ˆå¯¹3ã€4ã€5æ­¥éª¤å‘é€å¼‚å¸¸å¯¼è‡´ã€‚æ•…åªè¦è§£å†³3ã€4ã€5æ­¥éª¤çš„å¼‚å¸¸é—®é¢˜ï¼Œå°±èƒ½ä¿è¯æ¶ˆæ¯çš„å‘é€æˆåŠŸã€‚\nä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±å‘é€æˆåŠŸçš„æ–¹æ¡ˆï¼š\né‡‡ç”¨å®šæ—¶å™¨è½®è¯¢ç¡®è®¤æœºåˆ¶ï¼Œç”±ä¸»åŠ¨è€…ï¼ˆæ”¯ä»˜æœåŠ¡ï¼‰æä¾›ä¸€ä¸ªå¯ä¾›æ¶ˆæ¯æœåŠ¡æŸ¥è¯¢æ¶ˆæ¯è¿½æº¯ä¸šåŠ¡æ‰§è¡ŒçŠ¶æ€çš„æ¥å£ï¼›\nå¦‚æœä¸šåŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåˆ™æ›´æ”¹æ¶ˆæ¯çš„çŠ¶æ€ä¸ºâ€œå·²å‘é€â€ï¼›\nå¦åˆ™åˆ é™¤æ­¤æ¡æ¶ˆæ¯ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚\nå…·ä½“ç»†èŠ‚ï¼š\n\nå®šæ—¶å™¨è½®è¯¢è¿‡æœŸâ€œå¾…å‘é€â€çŠ¶æ€çš„æ¶ˆæ¯ï¼ˆè¿‡æœŸæ¶ˆæ¯ä¸€èˆ¬æ˜¯æ ¹æ®ä¸šåŠ¡è§„åˆ™è‡ªè¡Œè°ƒæ•´ï¼Œä¾‹å¦‚2åˆ†é’Ÿï¼‰ã€‚\næ¶ˆæ¯æœåŠ¡å‘æ”¯ä»˜æœåŠ¡å‘èµ·çŠ¶æ€æŸ¥è¯¢ï¼Œå¹¶ä¸”æ”¯ä»˜æœåŠ¡è¿”å›ä¸šåŠ¡æ‰§è¡ŒçŠ¶æ€ã€‚\næ¶ˆæ¯æœåŠ¡å¯¹æ¶ˆæ¯è¿›è¡Œç¡®è®¤ï¼šå¦‚æœä¸šåŠ¡æ‰§è¡ŒæˆåŠŸï¼Œåˆ™å‘é€MQæ¶ˆæ¯å¹¶æ›´æ”¹æ¶ˆæ¯çŠ¶æ€ä¸ºâ€œå·²å‘é€â€ï¼Œå¦åˆ™åˆ é™¤æ­¤æ¡æ¶ˆæ¯ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚\n\nå¦‚ä½•ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ï¼Œ100%å‘é€æˆåŠŸï¼Œæ ¸å¿ƒç‚¹å°±æ˜¯ä¿è¯â€œå¾…å‘é€â€å˜ä¸ºâ€œå·²å‘é€â€ã€‚\nå…­ã€å¦‚ä½•ä¿è¯æ¶ˆæ¯100%æ¶ˆè´¹æˆåŠŸ\næ¶ˆè´¹ä¸æˆåŠŸçš„ä¸šåŠ¡åœºæ™¯ï¼Œä¸»è¦6ã€7ã€8ã€9æ­¥éª¤å‘ç”Ÿå¼‚å¸¸æ˜¯ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹ä¸æˆåŠŸï¼›æ•…åªéœ€è¦è§£å†³æ­¥éª¤6ã€7ã€8ã€9å°±èƒ½ä¿è¯æ¶ˆæ¯æ¶ˆè´¹æˆåŠŸã€‚\nè§£å†³æ–¹æ¡ˆï¼š\né‡‡ç”¨å®šæ—¶å™¨è½®è¯¢è¿‡æœŸçš„â€œå·²å‘é€â€æ•°æ®ï¼Œåœ¨ä¿è¯å¹‚ç­‰æ€§çš„æ¡ä»¶ä¸‹ï¼Œè¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰ç›‘å¬åˆ°æ¶ˆæ¯åï¼Œé‡æ–°æ‰§è¡Œä¸šåŠ¡ï¼Œå¹¶é€šçŸ¥æ¶ˆæ¯æœåŠ¡æŠŠè¯¥æ¶ˆæ¯æ›´æ”¹ä¸ºâ€œå·²å®Œæˆâ€ï¼Œæœ€ç»ˆä¿è¯ä¸»åŠ¨è€…å’Œè¢«åŠ¨è€…çš„æ•°æ®ä¸€è‡´æ€§ã€‚\nå…·ä½“ç»†èŠ‚ï¼š\n\næ¶ˆæ¯æœåŠ¡å®šæœŸè½®è¯¢ï¼Œè¿‡æœŸçš„â€œå·²å‘é€â€æ¶ˆæ¯ï¼ˆè¿‡æœŸä¸€èˆ¬æ˜¯æ ¹æ®ä¸šåŠ¡è§„åˆ™æ¥è‡ªè¡Œè°ƒæ•´ï¼Œä¾‹å¦‚2åˆ†é’Ÿï¼‰\næ¶ˆæ¯æœåŠ¡é‡æ–°å°†è¿‡æœŸçš„â€œå·²å‘é€â€æ¶ˆæ¯ï¼Œå‘é€åˆ°æ¶ˆæ¯ä¸­é—´ä»¶MQä¸­ã€‚\nè¢«åŠ¨è€…ï¼ˆç§¯åˆ†æœåŠ¡ï¼‰ç›‘å¬åˆ°æ¶ˆæ¯åï¼Œåœ¨ä¿è¯å¹‚ç­‰æ€§çš„æƒ…å†µä¸‹é‡æ–°æ‰§è¡Œä¸šåŠ¡ã€‚\nè¢«åŠ¨è€…é€šçŸ¥æ¶ˆæ¯æœåŠ¡ï¼Œæ¶ˆè´¹æœåŠ¡å°†è¯¥æ¶ˆæ¯è®¾ç½®ä¸ºâ€œå·²å®Œæˆâ€æˆ–ç›´æ¥åˆ é™¤ã€‚æœ€ç»ˆä¿è¯äº†ä¸»åŠ¨è€…å’Œè¢«åŠ¨è€…çš„æ•°æ®ä¸€è‡´æ€§ã€‚\n\nä¸ƒã€ç‹¬ç«‹æ¶ˆæ¯æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡ä¼˜ç¼ºç‚¹ä¼˜ç‚¹ï¼š\nè§£è€¦ï¼Œé™ä½äº†ä¸šåŠ¡ç³»ç»Ÿå’Œæ¶ˆæ¯ç³»ç»Ÿä¹‹é—´çš„è€¦åˆåº¦ã€‚\næ¶ˆæ¯æœåŠ¡æ›´åŠ çµæ´»äº†ï¼Œä¼¸ç¼©æ€§å¼ºï¼Œç‹¬ç«‹éƒ¨ç½²ï¼Œç‹¬ç«‹ç»´æŠ¤ã€‚\nç›¸æ¯”æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œé™ä½äº†å¼€å‘æˆæœ¬ï¼Œæ¶ˆæ¯æœåŠ¡å¯ä»¥å…±ç”¨ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å»ºè¡¨ã€‚\n\nç¼ºç‚¹ï¼š\nä¸»åŠ¨è€…å¿…é¡»å®ç°æ¶ˆæ¯çŠ¶æ€å›æŸ¥çš„æ¥å£ã€‚\néœ€è¦2ä¸ªå®šæ—¶å™¨ï¼Œå¯¹è¿‡æœŸçš„çŠ¶æ€è¿›è¡Œé‡è¯•æ“ä½œã€‚\nä¸»åŠ¨è€…é€šçŸ¥è¢«åŠ¨è€…ï¼Œéœ€è¦å‘é€2æ¬¡æ¶ˆæ¯ï¼Œè¿‡äºå¤æ‚ã€‚\n\né¢è¯•é¢˜1.ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸€ä¸ªâ€œå¾…å‘é€â€æ¶ˆæ¯æœºåˆ¶ï¼Ÿä¸ºä»€ä¹ˆä¸ä¸šåŠ¡æˆåŠŸåç›´æ¥å‘é€ï¼Ÿ\nå¦‚æœä¸šåŠ¡æ‰§è¡ŒæˆåŠŸåï¼Œå†å‘é€æ¶ˆæ¯ï¼Œå¦‚æœå‘é€å¤±è´¥é‡‡ç”¨é‡è¯•æœºåˆ¶æ¥è§£å†³ï¼Œå½“ä¸šåŠ¡ç³»ç»Ÿå®•æœºæˆ–è€…é‡å¯ï¼Œå°±ä¼šå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±ï¼Œæœ€ç»ˆé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚\næŠŠ ä¸šåŠ¡æ‰§è¡ŒæˆåŠŸï¼Œå‘é€æ¶ˆæ¯ æ”¾åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œçœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†å‘é€è¶…æ—¶å…¶å®æ˜¯æˆåŠŸçš„ï¼Œå°±ä¼šå¯¼è‡´ä¸šåŠ¡å›æ»šï¼Œæœ€ç»ˆä¸ä¸€è‡´ã€‚\n\n2.å¦‚æœè¢«åŠ¨è€…æ¶ˆè´¹å¤±è´¥äº†æ€ä¹ˆåŠï¼Œæ˜¯å¦éœ€è¦ä¸»åŠ¨è€…åšå›æ»šï¼Ÿä¸»åŠ¨è€…ä¸ä¼šå› ä¸ºè¢«åŠ¨è€…çš„å¤±è´¥è€Œå›æ»šï¼Œå› ä¸ºåŸºäºæ¶ˆæ¯çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œè¯¥æŠ€æœ¯æ–¹æ¡ˆçš„ç›®çš„æ˜¯é«˜å¯ç”¨å’Œæœ€ç»ˆä¸€è‡´æ€§ï¼Œæ•…ï¼Œå®ƒä¸ä¼šå› ä¸ºè¢«åŠ¨è€…å¤±è´¥äº†å°±åšå›æ»šæ“ä½œï¼Œä¸€èˆ¬çš„åšæ³•æ˜¯é‡‡ç”¨MQè´Ÿè´£é‡è¯•ï¼Œç›´åˆ°è¢«åŠ¨è€…æˆåŠŸä¸ºæ­¢ã€‚\n3.å¦‚æœè¢«åŠ¨è€…å› ä¸ºä¸šåŠ¡å¼‚å¸¸å¿…é¡»å›æ»šï¼ˆä¾‹å¦‚åº“å­˜ä¸è¶³ï¼‰ï¼Œè¯¥æ€ä¹ˆåŠï¼ŸåŸºäºæ¶ˆæ¯çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œå¿…é¡»ä¿è¯è¢«åŠ¨è€…çš„ä¸šåŠ¡æ²¡æœ‰å¼‚å¸¸ï¼Œå®ƒ åªå…è®¸ç³»ç»Ÿå¼‚å¸¸ï¼Œä¸å…è®¸ä¸šåŠ¡å¼‚å¸¸ã€‚\nä¾‹å¦‚ä¸‹å•å‡åº“å­˜ã€æ‰£ä¼˜æƒ åˆ¸çš„é—®é¢˜ï¼Œä¸€èˆ¬é‡‡ç”¨ TCCäº‹åŠ¡ æ¥è§£å†³ã€‚\n","categories":["åˆ†å¸ƒå¼"]},{"title":"Aviator è§„åˆ™å¼•æ“","url":"/posts/15100/","content":"Githubï¼šhttps://github.com/killme2008/aviatorscript\næ–‡æ¡£ï¼šhttps://www.yuque.com/boyan-avfmj/aviatorscript\nä¾èµ–&lt;dependency&gt;  &lt;groupId&gt;com.googlecode.aviator&lt;/groupId&gt;  &lt;artifactId&gt;aviator&lt;/artifactId&gt;  &lt;version&gt;&#123;version&#125;&lt;/version&gt;&lt;/dependency&gt;","categories":["å®ç”¨ç±»åº“"]},{"title":"Dubbo3","url":"/posts/3153/","content":"Dubbo3 å®˜æ–¹æ–‡æ¡£\nä¸€ã€ä¾èµ–implementation &#x27;org.apache.dubbo:dubbo-spring-boot-starter:3.0.7&#x27;\n\nè‹¥ä½¿ç”¨ Nacos ä½œä¸ºæ³¨å†Œä¸­å¿ƒéœ€æ·»åŠ ä¾èµ–\nimplementation &#x27;org.apache.dubbo:dubbo-registry-nacos:3.0.7&#x27;\n\näºŒã€é…ç½®\nSpring Boot 2.6.6\n\nåº”ç”¨çº§åœ°å€å‘ç°è¿ç§»æŒ‡å—\n1. ç”Ÿäº§è€…æ·»åŠ æ³¨è§£ç”Ÿäº§è€…éœ€è¦åœ¨å¯åŠ¨ç±»ä¸Šæ·»åŠ  @EnableDubbo æ³¨è§£ã€‚\né…ç½®æ–‡ä»¶å¯åœ¨ application.yaml é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  dubbo.application.register-mode é…ç½®åº”ç”¨å‘ç°æ–¹å¼ã€‚\nå¯é€‰å€¼ï¼š\n\ninterfaceï¼šåªæ³¨å†Œæ¥å£çº§\ninstanceï¼šåªæ³¨å†Œåº”ç”¨çº§\nallï¼šå³æ¥å£çº§åœ°å€ã€åº”ç”¨çº§åœ°å€éƒ½æ³¨å†Œ\n\ndubbo:  application:    name: $&#123;spring.application.name&#125;    # å¯é€‰å€¼ interfaceã€instanceã€allï¼Œé»˜è®¤æ˜¯ allï¼Œå³æ¥å£çº§åœ°å€ã€åº”ç”¨çº§åœ°å€éƒ½æ³¨å†Œ    register-mode: instance  protocol:    name: dubbo    port: 18002  registry:    address: nacos://localhost:8848    version: 1.0.0#  provider:#    group: dubbo-demo\n\n2. æ¶ˆè´¹è€…é…ç½®æ–‡ä»¶å¯åœ¨ application.yaml é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  dubbo.application.service-discovery.migration é…ç½®æ¶ˆè´¹è€…è·å–ç”Ÿäº§è€…åœ°å€åˆ—è¡¨çš„æ–¹å¼ã€‚\nå¯é€‰å€¼ï¼š\n\nFORCE_INTERFACEï¼šåªæ¶ˆè´¹æ¥å£çº§åœ°å€ï¼Œå¦‚æ— åœ°å€åˆ™æŠ¥é”™ï¼Œå•è®¢é˜… 2.x åœ°å€ï¼›\nAPPLICATION_FIRSTï¼šæ™ºèƒ½å†³ç­–æ¥å£çº§/åº”ç”¨çº§åœ°å€ï¼ŒåŒè®¢é˜…ï¼›\nFORCE_APPLICATIONï¼šåªæ¶ˆè´¹åº”ç”¨çº§åœ°å€ï¼Œå¦‚æ— åœ°å€åˆ™æŠ¥é”™ï¼Œå•è®¢é˜… 3.x åœ°å€ã€‚\n\ndubbo:  application:    name: $&#123;spring.application.name&#125;    # é‡‡ç”¨åº”ç”¨çº§æœåŠ¡å‘ç°    service-discovery:      migration: APPLICATION_FIRST  registry:    address: nacos://localhost:8848    version: 1.0.0#  consumer:#    group: dubbo-demo\n\n","categories":["å®ç”¨ç±»åº“"],"tags":["SpringBoot","RPC"]},{"title":"Guice è½»é‡çº§ DI æ¡†æ¶","url":"/posts/34144/","content":"å…¶ä»–èµ„æ–™ï¼šhttps://iowiki.com/guice/guice_quick_guide.html\nèƒŒæ™¯åœ¨æ—¥å¸¸å†™ä¸€äº›å°å·¥å…·æˆ–è€…å°é¡¹ç›®çš„æ—¶å€™ï¼Œæœ‰ä¾èµ–ç®¡ç†å’Œä¾èµ–æ³¨å…¥çš„éœ€æ±‚ï¼Œä½†æ˜¯Spring(Boot)ä½“ç³»ä½œä¸ºDIæ¡†æ¶è¿‡äºé‡é‡çº§ï¼Œäºæ˜¯éœ€è¦è°ƒç ”ä¸€æ¬¾å¾®å‹çš„DIæ¡†æ¶ã€‚Guiceæ˜¯Googleå‡ºå“çš„ä¸€æ¬¾è½»é‡çº§çš„ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼Œä½¿ç”¨å®ƒæœ‰åŠ©äºè§£å†³é¡¹ç›®ä¸­çš„ä¾èµ–æ³¨å…¥é—®é¢˜ï¼Œæé«˜äº†å¯ç»´æŠ¤æ€§å’Œçµæ´»æ€§ã€‚ç›¸å¯¹äºé‡é‡çº§çš„Spring(Boot)ä½“ç³»ï¼ŒGuiceé¡¹ç›®åªæœ‰ä¸€ä¸ªå°äº1MBçš„æ ¸å¿ƒæ¨¡å—ï¼Œå¦‚æœæ ¸å¿ƒéœ€æ±‚æ˜¯DIï¼ˆå…¶å®Guiceä¹Ÿæä¾›äº†å¾ˆä½å±‚æ¬¡çš„AOPå®ç°ï¼‰ï¼Œé‚£ä¹ˆGuiceåº”è¯¥ä¼šæ˜¯ä¸€ä¸ªåˆé€‚çš„å€™é€‰æ–¹æ¡ˆã€‚\n\nåœ¨æŸ¥æ‰¾Guiceç›¸å…³èµ„æ–™çš„æ—¶å€™ï¼Œè§åˆ°ä¸å°‘ä»‹ç»æ–‡ç« åæ§½Guiceè¿‡äºç®€é™‹ï¼Œéœ€è¦åœ¨Moduleä¸­æ³¨å†Œæ¥å£å’Œå®ç°çš„é“¾æ¥å…³ç³»ï¼Œæ˜¾å¾—ååˆ†ç®€é™‹ã€‚åŸå› æ˜¯ï¼šGuiceæ˜¯æåº¦ç²¾ç®€çš„DIå®ç°ï¼Œæ²¡æœ‰æä¾›Classæ‰«æå’Œè‡ªåŠ¨æ³¨å†Œçš„åŠŸèƒ½ã€‚ä¸‹æ–‡ä¼šæä¾›ä¸€äº›æ€è·¯å»å®ç° ClassPath ä¸‹çš„Beanè‡ªåŠ¨æ‰«ææ–¹æ¡ˆ\n\nä¾èµ–å¼•å…¥ä¸å…¥é—¨ç¤ºä¾‹Guiceåœ¨5.xç‰ˆæœ¬åæ•´åˆäº†ä½ç‰ˆæœ¬çš„æ‰©å±•ç±»åº“ï¼Œç›®å‰ä½¿ç”¨å…¶æ‰€æœ‰åŠŸèƒ½åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–å³å¯ï¼Œå½“å‰ï¼ˆ2022-02å‰åï¼‰æœ€æ–°ç‰ˆæœ¬ä¾èµ–ä¸ºï¼š\n&lt;dependency&gt;    &lt;groupId&gt;com.google.inject&lt;/groupId&gt;    &lt;artifactId&gt;guice&lt;/artifactId&gt;    &lt;version&gt;5.1.0&lt;/version&gt;&lt;/dependency&gt;\n\nä¸€ä¸ªå…¥é—¨ä¾‹å­å¦‚ä¸‹ï¼š\npublic class GuiceDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new DemoModule());        Greeter first = injector.getInstance(Greeter.class);        Greeter second = injector.getInstance(Greeter.class);        System.out.printf(&quot;first hashcode =&gt; %s\\n&quot;, first.hashCode());        first.sayHello();        System.out.printf(&quot;second hashcode =&gt; %s\\n&quot;, second.hashCode());        second.sayHello();    &#125;    @Retention(RUNTIME)    public @interface Count &#123;    &#125;    @Retention(RUNTIME)    public @interface Message &#123;    &#125;    @Singleton    public static class Greeter &#123;        private final String message;        private final Integer count;        @Inject        public Greeter(@Message String message,                       @Count Integer count) &#123;            this.message = message;            this.count = count;        &#125;        public void sayHello() &#123;            for (int i = 1; i &lt;= count; i++) &#123;                System.out.printf(&quot;%s,count =&gt; %d\\n&quot;, message, i);            &#125;        &#125;    &#125;    public static class DemoModule extends AbstractModule &#123;        @Override        public void configure() &#123;//            bind(Greeter.class).in(Scopes.SINGLETON);        &#125;        @Provides        @Count        public static Integer count() &#123;            return 2;        &#125;        @Provides        @Count        public static String message() &#123;            return &quot;vlts.cn&quot;;        &#125;    &#125;&#125;\n\næ‰§è¡Œmainæ–¹æ³•æ§åˆ¶å°è¾“å‡ºï¼š\nfirst hashcode =&gt; 914507705vlts.cn,count =&gt; 1vlts.cn,count =&gt; 2second hashcode =&gt; 914507705vlts.cn,count =&gt; 1vlts.cn,count =&gt; 2\n\nGreeterç±»éœ€è¦æ³¨å†Œä¸ºå•ä¾‹ï¼ŒGuiceä¸­æ³¨å†Œçš„å®ä¾‹å¦‚æœä¸æ˜¾å¼æŒ‡å®šä¸ºå•ä¾‹ï¼Œé»˜è®¤éƒ½æ˜¯åŸå‹ï¼ˆPrototypeï¼Œæ¯æ¬¡é‡æ–°æ„é€ ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼‰ã€‚Guiceæ³¨å†Œä¸€ä¸ªå•ä¾‹ç›®å‰æ¥çœ‹ä¸»è¦æœ‰ä¸‰ç§æ–¹å¼ï¼š\n\næ–¹å¼ä¸€ï¼šåœ¨ç±»ä¸­ä½¿ç”¨æ³¨è§£@Singletonï¼ˆä½¿ç”¨Injector#getInstance()ä¼šæ‡’åŠ è½½å•ä¾‹ï¼‰\n\n@Singletonpublic static class Greeter &#123;    ......&#125;\n\n\næ–¹å¼äºŒï¼šæ³¨å†Œç»‘å®šå…³ç³»çš„æ—¶å€™æ˜¾å¼æŒ‡å®šScopeä¸ºScopes.SINGLETON\n\npublic static class DemoModule extends AbstractModule &#123;    @Override    public void configure() &#123;        bind(Greeter.class).in(Scopes.SINGLETON);        // å¦‚æœGreeterå·²ç»ä½¿ç”¨äº†æ³¨è§£@Singletonå¯ä»¥æ— éœ€æŒ‡å®šin(Scopes.SINGLETON)ï¼Œä»…bind(Greeter.class)å³å¯    &#125;    &#125;\n\n\næ–¹å¼ä¸‰ï¼šç»„åˆä½¿ç”¨æ³¨è§£@Provideså’Œ@Singletonï¼Œæ•ˆæœç±»ä¼¼äºSpringä¸­çš„@Beanæ³¨è§£\n\npublic static class SecondModule extends AbstractModule &#123;    @Override    public void configure() &#123;        // config module    &#125;    @Provides    @Singleton    public Foo foo() &#123;        return new Foo();    &#125;&#125;public static class Foo &#123;&#125;\n\nä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¦‚æœGreeterç±»ä¸ä½¿ç”¨@Singletonï¼ŒåŒæ—¶æ³¨é‡Šæ‰bind(Greeter.class).in(Scopes.SINGLETON);ï¼Œé‚£ä¹ˆæ‰§è¡Œmainæ–¹æ³•ä¼šå‘ç°ä¸¤æ¬¡ä»æ³¨å…¥å™¨ä¸­è·å–åˆ°çš„å®ä¾‹çš„hashCodeä¸ä¸€è‡´ï¼Œä¹Ÿå°±æ˜¯ä¸¤æ¬¡ä»æ³¨å…¥å™¨ä¸­è·å–åˆ°çš„éƒ½æ˜¯é‡æ–°åˆ›å»ºçš„å®ä¾‹ï¼ˆhashCodeä¸ç›¸åŒï¼‰ï¼š\nGuiceä¸­æ‰€æœ‰å•ä¾‹é»˜è®¤æ˜¯æ‡’åŠ è½½çš„ï¼Œç†è§£ä¸ºå•ä¾‹åˆå§‹åŒ–ä½¿ç”¨äº†ã€Œæ‡’æ±‰æ¨¡å¼ã€ï¼Œå¯ä»¥é€šè¿‡ScopedBindingBuilder#asEagerSingleton()æ ‡è®°å•ä¾‹ä¸ºé¥¥é¥¿åŠ è½½æ¨¡å¼ï¼Œå¯ä»¥ç†è§£ä¸ºåˆ‡æ¢å•ä¾‹åŠ è½½æ¨¡å¼ä¸ºã€Œé¥¿æ±‰æ¨¡å¼ã€ã€‚\nGuiceæ³¨å…¥å™¨åˆå§‹åŒ–Guiceæ³¨å…¥å™¨æ¥å£Injectoræ˜¯å…¶æ ¸å¿ƒAPIï¼Œç±»æ¯”ä¸ºSpringä¸­çš„BeanFactoryã€‚Injectoråˆå§‹åŒ–ä¾èµ–äºä¸€æˆ–å¤šä¸ªæ¨¡å—ï¼ˆcom.google.inject.Moduleï¼‰çš„å®ç°ã€‚åˆå§‹åŒ–Injectorçš„ç¤ºä¾‹å¦‚ä¸‹ï¼š\npublic class GuiceInjectorDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(                new FirstModule(),                new SecondModule()        );        //  injector.getInstance(Foo.class);    &#125;    public static class FirstModule extends AbstractModule &#123;        @Override        public void configure() &#123;            // config module        &#125;    &#125;    public static class SecondModule extends AbstractModule &#123;        @Override        public void configure() &#123;            // config module        &#125;    &#125;&#125;\n\nInjectoræ”¯æŒåŸºäºå½“å‰å®ä¾‹åˆ›å»ºå­Injectorå®ä¾‹ï¼Œç±»æ¯”äºSpringä¸­çš„çˆ¶å­IOCå®¹å™¨ï¼š\npublic class GuiceChildInjectorDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector parent = Guice.createInjector(                new FirstModule()        );        Injector childInjector = parent.createChildInjector(new SecondModule());    &#125;    public static class FirstModule extends AbstractModule &#123;        @Override        public void configure() &#123;            // config module        &#125;    &#125;    public static class SecondModule extends AbstractModule &#123;        @Override        public void configure() &#123;            // config module        &#125;    &#125;&#125;\n\nå­Injectorå®ä¾‹ä¼šç»§æ‰¿çˆ¶Injectorå®ä¾‹çš„æ‰€æœ‰çŠ¶æ€ï¼ˆæ‰€æœ‰ç»‘å®šã€Scopeã€æ‹¦æˆªå™¨å’Œè½¬æ¢å™¨ç­‰ï¼‰ã€‚\nGuiceå¿ƒæ™ºæ¨¡å‹\nå¿ƒæ™ºæ¨¡å‹ï¼ˆMental Modelï¼‰çš„æ¦‚å¿µæ¥è‡ªäºè®¤çŸ¥å¿ƒç†å­¦ï¼Œå¿ƒæ™ºæ¨¡å‹æŒ‡çš„æ˜¯æŒ‡è®¤çŸ¥ä¸»ä½“è¿ç”¨æ¦‚å¿µå¯¹è‡ªèº«ä½“éªŒè¿›è¡Œåˆ¤æ–­ä¸åˆ†ç±»çš„ä¸€ç§æƒ¯æ€§åŒ–çš„å¿ƒç†æœºåˆ¶æˆ–æ—¢å®šçš„è®¤çŸ¥æ¡†æ¶\n\nGuiceåœ¨è®¤çŸ¥ä¸Šå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªmapï¼ˆæ–‡æ¡£ä¸­è¡¨ç¤ºä¸ºmap[^guice-map]ï¼‰ï¼Œåº”ç”¨ç¨‹åºä»£ç å¯ä»¥é€šè¿‡è¿™ä¸ªmapå£°æ˜å’Œè·å–åº”ç”¨ç¨‹åºå†…çš„ä¾èµ–ç»„ä»¶ã€‚è¿™ä¸ªGuice Mapæ¯ä¸€ä¸ªMap.Entryæœ‰ä¸¤ä¸ªéƒ¨åˆ†ï¼š\n\nGuice Keyï¼šGuice Mapä¸­çš„é”®ï¼Œç”¨äºè·å–è¯¥mapä¸­ç‰¹å®šçš„å€¼\nProviderï¼šGuice Mapä¸­çš„å€¼ï¼Œç”¨äºåˆ›å»ºåº”ç”¨äºåº”ç”¨ç¨‹åºå†…çš„ï¼ˆç»„ä»¶ï¼‰å¯¹è±¡\n\nè¿™ä¸ªæŠ½è±¡çš„Guice Mapæœ‰ç‚¹åƒä¸‹é¢è¿™æ ·çš„ç»“æ„ï¼š\n// com.google.inject.Key =&gt; com.google.inject.Providerprivate final ConcurrentMap&lt;Key&lt;?&gt;, Provider&lt;?&gt;&gt; guiceMap = new ConcurrentHashMap&lt;&gt;();\n\nGuice Keyç”¨äºæ ‡è¯†Guice Mapä¸­çš„ä¸€ä¸ªä¾èµ–ç»„ä»¶ï¼Œè¿™ä¸ªé”®æ˜¯å…¨å±€å”¯ä¸€çš„ï¼Œç”±com.google.inject.Keyå®šä¹‰ã€‚é‰´äºJavaé‡Œé¢æ²¡æœ‰å½¢å‚ï¼ˆä¹Ÿå°±æ˜¯æ–¹æ³•çš„å…¥å‚åˆ—è¡¨æˆ–è€…è¿”å›å€¼åªæœ‰é¡ºåºå’Œç±»å‹ï¼Œæ²¡æœ‰åç§°ï¼‰ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™åœ¨æ„å»ºGuice Keyçš„æ—¶å€™æ—¢éœ€è¦ä¾èµ–ç»„ä»¶çš„ç±»å‹ï¼Œæ— æ³•å”¯ä¸€ç¡®å®šç»„ä»¶ç±»å‹çš„æ—¶å€™ï¼ˆä¾‹å¦‚ä¸€äº›å®šä¹‰å¸¸é‡çš„åœºæ™¯ï¼Œåªè¦æ»¡è¶³å¸¸é‡çš„åœºæ™¯ï¼Œå¯¹äºç±»å®ä¾‹ä¹Ÿæ˜¯å¯è¡Œçš„ï¼‰ï¼Œéœ€è¦é¢å¤–å¢åŠ ä¸€ä¸ªè‡ªå®šä¹‰æ³¨è§£ç”¨äºç”Ÿæˆç»„åˆçš„å”¯ä¸€æ ‡è¯†Type + Annotation(Type)ã€‚ä¾‹å¦‚ï¼š\n\n@Message Stringç›¸å½“äºKey&lt;String&gt;\n@Count intç›¸å½“äºKey&lt;Integer&gt;\n\npublic class GuiceMentalModelDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new EchoModule());        EchoService echoService = injector.getInstance(EchoService.class);    &#125;    @Qualifier    @Retention(RUNTIME)    public @interface Count &#123;    &#125;    @Qualifier    @Retention(RUNTIME)    public @interface Message &#123;    &#125;    public static class EchoModule extends AbstractModule &#123;        @Override        public void configure() &#123;            bind(EchoService.class).in(Scopes.SINGLETON);        &#125;        @Provides        @Message        public String messageProvider() &#123;            return &quot;foo&quot;;        &#125;        @Provides        @Count        public Integer countProvider() &#123;            return 10087;        &#125;    &#125;    public static class EchoService &#123;        private final String messageValue;        private final Integer countValue;        @Inject        public EchoService(@Message String messageValue, @Count Integer countValue) &#123;            this.messageValue = messageValue;            this.countValue = countValue;        &#125;    &#125;&#125;\n\nGuiceæ³¨å…¥å™¨åˆ›å»ºå•ä¾‹çš„å¤„ç†é€»è¾‘ç±»ä¼¼äºï¼š\nString messageValue = injector.getInstance(Key.get(String.class, Message.class));Integer countValue = injector.getInstance(Key.get(Integer.class, Count.class));EchoService echoService = new EchoService(messageValue, countValue);\n\nè¿™é‡Œçš„æ³¨è§£@Providesåœ¨Guiceä¸­çš„å®ç°å¯¹åº”äºProvideræ¥å£ï¼Œè¯¥æ¥å£çš„å®šä¹‰ååˆ†ç®€å•ï¼š\ninterface Provider&lt;T&gt; &#123;    /** Provides an instance of T.**/    T get();&#125;\n\nGuice Mapä¸­æ‰€æœ‰çš„å€¼éƒ½å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªProviderçš„å®ç°ï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­å¯ä»¥ç†è§£ä¸ºï¼š\n// messageProvider.get() =&gt; &#x27;foo&#x27;Provider&lt;String&gt; messageProvider = () -&gt; EchoModule.messageProvider();// countProvider.get() =&gt; 10087Provider&lt;Integer&gt; countProvider = () -&gt; EchoModule.countProvider();\n\nä¾èµ–æœç´¢å’Œåˆ›å»ºçš„è¿‡ç¨‹ä¹Ÿæ˜¯æ ¹æ®æ¡ä»¶åˆ›å»ºKeyå®ä¾‹ï¼Œç„¶ååœ¨Guice Mapä¸­å®šä½å”¯ä¸€çš„äºProviderï¼Œç„¶åé€šè¿‡è¯¥Providerå®Œæˆä¾èµ–ç»„ä»¶çš„å®ä¾‹åŒ–ï¼Œæ¥ç€å®Œæˆåç»­çš„ä¾èµ–æ³¨å…¥åŠ¨ä½œã€‚è¿™ä¸ªè¿‡ç¨‹åœ¨Guiceæ–‡æ¡£ä¸­ä½¿ç”¨äº†ä¸€ä¸ªå…·ä½“çš„è¡¨æ ¼è¿›è¡Œè¯´æ˜ï¼Œè¿™é‡Œè´´ä¸€ä¸‹è¿™ä¸ªè¡¨æ ¼ï¼š\n\n\n\nGuice DSLè¯­æ³•\nå¯¹åº”çš„æ¨¡å‹\n\n\n\nbind(key).toInstance(value)\nã€instance bindingã€‘map.put(key,() -&gt; value)\n\n\nbind(key).toProvider(provider)\nã€provider bindingã€‘map.put(key, provider)\n\n\nbind(key).to(anotherKey)\nã€linked bindingã€‘map.put(key, map.get(anotherKey))\n\n\n@Provides Foo provideFoo()&#123;...&#125;\nã€provider method bindingã€‘map.put(Key.get(Foo.class), module::provideFoo)\n\n\nKeyå®ä¾‹çš„åˆ›å»ºæœ‰å¾ˆå¤šè¡ç”Ÿæ–¹æ³•ï¼Œå¯ä»¥æ»¡è¶³å•å…·ä½“ç±»å‹ã€å…·ä½“ç±»å‹åŠ æ³¨è§£ç­‰å¤šç§å®ä¾‹åŒ–æ–¹å¼ã€‚ä¾èµ–æ³¨å…¥ä½¿ç”¨@Injectæ³¨è§£ï¼Œæ”¯æŒæˆå‘˜å˜é‡å’Œæ„é€ æ³¨å…¥ï¼Œä¸€ä¸ªæ¥å£ç”±å¤šä¸ªå®ç°çš„åœºæ™¯å¯ä»¥é€šè¿‡å†…å»º@Namedæ³¨è§£æˆ–è€…è‡ªå®šä¹‰æ³¨è§£æŒ‡å®šå…·ä½“æ³¨å…¥çš„å®ç°ï¼Œä½†æ˜¯éœ€è¦åœ¨æ„å»ºç»‘å®šçš„æ—¶å€™é€šè¿‡@Namedæ³¨è§£æˆ–è€…è‡ªå®šä¹‰æ³¨è§£æ ‡è®°å…·ä½“çš„å®ç°ã€‚ä¾‹å¦‚ï¼š\npublic class GuiceMentalModelDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bind(MessageProcessor.class)                        .annotatedWith(Names.named(&quot;firstMessageProcessor&quot;))                        .to(FirstMessageProcessor.class)                        .in(Scopes.SINGLETON);                bind(MessageProcessor.class)                        .annotatedWith(Names.named(&quot;secondMessageProcessor&quot;))                        .to(SecondMessageProcessor.class)                        .in(Scopes.SINGLETON);            &#125;        &#125;);        MessageClient messageClient = injector.getInstance(MessageClient.class);        messageClient.invoke(&quot;hello world&quot;);    &#125;    interface MessageProcessor &#123;        void process(String message);    &#125;    public static class FirstMessageProcessor implements MessageProcessor &#123;        @Override        public void process(String message) &#123;            System.out.println(&quot;FirstMessageProcessor process message =&gt; &quot; + message);        &#125;    &#125;    public static class SecondMessageProcessor implements MessageProcessor &#123;        @Override        public void process(String message) &#123;            System.out.println(&quot;SecondMessageProcessor process message =&gt; &quot; + message);        &#125;    &#125;    @Singleton    public static class MessageClient &#123;        @Inject        @Named(&quot;secondMessageProcessor&quot;)        private MessageProcessor messageProcessor;        public void invoke(String message) &#123;            messageProcessor.process(message);        &#125;    &#125;&#125;// æ§åˆ¶å°è¾“å‡ºï¼šSecondMessageProcessor process message =&gt; hello world\n\n@Namedæ³¨è§£è¿™é‡Œå¯ä»¥æ¢æˆä»»æ„çš„è‡ªå®šä¹‰æ³¨è§£å®ç°ï¼Œä¸è¿‡æ³¨æ„è‡ªå®šä¹‰æ³¨è§£éœ€è¦æ·»åŠ å…ƒæ³¨è§£@javax.inject.Qualifierï¼Œæœ€ç»ˆçš„æ•ˆæœæ˜¯ä¸€è‡´çš„ï¼Œå†…ç½®çš„@Namedå°±èƒ½æ»¡è¶³å¤§éƒ¨åˆ†çš„åœºæ™¯ã€‚æœ€åï¼Œæ¯ä¸ªç»„ä»¶æ³¨å†Œåˆ°Guiceä¸­ï¼Œè¯¥ç»„ä»¶çš„æ‰€æœ‰ä¾èµ–ä¼šå½¢æˆä¸€ä¸ªæœ‰å‘å›¾ï¼Œæ³¨å…¥è¯¥ç»„ä»¶çš„æ—¶å€™ä¼šé€’å½’æ³¨å…¥è¯¥ç»„ä»¶è‡ªèº«çš„æ‰€æœ‰ä¾èµ–ï¼Œè¿™ä¸ªéå†æ³¨å…¥æµç¨‹éµå¾ªã€Œæ·±åº¦ä¼˜å…ˆã€ã€‚Guiceä¼šæ ¡éªŒç»„ä»¶çš„ä¾èµ–æœ‰å‘å›¾çš„åˆæ³•æ€§ï¼Œå¦‚æœè¯¥æœ‰å‘å›¾æ˜¯éæ³•çš„ï¼Œä¼šæŠ›å‡ºCreationExceptionå¼‚å¸¸ã€‚\nGuiceæ”¯æŒçš„ç»‘å®šGuiceæä¾›AbstractModuleæŠ½è±¡æ¨¡å—ç±»ç»™ä½¿ç”¨è€…ç»§æ‰¿ï¼Œè¦†ç›–configure()æ–¹æ³•ï¼Œé€šè¿‡bind()ç›¸å…³APIåˆ›å»ºç»‘å®šã€‚\n\nâ\nGuiceä¸­çš„Bindingå…¶å®å°±æ˜¯å‰é¢æåˆ°çš„Mental Modelä¸­Guice Mapä¸­çš„é”®å’Œå€¼çš„æ˜ å°„å…³ç³»ï¼ŒGuiceæä¾›å¤šç§æ³¨å†Œè¿™ä¸ªç»‘å®šå…³ç³»çš„API\nâ\n\nè¿™é‡Œä»…ä»‹ç»æœ€å¸¸ç”¨çš„ç»‘å®šç±»å‹ï¼š\n\nLinked Binding\nInstance Binding\nProvider Binding\nConstructor Binding\nUntargeted Binding\nMulti Binding\nJIT Binding\n\nLinked BindingLinked Bindingç”¨äºæ˜ å°„ä¸€ä¸ªç±»å‹å’Œæ­¤ç±»å‹çš„å®ç°ç±»å‹ï¼Œä½¿ç”¨èµ·æ¥å¦‚ä¸‹ï¼š\nbind(æ¥å£ç±»å‹.class).to(å®ç°ç±»å‹.class);\n\nå…·ä½“ä¾‹å­ï¼š\npublic class GuiceLinkedBindingDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bind(Foo.class).to(Bar.class).in(Scopes.SINGLETON);            &#125;        &#125;);        Foo foo = injector.getInstance(Foo.class);    &#125;    interface Foo &#123;    &#125;    public static class Bar implements Foo &#123;    &#125;&#125;\n\nLinked Bindingå¸¸ç”¨äºè¿™ç§ä¸€ä¸ªæ¥å£ä¸€ä¸ªå®ç°çš„åœºæ™¯ã€‚ç›®æ ‡ç±»å‹ä¸Šæ·»åŠ äº†@Singletonæ³¨è§£ï¼Œé‚£ä¹ˆç¼–ç¨‹å¼æ³¨å†Œç»‘å®šæ—¶å€™å¯ä»¥æ— éœ€è°ƒç”¨in(Scopes.SINGLETON)ã€‚\nInstance BindingInstance Bindingç”¨äºæ˜ å°„ä¸€ä¸ªç±»å‹å’Œæ­¤ç±»å‹çš„å®ç°ç±»å‹ã€Œå®ä¾‹ã€ï¼Œä¹ŸåŒ…æ‹¬å¸¸é‡çš„ç»‘å®šã€‚ä»¥å‰ä¸€å°èŠ‚çš„ä¾‹å­ç¨å¾®æ”¹é€ æˆInstance Bindingçš„æ¨¡å¼å¦‚ä¸‹ï¼š\nfinal Bar bar = new Bar();bind(Foo.class).toInstance(bar);# æˆ–è€…æ·»åŠ Namedæ³¨è§£bind(Foo.class).annotatedWith(Names.named(&quot;bar&quot;)).toInstance(bar);# å¸¸é‡ç»‘å®šbindConstant().annotatedWith(Names.named(&quot;key&quot;)).to(value);\n\nå¯ä»¥åŸºäºè¿™ç§æ–¹å¼è¿›è¡Œå¸¸é‡çš„ç»‘å®šï¼Œä¾‹å¦‚ï¼š\npublic class GuiceInstanceBindingDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bind(String.class).annotatedWith(Names.named(&quot;host&quot;)).toInstance(&quot;localhost&quot;);                bind(Integer.class).annotatedWith(Names.named(&quot;port&quot;)).toInstance(8080);                bindConstant().annotatedWith(Protocol.class).to(&quot;HTTPS&quot;);                bind(HttpClient.class).to(DefaultHttpClient.class).in(Scopes.SINGLETON);            &#125;        &#125;);        HttpClient httpClient = injector.getInstance(HttpClient.class);        httpClient.print();    &#125;    @Qualifier    @Retention(RUNTIME)    public @interface Protocol &#123;    &#125;    interface HttpClient &#123;        void print();    &#125;    public static class DefaultHttpClient implements HttpClient &#123;        @Inject        @Named(&quot;host&quot;)        private String host;        @Inject        @Named(&quot;port&quot;)        private Integer port;        @Inject        @Protocol        private String protocol;        @Override        public void print() &#123;            System.out.printf(&quot;host =&gt; %s, port =&gt; %d, protocol =&gt; %s\\n&quot;, host, port, protocol);        &#125;    &#125;&#125;// è¾“å‡ºç»“æœï¼šhost =&gt; localhost, port =&gt; 8080, protocol =&gt; HTTPS\n\nProvider BindingProvider Bindingï¼Œå¯ä»¥æŒ‡å®šæŸä¸ªç±»å‹å’Œè¯¥ç±»å‹çš„Providerå®ç°ç±»å‹è¿›è¡Œç»‘å®šï¼Œæœ‰ç‚¹åƒè®¾è®¡æ¨¡å¼ä¸­çš„ç®€å•å·¥å‚æ¨¡å¼ï¼Œå¯ä»¥ç±»æ¯”ä¸ºSpringä¸­çš„FactoryBeanæ¥å£ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\npublic class GuiceProviderBindingDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bind(Key.get(Foo.class)).toProvider(FooProvider.class).in(Scopes.SINGLETON);            &#125;        &#125;);        Foo s1 = injector.getInstance(Key.get(Foo.class));        Foo s2 = injector.getInstance(Key.get(Foo.class));    &#125;    public static class Foo &#123;    &#125;    public static class FooProvider implements Provider&lt;Foo&gt; &#123;        private final Foo foo = new Foo();        @Override        public Foo get() &#123;            System.out.println(&quot;Get Foo from FooProvider...&quot;);            return foo;        &#125;    &#125;&#125;// Get Foo from FooProvider...\n\n\nè¿™é‡Œä¹Ÿè¦æ³¨æ„ï¼Œå¦‚æœæ ‡è®°Providerä¸ºå•ä¾‹ï¼Œé‚£ä¹ˆåœ¨Injectorä¸­è·å–åˆ›å»ºçš„å®ä¾‹ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡get()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‡’åŠ è½½\n\n@Providesæ³¨è§£æ˜¯Provider Bindingä¸€ç§ç‰¹åŒ–æ¨¡å¼ï¼Œå¯ä»¥åœ¨è‡ªå®šä¹‰çš„Moduleå®ç°ä¸­æ·»åŠ ä½¿ç”¨äº†@Providesæ³¨è§£çš„è¿”å›å¯¹åº”ç±»å‹å®ä¾‹çš„æ–¹æ³•ï¼Œè¿™ä¸ªç”¨æ³•è·ŸSpringé‡Œé¢çš„@Beanæ³¨è§£ååˆ†ç›¸ä¼¼ã€‚ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š\npublic class GuiceAnnotationProviderBindingDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;            &#125;            @Singleton            @Provides            public Foo fooProvider() &#123;                System.out.println(&quot;init Foo from method fooProvider()...&quot;);                return new Foo();            &#125;        &#125;);        Foo s1 = injector.getInstance(Key.get(Foo.class));        Foo s2 = injector.getInstance(Key.get(Foo.class));    &#125;    public static class Foo &#123;    &#125;&#125;// init Foo from method fooProvider()...\n\nConstructor BindingConstructor Bindingéœ€è¦æ˜¾å¼ç»‘å®šæŸä¸ªç±»å‹åˆ°å…¶å®ç°ç±»å‹çš„ä¸€ä¸ªæ˜ç¡®å…¥å‚ç±»å‹çš„æ„é€ å‡½æ•°ï¼Œç›®æ ‡æ„é€ å‡½æ•°ä¸éœ€è¦ä½¿ç”¨@Injectæ³¨è§£ã€‚ä¾‹å¦‚ï¼š\npublic class GuiceConstructorBindingDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                try &#123;                    bind(Key.get(JdbcTemplate.class))                            .toConstructor(DefaultJdbcTemplate.class.getConstructor(DataSource.class))                            .in(Scopes.SINGLETON);                &#125; catch (NoSuchMethodException e) &#123;                    addError(e);                &#125;            &#125;        &#125;);        JdbcTemplate instance = injector.getInstance(JdbcTemplate.class);    &#125;    interface JdbcTemplate &#123;    &#125;    public static class DefaultJdbcTemplate implements JdbcTemplate &#123;        public DefaultJdbcTemplate(DataSource dataSource) &#123;            System.out.println(&quot;init JdbcTemplate,ds =&gt; &quot; + dataSource.hashCode());        &#125;    &#125;    public static class DataSource &#123;    &#125;&#125;// init JdbcTemplate,ds =&gt; 1420232606\n\nè¿™é‡Œéœ€è¦ä½¿ç”¨è€…æ•è·å’Œå¤„ç†è·å–æ„é€ å‡½æ•°å¤±è´¥æŠ›å‡ºçš„NoSuchMethodExceptionå¼‚å¸¸ã€‚\nUntargeted BindingUntargeted Bindingç”¨äºæ³¨å†Œç»‘å®šæ²¡æœ‰ç›®æ ‡ï¼ˆå®ç°ï¼‰ç±»å‹çš„ç‰¹åŒ–åœºæ™¯ï¼Œä¸€èˆ¬æ˜¯æ²¡æœ‰å®ç°æ¥å£çš„æ™®é€šç±»å‹ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨@Namedæ³¨è§£æˆ–è€…è‡ªå®šä¹‰æ³¨è§£ç»‘å®šçš„å‰æä¸‹å¯ä»¥å¿½ç•¥to()è°ƒç”¨ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨äº†@Namedæ³¨è§£æˆ–è€…è‡ªå®šä¹‰æ³¨è§£è¿›è¡Œç»‘å®šï¼Œto()è°ƒç”¨ä¸€å®šä¸èƒ½å¿½ç•¥ã€‚ä¾‹å¦‚ï¼š\npublic class GuiceUnTargetedBindingDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bind(Foo.class).in(Scopes.SINGLETON);                bind(Bar.class).annotatedWith(Names.named(&quot;bar&quot;)).to(Bar.class).in(Scopes.SINGLETON);            &#125;        &#125;);    &#125;    public static class Foo &#123;    &#125;    public static class Bar &#123;    &#125;&#125;\n\nMulti BindingMulti Bindingä¹Ÿå°±æ˜¯å¤šï¼ˆå®ä¾‹ï¼‰ç»‘å®šï¼Œä½¿ç”¨ç‰¹åŒ–çš„Binderä»£ç†å®Œæˆï¼Œè¿™ä¸‰ç§Binderä»£ç†åˆ†åˆ«æ˜¯ï¼š\n\nMultibinderï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºType =&gt; Set&lt;TypeImpl&gt;ï¼Œæ³¨å…¥ç±»å‹ä¸ºSet&lt;Type&gt;\nMapBinderï¼šå¯ä»¥ç®€å•ç†è§£ä¸º(KeyType, ValueType) =&gt; Map&lt;KeyType, ValueTypeImpl&gt;ï¼Œæ³¨å…¥ç±»å‹ä¸ºMap&lt;KeyType, ValueType&gt;\nOptionalBinderï¼šå¯ä»¥ç®€å•ç†è§£ä¸ºType =&gt; Optional.ofNullable(GuiceMap.get(Type)).or(DefaultImpl)ï¼Œæ³¨å…¥ç±»å‹ä¸ºOptional&lt;Type&gt;\n\nMultibinderçš„ä½¿ç”¨ä¾‹å­ï¼š\npublic class GuiceMultiBinderDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                Multibinder&lt;Processor&gt; multiBinder = Multibinder.newSetBinder(binder(), Processor.class);                multiBinder.permitDuplicates().addBinding().to(FirstProcessor.class).in(Scopes.SINGLETON);                multiBinder.permitDuplicates().addBinding().to(SecondProcessor.class).in(Scopes.SINGLETON);            &#125;        &#125;);        injector.getInstance(Client.class).process();    &#125;    @Singleton    public static class Client &#123;        @Inject        private Set&lt;Processor&gt; processors;        public void process() &#123;            Optional.ofNullable(processors).ifPresent(ps -&gt; ps.forEach(Processor::process));        &#125;    &#125;    interface Processor &#123;        void process();    &#125;    public static class FirstProcessor implements Processor &#123;        @Override        public void process() &#123;            System.out.println(&quot;FirstProcessor process...&quot;);        &#125;    &#125;    public static class SecondProcessor implements Processor &#123;        @Override        public void process() &#123;            System.out.println(&quot;SecondProcessor process...&quot;);        &#125;    &#125;&#125;// è¾“å‡ºç»“æœFirstProcessor process...SecondProcessor process...\n\nMapBinderçš„ä½¿ç”¨ä¾‹å­ï¼š\npublic class GuiceMapBinderDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                MapBinder&lt;Type, Processor&gt; mapBinder = MapBinder.newMapBinder(binder(), Type.class, Processor.class);                mapBinder.addBinding(Type.SMS).to(SmsProcessor.class).in(Scopes.SINGLETON);                mapBinder.addBinding(Type.MESSAGE_TEMPLATE).to(MessageTemplateProcessor.class).in(Scopes.SINGLETON);            &#125;        &#125;);        injector.getInstance(Client.class).process();    &#125;    @Singleton    public static class Client &#123;        @Inject        private Map&lt;Type, Processor&gt; processors;        public void process() &#123;            Optional.ofNullable(processors).ifPresent(ps -&gt; ps.forEach(((type, processor) -&gt; processor.process())));        &#125;    &#125;    public enum Type &#123;        /**         * çŸ­ä¿¡         */        SMS,        /**         * æ¶ˆæ¯æ¨¡æ¿         */        MESSAGE_TEMPLATE    &#125;    interface Processor &#123;        void process();    &#125;    public static class SmsProcessor implements Processor &#123;        @Override        public void process() &#123;            System.out.println(&quot;SmsProcessor process...&quot;);        &#125;    &#125;    public static class MessageTemplateProcessor implements Processor &#123;        @Override        public void process() &#123;            System.out.println(&quot;MessageTemplateProcessor process...&quot;);        &#125;    &#125;&#125;// è¾“å‡ºç»“æœSmsProcessor process...MessageTemplateProcessor process...\n\nOptionalBinderçš„ä½¿ç”¨ä¾‹å­ï¼š\npublic class GuiceOptionalBinderDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;//                bind(Logger.class).to(LogbackLogger.class).in(Scopes.SINGLETON);                OptionalBinder.newOptionalBinder(binder(), Logger.class)                        .setDefault()                        .to(StdLogger.class)                        .in(Scopes.SINGLETON);            &#125;        &#125;);        injector.getInstance(Client.class).log(&quot;Hello World&quot;);    &#125;    @Singleton    public static class Client &#123;        @Inject        private Optional&lt;Logger&gt; logger;        public void log(String content) &#123;            logger.ifPresent(l -&gt; l.log(content));        &#125;    &#125;    interface Logger &#123;        void log(String content);    &#125;    public static class StdLogger implements Logger &#123;        @Override        public void log(String content) &#123;            System.out.println(content);        &#125;    &#125;&#125;\n\nJIT BindingJIT Bindingä¹Ÿå°±æ˜¯Just-In-Time Bindingï¼Œä¹Ÿå¯ä»¥ç§°ä¸ºéšå¼ç»‘å®šï¼ˆImplicit Bindingï¼‰ã€‚éšå¼ç»‘å®šéœ€è¦æ»¡è¶³ï¼š\n\næ„é€ å‡½æ•°å¿…é¡»æ— å‚ï¼Œå¹¶ä¸”éprivateä¿®é¥°\næ²¡æœ‰åœ¨Moduleå®ç°ä¸­æ¿€æ´»Binder#requireAtInjectRequired()\n\nè°ƒç”¨Binder#requireAtInjectRequired()æ–¹æ³•å¯ä»¥å¼ºåˆ¶å£°æ˜Guiceåªä½¿ç”¨å¸¦æœ‰@Injectæ³¨è§£çš„æ„é€ å™¨ã€‚è°ƒç”¨Binder#requireExplicitBindings()æ–¹æ³•å¯ä»¥å£°æ˜Moduleå†…å¿…é¡»æ˜¾å¼å£°æ˜æ‰€æœ‰ç»‘å®šï¼Œä¹Ÿå°±æ˜¯ç¦ç”¨éšå¼ç»‘å®šï¼Œæ‰€æœ‰ç»‘å®šå¿…é¡»åœ¨Moduleçš„å®ç°ä¸­å£°æ˜ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªéšå¼ç»‘å®šçš„ä¾‹å­ï¼š\npublic class GuiceJustInTimeBindingDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;            &#125;        &#125;);        Foo instance = injector.getInstance(Key.get(Foo.class));    &#125;    public static class Foo &#123;        public Foo() &#123;            System.out.println(&quot;init Foo...&quot;);        &#125;    &#125;&#125;// init Foo...\n\næ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªè¿è¡Œæ—¶ç»‘å®šæ³¨è§£ï¼š\n\n@ImplementedByï¼šç‰¹åŒ–çš„Linked Bindingï¼Œç”¨äºè¿è¡Œæ—¶ç»‘å®šå¯¹åº”çš„ç›®æ ‡ç±»å‹\n\n@ImplementedBy(MessageProcessor.class)public interface Processor &#123;  &#125;\n\n\n@ProvidedByï¼šç‰¹åŒ–çš„Provider Bindingï¼Œç”¨äºè¿è¡Œæ—¶ç»‘å®šå¯¹åº”çš„ç›®æ ‡ç±»å‹çš„Providerå®ç°\n\n@ProvidedBy(DruidDataSource.class)public interface DataSource &#123;  &#125;\n\nAOPç‰¹æ€§Guiceæä¾›äº†ç›¸å¯¹åº•å±‚çš„AOPç‰¹æ€§ï¼Œä½¿ç”¨è€…éœ€è¦è‡ªè¡Œå®ç°org.aopalliance.intercept.MethodInterceptoræ¥å£åœ¨æ–¹æ³•æ‰§è¡Œç‚¹çš„å‰åæ’å…¥è‡ªå®šä¹‰ä»£ç ï¼Œå¹¶ä¸”é€šè¿‡Binder#bindInterceptor()æ³¨å†Œæ–¹æ³•æ‹¦æˆªå™¨ã€‚è¿™é‡Œåªé€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è¿›è¡Œæ¼”ç¤ºï¼Œæ¨¡æ‹Ÿçš„åœºæ™¯æ˜¯æ–¹æ³•æ‰§è¡Œå‰å’Œæ–¹æ³•æ‰§è¡Œå®Œæˆååˆ†åˆ«æ‰“å°æ—¥å¿—ï¼Œå¹¶ä¸”è®¡ç®—ç›®æ ‡æ–¹æ³•è°ƒç”¨è€—æ—¶ï¼š\npublic class GuiceAopDemo &#123;    public static void main(String[] args) &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bindInterceptor(Matchers.only(EchoService.class), Matchers.any(), new EchoMethodInterceptor());            &#125;        &#125;);        EchoService instance = injector.getInstance(Key.get(EchoService.class));        instance.echo(&quot;throwable&quot;);    &#125;    public static class EchoService &#123;        public void echo(String name) &#123;            System.out.println(name + &quot; echo&quot;);        &#125;    &#125;    public static class EchoMethodInterceptor implements MethodInterceptor &#123;        @Override        public Object invoke(MethodInvocation methodInvocation) throws Throwable &#123;            Method method = methodInvocation.getMethod();            String methodName = method.getName();            long start = System.nanoTime();            System.out.printf(&quot;Before invoke method =&gt; [%s]\\n&quot;, methodName);            Object result = methodInvocation.proceed();            long end = System.nanoTime();            System.out.printf(&quot;After invoke method =&gt; [%s], cost =&gt; %d ns\\n&quot;, methodName, (end - start));            return result;        &#125;    &#125;&#125;// è¾“å‡ºç»“æœBefore invoke method =&gt; [echo]throwable echoAfter invoke method =&gt; [echo], cost =&gt; 16013700 ns\n\nè‡ªå®šä¹‰æ³¨å…¥é€šè¿‡TypeListenerå’ŒMembersInjectorå¯ä»¥å®ç°ç›®æ ‡ç±»å‹å®ä¾‹çš„æˆå‘˜å±æ€§è‡ªå®šä¹‰æ³¨å…¥æ‰©å±•ã€‚ä¾‹å¦‚å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®ç°ç›®æ ‡å®ä¾‹çš„org.slf4j.Loggerå±æ€§çš„è‡ªåŠ¨æ³¨å…¥ï¼š\npublic class GuiceCustomInjectionDemo &#123;    public static void main(String[] args) throws Exception &#123;        Injector injector = Guice.createInjector(new AbstractModule() &#123;            @Override            public void configure() &#123;                bindListener(Matchers.any(), new LoggingListener());            &#125;        &#125;);        injector.getInstance(LoggingClient.class).doLogging(&quot;Hello World&quot;);    &#125;    public static class LoggingClient &#123;        @Logging        private Logger logger;        public void doLogging(String content) &#123;            Optional.ofNullable(logger).ifPresent(l -&gt; l.info(content));        &#125;    &#125;    @Qualifier    @Retention(RUNTIME)    @interface Logging &#123;    &#125;    public static class LoggingMembersInjector&lt;T&gt; implements MembersInjector&lt;T&gt; &#123;        private final Field field;        private final Logger logger;        public LoggingMembersInjector(Field field) &#123;            this.field = field;            this.logger = LoggerFactory.getLogger(field.getDeclaringClass());            field.setAccessible(true);        &#125;        @Override        public void injectMembers(T instance) &#123;            try &#123;                field.set(instance, logger);            &#125; catch (IllegalAccessException e) &#123;                throw new IllegalStateException(e);            &#125; finally &#123;                field.setAccessible(false);            &#125;        &#125;    &#125;    public static class LoggingListener implements TypeListener &#123;        @Override        public &lt;I&gt; void hear(TypeLiteral&lt;I&gt; typeLiteral, TypeEncounter&lt;I&gt; typeEncounter) &#123;            Class&lt;?&gt; clazz = typeLiteral.getRawType();            while (Objects.nonNull(clazz)) &#123;                for (Field field : clazz.getDeclaredFields()) &#123;                    if (field.getType() == Logger.class &amp;&amp; field.isAnnotationPresent(Logging.class)) &#123;                        typeEncounter.register(new LoggingMembersInjector&lt;&gt;(field));                    &#125;                &#125;                clazz = clazz.getSuperclass();            &#125;        &#125;    &#125;&#125;// è¾“å‡ºç»“æœ[2022-02-22 00:51:33,516] [INFO] cn.vlts.guice.GuiceCustomInjectionDemo$LoggingClient [main] [] - Hello World\n\nåŸºäºClassGraphæ‰«æå’Œå…¨è‡ªåŠ¨æ³¨å†Œç»‘å®šGuiceæœ¬èº«ä¸æä¾›ç±»è·¯å¾„æˆ–è€…Jaræ–‡ä»¶çš„ç±»æ‰«æåŠŸèƒ½ï¼Œè¦å®ç°ç±»è·¯å¾„ä¸‹çš„æ‰€æœ‰Beanå…¨è‡ªåŠ¨æ³¨å†Œç»‘å®šï¼Œéœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹ç±»æ‰«ææ¡†æ¶ï¼Œè¿™é‡Œé€‰ç”¨äº†ä¸€ä¸ªæ€§èƒ½æ¯”è¾ƒé«˜ç¤¾åŒºæ¯”è¾ƒæ´»è·ƒçš„ç±»åº“io.github.classgraph:classgraphã€‚å¼•å…¥ClassGraphçš„æœ€æ–°ä¾èµ–ï¼š\n&lt;dependency&gt;    &lt;groupId&gt;io.github.classgraph&lt;/groupId&gt;    &lt;artifactId&gt;classgraph&lt;/artifactId&gt;    &lt;version&gt;4.8.138&lt;/version&gt;&lt;/dependency&gt;\n\nç¼–å†™è‡ªåŠ¨æ‰«æModuleï¼š\nimport com.google.inject.AbstractModule;import com.google.inject.Guice;import com.google.inject.Injector;import com.jz.demo.guice.ConfigModule;import io.github.classgraph.ClassGraph;import io.github.classgraph.ClassInfo;import io.github.classgraph.ScanResult;import java.util.LinkedList;import java.util.List;import lombok.SneakyThrows;/** * @Auther jd */public class AutoModuleScanner &#123;  private static String[] acceptPackages = &#123;&quot;com.jz.demo.guice&quot;&#125;;  private static String[] rejectClasses = &#123;&quot;*Main&quot;&#125;;  private volatile static Injector injector;  @SneakyThrows  public static synchronized void init() &#123;    if (injector != null) &#123;      return;    &#125;    ClassGraph classGraph = new ClassGraph();    ScanResult scanResult = classGraph        .enableClassInfo()        .acceptPackages(acceptPackages)        .rejectClasses(rejectClasses)        .scan();    List&lt;AbstractModule&gt; modules = new LinkedList&lt;&gt;();    for (ClassInfo classInfo : scanResult.getSubclasses(AbstractModule.class)) &#123;      if (classInfo.getName().equals(AutoModuleScanner.class.getName())) &#123;        continue;      &#125;      modules.add(((Class&lt;AbstractModule&gt;) classInfo.loadClass()).getConstructor().newInstance());    &#125;    injector = Guice.createInjector(modules.toArray(new AbstractModule[0]));  &#125;  public static Injector injector() &#123;    return injector;  &#125;&#125;","categories":["å®ç”¨ç±»åº“"]},{"title":"Kryo åºåˆ—åŒ–","url":"/posts/30029/","content":"å®˜æ–¹æ–‡æ¡£ï¼šhttps://github.com/EsotericSoftware/kryo/blob/master/README.md\nä¸€ã€Maven ä¾èµ–&lt;dependency&gt;    &lt;groupId&gt;com.esotericsoftware&lt;/groupId&gt;    &lt;artifactId&gt;kryo&lt;/artifactId&gt;    &lt;version&gt;5.3.0&lt;/version&gt;&lt;/dependency&gt;\n\näºŒã€å·¥å…·ç±»Kryo çº¿ç¨‹ä¸å®‰å…¨ã€‚\nimport com.esotericsoftware.kryo.Kryo;import com.esotericsoftware.kryo.io.Input;import com.esotericsoftware.kryo.io.Output;import com.esotericsoftware.kryo.util.DefaultInstantiatorStrategy;import java.io.ByteArrayInputStream;import java.io.ByteArrayOutputStream;import java.util.ArrayList;import java.util.List;import org.objenesis.strategy.StdInstantiatorStrategy;/** * @Auther jd */public class KryoUtils &#123;  private static final ThreadLocal&lt;Kryo&gt; KRYO = new ThreadLocal&lt;&gt;() &#123;    @Override    protected Kryo initialValue() &#123;      /**       * ä¸è¦è½»æ˜“æ”¹å˜è¿™é‡Œçš„é…ç½®,æ›´æ”¹ä¹‹åï¼Œåºåˆ—åŒ–çš„æ ¼å¼å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œ       * ä¸Šçº¿çš„åŒæ—¶å°±å¿…é¡»æ¸…é™¤ Redis é‡Œçš„æ‰€æœ‰ç¼“å­˜ï¼Œ       * å¦åˆ™é‚£äº›ç¼“å­˜å†å›æ¥ååºåˆ—åŒ–çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™       */      Kryo kryo = new Kryo();      kryo.setReferences(true);      kryo.setRegistrationRequired(false);      //Fix the NPE bug when deserializing Collections.      ((DefaultInstantiatorStrategy) kryo.getInstantiatorStrategy())          .setFallbackInstantiatorStrategy(new StdInstantiatorStrategy());      return kryo;    &#125;  &#125;;  public static &lt;T&gt; byte[] serializeObject(T obj) &#123;    if (obj == null) &#123;      return null;    &#125;    ByteArrayOutputStream os = null;    try (Output output = new Output(os = new ByteArrayOutputStream())) &#123;      Kryo kryo = KRYO.get();      kryo.writeObject(output, obj);      return os.toByteArray();    &#125; catch (Exception e) &#123;      e.printStackTrace();      return null;    &#125;  &#125;  public static &lt;T&gt; T deserialize(byte[] bytes, Class&lt;T&gt; clazz) &#123;    if (bytes == null || bytes.length == 0) &#123;      return null;    &#125;    ByteArrayInputStream is = null;    try (Input input = new Input(is = new ByteArrayInputStream(bytes))) &#123;      Kryo kryo = KRYO.get();      return kryo.readObject(input, clazz);    &#125; catch (Exception e) &#123;      e.printStackTrace();      return null;    &#125;  &#125;  public static &lt;T&gt; List&lt;T&gt; deserialize(byte[] bytes) &#123;    if (bytes == null || bytes.length == 0) &#123;      return null;    &#125;    ByteArrayInputStream is = null;    try (Input input = new Input(is = new ByteArrayInputStream(bytes))) &#123;      Kryo kryo = KRYO.get();      return kryo.readObject(input, ArrayList.class);    &#125; catch (Exception e) &#123;      e.printStackTrace();      return null;    &#125;  &#125;&#125;\n\n","categories":["å®ç”¨ç±»åº“"]},{"title":"Mapstruct","url":"/posts/3398/","content":"æ–‡æ¡£ï¼šhttps://mapstruct.org/\nä¾èµ–implementation &#x27;org.mapstruct:mapstruct:1.4.2.Final&#x27;implementation &#x27;org.mapstruct:mapstruct-jdk8:1.4.2.Final&#x27;annotationProcessor &#x27;org.mapstruct:mapstruct-processor:1.4.2.Final&#x27;","categories":["å®ç”¨ç±»åº“"]},{"title":"Resilience4j","url":"/posts/20321/","content":"Resilience4j å®˜æ–¹æ–‡æ¡£\nä¸€ã€ä¾èµ–implementation(&#x27;org.springframework.boot:spring-boot-starter-aop&#x27;)implementation(&#x27;org.springframework.boot:spring-boot-starter-actuator&#x27;)implementation(&quot;io.github.resilience4j:resilience4j-spring-boot2:$&#123;resilience4jVersion&#125;&quot;)\n\näºŒã€CircuitBreakerCircuitBreaker æ˜¯é€šè¿‡ä¸‰ä¸ªæ­£å¸¸çŠ¶æ€ï¼ˆCLOSEDã€OPEN å’Œ HALF_OPENï¼‰ä»¥åŠä¸¤ä¸ªç‰¹æ®ŠçŠ¶æ€ï¼ˆDISABLED å’Œ FORCED_OPENï¼‰ çš„æœ‰é™çŠ¶æ€æœºå®ç°çš„ã€‚\n\nCircuitBreaker ä½¿ç”¨æ»‘åŠ¨çª—å£æ¥å­˜å‚¨å’Œæ±‡æ€»è°ƒç”¨ç»“æœã€‚\næ”¯æŒåŸºäºè®¡æ•°çš„æ»‘åŠ¨çª—å£å’ŒåŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£ã€‚åŸºäºè®¡æ•°çš„æ»‘åŠ¨çª—å£èšåˆæœ€å N æ¬¡è°ƒç”¨çš„ç»“æœã€‚åŸºäºæ—¶é—´çš„æ»‘åŠ¨çª—å£èšåˆäº†æœ€å N ç§’çš„è°ƒç”¨ç»“æœã€‚\nå¤±è´¥ç‡å’Œæ…¢è°ƒç”¨ç‡é˜ˆå€¼å½“å¤±è´¥ç‡å¤§äºæˆ–ç­‰äºé…ç½®çš„é˜ˆå€¼ï¼ŒCircuitBreaker ä¼šä» CLOSED çŠ¶æ€å˜ä¸º OPEN çŠ¶æ€ã€‚\né»˜è®¤æ‰€æœ‰å¼‚å¸¸éƒ½è¢«è§†ä¸ºå¤±è´¥ã€‚\nå¯ä»¥å®šä¹‰åº”è¢«è§†ä¸ºå¤±è´¥çš„å¼‚å¸¸åˆ—è¡¨ï¼Œç„¶åå…¶ä»–æ‰€æœ‰çš„å¼‚å¸¸éƒ½è¢«è§†ä¸ºæˆåŠŸï¼Œé™¤éå®ƒä»¬è¢«å¿½ç•¥ã€‚å¼‚å¸¸ä¹Ÿå¯ä»¥è¢«å¿½ç•¥ï¼Œè¿™æ ·å®ƒä»¬æ—¢ä¸èƒ½ç®—ä½œå¤±è´¥ä¹Ÿä¸èƒ½ç®—æˆåŠŸã€‚\nå½“æ…¢é€Ÿè°ƒç”¨çš„ç™¾åˆ†æ¯”ç­‰äºæˆ–å¤§äºå¯é…ç½®çš„é˜ˆå€¼æ—¶ï¼ŒCircuitBreaker ä¹Ÿä¼šä» CLOSED å˜ä¸º OPENã€‚\nåªæœ‰è®°å½•äº†æœ€å°‘çš„è°ƒç”¨æ¬¡æ•°ï¼Œæ‰èƒ½è®¡ç®—å¤±è´¥ç‡å’Œæ…¢é€Ÿè°ƒç”¨ç‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœéœ€è¦è°ƒç”¨çš„æœ€å°æ•°é‡ä¸º 10ï¼Œåˆ™å¿…é¡»è‡³å°‘è®°å½• 10 ä¸ªè°ƒç”¨ï¼Œç„¶åæ‰èƒ½è®¡ç®—å¤±è´¥ç‡ã€‚\nåœ¨ OPEN çŠ¶æ€ä¸‹ï¼ŒCircuitBreaker ä¼šæ‹’ç»è°ƒç”¨å¹¶æŠ›å‡º CallNotPermittedException å¼‚å¸¸ã€‚\nåœ¨ç­‰å¾…æ—¶é—´ä¸€æ®µæ—¶é—´åï¼ŒCircuitBreaker çŠ¶æ€ä» OPEN å˜ä¸º HALF _ OPENï¼Œå¹¶å…è®¸å¯é…ç½®çš„è°ƒç”¨æ•°é‡ï¼Œä»¥æŸ¥çœ‹åç«¯æ˜¯å¦ä»ç„¶ä¸å¯ç”¨æˆ–å·²é‡æ–°å¯ç”¨ã€‚\nåœ¨æ‰€æœ‰å…è®¸çš„è°ƒç”¨å®Œæˆä¹‹å‰ï¼Œè¿›ä¸€æ­¥çš„è°ƒç”¨å°†è¢« CallNotPermittedException æ‹’ç»ã€‚\nå¦‚æœå¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡éšåå¤§äºæˆ–ç­‰äºé…ç½®çš„é˜ˆå€¼ï¼Œåˆ™çŠ¶æ€å°†æ›´æ”¹ä¸º OPENã€‚å¦‚æœå¤±è´¥ç‡æˆ–æ…¢è°ƒç”¨ç‡ä½äºé˜ˆå€¼ï¼Œåˆ™çŠ¶æ€å°†æ›´æ”¹ä¸º CLOSED ã€‚\nCircuitBreaker æ”¯æŒå¦å¤–ä¸¤ä¸ªç‰¹æ®Šçš„çŠ¶æ€ï¼ŒDISABLED (æ€»æ˜¯å…è®¸è®¿é—®)å’Œ FORCED_OPEN (æ€»æ˜¯æ‹’ç»è®¿é—®)ã€‚åœ¨è¿™ä¸¤ç§çŠ¶æ€ä¸‹ï¼Œä¸ä¼šäº§ç”Ÿä»»ä½•æ–­è·¯å™¨äº‹ä»¶(é™¤äº†çŠ¶æ€è½¬æ¢) ï¼Œä¹Ÿä¸ä¼šè®°å½•ä»»ä½•æŒ‡æ ‡ã€‚é€€å‡ºè¿™äº›çŠ¶æ€çš„å”¯ä¸€æ–¹æ³•æ˜¯è§¦å‘çŠ¶æ€è½¬æ¢æˆ–é‡ç½®æ–­è·¯å™¨ã€‚\né…ç½®\n\n\nConfig property\nDefault Value\nDescription\n\n\n\nfailureRateThreshold\n50\nä»¥ç™¾åˆ†æ¯”ä¸ºå•ä½é…ç½®æ•…éšœç‡é˜ˆå€¼ã€‚å½“æ•…éšœç‡ç­‰äºæˆ–å¤§äºé˜ˆå€¼æ—¶ï¼ŒCircuitBreaker è½¬æ¢ä¸ºæ‰“å¼€å¹¶å¼€å§‹çŸ­è·¯è°ƒç”¨ã€‚\n\n\nslowCallRateThreshold\n100\nä»¥ç™¾åˆ†æ¯”ä¸ºå•ä½é…ç½®é˜ˆå€¼ã€‚å½“è°ƒç”¨æŒç»­æ—¶é—´å¤§äº slowCallDurationThreshold æ—¶ï¼ŒCircuitBreaker è®¤ä¸ºè°ƒç”¨æ˜¯æ…¢çš„ï¼Œå½“æ…¢è°ƒç”¨çš„ç™¾åˆ†æ¯”ç­‰äºæˆ–å¤§äºé˜ˆå€¼æ—¶ï¼ŒCircuitBreaker è½¬æ¢ä¸ºæ‰“å¼€å¹¶å¼€å§‹çŸ­è·¯è°ƒç”¨ã€‚\n\n\nslowCallDurationThreshold\n60000 [ms]\næŒç»­æ—¶é—´é«˜äºè¯¥å€¼çš„è°ƒç”¨è¢«è§†ä¸ºæ…¢è°ƒç”¨ï¼Œå¹¶æé«˜æ…¢è°ƒç”¨ç‡ï¼Œå³slowCallRateThresholdçš„å€¼ã€‚\n\n\npermittedNumberOfCalls InHalfOpenState\n10\næ–­è·¯å™¨åŠå¼€æ—¶å…è®¸çš„è°ƒç”¨æ•°ã€‚\n\n\nmaxWaitDurationInHalfOpenState\n0 [ms]\nè¯¥ç­‰å¾…æ—¶é—´æ§åˆ¶ CircuitBreaker åœ¨åˆ‡æ¢åˆ° OPEN çŠ¶æ€ä¹‹å‰å¯ä»¥ä¿æŒ HALF_OPEN çŠ¶æ€çš„æœ€é•¿æ—¶é—´ã€‚å€¼0æ„å‘³ç€æ–­è·¯å™¨å°†åœ¨ HALF_OPEN çŠ¶æ€ä¸‹æ— é™ç­‰å¾…ï¼Œç›´åˆ°æ‰€æœ‰å…è®¸çš„è°ƒç”¨å®Œæˆã€‚\n\n\nslidingWindowType\nCOUNT_BASED\næ»‘åŠ¨çª—å£ç±»å‹ï¼Œå¯ä»¥æ˜¯åŸºäºè®¡æ•°çš„æˆ–åŸºäºæ—¶é—´çš„ã€‚  å¦‚æœæ»‘åŠ¨çª—å£æ˜¯ COUNT_BASEDï¼Œåˆ™è®°å½•å¹¶èšåˆæœ€åçš„ slidingWindowSize æ¬¡è°ƒç”¨ã€‚å¦‚æœæ»‘åŠ¨çª—å£æ˜¯ time_basedï¼Œåˆ™è®°å½•å¹¶èšåˆæœ€åä¸€æ¬¡ slidingWindowSize ç§’çš„è°ƒç”¨ã€‚\n\n\nslidingWindowSize\n100\né…ç½®æ»‘åŠ¨çª—å£çš„å¤§å°ï¼Œè¯¥çª—å£ç”¨äºåœ¨å…³é—­ CircuitBreaker æ—¶è®°å½•è°ƒç”¨çš„ç»“æœã€‚\n\n\nminimumNumberOfCalls\n100\nConfigures the minimum number of calls which are required (per sliding window period) before the CircuitBreaker can calculate the error rate or slow call rate. For example, if minimumNumberOfCalls is 10, then at least 10 calls must be recorded, before the failure rate can be calculated. If only 9 calls have been recorded the CircuitBreaker will not transition to open even if all 9 calls have failed.\n\n\nwaitDurationInOpenState\n60000 [ms]\nThe time that the CircuitBreaker should wait before transitioning from open to half-open.\n\n\nautomaticTransition FromOpenToHalfOpenEnabled\nfalse\nIf set to true it means that the CircuitBreaker will automatically transition from open to half-open state and no call is needed to trigger the transition. A thread is created to monitor all the instances of CircuitBreakers to transition them to HALF_OPEN once waitDurationInOpenState passes. Whereas, if set to false the transition to HALF_OPEN only happens if a call is made, even after waitDurationInOpenState is passed. The advantage here is no thread monitors the state of all CircuitBreakers.\n\n\nrecordExceptions\nempty\nA list of exceptions that are recorded as a failure and thus increase the failure rate. Any exception matching or inheriting from one of the list counts as a failure, unless explicitly ignored via ignoreExceptions. If you specify a list of exceptions, all other exceptions count as a success, unless they are explicitly ignored by ignoreExceptions.\n\n\nignoreExceptions\nempty\nA list of exceptions that are ignored and neither count as a failure nor success. Any exception matching or inheriting from one of the list will not count as a failure nor success, even if the exceptions is part of recordExceptions.\n\n\nrecordFailurePredicate\nthrowable -&gt; true  By default all exceptions are recored as failures.\nA custom Predicate which evaluates if an exception should be recorded as a failure. The Predicate must return true if the exception should count as a failure. The Predicate must return false, if the exception should count as a success, unless the exception is explicitly ignored by ignoreExceptions.\n\n\nignoreExceptionPredicate\nthrowable -&gt; false  By default no exception is ignored.\nA custom Predicate which evaluates if an exception should be ignored and neither count as a failure nor success. The Predicate must return true if the exception should be ignored. The Predicate must return false, if the exception should count as a failure.\n\n\nä¸‰ã€BulkheadResilience4j æä¾›äº†ä¿¡å·é‡éš”ç¦»å’Œçº¿ç¨‹æ± éš”ç¦»ï¼Œä¸¤ç§èµ„æºéš”ç¦»æ–¹å¼ã€‚\nä¿¡å·é‡éš”ç¦»é…ç½®\n\n\nConfig property\nDefault value\nDescription\n\n\n\nmaxConcurrentCalls\n25\næœ€å¤§å¹¶è¡Œæ•°é‡\n\n\nmaxWaitDuration\n0\nå½“è¾¾åˆ°æœ€å¤§å¹¶è¡Œæ•°é‡åï¼Œçº¿ç¨‹æœ€å¤§ç­‰å¾…æ—¶é—´\n\n\nçº¿ç¨‹æ± éš”ç¦»é…ç½®\n\n\nConfig property\nDefault value\nDescription\n\n\n\nmaxThreadPoolSize\nRuntime.getRuntime() .availableProcessors()\nçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°\n\n\ncoreThreadPoolSize\nRuntime.getRuntime() .availableProcessors() - 1\næ ¸å¿ƒçº¿ç¨‹æ•°\n\n\nqueueCapacity\n100\né˜»å¡é˜Ÿåˆ—å®¹é‡\n\n\nkeepAliveDuration\n20 [ms]\nçº¿ç¨‹æœ€å¤§ç©ºé—²æ—¶é—´\n\n\nå››ã€RateLimiteré…ç½®\n\n\nConfig property\nDefault value\nDescription\n\n\n\ntimeoutDuration\n5 [s]\nçº¿ç¨‹ç­‰å¾…è®¸å¯çš„æ—¶é—´\n\n\nlimitRefreshPeriod\n500 [ns]\nè®¸å¯åˆ·æ–°çš„æ—¶é—´å‘¨æœŸã€‚åœ¨æ¯ä¸ªå‘¨æœŸä¹‹åï¼Œé€Ÿç‡é™åˆ¶å™¨å°†å…¶æƒé™è®¡æ•°è®¾ç½®ä¸º limitForPeriod å€¼\n\n\nlimitForPeriod\n50\næ¯ä¸ªå‘¨æœŸå†…å¯ç”¨çš„è®¸å¯æ•°é‡\n\n\n","categories":["å®ç”¨ç±»åº“"],"tags":["é™æµ"]},{"title":"RoaringBitmap","url":"/posts/55464/","content":"ä¸€ã€ä¾èµ–&lt;dependency&gt;    &lt;groupId&gt;org.roaringbitmap&lt;/groupId&gt;    &lt;artifactId&gt;RoaringBitmap&lt;/artifactId&gt;    &lt;version&gt;0.9.30&lt;/version&gt;&lt;/dependency&gt;\n\näºŒã€å®˜æ–¹æ–‡æ¡£æºç åŠæ–‡æ¡£\n","categories":["å®ç”¨ç±»åº“"]},{"title":"maxmind-db æ ¹æ® IP è·å–åœ°ç†ä½ç½®ä¿¡æ¯","url":"/posts/15671/","content":"ä¾èµ–&lt;dependency&gt;    &lt;groupId&gt;com.maxmind.db&lt;/groupId&gt;    &lt;artifactId&gt;maxmind-db&lt;/artifactId&gt;    &lt;version&gt;2.0.0&lt;/version&gt;&lt;/dependency&gt;\n\n","categories":["å®ç”¨ç±»åº“"]},{"title":"Github å®ç”¨æŠ€å·§","url":"/posts/48924/","content":"ä¸€ã€é«˜çº§æœç´¢é¡µé¢åœ°å€ï¼šhttps://github.com/search/advanced\näºŒã€WEB ç¼–è¾‘å™¨å®˜æ–¹æ–‡æ¡£\nshift + . å¿«æ·é”®æ‰“å¼€ç¼–è¾‘å™¨ï¼Œæˆ–è€…ç›´æ¥å°†ä»“åº“åœ°å€çš„ github.com åŸŸåæ¢çš„ gitHub.devã€‚\nä¸‰ã€åœ¨çº¿è¿è¡Œé¡¹ç›®åœ¨ä»“åº“åŸŸåå‰åŠ  gitpod.io/#/ ï¼Œä¾‹å¦‚ï¼šhttps://gitpod.io/#/github.com/xxx/blog\n","categories":["å¼€å‘å®ç”¨æŠ€å·§"]},{"title":"åŠ å¯†æ•°æ®æ¨¡ç³ŠæŸ¥è¯¢","url":"/posts/35095/","content":"ä¸€ã€å‰è¨€å¯¹åŠ å¯†çš„æ•°æ®æ¨¡ç³ŠæŸ¥è¯¢å¤§è‡´åˆ†ä¸ºä¸‰ç±»åšæ³•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š\n\næ²™é›•åšæ³•ï¼ˆä¸åŠ¨è„‘æ€è€ƒç›´ç”·çš„æ€è·¯ï¼Œåªç®¡å®ç°åŠŸèƒ½ä»ä¸æ·±å…¥æ€è€ƒé—®é¢˜ï¼‰\nå¸¸è§„åšæ³•ï¼ˆæ€è€ƒäº†æŸ¥è¯¢æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿä¼šä½¿ç”¨ä¸€äº›å­˜å‚¨ç©ºé—´æ¢æ€§èƒ½ç­‰åšæ³•ï¼‰\nè¶…ç¥åšæ³•ï¼ˆæ¯”è¾ƒé«˜ç«¯çš„åšæ³•ä»ç®—æ³•å±‚é¢ä¸Šæ€è€ƒï¼‰\n\næˆ‘ä»¬å°±å¯¹è¿™ä¸‰ç§å®ç°æ–¹æ³•ä¸€ä¸€æ¥è®²è®²å®ç°æ€è·¯å’Œä¼˜åŠ£æ€§ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹æ²™é›•åšæ³•ã€‚\näºŒã€æ²™é›•åšæ³•\nå°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œè§£å¯†ï¼Œè§£å¯†åé€šè¿‡ç¨‹åºç®—æ³•æ¥æ¨¡ç³ŠåŒ¹é…\nå°†å¯†æ–‡æ•°æ®æ˜ å°„ä¸€ä»½æ˜æ–‡æ˜ å°„è¡¨ï¼Œä¿—ç§°tagè¡¨ï¼Œç„¶åæ¨¡ç³ŠæŸ¥è¯¢tagæ¥å…³è”å¯†æ–‡æ•°æ®\n\næ²™é›•ä¸€æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç¬¬ä¸€ä¸ªåšæ³•ï¼Œå°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ä¸­è¿›è¡Œè§£å¯†ï¼Œè¿™ä¸ªå¦‚æœæ•°æ®é‡å°çš„è¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹å¼æ¥åšï¼Œè¿™æ ·åšæ—¢ç®€å•åˆå®æƒ ï¼Œå¦‚æœæ•°æ®é‡å¤§çš„è¯é‚£å°±æ˜¯ç¾éš¾ï¼Œæˆ‘ä»¬æ¥å¤§è‡´ç®—ä¸€ä¸‹ã€‚\nä¸€ä¸ªè‹±æ–‡å­—æ¯(ä¸åˆ†å¤§å°å†™)å ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œä¸€ä¸ªä¸­æ–‡æ±‰å­—å ä¸¤ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œç”¨DESæ¥ä¸¾ä¾‹ï¼Œ13800138000åŠ å¯†åçš„ä¸²HE9T75xNx6c5yLmS5l4r6Q==å 24ä¸ªå­—èŠ‚ã€‚\n\n\n\næ¡æ•°\nBytes\nMB\n\n\n\n100w\n2400ä¸‡\n22.89\n\n\n1000w\n2.4äº¿\n228.89\n\n\n1äº¿\n24äº¿\n2288.89\n\n\nè½»åˆ™ä¸Šç™¾å…†ï¼Œé‡åˆ™ä¸Šåƒå…†ï¼Œè¿™æ ·åˆ†åˆ†é’Ÿç»™åº”ç”¨ç¨‹åºæ•´æˆOut of memoryï¼Œè¿™æ ·åšå¦‚æœæ•°æ®å°‘åªæœ‰å‡ ç™¾ã€å‡ åƒã€å‡ ä¸‡æ¡æ—¶æ˜¯å®Œå…¨å¯ä»¥è¿™æ ·åšçš„ï¼Œä½†æ˜¯æ•°æ®é‡å¤§å°±å¼ºçƒˆä¸å»ºè®®äº†ã€‚\næ²™é›•äºŒæˆ‘ä»¬å†æ¥çœ‹ç¬¬äºŒä¸ªåšæ³•ï¼Œå°†å¯†æ–‡æ•°æ®æ˜ å°„ä¸€ä»½æ˜æ–‡æ˜ å°„è¡¨ï¼Œç„¶åæ¨¡ç³ŠæŸ¥è¯¢æ˜ å°„è¡¨æ¥å…³è”å¯†æ–‡æ•°æ®ï¼Œwhatï¼Ÿï¼Ÿï¼Ÿï¼ï¼ï¼é‚£æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å¯¹æ•°æ®åŠ å¯†å‘¢ï¼Œç›´æ¥ä¸åŠ å¯†ä¸æ˜¯æ›´å¥½ä¹ˆï¼\næˆ‘ä»¬æ—¢ç„¶å¯¹æ•°æ®åŠ å¯†è‚¯å®šæ˜¯æœ‰å®‰å…¨è¯‰æ±‚æ‰ä¼šè¿™æ ·åšï¼Œå¢åŠ ä¸€ä¸ªæ˜æ–‡çš„æ˜ å°„è¡¨å°±è¿èƒŒäº†å®‰å…¨è¯‰æ±‚ï¼Œè¿™æ ·åšæ—¢ä¸å®‰å…¨ä¹Ÿä¸æ–¹ä¾¿å®Œå…¨æ˜¯è„±è£¤å­æ”¾xï¼Œå¤šæ­¤ä¸€ä¸¾ï¼Œå¼ºä¸”ä¸æ¨èã€‚\nä¸‰ã€å¸¸è§„åšæ³•æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹å¸¸è§„çš„åšæ³•ï¼Œä¹Ÿæ˜¯æœ€å¹¿æ³›ä½¿ç”¨çš„æ–¹æ³•ï¼Œæ­¤ç±»æ–¹æ³•åŠæ»¡è¶³çš„æ•°æ®å®‰å…¨æ€§ï¼Œåˆå¯¹æŸ¥è¯¢å‹å¥½ã€‚\n\nåœ¨æ•°æ®åº“å®ç°åŠ å¯†ç®—æ³•å‡½æ•°ï¼Œåœ¨æ¨¡ç³ŠæŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨decode(key) like &#39;%partial%\nå¯¹å¯†æ–‡æ•°æ®è¿›è¡Œåˆ†è¯ç»„åˆï¼Œå°†åˆ†è¯ç»„åˆçš„ç»“æœé›†åˆ†åˆ«è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå­˜å‚¨åˆ°æ‰©å±•åˆ—ï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡key like &#39;%partial%&#39;\n\nå¸¸è§„ä¸€åœ¨æ•°æ®åº“ä¸­å®ç°ä¸ç¨‹åºä¸€è‡´çš„åŠ è§£å¯†ç®—æ³•ï¼Œä¿®æ”¹æ¨¡ç³ŠæŸ¥è¯¢æ¡ä»¶ï¼Œä½¿ç”¨æ•°æ®åº“åŠ è§£å¯†å‡½æ•°å…ˆè§£å¯†å†æ¨¡ç³ŠæŸ¥æ‰¾ï¼Œè¿™æ ·åšçš„ä¼˜ç‚¹æ˜¯å®ç°æˆæœ¬ä½ï¼Œå¼€å‘ä½¿ç”¨æˆæœ¬ä½ï¼Œåªéœ€è¦å°†ä»¥å¾€çš„æ¨¡ç³ŠæŸ¥æ‰¾ç¨å¾®ä¿®æ”¹ä¸€ä¸‹å°±å¯ä»¥å®ç°ï¼Œä½†æ˜¯ç¼ºç‚¹ä¹Ÿå¾ˆæ˜æ˜¾ï¼Œè¿™æ ·åšæ— æ³•åˆ©ç”¨æ•°æ®åº“çš„ç´¢å¼•æ¥ä¼˜åŒ–æŸ¥è¯¢ï¼Œç”šè‡³æœ‰ä¸€äº›æ•°æ®åº“å¯èƒ½æ— æ³•ä¿è¯ä¸ç¨‹åºå®ç°ä¸€è‡´çš„åŠ è§£å¯†ç®—æ³•ï¼Œä½†æ˜¯å¯¹äºå¸¸è§„çš„åŠ è§£å¯†ç®—æ³•éƒ½å¯ä»¥ä¿è¯ä¸åº”ç”¨ç¨‹åºä¸€è‡´ã€‚\nå¦‚æœå¯¹æŸ¥è¯¢æ€§èƒ½è¦æ±‚ä¸æ˜¯ç‰¹åˆ«é«˜ã€å¯¹æ•°æ®å®‰å…¨æ€§è¦æ±‚ä¸€èˆ¬ï¼Œå¯ä»¥ä½¿ç”¨å¸¸è§çš„åŠ è§£å¯†ç®—æ³•æ¯”å¦‚è¯´AESã€DESä¹‹ç±»çš„ä¹Ÿæ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚\nå¦‚æœå…¬å¸æœ‰è‡ªå·±çš„ç®—æ³•å®ç°ï¼Œå¹¶ä¸”æ²¡æœ‰æä¾›å¤šç«¯çš„ç®—æ³•å®ç°ï¼Œè¦ä¹ˆæ‰¾ä¸ªç®—æ³•å¥½çš„äººå»ç ”ç©¶åƒé€è¡¥å…¨å¤šç«¯å®ç°ï¼Œè¦ä¹ˆæ”¾å¼ƒä½¿ç”¨è¿™ä¸ªåŠæ³•ã€‚\nå¸¸è§„äºŒå¯¹å¯†æ–‡æ•°æ®è¿›è¡Œåˆ†è¯ç»„åˆï¼Œå°†åˆ†è¯ç»„åˆçš„ç»“æœé›†åˆ†åˆ«è¿›è¡ŒåŠ å¯†ï¼Œç„¶åå­˜å‚¨åˆ°æ‰©å±•åˆ—ï¼ŒæŸ¥è¯¢æ—¶é€šè¿‡key like â€˜%partial%â€™ï¼Œè¿™æ˜¯ä¸€ä¸ªæ¯”è¾ƒåˆ’ç®—çš„å®ç°æ–¹æ³•ï¼Œæˆ‘ä»¬å…ˆæ¥åˆ†æä¸€ä¸‹å®ƒçš„å®ç°æ€è·¯ã€‚\nå…ˆå¯¹å­—ç¬¦è¿›è¡Œå›ºå®šé•¿åº¦çš„åˆ†ç»„ï¼Œå°†ä¸€ä¸ªå­—æ®µæ‹†åˆ†ä¸ºå¤šä¸ªï¼Œæ¯”å¦‚è¯´æ ¹æ®4ä½è‹±æ–‡å­—ç¬¦ï¼ˆåŠè§’ï¼‰ï¼Œ2ä¸ªä¸­æ–‡å­—ç¬¦ï¼ˆå…¨è§’ï¼‰ä¸ºä¸€ä¸ªæ£€ç´¢æ¡ä»¶ï¼Œä¸¾ä¸ªä¾‹å­ï¼š\n\nningyu1ä½¿ç”¨4ä¸ªå­—ç¬¦ä¸ºä¸€ç»„çš„åŠ å¯†æ–¹å¼ï¼Œç¬¬ä¸€ç»„ning ï¼Œç¬¬äºŒç»„ingy ï¼Œç¬¬ä¸‰ç»„ngyu ï¼Œç¬¬å››ç»„gyu1 â€¦ ä¾æ¬¡ç±»æ¨ã€‚\n\nå¦‚æœéœ€è¦æ£€ç´¢æ‰€æœ‰åŒ…å«æ£€ç´¢æ¡ä»¶4ä¸ªå­—ç¬¦çš„æ•°æ®æ¯”å¦‚ï¼šingy ï¼ŒåŠ å¯†å­—ç¬¦åé€šè¿‡ key like â€œ%partial%â€ æŸ¥åº“ã€‚\næˆ‘ä»¬éƒ½çŸ¥é“åŠ å¯†åé•¿åº¦ä¼šå¢é•¿ï¼Œå¢é•¿çš„è¿™éƒ¨åˆ†é•¿åº¦å­˜å‚¨å°±æ˜¯æˆ‘ä»¬è¦èŠ±è´¹çš„é¢å¤–æˆæœ¬ï¼Œå…¸å‹çš„ä½¿ç”¨æˆæœ¬æ¥æ¢å–é€Ÿåº¦ï¼Œå¯†æ–‡å¢é•¿çš„å¹…åº¦éšç€ç®—æ³•ä¸åŒè€Œä¸åŒä»¥DESä¸¾ä¾‹ï¼Œ13800138000åŠ å¯†å‰å 11ä¸ªå­—èŠ‚ï¼ŒåŠ å¯†åçš„ä¸²HE9T75xNx6c5yLmS5l4r6Q==å 24ä¸ªå­—èŠ‚ï¼Œå¢é•¿æ˜¯2.18å€ï¼Œæ‰€ä»¥ä¸€ä¸ªä¼˜ç§€çš„ç®—æ³•æ˜¯å¤šä¹ˆçš„é‡è¦ï¼Œèƒ½ä¸ºå…¬å¸èŠ‚çœä¸å°‘æˆæœ¬ï¼Œä½†æ˜¯è¯åˆè¯´å›æ¥ç®—æ³•å·¥ç¨‹å¸ˆçš„å·¥èµ„ä¹Ÿä¸ä½ï¼Œæ‰€ä»¥æˆ‘ä¹Ÿä¸çŸ¥é“æ˜¯èŠ‚çœæˆæœ¬è¿˜æ˜¯å¢åŠ æˆæœ¬ï¼Œå“ˆå“ˆå“ˆâ€¦ä½ ä»¬è‡ªå·±ç®—å§ã€‚\nå›åˆ°ä¸»é¢˜ï¼Œè¿™ä¸ªæ–¹æ³•è™½ç„¶å¯ä»¥å®ç°åŠ å¯†æ•°æ®çš„æ¨¡ç³ŠæŸ¥è¯¢ï¼Œä½†æ˜¯å¯¹æ¨¡ç³ŠæŸ¥è¯¢çš„å­—ç¬¦é•¿åº¦æ˜¯æœ‰è¦æ±‚çš„ï¼Œä»¥æˆ‘ä¸Šé¢ä¸¾çš„ä¾‹å­æ¨¡ç³ŠæŸ¥è¯¢å­—ç¬¦åŸæ–‡é•¿åº¦å¿…é¡»å¤§äºç­‰äº4ä¸ªè‹±æ–‡/æ•°å­—ï¼Œæˆ–è€…2ä¸ªæ±‰å­—ï¼Œå†çŸ­çš„é•¿åº¦ä¸å»ºè®®æ”¯æŒï¼Œå› ä¸ºåˆ†è¯ç»„åˆä¼šå¢å¤šä»è€Œå¯¼è‡´å­˜å‚¨çš„æˆæœ¬å¢åŠ ï¼Œåè€Œå®‰å…¨æ€§é™ä½ã€‚\nå¤§å®¶æ˜¯å¦éƒ½å¯¹æ¥è¿‡ æ·˜å®ã€æ‹¼å¤šå¤šã€JDä»–ä»¬çš„apiï¼Œä»–ä»¬å¯¹å¹³å°è®¢å•æ•°æ®ä¸­çš„ç”¨æˆ·æ•æ„Ÿæ•°æ®å°±æ˜¯åŠ å¯†çš„åŒæ—¶æ”¯æŒæ¨¡ç³ŠæŸ¥è¯¢ï¼Œä½¿ç”¨å°±æ˜¯è¿™ä¸ªæ–¹æ³•ï¼Œä¸‹é¢æˆ‘æ•´ç†äº†å‡ å®¶ç”µå•†å¹³å°çš„å¯†æ–‡å­—æ®µæ£€ç´¢æ–¹æ¡ˆçš„è¯´æ˜ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹ä¸‹é¢é“¾æ¥ã€‚\n\næ·˜å®å¯†æ–‡å­—æ®µæ£€ç´¢æ–¹æ¡ˆï¼šhttps://open.taobao.com/docV3.htm?docId=106213&amp;docType=1\né˜¿é‡Œå·´å·´æ–‡å­—æ®µæ£€ç´¢æ–¹æ¡ˆï¼šhttps://jaq-doc.alibaba.com/docs/doc.htm?treeId=1&amp;articleId=106213&amp;docType=1\næ‹¼å¤šå¤šå¯†æ–‡å­—æ®µæ£€ç´¢æ–¹æ¡ˆï¼šhttps://open.pinduoduo.com/application/document/browse?idStr=3407B605226E77F2\näº¬ä¸œå¯†æ–‡å­—æ®µæ£€ç´¢æ–¹æ¡ˆï¼šhttps://jos.jd.com/commondoc?listId=345\n\n\nps. åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ï¼Œæœç„¶éƒ½æ˜¯äº’ç›¸æŠ„è¢­ï¼Œè¿åŠ å¯†åçš„æ•°æ®æ ¼å¼éƒ½ä¸€è‡´ã€‚\n\nè¿™ä¸ªæ–¹æ³•ä¼˜ç‚¹å°±æ˜¯å®ç°èµ·æ¥ä¸ç®—å¤æ‚ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿè¾ƒä¸ºç®€å•ï¼Œç®—æ˜¯ä¸€ä¸ªæŠ˜ä¸­çš„åšæ³•ï¼Œå› ä¸ºä¼šæœ‰æ‰©å±•å­—æ®µå­˜å‚¨æˆæœ¬ä¼šæœ‰å‡é«˜ï¼Œä½†æ˜¯å¯åˆ©ç”¨æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢é€Ÿåº¦ï¼Œæ¨èä½¿ç”¨è¿™ä¸ªæ–¹æ³•ã€‚\nå››ã€è¶…ç¥åšæ³•æˆ‘ä»¬æ¥ä¸‹æ¥çœ‹çœ‹ä¼˜ç§€çš„åšæ³•ï¼Œæ­¤ç±»åšæ³•éš¾åº¦è¾ƒé«˜ï¼Œéƒ½æ˜¯ä»ç®—æ³•å±‚é¢æ¥è€ƒè™‘ï¼Œæœ‰äº›ç”šè‡³ä¼šè®¾è®¡ä¸€ä¸ªæ–°ç®—æ³•ï¼Œè™½ç„¶å·²æœ‰ä¸€äº›ç°æˆçš„ç®—æ³•å‚è€ƒï¼Œä½†æ˜¯å¤§å¤šéƒ½æ˜¯åŠæˆå“æ— æ³•æ‹¿æ¥ç›´æ¥ä½¿ç”¨ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦æœ‰äººå»æ·±å…¥ç ”ç©¶å’Œæ•´åˆåˆ°è‡ªå·±çš„åº”ç”¨ä¸­å»ã€‚\nä»ç®—æ³•å±‚é¢æ€è€ƒï¼Œç”šè‡³ä¼šè®¾è®¡ä¸€ä¸ªæ–°ç®—æ³•æ¥æ”¯æŒæ¨¡ç³ŠæŸ¥æ‰¾\nè¿™ä¸ªå±‚é¢å¤§å¤šæ˜¯ä¸“ä¸šç®—æ³•å·¥ç¨‹å¸ˆçš„ç ”ç©¶é¢†åŸŸï¼Œæƒ³è¦è®¾è®¡ä¸€ä¸ªæœ‰åºçš„ã€éä¸å¯é€†çš„ã€å¯†æ–‡é•¿åº¦ä¸èƒ½å¢é•¿è¿‡å¿«çš„ç®—æ³•ä¸æ˜¯ä¸€ä»¶ç®€å•çš„äº‹æƒ…ï¼Œå¤§è‡´çš„æ€è·¯æ˜¯è¿™æ ·çš„ï¼Œä½¿ç”¨è¯‘ç çš„æ–¹å¼è¿›è¡ŒåŠ è§£å¯†ï¼Œä¿ç•™å¯†æ–‡å’ŒåŸæ–‡ä¸€æ ·çš„é¡ºåºï¼Œä»è€Œæ”¯æŒå¯†æ–‡æ¨¡ç³ŠåŒ¹é…ï¼Œè¯´çš„æ¯”è¾ƒç¬¼ç»Ÿå› ä¸ºæˆ‘ä¹Ÿä¸æ˜¯è¿™æ–¹é¢çš„ä¸“å®¶æ²¡æœ‰æ›´æ·±ä¸€æ­¥çš„ç ”ç©¶è¿‡ï¼Œæ‰€ä»¥æˆ‘ä»ç½‘ä¸Šæ‰¾äº†ä¸€äº›èµ„æ–™å¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚\n\næ•°æ®åº“ä¸­å­—ç¬¦æ•°æ®çš„æ¨¡ç³ŠåŒ¹é…åŠ å¯†æ–¹æ³•ï¼šhttps://www.jiamisoft.com/blog/6542-zifushujumohupipeijiamifangfa.html\n\nè¿™é‡Œæåˆ°çš„Hillå¯†ç å¤„ç†å’Œæ¨¡ç³ŠåŒ¹é…åŠ å¯†æ–¹æ³•FMESå¯ä»¥é‡ç‚¹çœ‹çœ‹.\n\nä¸€ç§åŸºäºBloomFilterçš„æ”¹è¿›å‹åŠ å¯†æ–‡æœ¬æ¨¡ç³Šæœç´¢æœºåˆ¶ç ”ç©¶ï¼šhttp://kzyjc.cnjournals.com/html/2019/1/20190112.htm\næ”¯æŒå¿«é€ŸæŸ¥è¯¢çš„æ•°æ®åº“å¦‚ä½•åŠ å¯†ï¼šhttps://www.jiamisoft.com/blog/5961-kuaisuchaxunshujukujiami.html\nåŸºäºLuceneçš„äº‘ç«¯æœç´¢ä¸å¯†æ–‡åŸºç¡€ä¸Šçš„æ¨¡ç³ŠæŸ¥è¯¢ï¼šhttps://www.cnblogs.com/arthurqin/p/6307153.html\n\nåŸºäºLuceneçš„æ€è·¯å°±è·Ÿæˆ‘ä»¬ä¸Šé¢ä»‹ç»çš„å¸¸è§„åšæ³•äºŒç±»ä¼¼ï¼Œå¯¹å­—ç¬¦è¿›è¡Œç­‰é•¿åº¦åˆ†è¯ï¼Œå°†åˆ†è¯åçš„ç»“æœé›†åŠ å¯†åå­˜å‚¨ï¼Œåªä¸è¿‡å­˜å‚¨çš„dbä¸ä¸€æ ·ï¼Œä¸€ä¸ªæ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œä¸€ä¸ªæ˜¯esæœç´¢å¼•æ“ã€‚\n\näº‘å­˜å‚¨ä¸­ä¸€ç§æ”¯æŒå¯éªŒè¯çš„æ¨¡ç³ŠæŸ¥è¯¢åŠ å¯†æ–¹æ¡ˆï¼šhttp://jeit.ie.ac.cn/fileDZYXXXB/journal/article/dzyxxxb/2017/7/PDF/160971.pdf\n\n","categories":["æŠ€æœ¯æ–¹æ¡ˆ"]},{"title":"çº¢é»‘æ ‘","url":"/posts/28769/","content":"ç¾å›¢åšå®¢ï¼šhttps://tech.meituan.com/2016/12/02/redblack-tree.html\nä¸€ã€å®šä¹‰\nèŠ‚ç‚¹æ˜¯é»‘è‰²æˆ–è€…çº¢è‰²ï¼›\næ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼›\næ‰€æœ‰å¶å­èŠ‚ç‚¹ï¼Œå³å¶å­æ˜¯ null çš„èŠ‚ç‚¹è¢«è®¤ä¸ºæ˜¯é»‘è‰²ï¼›\næ¯ä¸ªçº¢è‰²èŠ‚ç‚¹å¿…é¡»æœ‰ä¸¤ä¸ªé»‘è‰²çš„å­èŠ‚ç‚¹ï¼ˆä»æ¯ä¸ªå¶å­åˆ°æ ¹çš„æ‰€æœ‰è·¯å¾„ä¸Šä¸èƒ½æœ‰ä¸¤ä¸ªè¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ï¼‰ï¼›\nä»ä»»ä¸€èŠ‚ç‚¹åˆ°å…¶æ¯ä¸ªå¶å­çš„æ‰€æœ‰ç®€å•è·¯å¾„éƒ½åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ã€‚\n\nè¿™äº›çº¦æŸç¡®ä¿äº†çº¢é»‘æ ‘çš„å…³é”®ç‰¹æ€§ï¼šä»æ ¹åˆ°å¶å­çš„æœ€é•¿çš„å¯èƒ½è·¯å¾„ä¸å¤šäºæœ€çŸ­çš„å¯èƒ½è·¯å¾„çš„ä¸¤å€é•¿ã€‚\nç»“æœæ˜¯è¿™ä¸ªæ ‘å¤§è‡´ä¸Šæ˜¯å¹³è¡¡çš„ã€‚å› ä¸ºæ“ä½œæ¯”å¦‚æ’å…¥ã€åˆ é™¤å’ŒæŸ¥æ‰¾æŸä¸ªå€¼çš„æœ€åæƒ…å†µæ—¶é—´éƒ½è¦æ±‚ä¸æ ‘çš„é«˜åº¦æˆæ¯”ä¾‹ï¼Œè¿™ä¸ªåœ¨é«˜åº¦ä¸Šçš„ç†è®ºä¸Šé™å…è®¸çº¢é»‘æ ‘åœ¨æœ€åæƒ…å†µä¸‹éƒ½æ˜¯é«˜æ•ˆçš„ï¼Œè€Œä¸åŒäºæ™®é€šçš„äºŒå‰æŸ¥æ‰¾æ ‘ã€‚\nè¦çŸ¥é“ä¸ºä»€ä¹ˆè¿™äº›æ€§è´¨ç¡®ä¿äº†è¿™ä¸ªç»“æœï¼Œæ³¨æ„åˆ°æ€§è´¨4å¯¼è‡´äº†è·¯å¾„ä¸èƒ½æœ‰ä¸¤ä¸ªæ¯—è¿çš„çº¢è‰²èŠ‚ç‚¹å°±è¶³å¤Ÿäº†ã€‚\næœ€çŸ­çš„å¯èƒ½è·¯å¾„éƒ½æ˜¯é»‘è‰²èŠ‚ç‚¹ï¼Œæœ€é•¿çš„å¯èƒ½è·¯å¾„æœ‰äº¤æ›¿çš„çº¢è‰²å’Œé»‘è‰²èŠ‚ç‚¹ã€‚\nå› ä¸ºæ ¹æ®æ€§è´¨5æ‰€æœ‰æœ€é•¿çš„è·¯å¾„éƒ½æœ‰ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹ï¼Œè¿™å°±è¡¨æ˜äº†æ²¡æœ‰è·¯å¾„èƒ½å¤šäºä»»ä½•å…¶ä»–è·¯å¾„çš„ä¸¤å€é•¿ã€‚\näºŒã€æ’å…¥æ“ä½œæ¼”ç¤ºåœ°å€ï¼šhttps://www.cs.usfca.edu/~galles/visualization/RedBlack.html\n\nç±»å‹\nå·¦å·¦ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­æ ‘ï¼Œæ’å…¥èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­æ ‘\nå³å³ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­æ ‘ï¼Œæ’å…¥èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­æ ‘\nå·¦å³ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å·¦å­æ ‘ï¼Œæ’å…¥èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­æ ‘\nå³å·¦ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯ç¥–çˆ¶èŠ‚ç‚¹çš„å³å­æ ‘ï¼Œæ’å…¥èŠ‚ç‚¹æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­æ ‘\n\nå¯¹äº å·¦å³ å’Œ å³å·¦ï¼Œå…¶å®æ˜¯é€šè¿‡å…ˆè¿›è¡Œå·¦æ—‹æˆ–å³æ—‹ï¼Œå˜æˆ å·¦å·¦ å’Œ å³å³ çš„æƒ…å†µè¿›è¡Œå¤„ç†ã€‚\nå˜è‰²çˆ¶èŠ‚ç‚¹å˜é»‘ï¼Œç¥–çˆ¶èŠ‚ç‚¹å˜çº¢\n","categories":["æ•°æ®ç»“æ„"]},{"title":"Jmeter å®‰è£…QPSæ’ä»¶","url":"/posts/20220/","content":"æ’ä»¶ä¸‹è½½https://jmeter-plugins.org/wiki/Start/\n\nResponse Times Over Time\nTransactions per Second\n\n","categories":["æµ‹è¯•"]},{"title":"LVS","url":"/posts/19134/","content":"ä¸€ã€LVSä»‹ç»ç®€ä»‹  LVSæ˜¯Linux Virtual Serverçš„ç®€ç§°ï¼Œå³Linuxè™šæ‹ŸæœåŠ¡å™¨ï¼Œåˆ›å§‹äººå‰é˜¿é‡Œäº‘é¦–å¸­ç§‘å­¦å®¶ç« æ–‡åµ©åšå£«(ç°å·²ç»åœ¨æ»´æ»´)ï¼Œå®˜æ–¹ç½‘ç«™ï¼šwww.linuxvirtualserver.orgã€‚ä»å†…æ ¸ç‰ˆæœ¬2.4å¼€å§‹ï¼Œå·²ç»å®Œå…¨å†…ç½®äº†LVSçš„å„ä¸ªåŠŸèƒ½æ¨¡å—ï¼Œæ— éœ€ç»™å†…æ ¸æ‰“ä»»ä½•è¡¥ä¸ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨LVSæä¾›çš„å„ç§åŠŸèƒ½ã€‚é€šè¿‡LVSæä¾›çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯å’ŒLinuxæ“ä½œç³»ç»Ÿå¯å®ç°ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„æœåŠ¡å™¨ç¾¤é›†ï¼Œå®ƒå…·æœ‰è‰¯å¥½å¯é æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æ“ä½œæ€§ï¼Œä»¥ä½å»‰çš„æˆæœ¬å®ç°æœ€ä¼˜çš„æœåŠ¡æ€§èƒ½ã€‚\n\n\n\né€šç”¨ä½“ç³»ç»“æ„ã€€ã€€LVSé›†ç¾¤é‡‡ç”¨IPè´Ÿè½½å‡è¡¡æŠ€æœ¯å’ŒåŸºäºå†…å®¹è¯·æ±‚åˆ†å‘æŠ€æœ¯ã€‚è°ƒåº¦å™¨å…·æœ‰å¾ˆå¥½çš„ååç‡ï¼Œå°†è¯·æ±‚å‡è¡¡åœ°è½¬ç§»åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼Œä¸”è°ƒåº¦å™¨è‡ªåŠ¨å±è”½æ‰æœ åŠ¡å™¨çš„æ•…éšœï¼Œä»è€Œå°†ä¸€ç»„æœåŠ¡å™¨æ„æˆä¸€ä¸ªé«˜æ€§èƒ½çš„ã€é«˜å¯ç”¨çš„è™šæ‹ŸæœåŠ¡å™¨ã€‚æ•´ä¸ªæœåŠ¡å™¨é›†ç¾¤çš„ç»“æ„å¯¹å®¢æˆ·æ˜¯é€æ˜çš„ï¼Œè€Œä¸”æ— éœ€ä¿®æ”¹å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯çš„ç¨‹åºï¼Œä»¥ä¸‹æ˜¯ä½“ç³»ç»“æ„å›¾ï¼ˆæ¥æºhttp://www.linuxvirtualserver.org/architecture.htmlï¼‰ï¼š\n\n\nè´Ÿè½½è°ƒåº¦å™¨ï¼ˆload balancerï¼‰ï¼Œå®ƒæ˜¯æ•´ä¸ªé›†ç¾¤å¯¹å¤–é¢çš„å‰ç«¯æœºï¼Œè´Ÿè´£å°†å®¢æˆ·çš„è¯·æ±‚å‘é€åˆ°ä¸€ç»„æœåŠ¡å™¨ä¸Šæ‰§è¡Œã€‚\næœåŠ¡å™¨æ± ï¼ˆserver poolï¼‰ï¼Œæ˜¯ä¸€ç»„çœŸæ­£æ‰§è¡Œå®¢æˆ·è¯·æ±‚çš„æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯WEBã€MAILã€FTPå’ŒDNSæœåŠ¡å™¨ç­‰ã€‚\nå…±äº«å­˜å‚¨ï¼ˆshared storageï¼‰ï¼Œå®ƒä¸ºæœåŠ¡å™¨æ± æä¾›ä¸€ä¸ªå…±äº«çš„å­˜å‚¨åŒºï¼Œè¿™æ ·å¾ˆå®¹æ˜“ä½¿å¾—æœåŠ¡å™¨æ± æ‹¥æœ‰ç›¸åŒçš„å†…å®¹ï¼Œæä¾›ç›¸åŒçš„æœåŠ¡ï¼Œä¾‹å¦‚æ•°æ®åº“ã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œå­˜å‚¨ç­‰ã€‚\n\nä¼˜ç¼ºç‚¹\né«˜å¹¶å‘è¿æ¥ï¼šLVSåŸºäºå†…æ ¸ç½‘ç»œå±‚é¢å·¥ä½œï¼Œæœ‰è¶…å¼ºçš„æ‰¿è½½èƒ½åŠ›å’Œå¹¶å‘å¤„ç†èƒ½åŠ›ã€‚å•å°LVSè´Ÿè½½å‡è¡¡å™¨ï¼Œå¯æ”¯æŒä¸Šä¸‡å¹¶å‘è¿æ¥ã€‚ç¨³å®šæ€§å¼ºï¼šæ˜¯å·¥ä½œåœ¨ç½‘ç»œ4å±‚ä¹‹ä¸Šä»…ä½œåˆ†å‘ä¹‹ç”¨ï¼Œè¿™ä¸ªç‰¹ç‚¹ä¹Ÿå†³å®šäº†å®ƒåœ¨è´Ÿè½½å‡è¡¡è½¯ä»¶é‡Œçš„æ€§èƒ½æœ€å¼ºï¼Œç¨³å®šæ€§æœ€å¥½ï¼Œå¯¹å†…å­˜å’Œcpuèµ„æºæ¶ˆè€—æä½ã€‚\næˆæœ¬ä½å»‰ï¼šç¡¬ä»¶è´Ÿè½½å‡è¡¡å™¨å°‘åˆ™åå‡ ä¸‡ï¼Œå¤šåˆ™å‡ åä¸‡ä¸Šç™¾ä¸‡ï¼ŒLVSåªéœ€ä¸€å°æœåŠ¡å™¨å’Œå°±èƒ½å…è´¹éƒ¨ç½²ä½¿ç”¨ï¼Œæ€§ä»·æ¯”æé«˜ã€‚\né…ç½®ç®€å•ï¼šLVSé…ç½®éå¸¸ç®€å•ï¼Œä»…éœ€å‡ è¡Œå‘½ä»¤å³å¯å®Œæˆé…ç½®ï¼Œä¹Ÿå¯å†™æˆè„šæœ¬è¿›è¡Œç®¡ç†ã€‚\næ”¯æŒå¤šç§ç®—æ³•ï¼šæ”¯æŒ8ç§è´Ÿè½½å‡è¡¡ç®—æ³•ï¼Œå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯çµæ´»è°ƒé…è¿›è¡Œä½¿ç”¨ã€‚\næ”¯æŒå¤šç§å·¥ä½œæ¨¡å‹ï¼šå¯æ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œä½¿ç”¨ä¸åŒçš„å·¥ä½œæ¨¡å¼æ¥è§£å†³ç”Ÿäº§ç¯å¢ƒè¯·æ±‚å¤„ç†é—®é¢˜ã€‚\nåº”ç”¨èŒƒå›´å¹¿ï¼šå› ä¸ºLVSå·¥ä½œåœ¨4å±‚ï¼Œæ‰€ä»¥å®ƒå‡ ä¹å¯ä»¥å¯¹æ‰€æœ‰åº”ç”¨åšè´Ÿè½½å‡è¡¡ï¼ŒåŒ…æ‹¬httpã€æ•°æ®åº“ã€DNSã€ftpæœåŠ¡ç­‰ç­‰ã€‚\nç¼ºç‚¹ï¼šå·¥ä½œåœ¨4å±‚ï¼Œä¸æ”¯æŒ7å±‚è§„åˆ™ä¿®æ”¹ï¼Œæœºåˆ¶è¿‡äºåºå¤§ï¼Œä¸é€‚åˆå°è§„æ¨¡åº”ç”¨ã€‚\n\nç»„ä»¶å’Œä¸“ä¸šæœ¯è¯­ç»„ä»¶ï¼š\n\nipvsadmï¼šç”¨æˆ·ç©ºé—´çš„å®¢æˆ·ç«¯å·¥å…·ï¼Œç”¨äºç®¡ç†é›†ç¾¤æœåŠ¡åŠé›†ç¾¤æœåŠ¡ä¸Šçš„RSç­‰ï¼›\nipvsï¼šå·¥ä½œäºå†…æ ¸ä¸Šçš„netfilter INPUTé’©å­ä¹‹ä¸Šçš„ç¨‹åºï¼Œå¯æ ¹æ®ç”¨æˆ·å®šä¹‰çš„é›†ç¾¤å®ç°è¯·æ±‚è½¬å‘ï¼›\n\nä¸“ä¸šæœ¯è¯­ï¼š\n\nVSï¼šVirtual Server ï¼Œè™šæ‹ŸæœåŠ¡\nDirectorï¼š Balancer ï¼Œä¹Ÿå«DS(Director Server)è´Ÿè½½å‡è¡¡å™¨ã€åˆ†å‘å™¨\nRSï¼šReal Server ï¼Œåç«¯è¯·æ±‚å¤„ç†æœåŠ¡å™¨ï¼ŒçœŸå®æœåŠ¡å™¨\nCIP: Client IP ï¼Œå®¢æˆ·ç«¯IP\nVIPï¼šDirector Virtual IP ï¼Œè´Ÿè½½å‡è¡¡å™¨è™šæ‹ŸIP\nDIPï¼šDirector IP ï¼Œè´Ÿè½½å‡è¡¡å™¨IP\nRIPï¼šReal Server IP ï¼Œåç«¯è¯·æ±‚å¤„ç†çš„æœåŠ¡å™¨IP\n\nå·¥ä½œæ¨¡å‹\nVSå·¥ä½œåœ¨å†…æ ¸ç©ºé—´ï¼ŒåŸºäºå†…æ ¸åŒ…å¤„ç†æ¡†æ¶Netfilterå®ç°çš„ä¸€ç§è´Ÿè´£å‡è¡¡æŠ€æœ¯ï¼Œå…¶åœ¨å·¥ä½œæ¨¡å¼å¦‚ä¸Šå›¾,å¤§è‡´è¿‡ç¨‹ï¼š\n\nå½“å®¢æˆ·ç«¯çš„è¯·æ±‚åˆ°è¾¾è´Ÿè½½å‡è¡¡å™¨çš„å†…æ ¸ç©ºé—´æ—¶ï¼Œé¦–å…ˆä¼šåˆ°è¾¾PREROUTINGé“¾ã€‚\nå½“å†…æ ¸å‘ç°è¯·æ±‚æ•°æ®åŒ…çš„ç›®çš„åœ°å€æ˜¯æœ¬æœºæ—¶ï¼Œå°†æ•°æ®åŒ…é€å¾€INPUTé“¾ã€‚\nLVSç”±ç”¨æˆ·ç©ºé—´çš„ipvsadmå’Œå†…æ ¸ç©ºé—´çš„IPVSç»„æˆï¼Œipvsadmç”¨æ¥å®šä¹‰è§„åˆ™ï¼ŒIPVSåˆ©ç”¨ipvsadmå®šä¹‰çš„è§„åˆ™å·¥ä½œï¼ŒIPVSå·¥ä½œåœ¨INPUTé“¾ä¸Š,å½“æ•°æ®åŒ…åˆ°è¾¾INPUTé“¾æ—¶ï¼Œé¦–å…ˆä¼šè¢«IPVSæ£€æŸ¥ï¼Œå¦‚æœæ•°æ®åŒ…é‡Œé¢çš„ç›®çš„åœ°å€åŠç«¯å£æ²¡æœ‰åœ¨è§„åˆ™é‡Œé¢ï¼Œé‚£ä¹ˆè¿™æ¡æ•°æ®åŒ…å°†è¢«æ”¾è¡Œè‡³ç”¨æˆ·ç©ºé—´ã€‚\nå¦‚æœæ•°æ®åŒ…é‡Œé¢çš„ç›®çš„åœ°å€åŠç«¯å£åœ¨è§„åˆ™é‡Œé¢ï¼Œé‚£ä¹ˆè¿™æ¡æ•°æ®æŠ¥æ–‡å°†è¢«ä¿®æ”¹ç›®çš„åœ°å€ä¸ºäº‹å…ˆå®šä¹‰å¥½çš„åç«¯æœåŠ¡å™¨ï¼Œå¹¶é€å¾€POSTROUTINGé“¾ã€‚\næœ€åç»ç”±POSTROUTINGé“¾å‘å¾€åç«¯æœåŠ¡å™¨ã€‚\n\näºŒã€è´Ÿè½½å‡è¡¡æ¨¡å¼LVS-NATæ¨¡å¼ç®€ä»‹\nã€€ã€€NATæ¨¡å¼ç§°ä¸ºå…¨ç§°Virtualserver via Network address translation(VS/NAT)ï¼Œæ˜¯é€šè¿‡ç½‘ç»œåœ°å€è½¬æ¢çš„æ–¹æ³•æ¥å®ç°è°ƒåº¦çš„ã€‚é¦–å…ˆè°ƒåº¦å™¨(Director)æ¥æ”¶åˆ°å®¢æˆ·çš„è¯·æ±‚æ•°æ®åŒ…æ—¶ï¼ˆè¯·æ±‚çš„ç›®çš„IPä¸ºVIPï¼‰ï¼Œæ ¹æ®è°ƒåº¦ç®—æ³•å†³å®šå°†è¯·æ±‚å‘é€ç»™å“ªä¸ªåç«¯çš„çœŸå®æœåŠ¡å™¨ï¼ˆRSï¼‰ã€‚ç„¶åè°ƒåº¦å°±æŠŠå®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ•°æ®åŒ…çš„ç›®æ ‡IPåœ°å€åŠç«¯å£æ”¹æˆåç«¯çœŸå®æœåŠ¡å™¨çš„IPåœ°å€ï¼ˆRIPï¼‰,è¿™æ ·çœŸå®æœåŠ¡å™¨ï¼ˆRSï¼‰å°±èƒ½å¤Ÿæ¥æ”¶åˆ°å®¢æˆ·çš„è¯·æ±‚æ•°æ®åŒ…äº†ã€‚çœŸå®æœåŠ¡å™¨å“åº”å®Œè¯·æ±‚åï¼ŒæŸ¥çœ‹é»˜è®¤è·¯ç”±ï¼ˆNATæ¨¡å¼ä¸‹æˆ‘ä»¬éœ€è¦æŠŠRSçš„é»˜è®¤è·¯ç”±è®¾ç½®ä¸ºDSæœåŠ¡å™¨ã€‚ï¼‰æŠŠå“åº”åçš„æ•°æ®åŒ…å‘é€ç»™DS,DSå†æ¥æ”¶åˆ°å“åº”åŒ…åï¼ŒæŠŠåŒ…çš„æºåœ°å€æ”¹æˆè™šæ‹Ÿåœ°å€ï¼ˆVIPï¼‰ç„¶åå‘é€å›ç»™å®¢æˆ·ç«¯ã€‚\nå…·ä½“å·¥ä½œæµç¨‹ï¼š\n\nè¯´æ˜ï¼š\n(1)å½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾DirectorServerï¼Œæ­¤æ—¶è¯·æ±‚çš„æ•°æ®æŠ¥æ–‡ä¼šå…ˆåˆ°å†…æ ¸ç©ºé—´çš„PREROUTINGé“¾ã€‚ æ­¤æ—¶æŠ¥æ–‡çš„æºIPä¸ºCIPï¼Œç›®æ ‡IPä¸ºVIPã€‚\n(2) PREROUTINGæ£€æŸ¥å‘ç°æ•°æ®åŒ…çš„ç›®æ ‡IPæ˜¯æœ¬æœºï¼Œå°†æ•°æ®åŒ…é€è‡³INPUTé“¾ã€‚\n(3) IPVSæ¯”å¯¹æ•°æ®åŒ…è¯·æ±‚çš„æœåŠ¡æ˜¯å¦ä¸ºé›†ç¾¤æœåŠ¡ï¼Œè‹¥æ˜¯ï¼Œä¿®æ”¹æ•°æ®åŒ…çš„ç›®æ ‡IPåœ°å€ä¸ºåç«¯æœåŠ¡å™¨IPï¼Œç„¶åå°†æ•°æ®åŒ…å‘è‡³POSTROUTINGé“¾ã€‚ æ­¤æ—¶æŠ¥æ–‡çš„æºIPä¸ºCIPï¼Œç›®æ ‡IPä¸ºRIP ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹å®Œæˆäº†ç›®æ ‡IPçš„è½¬æ¢ï¼ˆDNATï¼‰ã€‚\n(4) POSTROUTINGé“¾é€šè¿‡é€‰è·¯ï¼Œå°†æ•°æ®åŒ…å‘é€ç»™Real Serverã€‚\n(5) Real Serveræ¯”å¯¹å‘ç°ç›®æ ‡ä¸ºè‡ªå·±çš„IPï¼Œå¼€å§‹æ„å»ºå“åº”æŠ¥æ–‡å‘å›ç»™Director Serverã€‚ æ­¤æ—¶æŠ¥æ–‡çš„æºIPä¸ºRIPï¼Œç›®æ ‡IPä¸ºCIP ã€‚\n(6) Director Serveråœ¨å“åº”å®¢æˆ·ç«¯å‰ï¼Œæ­¤æ—¶ä¼šå°†æºIPåœ°å€ä¿®æ”¹ä¸ºè‡ªå·±çš„VIPåœ°å€ï¼ˆSNATï¼‰ï¼Œç„¶åå“åº”ç»™å®¢æˆ·ç«¯ã€‚ æ­¤æ—¶æŠ¥æ–‡çš„æºIPä¸ºVIPï¼Œç›®æ ‡IPä¸ºCIPã€‚ \nNATæ¨¡å¼ä¼˜ç¼ºç‚¹ï¼š\n\nNATæŠ€æœ¯å°†è¯·æ±‚çš„æŠ¥æ–‡å’Œå“åº”çš„æŠ¥æ–‡éƒ½éœ€è¦é€šè¿‡DSè¿›è¡Œåœ°å€æ”¹å†™ï¼Œå› æ­¤ç½‘ç«™è®¿é—®é‡æ¯”è¾ƒå¤§çš„æ—¶å€™DSè´Ÿè½½å‡è¡¡è°ƒåº¦å™¨æœ‰æ¯”è¾ƒå¤§çš„ç“¶é¢ˆï¼Œä¸€èˆ¬è¦æ±‚æœ€å¤šä¹‹èƒ½10-20å°èŠ‚ç‚¹ã€‚\nèŠ‚çœIPï¼Œåªéœ€è¦åœ¨DSä¸Šé…ç½®ä¸€ä¸ªå…¬ç½‘IPåœ°å€å°±å¯ä»¥äº†ã€‚\næ¯å°å†…éƒ¨çš„èŠ‚ç‚¹æœåŠ¡å™¨çš„ç½‘å…³åœ°å€å¿…é¡»æ˜¯è°ƒåº¦å™¨LBçš„å†…ç½‘åœ°å€ã€‚\nNATæ¨¡å¼æ”¯æŒå¯¹IPåœ°å€å’Œç«¯å£è¿›è¡Œè½¬æ¢ã€‚å³ç”¨æˆ·è¯·æ±‚çš„ç«¯å£å’ŒçœŸå®æœåŠ¡å™¨çš„ç«¯å£å¯ä»¥ä¸ä¸€è‡´ã€‚ \n\nåœ°å€å˜åŒ–è¿‡ç¨‹ï¼š\n\nLVS-DRæ¨¡å¼ç®€ä»‹\nã€€ã€€å…¨ç§°ï¼šVirtual Server via Direct Routing(VS-DR)ï¼Œä¹Ÿå«ç›´æ¥è·¯ç”±æ¨¡å¼ï¼Œç”¨ç›´æ¥è·¯ç”±æŠ€æœ¯å®ç°è™šæ‹ŸæœåŠ¡å™¨ï½¡å½“å‚ä¸é›†ç¾¤çš„è®¡ç®—æœºå’Œä½œä¸ºæ§åˆ¶ç®¡ç†çš„è®¡ç®—æœºåœ¨åŒä¸€ä¸ªç½‘æ®µæ—¶å¯ä»¥ç”¨æ­¤æ–¹æ³•,æ§åˆ¶ç®¡ç†çš„è®¡ç®—æœºæ¥æ”¶åˆ°è¯·æ±‚åŒ…æ—¶ç›´æ¥é€åˆ°å‚ä¸é›†ç¾¤çš„èŠ‚ç‚¹ï½¡ç›´æ¥è·¯ç”±æ¨¡å¼æ¯”è¾ƒç‰¹åˆ«ï¼Œå¾ˆéš¾è¯´å’Œä»€ä¹ˆæ–¹é¢ç›¸ä¼¼ï¼Œå‰ç§æ¨¡å¼åŸºæœ¬ä¸Šéƒ½æ˜¯å·¥ä½œåœ¨ç½‘ç»œå±‚ä¸Šï¼ˆä¸‰å±‚ï¼‰ï¼Œè€Œç›´æ¥è·¯ç”±æ¨¡å¼åˆ™åº”è¯¥æ˜¯å·¥ä½œåœ¨æ•°æ®é“¾è·¯å±‚ä¸Šï¼ˆäºŒå±‚ï¼‰ã€‚\nå·¥ä½œåŸç† \nã€€ã€€DSå’ŒRSéƒ½ä½¿ç”¨åŒä¸€ä¸ªIPå¯¹å¤–æœåŠ¡ã€‚ä½†åªæœ‰DSå¯¹ARPè¯·æ±‚è¿›è¡Œå“åº”ï¼Œæ‰€æœ‰RSå¯¹æœ¬èº«è¿™ä¸ªIPçš„ARPè¯·æ±‚ä¿æŒé™é»˜ï¼ˆå¯¹ARPè¯·æ±‚ä¸åšå“åº”ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œç½‘å…³ä¼šæŠŠå¯¹è¿™ä¸ªæœåŠ¡IPçš„è¯·æ±‚å…¨éƒ¨å®šå‘ç»™DSï¼Œè€ŒDSæ”¶åˆ°æ•°æ®åŒ…åæ ¹æ®è°ƒåº¦ç®—æ³•ï¼Œæ‰¾å‡ºå¯¹åº”çš„ RSï¼ŒæŠŠç›®çš„MACåœ°å€æ”¹ä¸ºRSçš„MACå¹¶å‘ç»™è¿™å°RSã€‚è¿™æ—¶RSæ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…ï¼Œåˆ™ç­‰äºç›´æ¥ä»å®¢æˆ·ç«¯æ”¶åˆ°è¿™ä¸ªæ•°æ®åŒ…æ— å¼‚ï¼Œå¤„ç†åç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ã€‚ç”±äºDSè¦å¯¹äºŒå±‚åŒ…å¤´è¿›è¡Œæ”¹æ¢ï¼Œæ‰€ä»¥DSå’ŒRSä¹‹é—´å¿…é¡»åœ¨ä¸€ä¸ªå¹¿æ’­åŸŸï¼Œä¹Ÿå¯ä»¥ç®€å•çš„ç†è§£ä¸ºåœ¨åŒä¸€å°äº¤æ¢æœºä¸Šã€‚\nå·¥ä½œæµç¨‹\n\nè¯´æ˜ï¼š\n\nå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾Director Serverï¼Œæ­¤æ—¶è¯·æ±‚çš„æ•°æ®æŠ¥æ–‡ä¼šå…ˆåˆ°å†…æ ¸ç©ºé—´çš„PREROUTINGé“¾ã€‚ æ­¤æ—¶æŠ¥æ–‡çš„æºIPä¸ºCIPï¼Œç›®æ ‡IPä¸ºVIPï¼›\nPREROUTINGæ£€æŸ¥å‘ç°æ•°æ®åŒ…çš„ç›®æ ‡IPæ˜¯æœ¬æœºï¼Œå°†æ•°æ®åŒ…é€è‡³INPUTé“¾ï¼›\nIPVSæ¯”å¯¹æ•°æ®åŒ…è¯·æ±‚çš„æœåŠ¡æ˜¯å¦ä¸ºé›†ç¾¤æœåŠ¡ï¼Œè‹¥æ˜¯ï¼Œå°†è¯·æ±‚æŠ¥æ–‡ä¸­çš„æºMACåœ°å€ä¿®æ”¹ä¸ºDIPçš„MACåœ°å€ï¼Œå°†ç›®æ ‡MACåœ°å€ä¿®æ”¹RIPçš„MACåœ°å€ï¼Œç„¶åå°†æ•°æ®åŒ…å‘è‡³POSTROUTINGé“¾ã€‚ æ­¤æ—¶çš„æºIPå’Œç›®çš„IPå‡æœªä¿®æ”¹ï¼Œä»…ä¿®æ”¹äº†æºMACåœ°å€ä¸ºDIPçš„MACåœ°å€ï¼Œç›®æ ‡MACåœ°å€ä¸ºRIPçš„MACåœ°å€ï¼›\nç”±äºDSå’ŒRSåœ¨åŒä¸€ä¸ªç½‘ç»œä¸­ï¼Œæ‰€ä»¥æ˜¯é€šè¿‡äºŒå±‚ï¼Œæ•°æ®é“¾è·¯å±‚æ¥ä¼ è¾“ã€‚POSTROUTINGé“¾æ£€æŸ¥ç›®æ ‡MACåœ°å€ä¸ºRIPçš„MACåœ°å€ï¼Œé‚£ä¹ˆæ­¤æ—¶æ•°æ®åŒ…å°†ä¼šå‘è‡³Real Serverï¼›\nRSå‘ç°è¯·æ±‚æŠ¥æ–‡çš„MACåœ°å€æ˜¯è‡ªå·±çš„MACåœ°å€ï¼Œå°±æ¥æ”¶æ­¤æŠ¥æ–‡ã€‚å¤„ç†å®Œæˆä¹‹åï¼Œå°†å“åº”æŠ¥æ–‡é€šè¿‡loæ¥å£ä¼ é€ç»™eth0ç½‘å¡ç„¶åå‘å¤–å‘å‡ºã€‚ æ­¤æ—¶çš„æºIPåœ°å€ä¸ºVIPï¼Œç›®æ ‡IPä¸ºCIPï¼›\nå“åº”æŠ¥æ–‡æœ€ç»ˆé€è¾¾è‡³å®¢æˆ·ç«¯ã€‚\n\nåœ°å€å˜åŒ–è¿‡ç¨‹\n\n DRæ¨¡å¼ç‰¹ç‚¹ä»¥åŠæ³¨æ„äº‹é¡¹ï¼š\n\nåœ¨å‰ç«¯è·¯ç”±å™¨åšé™æ€åœ°å€è·¯ç”±ç»‘å®šï¼Œå°†å¯¹äºVIPçš„åœ°å€ä»…è·¯ç”±åˆ°Director Server\nåœ¨arpçš„å±‚æ¬¡ä¸Šå®ç°åœ¨ARPè§£ææ—¶åšé˜²ç«å¢™è§„åˆ™ï¼Œè¿‡æ»¤RSå“åº”ARPè¯·æ±‚ã€‚ä¿®æ”¹RSä¸Šå†…æ ¸å‚æ•°ï¼ˆarp_ignoreå’Œarp_announceï¼‰å°†RSä¸Šçš„VIPé…ç½®åœ¨ç½‘å¡æ¥å£çš„åˆ«åä¸Šï¼Œå¹¶é™åˆ¶å…¶ä¸èƒ½å“åº”å¯¹VIPåœ°å€è§£æè¯·æ±‚ã€‚\nRSå¯ä»¥ä½¿ç”¨ç§æœ‰åœ°å€ï¼›ä½†ä¹Ÿå¯ä»¥ä½¿ç”¨å…¬ç½‘åœ°å€ï¼Œæ­¤æ—¶å¯ä»¥ç›´æ¥é€šè¿‡äº’è”ç½‘è¿å…¥RSä»¥å®ç°é…ç½®ã€ç›‘æ§ç­‰ï¼›\nRSçš„ç½‘å…³ä¸€å®šä¸èƒ½æŒ‡å‘DIPï¼›\nå› ä¸ºDRæ¨¡å¼æ˜¯é€šè¿‡MACåœ°å€æ”¹å†™æœºåˆ¶å®ç°è½¬å‘,RSè·ŸDirctoryè¦åœ¨åŒä¸€ç‰©ç†ç½‘ç»œå†…ï¼ˆä¸èƒ½ç”±è·¯ç”±å™¨åˆ†éš”ï¼‰ï¼›\nè¯·æ±‚æŠ¥æ–‡ç»è¿‡Directoryï¼Œä½†å“åº”æŠ¥æ–‡ä¸€å®šä¸ç»è¿‡Director\nä¸æ”¯æŒç«¯å£æ˜ å°„ï¼›\nRSå¯ä»¥ä½¿ç”¨å¤§å¤šæ•°çš„æ“ä½œç³»ç»Ÿï¼›\nRSä¸Šçš„loæ¥å£é…ç½®VIPçš„IPåœ°å€; \n\nLVS- UNæ¨¡å¼ä»‹ç»  åœ¨VS/NAT çš„é›†ç¾¤ç³»ç»Ÿä¸­ï¼Œè¯·æ±‚å’Œå“åº”çš„æ•°æ®æŠ¥æ–‡éƒ½éœ€è¦é€šè¿‡è´Ÿè½½è°ƒåº¦å™¨ï¼Œå½“çœŸå®æœåŠ¡å™¨çš„æ•°ç›®åœ¨10å°å’Œ20å°ä¹‹é—´æ—¶ï¼Œè´Ÿè½½è°ƒåº¦å™¨å°†æˆä¸ºæ•´ä¸ªé›†ç¾¤ç³»ç»Ÿçš„æ–°ç“¶é¢ˆã€‚å¤§å¤šæ•° InternetæœåŠ¡éƒ½æœ‰è¿™æ ·çš„ç‰¹ç‚¹ï¼šè¯·æ±‚æŠ¥æ–‡è¾ƒçŸ­è€Œå“åº”æŠ¥æ–‡å¾€å¾€åŒ…å«å¤§é‡çš„æ•°æ®ã€‚å¦‚æœèƒ½å°†è¯·æ±‚å’Œå“åº”åˆ†å¼€å¤„ç†ï¼Œå³åœ¨è´Ÿè½½è°ƒåº¦å™¨ä¸­åªè´Ÿè´£è°ƒåº¦è¯·æ±‚è€Œå“åº”ç›´ æ¥è¿”å›ç»™å®¢æˆ·ï¼Œå°†æå¤§åœ°æé«˜æ•´ä¸ªé›†ç¾¤ç³»ç»Ÿçš„ååé‡ã€‚\n   IPéš§é“ï¼ˆIP tunnelingï¼‰æ˜¯å°†ä¸€ä¸ªIPæŠ¥æ–‡å°è£…åœ¨å¦ä¸€ä¸ªIPæŠ¥æ–‡çš„æŠ€æœ¯ï¼Œè¿™å¯ä»¥ä½¿å¾—ç›®æ ‡ä¸ºä¸€ä¸ªIPåœ°å€çš„æ•°æ®æŠ¥æ–‡èƒ½è¢«å°è£…å’Œè½¬å‘åˆ°å¦ä¸€ä¸ªIPåœ°å€ã€‚IPéš§é“æŠ€ æœ¯äº¦ç§°ä¸ºIPå°è£…æŠ€æœ¯ï¼ˆIP encapsulationï¼‰ã€‚IPéš§é“ä¸»è¦ç”¨äºç§»åŠ¨ä¸»æœºå’Œè™šæ‹Ÿç§æœ‰ç½‘ç»œï¼ˆVirtual Private Networkï¼‰ï¼Œåœ¨å…¶ä¸­éš§é“éƒ½æ˜¯é™æ€å»ºç«‹çš„ï¼Œéš§é“ä¸€ç«¯æœ‰ä¸€ä¸ªIPåœ°å€ï¼Œå¦ä¸€ç«¯ä¹Ÿæœ‰å”¯ä¸€çš„IPåœ°å€ã€‚\n  åœ¨TUNæ¨¡å¼ä¸‹ï¼Œåˆ©ç”¨IPéš§é“æŠ€æœ¯å°†è¯·æ±‚æŠ¥æ–‡å°è£…è½¬å‘ç»™åç«¯æœåŠ¡å™¨ï¼Œå“åº”æŠ¥æ–‡èƒ½ä»åç«¯æœåŠ¡å™¨ç›´æ¥è¿”å›ç»™å®¢æˆ·ã€‚ä½†åœ¨è¿™é‡Œï¼Œåç«¯æœåŠ¡å™¨æœ‰ä¸€ç»„è€Œéä¸€ä¸ªï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¯èƒ½é™æ€åœ°å»ºç«‹ä¸€ä¸€å¯¹åº”çš„éš§é“ï¼Œè€Œæ˜¯åŠ¨æ€åœ°é€‰æ‹© ä¸€å°æœåŠ¡å™¨ï¼Œå°†è¯·æ±‚æŠ¥æ–‡å°è£…å’Œè½¬å‘ç»™é€‰å‡ºçš„æœåŠ¡å™¨ã€‚\nå·¥ä½œæµç¨‹\nå®¢æˆ·ç«¯å°†è¯·æ±‚å‘å¾€å‰ç«¯çš„è´Ÿè½½å‡è¡¡å™¨ï¼Œè¯·æ±‚æŠ¥æ–‡æºåœ°å€æ˜¯CIPï¼Œç›®æ ‡åœ°å€ä¸ºVIPã€‚\nè´Ÿè½½å‡è¡¡å™¨æ”¶åˆ°æŠ¥æ–‡åï¼Œå‘ç°è¯·æ±‚çš„æ˜¯åœ¨è§„åˆ™é‡Œé¢å­˜åœ¨çš„åœ°å€ï¼Œé‚£ä¹ˆå®ƒå°†åœ¨å®¢æˆ·ç«¯è¯·æ±‚æŠ¥æ–‡çš„é¦–éƒ¨å†å°è£…ä¸€å±‚IPæŠ¥æ–‡,å°†æºåœ°å€æ”¹ä¸ºDIPï¼Œç›®æ ‡åœ°å€æ”¹ä¸ºRIP,å¹¶å°†æ­¤åŒ…å‘é€ç»™RSã€‚\nRSæ”¶åˆ°è¯·æ±‚æŠ¥æ–‡åï¼Œä¼šé¦–å…ˆæ‹†å¼€ç¬¬ä¸€å±‚å°è£…,ç„¶åå‘ç°é‡Œé¢è¿˜æœ‰ä¸€å±‚IPé¦–éƒ¨çš„ç›®æ ‡åœ°å€æ˜¯è‡ªå·±loæ¥å£ä¸Šçš„VIPï¼Œæ‰€ä»¥ä¼šå¤„ç†æ¬¡è¯·æ±‚æŠ¥æ–‡ï¼Œå¹¶å°†å“åº”æŠ¥æ–‡é€šè¿‡loæ¥å£é€ç»™eth0ç½‘å¡ç›´æ¥å‘é€ç»™å®¢æˆ·ç«¯ã€‚æ³¨æ„ï¼šéœ€è¦è®¾ç½®loæ¥å£çš„VIPä¸èƒ½åœ¨å…±ç½‘ä¸Šå‡ºç°\n\nåœ°å€å˜åŒ–è¿‡ç¨‹\nFULL-NATæ¨¡å¼ä»‹ç»  FULL-NATæ¨¡å¼å¯ä»¥å®é™…ä¸Šæ˜¯æ ¹æ®LVS-NATæ¨¡å¼çš„ä¸€ç§æ‰©å±•ã€‚åœ¨NATæ¨¡å¼ä¸‹DSéœ€è¦å…ˆå¯¹è¯·æ±‚è¿›è¡Œç›®çš„åœ°å€è½¬æ¢(DNAT)ï¼Œç„¶åå¯¹å“åº”åŒ…è¿›è¡Œæºåœ°å€è½¬æ¢ï¼ˆSNATï¼‰ï¼Œå…ˆåè¿›è¡Œä¸¤æ¬¡NATï¼Œè€Œ FULL-NATåˆ™åˆ†åˆ«å¯¹è¯·æ±‚è¿›è¡Œå’Œå“åº”è¿›è¡ŒDNATå’ŒSNATï¼Œè¿›è¡Œ4æ¬¡NATï¼Œå½“ç„¶è¿™æ ·å¤šæ¬¡æ•°çš„NATä¼šå¯¹æ€§èƒ½å¤§å¤§å‰Šå‡ï¼Œä½†æ˜¯ç”±äºå¯¹è¯·æ±‚æŠ¥æ–‡çš„ç›®çš„åœ°å€å’Œæºåœ°å€éƒ½è¿›è¡Œäº†è½¬æ¢ï¼Œåç«¯çš„RSå¯ä»¥ä¸åœ¨åŒä¸€ä¸ªVLANä¸‹ã€‚ \nå·¥ä½œæµç¨‹\nè¯´æ˜ï¼š\n\né¦–å…ˆclient å‘é€è¯·æ±‚packageç»™VIP;\nVIP æ”¶åˆ°packageåï¼Œä¼šæ ¹æ®LVSè®¾ç½®çš„LBç®—æ³•é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„RSï¼Œç„¶åæŠŠpackage çš„ç›®åœ°å€ä¿®æ”¹ä¸ºRSçš„ipåœ°å€ï¼ŒæŠŠæºåœ°å€æ”¹æˆDSçš„ipåœ°å€ï¼›\nRSæ”¶åˆ°è¿™ä¸ªpackageåå‘ç°ç›®æ ‡åœ°å€æ˜¯è‡ªå·±ï¼Œå°±å¤„ç†è¿™ä¸ªpackage ï¼Œå¤„ç†å®ŒåæŠŠè¿™ä¸ªåŒ…å‘é€ç»™DSï¼›\nDSæ”¶åˆ°è¿™ä¸ªpackage åæŠŠæºåœ°å€æ”¹æˆVIPçš„IPï¼Œç›®çš„åœ°å€æ”¹æˆCIP(å®¢æˆ·ç«¯ip)ï¼Œç„¶åå‘é€ç»™å®¢æˆ·ç«¯ï¼›\n\nä¼˜ç¼ºç‚¹ï¼š\n\nRIPï¼ŒDIPå¯ä»¥ä½¿ç”¨ç§æœ‰åœ°å€ï¼›\nRIPå’ŒDIPå¯ä»¥ä¸å†åŒä¸€ä¸ªç½‘ç»œä¸­ï¼Œä¸”RIPçš„ç½‘å…³æœªå¿…éœ€è¦æŒ‡å‘DIPï¼›\næ”¯æŒç«¯å£æ˜ å°„ï¼›\nRSçš„OSå¯ä»¥ä½¿ç”¨ä»»æ„ç±»å‹ï¼›\nè¯·æ±‚æŠ¥æ–‡ç»ç”±Directorï¼Œå“åº”æŠ¥æ–‡ä¹Ÿç»ç”±Directorï¼›\nFULL-NATå› ä¸ºè¦ç»è¿‡4æ¬¡NATï¼Œæ‰€ä»¥æ€§èƒ½æ¯”NATè¿˜è¦ä½ï¼›\nç”±äºåšäº†æºåœ°å€è½¬æ¢ï¼ŒRSæ— æ³•è·å–åˆ°å®¢æˆ·ç«¯çš„çœŸå®IPï¼› \n\nå„ä¸ªæ¨¡å¼çš„åŒºåˆ«lvs-natä¸lvs-fullnatï¼šè¯·æ±‚å’Œå“åº”æŠ¥æ–‡éƒ½ç»ç”±Director\n  ã€€ã€€lvs-natï¼šRIPçš„ç½‘å…³è¦æŒ‡å‘DIP\n ã€€ã€€ lvs-fullnatï¼šRIPå’ŒDIPæœªå¿…åœ¨åŒä¸€IPç½‘ç»œï¼Œä½†è¦èƒ½é€šä¿¡\nlvs-drä¸lvs-tunï¼šè¯·æ±‚æŠ¥æ–‡è¦ç»ç”±Directorï¼Œä½†å“åº”æŠ¥æ–‡ç”±RSç›´æ¥å‘å¾€Client\n ã€€ã€€ lvs-drï¼šé€šè¿‡å°è£…æ–°çš„MACé¦–éƒ¨å®ç°ï¼Œé€šè¿‡MACç½‘ç»œè½¬å‘\n ã€€ã€€ lvs-tunï¼šé€šè¿‡åœ¨åŸIPæŠ¥æ–‡å¤–å°è£…æ–°IPå¤´å®ç°è½¬å‘ï¼Œæ”¯æŒè¿œè·ç¦»é€šä¿¡\nä¸‰ã€è°ƒåº¦ç®—æ³•LVSåœ¨å†…æ ¸ä¸­çš„è´Ÿè½½å‡è¡¡è°ƒåº¦æ˜¯ä»¥è¿æ¥ä¸ºç²’åº¦çš„ã€‚åœ¨HTTPåè®®ï¼ˆéæŒä¹…ï¼‰ä¸­ï¼Œæ¯ä¸ªå¯¹è±¡ä»WEBæœåŠ¡å™¨ä¸Šè·å–éƒ½éœ€è¦å»ºç«‹ä¸€ä¸ªTCPè¿æ¥ï¼ŒåŒä¸€ç”¨æˆ· çš„ä¸åŒè¯·æ±‚ä¼šè¢«è°ƒåº¦åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œæ‰€ä»¥è¿™ç§ç»†ç²’åº¦çš„è°ƒåº¦åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥é¿å…å•ä¸ªç”¨æˆ·è®¿é—®çš„çªå‘æ€§å¼•èµ·æœåŠ¡å™¨é—´çš„è´Ÿè½½ä¸å¹³è¡¡ã€‚åœ¨å†…æ ¸ä¸­çš„è¿æ¥è°ƒåº¦ç®—æ³•ä¸Šï¼ŒIPVSå·²å®ç°äº†ä»¥ä¸‹å…«ç§è°ƒåº¦ç®—æ³•ï¼š\n\nè½®å«è°ƒåº¦rrï¼ˆRound-Robin Schedulingï¼‰\nåŠ æƒè½®å«è°ƒåº¦wrrï¼ˆWeighted Round-Robin Schedulingï¼‰\næœ€å°è¿æ¥è°ƒåº¦lcï¼ˆLeast-Connection Schedulingï¼‰\nåŠ æƒæœ€å°è¿æ¥è°ƒåº¦wlcï¼ˆWeighted Least-Connection Schedulingï¼‰\nåŸºäºå±€éƒ¨æ€§çš„æœ€å°‘é“¾æ¥LBLCï¼ˆLocality-Based Least Connections Schedulingï¼‰\nå¸¦å¤åˆ¶çš„åŸºäºå±€éƒ¨æ€§æœ€å°‘é“¾æ¥LBLCRï¼ˆLocality-Based Least Connections with Replication Schedulingï¼‰\nç›®æ ‡åœ°å€æ•£åˆ—è°ƒåº¦DHï¼ˆDestination Hashing Schedulingï¼‰\næºåœ°å€æ•£åˆ—è°ƒåº¦SHï¼ˆSource Hashing Schedulingï¼‰\n\nrrï¼ˆè½®è¯¢ï¼‰ã€€ã€€è½®è¯¢è°ƒåº¦ï¼šè¿™ç§æ˜¯æœ€ç®€å•çš„è°ƒåº¦ç®—æ³•ï¼Œè°ƒåº¦å™¨æŠŠç”¨æˆ·è¯·æ±‚æŒ‰é¡ºåº1:1çš„åˆ†é…åˆ°é›†ç¾¤ä¸­çš„æ¯ä¸ªReal Serverä¸Šï¼Œè¿™ç§ç®—æ³•å¹³ç­‰åœ°å¯¹å¾…æ¯ä¸€å°Real Serverï¼Œè€Œä¸ç®¡æœåŠ¡å™¨çš„å‹åŠ›å’Œè´Ÿè½½çŠ¶å†µã€‚\nwrrï¼ˆæƒé‡, å³åŠ æƒè½®è¯¢ï¼‰   åŠ æƒè½®å«è°ƒåº¦ï¼ˆWeighted Round-Robin Schedulingï¼‰ç®—æ³•å¯ä»¥è§£å†³æœåŠ¡å™¨é—´æ€§èƒ½ä¸ä¸€çš„æƒ…å†µï¼Œå®ƒç”¨ç›¸åº”çš„æƒå€¼è¡¨ç¤ºæœåŠ¡å™¨çš„å¤„ç†æ€§èƒ½ï¼ŒæœåŠ¡å™¨çš„ç¼ºçœæƒå€¼ä¸º1ã€‚å‡è®¾æœåŠ¡å™¨Açš„æƒå€¼ä¸º1ï¼ŒBçš„ æƒå€¼ä¸º2ï¼Œåˆ™è¡¨ç¤ºæœåŠ¡å™¨Bçš„å¤„ç†æ€§èƒ½æ˜¯Açš„ä¸¤å€ã€‚åŠ æƒè½®å«è°ƒåº¦ç®—æ³•æ˜¯æŒ‰æƒå€¼çš„é«˜ä½å’Œè½®å«æ–¹å¼åˆ†é…è¯·æ±‚åˆ°å„æœåŠ¡å™¨ã€‚æƒå€¼é«˜çš„æœåŠ¡å™¨å…ˆæ”¶åˆ°çš„è¿æ¥ï¼Œæƒå€¼é«˜çš„æœ åŠ¡å™¨æ¯”æƒå€¼ä½çš„æœåŠ¡å™¨å¤„ç†æ›´å¤šçš„è¿æ¥ï¼Œç›¸åŒæƒå€¼çš„æœåŠ¡å™¨å¤„ç†ç›¸åŒæ•°ç›®çš„è¿æ¥æ•°\nshï¼ˆæºåœ°å€å“ˆå¸Œï¼‰ã€€ã€€æºåœ°å€æ•£åˆ—ï¼šä¸»è¦æ˜¯å®ç°å°†æ­¤å‰çš„sessionï¼ˆä¼šè¯ï¼‰ç»‘å®šã€‚å°†æ­¤å‰å®¢æˆ·çš„æºåœ°å€ä½œä¸ºæ•£åˆ—é”®ï¼Œä»é™æ€çš„æ•£åˆ—è¡¨ä¸­æ‰¾å‡ºå¯¹åº”çš„æœåŠ¡å™¨ï¼Œåªè¦ç›®æ ‡æœåŠ¡å™¨æ˜¯æ²¡æœ‰è¶…è´Ÿè·çš„å°±å°†è¯·æ±‚å‘é€è¿‡å»ã€‚å°±æ˜¯è¯´æŸå®¢æˆ·è®¿é—®è¿‡A,ç°åœ¨è¿™ä¸ªå®¢æˆ·åˆæ¥äº†ï¼Œæ‰€ä»¥å®¢æˆ·è¯·æ±‚ä¼šè¢«å‘é€åˆ°æœåŠ¡è¿‡ä»–çš„Aä¸»æœºã€‚\ndhï¼ˆç›®çš„åœ°å€å“ˆå¸Œï¼‰ã€€ã€€ç›®æ ‡åœ°å€æ•£åˆ—è°ƒåº¦ï¼ˆDestination Hashing Schedulingï¼‰ç®—æ³•ä¹Ÿæ˜¯é’ˆå¯¹ç›®æ ‡IPåœ°å€çš„è´Ÿè½½å‡è¡¡ï¼Œä½†å®ƒæ˜¯ä¸€ç§é™æ€æ˜ å°„ç®—æ³•ï¼Œé€šè¿‡ä¸€ä¸ªæ•£åˆ—ï¼ˆHashï¼‰å‡½æ•°å°†ä¸€ä¸ªç›®æ ‡IPåœ°å€æ˜ å°„åˆ°ä¸€å°æœåŠ¡å™¨ã€‚\nlcï¼ˆæœ€å°‘é“¾æ¥ï¼‰ã€€ã€€æœ€å°è¿æ¥è°ƒåº¦ï¼ˆLeast-Connection Schedulingï¼‰ç®—æ³•æ˜¯æŠŠæ–°çš„è¿æ¥è¯·æ±‚åˆ†é…åˆ°å½“å‰è¿æ¥æ•°æœ€å°çš„æœåŠ¡å™¨ã€‚æœ€å°è¿æ¥è°ƒåº¦æ˜¯ä¸€ç§åŠ¨æ€è°ƒåº¦ç®—æ³•ï¼Œå®ƒé€šè¿‡æœåŠ¡å™¨å½“å‰æ‰€æ´»è·ƒçš„è¿æ¥æ•°æ¥ä¼°è®¡æœåŠ¡ å™¨çš„è´Ÿè½½æƒ…å†µã€‚è°ƒåº¦å™¨éœ€è¦è®°å½•å„ä¸ªæœåŠ¡å™¨å·²å»ºç«‹è¿æ¥çš„æ•°ç›®ï¼Œå½“ä¸€ä¸ªè¯·æ±‚è¢«è°ƒåº¦åˆ°æŸå°æœåŠ¡å™¨ï¼Œå…¶è¿æ¥æ•°åŠ 1ï¼›å½“è¿æ¥ä¸­æ­¢æˆ–è¶…æ—¶ï¼Œå…¶è¿æ¥æ•°å‡ä¸€ã€‚\nwlcï¼ˆåŠ æƒæœ€å°‘é“¾æ¥ï¼‰LVSçš„ç†æƒ³ç®—æ³•   åŠ æƒæœ€å°è¿æ¥è°ƒåº¦ï¼ˆWeighted Least-Connection Schedulingï¼‰ç®—æ³•æ˜¯æœ€å°è¿æ¥è°ƒåº¦çš„è¶…é›†ï¼Œå„ä¸ªæœåŠ¡å™¨ç”¨ç›¸åº”çš„æƒå€¼è¡¨ç¤ºå…¶å¤„ç†æ€§èƒ½ã€‚æœåŠ¡å™¨çš„ç¼ºçœæƒå€¼ä¸º1ï¼Œç³»ç»Ÿç®¡ç†å‘˜å¯ä»¥åŠ¨æ€åœ°è®¾ç½®æœåŠ¡å™¨çš„æƒ å€¼ã€‚åŠ æƒæœ€å°è¿æ¥è°ƒåº¦åœ¨è°ƒåº¦æ–°è¿æ¥æ—¶å°½å¯èƒ½ä½¿æœåŠ¡å™¨çš„å·²å»ºç«‹è¿æ¥æ•°å’Œå…¶æƒå€¼æˆæ¯”ä¾‹ã€‚ \nLBLCï¼ˆåŸºäºå±€éƒ¨æ€§çš„æœ€å°‘è¿æ¥ï¼‰ã€€ã€€è¿™ä¸ªç®—æ³•ä¸»è¦ç”¨äºCacheé›†ç¾¤ç³»ç»Ÿï¼Œå› ä¸ºCacheé›†ç¾¤çš„ä¸­å®¢æˆ·è¯·æ±‚æŠ¥æ–‡çš„ç›®æ ‡IPåœ°å€çš„å˜åŒ–ï¼Œå°†ç›¸åŒçš„ç›®æ ‡URLåœ°å€è¯·æ±‚è°ƒåº¦åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼Œæ¥æé«˜æœåŠ¡å™¨çš„è®¿é—®çš„å±€éƒ¨æ€§å’ŒCacheå‘½ä¸­ç‡ã€‚ä»è€Œè°ƒæ•´æ•´ä¸ªé›†ç¾¤çš„ç³»ç»Ÿå¤„ç†èƒ½åŠ›ã€‚ä½†æ˜¯ï¼Œå¦‚æœrealserverçš„è´Ÿè½½å¤„äºä¸€åŠè´Ÿè½½ï¼Œå°±ç”¨æœ€å°‘é“¾æ¥ç®—æ³•ï¼Œå°†è¯·æ±‚å‘é€ç»™æ´»åŠ¨é“¾æ¥å°‘çš„ä¸»æœºã€‚ \nLBLCRï¼ˆå¸¦å¤åˆ¶çš„åŸºäºå±€éƒ¨æ€§çš„æœ€å°‘é“¾æ¥ï¼‰ã€€ã€€è¯¥ç®—æ³•é¦–å…ˆæ˜¯åŸºäºæœ€å°‘é“¾æ¥çš„ï¼Œå½“ä¸€ä¸ªæ–°è¯·æ±‚æ”¶åˆ°åï¼Œä¸€å®šä¼šå°†è¯·æ±‚å‘ç»™æœ€å°‘è¿æ¥çš„é‚£å°ä¸»æœºçš„ã€‚ä½†è¿™æ ·åˆç ´åäº†cacheå‘½ä¸­ç‡ã€‚ä½†è¿™ä¸ªç®—æ³•ä¸­ï¼Œé›†ç¾¤æœåŠ¡æ˜¯cacheå…±äº«çš„ï¼Œå‡è®¾Açš„PHPè·‘äº†ä¸€éï¼Œå¾—åˆ°ç¼“å­˜ã€‚ä½†å…¶ä»–realserverå¯ä»¥å»Aé‚£é‡Œæ‹¿ç¼“å­˜ï¼Œè¿™æ˜¯ç§ç¼“å­˜å¤åˆ¶æœºåˆ¶ã€‚\nå››ã€ç®¡ç†å·¥å…·ipvsadmä½¿ç”¨ã€€ã€€ ipvsadmæ˜¯LVSçš„ç®¡ç†å·¥å…·ï¼Œipvsadmå·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œç”¨æˆ·é€šè¿‡ipvsadmå‘½ä»¤ç¼–å†™è´Ÿè½½å‡è¡¡è§„åˆ™ã€‚\nå®‰è£…yum install ipvsadm -y ###æ–‡ä»¶è¯´æ˜Unit æ–‡ä»¶: ipvsadm.serviceä¸»ç¨‹åºï¼š/usr/sbin/ipvsadmè§„åˆ™ä¿å­˜å·¥å…·ï¼š/usr/sbin/ipvsadm-saveè§„åˆ™é‡è½½å·¥å…·ï¼š/usr/sbin/ipvsadm-restoreé…ç½®æ–‡ä»¶ï¼š/etc/sysconfig/ipvsadm-config\n\nç”¨æ³•ä»¥åŠå‚æ•°ipvsadm --help #æŸ¥çœ‹ä½¿ç”¨æ–¹æ³•åŠå‚æ•°å‘½ä»¤ï¼š-A, --add-serviceï¼š #æ·»åŠ ä¸€ä¸ªé›†ç¾¤æœåŠ¡. å³ä¸ºipvsè™šæ‹ŸæœåŠ¡å™¨æ·»åŠ ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ ä¸€ä¸ªéœ€è¦è¢«è´Ÿè½½å‡è¡¡çš„è™šæ‹Ÿåœ°å€ã€‚è™šæ‹Ÿåœ°å€éœ€è¦æ˜¯ipåœ°å€ï¼Œç«¯å£å·ï¼Œåè®®çš„å½¢å¼ã€‚-E, --edit-serviceï¼š #ä¿®æ”¹ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ã€‚-D, --delete-serviceï¼š #åˆ é™¤ä¸€ä¸ªè™šæ‹ŸæœåŠ¡ã€‚å³åˆ é™¤æŒ‡å®šçš„é›†ç¾¤æœåŠ¡;-C, --clearï¼š #æ¸…é™¤æ‰€æœ‰è™šæ‹ŸæœåŠ¡ã€‚-R, --restoreï¼š #ä»æ ‡å‡†è¾“å…¥è·å–ipvsadmå‘½ä»¤ã€‚ä¸€èˆ¬ç»“åˆä¸‹è¾¹çš„-Sä½¿ç”¨ã€‚-S, --saveï¼š #ä»æ ‡å‡†è¾“å‡ºè¾“å‡ºè™šæ‹ŸæœåŠ¡å™¨çš„è§„åˆ™ã€‚å¯ä»¥å°†è™šæ‹ŸæœåŠ¡å™¨çš„è§„åˆ™ä¿å­˜ï¼Œåœ¨ä»¥åé€šè¿‡-Rç›´æ¥è¯»å…¥ï¼Œä»¥å®ç°è‡ªåŠ¨åŒ–é…ç½®ã€‚-a, --add-serverï¼š #ä¸ºè™šæ‹ŸæœåŠ¡æ·»åŠ ä¸€ä¸ªreal serverï¼ˆRSï¼‰-e, --edit-serverï¼š #ä¿®æ”¹RS-d, --delete-serverï¼š #åˆ é™¤-L, -l, --listï¼š #åˆ—å‡ºè™šæ‹ŸæœåŠ¡è¡¨ä¸­çš„æ‰€æœ‰è™šæ‹ŸæœåŠ¡ã€‚å¯ä»¥æŒ‡å®šåœ°å€ã€‚æ·»åŠ -cæ˜¾ç¤ºè¿æ¥è¡¨ã€‚-Z, --zeroï¼š #å°†æ‰€æœ‰æ•°æ®ç›¸å…³çš„è®°å½•æ¸…é›¶ã€‚è¿™äº›è®°å½•ä¸€èˆ¬ç”¨äºè°ƒåº¦ç­–ç•¥ã€‚--set tcp tcpfin udpï¼š #ä¿®æ”¹åè®®çš„è¶…æ—¶æ—¶é—´ã€‚--start-daemon stateï¼š #è®¾ç½®è™šæ‹ŸæœåŠ¡å™¨çš„å¤‡æœåŠ¡å™¨ï¼Œç”¨æ¥å®ç°ä¸»å¤‡æœåŠ¡å™¨å†—ä½™ã€‚ï¼ˆæ³¨ï¼šè¯¥åŠŸèƒ½åªæ”¯æŒipv4ï¼‰--stop-daemonï¼š #åœæ­¢å¤‡æœåŠ¡å™¨ã€‚ å‚æ•°ï¼šä»¥ä¸‹å‚æ•°å¯ä»¥æ¥åœ¨ä¸Šè¾¹çš„å‘½ä»¤åè¾¹ã€‚-t, --tcp-service service-addressï¼š #æŒ‡å®šè™šæ‹ŸæœåŠ¡ä¸ºtcpæœåŠ¡ã€‚service-addressè¦æ˜¯host[:port]çš„å½¢å¼ã€‚ç«¯å£æ˜¯0è¡¨ç¤ºä»»æ„ç«¯å£ã€‚å¦‚æœéœ€è¦å°†ç«¯å£è®¾ç½®ä¸º0ï¼Œè¿˜éœ€è¦åŠ ä¸Š-pé€‰é¡¹ï¼ˆæŒä¹…è¿æ¥ï¼‰ã€‚-u, --udp-service service-addressï¼š #ä½¿ç”¨udpæœåŠ¡ï¼Œå…¶ä»–åŒä¸Šã€‚-f, --fwmark-service integerï¼š #ç”¨firewall markå–ä»£è™šæ‹Ÿåœ°å€æ¥æŒ‡å®šè¦è¢«è´Ÿè½½å‡è¡¡çš„æ•°æ®åŒ…ï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªå‘½ä»¤å®ç°æŠŠä¸åŒåœ°å€ã€ç«¯å£çš„è™šæ‹Ÿåœ°å€æ•´åˆæˆä¸€ä¸ªè™šæ‹ŸæœåŠ¡ï¼Œå¯ä»¥è®©è™šæ‹ŸæœåŠ¡å™¨åŒæ—¶æˆªè·å¤„ç†å»å¾€å¤šä¸ªä¸åŒåœ°å€çš„æ•°æ®åŒ…ã€‚fwmarkå¯ä»¥é€šè¿‡iptableså‘½ä»¤æŒ‡å®šã€‚å¦‚æœç”¨åœ¨ipv6éœ€è¦åŠ ä¸Š-6ã€‚-s, --scheduler scheduling-methodï¼š #æŒ‡å®šè°ƒåº¦ç®—æ³•,é»˜è®¤æ˜¯wlcã€‚è°ƒåº¦ç®—æ³•å¯ä»¥æŒ‡å®šä»¥ä¸‹8ç§ï¼šrrï¼ˆè½®è¯¢ï¼‰ï¼Œwrrï¼ˆæƒé‡ï¼‰ï¼Œlcï¼ˆæœ€åè¿æ¥ï¼‰ï¼Œwlcï¼ˆæƒé‡ï¼‰ï¼Œlblcï¼ˆæœ¬åœ°æœ€åè¿æ¥ï¼‰ï¼Œlblcrï¼ˆå¸¦å¤åˆ¶çš„æœ¬åœ°æœ€åè¿æ¥ï¼‰ï¼Œdhï¼ˆç›®çš„åœ°å€å“ˆå¸Œï¼‰ï¼Œshï¼ˆæºåœ°å€å“ˆå¸Œï¼‰ï¼Œsedï¼ˆæœ€å°æœŸæœ›å»¶è¿Ÿï¼‰ï¼Œnqï¼ˆæ°¸ä¸æ’é˜Ÿï¼‰-p, --persistent [timeout]ï¼š #è®¾ç½®æŒä¹…è¿æ¥ï¼Œè¿™ä¸ªæ¨¡å¼å¯ä»¥ä½¿æ¥è‡ªå®¢æˆ·çš„å¤šä¸ªè¯·æ±‚è¢«é€åˆ°åŒä¸€ä¸ªçœŸå®æœåŠ¡å™¨ï¼Œé€šå¸¸ç”¨äºftpæˆ–è€…sslä¸­ã€‚-M, --netmask netmaskï¼š #æŒ‡å®šå®¢æˆ·åœ°å€çš„å­ç½‘æ©ç ã€‚ç”¨äºå°†åŒå±ä¸€ä¸ªå­ç½‘çš„å®¢æˆ·çš„è¯·æ±‚è½¬å‘åˆ°ç›¸åŒæœåŠ¡å™¨ã€‚-r, --real-server server-addressï¼š #ä¸ºè™šæ‹ŸæœåŠ¡æŒ‡å®šæ•°æ®å¯ä»¥è½¬å‘åˆ°çš„çœŸå®æœåŠ¡å™¨çš„åœ°å€ã€‚å¯ä»¥æ·»åŠ ç«¯å£å·ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šç«¯å£å·ï¼Œåˆ™ç­‰æ•ˆäºä½¿ç”¨è™šæ‹Ÿåœ°å€çš„ç«¯å£å·ã€‚[packet-forwarding-method]ï¼š #æ­¤é€‰é¡¹æŒ‡å®šæŸä¸ªçœŸå®æœåŠ¡å™¨æ‰€ä½¿ç”¨çš„æ•°æ®è½¬å‘æ¨¡å¼ã€‚éœ€è¦å¯¹æ¯ä¸ªçœŸå®æœåŠ¡å™¨åˆ†åˆ«æŒ‡å®šæ¨¡å¼ã€‚-g, --gatewayingï¼š #ä½¿ç”¨ç½‘å…³ï¼ˆå³ç›´æ¥è·¯ç”±ï¼‰ï¼Œæ­¤æ¨¡å¼æ˜¯é»˜è®¤æ¨¡å¼ã€‚-i, --ipipï¼š #ä½¿ç”¨ipipéš§é“æ¨¡å¼ã€‚-m, --masqueradingï¼š #ä½¿ç”¨NATæ¨¡å¼ã€‚-w, --weight weight:  #è®¾ç½®æƒé‡ã€‚æƒé‡æ˜¯0~65535çš„æ•´æ•°ã€‚å¦‚æœå°†æŸä¸ªçœŸå®æœåŠ¡å™¨çš„æƒé‡è®¾ç½®ä¸º0ï¼Œé‚£ä¹ˆå®ƒä¸ä¼šæ”¶åˆ°æ–°çš„è¿æ¥ï¼Œä½†æ˜¯å·²æœ‰è¿æ¥è¿˜ä¼šç»§ç»­ç»´æŒï¼ˆè¿™ç‚¹å’Œç›´æ¥æŠŠæŸä¸ªçœŸå®æœåŠ¡å™¨åˆ é™¤æ—¶ä¸åŒçš„ï¼‰ã€‚-x, --u-threshold uthresholdï¼š #è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨å¯ä»¥ç»´æŒçš„è¿æ¥ä¸Šé™ã€‚0~65535ã€‚è®¾ç½®ä¸º0è¡¨ç¤ºæ²¡æœ‰ä¸Šé™ã€‚-y, --l-threshold lthresholdï¼š #è®¾ç½®ä¸€ä¸ªæœåŠ¡å™¨çš„è¿æ¥ä¸‹é™ã€‚å½“æœåŠ¡å™¨çš„è¿æ¥æ•°ä½äºæ­¤å€¼çš„æ—¶å€™æœåŠ¡å™¨æ‰å¯ä»¥é‡æ–°æ¥æ”¶è¿æ¥ã€‚å¦‚æœæ­¤å€¼æœªè®¾ç½®ï¼Œåˆ™å½“æœåŠ¡å™¨çš„è¿æ¥æ•°è¿ç»­ä¸‰æ¬¡ä½äºuthresholdæ—¶æœåŠ¡å™¨æ‰å¯ä»¥æ¥æ”¶åˆ°æ–°çš„è¿æ¥ã€‚--mcast-interface interfaceï¼š #æŒ‡å®šä½¿ç”¨å¤‡æœåŠ¡å™¨æ—¶å€™çš„å¹¿æ’­æ¥å£ã€‚--syncid syncidï¼š#æŒ‡å®šsyncidï¼Œ åŒæ ·ç”¨äºä¸»å¤‡æœåŠ¡å™¨çš„åŒæ­¥ã€‚ #ä»¥ä¸‹é€‰é¡¹ç”¨äºlist(-l)å‘½ä»¤ï¼š-c, --connectionï¼š #åˆ—å‡ºå½“å‰çš„IPVSè¿æ¥ã€‚--timeoutï¼š #åˆ—å‡ºè¶…æ—¶--statsï¼š #çŠ¶æ€ä¿¡æ¯--rateï¼š #ä¼ è¾“é€Ÿç‡--thresholdsï¼š #åˆ—å‡ºé˜ˆå€¼--persistent-connï¼š #æŒä¹…è¿æ¥--sorï¼š #æŠŠåˆ—è¡¨æ’åº--nosortï¼š #ä¸æ’åº-n, --numericï¼š #ä¸å¯¹ipåœ°å€è¿›è¡ŒdnsæŸ¥è¯¢--exactï¼š #å•ä½-6ï¼š å¦‚#æœfwmarkç”¨çš„æ˜¯ipv6åœ°å€éœ€è¦æŒ‡å®šæ­¤é€‰é¡¹ã€‚         #å¦‚æœä½¿ç”¨IPv6åœ°å€ï¼Œéœ€è¦åœ¨åœ°å€ä¸¤ç«¯åŠ ä¸Š&quot;[]&quot;ã€‚ä¾‹å¦‚ï¼šipvsadm -A -t [2001:db8::80]:80 -s rr\n\nLVSé›†ç¾¤ç®¡ç†ç¤ºä¾‹####ç®¡ç†LVSé›†ç¾¤ä¸­çš„RealServerä¸¾ä¾‹1) æ·»åŠ RS : -a# ipvsadm -a -t|u|f service-address -r server-address [-g|i|m] [-w weight]  #ä¸¾ä¾‹1: å¾€VIPèµ„æºä¸º10.1.210.58çš„é›†ç¾¤æœåŠ¡é‡Œæ·»åŠ 1ä¸ªrealserveripvsadm -a -t 10.1.210.58 -r 10.1.210.52 â€“g -w 5  2) ä¿®æ”¹RS : -e# ipvsadm -e -t|u|f service-address -r server-address [-g|i|m] [-w weight]  #ä¸¾ä¾‹2: ä¿®æ”¹10.1.210.58é›†ç¾¤æœåŠ¡é‡Œ10.1.210.52è¿™ä¸ªrealserverçš„æƒé‡ä¸º3ipvsadm -e -t 10.1.210.58:80 -r 10.1.210.52 â€“g -w 3  3) åˆ é™¤RS : -d# ipvsadm -d -t|u|f service-address -r server-address  #ä¸¾ä¾‹3: åˆ é™¤10.1.210.58é›†ç¾¤æœåŠ¡é‡Œ10.1.210.52è¿™ä¸ªrealserveripvsadm -d -t 10.1.210.58:80 -r 10.1.210.524) æ¸…é™¤è§„åˆ™ (åˆ é™¤æ‰€æœ‰é›†ç¾¤æœåŠ¡), è¯¥å‘½ä»¤ä¸iptablesçš„-FåŠŸèƒ½ç±»ä¼¼ï¼Œæ‰§è¡Œåä¼šæ¸…é™¤æ‰€æœ‰è§„åˆ™:# ipvsadm -C  5) ä¿å­˜åŠè¯»å–è§„åˆ™ï¼š# ipvsadm -S &gt; /path/to/somefile# ipvsadm-save &gt; /path/to/somefile# ipvsadm-restore &lt; /path/to/somefile####ç®¡ç†LVSé›†ç¾¤æœåŠ¡çš„æŸ¥çœ‹# ipvsadm -L|l [options]   optionså¯ä»¥ä¸ºï¼š   -nï¼šæ•°å­—æ ¼å¼æ˜¾ç¤º   --stats ç»Ÿè®¡ä¿¡æ¯   --rateï¼šç»Ÿè®¡é€Ÿç‡   --timeoutï¼šæ˜¾ç¤ºtcpã€tcpinfoã€udpçš„ä¼šè¯è¶…æ—¶æ—¶é•¿   -cï¼šè¿æ¥å®¢æˆ·ç«¯æ•°é‡  #æŸ¥çœ‹lvsé›†ç¾¤è½¬å‘æƒ…å†µ# ipvsadm -Ln  #æŸ¥çœ‹lvsé›†ç¾¤çš„è¿æ¥çŠ¶æ€# ipvsadm -l --stats  è¯´æ˜ï¼šConns    (connections scheduled)  å·²ç»è½¬å‘è¿‡çš„è¿æ¥æ•°InPkts   (incoming packets)       å…¥åŒ…ä¸ªæ•°OutPkts  (outgoing packets)       å‡ºåŒ…ä¸ªæ•°InBytes  (incoming bytes)         å…¥æµé‡ï¼ˆå­—èŠ‚ï¼‰OutBytes (outgoing bytes)         å‡ºæµé‡ï¼ˆå­—èŠ‚ï¼‰  #æŸ¥çœ‹lvsé›†ç¾¤çš„é€Ÿç‡ipvsadm -l --rate  è¯´æ˜ï¼šCPS      (current connection rate)   æ¯ç§’è¿æ¥æ•°InPPS    (current in packet rate)    æ¯ç§’çš„å…¥åŒ…ä¸ªæ•°OutPPS   (current out packet rate)   æ¯ç§’çš„å‡ºåŒ…ä¸ªæ•°InBPS    (current in byte rate)      æ¯ç§’å…¥æµé‡ï¼ˆå­—èŠ‚ï¼‰OutBPS   (current out byte rate)      æ¯ç§’å…¥æµé‡ï¼ˆå­—èŠ‚ï¼‰\n\näº”ã€æ¡ˆä¾‹ç¯‡ç¯å¢ƒæœåŠ¡å™¨ç³»ç»Ÿï¼šcentos7.4\nè°ƒåº¦æœåŠ¡å™¨DSï¼š10.1.210.51\nä¸¤å°çœŸå®æœåŠ¡RSï¼š10.1.210.52ã€10.1.210.53\nVIP:10.1.210.58 \nLVS-DRæ¨¡å¼æ¡ˆä¾‹ã€€ã€€ centos7é»˜è®¤å·²ç»å°†ipvsç¼–è¯‘è¿›å†…æ ¸æ¨¡å—ï¼Œåç§°ä¸ºip_vs,ä½¿ç”¨æ—¶å€™éœ€è¦å…ˆåŠ è½½è¯¥å†…æ ¸æ¨¡å—ã€‚\nä»¥ä¸‹æ­¥éª¤éœ€è¦åœ¨DSä¸Šè¿›è¡Œï¼š\n1.åŠ è½½ip_vsæ¨¡å—\nmodprobe ip_vs #åŠ è½½ip_vsæ¨¡å—cat /proc/net/ip_vs #æŸ¥çœ‹æ˜¯å¦åŠ è½½æˆåŠŸlsmod | grep ip_vs   #æŸ¥çœ‹åŠ è½½çš„æ¨¡å—yum install ipvsadm # å®‰è£…ç®¡ç†å·¥å…·\n\n2.é…ç½®è°ƒåº¦è„šæœ¬dr.sh\n#!/bin/bashVIP=10.1.210.58  #è™šæ‹ŸIPRIP1=10.1.210.52 #çœŸå®æœåŠ¡å™¨IP1RIP2=10.1.210.53 #çœŸå®æœåŠ¡å™¨IP2PORT=80 #ç«¯å£ifconfig ens192:1 $VIP broadcast $VIP netmask 255.255.255.255 up #æ·»åŠ VIP,æ³¨æ„ç½‘å¡åç§°echo 1 &gt; /proc/sys/net/ipv4/ip_forward    #å¼€å¯è½¬å‘ route add -host $VIP dev ens192:1    #æ·»åŠ VIPè·¯ç”±/sbin/ipvsadm -C      #æ¸…ç©ºipvsä¸­çš„è§„åˆ™/sbin/ipvsadm -A -t $VIP:80 -s wrr  #æ·»åŠ è°ƒåº¦å™¨/sbin/ipvsadm -a -t $VIP:80 -r $RIP1 -g -w 1 #æ·»åŠ RS/sbin/ipvsadm -a -t $VIP:80 -r $RIP2 -g -w 1 #æ·»åŠ RS/sbin/ipvsadm -ln  #æŸ¥çœ‹è§„åˆ™\n\n3.æ‰§è¡Œè„šæœ¬\n[root@app51 ~]# sh dr.shIP Virtual Server version 1.2.1 (size=4096)Prot LocalAddress:Port Scheduler Flags  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConnTCP  10.1.210.58:80 wrr  -&gt; 10.1.210.52:80               Route   1      0          0           -&gt; 10.1.210.53:80               Route   1      0          0 \n\nä»¥ä¸‹æ­¥éª¤éœ€è¦åœ¨RSä¸Šæ‰§è¡Œï¼š\n1.çœŸå®æœåŠ¡RSé…ç½®è„šæœ¬rs.sh\n#!/bin/bashVIP=10.1.210.58  #RSä¸ŠVIPåœ°å€#å…³é—­å†…æ ¸arpå“åº”ï¼Œæ°¸ä¹…ä¿®æ”¹é…ç½®å‚æ•°åˆ°/etc/sysctl.confï¼Œç›®çš„æ˜¯ä¸ºäº†è®©rsé¡ºåˆ©å‘é€macåœ°å€ç»™å®¢æˆ·ç«¯ echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore      echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/lo/arp_announce echo &quot;1&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_ignore echo &quot;2&quot; &gt;/proc/sys/net/ipv4/conf/all/arp_announceifconfig lo:0 $VIP broadcast $VIP netmask 255.255.255.255 up  #ç»‘å®šVIPåˆ°RSæœåŠ¡å™¨ä¸Š/sbin/route add -host $VIP dev lo:0  #æ·»åŠ VIPè·¯ç”±\n\n2.æ‰§è¡Œè„šæœ¬\nsh rs.sh\n3.é…ç½®æµ‹è¯•webæœåŠ¡ï¼ˆä»¥ä¸€å°ä¸ºç¤ºä¾‹ï¼‰\nsystemctl stop firewalld  #å…³é—­é˜²ç«å¢™systemctl disable firewalld #ç¦æ­¢å¼€æœºå¯åŠ¨yum install httpd #å®‰è£…httpd###RS1è™šæ‹Ÿä¸»æœºé…ç½®vi /etc/httpd/conf/httpd.confServerName 10.1.210.52:80echo &quot;RS 10.1.210.52&quot; &gt; /var/www/html/index.html###RS2è™šæ‹Ÿä¸»æœºé…ç½®vi /etc/httpd/conf/httpd.confServerName 10.1.210.53:80echo &quot;RS 10.1.210.53&quot; &gt; /var/www/html/index.html#å¯åŠ¨httpdæœåŠ¡systemctl start httpd\n\næµ‹è¯•\nè°ƒåº¦ç®—æ³•æ˜¯è½®è®­ï¼Œæ‰€ä»¥ç»“æœæ˜¯äº¤æ›¿å‡ºç° ã€‚\n[root@node1 ~]# for i in &#123;1..10&#125; ;do curl http://10.1.210.58 ;doneRS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52\n\nLVS-NATæ¡ˆä¾‹ã€€ã€€LVS-NATæ¨¡å¼å’ŒDRåŒºåˆ«è¦åšnatï¼Œå¹¶ä¸”è¯·æ±‚å’Œå“åº”éƒ½è¦ç»è¿‡DSï¼Œæ‰€æœ‰éœ€è¦å°†RSç½‘å…³æŒ‡å‘DS,ç”±äºä¹‹å‰æµ‹è¯•è¿‡DRæ¨¡å¼ï¼Œåœ¨æµ‹è¯•NATæ¨¡å¼æ—¶å€™éœ€è¦å°†RSç¯å¢ƒæ¢å¤ï¼ŒRSæ¢å¤æ­¥éª¤å¦‚ä¸‹ï¼š\necho 0 &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore     echo 0 &gt;/proc/sys/net/ipv4/conf/lo/arp_announceecho 0 &gt;/proc/sys/net/ipv4/conf/all/arp_ignoreecho 0 &gt;/proc/sys/net/ipv4/conf/all/arp_announceifconfig lo:0 down\n\nè°ƒåº¦æœåŠ¡DSé…ç½®\n#!/bin/bashVIP=10.1.210.58  #è™šæ‹ŸIPRIP1=10.1.210.52 #çœŸå®æœåŠ¡å™¨IP1RIP2=10.1.210.53 #çœŸå®æœåŠ¡å™¨IP2PORT=80 #ç«¯å£ifconfig ens192:1 $VIP broadcast $VIP netmask 255.255.255.255 up #æ·»åŠ VIPecho 1 &gt; /proc/sys/net/ipv4/ip_forward    #å¼€å¯è½¬å‘ route add -host $VIP dev ens192:1    #æ·»åŠ VIPè·¯ç”±/sbin/ipvsadm -C      #æ¸…ç©ºipvsä¸­çš„è§„åˆ™/sbin/ipvsadm -A -t $VIP:80 -s wlc  #æ·»åŠ è°ƒåº¦å™¨/sbin/ipvsadm -a -t $VIP:80 -r $RIP1 -m -w 1 #æ·»åŠ RS/sbin/ipvsadm -a -t $VIP:80 -r $RIP2 -m -w 1 #æ·»åŠ RS/sbin/ipvsadm -ln  #æŸ¥çœ‹è§„åˆ™\n\nRSé…ç½®\nã€€ã€€natæ¨¡å¼RSé…ç½®å¾ˆç®€å•ï¼Œåªéœ€è¦å°†RSè·¯ç”±æŒ‡å‘DS\nvi /etc/sysconfig/network-scripts/ifcfg-ens192 GATEWAY=10.1.210.58 #ä¿®æ”¹ç½‘å…³è‡³RSåœ°å€systemctl restart network #é‡å¯ç½‘ç»œ\n\næµ‹è¯•\nã€€ã€€ ç”±äºè¿™é‡Œçš„ç¯å¢ƒDSå’ŒRSåœ¨åŒä¸€ä¸ªç½‘æ®µä¸‹ï¼ŒNATæ¨¡å¼ä¸‹å¦‚æœå®¢æˆ·ç«¯æ˜¯åŒç½‘æ®µæƒ…å†µä¸‹ï¼ŒRSå“åº”çš„æ—¶å€™ç›´æ¥å“åº”ç»™åŒç½‘æ®µçš„æœåŠ¡å™¨äº†å¹¶ä¸ç»è¿‡DSï¼Œè¿™æ ·å°±å¯¼è‡´å®¢æˆ·ç«¯ä¼šä¸¢å¼ƒè¯¥è¯·æ±‚ã€‚å¦‚æœæƒ³è¦åŒç½‘æ®µçš„æƒ³è¦è®¿é—®åˆ°DSåˆ™éœ€è¦æ·»åŠ è·¯ç”±ï¼Œè¿™é‡Œéœ€è¦RSåœ¨å“åº”åŒç½‘æ®µæœåŠ¡å™¨æ—¶å€™ç½‘å…³æŒ‡å‘DSï¼Œè¿™æ ·åŒç½‘æ®µå°±èƒ½è®¿é—®åˆ°DSäº†ï¼Œç¤ºä¾‹ï¼š\nroute add -net 10.1.210.0/24 gw 10.1.210.58\n\næµ‹è¯•ç»“æœï¼š\n[root@app36 ~]# for i in &#123;1..10&#125; ; do curl http://10.1.210.58 ;doneRS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52RS 10.1.210.53RS 10.1.210.52\n\nå…­ã€æŒä¹…è¿æ¥ä»€ä¹ˆæ˜¯æŒä¹…è¿æ¥ã€€ã€€åœ¨LVSä¸­ï¼ŒæŒä¹…è¿æ¥æ˜¯ä¸ºäº†ç”¨æ¥ä¿è¯å½“æ¥è‡ªåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚æ—¶èƒ½å¤Ÿå®šä½åˆ°åŒä¸€å°æœåŠ¡å™¨ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¼šè¯ä¿æŒï¼Œè€Œé€šå¸¸ä½¿ç”¨çš„ä¼šè¯ä¿æŒæŠ€æœ¯æ‰‹æ®µå°±æ˜¯cookieä¸sessionã€‚\ncookieä¸sessionç®€è¿°ã€€ã€€ åœ¨WebæœåŠ¡é€šä¿¡ä¸­ï¼ŒHTTPæœ¬èº«æ˜¯æ— çŠ¶æ€åè®®ï¼Œä¸èƒ½æ ‡è¯†ç”¨æˆ·æ¥æºï¼Œå½“ç”¨æˆ·åœ¨è®¿é—®Aç½‘é¡µï¼Œå†ä»Aç½‘é¡µè®¿é—®å…¶ä»–èµ„æºè·³è½¬åˆ°äº†Bç½‘é¡µï¼Œè¿™å¯¹äºæœåŠ¡å™¨æ¥è¯´åˆæ˜¯ä¸€ä¸ªæ–°çš„è¯·æ±‚ï¼Œä¹‹å‰çš„ç™»é™†ä¿¡æ¯éƒ½æ²¡æœ‰äº†ï¼Œæ€ä¹ˆåŠï¼Ÿä¸ºäº†è®°å½•ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œå¼€å‘è€…åœ¨æµè§ˆå™¨å’ŒæœåŠ¡å™¨ä¹‹é—´æä¾›äº†cookieå’ŒsessionæŠ€æœ¯ï¼Œç®€å•è¯´æ¥åœ¨ä½ æµè§ˆç½‘é¡µæ—¶å€™ï¼ŒæœåŠ¡å™¨å»ºç«‹sessionç”¨äºä¿å­˜ä½ çš„èº«ä»½ä¿¡æ¯ï¼Œå¹¶å°†ä¸ä¹‹å¯¹åº”çš„cookieä¿¡æ¯å‘é€ç»™æµè§ˆå™¨ï¼Œæµè§ˆå™¨ä¿å­˜cookieï¼Œå½“ä½ å†æ¬¡æµè§ˆè¯¥ç½‘é¡µæ—¶å€™ï¼ŒæœåŠ¡å™¨æ£€æŸ¥ä½ çš„æµè§ˆå™¨ä¸­çš„cookieå¹¶è·å–ä¸ä¹‹å¯¹åº”çš„sessionæ•°æ®ï¼Œè¿™æ ·ä¸€æ¥ä½ ä¸Šæ¬¡æµè§ˆç½‘é¡µçš„æ•°æ®ä¾ç„¶å­˜åœ¨ã€‚\n4å±‚å‡è¡¡è´Ÿè½½å¯¼è‡´çš„é—®é¢˜ã€€ã€€ç”±äºcookieå’ŒsessionæŠ€æœ¯æ˜¯åŸºäºåº”ç”¨å±‚ï¼ˆä¸ƒå±‚ï¼‰,è€ŒLVSå·¥ä½œåœ¨4å±‚ï¼Œåªèƒ½æ ¹æ®IPåœ°å€å’Œç«¯å£è¿›è¡Œè½¬å‘ï¼Œä¸èƒ½æ ¹æ®åº”ç”¨å±‚ä¿¡æ¯è¿›è¡Œè½¬å‘ï¼Œæ‰€ä»¥å°±å­˜åœ¨äº†é—®é¢˜ã€‚æ¯”å¦‚LVSé›†ç¾¤RSæ˜¯ä¸‰å°ï¼ŒAç”¨æˆ·ç™»é™†åè¯·æ±‚åœ¨ç”±ç¬¬ä¸€å°å¤„ç†ï¼Œè€ŒAç”¨æˆ·è·³è½¬åˆ°äº†å¦ä¸€ä¸ªé¡µé¢è¯·æ±‚ç»è¿‡DSè½¬å‘åˆ°ç¬¬äºŒå°æœåŠ¡å™¨ï¼Œä½†æ˜¯æ­¤æ—¶è¿™å°æœåŠ¡å™¨ä¸Šå¹¶æ²¡æœ‰sessionï¼Œç”¨æˆ·çš„ä¿¡æ¯å°±æ²¡æœ‰äº†ï¼Œæ˜¾ç„¶è¿™æ˜¯ä¸èƒ½æ¥å—çš„ã€‚ä¸ºäº†é¿å…ä¸Šè¿°çš„é—®é¢˜ï¼Œä¸€èˆ¬çš„è§£å†³æ–¹æ¡ˆæœ‰ä¸‰ç§ï¼š\n\nå°†æ¥è‡ªäºåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å‘å¾€åŒä¸€ä¸ªæœåŠ¡å™¨(ä¾‹å¦‚nginxçš„ip_hashç®—æ³•)ï¼›\nå°†sessionä¿¡æ¯åœ¨æœåŠ¡å™¨é›†ç¾¤å†…å…±äº«ï¼Œæ¯ä¸ªæœåŠ¡å™¨éƒ½ä¿å­˜æ•´ä¸ªé›†ç¾¤çš„sessionä¿¡æ¯ï¼›\nå»ºç«‹ä¸€ä¸ªsessionå­˜ï¼Œæ‰€æœ‰sessionä¿¡æ¯éƒ½ä¿å­˜åˆ°å­˜å‚¨æ± ä¸­ ï¼›\n\nLVSä¼šè¯ä¿æŒå®ç°æ–¹å¼å°±æ˜¯é€šè¿‡å°†æ¥è‡ªäºåŒä¸€ä¸ªç”¨æˆ·çš„è¯·æ±‚å‘å¾€åŒä¸€ä¸ªæœåŠ¡å™¨ï¼Œå…·ä½“å®ç°åˆ†ä¸ºshç®—æ³•å’ŒæŒä¹…è¿æ¥ï¼š\nshç®—æ³•ï¼šä½¿ç”¨SHç®—æ³•ï¼ŒSHç®—æ³•åœ¨å†…æ ¸ä¸­ä¼šè‡ªåŠ¨ç»´æŠ¤ä¸€ä¸ªå“ˆå¸Œè¡¨ï¼Œæ­¤å“ˆå¸Œè¡¨ä¸­ç”¨æ¯ä¸€ä¸ªè¯·æ±‚çš„æºIPåœ°å€ç»è¿‡å“ˆå¸Œè®¡ç®—å¾—å‡ºçš„å€¼ä½œä¸ºé”®ï¼ŒæŠŠè¯·æ±‚æ‰€åˆ°è¾¾çš„RSçš„åœ°å€ä½œä¸ºå€¼ã€‚åœ¨åé¢çš„è¯·æ±‚ä¸­ï¼Œæ¯ä¸€ä¸ªè¯·æ±‚ä¼šå…ˆç»è¿‡æ­¤å“ˆå¸Œè¡¨ï¼Œå¦‚æœè¯·æ±‚åœ¨æ­¤å“ˆå¸Œè¡¨ä¸­æœ‰é”®å€¼ï¼Œé‚£ä¹ˆç›´æ¥å®šå‘è‡³ç‰¹å®šRSï¼Œå¦‚æ²¡æœ‰ï¼Œåˆ™ä¼šæ–°ç”Ÿæˆä¸€ä¸ªé”®å€¼ï¼Œä»¥ä¾¿åç»­è¯·æ±‚çš„å®šå‘ã€‚ä½†æ˜¯æ­¤ç§æ–¹æ³•åœ¨æ—¶é—´çš„è®°å½•ä¸Šæ¯”è¾ƒæ¨¡ç³Šï¼ˆä¾æ®TCPçš„è¿æ¥æ—¶é•¿è®¡ç®—ï¼‰ï¼Œè€Œä¸”å…¶æ˜¯ç®—æ³•æœ¬èº«ï¼Œæ‰€ä»¥æ— æ³•ä¸ç®—æ³•åˆ†ç¦»ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«ç†æƒ³çš„æ–¹æ³•ã€‚\n æŒä¹…è¿æ¥ï¼šæ­¤ç§æ–¹æ³•å®ç°äº†æ— è®ºä½¿ç”¨å“ªä¸€ç§è°ƒåº¦æ–¹æ³•ï¼ŒæŒä¹…è¿æ¥åŠŸèƒ½éƒ½èƒ½ä¿è¯åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´ä¹‹å†…ï¼Œæ¥è‡ªäºåŒä¸€ä¸ªIPçš„è¯·æ±‚å°†å§‹ç»ˆè¢«å®šå‘è‡³åŒä¸€ä¸ªRSï¼Œè¿˜å¯ä»¥æŠŠå¤šç§æœåŠ¡ç»‘å®šåç»Ÿä¸€è¿›è¡Œè°ƒåº¦ã€‚ \nã€€ã€€è¯¦ç»†ä¸€ç‚¹è¯´æ¥ï¼šå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾directoræ—¶ã€‚æ— è®ºä½¿ç”¨ä»€ä¹ˆè°ƒåº¦æ–¹æ³•ï¼Œéƒ½å¯ä»¥å®ç°å¯¹åŒä¸€ä¸ªæœåŠ¡çš„è¯·æ±‚åœ¨æŒ‡å®šæ—¶é—´èŒƒå›´å†…å§‹ç»ˆå®šå‘ä¸ºåŒä¸€ä¸ªRSã€‚åœ¨directorå†…æœ‰ä¸€ä¸ªLVSæŒä¹…è¿æ¥æ¨¡æ¿ï¼Œæ¨¡æ¿ä¸­è®°å½•äº†æ¯ä¸€ä¸ªè¯·æ±‚çš„æ¥æºã€è°ƒåº¦è‡³çš„RSã€ç»´æŠ¤æ—¶é•¿ç­‰ç­‰ï¼Œæ‰€ä»¥ï¼Œåœ¨æ–°çš„è¯·æ±‚è¿›å…¥æ—¶ï¼Œé¦–å…ˆåœ¨æ­¤æ¨¡æ¿ä¸­æ£€æŸ¥æ˜¯å¦æœ‰è®°å½•ï¼ˆæœ‰å†…ç½®çš„æ—¶é—´é™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶æ˜¯300ç§’ï¼Œå½“åœ¨åˆ°è¾¾300ç§’æ—¶ä¾ç„¶æœ‰ç”¨æˆ·è®¿é—®ï¼Œé‚£ä¹ˆæŒä¹…è¿æ¥æ¨¡æ¿å°±ä¼šå°†æ—¶é—´å¢åŠ ä¸¤åˆ†é’Ÿï¼Œå†è®¡æ•°ï¼Œä¾æ¬¡ç±»æ¨ï¼Œæ¯æ¬¡åªå»¶é•¿2åˆ†é’Ÿï¼‰ï¼Œå¦‚æœè¯¥è®°å½•æœªè¶…æ—¶ï¼Œåˆ™ä½¿ç”¨è¯¥è®°å½•æ‰€æŒ‡å‘çš„RSï¼Œå¦‚æœæ˜¯è¶…æ—¶è®°å½•æˆ–è€…æ˜¯æ–°è¯·æ±‚ï¼Œåˆ™ä¼šæ ¹æ®è°ƒåº¦ç®—æ³•å…ˆè°ƒåº¦è‡³ç‰¹å®šRSï¼Œå†å°†è°ƒåº¦çš„è®°å½•æ·»åŠ è‡³æ­¤è¡¨ä¸­ã€‚è¿™å¹¶ä¸ä¸SHç®—æ³•å†²çªï¼ŒlvsæŒä¹…è¿æ¥ä¼šåœ¨æ–°è¯·æ±‚è¾¾åˆ°æ—¶ï¼Œæ£€æŸ¥åç«¯RSçš„è´Ÿè½½çŠ¶å†µï¼Œè¿™å°±æ˜¯æ¯”è¾ƒç²¾ç»†çš„è°ƒåº¦å’Œä¼šè¯ä¿æŒæ–¹æ³•ã€‚\nLVSçš„ä¸‰ç§æŒä¹…è¿æ¥æ–¹å¼PCCï¼šæ¯å®¢æˆ·ç«¯æŒä¹…ï¼›å°†æ¥è‡ªäºåŒä¸€ä¸ªå®¢æˆ·ç«¯çš„æ‰€æœ‰è¯·æ±‚ç»Ÿç»Ÿå®šå‘è‡³æ­¤å‰é€‰å®šçš„RSï¼›ä¹Ÿå°±æ˜¯åªè¦IPç›¸åŒï¼Œåˆ†é…çš„æœåŠ¡å™¨å§‹ç»ˆç›¸åŒã€‚\nPPCï¼šæ¯ç«¯å£æŒä¹…ï¼›å°†æ¥è‡ªäºåŒä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åŒä¸€ä¸ªæœåŠ¡(ç«¯å£)çš„è¯·æ±‚ï¼Œå§‹ç»ˆå®šå‘è‡³æ­¤å‰é€‰å®šçš„RSã€‚ä¾‹å¦‚ï¼šæ¥è‡ªåŒä¸€ä¸ªIPçš„ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®é›†ç¾¤çš„80ç«¯å£åˆ†é…åˆ°AæœåŠ¡å™¨ï¼Œ25å·ç«¯å£åˆ†é…åˆ°BæœåŠ¡å™¨ã€‚å½“ä¹‹åè¿™ä¸ªç”¨æˆ·ç»§ç»­è®¿é—®80ç«¯å£ä»ç„¶åˆ†é…åˆ°AæœåŠ¡å™¨ï¼Œ25å·ç«¯å£ä»ç„¶åˆ†é…åˆ°BæœåŠ¡å™¨ã€‚\nPFMCï¼šæŒä¹…é˜²ç«å¢™æ ‡è®°è¿æ¥ï¼›å°†æ¥è‡ªäºåŒä¸€å®¢æˆ·ç«¯å¯¹æŒ‡å®šæœåŠ¡(ç«¯å£)çš„è¯·æ±‚ï¼Œå§‹ç»ˆå®šå‘è‡³æ­¤é€‰å®šçš„RSï¼›ä¸è¿‡å®ƒå¯ä»¥å°†ä¸¤ä¸ªæ¯«ä¸ç›¸å¹²çš„ç«¯å£å®šä¹‰ä¸ºä¸€ä¸ªé›†ç¾¤æœåŠ¡ï¼Œä¾‹å¦‚ï¼šåˆå¹¶httpçš„80ç«¯å£å’Œhttpsçš„443ç«¯å£å®šä¹‰ä¸ºåŒä¸€ä¸ªé›†ç¾¤æœåŠ¡ï¼Œå½“ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—®80ç«¯å£åˆ†é…åˆ°AæœåŠ¡å™¨ï¼Œç¬¬äºŒæ¬¡è®¿é—®443ç«¯å£æ—¶ä»ç„¶åˆ†é…åˆ°AæœåŠ¡å™¨ã€‚ \nç¤ºä¾‹ã€€ã€€LVSçš„æŒä¹…è¿æ¥åŠŸèƒ½éœ€è¦å®šä¹‰åœ¨é›†ç¾¤æœåŠ¡ä¸Šé¢ï¼Œä½¿ç”¨-p timeouté€‰é¡¹ã€‚\nPPCï¼š\n[root@localhost ~]# ipvsadm -At 10.1.210.58:80 -s rr -p 300  #ä¸Šé¢å‘½ä»¤çš„æ„æ€æ˜¯ï¼šæ·»åŠ ä¸€ä¸ªé›†ç¾¤æœåŠ¡ä¸º10.1.210.58:80ï¼Œä½¿ç”¨çš„è°ƒåº¦ç®—æ³•ä¸ºrrï¼ŒæŒä¹…è¿æ¥çš„ä¿æŒæ—¶é—´æ˜¯300ç§’ã€‚å½“è¶…è¿‡300ç§’éƒ½æ²¡æœ‰è¯·æ±‚æ—¶ï¼Œåˆ™æ¸…ç©ºLVSçš„æŒä¹…è¿æ¥æ¨¡æ¿ã€‚\n\nPCCï¼š\n# ipvsadm -A -t 10.1.210.58:0 -s rr -p 600# ipvsadm -a -t 10.1.210.58:0 -r 10.1.210.52 -g -w 2# ipvsadm -a -t 10.1.210.58:0 -r 0.1.210.53 -g -w 1\n\nPFMCï¼š\n######PNMPPæ˜¯é€šè¿‡è·¯ç”±å‰ç»™æ•°æ®åŒ…æ‰“æ ‡è®°æ¥å®ç°çš„# iptables -t mangle -A PREROUTING -d 10.1.210.58 -ens192 -p tcp --dport 80 -j MARK --set-mark 3# iptables -t mangle -A PREROUTING -d 10.1.210.58 -ens192 -p tcp --dport 443 -j MARK --set-mark 3# ipvsadm -A -f 3 -s rr -p 600# ipvsadm -a -f 3 -r 10.1.210.52 -g -w 2# ipvsadm -a -f 3 -r 10.1.210.52 -g -w 2\n","categories":["çŸ¥è¯†åº“"]},{"title":"OAuth2","url":"/posts/13254/","content":"ä¸€ã€OAuth 2.0 çš„ä¸€ä¸ªç®€å•è§£é‡Š1. å¿«é€’å‘˜é—®é¢˜æˆ‘ä½åœ¨ä¸€ä¸ªå¤§å‹çš„å±…æ°‘å°åŒºã€‚\nå°åŒºæœ‰é—¨ç¦ç³»ç»Ÿã€‚\nè¿›å…¥çš„æ—¶å€™éœ€è¦è¾“å…¥å¯†ç ã€‚\næˆ‘ç»å¸¸ç½‘è´­å’Œå¤–å–ï¼Œæ¯å¤©éƒ½æœ‰å¿«é€’å‘˜æ¥é€è´§ã€‚æˆ‘å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåŠæ³•ï¼Œè®©å¿«é€’å‘˜é€šè¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚\nå¦‚æœæˆ‘æŠŠè‡ªå·±çš„å¯†ç ï¼Œå‘Šè¯‰å¿«é€’å‘˜ï¼Œä»–å°±æ‹¥æœ‰äº†ä¸æˆ‘åŒæ ·çš„æƒé™ï¼Œè¿™æ ·å¥½åƒä¸å¤ªåˆé€‚ã€‚ä¸‡ä¸€æˆ‘æƒ³å–æ¶ˆä»–è¿›å…¥å°åŒºçš„æƒåŠ›ï¼Œä¹Ÿå¾ˆéº»çƒ¦ï¼Œæˆ‘è‡ªå·±çš„å¯†ç ä¹Ÿå¾—è·Ÿç€æ”¹äº†ï¼Œè¿˜å¾—é€šçŸ¥å…¶ä»–çš„å¿«é€’å‘˜ã€‚\næœ‰æ²¡æœ‰ä¸€ç§åŠæ³•ï¼Œè®©å¿«é€’å‘˜èƒ½å¤Ÿè‡ªç”±è¿›å…¥å°åŒºï¼Œåˆä¸å¿…çŸ¥é“å°åŒºå±…æ°‘çš„å¯†ç ï¼Œè€Œä¸”ä»–çš„å”¯ä¸€æƒé™å°±æ˜¯é€è´§ï¼Œå…¶ä»–éœ€è¦å¯†ç çš„åœºåˆï¼Œä»–éƒ½æ²¡æœ‰æƒé™ï¼Ÿ\n2. æˆæƒæœºåˆ¶çš„è®¾è®¡äºæ˜¯ï¼Œæˆ‘è®¾è®¡äº†ä¸€å¥—æˆæƒæœºåˆ¶ã€‚\nç¬¬ä¸€æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿçš„å¯†ç è¾“å…¥å™¨ä¸‹é¢ï¼Œå¢åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå«åšâ€è·å–æˆæƒâ€ã€‚å¿«é€’å‘˜éœ€è¦é¦–å…ˆæŒ‰è¿™ä¸ªæŒ‰é’®ï¼Œå»ç”³è¯·æˆæƒã€‚\nç¬¬äºŒæ­¥ï¼Œä»–æŒ‰ä¸‹æŒ‰é’®ä»¥åï¼Œå±‹ä¸»ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ï¼‰çš„æ‰‹æœºå°±ä¼šè·³å‡ºå¯¹è¯æ¡†ï¼šæœ‰äººæ­£åœ¨è¦æ±‚æˆæƒã€‚ç³»ç»Ÿè¿˜ä¼šæ˜¾ç¤ºè¯¥å¿«é€’å‘˜çš„å§“åã€å·¥å·å’Œæ‰€å±çš„å¿«é€’å…¬å¸ã€‚\næˆ‘ç¡®è®¤è¯·æ±‚å±å®ï¼Œå°±ç‚¹å‡»æŒ‰é’®ï¼Œå‘Šè¯‰é—¨ç¦ç³»ç»Ÿï¼Œæˆ‘åŒæ„ç»™äºˆä»–è¿›å…¥å°åŒºçš„æˆæƒã€‚\nç¬¬ä¸‰æ­¥ï¼Œé—¨ç¦ç³»ç»Ÿå¾—åˆ°æˆ‘çš„ç¡®è®¤ä»¥åï¼Œå‘å¿«é€’å‘˜æ˜¾ç¤ºä¸€ä¸ªè¿›å…¥å°åŒºçš„ä»¤ç‰Œï¼ˆaccess tokenï¼‰ã€‚ä»¤ç‰Œå°±æ˜¯ç±»ä¼¼å¯†ç çš„ä¸€ä¸²æ•°å­—ï¼Œåªåœ¨çŸ­æœŸå†…ï¼ˆæ¯”å¦‚ä¸ƒå¤©ï¼‰æœ‰æ•ˆã€‚\nç¬¬å››æ­¥ï¼Œå¿«é€’å‘˜å‘é—¨ç¦ç³»ç»Ÿè¾“å…¥ä»¤ç‰Œï¼Œè¿›å…¥å°åŒºã€‚\næœ‰äººå¯èƒ½ä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸æ˜¯è¿œç¨‹ä¸ºå¿«é€’å‘˜å¼€é—¨ï¼Œè€Œè¦ä¸ºä»–å•ç‹¬ç”Ÿæˆä¸€ä¸ªä»¤ç‰Œï¼Ÿè¿™æ˜¯å› ä¸ºå¿«é€’å‘˜å¯èƒ½æ¯å¤©éƒ½ä¼šæ¥é€è´§ï¼Œç¬¬äºŒå¤©ä»–è¿˜å¯ä»¥å¤ç”¨è¿™ä¸ªä»¤ç‰Œã€‚å¦å¤–ï¼Œæœ‰çš„å°åŒºæœ‰å¤šé‡é—¨ç¦ï¼Œå¿«é€’å‘˜å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªä»¤ç‰Œé€šè¿‡å®ƒä»¬ã€‚\n3. äº’è”ç½‘åœºæ™¯æˆ‘ä»¬æŠŠä¸Šé¢çš„ä¾‹å­æ¬åˆ°äº’è”ç½‘ï¼Œå°±æ˜¯ OAuth çš„è®¾è®¡äº†ã€‚\né¦–å…ˆï¼Œå±…æ°‘å°åŒºå°±æ˜¯å‚¨å­˜ç”¨æˆ·æ•°æ®çš„ç½‘ç»œæœåŠ¡ã€‚æ¯”å¦‚ï¼Œå¾®ä¿¡å‚¨å­˜äº†æˆ‘çš„å¥½å‹ä¿¡æ¯ï¼Œè·å–è¿™äº›ä¿¡æ¯ï¼Œå°±å¿…é¡»ç»è¿‡å¾®ä¿¡çš„â€é—¨ç¦ç³»ç»Ÿâ€ã€‚\nå…¶æ¬¡ï¼Œå¿«é€’å‘˜ï¼ˆæˆ–è€…è¯´å¿«é€’å…¬å¸ï¼‰å°±æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæƒ³è¦ç©¿è¿‡é—¨ç¦ç³»ç»Ÿï¼Œè¿›å…¥å°åŒºã€‚\næœ€åï¼Œæˆ‘å°±æ˜¯ç”¨æˆ·æœ¬äººï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥å°åŒºï¼Œè·å–æˆ‘çš„æ•°æ®ã€‚\nç®€å•è¯´ï¼ŒOAuth å°±æ˜¯ä¸€ç§æˆæƒæœºåˆ¶ã€‚æ•°æ®çš„æ‰€æœ‰è€…å‘Šè¯‰ç³»ç»Ÿï¼ŒåŒæ„æˆæƒç¬¬ä¸‰æ–¹åº”ç”¨è¿›å…¥ç³»ç»Ÿï¼Œè·å–è¿™äº›æ•°æ®ã€‚ç³»ç»Ÿä»è€Œäº§ç”Ÿä¸€ä¸ªçŸ­æœŸçš„è¿›å…¥ä»¤ç‰Œï¼ˆtokenï¼‰ï¼Œç”¨æ¥ä»£æ›¿å¯†ç ï¼Œä¾›ç¬¬ä¸‰æ–¹åº”ç”¨ä½¿ç”¨ã€‚\n4. ä»¤ç‰Œä¸å¯†ç ä»¤ç‰Œï¼ˆtokenï¼‰ä¸å¯†ç ï¼ˆpasswordï¼‰çš„ä½œç”¨æ˜¯ä¸€æ ·çš„ï¼Œéƒ½å¯ä»¥è¿›å…¥ç³»ç»Ÿï¼Œä½†æ˜¯æœ‰ä¸‰ç‚¹å·®å¼‚ã€‚\nï¼ˆ1ï¼‰ä»¤ç‰Œæ˜¯çŸ­æœŸçš„ï¼Œåˆ°æœŸä¼šè‡ªåŠ¨å¤±æ•ˆï¼Œç”¨æˆ·è‡ªå·±æ— æ³•ä¿®æ”¹ã€‚å¯†ç ä¸€èˆ¬é•¿æœŸæœ‰æ•ˆï¼Œç”¨æˆ·ä¸ä¿®æ”¹ï¼Œå°±ä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚\nï¼ˆ2ï¼‰ä»¤ç‰Œå¯ä»¥è¢«æ•°æ®æ‰€æœ‰è€…æ’¤é”€ï¼Œä¼šç«‹å³å¤±æ•ˆã€‚ä»¥ä¸Šä¾‹è€Œè¨€ï¼Œå±‹ä¸»å¯ä»¥éšæ—¶å–æ¶ˆå¿«é€’å‘˜çš„ä»¤ç‰Œã€‚å¯†ç ä¸€èˆ¬ä¸å…è®¸è¢«ä»–äººæ’¤é”€ã€‚\nï¼ˆ3ï¼‰ä»¤ç‰Œæœ‰æƒé™èŒƒå›´ï¼ˆscopeï¼‰ï¼Œæ¯”å¦‚åªèƒ½è¿›å°åŒºçš„äºŒå·é—¨ã€‚å¯¹äºç½‘ç»œæœåŠ¡æ¥è¯´ï¼Œåªè¯»ä»¤ç‰Œå°±æ¯”è¯»å†™ä»¤ç‰Œæ›´å®‰å…¨ã€‚å¯†ç ä¸€èˆ¬æ˜¯å®Œæ•´æƒé™ã€‚\nä¸Šé¢è¿™äº›è®¾è®¡ï¼Œä¿è¯äº†ä»¤ç‰Œæ—¢å¯ä»¥è®©ç¬¬ä¸‰æ–¹åº”ç”¨è·å¾—æƒé™ï¼ŒåŒæ—¶åˆéšæ—¶å¯æ§ï¼Œä¸ä¼šå±åŠç³»ç»Ÿå®‰å…¨ã€‚è¿™å°±æ˜¯ OAuth 2.0 çš„ä¼˜ç‚¹ã€‚\næ³¨æ„ï¼Œåªè¦çŸ¥é“äº†ä»¤ç‰Œï¼Œå°±èƒ½è¿›å…¥ç³»ç»Ÿã€‚ç³»ç»Ÿä¸€èˆ¬ä¸ä¼šå†æ¬¡ç¡®è®¤èº«ä»½ï¼Œæ‰€ä»¥ä»¤ç‰Œå¿…é¡»ä¿å¯†ï¼Œæ³„æ¼ä»¤ç‰Œä¸æ³„æ¼å¯†ç çš„åæœæ˜¯ä¸€æ ·çš„ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä»¤ç‰Œçš„æœ‰æ•ˆæœŸï¼Œä¸€èˆ¬éƒ½è®¾ç½®å¾—å¾ˆçŸ­çš„åŸå› ã€‚\näºŒã€OAuth 2.0 çš„å››ç§æˆæƒç±»å‹1. RFC 6749OAuth 2.0 çš„æ ‡å‡†æ˜¯ RFC 6749 æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å…ˆè§£é‡Šäº† OAuth æ˜¯ä»€ä¹ˆã€‚\n\nOAuth å¼•å…¥äº†ä¸€ä¸ªæˆæƒå±‚ï¼Œç”¨æ¥åˆ†ç¦»ä¸¤ç§ä¸åŒçš„è§’è‰²ï¼šå®¢æˆ·ç«¯å’Œèµ„æºæ‰€æœ‰è€…ã€‚â€¦â€¦èµ„æºæ‰€æœ‰è€…åŒæ„ä»¥åï¼Œèµ„æºæœåŠ¡å™¨å¯ä»¥å‘å®¢æˆ·ç«¯é¢å‘ä»¤ç‰Œã€‚å®¢æˆ·ç«¯é€šè¿‡ä»¤ç‰Œï¼Œå»è¯·æ±‚æ•°æ®ã€‚\n\nè¿™æ®µè¯çš„æ„æ€å°±æ˜¯ï¼ŒOAuth çš„æ ¸å¿ƒå°±æ˜¯å‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ç„¶åï¼ŒRFC 6749 æ¥ç€å†™é“ï¼š\n\nï¼ˆç”±äºäº’è”ç½‘æœ‰å¤šç§åœºæ™¯ï¼Œï¼‰æœ¬æ ‡å‡†å®šä¹‰äº†è·å¾—ä»¤ç‰Œçš„å››ç§æˆæƒæ–¹å¼ï¼ˆauthorization grant ï¼‰ã€‚\n\nä¹Ÿå°±æ˜¯è¯´ï¼ŒOAuth 2.0 è§„å®šäº†å››ç§è·å¾—ä»¤ç‰Œçš„æµç¨‹ã€‚ä½ å¯ä»¥é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„é‚£ä¸€ç§ï¼Œå‘ç¬¬ä¸‰æ–¹åº”ç”¨é¢å‘ä»¤ç‰Œã€‚ä¸‹é¢å°±æ˜¯è¿™å››ç§æˆæƒæ–¹å¼ã€‚\n\næˆæƒç ï¼ˆauthorization-codeï¼‰\néšè—å¼ï¼ˆimplicitï¼‰\nå¯†ç å¼ï¼ˆpasswordï¼‰ï¼š\nå®¢æˆ·ç«¯å‡­è¯ï¼ˆclient credentialsï¼‰\n\næ³¨æ„ï¼Œä¸ç®¡å“ªä¸€ç§æˆæƒæ–¹å¼ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨ç”³è¯·ä»¤ç‰Œä¹‹å‰ï¼Œéƒ½å¿…é¡»å…ˆåˆ°ç³»ç»Ÿå¤‡æ¡ˆï¼Œè¯´æ˜è‡ªå·±çš„èº«ä»½ï¼Œç„¶åä¼šæ‹¿åˆ°ä¸¤ä¸ªèº«ä»½è¯†åˆ«ç ï¼šå®¢æˆ·ç«¯ IDï¼ˆclient IDï¼‰å’Œå®¢æˆ·ç«¯å¯†é’¥ï¼ˆclient secretï¼‰ã€‚è¿™æ˜¯ä¸ºäº†é˜²æ­¢ä»¤ç‰Œè¢«æ»¥ç”¨ï¼Œæ²¡æœ‰å¤‡æ¡ˆè¿‡çš„ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œæ˜¯ä¸ä¼šæ‹¿åˆ°ä»¤ç‰Œçš„ã€‚\n2. ç¬¬ä¸€ç§æˆæƒæ–¹å¼ï¼šæˆæƒç æˆæƒç ï¼ˆauthorization codeï¼‰æ–¹å¼ï¼ŒæŒ‡çš„æ˜¯ç¬¬ä¸‰æ–¹åº”ç”¨å…ˆç”³è¯·ä¸€ä¸ªæˆæƒç ï¼Œç„¶åå†ç”¨è¯¥ç è·å–ä»¤ç‰Œã€‚\nè¿™ç§æ–¹å¼æ˜¯æœ€å¸¸ç”¨çš„æµç¨‹ï¼Œå®‰å…¨æ€§ä¹Ÿæœ€é«˜ï¼Œå®ƒé€‚ç”¨äºé‚£äº›æœ‰åç«¯çš„ Web åº”ç”¨ã€‚æˆæƒç é€šè¿‡å‰ç«¯ä¼ é€ï¼Œä»¤ç‰Œåˆ™æ˜¯å‚¨å­˜åœ¨åç«¯ï¼Œè€Œä¸”æ‰€æœ‰ä¸èµ„æºæœåŠ¡å™¨çš„é€šä¿¡éƒ½åœ¨åç«¯å®Œæˆã€‚è¿™æ ·çš„å‰åç«¯åˆ†ç¦»ï¼Œå¯ä»¥é¿å…ä»¤ç‰Œæ³„æ¼ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œç”¨æˆ·ç‚¹å‡»åå°±ä¼šè·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚ä¸‹é¢å°±æ˜¯ A ç½‘ç«™è·³è½¬ B ç½‘ç«™çš„ä¸€ä¸ªç¤ºæ„é“¾æ¥ã€‚\nhttps://b.com/oauth/authorize?  response_type=code&amp;  client_id=CLIENT_ID&amp;  redirect_uri=CALLBACK_URL&amp;  scope=read\n\nä¸Šé¢ URL ä¸­ï¼Œresponse_type å‚æ•°è¡¨ç¤ºè¦æ±‚è¿”å›æˆæƒç ï¼ˆcodeï¼‰ï¼Œclient_id å‚æ•°è®© B çŸ¥é“æ˜¯è°åœ¨è¯·æ±‚ï¼Œredirect_uri å‚æ•°æ˜¯ B æ¥å—æˆ–æ‹’ç»è¯·æ±‚åçš„è·³è½¬ç½‘å€ï¼Œscope å‚æ•°è¡¨ç¤ºè¦æ±‚çš„æˆæƒèŒƒå›´ï¼ˆè¿™é‡Œæ˜¯åªè¯»ï¼‰ã€‚\n\nç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åï¼ŒB ç½‘ç«™ä¼šè¦æ±‚ç”¨æˆ·ç™»å½•ï¼Œç„¶åè¯¢é—®æ˜¯å¦åŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚ç”¨æˆ·è¡¨ç¤ºåŒæ„ï¼Œè¿™æ—¶ B ç½‘ç«™å°±ä¼šè·³å›redirect_uriå‚æ•°æŒ‡å®šçš„ç½‘å€ã€‚è·³è½¬æ—¶ï¼Œä¼šä¼ å›ä¸€ä¸ªæˆæƒç ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚\nhttps://a.com/callback?code=AUTHORIZATION_CODE\n\nä¸Šé¢ URL ä¸­ï¼Œcode å‚æ•°å°±æ˜¯æˆæƒç ã€‚\n\nç¬¬ä¸‰æ­¥ï¼ŒA ç½‘ç«™æ‹¿åˆ°æˆæƒç ä»¥åï¼Œå°±å¯ä»¥åœ¨åç«¯ï¼Œå‘ B ç½‘ç«™è¯·æ±‚ä»¤ç‰Œã€‚\nhttps://b.com/oauth/token? client_id=CLIENT_ID&amp; client_secret=CLIENT_SECRET&amp; grant_type=authorization_code&amp; code=AUTHORIZATION_CODE&amp; redirect_uri=CALLBACK_URL\n\nä¸Šé¢ URL ä¸­ï¼Œclient_id å‚æ•°å’Œ client_secret å‚æ•°ç”¨æ¥è®© B ç¡®è®¤ A çš„èº«ä»½ï¼ˆclient_secretå‚æ•°æ˜¯ä¿å¯†çš„ï¼Œå› æ­¤åªèƒ½åœ¨åç«¯å‘è¯·æ±‚ï¼‰ï¼Œgrant_type å‚æ•°çš„å€¼æ˜¯ AUTHORIZATION_CODEï¼Œè¡¨ç¤ºé‡‡ç”¨çš„æˆæƒæ–¹å¼æ˜¯æˆæƒç ï¼Œcode å‚æ•°æ˜¯ä¸Šä¸€æ­¥æ‹¿åˆ°çš„æˆæƒç ï¼Œredirect_uri å‚æ•°æ˜¯ä»¤ç‰Œé¢å‘åçš„å›è°ƒç½‘å€ã€‚\n\nç¬¬å››æ­¥ï¼ŒB ç½‘ç«™æ”¶åˆ°è¯·æ±‚ä»¥åï¼Œå°±ä¼šé¢å‘ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯å‘ redirect_uri æŒ‡å®šçš„ç½‘å€ï¼Œå‘é€ä¸€æ®µ JSON æ•°æ®ã€‚\n&#123;      &quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,  &quot;token_type&quot;:&quot;bearer&quot;,  &quot;expires_in&quot;:2592000,  &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;,  &quot;scope&quot;:&quot;read&quot;,  &quot;uid&quot;:100101,  &quot;info&quot;:&#123;...&#125;&#125;\n\nä¸Šé¢ JSON æ•°æ®ä¸­ï¼Œaccess_token å­—æ®µå°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™åœ¨åç«¯æ‹¿åˆ°äº†ã€‚\n\n3. ç¬¬äºŒç§æ–¹å¼ï¼šéšè—å¼æœ‰äº› Web åº”ç”¨æ˜¯çº¯å‰ç«¯åº”ç”¨ï¼Œæ²¡æœ‰åç«¯ã€‚è¿™æ—¶å°±ä¸èƒ½ç”¨ä¸Šé¢çš„æ–¹å¼äº†ï¼Œå¿…é¡»å°†ä»¤ç‰Œå‚¨å­˜åœ¨å‰ç«¯ã€‚RFC 6749 å°±è§„å®šäº†ç¬¬äºŒç§æ–¹å¼ï¼Œå…è®¸ç›´æ¥å‘å‰ç«¯é¢å‘ä»¤ç‰Œã€‚è¿™ç§æ–¹å¼æ²¡æœ‰æˆæƒç è¿™ä¸ªä¸­é—´æ­¥éª¤ï¼Œæ‰€ä»¥ç§°ä¸ºï¼ˆæˆæƒç ï¼‰â€éšè—å¼â€ï¼ˆimplicitï¼‰ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™æä¾›ä¸€ä¸ªé“¾æ¥ï¼Œè¦æ±‚ç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œæˆæƒç”¨æˆ·æ•°æ®ç»™ A ç½‘ç«™ä½¿ç”¨ã€‚\nhttps://b.com/oauth/authorize?  response_type=token&amp;  client_id=CLIENT_ID&amp;  redirect_uri=CALLBACK_URL&amp;  scope=read\n\nä¸Šé¢ URL ä¸­ï¼Œresponse_type å‚æ•°ä¸º tokenï¼Œè¡¨ç¤ºè¦æ±‚ç›´æ¥è¿”å›ä»¤ç‰Œã€‚\nç¬¬äºŒæ­¥ï¼Œç”¨æˆ·è·³è½¬åˆ° B ç½‘ç«™ï¼Œç™»å½•ååŒæ„ç»™äºˆ A ç½‘ç«™æˆæƒã€‚è¿™æ—¶ï¼ŒB ç½‘ç«™å°±ä¼šè·³å› redirect_uri å‚æ•°æŒ‡å®šçš„è·³è½¬ç½‘å€ï¼Œå¹¶ä¸”æŠŠä»¤ç‰Œä½œä¸º URL å‚æ•°ï¼Œä¼ ç»™ A ç½‘ç«™ã€‚\nhttps://a.com/callback#token=ACCESS_TOKEN\n\nä¸Šé¢ URL ä¸­ï¼Œtoken å‚æ•°å°±æ˜¯ä»¤ç‰Œï¼ŒA ç½‘ç«™å› æ­¤ç›´æ¥åœ¨å‰ç«¯æ‹¿åˆ°ä»¤ç‰Œã€‚\næ³¨æ„ï¼Œä»¤ç‰Œçš„ä½ç½®æ˜¯ URL é”šç‚¹ï¼ˆfragmentï¼‰ï¼Œè€Œä¸æ˜¯æŸ¥è¯¢å­—ç¬¦ä¸²ï¼ˆquerystringï¼‰ï¼Œè¿™æ˜¯å› ä¸º OAuth 2.0 å…è®¸è·³è½¬ç½‘å€æ˜¯ HTTP åè®®ï¼Œå› æ­¤å­˜åœ¨â€ä¸­é—´äººæ”»å‡»â€çš„é£é™©ï¼Œè€Œæµè§ˆå™¨è·³è½¬æ—¶ï¼Œé”šç‚¹ä¸ä¼šå‘åˆ°æœåŠ¡å™¨ï¼Œå°±å‡å°‘äº†æ³„æ¼ä»¤ç‰Œçš„é£é™©ã€‚\n\nè¿™ç§æ–¹å¼æŠŠä»¤ç‰Œç›´æ¥ä¼ ç»™å‰ç«¯ï¼Œæ˜¯å¾ˆä¸å®‰å…¨çš„ã€‚å› æ­¤ï¼Œåªèƒ½ç”¨äºä¸€äº›å®‰å…¨è¦æ±‚ä¸é«˜çš„åœºæ™¯ï¼Œå¹¶ä¸”ä»¤ç‰Œçš„æœ‰æ•ˆæœŸå¿…é¡»éå¸¸çŸ­ï¼Œé€šå¸¸å°±æ˜¯ä¼šè¯æœŸé—´ï¼ˆsessionï¼‰æœ‰æ•ˆï¼Œæµè§ˆå™¨å…³æ‰ï¼Œä»¤ç‰Œå°±å¤±æ•ˆäº†ã€‚\n4. ç¬¬ä¸‰ç§æ–¹å¼ï¼šå¯†ç å¼å¦‚æœä½ é«˜åº¦ä¿¡ä»»æŸä¸ªåº”ç”¨ï¼ŒRFC 6749 ä¹Ÿå…è®¸ç”¨æˆ·æŠŠç”¨æˆ·åå’Œå¯†ç ï¼Œç›´æ¥å‘Šè¯‰è¯¥åº”ç”¨ã€‚è¯¥åº”ç”¨å°±ä½¿ç”¨ä½ çš„å¯†ç ï¼Œç”³è¯·ä»¤ç‰Œï¼Œè¿™ç§æ–¹å¼ç§°ä¸ºâ€å¯†ç å¼â€ï¼ˆpasswordï¼‰ã€‚\nç¬¬ä¸€æ­¥ï¼ŒA ç½‘ç«™è¦æ±‚ç”¨æˆ·æä¾› B ç½‘ç«™çš„ç”¨æˆ·åå’Œå¯†ç ã€‚æ‹¿åˆ°ä»¥åï¼ŒA å°±ç›´æ¥å‘ B è¯·æ±‚ä»¤ç‰Œã€‚\nhttps://oauth.b.com/token?  grant_type=password&amp;  username=USERNAME&amp;  password=PASSWORD&amp;  client_id=CLIENT_ID\n\nä¸Šé¢ URL ä¸­ï¼Œgrant_type å‚æ•°æ˜¯æˆæƒæ–¹å¼ï¼Œè¿™é‡Œçš„passwordè¡¨ç¤ºâ€å¯†ç å¼â€ï¼Œusername å’Œ password æ˜¯ B çš„ç”¨æˆ·åå’Œå¯†ç ã€‚\nç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯èº«ä»½é€šè¿‡åï¼Œç›´æ¥ç»™å‡ºä»¤ç‰Œã€‚æ³¨æ„ï¼Œè¿™æ—¶ä¸éœ€è¦è·³è½¬ï¼Œè€Œæ˜¯æŠŠä»¤ç‰Œæ”¾åœ¨ JSON æ•°æ®é‡Œé¢ï¼Œä½œä¸º HTTP å›åº”ï¼ŒA å› æ­¤æ‹¿åˆ°ä»¤ç‰Œã€‚\nè¿™ç§æ–¹å¼éœ€è¦ç”¨æˆ·ç»™å‡ºè‡ªå·±çš„ç”¨æˆ·å/å¯†ç ï¼Œæ˜¾ç„¶é£é™©å¾ˆå¤§ï¼Œå› æ­¤åªé€‚ç”¨äºå…¶ä»–æˆæƒæ–¹å¼éƒ½æ— æ³•é‡‡ç”¨çš„æƒ…å†µï¼Œè€Œä¸”å¿…é¡»æ˜¯ç”¨æˆ·é«˜åº¦ä¿¡ä»»çš„åº”ç”¨ã€‚\n5. ç¬¬å››ç§æ–¹å¼ï¼šå‡­è¯å¼æœ€åä¸€ç§æ–¹å¼æ˜¯å‡­è¯å¼ï¼ˆclient credentialsï¼‰ï¼Œé€‚ç”¨äºæ²¡æœ‰å‰ç«¯çš„å‘½ä»¤è¡Œåº”ç”¨ï¼Œå³åœ¨å‘½ä»¤è¡Œä¸‹è¯·æ±‚ä»¤ç‰Œã€‚\nç¬¬ä¸€æ­¥ï¼ŒA åº”ç”¨åœ¨å‘½ä»¤è¡Œå‘ B å‘å‡ºè¯·æ±‚ã€‚\nhttps://oauth.b.com/token?  grant_type=client_credentials&amp;  client_id=CLIENT_ID&amp;  client_secret=CLIENT_SECRET\n\nä¸Šé¢ URL ä¸­ï¼Œgrant_type å‚æ•°ç­‰äº client_credentials è¡¨ç¤ºé‡‡ç”¨å‡­è¯å¼ï¼Œclient_id å’Œ client_secret ç”¨æ¥è®© B ç¡®è®¤ A çš„èº«ä»½ã€‚\nç¬¬äºŒæ­¥ï¼ŒB ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œç›´æ¥è¿”å›ä»¤ç‰Œã€‚\nè¿™ç§æ–¹å¼ç»™å‡ºçš„ä»¤ç‰Œï¼Œæ˜¯é’ˆå¯¹ç¬¬ä¸‰æ–¹åº”ç”¨çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹ç”¨æˆ·çš„ï¼Œå³æœ‰å¯èƒ½å¤šä¸ªç”¨æˆ·å…±äº«åŒä¸€ä¸ªä»¤ç‰Œã€‚\n6. ä»¤ç‰Œçš„ä½¿ç”¨A ç½‘ç«™æ‹¿åˆ°ä»¤ç‰Œä»¥åï¼Œå°±å¯ä»¥å‘ B ç½‘ç«™çš„ API è¯·æ±‚æ•°æ®äº†ã€‚\næ­¤æ—¶ï¼Œæ¯ä¸ªå‘åˆ° API çš„è¯·æ±‚ï¼Œéƒ½å¿…é¡»å¸¦æœ‰ä»¤ç‰Œã€‚å…·ä½“åšæ³•æ˜¯åœ¨è¯·æ±‚çš„å¤´ä¿¡æ¯ï¼ŒåŠ ä¸Šä¸€ä¸ª Authorization å­—æ®µï¼Œä»¤ç‰Œå°±æ”¾åœ¨è¿™ä¸ªå­—æ®µé‡Œé¢ã€‚\ncurl -H &quot;Authorization: Bearer ACCESS_TOKEN&quot; \\&quot;https://api.b.com&quot;\n\nä¸Šé¢å‘½ä»¤ä¸­ï¼ŒACCESS_TOKEN å°±æ˜¯æ‹¿åˆ°çš„ä»¤ç‰Œã€‚\n7. æ›´æ–°ä»¤ç‰Œä»¤ç‰Œçš„æœ‰æ•ˆæœŸåˆ°äº†ï¼Œå¦‚æœè®©ç”¨æˆ·é‡æ–°èµ°ä¸€éä¸Šé¢çš„æµç¨‹ï¼Œå†ç”³è¯·ä¸€ä¸ªæ–°çš„ä»¤ç‰Œï¼Œå¾ˆå¯èƒ½ä½“éªŒä¸å¥½ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰å¿…è¦ã€‚OAuth 2.0 å…è®¸ç”¨æˆ·è‡ªåŠ¨æ›´æ–°ä»¤ç‰Œã€‚\nå…·ä½“æ–¹æ³•æ˜¯ï¼ŒB ç½‘ç«™é¢å‘ä»¤ç‰Œçš„æ—¶å€™ï¼Œä¸€æ¬¡æ€§é¢å‘ä¸¤ä¸ªä»¤ç‰Œï¼Œä¸€ä¸ªç”¨äºè·å–æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ–°çš„ä»¤ç‰Œï¼ˆrefresh token å­—æ®µï¼‰ã€‚ä»¤ç‰Œåˆ°æœŸå‰ï¼Œç”¨æˆ·ä½¿ç”¨ refresh token å‘ä¸€ä¸ªè¯·æ±‚ï¼Œå»æ›´æ–°ä»¤ç‰Œã€‚\nhttps://b.com/oauth/token?  grant_type=refresh_token&amp;  client_id=CLIENT_ID&amp;  client_secret=CLIENT_SECRET&amp;  refresh_token=REFRESH_TOKEN\n\nä¸Šé¢ URL ä¸­ï¼Œgrant_type å‚æ•°ä¸º refresh_token è¡¨ç¤ºè¦æ±‚æ›´æ–°ä»¤ç‰Œï¼Œclient_id å‚æ•°å’Œ client_secret å‚æ•°ç”¨äºç¡®è®¤èº«ä»½ï¼Œrefresh_token å‚æ•°å°±æ˜¯ç”¨äºæ›´æ–°ä»¤ç‰Œçš„ä»¤ç‰Œã€‚\nB ç½‘ç«™éªŒè¯é€šè¿‡ä»¥åï¼Œå°±ä¼šé¢å‘æ–°çš„ä»¤ç‰Œã€‚\n","categories":["çŸ¥è¯†åº“"]},{"title":"PaaSã€IaaS å’Œ SaaS çš„åŒºåˆ«","url":"/posts/50925/","content":"ä¸€ã€æ¦‚è¿°â€œå³æœåŠ¡ï¼ˆaaSï¼‰â€é€šå¸¸æ˜¯æŒ‡ç”±åˆ«äººæä¾›çš„æœåŠ¡ï¼Œå®ƒå¯ä»¥è®©æ‚¨ä¸“æ³¨äºæ›´é‡è¦çš„äº‹åŠ¡ï¼Œä¾‹å¦‚å†™ä»£ç å’Œå®¢æˆ·å…³ç³»ã€‚å³æœåŠ¡é€‰é¡¹è¿˜åŒ…æ‹¬ï¼šåŸºç¡€æ¶æ„å³æœåŠ¡ï¼ˆIaaSï¼‰ã€å¹³å°å³æœåŠ¡ï¼ˆPaaSï¼‰å’Œ è½¯ä»¶å³æœåŠ¡ï¼ˆSaaSï¼‰ã€‚\n\näºŒã€IaaSåŸºç¡€æ¶æ„å³æœåŠ¡ï¼ˆIaaSï¼‰ä¹Ÿç§°ä¸ºäº‘åŸºç¡€æ¶æ„æœåŠ¡ï¼Œæ˜¯ä¸€ç§ç»ç”±äº’è”ç½‘å‘æœ€ç»ˆç”¨æˆ·æä¾› IT åŸºç¡€æ¶æ„çš„äº‘è®¡ç®—å½¢å¼ã€‚IaaS é€šå¸¸ä¸æ— æœåŠ¡å™¨è®¡ç®—æ¯æ¯ç›¸å…³ã€‚\nIaaS è¡¨ç¤ºå°†ç”±æä¾›å•†é€šè¿‡äº‘ä¸ºæ‚¨ç®¡ç†åŸºç¡€æ¶æ„ï¼ŒåŒ…æ‹¬å®é™…çš„æœåŠ¡å™¨ã€ç½‘ç»œã€è™šæ‹ŸåŒ–å’Œå­˜å‚¨ã€‚ç”¨æˆ·å¯é€šè¿‡åº”ç”¨ç¼–ç¨‹æ¥å£ï¼ˆAPIï¼‰ æˆ–æ§åˆ¶é¢æ¿è¿›è¡Œè®¿é—®ï¼Œå¹¶ä¸”åŸºæœ¬ä¸Šæ˜¯ç§Ÿç”¨åŸºç¡€æ¶æ„ã€‚æ“ä½œç³»ç»Ÿã€åº”ç”¨å’Œä¸­é—´ä»¶ç­‰å†…å®¹ç”±ç”¨æˆ·ç®¡ç†ï¼Œè€Œæä¾›å•†åˆ™æä¾›ç¡¬ä»¶ã€ç½‘ç»œã€ç¡¬ç›˜é©±åŠ¨å™¨ã€å­˜å‚¨å’ŒæœåŠ¡å™¨ï¼Œå¹¶è´Ÿè´£å¤„ç†ä¸­æ–­ã€ç»´ä¿®åŠç¡¬ä»¶é—®é¢˜ã€‚\nä¸‰ã€PaaSå¹³å°å³æœåŠ¡ï¼ˆPaaSï¼‰æ˜¯ä¸€ç§ç”±ç¬¬ä¸‰æ–¹æä¾›ç¡¬ä»¶å’Œåº”ç”¨è½¯ä»¶å¹³å°çš„äº‘è®¡ç®—å½¢å¼ã€‚PaaS ä¸»è¦é¢å‘å¼€å‘äººå‘˜å’Œç¨‹åºå‘˜ï¼Œå®ƒå…è®¸ç”¨æˆ·å¼€å‘ã€è¿è¡Œå’Œç®¡ç†è‡ªå·±çš„åº”ç”¨ï¼Œè€Œæ— éœ€æ„å»ºå’Œç»´æŠ¤é€šå¸¸ä¸è¯¥æµç¨‹ç›¸å…³è”çš„åŸºç¡€æ¶æ„æˆ–å¹³å°ã€‚\nPaaS æä¾›å•†ä¼šå°†ç¡¬ä»¶å’Œè½¯ä»¶æ‰˜ç®¡åœ¨è‡ªå·±çš„åŸºç¡€æ¶æ„ä¸Šï¼Œå¹¶é€šè¿‡äº’è”ç½‘ä»¥é›†æˆè§£å†³æ–¹æ¡ˆã€è§£å†³æ–¹æ¡ˆå †æ ˆæˆ–æœåŠ¡çš„å½¢å¼å°†è¯¥å¹³å°äº¤ä»˜ç»™ç”¨æˆ·ã€‚\nä¸¾ä¾‹è€Œè¨€ï¼Œå‡è®¾æ‚¨æ„æ€å¥½äº†è‡ªå·±ä¸‹ä¸€æ­¥çš„å¤§é¡¹ç›®ï¼Œå·²ç»å†™å¥½äº†ä¸€ä¸ªç”Ÿæ´»ä¾¿åˆ©åº”ç”¨çš„ä»£ç ã€‚æ‚¨å¯¹è¿™ä¸ªåº”ç”¨ã€å®ƒçš„ç›®æ ‡å’Œæœªæ¥å‘å±•å……æ»¡å…´å¥‹ã€‚ä¸ºäº†é¿å…å› å®‰è£…æœ¬åœ°ç¡¬ä»¶ã€ç»´æŠ¤æœåŠ¡å™¨ã€æ›´æ–°åŸºç¡€æ¶æ„è½¯ä»¶ä»¥åŠå¿…é¡»è®¾ç½®ç”¨äºæ„å»ºåº”ç”¨çš„è‡ªå®šä¹‰å¹³å°è€Œå¸¦æ¥çš„é¢å¤–å‹åŠ›ï¼Œæ‚¨ä¼šé€‰æ‹©ç”± PaaS æä¾›å•†æ¥æ‰˜ç®¡å¹³å°å¹¶æä¾›è¿è¡Œä»£ç æ‰€éœ€çš„ç¯å¢ƒã€‚\nå››ã€SaaSSaaS æ˜¯æŒ‡ç”±æä¾›å•†ä¸ºæ‚¨ç®¡ç†åº”ç”¨ã€‚æä¾›å•†å°†è´Ÿè´£å¤„ç†è½¯ä»¶æ›´æ–°ã€æ¼æ´ä¿®å¤åŠå…¶ä»–å¸¸è§„è½¯ä»¶ç»´æŠ¤å·¥ä½œï¼Œè€Œæ‚¨åªç”¨é€šè¿‡ Web æµè§ˆå™¨æˆ– API è¿æ¥è‡³è½¯ä»¶ã€‚è¿™æ ·ä¸€æ¥ï¼Œæ‚¨å°±æ— éœ€åœ¨æ¯å°è®¡ç®—æœºä¸Šå®‰è£…åº”ç”¨ã€‚\n","categories":["çŸ¥è¯†åº“"]},{"title":"ä»£ç†è¯¦è§£","url":"/posts/53164/","content":"OSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹\nTCP/IP å››å±‚æ¨¡å‹\nä¸€ã€ä»£ç†æ˜¯ä»€ä¹ˆä»£ç†ï¼ˆè‹±è¯­ï¼šProxyï¼‰ä¹Ÿç§°ç½‘ç»œä»£ç†ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç½‘ç»œæœåŠ¡ï¼Œå…è®¸ä¸€ä¸ªç½‘ç»œç»ˆç«¯ï¼ˆä¸€èˆ¬ä¸ºå®¢æˆ·ç«¯ï¼‰é€šè¿‡è¿™ä¸ªæœåŠ¡ä¸å¦ä¸€ä¸ªç½‘ç»œç»ˆç«¯ï¼ˆä¸€èˆ¬ä¸ºæœåŠ¡å™¨ï¼‰è¿›è¡Œéç›´æ¥çš„è¿æ¥ã€‚ä¸€äº›ç½‘å…³ã€è·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡å…·å¤‡ç½‘ç»œä»£ç†åŠŸèƒ½ã€‚ä¸€èˆ¬è®¤ä¸ºä»£ç†æœåŠ¡æœ‰åˆ©äºä¿éšœç½‘ç»œç»ˆç«¯çš„éšç§æˆ–å®‰å…¨ï¼Œé˜²æ­¢æ”»å‡»ã€‚\näºŒã€æ­£å‘ä»£ç†ä¸åå‘ä»£ç†æœ¬è´¨ä¸Šæ¥è®²ï¼Œä»£ç†éƒ½æ˜¯å­˜åœ¨äºClientä¸Serverä¹‹é—´çš„ï¼Œä½†ç”±äºæ€§è´¨ä¸åŒåˆ†ä¸ºäº†ä¸¤ç§ã€‚\nä¸¾ä¸ªä¾‹å­å‡è®¾Aã€Bã€Cä¸‰ä¸ªäººä¹‹é—´å­˜åœ¨å€Ÿé’±çš„å…³ç³»ã€‚\næ­£å‘ä»£ç†ï¼š\n\nAéœ€è¦é’±ï¼ŒAçŸ¥é“Cæœ‰å¾ˆå¤šé’±ï¼Œæƒ³å‘Cå€Ÿé’±\nä½†æ˜¯Aå’ŒCæœ‰çŸ›ç›¾ï¼Œäºæ˜¯Aæƒ³é€šè¿‡Bå»å€ŸCçš„é’±\nBå‘Cå€Ÿåˆ°äº†é’±ï¼ŒCä¸çŸ¥é“Açš„å­˜åœ¨\næœ€ç»ˆBå¸®åŠ©Aå€Ÿåˆ°äº†Cçš„é’±\n\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒBå……å½“äº†ä»£ç†çš„è§’è‰²ï¼Œä»£æ›¿Aæ‰¾Cå€Ÿé’±ï¼ŒCå¯¹Aæ˜¯æ— æ„ŸçŸ¥çš„ï¼Œè¿™æ˜¯æ­£å‘ä»£ç†ã€‚\nå…¶ä¸­Aæ˜¯Clientï¼ŒCæ˜¯Serverã€‚\næ¯”å¦‚è¯´ç¿»å¢™ï¼Œæˆ‘ä»¬å°±æ˜¯Clientï¼Œé€šè¿‡ä»£ç†ï¼Œè®¿é—®åˆ°äº†Googleã€‚\nåå‘ä»£ç†ï¼š\n\nAéœ€è¦é’±ï¼ŒCæœ‰å¾ˆå¤šé’±ï¼Œä½†Aä¸çŸ¥é“Cæœ‰å¾ˆå¤šé’±\nAæ‰¾Bå€Ÿé’±\nBçŸ¥é“Cæœ‰å¾ˆå¤šé’±\nBå‘Cå€Ÿé’±ï¼Œå¹¶æŠŠä»Cå€Ÿåˆ°çš„é’±ç»™äº†A\nAä¸çŸ¥é“Cçš„å­˜åœ¨ï¼Œä»¥ä¸ºé’±æ˜¯Bçš„\n\nè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒBå……å½“äº†ä»£ç†å€Ÿé’±å€Ÿé’±çš„è§’è‰²ï¼Œä¸è¿‡ä¸æ˜¯æ›¿Aå€Ÿçš„ï¼Œè€Œæ˜¯æ‰¾Cå€Ÿé’±ç„¶åç»™Aäº†ï¼Œæ¢è¨€ä¹‹å°±æ˜¯ä»£æ›¿Cå°†é’±å€Ÿç»™äº†Aï¼ŒåŒæ—¶Aå’ŒCç›¸äº’æ— æ„ŸçŸ¥ï¼Œè¿™å°±æ˜¯åå‘ä»£ç†ã€‚\nå…¶ä¸­Aè¿˜æ˜¯Clientï¼ŒCæ˜¯Serverã€‚\næ¯”å¦‚Nginxçš„ä»£ç†å°±æ˜¯åå‘ä»£ç†ã€‚\nå®‰å…¨æ¨¡å‹ä¸åŒ\næ­£å‘ä»£ç†å…è®¸å®¢æˆ·ç«¯é€šè¿‡å®ƒè®¿é—®ä»»æ„ç½‘ç«™å¹¶ä¸”éšè—å®¢æˆ·ç«¯è‡ªèº«ï¼Œå› æ­¤å¿…é¡»é‡‡å–å®‰å…¨æªæ–½ä»¥ç¡®ä¿ä»…ä¸ºæˆæƒçš„å®¢æˆ·ç«¯æä¾›æœåŠ¡\nåå‘ä»£ç†éƒ½å¯¹å¤–éƒ½æ˜¯é€æ˜çš„ï¼Œè®¿é—®è€…å¹¶ä¸çŸ¥é“è‡ªå·±è®¿é—®çš„æ˜¯ä»£ç†ï¼Œè®¿é—®è€…ä¸çŸ¥é“æœåŠ¡èŠ‚ç‚¹çš„å­˜åœ¨ï¼Œè®¤ä¸ºå¤„ç†è¯·æ±‚çš„å°±æ˜¯ä»£ç†èŠ‚ç‚¹\n\næ€»è€Œè¨€ä¹‹ï¼Œæ­£å‘ä»£ç†æ˜¯ä»å®¢æˆ·ç«¯çš„è§’åº¦å‡ºå‘ï¼ŒæœåŠ¡äºå±€åŸŸç½‘ç”¨æˆ·ï¼Œä»¥è®¿é—®éç‰¹å®šçš„æœåŠ¡ï¼Œå…¶ä¸­æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯ç¿»å¢™ã€‚\nåå‘ä»£ç†æ­£å¥½ä¸æ­¤ç›¸åï¼Œä»æœåŠ¡ç«¯çš„è§’åº¦å‡ºå‘ï¼ŒæœåŠ¡äºæ‰€æœ‰ç”¨æˆ·ï¼Œéšè—å®é™…çš„æœåŠ¡èŠ‚ç‚¹ï¼ŒæœåŠ¡èŠ‚ç‚¹çš„æ¶æ„å¯¹ç”¨æˆ·é€æ˜ï¼Œä»¥ä»£ç†èŠ‚ç‚¹ç»Ÿä¸€å¯¹å¤–æœåŠ¡ã€‚\nä¸‰ã€å››å±‚ä»£ç†å¦‚æœè¯´ç½‘ç»œå±‚é€šä¿¡çš„ç²’åº¦æ˜¯ç‰©ç†ç»ˆç«¯è®¾å¤‡çš„è¯ï¼ŒIP å°±æ˜¯æ ‡è¯†ä¸åŒç‰©ç†è®¾å¤‡çš„æ ‡è¯†ç¬¦ã€‚\né‚£ä¹ˆä¼ è¾“å±‚é€šä¿¡çš„ç²’åº¦å°±æ˜¯è¿›ç¨‹ï¼Œç«¯å£å°±æ˜¯æ ‡è¯†ä¸åŒè¿›ç¨‹çš„æ ‡è¯†ç¬¦ã€‚\nå››å±‚ä»£ç†çš„å››å±‚å°±æ˜¯OSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹ä¸­çš„ ä¼ è¾“å±‚ã€‚\nå››å±‚ä»£ç†æ˜¯åŸºäº IP + ç«¯å£ åšçš„ä»£ç†ã€‚é€šè¿‡ è™šæ‹ŸIP + ç«¯å£ æ¥æ”¶è¯·æ±‚ï¼Œç„¶åå†åˆ†é…åˆ°çœŸå®çš„æœåŠ¡å™¨ã€‚\nä¸¾ä¸ªæ —å­ä»¥å¸¸è§çš„TCPä¸ºä¾‹ï¼Œä»ä¸‰æ¬¡æ¡æ‰‹çš„ç¬¬ä¸€æ¬¡æ¡æ‰‹å¼€å§‹ï¼Œä»£ç†è®¾å¤‡åœ¨æ¥æ”¶åˆ°ç¬¬ä¸€ä¸ªæ¥è‡ªå®¢æˆ·ç«¯çš„ SYN è¯·æ±‚æ—¶ï¼Œå³æŒ‰ç…§ä¸€å®šçš„ç­–ç•¥é€‰æ‹©ä¸€ä¸ªè¢«ä»£ç†çš„åç«¯æœåŠ¡å™¨ï¼Œå¹¶å¯¹æŠ¥æ–‡ä¸­çš„ ç›®æ ‡IPåœ°å€ è¿›è¡Œä¿®æ”¹ï¼ˆæ”¹ä¸ºåç«¯æœåŠ¡å™¨IPï¼‰ï¼Œç›´æ¥è½¬å‘ç»™è¯¥æœåŠ¡å™¨ã€‚\nTCP è¿æ¥å»ºç«‹ï¼Œå³ä¸‰æ¬¡æ¡æ‰‹ï¼Œå®é™…ä¸Šæ˜¯å®¢æˆ·ç«¯å’Œåç«¯æœåŠ¡å™¨å»ºç«‹çš„ï¼Œä»£ç†è®¾å¤‡åªæ˜¯èµ·åˆ°ä¸€ä¸ªç±»ä¼¼è·¯ç”±å™¨çš„è½¬å‘åŠ¨ä½œã€‚\nåœ¨æŸäº›éƒ¨ç½²æƒ…å†µä¸‹ï¼Œä¸ºä¿è¯æœåŠ¡å™¨å›åŒ…å¯ä»¥æ­£ç¡®è¿”å›ç»™è´Ÿè½½å‡è¡¡è®¾å¤‡ï¼Œåœ¨è½¬å‘æŠ¥æ–‡çš„åŒæ—¶å¯èƒ½è¿˜ä¼šå¯¹æŠ¥æ–‡åŸæ¥çš„åŸåœ°å€è¿›è¡Œä¿®æ”¹ã€‚\nå‡¤å‡°æ¶æ„ä¸­å¯¹å››å±‚ä»£ç†çš„æè¿°ç°åœ¨æ‰€è¯´çš„ â€œå››å±‚è´Ÿè½½å‡è¡¡â€ å…¶å®æ˜¯å¤šç§å‡è¡¡å™¨å·¥ä½œæ¨¡å¼çš„ç»Ÿç§°ï¼Œâ€œå››å±‚â€æ˜¯è¯´è¿™äº›å·¥ä½œæ¨¡å¼çš„å…±åŒç‰¹ç‚¹æ˜¯ç»´æŒåŒä¸€ä¸ª TCP è¿æ¥ï¼Œè€Œä¸æ˜¯è¯´å®ƒåªå·¥ä½œåœ¨ç¬¬å››å±‚ã€‚\näº‹å®ä¸Šï¼Œè¿™äº›æ¨¡å¼ä¸»è¦éƒ½å·¥ä½œåœ¨ç¬¬äºŒå±‚ï¼ˆæ•°æ®é“¾è·¯å±‚ï¼Œæ”¹å†™ MAC åœ°å€ï¼‰å’Œç¬¬ä¸‰å±‚ï¼ˆç½‘ç»œå±‚ï¼Œæ”¹å†™ IP åœ°å€ï¼‰ä¸Šï¼Œå•çº¯åªå¤„ç†ç¬¬å››å±‚ï¼ˆä¼ è¾“å±‚ï¼Œå¯ä»¥æ”¹å†™ TCPã€UDP ç­‰åè®®çš„å†…å®¹å’Œç«¯å£ï¼‰çš„æ•°æ®æ— æ³•åšåˆ°è´Ÿè½½å‡è¡¡çš„è½¬å‘ï¼Œå› ä¸º OSI çš„ä¸‹ä¸‰å±‚æ˜¯åª’ä½“å±‚ï¼ˆMedia Layerï¼‰ï¼Œä¸Šå››å±‚æ˜¯ä¸»æœºå±‚ï¼ˆHost Layerï¼‰ï¼Œæ—¢ç„¶æµé‡éƒ½å·²ç»åˆ°è¾¾ç›®æ ‡ä¸»æœºä¸Šäº†ï¼Œä¹Ÿå°±è°ˆä¸ä¸Šä»€ä¹ˆæµé‡è½¬å‘ï¼Œæœ€å¤šåªèƒ½åšä»£ç†ã€‚\nå››ã€ä¸ƒå±‚ä»£ç†ä¸ƒå±‚ä»£ç†ä¸­çš„ä¸ƒå±‚å°±æ˜¯OSIä¸ƒå±‚ç½‘ç»œæ¨¡å‹ä¸­çš„ åº”ç”¨å±‚ã€‚\nä¸ƒå±‚ä»£ç†æ˜¯åŸºäºæ•°æ®å†…å®¹åšçš„ä»£ç†ï¼ˆåº”ç”¨å±‚ä¸­çš„åº”ç”¨æ•°æ®ï¼‰ï¼Œæœ€ç»ˆçš„è½¬å‘è§„åˆ™å–å†³äºå†…å®¹çš„å·®å¼‚ã€‚\né‰´äºä¸ƒå±‚åº”ç”¨åè®®éå¸¸å¹¿æ³›ï¼Œç°åœ¨çš„ä¸ƒå±‚ä»£ç†ä¸»è¦æ˜¯æŒ‡ HTTP ä»£ç†ã€‚\nä¸å››å±‚ä»£ç†çš„ä¸åŒä¸ƒå±‚ä»£ç†å¿…é¡»è¦å…ˆå’Œä»£ç†è®¾å¤‡ä¸‰æ¬¡æ¡æ‰‹åï¼Œæ‰èƒ½å¾—åˆ°ä¸ƒå±‚ï¼ˆHTTPå±‚ï¼‰çš„å…·ä½“å†…å®¹ï¼Œç„¶åå†è½¬å‘ã€‚\nä¹Ÿå°±æ˜¯è¯´ ä»£ç†æœºå¿…é¡»è¦ä¸å®¢æˆ·ç«¯å’Œåç«¯æœåŠ¡å™¨çš„æœºå™¨éƒ½è¦å»ºç«‹è¿æ¥ã€‚\næ˜¾ç„¶ï¼Œä¸ƒå±‚ä»£ç†å¯¹ä»£ç†è®¾å¤‡çš„æ€§èƒ½è¦æ±‚è¦é«˜äºå››å±‚ä»£ç†ã€‚\nä¸ƒå±‚ä»£ç†çš„å¥½å¤„å¹³å¸¸ä½¿ç”¨çš„Nginxï¼Œç”¨ä½œä»£ç†æœåŠ¡å™¨çš„æ—¶å€™ä¸€èˆ¬éƒ½æ˜¯å·¥ä½œåœ¨ç¬¬ä¸ƒå±‚çš„ã€‚ä½¿ç”¨Nginxï¼Œæˆ‘ä»¬å¯ä»¥ä»£ç†é™æ€æ–‡ä»¶ã€ajaxåå°æ¥å£ã€CDNé‡å®šå‘ç­‰ï¼Œéƒ½æ˜¯åœ¨ä¼ è¾“å±‚ä¹‹ä¸Šç†è§£å†…å®¹ååšçš„å·¥ä½œã€‚\nï¼ˆ1ï¼‰ä½¿æ•´ä¸ªç½‘ç»œæ›´æ™ºèƒ½åŒ–ä¾‹å¦‚è®¿é—®ä¸€ä¸ªç½‘ç«™çš„ç”¨æˆ·æµé‡ï¼Œå¯ä»¥é€šè¿‡ä¸ƒå±‚çš„æ–¹å¼ï¼Œå°†å¯¹å›¾ç‰‡ç±»çš„è¯·æ±‚è½¬å‘åˆ°ç‰¹å®šçš„å›¾ç‰‡æœåŠ¡å™¨å¹¶å¯ä»¥ä½¿ç”¨ç¼“å­˜æŠ€æœ¯ï¼›\nå°†å¯¹æ–‡å­—ç±»çš„è¯·æ±‚å¯ä»¥è½¬å‘åˆ°ç‰¹å®šçš„æ–‡å­—æœåŠ¡å™¨å¹¶å¯ä»¥ä½¿ç”¨å‹ç¼©æŠ€æœ¯ã€‚\nå½“ç„¶è¿™åªæ˜¯ä¸ƒå±‚åº”ç”¨çš„ä¸€ä¸ªå°æ¡ˆä¾‹ï¼Œä»æŠ€æœ¯åŸç†ä¸Šï¼Œè¿™ç§æ–¹å¼å¯ä»¥å¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚å’ŒæœåŠ¡å™¨çš„å“åº”è¿›è¡Œä»»æ„æ„ä¹‰ä¸Šçš„ä¿®æ”¹ï¼Œæå¤§çš„æå‡äº†åº”ç”¨ç³»ç»Ÿåœ¨ç½‘ç»œå±‚çš„çµæ´»æ€§ã€‚\nå¾ˆå¤šåœ¨åå°ï¼Œä¾‹å¦‚Nginxæˆ–è€…Apacheä¸Šéƒ¨ç½²çš„åŠŸèƒ½å¯ä»¥å‰ç§»åˆ°è´Ÿè½½å‡è¡¡è®¾å¤‡ä¸Šï¼Œä¾‹å¦‚å®¢æˆ·è¯·æ±‚ä¸­çš„Headeré‡å†™ï¼ŒæœåŠ¡å™¨å“åº”ä¸­çš„å…³é”®å­—è¿‡æ»¤æˆ–è€…å†…å®¹æ’å…¥ç­‰åŠŸèƒ½ã€‚\nï¼ˆ2ï¼‰å®‰å…¨æ€§ç½‘ç»œä¸­æœ€å¸¸è§çš„SYN Floodæ”»å‡»ï¼Œå³é»‘å®¢æ§åˆ¶ä¼—å¤šæºå®¢æˆ·ç«¯ï¼Œä½¿ç”¨è™šå‡IPåœ°å€å¯¹åŒä¸€ç›®æ ‡å‘é€SYNæ”»å‡»ã€‚\né€šå¸¸è¿™ç§æ”»å‡»ä¼šå¤§é‡å‘é€SYNæŠ¥æ–‡ï¼Œè€—å°½æœåŠ¡å™¨ä¸Šçš„ç›¸å…³èµ„æºï¼Œä»¥è¾¾åˆ°Denial of Service(DoS)çš„ç›®çš„ã€‚\nä»æŠ€æœ¯åŸç†ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œå››å±‚æ¨¡å¼ä¸‹è¿™äº›SYNæ”»å‡»éƒ½ä¼šè¢«è½¬å‘åˆ°åç«¯çš„æœåŠ¡å™¨ä¸Šã€‚\nè€Œä¸ƒå±‚æ¨¡å¼ä¸‹è¿™äº›SYNæ”»å‡»è‡ªç„¶åœ¨è´Ÿè½½å‡è¡¡è®¾å¤‡ä¸Šå°±æˆªæ­¢ï¼Œä¸ä¼šå½±å“åå°æœåŠ¡å™¨çš„æ­£å¸¸è¿è¥ã€‚\nå¦å¤–è´Ÿè½½å‡è¡¡è®¾å¤‡å¯ä»¥åœ¨ä¸ƒå±‚å±‚é¢è®¾å®šå¤šç§ç­–ç•¥ï¼Œè¿‡æ»¤ç‰¹å®šæŠ¥æ–‡ï¼Œä¾‹å¦‚SQL Injectionç­‰åº”ç”¨å±‚é¢çš„ç‰¹å®šæ”»å‡»æ‰‹æ®µï¼Œä»åº”ç”¨å±‚é¢è¿›ä¸€æ­¥æé«˜ç³»ç»Ÿæ•´ä½“å®‰å…¨ã€‚\nå°ç»“ç°åœ¨çš„ä¸ƒå±‚ä»£ç†ï¼Œä¸»è¦è¿˜æ˜¯ç€é‡äºåº”ç”¨HTTPåè®®ï¼Œæ‰€ä»¥å…¶åº”ç”¨èŒƒå›´ä¸»è¦æ˜¯ä¼—å¤šçš„ç½‘ç«™æˆ–è€…å†…éƒ¨ä¿¡æ¯å¹³å°ç­‰åŸºäºB/Så¼€å‘çš„ç³»ç»Ÿã€‚\nå››å±‚ä»£ç†åˆ™å¯¹åº”å…¶ä»–TCPåº”ç”¨ï¼Œä¾‹å¦‚åŸºäºC/Så¼€å‘çš„ç³»ç»Ÿã€‚\n","categories":["çŸ¥è¯†åº“"]},{"title":"æœ€å¤§QPSæ¨ç®—","url":"/posts/42351/","content":"ä¸€ã€RTRT = ThreadCPUTime + ThreadWaitTime\nRTï¼ˆResponse Timeï¼‰å³å“åº”æ—¶é—´ã€‚\nå¯ä»¥ç†è§£ä¸ºç³»ç»Ÿä»è¾“å…¥åˆ°è¾“å‡ºçš„æ—¶é—´é—´éš”ï¼Œç³»ç»Ÿæ˜¯æŒ‡ä¸€ä¸ªç½‘ç«™æˆ–å…¶ä»–ç±»å‹çš„è½¯ä»¶åº”ç”¨ï¼Œæˆ–è€…æŒ‡æŸä¸ªè®¾å¤‡ï¼Œæ¯”å¦‚æ‰‹æœºï¼Œæ‰‹æœºç•Œé¢ä¹Ÿæœ‰å“åº”æ—¶é—´ã€‚\næ‰€ä»¥RTæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¹¿æ³›çš„æ¦‚å¿µï¼Œä¸è¿‡æœ¬ç« æ¢è®¨çš„RTéƒ½æ˜¯ç‰¹æŒ‡äº’è”ç½‘åº”ç”¨ã€‚\næœåŠ¡å™¨ç«¯RTï¼šæŒ‡ä»æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚åˆ°è¯¥è¯·æ±‚å“åº”çš„å…¨éƒ¨æ•°æ®è¢«å‘å¾€å®¢æˆ·ç«¯çš„æ—¶é—´\nå®¢æˆ·ç«¯RTï¼šä»å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚æµè§ˆå™¨ï¼‰å‘èµ·è¯·æ±‚åˆ°å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¯·æ±‚å“åº”çš„å…¨éƒ¨æ•°æ®çš„æ—¶é—´é—´éš”ã€‚\næœåŠ¡ç«¯RT + ç½‘ç»œå¼€é”€ â‰ˆ å®¢æˆ·ç«¯RT\nä¹Ÿå°±æ˜¯è¯´ä¸€ä¸ªå·®çš„ç½‘ç»œç¯å¢ƒä¼šå¯¼è‡´ä¸¤ä¸ªRTå·®è·æ‚¬æ®Šï¼Œæ¯”å¦‚ä»å›½å¤–åˆ°å›½å†…çš„RTè¿œå¤§äºå›½å†…ç½‘ç»œç¯å¢ƒä¸­çš„RTã€‚\nå®¢æˆ·ç«¯çš„RTç›´æ¥å½±å“ç”¨æˆ·ä½“éªŒï¼Œè¦æƒ³é™ä½å®¢æˆ·ç«¯RTï¼Œéœ€è¦è€ƒè™‘äº®ç‚¹ï¼š\n\næœåŠ¡å™¨ç«¯RT\nç½‘ç»œ\n\nå¯¹äºç½‘ç»œæ¥è¯´ï¼Œå¸¸è§çš„ä¼˜åŒ–æ–¹å¼æœ‰CDNã€ANDå’Œä¸“çº¿ï¼Œåˆ†åˆ«é€‚ç”¨äºä¸åŒçš„åœºæ™¯ã€‚\nå¯¹äºæœåŠ¡ç«¯çš„RTæ¥è¯´ï¼Œä¸»è¦çœ‹æœåŠ¡ç«¯çš„åšæ³•ã€‚\nä»ä¸Šè¾¹çš„å…¬å¼å¯ä»¥çœ‹å‡ºï¼Œè¦æƒ³é™ä½ RTï¼Œå¯ä»¥é€šè¿‡é™ä½ ThreadCPUTime å’Œ ThreadWaitTime çš„æ–¹å¼ã€‚\nåé¢å°†ä» RTã€ThreadCPUTime å’Œ ThreadWaitTime æ¥è¿›è¡Œè®¨è®ºã€‚\näºŒã€å•çº¿ç¨‹QPSä¸Šä¸€èŠ‚ä¸­ç®€å•åœ°å®šä¹‰äº†RTç”± ThreadCPUTime å’Œ ThreadWaitTime ä¸¤éƒ¨åˆ†ç»„æˆã€‚\nå¦‚æœç³»ç»Ÿé‡Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹æˆ–è€…ä¸€ä¸ªè¿›ç¨‹ï¼ˆè¯¥è¿›ç¨‹ä¸­åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼‰ï¼Œé‚£ä¹ˆæœ€å¤§QPSæ˜¯å¤šå°‘ï¼Ÿ\nå‡è®¾RTæ˜¯199msï¼Œå…¶ä¸­ThreadCPUTime ä¸º19msï¼ŒThreadWaitTime ä¸º 180msï¼Œ\né‚£ä¹ˆ1000mså†…ç³»ç»Ÿå¯ä»¥æ¥æ”¶çš„æœ€å¤§è¯·æ±‚æ•°å°±æ˜¯ 1000ms/(19ms+180ms) â‰ˆ 5.025ã€‚\næ‰€ä»¥å•çº¿ç¨‹çš„ QPS = 1000ms / RT\nä¸‰ã€æœ€ä½³çº¿ç¨‹æ•°è¿˜æ˜¯ä¸Šè¾¹çš„ä¾‹å­ï¼Œå‡è®¾CPUæ ¸æ•°æ˜¯1.\nå‡è®¾åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨æ‰§è¡ŒæŸä¸ªè¯·æ±‚æ—¶ï¼ŒCPUçœŸæ­£èŠ±åœ¨è¯¥çº¿ç¨‹ä¸Šçš„æ—¶é—´å°±æ˜¯ ThreadCPUTimeï¼Œå³19msã€‚\né‚£ä¹ˆåœ¨æ•´ä¸ªRTç”Ÿå‘½å‘¨æœŸä¸­ï¼Œè¿˜æœ‰180msçš„ ThreadWaitTimeï¼Œè¿™ä¸ªæ—¶é—´CPUåœ¨åšä»€ä¹ˆï¼Ÿ\nåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼ŒæŠ›å¼€ç³»ç»Ÿå±‚é¢çš„é—®é¢˜ï¼Œå¯ä»¥è®¤ä¸ºCPUåœ¨è¿™180mså†…ä»€ä¹ˆéƒ½æ²¡åšï¼Œè‡³å°‘å¯¹äºä¸šåŠ¡æ¥è¯´ä»€ä¹ˆéƒ½æ²¡åšã€‚\n1æ ¸çš„æƒ…å†µç”±äºæ¯ä¸ªè¯·æ±‚çš„æ¥æ”¶ï¼ŒCPUåªéœ€è¦å·¥ä½œ19msï¼Œæ‰€ä»¥åœ¨180msçš„æ—¶é—´å†…ï¼Œå¯ä»¥è®¤ä¸ºç³»ç»Ÿè¿˜å¯ä»¥é¢å¤–æ¥æ”¶ 180ms/19ms â‰ˆ 9 ä¸ªè¯·æ±‚ã€‚\nç”±äºåœ¨åŒæ­¥æ¨¡å‹ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚éœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œå› æ­¤éœ€è¦é¢å¤–çš„9ä¸ªçº¿ç¨‹æ¥å¤„ç†è¿™äº›ã€‚\næ‰€ä»¥1æ ¸çš„æœ€ä½³çº¿ç¨‹æ•°å°±æ˜¯ï¼š** (180ms + 19ms) / 19ms â‰ˆ 10 **\nå¤šçº¿ç¨‹ä¹‹åï¼ŒThreadCPUTime ä»19mså˜æˆäº†20msï¼Œè¿™1msçš„å·®å€¼è¡¨ç¤ºå¤šçº¿ç¨‹ä¹‹åçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€GCç­‰å¸¦æ¥çš„é¢å¤–å¼€é”€ï¼ˆJVMæƒ…å†µä¸‹ï¼‰ï¼Œè¿™é‡Œçš„1msåªæ˜¯ä¸€ä¸ªå‡è®¾ï¼Œå¯ä»¥æŠŠå®ƒçœ‹ä½œnã€‚\n2æ ¸çš„æƒ…å†µ1æ ¸çš„æƒ…å†µä¸‹å¯ä»¥æœ‰10ä¸ªçº¿ç¨‹ï¼Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œ2æ ¸çš„æœ€ä½³çº¿ç¨‹æ•°å¯ä»¥è®¤ä¸ºï¼š\n2 * (180ms + 20ms) / 20ms = 20\nCPUåˆ©ç”¨ç‡ä¸Šé¢ä¸¾çš„ä¾‹å­éƒ½æ˜¯åœ¨ CPUæ»¡è½½ çš„æƒ…å†µä¸‹ã€‚\næœ‰æ—¶ç”±äºæŸä¸ªç“¶é¢ˆï¼Œå¯¼è‡´CPUå¾—ä¸åˆ°æœ‰æ•ˆåˆ©ç”¨ã€‚æ¯”å¦‚2æ ¸çš„CPUï¼Œå› ä¸ºæŸä¸ªèµ„æºï¼Œå„è‡ªèŒèƒ½ä½¿ç”¨ä¸€åŠçš„æ•ˆèƒ½ï¼Œè¿™æ ·æ€»çš„CPUåˆ©ç”¨ç‡å°±å˜æˆäº† 50%ã€‚\nè¿™ç§æƒ…å†µä¸‹ï¼Œæœ€ä½³çº¿ç¨‹æ•°æ˜¯ï¼š50% * 2 * (180ms + 20ms) / 20ms = 10\næœ€ä½³çº¿ç¨‹æ•°å…¬å¼æ ¹æ®ä¸Šé¢çš„åˆ†æï¼Œæœ€ä½³çº¿ç¨‹æ•°å…¬å¼å¦‚ä¸‹ï¼šæœ€ä½³çº¿ç¨‹æ•° = (RT / ThreadCPUTime) * CPUæ ¸æ•° * CPUåˆ©ç”¨ç‡\nå½“ç„¶ï¼Œæœ€ä½³çº¿ç¨‹æ•°å…¬å¼ä¸æ˜¯ä»»æ„æ¨æµ‹çš„ï¼Œåœ¨ä¸€äº›æƒå¨è‘—ä½œä¸Šéƒ½æœ‰è®ºè¿°ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œå‡è®¾æœ€ä½³çº¿ç¨‹æ•°çš„å…¬å¼æ˜¯æ­£ç¡®çš„ã€‚\nå››ã€æœ€å¤§QPSæœ€å¤§QPSå…¬å¼æ¨å¯¼å‡è®¾çŸ¥é“æœ€ä½³çº¿ç¨‹æ•°ï¼Œä¹ŸçŸ¥é“æ¯ä¸ªçº¿ç¨‹çš„QPSï¼Œé‚£ä¹ˆçº¿ç¨‹æ•°âœ–ï¸æ¯ä¸ªçº¿ç¨‹çš„QPSï¼Œå³è¿™å°æœºå™¨åœ¨æœ€ä½³çº¿ç¨‹æ•°ä¸‹çš„QPSã€‚\n\næŠŠåˆ†å­ã€åˆ†æ¯å»çº¦æ•°\n\nåŒ–ç®€åå¾—\n\nä»å…¬å¼å¯å¯ä»¥çœ‹å‡ºï¼Œå†³å®šQPSçš„æ˜¯ ThreadCPUTimeã€CPUæ ¸æ•°ã€CPUåˆ©ç”¨ç‡ã€‚\nCPUæ ¸æ•°å¸ˆç”±ç¡¬ä»¶å†³å®šçš„ï¼ŒThreadCPUTime å’Œ CPUåˆ©ç”¨ç‡ä¸æˆ‘ä»¬çš„ä»£ç æ¯æ¯ç›¸å…³ã€‚\nè™½ç„¶å®è§‚ä¸Šæ˜¯æ­£ç¡®çš„ï¼Œä½†æ˜¯æ¨å¯¼çš„è¿‡ç¨‹è¿˜æ˜¯ç”±ä¸€ç‚¹ç‘•ç–µï¼Œå› ä¸ºå¤šçº¿ç¨‹ä¸‹çš„ ThreadCPUTime ï¼ˆæ¯”å¦‚é«˜å¹¶å‘ä¸‹çš„GCæ¬¡æ•°å¢åŠ ã€çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ï¼Œå¯¼è‡´ThreadCPUTimeå¢åŠ ï¼‰å’Œå•çº¿ç¨‹çš„ ThreadCPUTime æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥å¯¼è‡´æ¨ç®—å‡ºçš„ç»“æœå­˜åœ¨è¯¯å·®ã€‚\nThreadCPUTimeThreadCPUTime ä¸åªæ˜¯ä¸šåŠ¡é€»è¾‘æ‰€æ¶ˆè€—çš„CPUæ—¶é—´ï¼Œè€Œæ˜¯ä¸€æ¬¡è¯·æ±‚ä¸­æ‰€æœ‰ç¯èŠ‚ä¸Šæ¶ˆè€—çš„CPUæ—¶é—´ä¹‹å’Œã€‚\næ¯”å¦‚ï¼Œåœ¨webåº”ç”¨ä¸­ï¼Œä¸€ä¸ªè¯·æ±‚è¿‡æ¥çš„HTTPçš„è§£ææ‰€æ¶ˆè€—çš„CPUæ—¶é—´ã€è¿™ä¸ªè¯·æ±‚ä¸­RPCè°ƒç”¨çš„encodeå’Œdecodeæ‰€æ¶ˆè€—çš„CPUæ—¶é—´ï¼Œè¿™äº›éƒ½æ˜¯ ThreadCPUTime çš„ä¸€éƒ¨åˆ†ã€‚\næ‰€ä»¥å½±å“ ThreadCPUTime çš„å› ç´ æœ‰ä¸¤ä¸ªï¼š\n\næ•°æ®ç»“æ„\nç®—æ³•\n\nä¾‹å¦‚ï¼šHashé—®é¢˜ã€æ’åºä¸æŸ¥æ‰¾é—®é¢˜ã€çŠ¶æ€æœºé—®é¢˜ã€åºåˆ—åŒ–é—®é¢˜ç­‰ã€‚\nCPUåˆ©ç”¨ç‡CUPåˆ©ç”¨ç‡ä¸é«˜çš„æƒ…å†µæ˜¯ç»å¸¸å‘ç”Ÿçš„ï¼Œä»¥ä¸‹å› ç´ éƒ½ä¼šå½±å“CPUåˆ©ç”¨ç‡ï¼Œä»è€Œå½±å“ç³»ç»Ÿå¯ä»¥æ”¯æŒçš„æœ€å¤§QPSã€‚\nï¼ˆ1ï¼‰IOèƒ½åŠ›\nç£ç›˜IO\nç½‘ç»œIO\nå¸¦å®½ï¼šæ¯”å¦‚æŸå¤§ä¿ƒå‹æµ‹æ—¶ï¼Œç”±äºæŸä¸ªåº”ç”¨æ”¾åœ¨Tairä¸­çš„æ•°æ®é‡å¤§ï¼Œå¯¼è‡´Tairçš„æœºå™¨ç½‘å¡è·‘æ»¡\nç½‘ç»œé“¾è·¯ï¼šè¿˜æ˜¯å¤§ä¿ƒï¼Œå€Ÿç”¨äº†å…¶ä»–æ ¸å¿ƒäº¤æ¢æœºä¸‹çš„æœºå™¨ï¼Œå¯¼è‡´å®¢æˆ·ç«¯RTæ˜æ˜¾å¢åŠ \n\n\n\nï¼ˆ2ï¼‰æ•°æ®åº“è¿æ¥æ± å¹¶å‘èƒ½åŠ› = PoolWaitTime / RT(client) * PoolSize\nï¼ˆ3ï¼‰å†…å­˜ä¸è¶³GCå¤§é‡å ç”¨CPUï¼Œå¯¼è‡´ç»™ä¸šåŠ¡é€»è¾‘ä½¿ç”¨çš„CPUåˆ©ç”¨ç‡ä¸‹é™ï¼Œè€Œä¸”GCæ—¶è¿˜æ»¡è¶³Amdahlå®šå¾‹æ‰€å®šä¹‰çš„åœºæ™¯ã€‚\nï¼ˆ4ï¼‰å…±äº«èµ„æºçš„ç«äº‰æ¯”å¦‚å„ç§é”ç­–ç•¥ï¼ˆè¯»å†™é”ã€é”åˆ†ç¦»ç­‰ï¼‰ã€é˜»å¡é˜Ÿåˆ—ç­‰ã€‚\nï¼ˆ5ï¼‰ä¾èµ–çš„æœåŠ¡å¦‚RPCè°ƒç”¨å…¶ä»–æœåŠ¡ã€DBç­‰ã€‚\nï¼ˆ6ï¼‰çº¿ç¨‹æ•°æˆ–è¿›ç¨‹æ•°ï¼Œä¹ƒè‡³ç¼–ç¨‹æ¨¡å‹ï¼ˆåŒæ­¥æ¨¡å‹ã€å¼‚æ­¥æ¨¡å‹ï¼ŒæŸäº›åœºæ™¯é€‚åˆåŒæ­¥æ¨¡å‹ï¼ŒæŸäº›é€‚åˆå¼‚æ­¥æ¨¡å‹ï¼‰åœ¨å‹æµ‹è¿‡ç¨‹ä¸­ï¼Œå‡ºç°æœ€å¤šçš„æ˜¯ç½‘ç»œIOå±‚é¢çš„é—®é¢˜ã€GCå¤§é‡å ç”¨ ThreadCPUTime ä¹‹ç±»çš„é—®é¢˜ã€‚\nCPUæ ¸æ•°1.Amdahlå®šå¾‹ï¼ˆå®‰è¾¾å°”å®šå¾‹ï¼‰Amdahlå®šå¾‹æ˜¯ç”¨æ¥æè¿°å¯ä¼¸ç¼©æ€§çš„ã€‚\nå¯ä¼¸ç¼©æ€§æŒ‡ï¼šå½“å¢åŠ è®¡ç®—èµ„æºçš„æ—¶å€™ï¼Œå¦‚CPUã€å†…å­˜ã€å¸¦å®½ç­‰ï¼ŒQPSèƒ½å¤Ÿç›¸åº”åœ°è¿›è¡Œæ”¹è¿›ã€‚\nAmdahlåœ¨è®ºæ–‡ä¸­æŒ‡å‡ºï¼Œå¯ä¼¸ç¼©æ€§æ˜¯æŒ‡åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼ŒåŸºäºå¯å¹¶è¡ŒåŒ–å’Œä¸²è¡ŒåŒ–çš„ç»„ä»¶å„è‡ªæ‰€å çš„æ¯”ä¾‹ï¼Œå½“ç¨‹åºè·å¾—é¢å¤–çš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€å†…å­˜ç­‰ï¼‰æ—¶ï¼Œç³»ç»Ÿç†è®ºä¸Šèƒ½å¤Ÿè·å¾—çš„åŠ é€Ÿå€¼ï¼ˆQPSæˆ–è€…å…¶ä»–æŒ‡æ ‡å¯ä»¥ç¿»å‡ å€ï¼‰ã€‚\nç”¨å…¬å¼æ¥è¡¨ç¤ºï¼Œå¦‚æœFè¡¨ç¤ºå¿…é¡»ä¸²è¡ŒåŒ–æ‰§è¡Œçš„æ¯”ä¾‹ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªNæ ¸çš„CPUçš„æœºå™¨ä¸­ï¼Œ\nåŠ é€Ÿæ¯” = 1 / (F + (1 - F) / N)\nè¿™ä¸ªå…¬å¼ä»£è¡¨çš„æ„ä¹‰æ¯”è¾ƒå¹¿æ³›ï¼Œåœ¨é¡¹ç›®ç®¡ç†ä¸­æœ‰ä¸€å¥ç±»ä¼¼çš„è¯ï¼š\nä¸€ä¸ªå¥³äººç”Ÿä¸€ä¸ªå­©å­ï¼Œéœ€è¦9ä¸ªæœˆï¼Œä½†æ˜¯æ°¸è¿œä¸å¯èƒ½è®©9å¥³äººåœ¨ä¸€ä¸ªæœˆå†…å°±ç”Ÿä¸€ä¸ªå­©å­ã€‚\næ‹¿å…¬å¼å¥—ç”¨ä¸€ä¸‹ï¼Œè¿™é‡ŒF = 100%ï¼Œ9 ä¸ªå¥³äººè¡¨ç¤ºN = 9ï¼Œäºæ˜¯å°±æœ‰ 1 / (100% + (1 - 100%) / 9) = 1ï¼Œæ‰€ä»¥åŠ é€Ÿæ¯”ä¸º1ï¼Œç­‰äºæ²¡åŠ é€Ÿã€‚\n\n è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªå…¬å¼æè¿°çš„æ˜¯ï¼Œåœ¨å¢åŠ èµ„æºçš„æƒ…å†µä¸‹ç³»ç»Ÿçš„åŠ é€Ÿæ¯”ï¼Œè€Œä¸æ˜¯åœ¨èµ„æºä¸å˜çš„æƒ…å†µä¸‹ä¼˜åŒ–æ•°æ®ç»“æ„å’Œç®—æ³•ä¹‹åå¸¦æ¥çš„æå‡ã€‚\nä¼˜åŒ–æ•°æ®ç»“æ„å’Œç®—æ³•å¸¦æ¥çš„æå‡è¦çœ‹å‰æ–‡æœ€å¤§QPSå…¬å¼ã€‚\nä¸è¿‡è¿™ä¸¤ä¸ªå…¬å¼ä¹Ÿä¸æ˜¯å®Œå…¨æ²¡æœ‰è”ç³»ï¼Œåœ¨å¢åŠ èµ„æºçš„æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„è”ç³»è¿˜æ˜¯æ¯”è¾ƒç´§å¯†çš„ã€‚\n\n2.Gustafsonå®šå¾‹ï¼ˆå¤æ–¯å¡”å¤«æ£®å®šå¾‹ï¼‰è¯¥å®šå¾‹æ˜¯å¯¹Amdahlå®šå¾‹çš„è¡¥å……ï¼šS(P) = P - a * (P - 1)\nPæ˜¯å¤„ç†å™¨æ ¸æ•°ï¼Œaæ˜¯ä¸²è¡Œæ—¶é—´å æ€»æ‰§è¡Œæ—¶é—´çš„æ¯”ä¾‹ã€‚\nä¸Šè¾¹çš„æ¡ˆä¾‹å¥—ç”¨å…¬å¼ï¼ŒPä¸ºå¥³äººä¸ªæ•°9ï¼Œä¸²è¡Œæ¯”ä¾‹100%ã€‚\nSpeedup = 9 - 100% * (9 - 1) = 1ã€‚\nä¹Ÿå°±æ˜¯æ— æ³•åŠ é€Ÿã€‚\nè¿™ä¸¤ä¸ªå®šå¾‹æœ‰å…³ç³»å—ï¼Ÿæœ‰ï¼Œå®ƒä»¬æ˜¯ç›¸è¾…ç›¸æˆçš„ã€‚\nå‰è€…ä»ä¸²è¡Œå’Œå¹¶è¡Œæ‰§è¡Œæ—¶é—´çš„è§’åº¦æ¥æ¨å¯¼ï¼Œåè€…ä»ä¸²è¡Œå’Œå¹¶è¡Œçš„è®¡ç®—é‡è§’åº¦æ¥æ¨å¯¼ï¼Œä¸ç®¡å“ªä¸ªè§’åº¦ï¼Œæœ€ç»ˆçš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚\n3.CPUæ ¸æ•°ä¸Amdahlå®šå¾‹å…³ç³»é€šè¿‡æœ€å¤§QPSå…¬å¼ï¼Œç¬”è€…å‘ç°ï¼Œåœ¨CPU Timeå’ŒCPUåˆ©ç”¨ç‡ä¸å˜çš„æƒ…å†µä¸‹ï¼Œæ ¸æ•°è¶Šå¤šï¼ŒQPSå°±è¶Šå¤§ã€‚æ¯”å¦‚æ ¸æ•°ä»1åˆ°4ï¼Œåœ¨CPU Timeå’ŒCPUåˆ©ç”¨ç‡ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒåŠ é€Ÿæ¯”åº”è¯¥æ˜¯4ï¼Œæ‰€ä»¥QPSåº”è¯¥å¢åŠ 4å€ã€‚\nè¿™æ˜¯èµ„æºå¢åŠ ï¼ˆCPUæ ¸æ•°å¢åŠ ï¼‰çš„æƒ…å†µä¸‹çš„åŠ é€Ÿæ¯”ï¼Œä¹Ÿå¯ä»¥é€šè¿‡Amdahlå®šå¾‹æ¥è¡¡é‡ï¼Œè€ƒè™‘ä¸²è¡Œå’Œå¹¶è¡Œçš„æ¯”ä¾‹åœ¨å¢åŠ èµ„æºçš„æƒ…å†µä¸‹æ˜¯å¦ä¼šæ”¹å˜ã€‚ä¹Ÿå°±æ˜¯è¦è€ƒè™‘åœ¨Nå¢åŠ çš„æƒ…å†µä¸‹ï¼ŒFå—å“ªäº›å› ç´ çš„å½±å“ï¼š\nåªè¦Få¤§äº0ï¼Œæœ€å¤§QPSå°±ä¸ä¼šç¿»4å€ã€‚\nä¸€ä¸ªå…¬å¼è¯´è¦å¢åŠ 4å€ï¼Œä¸€ä¸ªå®šç†è¯´æ²¡æœ‰4å€ï¼Œäº’ç›¸çŸ›ç›¾ï¼Ÿ\nå…¶å®äº‹æƒ…æ˜¯è¿™æ ·çš„ï¼Œé€šè¿‡æœ€å¤§QPSå…¬å¼ï¼Œæˆ‘ä»¬å¾—çŸ¥ï¼Œå¦‚æœ ThreadCPUTime å’ŒCPUåˆ©ç”¨ç‡ä¸å˜ï¼Œæ ¸æ•°ä»1å¢åŠ åˆ°4ï¼ŒQPSä¼šç›¸åº”åœ°å¢åŠ 4å€ã€‚ä½†æ˜¯åœ¨å®é™…æƒ…å†µä¸‹ï¼Œå½“æ ¸æ•°å¢åŠ æ—¶ï¼ŒThreadCPUTime å’ŒCPUåˆ©ç”¨ç‡å¤§éƒ¨åˆ†æ—¶å€™æ˜¯å˜åŒ–çš„ï¼Œæ‰€ä»¥å‰é¢çš„å‡è®¾ä¸æˆç«‹ï¼Œå³ä¸€èˆ¬åœºæ™¯ä¸‹æœ€å¤§QPSä¸èƒ½å¢åŠ 4å€ã€‚\nä¸ºä»€ä¹ˆå¢åŠ è®¡ç®—èµ„æºæ—¶ï¼Œæœ€å¤§QPSå…¬å¼ä¸­çš„CPU Timeå’ŒCPUåˆ©ç”¨ç‡ä¼šå˜åŒ–ï¼ŒFä¹Ÿä¼šå˜åŒ–å‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»å®è§‚ä¸Šåˆ†æä¸€ä¸‹ï¼Œå¢åŠ è®¡ç®—èµ„æºæ—¶ï¼Œè¾¾åˆ°æ»¡è½½ï¼š\n\nQPSä¼šæ›´é«˜ï¼Œå•ä½æ—¶é—´å†…äº§ç”Ÿçš„å¯¹è±¡ä¼šæ›´å¤šã€‚åœ¨åŒç­‰æ¡ä»¶ä¸‹ï¼Œminor GCè¢«è§¦å‘çš„æ¬¡æ•°å¢åŠ ï¼Œè¿˜æœ‰äº›åœºæ™¯å‘ç”Ÿè¿‡å¯¹è±¡å¤šåˆ°å“åº”æ²¡è¿”å›å®ƒä»¬å°±è¿›äº†â€œè€å¹´ä»£â€ï¼Œä»è€Œfull GCè¢«è§¦å‘ã€‚å®è§‚ä¸Šï¼Œè¿™æ˜¯å±äºä¸²è¡Œçš„éƒ¨åˆ†ï¼Œå¯¹äºAmdahlå…¬å¼æ¥è¯´Fä¼šå—åˆ°å½±å“ï¼Œå¯¹äºæœ€å¤§QPSå…¬å¼æ¥è¯´ï¼ŒCPU Timeå’ŒCPUåˆ©ç”¨ç‡ä¹Ÿå—åˆ°å½±å“ã€‚\nåœ¨åŒæ­¥æ¨¡å‹ä¸‹å¤§é‡çš„çº¿ç¨‹åœ¨å®Œæˆä¸€æ¬¡è¯·æ±‚ä¸­ï¼Œä¸Šä¸‹æ–‡è¢«åˆ‡æ¢çš„æ¬¡æ•°å¤§å¤§å¢åŠ ã€‚\nå°¤å…¶æ˜¯åœ¨æœ‰ä¸²è¡Œæ¨¡å—çš„æ—¶å€™ï¼Œä¸²è¡Œçš„æ‰§è¡Œå’Œç­‰å¾…æ—¶é—´å¢åŠ ï¼ŒFä¼šå˜åŒ–ï¼ŒæŸäº›åœºæ™¯ä¸‹CPUåˆ©ç”¨ç‡ä¹Ÿè¾¾ä¸åˆ°ç†æƒ³æ•ˆæœï¼Œè¿™å–å†³äºä½ çš„ä»£ç ã€‚è¿™ä¹Ÿæ˜¯è¦åšé”åˆ†ç¦»ã€ä¸ºä»€ä¹ˆè¦ç¼©å°åŒæ­¥å—çš„åŸå› ã€‚å½“ç„¶è¿˜æœ‰é”è‡ªèº«çš„ä¼˜åŒ–ï¼Œæ¯”å¦‚åå‘ã€è‡ªæ—‹ã€è¯»å†™åˆ†ç¦»ç­‰æŠ€æœ¯ï¼Œéƒ½æ˜¯ä¸ºäº†ä¸æ–­åœ°å‡å°‘Amdahlå®šå¾‹ä¸­çš„Fï¼Œä¹Ÿæ˜¯ä¸ºäº†å‡å°‘ThreadCPUTimeï¼ˆé”æœ¬èº«çš„ä¼˜åŒ–ï¼‰ï¼Œæé«˜CPUåˆ©ç”¨ç‡ï¼ˆä½¿ç”¨é”çš„æ–¹æ³•çš„ä¼˜åŒ–ï¼‰ã€‚\né”æœ¬èº«çš„ä¼˜åŒ–æœ€ä¸ºæ´¥æ´¥ä¹é“çš„æ˜¯è‡ªæ—‹ã€åå‘ã€è‡ªé€‚åº”ï¼Œè¿™äº›çŸ¥è¯†ç‚¹è¯·çœ‹ç½‘ä¸Šçš„synchronizedåˆ†æï¼Œè¿˜æœ‰reetrantLockçš„ä»£ç åŠAQSè®ºæ–‡ã€‚\nä½¿ç”¨é”çš„ä¼˜åŒ–æ–¹æ³•æœ€å¸¸è§çš„æ˜¯ç¼©å°é”åŒºé—´ã€é”åˆ†ç¦»ã€æ— é”åŒ–ã€volatileã€‚\n\n\n\næ‰€ä»¥åœ¨å¢åŠ è®¡ç®—èµ„æºæ—¶ï¼Œæ›´é«˜çš„å¹¶å‘äº§ç”Ÿï¼Œä¼šå¼•èµ·æœ€å¤§QPSå…¬å¼ä¸­ä¸¤ä¸ªå‚æ•°çš„å˜åŒ–ï¼Œä¹Ÿä¼šå¼•èµ·Amdahlå®šå¾‹ä¸­Få€¼çš„å˜åŒ–ï¼ŒåŒæ—¶å…¬å¼å’Œå®šå¾‹å˜åŒ–çš„è¶‹åŠ¿æ˜¯ç›¸åŒçš„ã€‚Amdahlå®šå¾‹æ˜¯å¾—åˆ°å¹¿æ³›è®¤å¯çš„ï¼Œä¹Ÿæ˜¯å¾—åˆ°æ•°æ®éªŒè¯çš„ã€‚æœ€å¤§QPSå…¬å¼å¥½åƒæ²¡æœ‰äººéªŒè¯è¿‡ï¼Œè¿™é‡Œå¼•ç”¨ä¸€ä¸ªæ¯”è¾ƒæœ‰åçš„æµ‹è¯•ç»“æœã€‚\n\nä»å›¾ä¸­å¯ä»¥çœ‹å‡º\n\nå½“è®¡ç®—èµ„æºï¼ˆå¤„ç†å™¨æ•°é‡ï¼‰å¢åŠ æ—¶ï¼Œåœ¨ä¸²è¡Œéƒ¨åˆ†æ¯”ä¾‹ä¸å˜çš„æƒ…å†µä¸‹ï¼ŒCPUåˆ©ç”¨ç‡ä¸‹é™ã€‚\nå½“è®¡ç®—èµ„æºï¼ˆå¤„ç†å™¨æ•°é‡ï¼‰å¢åŠ æ—¶ï¼Œä¸²è¡Œå çš„æ¯”ä¾‹è¶Šå¤§ï¼ŒCPUåˆ©ç”¨ç‡ä¸‹é™å¾—è¶Šå¤šã€‚\n\nåŸæ–‡è¿æ¥ï¼šhttp://bjxiaoyu.com/newsde.html?id=77\n","categories":["çŸ¥è¯†åº“"]},{"title":"Sentinel","url":"/posts/38559/","content":"Spring Cloud Alibabaç»„ä»¶ç‰ˆæœ¬å¯¹åº”è¯´æ˜\nSentinel å®˜æ–¹æ–‡æ¡£\nSentinel é›†ç¾¤é™æµ\næœ¬æ–‡ä¾èµ–ç‰ˆæœ¬ï¼š\n\nSpring Bootï¼š2.6.6\n\nä¸€ã€Sentinel ä¾èµ–&lt;dependencyManagement&gt;    &lt;dependency&gt;        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;        &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;        &lt;version&gt;2021.0.1.0&lt;/version&gt;    &lt;/dependency&gt;&lt;/dependencyManagement&gt;&lt;dependency&gt;    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;&lt;/dependency&gt;\n\næœ¬æ–‡é‡‡ç”¨ Nacos ä½œä¸ºæ•°æ®æº\n&lt;dependency&gt;    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;    &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;    &lt;version&gt;1.8.4&lt;/version&gt;&lt;/dependency&gt;\n\näºŒã€å®‰è£… Nacoshttp://jzcupid.cn/posts/36267/\nä¸‰ã€å®‰è£… Sentinel æ§åˆ¶å°Sentinel  æ§åˆ¶å°é…ç½®\n1. åŸºäºDockeré•œåƒæ‹‰å–é•œåƒdocker pull bladex/sentinel-dashboard:1.8.0\n\nå®˜æ–¹æ²¡æœ‰æä¾›é•œåƒ\nè¿è¡Œæ§åˆ¶å°docker run -d --name sentinel -p 8858:8858 \\   -e auth.enabled=&quot;true&quot; \\   -e sentinel.dashboard.auth.username=admin \\   -e sentinel.dashboard.auth.password=admin \\   -e server.servlet.session.timeout=7200 \\   bladex/sentinel-dashboard:1.8.0\n\nè®¿é—®æ§åˆ¶å°ï¼šhttp://localhost:8858/\n2. åŸºäºæºç æºç ä»“åº“\næ§åˆ¶å°æºç ä½äº sentinel-dashboard æ¨¡å—ã€‚\né»˜è®¤åœ¨æ§åˆ¶å°ä¿®æ”¹è§„åˆ™åï¼Œæ— æ³•æŒä¹…åŒ–åˆ°æ•°æ®æºï¼ˆä¾‹å¦‚ï¼šNacosï¼‰ï¼Œå¯¹æºç è¿›è¡Œæ”¹é€ ï¼Œä½¿ç”¨ push æ¨¡å¼ï¼Œä½¿è§„åˆ™ä¿®æ”¹åè‡ªåŠ¨åŒæ­¥åˆ°æ•°æ®æºï¼Œè¿™é‡Œä»¥ Nacos ä¸ºä¾‹ã€‚\n1ï¼‰ä¿®æ”¹ POMå°† POM ä¸­ä¸‹è¾¹ä¾èµ–çš„ &lt;scope&gt;test&lt;/scope&gt; å»æ‰\n&lt;dependency&gt;  &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;  &lt;artifactId&gt;sentinel-datasource-nacos&lt;/artifactId&gt;  &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt;\n\nå°† sentinel-dashboard/src/test/java/com/alibaba/csp/sentinel/dashboard/rule/nacos ç›®å½•æ•´ä¸ªæ‹·è´åˆ° sentinel-dashboard/src/main/java/com/alibaba/csp/sentinel/dashboard/rule ç›®å½•ä¸‹ã€‚\nâš ï¸ nacos æœ€ç»ˆæ˜¯åœ¨ rule ç›®å½•ä¸‹çš„ã€‚\n2ï¼‰ä¿®æ”¹é…ç½®NacosConfig æ·»åŠ å¦‚ä¸‹é…ç½®ï¼ŒåŒæ—¶ç”±äºè¯¥ç±»é»˜è®¤åŠ è½½ Nacos é…ç½®æ—¶ç”¨çš„ nacosConfigService() æ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥è‡ªè¡Œå°è£…è¯¥æ–¹æ³•ã€‚\n@Beanpublic Converter&lt;List&lt;DegradeRuleEntity&gt;, String&gt; degradeRuleEntityEncoder() &#123;  return JSON::toJSONString;&#125;@Beanpublic Converter&lt;String, List&lt;DegradeRuleEntity&gt;&gt; degradeRuleEntityDecoder() &#123;  return s -&gt; JSON.parseArray(s, DegradeRuleEntity.class);&#125;@Beanpublic Converter&lt;List&lt;ParamFlowRuleEntity&gt;, String&gt; paramFlowRuleEntityEncoder() &#123;  return JSON::toJSONString;&#125;@Beanpublic Converter&lt;String, List&lt;ParamFlowRuleEntity&gt;&gt; paramFlowRuleEntityDecoder() &#123;  return s -&gt; JSON.parseArray(s, ParamFlowRuleEntity.class);&#125;@Beanpublic Converter&lt;List&lt;AuthorityRuleEntity&gt;, String&gt; authorityRuleEntityEncoder() &#123;  return JSON::toJSONString;&#125;@Beanpublic Converter&lt;String, List&lt;AuthorityRuleEntity&gt;&gt; authorityRuleEntityDecoder() &#123;  return s -&gt; JSON.parseArray(s, AuthorityRuleEntity.class);&#125;\n\nNacosConfigUtil ç±»æ·»åŠ \npublic static final String DEGRADE_DATA_ID_POSTFIX = &quot;-degrade-rules&quot;;public static final String AUTHORITY_DATA_ID_POSTFIX = &quot;-authority-rules&quot;;\n\n3ï¼‰è‡ªåŠ¨æ¨é€ Flow è§„åˆ™ä¿®æ”¹ com.alibaba.csp.sentinel.dashboard.controller.v2.FlowControllerV2 ç±»ã€‚\næ‰¾åˆ°å¦‚ä¸‹ä»£ç \n@Autowired@Qualifier(&quot;flowRuleDefaultProvider&quot;)private DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;@Autowired@Qualifier(&quot;flowRuleDefaultPublisher&quot;)private DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;\n\nä¿®æ”¹ä¸º\n@Autowired@Qualifier(&quot;flowRuleNacosProvider&quot;)private DynamicRuleProvider&lt;List&lt;FlowRuleEntity&gt;&gt; ruleProvider;@Autowired@Qualifier(&quot;flowRuleNacosPublisher&quot;)private DynamicRulePublisher&lt;List&lt;FlowRuleEntity&gt;&gt; rulePublisher;\n\nä¿®æ”¹çš„ Bean Name å¯åœ¨ä¸Šè¾¹æ‹·è´çš„ç±»ä¸­æ‰¾åˆ°ã€‚\nå‰ç«¯é¡µé¢ä¿®æ”¹\nå°† src/main/webapp/resources/app/scripts/directives/sidebar/sidebar.html ä¸­å¦‚ä¸‹ä»£ç çš„æ³¨é‡Šå»æ‰ã€‚\n&lt;!--&lt;li ui-sref-active=&quot;active&quot; ng-if=&quot;entry.appType==0&quot;&gt;--&gt;  &lt;!--&lt;a ui-sref=&quot;dashboard.flow(&#123;app: entry.app&#125;)&quot;&gt;--&gt;    &lt;!--&lt;i class=&quot;glyphicon glyphicon-filter&quot;&gt;&lt;/i&gt;&amp;nbsp;&amp;nbsp;æµæ§è§„åˆ™ V1&lt;/a&gt;--&gt;&lt;!--&lt;/li&gt;--&gt;\n\n4ï¼‰è‡ªåŠ¨æ¨é€ Degrade è§„åˆ™æ–°å¢ Publisher\nimport com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.DegradeRuleEntity;import com.alibaba.csp.sentinel.dashboard.rule.DynamicRulePublisher;import com.alibaba.csp.sentinel.datasource.Converter;import com.alibaba.csp.sentinel.util.AssertUtil;import com.alibaba.nacos.api.config.ConfigService;import java.util.List;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;/** * @Auther jd */@Component(&quot;degradeRuleNacosPublisher&quot;)public class DegradeRuleNacosPublisher implements DynamicRulePublisher&lt;List&lt;DegradeRuleEntity&gt;&gt; &#123;  @Autowired  private ConfigService configService;  @Autowired  private Converter&lt;List&lt;DegradeRuleEntity&gt;, String&gt; converter;  @Override  public void publish(String app, List&lt;DegradeRuleEntity&gt; rules) throws Exception &#123;    AssertUtil.notEmpty(app, &quot;app name cannot be empty&quot;);    if (rules == null) &#123;      return;    &#125;    boolean successed = configService.publishConfig(app + NacosConfigUtil.DEGRADE_DATA_ID_POSTFIX,        NacosConfigUtil.GROUP_ID, converter.convert(rules));    if (!successed) &#123;      throw new RuntimeException(&quot;publish degrade rule to nacos fail&quot;);    &#125;  &#125;&#125;\n\næ”¹é€  DegradeController\n@Autowiredprivate DegradeRuleNacosPublisher degradeRuleNacosPublisher;private boolean publishRules(String app, String ip, Integer port) &#123;  List&lt;DegradeRuleEntity&gt; rules = repository.findAllByMachine(MachineInfo.of(app, ip, port));  try &#123;    degradeRuleNacosPublisher.publish(app, rules);  &#125; catch (Exception e) &#123;    e.printStackTrace();  &#125;  return sentinelApiClient.setDegradeRuleOfMachine(app, ip, port, rules);&#125;\n\n5ï¼‰è‡ªåŠ¨æ¨é€ ParamFlow è§„åˆ™æ–°å¢ ParamFlowRulePublisher å®ç°å°†è§„åˆ™æ¨é€åˆ° Nacos\nimport com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.ParamFlowRuleEntity;import com.alibaba.csp.sentinel.dashboard.rule.DynamicRulePublisher;import com.alibaba.csp.sentinel.datasource.Converter;import com.alibaba.csp.sentinel.util.AssertUtil;import com.alibaba.nacos.api.config.ConfigService;import java.util.List;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;/** * @Auther jd */@Component(&quot;paramFlowRulePublisher&quot;)public class ParamFlowRulePublisher implements DynamicRulePublisher&lt;List&lt;ParamFlowRuleEntity&gt;&gt; &#123;  @Autowired  private ConfigService configService;  @Autowired  private Converter&lt;List&lt;ParamFlowRuleEntity&gt;, String&gt; converter;  @Override  public void publish(String app, List&lt;ParamFlowRuleEntity&gt; rules) throws Exception &#123;    AssertUtil.notEmpty(app, &quot;app name cannot be empty&quot;);    if (rules == null) &#123;      return;    &#125;    boolean successed = configService.publishConfig(app + NacosConfigUtil.PARAM_FLOW_DATA_ID_POSTFIX,        NacosConfigUtil.GROUP_ID, converter.convert(rules));    if (!successed) &#123;      throw new RuntimeException(&quot;publish param flow rule to nacos fail&quot;);    &#125;  &#125;&#125;\n\næ”¹é€  ParamFlowRuleController\n@Autowiredprivate ParamFlowRulePublisher paramFlowRulePublisher;private CompletableFuture&lt;Void&gt; publishRules(String app, String ip, Integer port) &#123;  List&lt;ParamFlowRuleEntity&gt; rules = repository.findAllByMachine(MachineInfo.of(app, ip, port));  try &#123;    paramFlowRulePublisher.publish(app, rules);  &#125; catch (Exception e) &#123;    e.printStackTrace();  &#125;  return sentinelApiClient.setParamFlowRuleOfMachine(app, ip, port, rules);&#125;\n\n6ï¼‰è‡ªåŠ¨æ¨é€ Authority è§„åˆ™æ–°å¢ AuthorityRuleNacosPublisher å°†è§„åˆ™æ¨é€åˆ° Nacos\nimport com.alibaba.csp.sentinel.dashboard.datasource.entity.rule.AuthorityRuleEntity;import com.alibaba.csp.sentinel.dashboard.rule.DynamicRulePublisher;import com.alibaba.csp.sentinel.datasource.Converter;import com.alibaba.csp.sentinel.util.AssertUtil;import com.alibaba.nacos.api.config.ConfigService;import java.util.List;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.stereotype.Component;/** * @Auther jd */@Component(&quot;authorityRuleNacosPublisher&quot;)public class AuthorityRuleNacosPublisher implements DynamicRulePublisher&lt;List&lt;AuthorityRuleEntity&gt;&gt; &#123;  @Autowired  private ConfigService configService;  @Autowired  private Converter&lt;List&lt;AuthorityRuleEntity&gt;, String&gt; converter;  @Override  public void publish(String app, List&lt;AuthorityRuleEntity&gt; rules) throws Exception &#123;    AssertUtil.notEmpty(app, &quot;app name cannot be empty&quot;);    if (rules == null) &#123;      return;    &#125;    boolean successed = configService.publishConfig(app + NacosConfigUtil.AUTHORITY_DATA_ID_POSTFIX,        NacosConfigUtil.GROUP_ID, converter.convert(rules));    if (!successed) &#123;      throw new RuntimeException(&quot;publish authority rule to nacos fail&quot;);    &#125;  &#125;&#125;\n\næ”¹é€  AuthorityRuleController\n@Autowiredprivate AuthorityRuleNacosPublisher authorityRuleNacosPublisher;private boolean publishRules(String app, String ip, Integer port) &#123;  List&lt;AuthorityRuleEntity&gt; rules = repository.findAllByMachine(MachineInfo.of(app, ip, port));  try &#123;    authorityRuleNacosPublisher.publish(app, rules);  &#125; catch (Exception e) &#123;    e.printStackTrace();  &#125;  return sentinelApiClient.setAuthorityRuleOfMachine(app, ip, port, rules);&#125;\n\n7ï¼‰ä½¿ç”¨æ§åˆ¶å°é»˜è®¤ç™»é™†ç”¨æˆ·åå’Œå¯†ç åœ¨é…ç½®æ–‡ä»¶ä¸­ auth.username å’Œ auth.password\nåœ¨ æµæ§è§„åˆ™ V1 èœå•é…ç½®çš„æµé‡è§„åˆ™å°†ä¼šåŒæ­¥åˆ° Nacosï¼ŒåŒæ—¶æœåŠ¡ä¹Ÿä¼šåº”ç”¨è¯¥è§„åˆ™ï¼Œéœ€è¦æ³¨æ„æœåŠ¡ä¸­é…ç½®çš„ Nacos é…ç½®æ–‡ä»¶çš„ dataId å’Œ groupId è¦ä¸ç”Ÿæˆçš„ä¸€è‡´ã€‚\nå››ã€Spring Boot æ·»åŠ é…ç½®spring:  application:    name: spring-cloud-demo-consumer  cloud:    # ä½¿ç”¨ Sentinel è¿›è¡Œæµé‡æ§åˆ¶    sentinel:      eager: true      # å–æ¶ˆæ§åˆ¶å°æ‡’åŠ è½½      transport:        port: 8732     # ä¸ŠæŠ¥ç»™æ§åˆ¶å°çš„ç«¯å£        dashboard: 127.0.0.1:8080        # æ§åˆ¶å°åœ°å€      datasource:        nacos-degrade:          nacos:            server-addr: 127.0.0.1:8848            namespace: public            username: nacos            password: nacos            dataId: $&#123;spring.application.name&#125;-degrade-rules            groupId: SENTINEL_GROUP        # éœ€è¦ä¸ Sentinel æ§åˆ¶å°çš„ GroupId ä¸€è‡´            data-type: json            rule-type: degrade        nacos-flow:          nacos:            server-addr: 127.0.0.1:8848            namespace: public            username: nacos            password: nacos            dataId: $&#123;spring.application.name&#125;-flow-rules            groupId: SENTINEL_GROUP        # éœ€è¦ä¸ Sentinel æ§åˆ¶å°çš„ GroupId ä¸€è‡´            data-type: json            rule-type: flow\n\n","categories":["è¿ç»´"],"tags":["SpringBoot","Spring","Sentinel"]},{"title":"SkyWalking","url":"/posts/15856/","content":"ä¸€ã€å®‰è£… SkyWalking1. å®‰è£… Elasticsearchdocker pull --platform linux/arm64/v8 elasticsearch:7.16.3docker run -d --name es \\    --platform linux/arm64/v8 \\    -p 9200:9200 -p 9300:9300 \\    -e &quot;discovery.type=single-node&quot; \\    -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; \\    elasticsearch:7.16.3\n\n1. å®‰è£… SkyWalking-OAP-Serverè¿™é‡Œæä¾› Elasticsearch å’Œ H2 ä½œä¸º storage çš„å®‰è£…ã€‚\nä½¿ç”¨ Elasticsearch ä½œä¸º storageå®‰è£… Elasticsearch\ndocker pull --platform linux/arm64/v8 elasticsearch:7.16.3docker run -d --name es \\    --platform linux/arm64/v8 \\    -p 9200:9200 -p 9300:9300 \\    -e &quot;discovery.type=single-node&quot; \\    -e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; \\    elasticsearch:7.16.3\n\nå®‰è£… SkyWalking-OAP-Server\ndocker pull --platform linux/arm64 apache/skywalking-oap-server:8.9.1docker run -d --name oap \\    -p 1234:1234 -p 11800:11800 -p 12800:12800 \\    --link es:elasticsearch \\    -e TZ=Asia/Shanghai \\    -e SW_STORAGE=elasticsearch \\    -e SW_STORAGE_ES_CLUSTER_NODES=elasticsearch:9200 \\    -e SW_NAMESPACE=oap \\    apache/skywalking-oap-server:8.9.1\n\n\nSW_STORAGEï¼šé€‰æ‹© elasticsearch é…ç½®ï¼Œè‹¥ä¸é€‰é»˜è®¤ä¸º H2\nSW_STORAGE_ES_CLUSTER_NODESï¼šelasticsearch åœ°å€\n\nä½¿ç”¨ H2 ä½œä¸º storagedocker run -d --name oap \\    -p 1234:1234 -p 11800:11800 -p 12800:12800 \\    -e TZ=Asia/Shanghai \\    apache/skywalking-oap-server:8.9.1\n\n3. å®‰è£… SkyWalking-UIdocker pull --platform linux/arm64 apache/skywalking-ui:8.9.1docker run -d --name ui \\    -p 8080:8080 \\    --link oap:oap \\    -e TZ=Asia/Shanghai \\    -e SW_OAP_ADDRESS=http://oap:12800 \\    apache/skywalking-ui:8.9.1\n\nè®¿é—®ç•Œé¢ï¼šhttp://localhost:8080/\nâš ï¸ SW_OAP_ADDRESS å¿…é¡»æ·»åŠ åè®®ç±»å‹ï¼Œå¦‚ï¼šhttp ã€‚\näºŒã€æœåŠ¡å¼•ç”¨ SkyWalkingSkeWalking Agents ä¸‹è½½åœ°å€ï¼šhttps://skywalking.apache.org/downloads/\nåœ¨é¡¹ç›®å¯åŠ¨æ—¶æ·»åŠ é…ç½®\nä¼˜å…ˆçº§ï¼šæ¢é’ˆ &gt; JVMé…ç½® &gt; ç³»ç»Ÿç¯å¢ƒå˜é‡ &gt; agent.config\næ¢é’ˆæ ¼å¼é…ç½®å¦‚ä¸‹ï¼š\nï¼ˆ1ï¼‰-javaagent:/path/to/skywalking-agent.jar={config1}={value1},{config2}={value2}-javaagent:/Users/xx/Desktop/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar=agent.service_name=demo,collector.backend_service=localhost:11800\n\nï¼ˆ2ï¼‰-Dskywalking.[option1]=[value2]-javaagent:/Users/xx/Desktop/apache-skywalking-apm-bin-es7/agent/skywalking-agent.jar -Dskywalking.agent.service_name=demo -Dskywalking.collector.backend_service=localhost:11800\n\n","categories":["è¿ç»´"],"tags":["é“¾è·¯è¿½è¸ª","SkyWalking"]},{"title":"æ­å»º Minio","url":"/posts/18302/","content":"Docker æ­å»º Miniodocker run -d -p 9000:9000 -p 9001:9001 --name minio\\  -e &quot;MINIO_ROOT_USER=admin&quot; \\  -e &quot;MINIO_ROOT_PASSWORD=12345678&quot; \\  minio/minio server /data --console-address &quot;:9001&quot;\n\n\néœ€è¦é€šè¿‡ --console-address &quot;:9001&quot; æŒ‡å®šæ§åˆ¶å°ç«¯å£ï¼Œä¸ç„¶è®¿é—®é¡µé¢ä¼šä¸€ç›´è½¬å‘åˆ«çš„ç«¯å£ã€‚\n9001 ä¸ºæ§åˆ¶å°ç«¯å£ï¼Œéœ€è¦ä¸ servier çš„ç«¯å£ä¸åŒã€‚\n\n","categories":["è¿ç»´"]},{"title":"æ­å»º Nacos","url":"/posts/36267/","content":"ä¸€ã€å•æœºç‰ˆæ‹‰å–é•œåƒdocker pull --platform linux/arm64 nacos/nacos-server:2.1.0-BETA\n\nå¯åŠ¨ Nacosdocker run -d --name nacos \\   -p 8848:8848 -p 9848:9848 \\   -e MODE=standalone \\   nacos/nacos-server:2.1.0-BETA\n\nè®¿é—® Nacos é¡µé¢ http://localhost:8848/nacos\né»˜è®¤è´¦å·å¯†ç ï¼šnacos/nacos\näºŒã€K8S æ­å»º Nacos é›†ç¾¤Nacos æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼Œå¯ä»¥æ ¹æ®ä¸åŒç‰ˆæœ¬é€‰æ‹© tagã€‚\nå®˜æ–¹yaml\n","categories":["è¿ç»´"]},{"title":"DDD & Microservices","url":"/posts/29601/","content":"Microservicesï¼ˆå¾®æœåŠ¡æ¶æ„ï¼‰å’ŒDDDï¼ˆé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼‰æ˜¯æ—¶ä¸‹æœ€ç‚™æ‰‹å¯çƒ­çš„ä¸¤ä¸ªæŠ€æœ¯è¯æ±‡ã€‚åœ¨æœ€è¿‘ä¸¤å¹´çš„å’¨è¯¢å·¥ä½œä¸­æ€»æ˜¯ä¼šè¢«ä¸åŒçš„å›¢é˜Ÿå’Œè§’è‰²è¯¢é—®ï¼Œç”±æ­¤ä¹Ÿä¿ƒä½¿æˆ‘æ€è€ƒä¸ºä»€ä¹ˆè¿™ä¸¤ä¸ªæŠ€æœ¯è¯æ±‡è¢«è¿™ä¹ˆæ·±å…¥äººå¿ƒçš„ç»‘å®šï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ\næœåŠ¡äºæ›´é«˜çš„ä¸šåŠ¡å“åº”åŠ›é¦–å…ˆä»ä¸¤ä¸ªè¯æ±‡çš„å‘æ˜æ¥çœ‹å®ƒä»¬æ˜¯æ²¡æœ‰å› æœå…³ç³»çš„ã€‚DDDæ˜¯Eric Evansäº2003å¹´å‡ºç‰ˆçš„ä¹¦åï¼ŒåŒæ—¶ä¹Ÿæ˜¯è¿™ä¸ªæ¶æ„è®¾è®¡æ–¹æ³•åçš„èµ·æºã€‚DDDçš„æƒ³æ³•æ˜¯è®©æˆ‘ä»¬çš„è½¯ä»¶å®ç°å’Œä¸€ä¸ªæ¼”è¿›çš„æ¶æ„æ¨¡å‹ä¿æŒä¸€è‡´ï¼Œè€Œè¿™ä¸ªæ¼”è¿›çš„æ¨¡å‹æ¥è‡ªäºæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ã€‚è¿™ç§æ¼”è¿›å¼è®¾è®¡æ–¹æ³•åœ¨å½“æ—¶çœ‹æ¥è¿˜æ˜¯æ¯”è¾ƒæŒ‘æˆ˜çš„ï¼Œæ›´ä¸ºæµè¡Œçš„è§£å†³æ¶æ„è®¾è®¡å¤æ‚åº¦çš„æ–¹æ³•æ˜¯åˆ†å±‚ï¼šæ¯”å¦‚æ•°æ®æ¶æ„ã€æœåŠ¡æ¶æ„ã€ä¸­é—´ä»¶æ¶æ„ç­‰ã€‚MVCåœ¨äº’è”ç½‘åº”ç”¨å¼€å‘é¢†åŸŸä¹ŸåŸºæœ¬æˆä¸ºäº†æ ‡é…ã€‚\næ—¶é—´å¾ˆå¿«è¿‡äº†10å¹´ï¼ŒMartin Fowlerå’ŒThoughtWorksè‹±å›½æ¶æ„å¸ˆJames Lewisåä¸‹æ¥ä¸€èµ·åˆ†æäº†å¥½å‡ ä¸ªèƒ½å¤ŸæŒç»­æ¼”è¿›çš„å¤§å‹å¤æ‚ç³»ç»Ÿï¼Œæ€»ç»“å‡ºäº†9å¤§æ ¸å¿ƒç‰¹è´¨ï¼Œç„¶åç”¨Microservicesæ¥å®šä¹‰äº†æ‹¥æœ‰è¿™äº›ç‰¹è´¨çš„æ¶æ„ã€‚ä¹‹åç”±äºGoogleã€Netflixã€Amazonç­‰ä¸€ç³»åˆ—æ˜æ˜Ÿä¼ä¸šéƒ½å¯¹å·å…¥åº§ï¼ŒMicroserviceså¼€å§‹é£é¡æ•´ä¸ªè½¯ä»¶ä¸šã€‚è¿™æ—¶å€™å¾ˆå¤šäººä¼šé—®å¾®æœåŠ¡æ¶æ„æ˜¯æ€ä¹ˆè®¾è®¡å‡ºæ¥çš„ï¼Œä¸šç•Œäººå£«ä¼šè¯´DDDæ˜¯ä¸€ä¸ªå¥½æ–¹æ³•ï¼Œå…¶ä¸­ä¹ŸåŒ…æ‹¬å¾®æœåŠ¡å®šä¹‰è€…Martin Fowlerï¼Œæ¯•ç«ŸDDDåŸä¹¦çš„åºæ˜¯ä»–ç»™è‘—çš„ï¼›ï¼‰äºæ˜¯ä¹DDDå¼€å§‹åœ¨è¢«å®šä¹‰10å¹´åç«äº†ã€‚\nä»æˆ‘ä¸ªäººè§’åº¦æ¥çœ‹ï¼Œå¦‚æœçœŸçš„éœ€è¦æ‰¾åˆ°å› æœå…³ç³»çš„è¯ï¼Œæœ€æ ¹æœ¬çš„é©±åŠ¨åŠ›æ¥è‡ªäºç§‘æŠ€æ—¶ä»£å¯¹è½¯ä»¶ç³»ç»Ÿï¼ˆæ•°å­—åŒ–ï¼‰å“åº”åŠ›è¦æ±‚çš„ä¸æ–­æå‡ï¼Œè€Œç³»ç»Ÿçš„å¤æ‚åº¦å´éšç€ä¸šåŠ¡çš„å¤šå…ƒåŒ–è€Œä¸æ—¥ä¿±å¢ã€‚å¦‚ä½•é©¾é©­è¿™æ ·çš„é«˜å¤æ‚åº¦æˆäº†æ¯ä¸ªä¼ä¸šå¿…é¡»é¢å¯¹çš„æŒ‘æˆ˜ï¼Œä»¥è‡³äºä¸šç•Œå¼€å§‹æŠŠè¿™ç§æ¨¡å‹æ€»ç»“ä¸ºå“åº”åŠ›ä¼ä¸šï¼ˆResponsive Enterpriseï¼‰ï¼Œè€Œæ¨¡å‹ä¸­æ€»ç»“çš„å¤§éƒ¨åˆ†åŸåˆ™éƒ½æ˜¯ä¸ºäº†æ›´å¥½çš„é€‚åº”ç¯å¢ƒä¸ç¡®å®šæ€§å¸¦æ¥çš„é«˜å¤æ‚åº¦ã€‚\nä¸€ã€ä»ä¸šåŠ¡è§†è§’åˆ†ç¦»å¤æ‚åº¦æ¯ä¸ªäººèƒ½å¤Ÿè®¤çŸ¥çš„å¤æ‚åº¦éƒ½æ˜¯æœ‰é™çš„ï¼Œåœ¨é¢å¯¹é«˜å¤æ‚åº¦çš„æ—¶å€™æˆ‘ä»¬ä¼šåšå…³æ³¨ç‚¹åˆ†ç¦»ï¼Œè¿™æ˜¯ä¸€ä¸ªæœ€åŸºæœ¬çš„å“²å­¦åŸåˆ™ã€‚æ˜¾ç„¶åœ¨é’ˆå¯¹å¤æ‚ä¸šåŠ¡åœºæ™¯è¿›è¡Œå»ºæ¨¡æ—¶ï¼Œæˆ‘ä»¬ä¹Ÿä¼šåº”ç”¨æ­¤åŸåˆ™ã€‚è¿™ä¸ªæ—¶å€™å»åˆ†ç¦»å…³æ³¨ç‚¹ä¸€èˆ¬å¯ä»¥ä»ä¸¤ä¸ªç»´åº¦å‡ºå‘ï¼š\n\næŠ€æœ¯ç»´åº¦åˆ†ç¦»ï¼Œç±»ä¼¼MVCè¿™æ ·çš„åˆ†å±‚æ€æƒ³æ˜¯æˆ‘ä»¬å¹¿æ³›æ¥å—çš„ã€‚\nä¸šåŠ¡ç»´åº¦åˆ†ç¦»ï¼Œæ ¹æ®ä¸åŒçš„ä¸šæ€åˆ’åˆ†ç³»ç»Ÿï¼Œæ¯”å¦‚æŒ‰å”®å‰ã€é”€å”®ã€å”®ååˆ’åˆ†ã€‚\n\nä»¥ä¸Šä¸¤ä¸ªç»´åº¦æ²¡æœ‰å­°ä¼˜å­°åŠ£ä¹‹åˆ†ï¼Œåœ¨å¤„ç†å¤æ‚é—®é¢˜çš„æ—¶å€™ä¸€å®šéƒ½ä¼šç”¨ä¸Šï¼Œä½†ä¸ºäº†èƒ½å¤Ÿé«˜æ•ˆå“åº”ä¸šåŠ¡çš„å˜åŒ–ï¼Œå¾®æœåŠ¡çš„æ¶æ„æ›´å¼ºè°ƒä¸šåŠ¡ç»´åº¦çš„å…³æ³¨ç‚¹åˆ†ç¦»æ¥åº”å¯¹é«˜å¤æ‚åº¦ã€‚è¿™æ˜¯æ˜¾è‘—åŒºåˆ«äºä¼ ç»ŸSOAæ¶æ„çš„ç‰¹è´¨ä¹‹ä¸€ï¼Œæ¯”å¦‚è¯ç”Ÿäºä¼ ç»ŸSOAæ—¶ä»£çš„ESBï¼ˆå·¥ä¸šæœåŠ¡æ€»çº¿ï¼‰å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„æŠ€æœ¯å…³æ³¨ç‚¹åˆ†ç¦»å‡ºæ¥çš„ä¸­é—´ä»¶ã€‚éšç€ä¸šåŠ¡çš„å˜åŒ–ï¼Œæˆ‘ä»¬ä¹Ÿçœ‹åˆ°ESBæˆä¸ºäº†ä¸€ä¸ªæ¶æ„ä¸Šçš„åæ¨¡å¼ï¼Œå³å¤§é‡çš„ä¸šåŠ¡è§„åˆ™å’Œæµç¨‹è¢«å°è£…åœ¨äº†ESBé‡Œï¼Œè®©ESBæˆä¸ºäº†ä¸å¯é©¾é©­çš„å¤æ‚åº¦ä¹‹æºï¼Œä»¥è‡³äºç ´åäº†SOAæ¶æ„ä¹‹å‰æ‰¿è¯ºçš„å„ç§ä¼˜åŠ¿ã€‚å½“ç„¶Microservicesæ¶æ„å¹¶éæ˜¯æ–°ä¸€ä»£SOAæ¶æ„è¿™ä¹ˆç®€å•ï¼Œå·²ç»æœ‰ä¸å°‘æ–‡ç« åœ¨è®¨è®ºè¿™ä¸ªè¯é¢˜ï¼Œæœ¬æ–‡å°±ä¸åœ¨å±•å¼€äº†ã€‚\næ‰€ä»¥ä»æœ¬è´¨ä¸Šä½œä¸ºä¸€ç§æ¶æ„è®¾è®¡æ–¹æ³•çš„DDDå’Œä½œä¸ºä¸€ç§æ¶æ„é£æ ¼çš„Microserviceséƒ½æ˜¯ä¸ºç€è¿½æ±‚é«˜å“åº”åŠ›ç›®æ ‡è€Œä»ä¸šåŠ¡è§†è§’å»åˆ†ç¦»å¤æ‚åº¦çš„æ‰‹æ®µã€‚\nå¦‚æœè¿™ä¸ªæ—¶ä»£ä½ è¿˜è§‰å¾—è‡ªå·±çš„æ¶æ„ä¸éœ€è¦è¿™ç§å“åº”åŠ›ï¼Œæˆ‘å»ºè®®ä½ é—®é—®èº«è¾¹ç»´æŠ¤3å¹´ä»¥ä¸Šç³»ç»Ÿçš„æœ‹å‹æˆ–åŒäº‹ä»¬ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ è¿™æ˜¯æ€æ ·çš„ä¸€ç§ç—›è‹¦ã€‚å®é™…ä¸Šå¾ˆå¤šä¼ä¸šå¯¹è¿™ç§å“åº”åŠ›çš„è¿½æ±‚å·²ç»å¾ˆâ€œç–¯ç‹‚â€äº†ï¼Œè¿™ä¹Ÿæ˜¯å¾®æœåŠ¡çš„ä¸¤ä½å®šä¹‰è€…å¯èƒ½éƒ½å§‹æ–™æœªåŠçš„ã€‚\nä»–ä»¬åœ¨å®šä¹‰æ–‡ç« ä¸­å¸¦ç€å¾ˆå¼ºè­¦å‘Šè¯­æ°”è®©å¤§å®¶æ…ç”¨ï¼Œä½†åœ¨è¿™ä¸ªç§‘æŠ€æ—¶ä»£ï¼Œå¾®æœåŠ¡æ¶æ„å®æ–½çš„å¯èƒ½é£é™©å¯¹æ¯”é«˜å“åº”åŠ›åœ¨æœªæ¥å¯èƒ½å¸¦æ¥çš„å¸‚åœºæœºä¼šå‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ä¸€ä¸ªNetflixçš„æˆåŠŸå°±è¶³ä»¥è®©å¤§éƒ¨åˆ†ä¼ä¸šæ¯«ä¸çŠ¹è±«çš„é€‰æ‹©å¾®æœåŠ¡ä½œä¸ºè‡ªèº«çš„æ¶æ„é£æ ¼ã€‚\näºŒã€ä¸šåŠ¡å’ŒæŠ€æœ¯æ¸è¿›ç»Ÿä¸€çš„æ¶æ„è®¾è®¡å¦‚æœMicroserviceså’ŒDDDåœ¨ç›®æ ‡ä¸Šè¾¾æˆäº†ä¸Šæ–‡çš„ç»Ÿä¸€ï¼Œé‚£ä¹ˆåœ¨å…·ä½“åšæ³•ä¸Šå’Œä»¥å‰æœ‰ä»€ä¹ˆä¸åŒå‘¢ï¼Ÿ\nä¸ºäº†è§£é‡Šæ¸…æ¥šè¿™ä¸ªé—®é¢˜è®©æˆ‘ä»¬æç®€åŒ–æ¶æ„è®¾è®¡ä¸ºä»¥ä¸‹ä¸‰ä¸ªå±‚é¢å·¥ä½œï¼š\n\nä¸šåŠ¡æ¶æ„ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡ä¸šåŠ¡æ¨¡å—åŠäº¤äº’å…³ç³»ã€‚\nç³»ç»Ÿæ¶æ„ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚è®¾è®¡ç³»ç»Ÿå’Œå­ç³»ç»Ÿçš„æ¨¡å—ã€‚\næŠ€æœ¯æ¶æ„ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚å†³å®šé‡‡ç”¨çš„æŠ€æœ¯åŠæ¡†æ¶ã€‚\n\næ˜¾ç„¶è¿™ä¸‰è€…åœ¨å…·ä½“ä¸€ä¸ªæ¶æ„è®¾è®¡æ´»åŠ¨ä¸­åº”è¯¥æ˜¯æœ‰å…ˆåé¡ºåºçš„ï¼Œä½†å¹¶éä¸€å®šæ˜¯å­°å…ˆå­°åï¼Œæ¯”å¦‚ä¸€ä¸ªç®€å•çš„webåº”ç”¨ï¼Œå¾ˆå¤šäººä¼šè¯´MVCæ˜¯æ ‡é…äº†ï¼ˆé¦–å…ˆç¡®å®šäº†ç³»ç»Ÿæ¶æ„ï¼‰ï¼Œæˆ–è€…æœ‰äººè¯´ç”¨RoRå¿«ï¼ˆé¦–å…ˆç¡®å®šäº†æŠ€æœ¯æ¶æ„ï¼‰ã€‚åœ¨ç»™å®šçš„ä¸šåŠ¡åœºæ™¯é‡Œï¼Œä¹Ÿè®¸è¿™æ ·çš„é¡ºåºæ˜¯åˆç†çš„ã€‚\n\næ¶æ„è®¾è®¡å·¥ä½œåˆ†å±‚åŠä¼ ç»Ÿæ„ä¹‰ä¸Šçš„è´Ÿè´£äºº\nè¿™ä¸ªæ—¶å€™å’±ä»¬å¢åŠ å¤æ‚ä¸šåŠ¡éœ€æ±‚å’Œå¿«é€Ÿå¸‚åœºå˜åŒ–è¿™ä¸¤ä¸ªç¯å¢ƒå˜é‡ï¼Œè¿™ä¸ªé¡ºåºå°±å˜å¾—å¾ˆæœ‰æ„æ€äº†ã€‚äºæ˜¯æˆ‘ä»¬å¬åˆ°ä¸å°‘èµ°å‡ºåˆåˆ›æœŸçš„äº’è”ç½‘æœåŠ¡å¹³å°å¼€å§‹â€œé‡å†™â€ä»–ä»¬çš„ç³»ç»Ÿï¼ˆä»PHPåˆ°Javaï¼‰ï¼Œå¾ˆå¤šæ–‡ç« å¼€å§‹åæ€MVCå¸¦æ¥çš„åƒµåŒ–ï¼ˆè‡ƒè‚¿çš„å±•ç°å±‚ï¼‰ã€‚ç»å†äº†è¿™æ ·å˜è¿çš„æ¶æ„å¸ˆä»¬éƒ½ä¼šæ„ŸåŒèº«å—çš„å‡ºæ¥ä¸ºDDDç«™å°ï¼Œå…¶åŸå› å°±æ˜¯â€œè·³è¿‡â€ï¼ˆæˆ–â€œåè¡¥â€ï¼‰ä¸šåŠ¡æ¶æ„æ˜¾ç„¶è¡¨æ˜è®¾è®¡å‡ºæ¥çš„æ¶æ„å…³æ³¨ç‚¹å¹¶ä¸åœ¨ä¸šåŠ¡çš„å“åº”åŠ›ä¸Šï¼Œå› ä¸ºä¸šåŠ¡çš„å¯èƒ½å˜åŒ–ç‚¹å¹¶æ²¡æœ‰è¢«åˆ†æå‡ºæ¥æŒ‡å¯¼ç³»ç»Ÿå’ŒæŠ€æœ¯æ¶æ„çš„è®¾è®¡ã€‚\nDDDçš„æ ¸å¿ƒè¯‰æ±‚å°±æ˜¯èƒ½å¤Ÿè®©ä¸šåŠ¡æ¶æ„å’Œç³»ç»Ÿæ¶æ„å½¢æˆç»‘å®šå…³ç³»ï¼Œä»è€Œå½“æˆ‘ä»¬å»å“åº”ä¸šåŠ¡å˜åŒ–è°ƒæ•´ä¸šåŠ¡æ¶æ„æ—¶ï¼Œç³»ç»Ÿæ¶æ„çš„æ”¹å˜æ˜¯éšä¹‹è‡ªå‘çš„ã€‚\nè¿™ä¸ªå˜åŒ–çš„ç»“æœæœ‰ä¸¤ä¸ªï¼š\n\nä¸šåŠ¡æ¶æ„çš„æ¢³ç†å’Œç³»ç»Ÿæ¶æ„çš„æ¢³ç†æ˜¯åŒæ­¥æ¸è¿›çš„ï¼Œå…¶ç»“æœæ˜¯åˆ’åˆ†å‡ºçš„ä¸šåŠ¡ä¸Šä¸‹æ–‡å’Œç³»ç»Ÿæ¨¡å—ç»“æ„æ˜¯ç»‘å®šçš„ã€‚\næŠ€æœ¯æ¶æ„æ˜¯è§£è€¦çš„ï¼Œå¯ä»¥æ ¹æ®åˆ’åˆ†å‡ºæ¥çš„ä¸šåŠ¡ä¸Šä¸‹æ–‡çš„ç³»ç»Ÿæ¶æ„é€‰æ‹©æœ€åˆé€‚çš„å®ç°æŠ€æœ¯ã€‚\n\nç¬¬ä¸€ç‚¹æ˜¾ç„¶ä¹Ÿæ˜¯æˆ‘ä»¬äº§ç”Ÿå¾®æœåŠ¡åˆ’åˆ†æ‰€å¿…é¡»éµå¾ªçš„ï¼Œå› ä¸ºå¾®æœåŠ¡è¿½æ±‚çš„æ˜¯ä¸šåŠ¡å±‚é¢çš„å¤ç”¨ï¼Œæ‰€ä»¥è®¾è®¡å‡ºæ¥çš„ç³»ç»Ÿå¿…é¡»æ˜¯è·Ÿä¸šåŠ¡ä¸€è‡´çš„ã€‚ç¬¬äºŒç‚¹æ›´æ˜¯å¾®æœåŠ¡æ¶æ„çš„ç‰¹è´¨ï¼šâ€œå»ä¸­å¿ƒåŒ–â€çš„æ²»ç†æŠ€æœ¯å’Œæ•°æ®ç®¡ç†ã€‚ ä½œä¸ºæ¶æ„è®¾è®¡çš„æ–¹æ³•ï¼ŒDDDçš„å„ç§å®è·µï¼ŒåŒ…æ‹¬æœ€è¿‘æµè¡Œçš„Event Stormingï¼ˆäº‹ä»¶é£æš´ï¼‰å®é™…ä¸Šéƒ½æ˜¯ä¿ƒè¿›ä¸šåŠ¡å’Œç³»ç»Ÿæ¶æ„æ¢³ç†çš„æ¸è¿›å¼è®¤çŸ¥ã€‚\nåœ¨ä¸€æ¬¡DDDå·¥ä½œåŠä¸­ï¼Œä¸€ä½åŒäº‹ç»™å‡ºäº†â€œä½ ä»¬è¿ä¸šåŠ¡æ•…äº‹éƒ½è®²ä¸æ¸…æ¥šï¼Œè¿˜æœ‰å¿…è¦ç»§ç»­åšæ¶æ„è®¾è®¡å—ï¼Ÿâ€è¿™æ ·çš„ç»å…¸è¯„è®ºã€‚è€ŒDDDçš„æ•´ä¸ªæ–¹æ³•ä¹Ÿæ²¡æœ‰æ¶‰åŠå…·ä½“çš„æŠ€æœ¯æ¶æ„å®ç°ï¼Œè¿™ä¸ªé€‰å‹çš„æƒåˆ©å¾ˆå¤šæ—¶å€™è¢«â€œä¸‹æ”¾â€ç»™äº†çœŸæ­£çš„å¼€å‘å›¢é˜Ÿã€‚\nå€¼å¾—ä¸€æçš„æ˜¯é‡‡ç”¨DDDè¿™ç§æ¶æ„è®¾è®¡æ–¹æ³•å¹¶ä¸ä¸€å®šå°±äº§ç”ŸMircoservicesè¿™ç§æ¶æ„é£æ ¼ï¼Œå¾€å¾€ä¼šæ¨èç”¨å¤§é¢—ç²’åº¦çš„æœåŠ¡æ¥åŒ…å«ä¸šåŠ¡åˆ†æè¿‡ç¨‹ä¸­å‘ç°çš„ä¸ç¡®å®šç‚¹ï¼Œä»¥é¿å…æ‹†åˆ†åå˜åŒ–è¿‡åº¦é¢‘ç¹å¸¦æ¥çš„åŒå‘ä¿®æ”¹æˆæœ¬ã€‚\nä¸‰ã€è·¨èŒèƒ½åä½œçš„æ¶æ„è®¾è®¡ä¸šåŠ¡å’Œç³»ç»Ÿçš„æ¸è¿›è®¤çŸ¥æ”¹å˜äº†å¾ˆå¤šä¹‹å‰çš„æ¶æ„å·¥ä½œæ¨¡å¼ï¼Œåœ¨é‡‡ç”¨DDDçš„è¿‡ç¨‹ä¸­ï¼Œå¾ˆå®¹æ˜“æ„Ÿå—åˆ°ä¸šåŠ¡ä¸“å®¶çš„é‡è¦æ€§ã€‚è€Œå¦‚æœè¿˜æœ‰äººå¯„å¸Œæœ›è®©ä¸šåŠ¡èƒ½å¤Ÿä¸€æ¬¡æ€§ç»™æ¶æ„å¸ˆè®²æ¸…æ¥šéœ€æ±‚ï¼Œé‚£æˆ‘å»ºè®®æŠ±æœ‰è¿™æ ·å¸Œæœ›çš„åŒå­¦å»äº²èº«å‚åŠ ä¸€æ¬¡è‡ªå·±ä¸ç†Ÿæ‚‰ä¸šåŠ¡é¢†åŸŸçš„æ¶æ„è®¾è®¡è®¨è®ºã€‚ä½ ä¼šå¾ˆå®¹æ˜“å¾—å‡ºç»“è®ºâ€œåŸæ¥ä¸šåŠ¡ä¹Ÿä¸æ‡‚ä»–è¦ä»€ä¹ˆâ€ã€‚å½“ç„¶ä¸šåŠ¡äººå‘˜å¬è¯´è¦å‚åŠ æŸç§ï¼ˆè½¯ä»¶ï¼‰æ¶æ„è®¾è®¡æ–¹æ³•æ—¶å¿ƒé‡Œä¹Ÿä¸€å®šæ˜¯æŠµè§¦çš„ã€‚\nDDDæˆåŠŸè¿ç”¨çš„åŸºç¡€å°±æ˜¯åˆ›é€ è®©ä¸šåŠ¡å’Œç³»ç»Ÿè¿™ä¸¤ç§ä¸åŒè®¤çŸ¥æ¨¡å‹é€æ­¥ç»Ÿä¸€çš„ç¯å¢ƒã€‚\n\næ‰€ä»¥â€œä¸å¹¸â€çš„æ˜¯å¦‚æœä½ ä¸èƒ½å»ºç«‹ä¸€ä¸ªè·¨ä¸šåŠ¡å’ŒæŠ€æœ¯çš„æ–°å‹æ¶æ„è®¾è®¡å°ç»„ï¼Œä½ çš„DDDå®è·µå°±æ²¡æœ‰æˆåŠŸçš„åŸºç¡€ï¼Œç»§è€Œé‡‡ç”¨å¾®æœåŠ¡æ¶æ„å¯èƒ½å°±ä¼šæ˜¯ä¸€åœºç¾éš¾ã€‚å¹¸è¿çš„æ˜¯è¿™ç§è·¨èŒèƒ½ç»„ç»‡ç»“æ„å·²ç»æ˜¯å‰æ–‡ä¸­â€œé‡‡ç”¨â€å¾®æœåŠ¡æ¶æ„ä¼ä¸šï¼ˆå¦‚Amazonï¼‰çš„æ ‡é…ï¼Œä½ ä¸å¿…å†è®ºè¯è¿™ä»¶äº‹æƒ…çš„å¯å®æ–½æ€§ã€‚å‰©ä¸‹çš„å…³é”®å°±æ˜¯å¦‚ä½•èƒ½å¤Ÿè®©ä¸åŒèƒŒæ™¯çš„äººä»¬åä½œèµ·æ¥ã€‚è¿™ä¹Ÿæ˜¯å¤§å®¶å¯ä»¥çœ‹åˆ°DDDé¢†åŸŸçš„ä¸‹ä¸€ä¸ªçƒ­ç‚¹ï¼Œç±»ä¼¼Event Stormingè¿™æ ·çš„æ¨¡å¼åŒ–åä½œå·¥ä½œåŠä¼šæ›´å¤šçš„å‡ºç°åœ¨å¤§å®¶çš„è§†çº¿é‡Œã€‚\nå››ã€æ°¸æ— ç»ˆæ­¢çš„DDDå’Œæ¼”è¿›çš„MicroservicesDDDæ˜¯å®¹æ˜“ä¸Šç˜¾çš„ï¼Œå½“å¤§å®¶å‘ç°åŸæ¥é€šè¿‡è¿™ä¸ªå»ºæ¨¡è¿‡ç¨‹ä¸šåŠ¡ä¸“å®¶æ›´äº†è§£æœåŠ¡åˆ’åˆ†ï¼ˆç³»ç»Ÿæ¨¡å—ï¼‰ï¼Œæ¶æ„è®¾è®¡æ›´æ‡‚ä¸šåŠ¡éœ€æ±‚ï¼Œè¿™ç§åä½œä¼šæˆä¸ºå¸¸æ€ã€‚åœ¨è¿™ä¸ªtech@coreçš„æ—¶ä»£ï¼Œè¿™æ ·çš„èåˆå°†æˆä¸ºä¼ä¸šçš„æ ¸å¿ƒç«äº‰åŠ›ã€‚\nå½“ç„¶åˆšå¼€å§‹é‡‡ç”¨DDDæ–¹æ³•çš„æ—¶å€™ï¼Œè¯·ä¸è¦è®¤ä¸ºæ¯ä¸ªç³»ç»Ÿæä¸€æ¬¡æ‰€è°“çš„DDDå·¥ä½œåŠå°±èƒ½å¤Ÿæ‰¾åˆ°æœ€ä½³çš„æœåŠ¡åˆ’åˆ†äº†ã€‚ä¸šåŠ¡çš„å˜åŒ–æ˜¯æŒç»­çš„ï¼Œè€Œæ¯æ¬¡ä¸šåŠ¡æ¶æ„å˜åŒ–å¿…ç„¶ç‰µåŠ¨ç³»ç»Ÿæ¶æ„çš„å˜åŒ–ã€‚è‰¯å¥½çš„é¢†åŸŸæ¶æ„ç»‘å®šäº†ä¸šåŠ¡å’Œç³»ç»Ÿï¼Œè®©åŒæ–¹äººå‘˜èƒ½å¤Ÿç”¨ç»Ÿä¸€è¯­è¨€äº¤æµï¼Œè¿™ä»¶äº‹æƒ…å»ºç«‹ä¸æ˜“ï¼Œè€ŒæŒç»­è¿ä½œæ›´éš¾ã€‚\næˆåŠŸçš„DDDæ–¹æ³•è¿ç”¨æ˜¯è´¯ç©¿ç³»ç»Ÿçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ä¸šåŠ¡å’ŒæŠ€æœ¯çš„åä½œæ˜¯æŒç»­å‘ç”Ÿçš„ã€‚\nMicroservicesçš„æœ€åä¸€ä¸ªç‰¹è´¨ï¼šâ€œæ¼”è¿›å¼â€è®¾è®¡ - ä¹Ÿæ˜ç¡®äº†è®¾è®¡æ˜¯ä¸€ç§æŒç»­çš„æ´»åŠ¨ã€‚DDDæä¾›äº†ä¸€ç§ç¬¦åˆè¿™ä¸ªå¾®æœåŠ¡ç‰¹è´¨çš„å·¥ä½œæ–¹æ³•ï¼Œè®©æ¼”è¿›èƒ½å¤Ÿè½åœ°ã€‚å€¼å¾—ä¸€æçš„æ˜¯å°±ç¬”è€…æœ€è¿‘çš„ç»éªŒï¼Œè¿™ä¸ªæ¼”è¿›è¿‡ç¨‹ä¸­æœ€éš¾è®¤çŸ¥åˆ°å˜åŒ–çš„å°±æ˜¯DDDé‡Œæœ€æ˜¾è€Œæ˜“è§çš„â€œç»Ÿä¸€è¯­è¨€â€ã€‚å½“å¤§å®¶å½¢æˆäº†ä¸€ä¸ªä¸šåŠ¡æ¦‚å¿µ-â€œå®¢æˆ·â€åï¼Œå°‘æœ‰å›¢é˜Ÿèƒ½å¤ŸæŒç»­å®¡è§†è¿™ä¸ªâ€œå®¢æˆ·â€æ˜¯å¦éšç€å¸‚åœºçš„å˜åŒ–è€Œå‘ç”Ÿäº†å«ä¹‰çš„å˜è¿ã€‚\nå¯¹æ¯”ä¼ ç»Ÿçš„SOAï¼Œå¾®æœåŠ¡çš„æ‹†åˆ†ä¹Ÿæ˜¯åŠ¨æ€çš„ï¼Œç¦šå¨´é™åœ¨è‡ªå·±çš„æ–‡ç« ä¸­æè¿°ä¸€ä¸ªç³»ç»Ÿé‡‡ç”¨å¾®æœåŠ¡æ¶æ„å†ç¨‹ä¸­æœåŠ¡æ‹†åˆ†çš„æ¼”å˜ã€‚è¿™é‡Œä¸ä¼šæœ‰ä¸€ä¸ªESBæ¥ä»¥ä¸å˜åº”ä¸‡å˜ï¼Œè¿™ç§å¹»æƒ³åœ¨è¿‡å»çš„10å¹´é‡Œå·²ç»è¢«æ•°æ¬¡æ‰“è„¸ã€‚DDDçš„å¥½å¤„æ˜¯è®©ä¸šåŠ¡å’ŒæŠ€æœ¯äººå‘˜éƒ½èƒ½å¤Ÿåœ¨åˆä½œä¸­ç†è§£è¿™ç§å˜åŒ–ï¼Œè€Œä¸è‡³äºé™·å…¥ä¸šåŠ¡äººå‘˜æŠ±æ€¨æŠ€æœ¯æ¶æ„ä¸çŸ¥æ‰€è°“ï¼ŒæŠ€æœ¯äººå‘˜è§‰å¾—ä¸šåŠ¡äººå‘˜æœä¸‰æš®å››çš„å°´å°¬ã€‚\näº”ã€ä½ éœ€è¦æˆä¸ºé‚£ä¸ªé«˜ä¸ªå­ï¼Martin Fowleråœ¨Microserviesçš„å®šä¹‰æ–‡ç« ä¸­ç”»äº†ä¸‹é¢çš„å›¾ï¼Œè¯„è®ºâ€œä½ å¿…é¡»æœ‰é‚£ä¸ªé«˜åº¦â€æ¥éšå–»å¾®æœåŠ¡å®æ–½çš„èƒ½åŠ›è¦æ±‚ã€‚å°±æ¶æ„å»ºæ¨¡æ–¹é¢æ¥è¯´æˆ‘è®¤ä¸ºDDDåº”è¯¥æ˜¯ä¸€ä¸ªå›¢é˜Ÿå¿…é¡»å»æŒæ¡çš„ï¼ŒåŒ…æ‹¬è¿™ä¸ªå›¢é˜Ÿçš„ä¸šåŠ¡äººå‘˜å’Œäº§å“è®¾è®¡äººå‘˜ã€‚\n\nå¾®æœåŠ¡å‰ç½®æ¡ä»¶ç¤ºæ„\nå¾ˆæœ‰æ„æ€çš„æ˜¯ç›®å‰Service Designä¹Ÿæ˜¯å…¨çƒç”¨æˆ·ä½“éªŒè®¾è®¡é¢†åŸŸçš„ä¸€ä¸ªçƒ­é—¨è¯é¢˜ï¼Œä»ç”¨æˆ·è§†è§’å‡ºå‘å»è®¾è®¡æ•´ä¸ªæœåŠ¡é“¾æ¡ã€‚æ¯”å¦‚æ—¶ä¸‹çƒ­é—¨çš„å…±äº«å•è½¦ï¼Œä¸€ä¸ªæˆåŠŸçš„æœåŠ¡è®¾è®¡åº”è¯¥æ˜¯ä»ç”¨æˆ·å¼€å§‹æœ‰ç”¨è½¦éœ€æ±‚è§¦å‘åˆ°æœ€åå®Œæˆéª‘è¡Œç¼´è´¹ç¦»å¼€ï¼Œè€Œä¸ä»…ä»…æ˜¯å»è®¾è®¡ä¸€è¾†èƒ½å¤Ÿäº’è”ç½‘è§£é”çš„è‡ªè¡Œè½¦ã€‚\næˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¾ˆå¤šService Deisgnå’ŒDDDåœ¨åŸåˆ™ä¸Šçš„ç›¸ä¼¼ä¹‹å¤„ï¼Œæ¯”å¦‚ç”¨æˆ·ä¸­å¿ƒå’ŒååŒè®¾è®¡ã€‚å€Ÿç”¨ä¸Šé¢çš„é«˜ä¸ªå­è¯´æ³•:\nåœ¨ä¸šåŠ¡éœ€æ±‚è®¤çŸ¥å’Œè·¨èŒèƒ½åä½œæ–¹é¢ä½ ä¸€å®šéœ€è¦æˆä¸ºé«˜ä¸ªå­ï¼\n","categories":["é¢†åŸŸé©±åŠ¨è®¾è®¡"]},{"title":"ä»â€œå››è‰²å»ºæ¨¡æ³•â€åˆ°â€œé™ç•Œçº¸ç¬”å»ºæ¨¡æ³•â€","url":"/posts/17671/","content":"å¯¹äºé¢†åŸŸä¸“å®¶ã€ç¨‹åºå‘˜å’Œæµ‹è¯•å·¥ç¨‹å¸ˆæ¥è¯´ï¼Œé¢†åŸŸå»ºæ¨¡æ‰€æ„å»ºçš„æ¦‚å¿µæ¨¡å‹æ˜¯æ’‘èµ·è½¯ä»¶å¼€å‘ç³»ç»Ÿçš„éª¨æ¶ã€‚é¢†åŸŸå»ºæ¨¡çš„æ–¹æ³•æœ‰å¾ˆå¤šç§ï¼ŒThoughtWorksçš„åŒäº‹ä»¬ç»å¸¸ä½¿ç”¨ç»è¿‡å¾æ˜Šæ”¹ç¼–çš„â€œå››è‰²å»ºæ¨¡æ³•â€[1]æ¥è¿›è¡Œå»ºæ¨¡ã€‚è€Œæœ¬æ–‡æ‰€æè¿°çš„â€œé™ç•Œçº¸ç¬”å»ºæ¨¡æ³•â€ï¼Œåœ¨â€œå››è‰²å»ºæ¨¡æ³•â€çš„â€œæ—¶æ ‡å¯¹è±¡â€çš„åŸºç¡€ä¸Šç¡®å®šâ€é™ç•Œä¸Šä¸‹æ–‡â€[2]ä¸â€œèšé›†â€[3]çš„æ¦‚å¿µï¼Œå†ä½¿ç”¨â€œçº¸å’Œç¬”æ¥ç®¡ç†â€çš„æ–¹æ³•ï¼ŒåŠ›å›¾åœ¨å»ºæ¨¡è¿‡ç¨‹ä¸­å®ç°â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œå¢å¼ºæ•°æ®çš„å®Œæ•´æ€§ï¼Œå¹¶é¿å…è¿‡åº¦è®¾è®¡ã€‚\nä¸ºäº†ä¾¿äºè¯´æ˜ï¼Œä¸‹æ–‡å°†ä»¥â€œå°ç”»ç¬”â€ç»˜ç”»è¯¾å¤–ç­çš„ä¸šåŠ¡ä¸ºä¾‹ï¼Œé¦–å…ˆæè¿°åŒäº‹äº¢æ±Ÿå¦¹ç”¨å››è‰²å»ºæ¨¡æ³•å¯¹å…¶æ‰€å»ºçš„æ¨¡å‹ï¼Œç„¶åå†æè¿°å¦‚ä½•åœ¨å…¶â€œæ—¶æ ‡å¯¹è±¡â€çš„åŸºç¡€ä¸Šï¼Œè¿ç”¨é™ç•Œçº¸ç¬”å»ºæ¨¡æ³•è¿›è¡Œå»ºæ¨¡ã€‚\nä¸€ã€â€œå°ç”»ç¬”â€ç»˜ç”»è¯¾å¤–ç­â€œå°ç”»ç¬”â€æ˜¯ä¸€å®¶é¢å‘2-10å²å°æœ‹å‹çš„ç»˜ç”»åŸ¹è®­æœºæ„ã€‚ä¹ä¹è€å¸ˆæ˜¯è¿™ä¸ªåŸ¹è®­æœºæ„çš„ä¸»ç®¡ã€‚å¥¹æ¯•ä¸šäºåŒ—äº¬å¸ˆèŒƒå­¦é™¢ï¼Œæœ‰ä¸€äº›è®¤è¯†çš„åŒå­¦å’Œè€å¸ˆæ„¿æ„åœ¨ä¸šä½™æ—¶é—´æˆè¯¾æ¥è·å¾—ä¸€å®šæ”¶å…¥ã€‚\nâ€œå°ç”»ç¬”â€ç›®å‰æœ‰ä¸‰ä¸ªç­ï¼š\n\nç¾æœ¯é¢„ç§‘ï¼šé€‚åˆ2-3å²å­©å­ï¼Œä»çœ‹ã€æ‘¸ã€é—»ã€å¬ã€å°åŸ¹å…»è‰ºæœ¯æ„Ÿï¼›æ¯æœŸè¯¾ç¨‹8æ¬¡ï¼Œæ¯å‘¨ä¸€æ¬¡ï¼Œå‘¨æœ«ä¸Šï¼›æ¯ç­æœ€å°‘6ä¸ªå­©å­å¼€è¯¾ï¼Œæœ€å¤š10ä¸ªå­©å­ã€‚\nä¹¦æ³•ï¼šé€‚åˆ3-6å²å­©å­ï¼Œå­¦ä¹ å­—ä½“ç»“æ„ã€ç¬”ç”»çº¿æ¡ï¼›æ¯æœŸè¯¾ç¨‹8æ¬¡ï¼Œæ¯å‘¨ä¸€æ¬¡ï¼Œå‘¨æœ«æˆ–æ™šä¸Šä¸Š; æ¯ç­æœ€å°‘6ä¸ªå­©å­å¼€è¯¾ï¼Œæœ€å¤š12ä¸ªå­©å­ã€‚\nå„¿ç«¥ç»˜æœ¬ï¼šé€‚åˆå¹´é¾„5-10å²ï¼Œç”¨æ–‡å­—å’Œå›¾ç”»è¡¨è¾¾ï¼›æ¯æœŸè¯¾ç¨‹8æ¬¡ï¼Œæ¯å‘¨ä¸€æ¬¡ï¼Œå‘¨æœ«æˆ–æ™šä¸Šä¸Š; æ¯ç­æœ€å°‘6ä¸ªå­©å­å¼€è¯¾ï¼Œæœ€å¤š12ä¸ªå­©å­ã€‚\n\nâ€œå°ç”»ç¬”â€æœ‰ä¸‰ä¸ªæ•™å®¤ï¼šè¾¾èŠ¬å¥‡ï¼Œæ¯•åŠ ç´¢å’Œæ¢µé«˜ã€‚\næ¯ä¸¤ä¸ªæœˆå¼€å§‹æ–°æœŸè¯¾ç¨‹ï¼Œ8æ¬¡è¯¾ç»“æŸåé‡æ–°å¼€å§‹ã€‚\nä¹ä¹è€å¸ˆçš„ä¸»è¦å·¥ä½œæ˜¯ï¼š\n\næ ¹æ®ç°æœ‰è€å¸ˆèƒ½å¤Ÿè®²æˆçš„è¯¾ç¨‹åŠæ—¶é—´ï¼Œåšå¥½è¯¾ç¨‹è¡¨å®‰æ’ï¼Œæå‰ä¸¤ä¸ªæœˆæŠŠä¸‹æœŸè¯¾ç¨‹ä»‹ç»åšå¥½ï¼Œå°æˆå®£ä¼ å½©é¡µï¼›\nåœ¨é™„è¿‘ç¤¾åŒºé‡Œç»™å®¶é•¿å®£ä¼ ï¼Œæ‹›å‹Ÿç”Ÿæºï¼›\næ¥å—å®¶é•¿æŠ¥åï¼ˆç”µè¯æˆ–é¢å¯¹é¢ï¼‰ï¼Œè®°å½•å’Œè¿½è¸ªæŠ¥åæƒ…å†µï¼›\næ”¶å–å­¦è´¹ï¼Œå­¦è´¹æ”¯ä»˜é‡‡ç”¨ç°é‡‘ä»˜æ¬¾ï¼Œæˆ–é“¶è”å¡åˆ·å¡æ”¯ä»˜ï¼›\näº‰å–åœ¨æ¯ä¸€æœŸè¯¾ç¨‹å¼€å§‹å‰éƒ½æœ‰è¶³å¤Ÿå­¦å‘˜æŠ¥åï¼Œå¯ä»¥å‡†æ—¶å¼€ç­ï¼›\nä¿è¯è¯¾ç¨‹è´¨é‡å’Œå®‰å…¨ï¼Œä¿è¯è¥æ”¶ï¼Œç»´æŒåŸ¹è®­æœºæ„æ­£å¸¸è¿è½¬ã€‚\n\nä¹ä¹è€å¸ˆéœ€è¦å¤„ç†çš„ä¸‰ä¸ªæ ¸å¿ƒé—®é¢˜æœ‰ï¼š\n\nä¸‹ä¸€æœŸçš„è¯¾ç¨‹å¦‚ä½•å®‰æ’ï¼Ÿ - æ’è¯¾\nå¦‚ä½•æ‹›ç”Ÿå’Œç®¡ç†æŠ¥åï¼Ÿ - ç®¡ç†æŠ¥å\nå¦‚ä½•ä¿è¯è¯¾ç¨‹è´¨é‡ï¼Ÿ - ç®¡ç†è¯¾å ‚\n\næŒ‘æˆ˜ï¼š\nè¯·ä¸ºä¹ä¹è€å¸ˆè®¾è®¡ä¸€ä¸ªè½¯ä»¶å·¥å…·çš„æ¦‚å¿µæ¨¡å‹ï¼Œèƒ½è®©ä¹ä¹è€å¸ˆæ–¹ä¾¿åœ°ç®¡ç†æ’è¯¾ã€æŠ¥åå’Œå­¦å‘˜è€ƒå‹¤ï¼Œç»´æŠ¤â€œå°ç”»ç¬”â€çš„æ­£å¸¸è¿è¥ã€‚\nåœ¨æ—¥å¸¸è¿è¥ä¸­ï¼Œä¹ä¹è€å¸ˆç»å¸¸ç¢°åˆ°ä¸‹åˆ—é—®é¢˜ï¼š\n\nè¯¾ç¨‹å¼€å§‹åå‘ç°æœ‰å­©å­æ²¡æ¥ä¸Šè¯¾ï¼Œä¹Ÿæ²¡æœ‰è¯·å‡ï¼Œéœ€è¦æŸ¥æ‰¾å®¶é•¿è”ç³»ç”µè¯æ¥è¯¢é—®ã€‚\næœ‰æ—¶å­©å­è¯·å‡ä¼šé€ æˆç¼ºè¯¾ï¼Œå®¶é•¿ä¼šè¦æ±‚åœ¨åæœŸè¯¾ç¨‹ä¸­è¡¥ä¸Šã€‚ä¹ä¹è€å¸ˆéœ€è¦è®°å½•å­©å­çš„ä¸Šè¯¾æ¬¡æ•°ï¼Œåœ¨å¯ä»¥è¡¥ä¸Šè¯¾ç¨‹çš„æ—¶å€™é€šçŸ¥å­©å­æ¥å‚åŠ ã€‚\néœ€è¦æŸ¥çœ‹è¿˜æœ‰å“ªä¸ªå®¶é•¿æ²¡æœ‰ç¼´è´¹ï¼Œé€šçŸ¥ä»–ä»¬ç¼´è´¹ã€‚\néœ€è¦æŸ¥çœ‹æŸä¸ªå­©å­çš„ç¼´è´¹è®°å½•ï¼Œä»¥ç¡®è®¤å®¶é•¿æ˜¯å¦ç¼´è´¹ã€‚\nç»å¸¸æœ‰å®¶é•¿è¦æ±‚å…ˆè¯•ä¸€æ¬¡è¯¾ï¼Œå†ç¡®å®šæŠ¥åäº¤é’±ã€‚ä½†æ¯ç­åªèƒ½åœ¨æŠ¥åä¸æ»¡é¢çš„æƒ…å†µä¸‹æ‰èƒ½è¯•å¬ï¼Œä¸”æœ€å¤šåªèƒ½å…è®¸3ä¸ªå­©å­è¯•å¬ã€‚æ‰€ä»¥ä¹ä¹éœ€è¦è¿½è¸ªæ¯ç­æŠ¥åå¤šå°‘å­©å­ã€è¯•å­¦å¤šå°‘å­©å­ã€è¿˜æœ‰æ²¡æœ‰è¯•å­¦åé¢ã€‚\néœ€è¦ç»å¸¸æŸ¥çœ‹æ¯ç­æ˜¯å¦æŠ¥æ»¡ï¼Œå¯å¦å¼€è¯¾ï¼›å¦‚æœä¸æ»¡ï¼Œéœ€è¦å†å»å°åŒºåšå®£ä¼ ã€‚\néœ€è¦æå‰è·Ÿä¸Šè¯¾è€å¸ˆç¡®è®¤ï¼Œç¡®ä¿ä»–ä»¬èƒ½æŒ‰æ—¶æˆè¯¾ã€‚\næœ‰äº›è¯¾ç¨‹å¯èƒ½ä¼šæœ‰ä¸€ä½ä¸»ä»»è€å¸ˆå’Œå¦ä¸€ä½è§ä¹ è€å¸ˆæ¥å…±åŒæˆè¯¾ï¼Œæ‰€ä»¥è¿™äº›è¯¾ç¨‹æ¯é—¨è¯¾éœ€è¦ç®¡ç†å¤šä½è€å¸ˆçš„ä¿¡æ¯ã€‚\néœ€è¦è·Ÿè¸ªæ•™å­¦è´¨é‡ï¼Œç¡®ä¿è€å¸ˆæŒ‰æ—¶æŒ‰è´¨æˆè¯¾ï¼ŒåŠæ­£å¸¸æ•™å­¦å®‰å…¨å’Œç§©åºï¼›\n\nè¯·æ£€æŸ¥ä½ æ‰€è®¾è®¡çš„æ¦‚å¿µæ¨¡å‹èƒ½å¦å¸®ä¹ä¹è€å¸ˆè§£å†³ä¸Šè¿°é—®é¢˜ã€‚\näºŒã€ç”¨â€œå››è‰²å»ºæ¨¡æ³•â€è¿›è¡Œå»ºæ¨¡ç¬¬ä¸€æ­¥ï¼šå¯»æ‰¾è¦è¿½æº¯çš„äº‹ä»¶\n\nè°ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™ï¼Œä¸ºè°ï¼ŒæŠ¥åäº†ä»€ä¹ˆè¯¾ç¨‹\nè°ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™ï¼Œä¸ºè°ï¼Œæ”¯ä»˜äº†å¤šå°‘å­¦è´¹\nè°ï¼Œåœ¨ä»€ä¹ˆæ—¶å€™ï¼Œä¸Šäº†ä»€ä¹ˆè¯¾ç¨‹\n\nç¬¬äºŒæ­¥ï¼šè¯†åˆ«â€œæ—¶æ ‡å¯¹è±¡â€[4]\næŒ‰æ—¶é—´å‘å±•çš„å…ˆåé¡ºåºï¼Œç”¨çº¢è‰²æ‰€è¡¨ç¤ºçš„èµ·åˆ°â€œè¿½æº¯å•æ®â€ä½œç”¨çš„â€œæ—¶æ ‡â€æ¦‚å¿µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç¬¬ä¸‰æ­¥ï¼šå¯»æ‰¾æ—¶æ ‡å¯¹è±¡å‘¨å›´çš„â€œäººã€åœ°ã€ç‰©â€[5]\nåœ¨â€œæ—¶æ ‡â€å¯¹è±¡å‘¨å›´çš„ç”¨ç»¿è‰²æ‰€è¡¨ç¤ºçš„â€œäººã€åœ°ã€ç‰©â€æ¦‚å¿µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç¬¬å››æ­¥ï¼šæŠ½è±¡â€œè§’è‰²â€[6]\nåœ¨ä¸Šå›¾ä¸­æ’å…¥ç”¨é»„è‰²æ‰€è¡¨ç¤ºçš„â€œè§’è‰²â€æ¦‚å¿µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç¬¬äº”æ­¥ï¼šè¡¥å……â€œæè¿°â€ä¿¡æ¯[7]\nåœ¨ä¸Šå›¾ä¸­æ’å…¥ç”¨è“è‰²æ‰€è¡¨ç¤ºçš„â€œæè¿°â€æ¦‚å¿µï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nä¸‰ã€ç”¨â€œé™ç•Œçº¸ç¬”å»ºæ¨¡æ³•â€è¿›è¡Œå»ºæ¨¡ä¸Šé¢ç”¨å››è‰²å»ºæ¨¡æ³•å¯¹â€œå°ç”»ç¬”â€ç»˜ç”»è¯¾å¤–ç­çš„è½¯ä»¶ç³»ç»Ÿæ‰€åšçš„å»ºæ¨¡è¿‡ç¨‹ï¼Œæœ€å¤§çš„äº®ç‚¹æ˜¯æŒ‰æ—¶é—´å‘å±•çš„å…ˆåé¡ºåºï¼Œè¯†åˆ«å‡ºèµ·åˆ°â€œè¿½æº¯å•æ®â€ä½œç”¨çš„â€œæ—¶æ ‡â€æ¦‚å¿µã€‚è¿™ç§è¯†åˆ«æ–¹æ³•ç›´è¾¾ä¸šåŠ¡æ ¸å¿ƒæ•°æ®ï¼Œç®€ä¾¿æœ‰æ•ˆã€‚\næ­¤å¤–ï¼Œé™ç•Œçº¸ç¬”å»ºæ¨¡æ³•å¯ä»¥ç»§ç»­è¿›è¡Œä»¥ä¸‹ä¸‰é¡¹å»ºæ¨¡å·¥ä½œï¼š\n\nåˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼Œé¿å…æ¨¡å‹å‘å±•æˆâ€œå¤§æ³¥çƒæ¶æ„â€ã€‚\nå¼ºè°ƒâ€œèšé›†æ ¹â€[8]çš„æ¦‚å¿µï¼Œæ›´å¥½åœ°ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ã€‚\nå¯»æ‰¾â€œæ°å¥½å¤Ÿç”¨â€çš„æ¦‚å¿µï¼Œé¿å…è¿‡åº¦è®¾è®¡ï¼Œé™ä½æ‰€å»ºæ¨¡å‹çš„å¤æ‚æ€§ã€‚\n\nä¸€ä¸ªâ€œèšé›†æ ¹â€å¥½æ¯”ä¸€ä¸ªç»ç†ï¼Œè¿™ä¸ªâ€œèšé›†â€æ‰€æ±‡èšçš„æ‰€æœ‰å½¼æ­¤ç›¸å…³çš„æ¦‚å¿µå¥½æ¯”è¿™ä¸ªç»ç†æ‰‹ä¸‹ç®¡ç†çš„æ‰€æœ‰å‘˜å·¥ã€‚å½“å¦ä¸€ä¸ªâ€œèšé›†â€çš„ç»ç†ï¼Œè¦è®¿é—®è¯¥â€œèšé›†â€ä¸­çš„æŸä¸ªå‘˜å·¥æ—¶ï¼Œå¿…é¡»è¦é€šè¿‡è¯¥â€œèšé›†â€çš„â€œèšé›†æ ¹â€è¿™ä¸ªç»ç†çš„åŒæ„å’Œå®‰æ’æ‰è¡Œï¼Œä¸èƒ½ç›´æ¥å»æ‰¾ã€‚è¿™æ ·è®¾è®¡èƒ½å¤Ÿå°†ç®¡ç†æ•°æ®çš„è®¿é—®èŒè´£ç¼©å°åˆ°ä¸€äº›â€œç»ç†â€é‚£é‡Œï¼Œæ—¢æ–¹ä¾¿å®šä½èŒè´£ï¼Œä¹Ÿæœ‰åŠ©äºå¢å¼ºæ•°æ®çš„å®Œæ•´æ€§ã€‚\nä¸‹é¢å°è¯•ç”¨é™ç•Œçº¸ç¬”å»ºæ¨¡æ³•æ¥å¯¹â€œå°ç”»ç¬”â€ç»˜ç”»è¯¾å¤–ç­çš„è½¯ä»¶ç³»ç»Ÿå»ºæ¨¡ã€‚\nç¬¬ä¸€æ­¥ï¼šæ ¹æ®â€œè¿½æº¯å•æ®â€çš„ä»·å€¼è¯†åˆ«æ ¸å¿ƒé¢†åŸŸ[9]\né¦–å…ˆä»¥â€œå°ç”»ç¬”â€ç»˜ç”»è¯¾å¤–ç­çš„ä¸šåŠ¡â€œè¿½æº¯å•æ®â€ä¸ºçº¿ç´¢ï¼Œåˆ—å‡ºè¿™äº›è¿½æº¯å•æ®ä¸ºä¹ä¹è€å¸ˆæ‰€æä¾›ä»·å€¼ï¼Œå¹¶åˆå¹¶å…¶ä¸­ä¸€äº›ä»·å€¼ç›¸åŒçš„å•æ®ã€‚æ¯”å¦‚å¯¹äºä¸€ä¸ªåªæœ‰ä¸‰é—´æ•™å®¤çš„å°è¯¾å¤–åŸ¹è®­æœºæ„ï¼Œåªæœ‰äº¤è´¹æˆåŠŸçš„â€œæŠ¥åâ€æ‰è§†ä½œæœ‰æ•ˆæŠ¥åã€‚æ‰€ä»¥â€œæŠ¥åç™»è®°è¡¨â€å’Œâ€œäº¤è´¹çºªå½•â€å¯ä»¥åˆå¹¶ã€‚ç„¶åç¡®å®šè¿™äº›ä»·å€¼æ‰€å¯¹åº”çš„æ ¸å¿ƒé¢†åŸŸã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š\n\n ç¬¬äºŒæ­¥ï¼šç¡®å®šæ ¸å¿ƒé¢†åŸŸä¹‹é—´çš„ä¾èµ–å…³ç³»\næ’è¯¾ã€æŠ¥åä¸ç­¾åˆ°ä¸‰ä¸ªæ ¸å¿ƒé¢†åŸŸçš„ä¾èµ–å…³ç³»å¦‚ä¸‹æ‰€ç¤ºï¼š\næ’è¯¾ &lt;â€”â€” æŠ¥å &lt;â€”â€” ç­¾åˆ°\nä¸Šé¢çš„ç®­å¤´è¡¨ç¤ºï¼šâ€œæŠ¥åâ€éœ€è¦ä¾èµ–â€œæ’è¯¾â€æ‰€æä¾›çš„ä¿¡æ¯ï¼Œè€Œâ€œç­¾åˆ°â€éœ€è¦ä¾èµ–â€œæŠ¥åâ€æ‰€æä¾›çš„ä¿¡æ¯ã€‚\nç¬¬ä¸‰æ­¥ï¼šç”¨çº¸å’Œç¬”ç”»è¡¨æ ¼å¹¶å†™å®ä¾‹\nå…ˆé€‰æ‹©ä¸€ä¸ªæ ¸å¿ƒé¢†åŸŸï¼Œç„¶åå¼€å§‹åœ¨å…¶æ‰€å¯¹åº”çš„â€œé™ç•Œä¸Šä¸‹æ–‡â€ä¸­ï¼Œå¼€å§‹å¯¹å…¶å»ºæ¨¡ã€‚å‡è®¾æ—¶å…‰å›é€€100å¹´ï¼Œé‚£æ—¶æ²¡æœ‰ç”µè„‘ï¼Œåªæœ‰çº¸å’Œç¬”ã€‚ç”¨çº¸å’Œç¬”ç”»è¡¨æ ¼å¹¶å†™å®ä¾‹çš„æ–¹æ³•ï¼Œæ¥ç®¡ç†è¯¥æ ¸å¿ƒé¢†åŸŸçš„â€œæ°å¥½å¤Ÿç”¨â€çš„æ•°æ®ï¼Œæ¥è¾¾æˆä¹ä¹è€å¸ˆåœ¨æ­¤æ ¸å¿ƒé¢†åŸŸæ‰€æœŸæœ›çš„ä»·å€¼ã€‚\né¦–å…ˆé€‰æ‹©â€œæ’è¯¾â€ã€‚ä¸‹å›¾æ˜¯ç”¨çº¸å’Œç¬”ç”»å‡ºçš„è¡¨æ ¼ï¼Œå¹¶æœ‰ä¸€æ¡å®ä¾‹æ•°æ®ï¼š\n\nç¬¬å››æ­¥ï¼šç¡®å®šâ€œèšé›†æ ¹â€\nç»™è¡¨ä¸­æ‰€æœ‰çš„åˆ—æ‰¾ä¸€ä¸ªâ€œç»ç†â€æ¥ä½œä¸ºâ€œèšé›†æ ¹â€ã€‚è¿™é‡Œé€‰æ‹©â€œè¯¾ç¨‹â€ä½œä¸ºâ€œèšé›†æ ¹â€ï¼Œå®ƒæ˜¯ä¸€ç§å…·æœ‰å”¯ä¸€æ ‡è¯†ï¼ˆå³æœ‰å”¯ä¸€çš„è¯¾ç¨‹ç¼–å·ï¼‰çš„Entity[10]æ¦‚å¿µï¼Œç„¶åæŠŠè¡¨ä¸­æ‰€æœ‰çš„åˆ—åéƒ½æŠ„å†™åˆ°è¡¨ä¸‹â€œèšé›†æ ¹â€çš„å³ä¾§ï¼Œå¹¶ç”¨æ‹¬å·æ‹¬èµ·æ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n\nç¬¬äº”æ­¥ï¼šä»¥â€œäººä»¥ç¾¤åˆ†â€çš„åŸåˆ™æŠ½å–æ–°çš„â€œèšé›†â€\nè§‚å¯Ÿæ‰€æŠ„å†™çš„â€œèšé›†æ ¹â€å³ä¾§æ‰€æœ‰èšé›†åœ¨ä¸€èµ·çš„å„ä¸ªæ¦‚å¿µï¼Œæå–å‡ºæ€»æ˜¯â€œä¸€èµ·ç©å„¿â€çš„å¤šä¸ªæ¦‚å¿µï¼Œå½¢æˆä¸€ä¸ªæ–°çš„èšé›†ï¼Œå¹¶ç¡®å®šè¿™ä¸ªæ–°èšé›†çš„åå­—ã€‚æ¯”å¦‚ï¼Œâ€œä¸Šè¯¾æ—¶é—´â€ã€â€œèµ·å§‹æ—¥æœŸâ€ã€â€œæ¬¡æ•°â€è¿™ä¸‰ä¸ªæ¦‚å¿µæ€»æ˜¯ä¸€èµ·å‡ºç°ï¼Œå®ƒä»¬å†³å®šäº†è¿™é—¨è¯¾ç¨‹çš„å­¦æ—¶ï¼Œæ‰€ä»¥å°±æå–â€œå­¦æ—¶â€è¿™ä¸ªæ–°èšé›†ï¼Œå¹¶æŠŠè¿™ä¸‰ä¸ªæ¦‚å¿µä»â€œè¯¾ç¨‹â€å³ä¾§åˆ’æ‰ã€‚â€œå­¦æ—¶â€è¿™ä¸ªæ¦‚å¿µä¸éœ€è¦æœ‰å”¯ä¸€æ ‡è¯†ï¼Œæ‰€ä»¥æ˜¯Value Object[11]æ¦‚å¿µã€‚å®ƒå’Œâ€œè¯¾ç¨‹â€æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ç”¨ç›¸åŒçš„æ–¹æ³•å¯ä»¥æå–â€œè€å¸ˆâ€è¿™ä¸ªæ–°èšé›†ï¼Œå®ƒæ˜¯Entityæ¦‚å¿µï¼Œâ€œè¯¾ç¨‹â€ä¸å®ƒæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\n \nå¯¹äºé‚£äº›åªâ€œè‡ªå·±å•ç‹¬ç©å„¿â€çš„æ¦‚å¿µï¼Œå¦‚â€œå­¦è´¹â€ã€â€œæ•™å®¤â€ç­‰ï¼Œå°±å…ˆæš‚æ—¶æ”¾åˆ°â€œè¯¾ç¨‹â€è¿™ä¸ªèšé›†æ ¹ä¸‹é¢ï¼Œç­‰éšç€å°†æ¥ä¸šåŠ¡æ¼”è¿›å‡ºç°äº†æ–°çš„â€œèƒ½ä¸€èµ·ç©å„¿çš„ä¼™ä¼´â€åï¼Œå†æå–æ–°çš„èšé›†ä¸è¿Ÿã€‚\nè‡³æ­¤ï¼Œä½¿ç”¨é™ç•Œçº¸ç¬”å»ºæ¨¡æ³•å¯¹â€œæ’è¯¾â€è¿™ä¸ªæ ¸å¿ƒé¢†åŸŸæ‰€è¿›è¡Œçš„å»ºæ¨¡å‘Šä¸€æ®µè½ã€‚ä¸‹å›¾æ˜¯ä½¿ç”¨è¿™ç§æ–¹æ³•å¯¹â€œæŠ¥åâ€è¿™ä¸ªæ ¸å¿ƒé¢†åŸŸæ‰€å»ºçš„æ¨¡å‹ï¼Œâ€œç­¾åˆ°â€æ ¸å¿ƒé¢†åŸŸçš„å»ºæ¨¡ç•¥å»ä¸è®¨è®ºã€‚\n\nè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œâ€œæ’è¯¾â€è¿™ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­æœ‰â€œè¯¾ç¨‹â€è¿™ä¸ªèšé›†æ ¹ï¼Œè€Œâ€œæŠ¥åâ€è¿™ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­ä¹Ÿæœ‰â€œè¯¾ç¨‹â€è¿™ä¸ªèšé›†æ ¹ï¼Œè¿™ä¸¤è€…æ˜¯åŒä¸€ä¸ªæ¦‚å¿µå—ï¼Ÿ\nä»DDDçš„è§‚ç‚¹æ¥çœ‹ï¼Œè¿™ä¸¤è€…æ˜¯ä¸åŒçš„æ¦‚å¿µï¼Œè€Œä¸”åœ¨æ•°æ®åº“ä¸­ä¹Ÿåº”è¯¥æ˜¯ä¸¤å¼ ä¸åŒçš„è¡¨ã€‚å‰è€…æ˜¯â€œæ’è¯¾.è¯¾ç¨‹â€ï¼Œåè€…æ˜¯â€œæŠ¥å.è¯¾ç¨‹â€ã€‚ä¸¤è€…çš„å±æ€§ä¹Ÿå„ä¸ç›¸åŒï¼Œå‰è€…æ˜¯ï¼šæ’è¯¾.è¯¾ç¨‹ï¼ˆåç§°ã€ä»‹ç»ã€é€‚åˆå¹´é¾„ã€å­¦è´¹ã€æ•™å®¤ï¼‰ï¼Œåè€…æ˜¯ï¼šæŠ¥å.è¯¾ç¨‹ï¼ˆåç§°ï¼‰ã€‚å½“ç„¶ï¼Œè¿™ä¸¤ä¸ªæ¦‚å¿µçš„â€œè¯¾ç¨‹åç§°â€å’Œè¯¾ç¨‹ç¼–å·éƒ½æ˜¯ä¸€è‡´çš„ã€‚å½“â€œæŠ¥åâ€é™ç•Œä¸Šä¸‹æ–‡éœ€è¦è®¿é—®â€œæ’è¯¾â€é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„â€œè¯¾ç¨‹â€æ¦‚å¿µæ¥è·å–â€œè¯¾ç¨‹ä»‹ç»â€ç­‰ä¿¡æ¯æ—¶ï¼Œéœ€è¦é€šè¿‡ä¸¤è€…ä¹‹é—´çš„â€œç¿»è¯‘å™¨â€æ¥æ ¹æ®ä¸Šè¿°ä¸€è‡´çš„è¯¾ç¨‹ç¼–å·æ¥è¿›è¡Œç¿»è¯‘å’Œè½¬æ¢ã€‚\nå››ã€é™ç•Œçº¸ç¬”å»ºæ¨¡æ³•çš„3ç‚¹ä¼˜åŠ¿\nåˆ’åˆ†æ ¸å¿ƒé¢†åŸŸæœ‰åŠ©äºâ€œåˆ†è€Œæ²»ä¹‹â€ï¼šä¸€æ—¦ç¡®å®šäº†æ ¸å¿ƒé¢†åŸŸï¼Œé™ç•Œä¸Šä¸‹æ–‡ä¹Ÿå°±ç¡®å®šäº†ï¼Œä¸åŒçš„é™ç•Œä¸Šä¸‹æ–‡ä¹‹é—´é€šè¿‡â€œç¿»è¯‘å™¨â€æ¥å½¼æ­¤æ²Ÿé€šå¹¶å±è”½å¹²æ‰°ï¼Œè¿™æ ·å°±é¿å…äº†â€œå¤§æ³¥çƒâ€çš„è®¾è®¡ï¼Œå¹¶æœ‰åŠ©äºæ¼”è¿›åˆ°å¾®æœåŠ¡æ¶æ„ã€‚\nâ€œèšé›†æ ¹â€æœ‰åŠ©äºæ•°æ®å®Œæ•´æ€§ï¼šæ¯ä¸ªé™ç•Œä¸Šä¸‹æ–‡éƒ½æœ‰ä¸€ä¸ªâ€œèšé›†æ ¹â€çš„æ¦‚å¿µï¼Œå¤–ç•Œå¯¹å…¶ä¸‹å±æ¦‚å¿µçš„è®¿é—®éƒ½å¿…é¡»é€šè¿‡å®ƒæ¥è¿›è¡Œï¼Œè¿™æ ·æ—¢æ–¹ä¾¿å®šä½èŒè´£ï¼Œä¹Ÿæœ‰åŠ©äºå¢å¼ºæ•°æ®çš„å®Œæ•´æ€§ã€‚\nç”¨â€œçº¸å’Œç¬”â€ç”»æ°å¥½å¤Ÿç”¨çš„æ¦‚å¿µæœ‰åŠ©äºé¿å…è¿‡åº¦è®¾è®¡ï¼šæ¯ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­è¦ç®¡ç†çš„æ¦‚å¿µï¼Œéƒ½æ˜¯é€šè¿‡â€œå€’é€€åˆ°æ²¡æœ‰ç”µè„‘è€Œç”¨çº¸å’Œç¬”çš„æ—¶ä»£å¦‚ä½•ç®¡ç†â€æ¥å¼•å¯¼å‡ºæ¥çš„ï¼Œç”¨çº¸å’Œç¬”æ¥è®°å½•ï¼Œèƒ½ä¿ƒä½¿äººé¿å…å†™è¿‡å¤šçš„ä¿¡æ¯ï¼Œè€Œåªå†™é™ç•Œä¸Šä¸‹æ–‡ä¸­æ°å¥½å¤Ÿç”¨çš„æ¦‚å¿µã€‚\n\näº”ã€æ€»ç»“å››è‰²å»ºæ¨¡æ³•æœ€å¤§çš„äº®ç‚¹æ˜¯æŒ‰æ—¶é—´å‘å±•çš„å…ˆåé¡ºåºï¼Œè¯†åˆ«èµ·â€œè¿½æº¯å•æ®â€ä½œç”¨çš„â€œæ—¶æ ‡â€æ¦‚å¿µï¼Œä»è€Œèƒ½æŠŠæ¡ä¸šåŠ¡æ ¸å¿ƒæ•°æ®ï¼Œç®€ä¾¿æœ‰æ•ˆã€‚\né™ç•Œçº¸ç¬”å»ºæ¨¡æ³•ï¼Œä½¿ç”¨äº†DDDä¸­çš„â€é™ç•Œä¸Šä¸‹æ–‡â€ä¸â€œèšé›†â€çš„æ¦‚å¿µä»¥åŠâ€œçº¸å’Œç¬”æ¥ç®¡ç†â€æ–¹æ³•ï¼Œæ¥å®ç°â€œåˆ†è€Œæ²»ä¹‹â€ï¼Œå¢å¼ºæ•°æ®çš„å®Œæ•´æ€§ï¼Œé¿å…è¿‡åº¦è®¾è®¡ã€‚\n\næ³¨ï¼š\n[1] å››è‰²å»ºæ¨¡æ³•ï¼šç»è¿‡å¾æ˜Šæ”¹ç¼–çš„â€œå››è‰²å»ºæ¨¡æ³•â€å‚è§ï¼šhttp://www.infoq.com/cn/articles/xh-four-color-modeling\n[2] é™ç•Œä¸Šä¸‹æ–‡ï¼šBounded Contextï¼ŒDDDæ¦‚å¿µï¼Œä¸â€œæ ¸å¿ƒé¢†åŸŸâ€(Core Domain)ä¸€ä¸€å¯¹åº”ï¼Œå®ƒè¢«ç¨‹åºå‘˜æ‰€å…³æ³¨ï¼ŒåŒ…å«å…¶æ‰€å¯¹åº”çš„æ ¸å¿ƒé¢†åŸŸçš„æ¦‚å¿µæ¨¡å‹ã€‚\n[3] èšé›†ï¼šAggregatesï¼ŒDDDæ¦‚å¿µï¼ŒæŒ‡æŸä¸€ç°‡å½¼æ­¤ç›¸å…³è”çš„æ¦‚å¿µé›†åˆã€‚\n[4] æ—¶æ ‡å¯¹è±¡ï¼šæŒ‡å››è‰²å»ºæ¨¡æ³•ä¸­çš„â€Moment, Intervalâ€æ¦‚å¿µï¼Œç”¨çº¢è‰²è¡¨ç¤ºã€‚è¿‘ä¼¼äºDDDä¸­çš„Repositoriesæ¦‚å¿µã€‚\n[5] â€œäººã€åœ°ã€ç‰©â€ï¼šæŒ‡å››è‰²å»ºæ¨¡æ³•ä¸­çš„â€œParty, Place, Thingâ€æ¦‚å¿µï¼Œç”¨ç»¿è‰²è¡¨ç¤ºã€‚è¿‘ä¼¼äºDDDä¸­çš„Entitiesæ¦‚å¿µã€‚\n[6] è§’è‰²ï¼šæŒ‡å››è‰²å»ºæ¨¡æ³•ä¸­çš„â€œRoleâ€æ¦‚å¿µï¼Œç”¨é»„è‰²è¡¨ç¤ºã€‚è¿‘ä¼¼äºDDDä¸­çš„Servicesæ¦‚å¿µã€‚\n[7] æè¿°ä¿¡æ¯ï¼šæŒ‡å››è‰²å»ºæ¨¡æ³•ä¸­çš„â€œDescriptionâ€æ¦‚å¿µï¼Œç”¨è“è‰²è¡¨ç¤ºã€‚è¿‘ä¼¼äºDDDä¸­å›½çš„Value Objectsæ¦‚å¿µã€‚\n[8] èšé›†æ ¹ï¼šAggregate Rootï¼ŒDDDæ¦‚å¿µï¼ŒæŒ‡å¯¹å…¶æ‰€å±çš„èšé›†å†…çš„ç›¸å…³ä»å±æ¦‚å¿µè¿›è¡Œç»Ÿä¸€è®¿é—®æ§åˆ¶çš„é‚£ä¸ªæ¦‚å¿µã€‚\n[9] æ ¸å¿ƒé¢†åŸŸï¼šCore Domainï¼ŒDDDæ¦‚å¿µï¼Œä¸â€œé™ç•Œä¸Šä¸‹æ–‡â€(Bounded Context)ä¸€ä¸€å¯¹åº”ï¼ŒæŒ‡æŸä¸ªä¸šåŠ¡ä¸“å®¶æ‰€å…³æ³¨çš„ã€å…·æœ‰å·®å¼‚åŒ–ç«äº‰ä¼˜åŠ¿çš„ã€ç›¸å¯¹ç‹¬ç«‹çš„ä¸šåŠ¡é¢†åŸŸã€‚\n[10] Entityï¼šDDDæ¦‚å¿µï¼Œè¡¨ç¤ºå…·æœ‰å”¯ä¸€æ ‡è¯†çš„æ¦‚å¿µã€‚\n[11] Value Object: DDDæ¦‚å¿µï¼Œè¡¨ç¤ºä¸å¿…æœ‰å”¯ä¸€æ ‡è¯†çš„æ¦‚å¿µã€‚\n","categories":["é¢†åŸŸé©±åŠ¨è®¾è®¡"]},{"title":"ä»ä¸‰æ˜æ²»åˆ°å…­è¾¹å½¢","url":"/posts/47281/","content":"è½¯ä»¶é¡¹ç›®çš„å¥—è·¯å¦‚æœä½ å¹³æ—¶çš„å·¥ä½œæ˜¯åšå„ç§é¡¹ç›®ï¼ˆè€Œä¸æ˜¯äº§å“ï¼‰ï¼Œè€Œä¸”ä½ å·¥ä½œçš„æ—¶é—´è¶³å¤Ÿé•¿ï¼Œé‚£ä¹ˆè‡ªç„¶è§è¯†è¿‡å¾ˆå¤šä¸åŒç±»å‹çš„é¡¹ç›®ã€‚åœ¨åˆ‡æ¢è¿‡å¤šæ¬¡ä¸Šä¸‹æ–‡ä¹‹åï¼Œä½œä¸ºç¨‹åºå‘˜çš„ä½ ï¼Œè‡ªç„¶è€Œç„¶çš„ä¼šæ„Ÿåˆ°ä¸€å®šç¨‹åº¦çš„é‡å¤ï¼šç¨åŠ æŠ½è±¡ï¼Œä½ ä¼šå‘ç°æ‰€æœ‰çš„ä¸šåŠ¡ç³»ç»Ÿéƒ½å‡ ä¹åšç€åŒæ ·çš„äº‹æƒ…ï¼š\n\nä»æŸç§æ¸ é“ä¸ç”¨æˆ·äº¤äº’ï¼Œä»è€Œæ¥å—è¾“å…¥ï¼ˆNative Appï¼ŒMobile Siteï¼ŒWeb Siteï¼Œæ¡Œé¢åº”ç”¨ç­‰ç­‰ï¼‰\nå°†ç”¨æˆ·è¾“å…¥çš„æ•°æ®æŒ‰ç…§ä¸€å®šè§„åˆ™è¿›è¡Œè½¬æ¢ï¼Œç„¶åä¿å­˜èµ·æ¥ï¼ˆé€šå¸¸æ˜¯å…³ç³»å‹æ•°æ®åº“ï¼‰\nå°†ä¸šåŠ¡æ•°æ®ä»¥æŸç§å½¢å¼å±•ç°ï¼ˆåˆ—è¡¨ï¼Œå¡ç‰‡ï¼Œåœ°å›¾ä¸Šçš„Markerï¼Œæ—¶é—´çº¿ç­‰ï¼‰\n\nç¨åŠ ç®€åŒ–ï¼Œä½ ä¼šå‘ç°å¤§éƒ¨åˆ†ä¸šåŠ¡ç³»ç»Ÿå…¶å®å°±æ˜¯å¯¹æŸç§å½¢å¼çš„èµ„æºè¿›è¡Œç®¡ç†ã€‚æ‰€è°“ç®¡ç†ï¼Œä¹Ÿæ— éæ˜¯å¢åˆ æŸ¥æ”¹ï¼ˆCRUDï¼‰æ“ä½œã€‚æ¯”å¦‚çŸ¥ä¹æ˜¯å¯¹â€œé—®é¢˜â€è¿™ç§èµ„æºçš„ç®¡ç†ï¼ŒLinkedInæ˜¯å¯¹â€œProfileâ€çš„ç®¡ç†ï¼ŒJenkinså¯¹æ„å»ºä»»åŠ¡çš„ç®¡ç†ç­‰ç­‰ï¼Œç²—ç•¥çš„çœ‹èµ·æ¥éƒ½æ˜¯è¿™ä¸€ä¸ªå¥—è·¯ï¼ˆå½“ç„¶ï¼Œæ¯ä¸ªç³»ç»Ÿç®¡ç†çš„èµ„æºç±»å‹å¯èƒ½ä¸æ­¢ä¸€ç§ï¼Œæ¯”å¦‚çŸ¥ä¹è¿˜æœ‰æ—¶é—´çº¿ï¼ŒLiveï¼ŒåŠ¨æ€ç­‰ç­‰èµ„æºçš„ç®¡ç†ï¼‰ã€‚\nè¿™äº›æƒ…å†µç”šè‡³ä¼šç»™å¼€å‘è€…ä¸€ç§é”™è§‰ï¼šä¸–ç•Œä¸Šæ‰€æœ‰çš„ä¿¡æ¯ç®¡ç†ç³»ç»Ÿéƒ½æ˜¯ä¸€æ ·çš„ï¼Œä¸åŒçš„ä»…ä»…æ˜¯æŠ€æœ¯æ ˆå’Œæ“ä½œçš„ä¸šåŠ¡å¯¹è±¡è€Œå·²ã€‚å¦‚æœå†™å¥½ä¸€ä¸ªæ¨¡æ¿ï¼Œå‡ ä¹éƒ½å¯ä»¥å°†å¼€å‘è¿‡ç¨‹è‡ªåŠ¨åŒ–èµ·æ¥ã€‚äº‹å®ä¸Šï¼Œæœ‰ä¸€äº›å·¥å…·å·²ç»æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶ï¼ˆæ¯”å¦‚yamlæˆ–è€…json/XMLï¼‰çš„æè¿°æ¥ç”Ÿæˆå¯¹åº”çš„ä»£ç çš„åŠŸèƒ½ã€‚\nå¦‚æœçœŸæ˜¯è¿™æ ·çš„è¯ï¼Œè½¯ä»¶å¼€å‘å°±ç®€å•å¤šäº†ï¼Œåªéœ€è¦çŸ¥é“å®¢æˆ·ä¸šåŠ¡çš„èµ„æºï¼Œç„¶åå†™å†™é…ç½®æ–‡ä»¶ï¼Œæœ€åæ‰§è¡Œäº†ä¸€ä¸ªå‘½ä»¤æ¥ç”Ÿæˆåº”ç”¨ç¨‹åºå°±å¥½äº†ã€‚ä¸è¿‡å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ç”Ÿæ´»åœ¨ç°å®ä¸–ç•Œçš„è¯ï¼Œè¿˜æ˜¯è¶æ—©æ”¾å¼ƒè¿™ç§å®Œå…¨è‡ªåŠ¨åŒ–çš„æƒ³æ³•å§ã€‚\nå¤æ‚çš„ä¸šåŠ¡ç°å®ä¸–ç•Œçš„è½¯ä»¶å¼€å‘æ˜¯å¤æ‚çš„ï¼Œå¤æ‚æ€§å¹¶ä¸ä½“ç°åœ¨å…·ä½“çš„æŠ€æœ¯æ ˆä¸Šã€‚å¦‚Javaï¼ŒSpringï¼ŒDockerï¼ŒMySQLç­‰ç­‰å…·ä½“çš„æŠ€æœ¯æ˜¯å¯ä»¥å­¦ä¹ å¾ˆå¿«å°±ç†Ÿç»ƒæŒæ¡çš„ã€‚è½¯ä»¶çœŸæ­£å¤æ‚çš„éƒ¨åˆ†ï¼Œå¾€å¾€æ˜¯ä¸šåŠ¡æœ¬èº«ï¼Œæ¯”å¦‚èˆªç©ºå…¬å¸çš„è¶…å”®ç­–ç•¥ï¼Œåœ¨è¶…å”®ä¹‹åRemoveä¹˜å®¢çš„ç­–ç•¥ç­‰ï¼›æ¯”å¦‚äºšé©¬é€Šçš„æ‰“æŠ˜ç­–ç•¥ï¼Œç‰©æµç­–ç•¥ç­‰ã€‚\nç”¨è½¯ä»¶æ¨¡å‹å¦‚ä½•ä¼˜é›…è€Œåˆç†çš„ååº”å¤æ‚çš„ä¸šåŠ¡ï¼ˆä»¥ä¾¿åœ¨æœªæ¥ä¸šåŠ¡å‘ç”Ÿå˜åŒ–æ—¶å¯ä»¥æ›´å¿«é€Ÿï¼Œæ›´ä½é”™è¯¯çš„ä½œå‡ºå“åº”ï¼‰æœ¬èº«ä¹Ÿæ˜¯å¤æ‚çš„ã€‚è¦å°†å¤æ‚çš„ä¸šåŠ¡è§„åˆ™è½¬æ¢æˆè½¯ä»¶æ¨¡å‹æ˜¯è½¯ä»¶æ´»åŠ¨ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ï¼Œä¹Ÿæ˜¯ä¿¡æ¯ä¼ é€’å¾€å¾€ä¼šå¤±çœŸçš„ä¸€ç¯ã€‚ä¸šåŠ¡äººå‘˜è¯´çš„Aå¯èƒ½è¢«è½¯ä»¶å¼€å‘è€…ç†è§£æˆZï¼Œåè¿‡æ¥ä¹Ÿä¸€æ ·ã€‚\nä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ç»™ç§Ÿæ¥çš„æˆ¿å­ä¹°äº†1å¹´çš„è”é€šå®½å¸¦ã€‚å¯æ˜¯è¿‡äº†6ä¸ªæœˆåï¼Œæˆ¿ä¸œæƒ³è¦å–æˆ¿å­æŠŠæˆ‘èµ¶äº†å‡ºæ¥ï¼Œåœ¨æ¬å®¶ä¹‹åï¼Œæˆ‘éœ€è¦é€šçŸ¥è”é€šå…¬å¸å¸®æˆ‘åšç§»æœºæœåŠ¡ã€‚\nå¦‚æœçº¯ç²¹ä»å¼€å‘è€…çš„è§’åº¦å‡ºå‘ï¼Œå†™å‡ºæ¥çš„ä»£ç å¯èƒ½çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š\npublic class Customer &#123;     private String address;     public void setAddress(String address) &#123;         this.address = address;     &#125;     public String getAddress() &#123;         return this.address;     &#125;&#125;\n\nä¸­è§„ä¸­çŸ©ï¼Œä¸€ä¸ªç®€å•çš„å€¼å¯¹è±¡ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œé€šè¿‡ä¸é¢†åŸŸä¸“å®¶çš„äº¤æµä¹‹åï¼Œå†™å‡ºæ¥çš„ä»£ç ä¼šæ˜¯è¿™æ ·ï¼š\npublic class Customer &#123;     private String address;         public void movingHome(String address) &#123;         this.address = address;     &#125;&#125;\n\né€šè¿‡å¼•å…¥ä¸šåŠ¡åœºæ™¯ä¸­çš„æ¦‚å¿µmovingHomeï¼Œä»£ç å°±å˜å¾—æœ‰äº†ä¸šåŠ¡å«ä¹‰ï¼Œé™¤äº†å¯è¯»æ€§å˜å¼ºä¹‹å¤–ï¼Œè¿™æ ·çš„ä»£ç ä¹Ÿä¾¿äºå’Œé¢†åŸŸä¸“å®¶è¿›è¡Œäº¤æµå’Œè®¨è®ºã€‚Ericåœ¨é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain Drvien Designï¼‰ä¸­å°†ç»Ÿä¸€è¯­è¨€è§†ä¸ºå®æ–½DDDçš„å…ˆå†³æ¡ä»¶ã€‚\nå±‚æ¬¡æ¶æ„ï¼ˆä¸‰æ˜æ²»ï¼‰\nAll problems in computer science can be solved by another level of indirection, except of course for the problem of too many indirections. â€“ David Wheeler\n\nä¸Šæ–‡æåˆ°ï¼Œä¸šåŠ¡ç³»ç»Ÿå¯¹å¤–çš„å‘ˆç°æ˜¯å¯¹æŸç§èµ„æºçš„ç®¡ç†ï¼Œè€Œä¸”ï¼Œç°å®ä¸–ç•Œé‡Œçš„ä¸šåŠ¡ç³»ç»Ÿå¾€å¾€è¦å¯¹å¤šç§èµ„æºè¿›è¡Œç®¡ç†ã€‚è¿™äº›èµ„æºè¿˜ä¼šäº’ç›¸å¼•ç”¨ï¼Œäº’ç›¸äº¤ç»‡ã€‚æ¯”å¦‚ä¸€ä¸ªçœ‹æ¿ç³»ç»Ÿä¸­çš„æ³³é“ã€ä»·å€¼æµã€å¡ç‰‡ç­‰ï¼›LinkedInä¸­çš„å…¬å¸ï¼Œå­¦æ ¡ï¼Œä¸ªäººï¼Œç ”ç©¶æœºæ„ï¼Œé¡¹ç›®ï¼Œé¡¹ç›®æˆå‘˜ç­‰ï¼Œå®ƒä»¬å¾€å¾€ä¼šæœ‰åµŒå¥—ã€ä¾èµ–ç­‰å…³ç³»ã€‚\nä¸ºäº†ç®¡ç†åºå¤§çš„èµ„æºç§ç±»å’Œç¹å¤çš„å¼•ç”¨å…³ç³»ï¼Œäººä»¬è‡ªç„¶è€Œç„¶çš„å°†åšåŒæ ·äº‹æƒ…çš„ä»£ç æ”¾åœ¨äº†ç»Ÿä¸€çš„åœ°æ–¹ã€‚å°†ä¸åŒèŒè´£çš„äº‹ç‰©åˆ†ç±»æ˜¯äººç±»åœ¨å¤„ç†å¤æ‚é—®é¢˜æ—¶è‡ªç„¶ä½¿ç”¨çš„ä¸€ç§æ–¹å¼ï¼Œå°†å¤æ‚çš„ã€åºå¤§çš„é—®é¢˜åˆ†è§£ã€é™çº§æˆå¯ä»¥è§£å†³çš„é—®é¢˜ï¼Œç„¶ååˆ†è€Œæ²»ä¹‹ã€‚\næ¯”å¦‚åœ¨å®è·µä¸­ ï¼Œå±•ç°éƒ¨åˆ†çš„ä»£ç åªè´Ÿè´£å°†æ•°æ®æ¸²æŸ“å‡ºæ¥ï¼Œåº”ç”¨éƒ¨åˆ†çš„ä»£ç åªè´Ÿè´£åºåˆ—åŒ–/ååºåˆ—åŒ–ã€ç»„ç»‡å¹¶åè°ƒå¯¹ä¸šåŠ¡æœåŠ¡çš„è°ƒç”¨ï¼Œæ•°æ®è®¿é—®å±‚åˆ™è´Ÿè´£å±è”½åº•å±‚å…³ç³»å‹æ•°æ®åº“çš„å·®å¼‚ï¼Œä¸ºä¸Šå±‚æä¾›æ•°æ®ã€‚è¿™å°±æ˜¯å±‚çº§æ¶æ„çš„ç”±æ¥ï¼šä¸Šå±‚çš„ä»£ç ç›´æ¥ä¾èµ–äºä¸´è¿‘çš„ä¸‹å±‚ï¼Œä¸€èˆ¬ä¸å¯¹é—´æ¥çš„ä¸‹å±‚äº§ç”Ÿä¾èµ–ï¼Œå±‚æ¬¡ä¹‹é—´é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„APIæ¥é€šä¿¡ï¼ˆä¾èµ–é€šå¸¸ä¹Ÿæ˜¯å•å‘çš„ï¼‰ã€‚\nä»¥ç°ä»£çš„çœ¼å…‰æ¥çœ‹ï¼Œå±‚æ¬¡æ¶æ„çš„å‡ºç°ä¼¼ä¹ç†æ‰€åº”å½“ã€è‡ªç„¶è€Œç„¶ï¼Œå…¶å®å®ƒä¹Ÿæ˜¯ç»è¿‡äº†å¾ˆå¤šæ¬¡çš„æ¼”è¿›è€Œæ¥çš„ã€‚ä»¥JavaEEä¸–ç•Œä¸ºä¾‹ï¼Œæ—©æœŸäººä»¬ä¼šæŠŠåº”ç”¨ç¨‹åºä¸­è´Ÿè´£è¯·æ±‚å¤„ç†ã€æ–‡ä»¶IOã€ä¸šåŠ¡é€»è¾‘ã€ç»“æœç”Ÿæˆéƒ½æ”¾åœ¨servletä¸­ï¼›åæ¥å‘æ˜äº†å¯ä»¥è¢«Webå®¹å™¨ç¿»è¯‘æˆservletçš„JSPï¼Œè¿™æ ·æ•°æ®å’Œå±•ç°å¯ä»¥å¾—åˆ°æ¯”è¾ƒå¥½çš„åˆ†ç¦»ï¼ˆå½“ç„¶ä¸­é—´è¿˜æœ‰ä¸€äº›è¿‚å›ï¼Œæ¯”å¦‚JSTLã€taglibçš„æ»¥ç”¨åˆå¯¼è‡´å¾ˆå¤šé€»è¾‘è¢«æ³„éœ²åˆ°äº†å±•ç°å±‚ï¼‰ï¼›æ•°æ®å­˜å‚¨åˆ™ä»JDBCæ¼”åŒ–åˆ°äº†å„ç§ORMæ¡†æ¶ï¼Œæœ€åå†åˆ°JPAçš„å¤§ä¸€ç»Ÿã€‚\nå¦‚æœç°åœ¨æŠŠä¸€ä¸ªSpring-Bootå†™çš„RESTfulåç«¯ï¼Œå’ŒSSHï¼ˆSpring-Struts-Hibernateï¼‰æµè¡Œçš„å¹´ä»£çš„åç«¯æ¥åšå¯¹æ¯”ï¼Œé™¤äº†ä»£ç é‡ä¸Šä¼šå°‘å¾ˆå¤šä»¥å¤–ï¼Œå±‚æ¬¡ç»“æ„ä¸ŠåŸºæœ¬ä¸Šå¹¶æ— å¤ªå¤§åŒºåˆ«ã€‚ä¸è¿‡å½“å¹´åœ¨SSHä¸­å¤æ‚çš„é…ç½®ï¼Œæ¯”å¦‚å¤§é‡çš„XMLå˜æˆäº†ä»£ç ä¸­çš„æ³¨è§£ï¼Œå®¹å™¨è¢«å†…ç½®åˆ°åº”ç”¨ä¸­ï¼Œä¸€äº›é…ç½®æ¼”å˜æˆäº†æƒ¯ä¾‹ï¼Œå¤§è‡´æ¥çœ‹ï¼Œåº”ç”¨çš„å±‚æ¬¡åŸºæœ¬è¿˜æ˜¯ä¿ç•™äº†ï¼š\n\nå±•ç°å±‚\nåº”ç”¨å±‚\næ•°æ®è®¿é—®å±‚\n\nåœ¨æœ‰äº›åœºæ™¯ä¸‹ï¼Œåº”ç”¨å±‚å†…è¿˜å¯èƒ½åˆ’åˆ†å‡ºä¸€ä¸ªæœåŠ¡å±‚ã€‚\n\nå‰åç«¯åˆ†ç¦»éšç€æ™ºèƒ½è®¾å¤‡çš„å¤§çˆ†å‘ï¼Œç§»åŠ¨ç«¯å˜æˆäº†å±•ç°å±‚çš„ä¸»åŠ›ï¼Œå¦‚ä½•è®©åº”ç”¨ç¨‹åºå¾ˆå®¹æ˜“çš„é€‚é…æ–°çš„å±•ç°å±‚å˜æˆäº†æ–°çš„æŒ‘æˆ˜ã€‚è¿™ä¸ªæ–°çš„æŒ‘æˆ˜é©±åŠ¨å‡ºäº†å‰åç«¯åˆ†ç¦»æ–¹å¼ï¼Œå³åç«¯åªæä¾›æ•°æ®ï¼ˆJSONæˆ–è€…XMLï¼‰ï¼Œå‰ç«¯åº”ç”¨æ¥å±•ç°è¿™äº›æ•°æ®ã€‚ç”šè‡³å¾ˆå¤šæ—¶å€™ï¼Œå‰ç«¯ä¼šæˆä¸ºä¸€ä¸ªç‹¬ç«‹çš„åº”ç”¨ç¨‹åºï¼Œæœ‰è‡ªå·±çš„MVC/MVPï¼Œåªéœ€è¦æœ‰ä¸€ä¸ªHTTPåç«¯å°±å¯ä»¥ç‹¬ç«‹å·¥ä½œã€‚\n\nå‰åç«¯åˆ†ç¦»å¯ä»¥å¾ˆå¥½çš„è§£å†³å¤šç«¯æ¶ˆè´¹è€…çš„é—®é¢˜ï¼Œåç«¯åº”ç”¨ç°åœ¨ä¸åŒºåˆ†å‰ç«¯çš„æ¶ˆè´¹è€…åˆ°åº•æ˜¯è°ï¼Œå®ƒæ—¢å¯ä»¥æ˜¯é€šè¿‡4Gç½‘ç»œè¿æ¥çš„iOSä¸Šçš„Native Appï¼Œä¹Ÿå¯ä»¥æ˜¯iMacæ¡Œé¢ä¸Šçš„Chromeæµè§ˆå™¨ï¼Œè¿˜å¯ä»¥æ˜¯Androidä¸Šçš„çŒè±¹æµè§ˆå™¨ã€‚ç”šè‡³å®ƒè¿˜å¯ä»¥æ˜¯å¦ä¸€ä¸ªåå°çš„åº”ç”¨ç¨‹åºï¼šæ€»ä¹‹ï¼Œåªè¦å¯ä»¥æ¶ˆè´¹HTTPåè®®çš„æ–‡æœ¬å°±å¯ä»¥äº†ï¼\nè¿™ä¸å¾—ä¸è¯´æ˜¯ä¸€ä¸ªéå¸¸å¤§çš„è¿›æ­¥ï¼Œä¸€æ—¦åç«¯åº”ç”¨åŸºæœ¬ç¨³å®šï¼Œé¢‘ç¹æ”¹å˜çš„ç”¨æˆ·ç•Œé¢ä¸ä¼šå½±å“åç«¯çš„å‘å¸ƒè®¡åˆ’ï¼Œæ‰‹æœºç”¨æˆ·çš„ä½“éªŒæ”¹è¿›ä¹Ÿä¸åç«¯çš„APIè®¾è®¡æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œä¼¼ä¹ä¸€åˆ‡éƒ½å˜çš„ç¾å¥½èµ·æ¥äº†ã€‚\nä¸šåŠ¡ä¸åŸºç¡€è®¾æ–½åˆ†ç¦»ä¸è¿‡ï¼Œå¦‚æœæœ‰ä¸€ä¸ªæ¶ˆè´¹è€…ï¼ˆä¸€ä¸ªä¸šåŠ¡ç³»ç»Ÿï¼‰ï¼Œå®ƒæ ¹æœ¬ä¸ä½¿ç”¨HTTPåè®®æ€ä¹ˆåŠï¼Ÿæ¯”å¦‚ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…è‡ªå®šä¹‰çš„Socketåè®®æ¥è¿›è¡Œé€šä¿¡ï¼Œåº”ç”¨ç¨‹åºå¦‚ä½•å¤„ç†è¿™ç§åœºæ™¯ï¼Ÿ è¿™ç§æƒ…å†µå°±å¥½æ¯”ä½ çœ‹åˆ°äº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š\nhttpService(request, response);\n\nä½œä¸ºç¨‹åºå‘˜ï¼Œè‡ªç„¶ä¼šåšä¸€æ¬¡æŠ½è±¡ï¼Œå°†åè®®ä½œä¸ºå‚æ•°ä¼ å…¥ï¼š\nservice(request, response, protocol);\n\næ›´è¿›ä¸€æ­¥ï¼Œprotocolå¯ä»¥åœ¨serviceä¹‹å¤–æ„é€ ï¼Œå¹¶æ³¨å…¥åˆ°åº”ç”¨ä¸­ï¼Œè¿™æ ·ä»£ç å°±å¯ä»¥é€‚é…å¾ˆå¤šç§åè®®ï¼ˆæ¯”å¦‚æ¶ˆæ¯é˜Ÿåˆ—ï¼Œæˆ–è€…å…¶ä»–è‡ªå®šä¹‰çš„Socketåè®®ï¼‰ã€‚ æ¯”å¦‚ï¼š\npublic interface Protocol &#123;  void transform(Request request, Response response);&#125;public class HTTP implements Protocol &#123;&#125;public class MyProtocol implements Protocol &#123;&#125;public class Service &#123;        public Service(Protocol protocol) &#123;         this.protocol = protocol;        &#125;             public void service(request, response) &#123;         //business logic here         protocol.transfrom(request, response);        &#125;&#125;\n\nç±»ä¼¼çš„ï¼Œå¯¹äºæ•°æ®çš„æŒä¹…åŒ–ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨åŒæ ·çš„åŸåˆ™ã€‚å¯¹äºä»£ç ä¸­è¯¸å¦‚è¿™æ ·çš„ä»£ç ï¼š\npersisteToDatabase(data);\n\nåœ¨ä¿®æ”¹ä¹‹åä¼šå˜æˆï¼š persistenceTo(data, repository);\nåº”ç”¨ä¾èµ–å€’ç½®åŸåˆ™ï¼Œæˆ‘ä»¬ä¼šå†™å‡ºè¿™æ ·çš„å½¢å¼ï¼š\npublic class DomainService &#123;     public BusinessLogic(Repository repository) &#123;           this.repository = repository     &#125;      public void perform() &#123;           //perform business logic           repository.save(record);     &#125;&#125;\n\nå¯¹äºRepositoryå¯èƒ½ä¼šæœ‰å¤šç§å®ç°ã€‚æ ¹æ®ä¸åŒçš„éœ€æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªç”±çš„åœ¨å„ç§å®ç°ä¸­åˆ‡æ¢ï¼š\npublic class InMemoryRepository implements Repository &#123;&#125;public class RDBMSRepository implements Repository &#123;&#125;\n\nè¿™æ ·ä¸šåŠ¡é€»è¾‘å’Œå¤–å›´çš„ä¼ è¾“åè®®ã€æŒä¹…åŒ–æœºåˆ¶ã€å®‰å…¨ã€å®¡è®¡ç­‰ç­‰éƒ½éš”ç¦»å¼€æ¥äº†ï¼Œåº”ç”¨ç¨‹åºä¸å†ä¾èµ–å…·ä½“çš„ä¼ è¾“ç»†èŠ‚ï¼ŒæŒä¹…åŒ–ç»†èŠ‚ï¼Œè¿™äº›å…·ä½“çš„å®ç°ç»†èŠ‚åè¿‡æ¥ä¼šä¾èµ–äºåº”ç”¨ç¨‹åºã€‚\né€šè¿‡å°†ä¼ ç»Ÿå†…ç½®åœ¨å±‚æ¬¡æ¶æ„ä¸­çš„æ•°æ®åº“è®¿é—®å±‚ã€é€šä¿¡æœºåˆ¶ç­‰éƒ¨åˆ†çš„å‰¥ç¦»ï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ç®€å•çš„åˆ†ä¸ºå†…éƒ¨å’Œå¤–éƒ¨ä¸¤å¤§éƒ¨åˆ†ã€‚å†…éƒ¨æ˜¯ä¸šåŠ¡çš„æ ¸å¿ƒï¼Œä¹Ÿå°±æ˜¯DDDï¼ˆDomain Driven Designï¼‰ä¸­å¼ºè°ƒçš„é¢†åŸŸæ¨¡å‹ï¼ˆå…¶ä¸­åŒ…å«é¢†åŸŸæœåŠ¡ï¼Œå¯¹ä¸šåŠ¡æ¦‚å¿µçš„å»ºç«‹çš„æ¨¡å‹ç­‰ï¼‰ï¼›å¤–éƒ¨åˆ™æ˜¯ç±»ä¼¼RESTful APIï¼ŒSOAPï¼ŒAMQPï¼Œæˆ–è€…æ•°æ®åº“ï¼Œå†…å­˜ï¼Œæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åŠè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚\nè¿™ç§æ¶æ„é£æ ¼è¢«ç§°ä¸ºå…­è¾¹å½¢æ¶æ„ï¼Œä¹Ÿå«ç«¯å£é€‚é…å™¨æ¶æ„ã€‚\nå…­è¾¹å½¢æ¶æ„ï¼ˆç«¯å£é€‚é…å™¨ï¼‰å…­è¾¹å½¢æ¶æ„æœ€æ—©ç”±Alistair Cockburnæå‡ºã€‚åœ¨DDDç¤¾åŒºå¾—åˆ°äº†å‘å±•å’Œæ¨å¹¿ï¼Œç„¶åIDDDï¼ˆã€Šå®ç°é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹ï¼‰ä¸€ä¹¦ä¸­ï¼Œä½œè€…è¿›è¡Œäº†æ¯”è¾ƒæ·±å…¥çš„è®¨è®ºã€‚\n\nï¼ˆå›¾ç‰‡æ¥è‡ªï¼šslideshare.net ï¼‰\nç®€è€Œè¨€ä¹‹ï¼Œåœ¨å…­è¾¹å½¢æ¶æ„é£æ ¼ä¸­ï¼Œåº”ç”¨ç¨‹åºçš„å†…éƒ¨ï¼ˆä¸­é—´çš„æ©™è‰²å…­è¾¹å½¢ï¼‰åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼ŒåŸºäºä¸šåŠ¡è§„åˆ™çš„è®¡ç®—ï¼Œé¢†åŸŸå¯¹è±¡ï¼Œé¢†åŸŸäº‹ä»¶ç­‰ã€‚è¿™éƒ¨åˆ†æ˜¯ä¼ä¸šåº”ç”¨çš„æ ¸å¿ƒï¼šæ¯”å¦‚åœ¨çº¿å•†åº—é‡Œä»€ä¹ˆæ ·çš„å•†å“å¯ä»¥æ‰“æŠ˜ï¼Œå¯¹é‚£ç§ç±»å‹çš„ç”¨æˆ·è¿›è¡Œ80%çš„æŠ˜æ‰£ï¼›å–æ¶ˆä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„æµæ°´çº¿ä¼šéœ€è¦å‘ç”Ÿä»€ä¹ˆåŠ¨ä½œï¼Œåˆ é™¤ä¸€ä¸ªå·²ç»è¢«åˆ«çš„Jobä¾èµ–çš„Stageåˆåº”è¯¥å¦‚ä½•å¤„ç†ã€‚\nè€Œå¤–éƒ¨çš„ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¹³æ—¶æœ€ç†Ÿæ‚‰çš„è¯¸å¦‚RESTï¼ŒSOAPï¼ŒNoSQLï¼ŒSQLï¼ŒMessage Queueç­‰ï¼Œéƒ½é€šè¿‡ä¸€ä¸ªç«¯å£æ¥å…¥ï¼Œç„¶ååœ¨å†…å¤–ä¹‹é—´æœ‰ä¸€ä¸ªé€‚é…å™¨ç»„æˆçš„å±‚ï¼Œå®ƒè´Ÿè´£å°†ä¸åŒç«¯å£æ¥çš„æ•°æ®è¿›è¡Œè½¬æ¢ï¼Œç¿»è¯‘æˆé¢†åŸŸå†…éƒ¨å¯ä»¥è¯†åˆ«çš„æ¦‚å¿µï¼ˆé¢†åŸŸå¯¹è±¡ï¼Œé¢†åŸŸäº‹ä»¶ç­‰ï¼‰ã€‚\nå†…éƒ¨ä¸å…³å¿ƒæ•°æ®ä»ä½•è€Œæ¥ï¼Œä¸å…³å¿ƒæ•°æ®å¦‚ä½•å­˜å‚¨ï¼Œä¸å…³å¿ƒè¾“å‡ºæ—¶JSONè¿˜æ˜¯XMLï¼Œäº‹å®ä¸Šå®ƒå¯¹è°ƒç”¨è€…ä¸€æ— æ‰€çŸ¥ï¼Œå®ƒå¯ä»¥å¤„ç†çš„æ•°æ®å·²ç»æ˜¯ç»è¿‡é€‚é…å™¨è½¬æ¢è¿‡çš„é¢†åŸŸå¯¹è±¡äº†ã€‚\nå…­è¾¹å½¢æ¶æ„çš„ä¼˜ç‚¹\nä¸šåŠ¡é¢†åŸŸçš„è¾¹ç•Œæ›´åŠ æ¸…æ™°\næ›´å¥½çš„å¯æ‰©å±•æ€§\nå¯¹æµ‹è¯•çš„å‹å¥½æ”¯æŒ\næ›´å®¹æ˜“å®æ–½DDD\n\nè¦æ–°æ·»åŠ ä¸€ç§æ•°æ®åº“çš„æ”¯æŒï¼Œæˆ–è€…éœ€è¦å°†RESTfulçš„åº”ç”¨æ‰©å±•ä¸ºæ”¯æŒSOAPï¼Œæˆ‘ä»¬åªéœ€è¦å®šä¹‰ä¸€ç»„ç«¯å£-é€‚é…å™¨å³å¯ï¼Œå¯¹äºä¸šåŠ¡é€»è¾‘éƒ¨åˆ†æ— éœ€è§¦ç¢°ï¼Œè€Œä¸”å¯¹æ—¢æœ‰çš„ç«¯å£-é€‚é…å™¨ä¹Ÿä¸ä¼šæœ‰å½±å“ã€‚\nç”±äºä¸šåŠ¡ä¹‹å¤–çš„ä¸€åˆ‡éƒ½å±äºå¤–å›´ï¼Œæ‰€ä»¥åº”ç”¨ç¨‹åºæ˜¯çœŸçš„è·‘åœ¨äº†Webå®¹å™¨ä¸­è¿˜æ˜¯ä¸€ä¸ªJavaè¿›ç¨‹ä¸­å…¶å®æ˜¯æ— æ‰€è°“çš„ï¼Œè¿™æ—¶å€™è‡ªåŠ¨åŒ–æµ‹è¯•ä¼šå®¹æ˜“å¾ˆå¤šï¼Œå› ä¸ºæµ‹è¯•çš„é‡ç‚¹ï¼šä¸šåŠ¡é€»è¾‘å’Œå¤æ‚çš„è®¡ç®—éƒ½æ˜¯ç®€å•å¯¹è±¡ï¼Œä¹Ÿæ— éœ€å®¹å™¨ï¼Œæ•°æ®åº“ä¹‹ç±»çš„ç¯å¢ƒé—®é¢˜ï¼Œå•å…ƒçº§åˆ«çš„æµ‹è¯•å°±å¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†çš„ä¸šåŠ¡åœºæ™¯ã€‚\nè¿™ç§æ¶æ„æ¨¡å¼ç”šè‡³å¯èƒ½å½±å“åˆ°å›¢é˜Ÿçš„ç»„æˆï¼Œå¯¹ä¸šåŠ¡æœ‰æ·±å…¥ç†è§£çš„ä¸šåŠ¡ä¸“å®¶å’ŒæŠ€æœ¯ä¸“å®¶ä¸€èµ·æ¥å®Œæˆæ ¸å¿ƒä¸šåŠ¡é¢†åŸŸçš„å»ºæ¨¡åŠç¼–ç ï¼Œè€Œå¤–å›´çš„åˆ™å¯ä»¥äº¤ç»™æ–°äººæˆ–è€…å¹²è„†å¤–åŒ…å‡ºå»ã€‚\nåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä»å¼€å‘è€…çš„è§’åº¦è¿›è¡Œçš„å‡è®¾éƒ½ä¼šåœ¨äº‹åè¢«è¯æ˜æ˜¯é”™è¯¯çš„ã€‚äººä»¬åœ¨é¢„æµ‹è½¯ä»¶æœªæ¥æ¼”è¿›æ–¹å‘æ—¶å¾€å¾€ä¼šåšå¾ˆå¤šé”™è¯¯çš„å†³å®šã€‚æ¯”å¦‚å¯¹å…³ç³»å‹æ•°æ®åº“çš„é€‰ç”¨ï¼Œå¯¹å‰ç«¯æ¡†æ¶çš„é€‰ç”¨ï¼Œå¯¹ä¸­é—´ä»¶çš„é€‰ç”¨ç­‰ç­‰ï¼Œå…­è¾¹å½¢æ¶æ„å¯ä»¥å¾ˆå¥½çš„å¸®åŠ©æˆ‘ä»¬é¿å…è¿™ä¸€ç‚¹ã€‚\nå°ç»“è½¯ä»¶çš„æ ¸å¿ƒå¤æ‚åº¦åœ¨äºä¸šåŠ¡æœ¬èº«ï¼Œæˆ‘ä»¬éœ€è¦å¯¹ä¸šåŠ¡æœ¬èº«éå¸¸ç†Ÿæ‚‰æ‰å¯èƒ½æ­£ç¡®çš„ä¸ºä¸šåŠ¡å»ºæ¨¡ã€‚é€šè¿‡ç»Ÿä¸€çš„è¯­è¨€æˆ‘ä»¬å¯ä»¥ç¼–å†™å‡ºè¡¨æ„è€Œä¸”æ˜“äºå’Œä¸šåŠ¡äººå‘˜äº¤æµçš„æ¨¡å‹ã€‚\nå¦ä¸€æ–¹é¢æ¨¡å‹åº”è¯¥å°½å¯èƒ½çš„å’ŒåŸºç¡€è®¾æ–½ï¼ˆæ¯”å¦‚JSON/XMLçš„ï¼Œæ•°æ®åº“å­˜å‚¨ï¼Œé€šä¿¡æœºåˆ¶ç­‰ï¼‰åˆ†ç¦»å¼€ã€‚è¿™æ ·ä¸€æ¥å¯ä»¥å¾ˆå®¹æ˜“ç”¨mockçš„æ–¹å¼æ¥è§£è€¦æ¨¡å‹å’ŒåŸºç¡€è®¾æ–½ï¼Œä»è€Œæ›´å®¹æ˜“æµ‹è¯•å’Œä¿®æ”¹ï¼ŒäºŒæ¥æˆ‘ä»¬çš„é¢†åŸŸæ¨¡å‹ä¹Ÿæ›´ç‹¬ç«‹ï¼Œæ›´ç²¾ç®€ï¼Œåœ¨é€‚åº”æ–°çš„éœ€æ±‚æ—¶ä¿®æ”¹ä¹Ÿä¼šæ›´å®¹æ˜“ã€‚\n","categories":["é¢†åŸŸé©±åŠ¨è®¾è®¡"]},{"title":"åœ¨å¾®æœåŠ¡ä¸­ä½¿ç”¨é¢†åŸŸäº‹ä»¶","url":"/posts/34323/","content":"ç¨å¾®å›æƒ³ä¸€ä¸‹è®¡ç®—æœºç¡¬ä»¶çš„å·¥ä½œåŸç†æˆ‘ä»¬ä¾¿ä¸éš¾å‘ç°ï¼Œæ•´ä¸ªè®¡ç®—æœºçš„å·¥ä½œè¿‡ç¨‹å…¶å®å°±æ˜¯ä¸€ä¸ªå¯¹äº‹ä»¶çš„å¤„ç†è¿‡ç¨‹ã€‚å½“ä½ ç‚¹å‡»é¼ æ ‡ã€æ•²å‡»é”®ç›˜æˆ–è€…æ’ä¸ŠUç›˜æ—¶ï¼Œè®¡ç®—æœºä¾¿ä»¥ä¸­æ–­çš„å½¢å¼å¤„ç†å„ç§å¤–éƒ¨äº‹ä»¶ã€‚åœ¨è½¯ä»¶å¼€å‘é¢†åŸŸï¼Œäº‹ä»¶é©±åŠ¨æ¶æ„ï¼ˆEvent Driven Architectureï¼ŒEDAï¼‰æ—©å·²è¢«å¼€å‘è€…ç”¨äºå„ç§å®è·µï¼Œå…¸å‹çš„åº”ç”¨åœºæ™¯æ¯”å¦‚æµè§ˆå™¨å¯¹ç”¨æˆ·è¾“å…¥çš„å¤„ç†ã€æ¶ˆæ¯æœºåˆ¶ä»¥åŠSOAã€‚æœ€è¿‘å‡ å¹´é‡æ–°è¿›å…¥å¼€å‘è€…è§†é‡çš„å“åº”å¼ç¼–ç¨‹ï¼ˆReactive Programmingï¼‰æ›´æ˜¯å°†äº‹ä»¶ä½œä¸ºè¯¥ç¼–ç¨‹æ¨¡å‹ä¸­çš„ä¸€ç­‰å…¬æ°‘ã€‚å¯è§ï¼Œâ€œäº‹ä»¶â€è¿™ä¸ªæ¦‚å¿µä¸€ç›´åœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸­æ‰®æ¼”ç€é‡è¦çš„è§’è‰²ã€‚\nä¸€ã€è®¤è¯†é¢†åŸŸäº‹ä»¶é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰æ˜¯é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDomain Driven Designï¼ŒDDDï¼‰ä¸­çš„ä¸€ä¸ªæ¦‚å¿µï¼Œç”¨äºæ•è·æˆ‘ä»¬æ‰€å»ºæ¨¡çš„é¢†åŸŸä¸­æ‰€å‘ç”Ÿè¿‡çš„äº‹æƒ…ã€‚é¢†åŸŸäº‹ä»¶æœ¬èº«ä¹Ÿä½œä¸ºé€šç”¨è¯­è¨€ï¼ˆUbiquitous Languageï¼‰çš„ä¸€éƒ¨åˆ†æˆä¸ºåŒ…æ‹¬é¢†åŸŸä¸“å®¶åœ¨å†…çš„æ‰€æœ‰é¡¹ç›®æˆå‘˜çš„äº¤æµç”¨è¯­ã€‚æ¯”å¦‚ï¼Œåœ¨ç”¨æˆ·æ³¨å†Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šè¯´â€œå½“ç”¨æˆ·æ³¨å†ŒæˆåŠŸä¹‹åï¼Œå‘é€ä¸€å°æ¬¢è¿é‚®ä»¶ç»™å®¢æˆ·ã€‚â€ï¼Œæ­¤æ—¶çš„â€œç”¨æˆ·å·²ç»æ³¨å†Œâ€ä¾¿æ˜¯ä¸€ä¸ªé¢†åŸŸäº‹ä»¶ã€‚\nå½“ç„¶ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰å‘ç”Ÿè¿‡çš„äº‹æƒ…éƒ½å¯ä»¥æˆä¸ºé¢†åŸŸäº‹ä»¶ã€‚ä¸€ä¸ªé¢†åŸŸäº‹ä»¶å¿…é¡»å¯¹ä¸šåŠ¡æœ‰ä»·å€¼ï¼Œæœ‰åŠ©äºå½¢æˆå®Œæ•´çš„ä¸šåŠ¡é—­ç¯ï¼Œä¹Ÿå³ä¸€ä¸ªé¢†åŸŸäº‹ä»¶å°†å¯¼è‡´è¿›ä¸€æ­¥çš„ä¸šåŠ¡æ“ä½œã€‚ä¸¾ä¸ªå’–å•¡å…å»ºæ¨¡çš„ä¾‹å­ï¼Œå½“å®¢æˆ·æ¥åˆ°å‰å°æ—¶å°†äº§ç”Ÿâ€œå®¢æˆ·å·²åˆ°è¾¾â€çš„äº‹ä»¶ï¼Œå¦‚æœä½ å…³æ³¨çš„æ˜¯å®¢æˆ·æ¥å¾…ï¼Œæ¯”å¦‚éœ€è¦ä¸ºå®¢æˆ·é¢„ç•™ä½ç½®ç­‰ï¼Œé‚£ä¹ˆæ­¤æ—¶çš„â€œå®¢æˆ·å·²åˆ°è¾¾â€ä¾¿æ˜¯ä¸€ä¸ªå…¸å‹çš„é¢†åŸŸäº‹ä»¶ï¼Œå› ä¸ºå®ƒå°†ç”¨äºè§¦å‘ä¸‹ä¸€æ­¥â€”â€”â€œé¢„ç•™ä½ç½®â€æ“ä½œï¼›ä½†æ˜¯å¦‚æœä½ å»ºæ¨¡çš„æ˜¯å’–å•¡ç»“è´¦ç³»ç»Ÿï¼Œé‚£ä¹ˆæ­¤æ—¶çš„â€œå®¢æˆ·å·²åˆ°è¾¾â€ä¾¿æ²¡æœ‰å¤šå¤§å­˜åœ¨çš„å¿…è¦â€”â€”ä½ ä¸å¯èƒ½åœ¨ç”¨æˆ·åˆ°è¾¾æ—¶å°±ç«‹å³å‘å®¢æˆ·è¦é’±å¯¹å§ï¼Œè€Œâ€å®¢æˆ·å·²ä¸‹å•â€œæ‰æ˜¯å¯¹ç»“è´¦ç³»ç»Ÿæœ‰ç”¨çš„äº‹ä»¶ã€‚\nåœ¨å¾®æœåŠ¡ï¼ˆMicroservicesï¼‰æ¶æ„å®è·µä¸­ï¼Œäººä»¬å¤§é‡åœ°å€Ÿç”¨äº†DDDä¸­çš„æ¦‚å¿µå’ŒæŠ€æœ¯ï¼Œæ¯”å¦‚ä¸€ä¸ªå¾®æœåŠ¡åº”è¯¥å¯¹åº”DDDä¸­çš„ä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡ï¼ˆBounded Contextï¼‰ï¼›åœ¨å¾®æœåŠ¡è®¾è®¡ä¸­åº”è¯¥é¦–å…ˆè¯†åˆ«å‡ºDDDä¸­çš„èšåˆæ ¹ï¼ˆAggregate Rootï¼‰ï¼›è¿˜æœ‰åœ¨å¾®æœåŠ¡ä¹‹é—´é›†æˆæ—¶é‡‡ç”¨DDDä¸­çš„é˜²è…å±‚ï¼ˆAnti-Corruption Layer, ACLï¼‰ï¼›æˆ‘ä»¬ç”šè‡³å¯ä»¥è¯´DDDå’Œå¾®æœåŠ¡æœ‰ç€å¤©ç”Ÿçš„é»˜å¥‘ã€‚æ›´å¤šæœ‰å…³DDDçš„å†…å®¹ï¼Œè¯·å‚è€ƒç¬”è€…çš„å¦ä¸€ç¯‡æ–‡ç« æˆ–å‚è€ƒã€Šé¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹åŠã€Šå®ç°é¢†åŸŸé©±åŠ¨è®¾è®¡ã€‹ã€‚\nåœ¨DDDä¸­æœ‰ä¸€æ¡åŸåˆ™ï¼šä¸€ä¸ªä¸šåŠ¡ç”¨ä¾‹å¯¹åº”ä¸€ä¸ªäº‹åŠ¡ï¼Œä¸€ä¸ªäº‹åŠ¡å¯¹åº”ä¸€ä¸ªèšåˆæ ¹ï¼Œä¹Ÿå³åœ¨ä¸€æ¬¡äº‹åŠ¡ä¸­ï¼Œåªèƒ½å¯¹ä¸€ä¸ªèšåˆæ ¹è¿›è¡Œæ“ä½œã€‚ä½†æ˜¯åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å‘ç°ä¸€ä¸ªç”¨ä¾‹éœ€è¦ä¿®æ”¹å¤šä¸ªèšåˆæ ¹çš„æƒ…å†µï¼Œå¹¶ä¸”ä¸åŒçš„èšåˆæ ¹è¿˜å¤„äºä¸åŒçš„é™ç•Œä¸Šä¸‹æ–‡ä¸­ã€‚æ¯”å¦‚ï¼Œå½“ä½ åœ¨ç”µå•†ç½‘ç«™ä¸Šä¹°äº†ä¸œè¥¿ä¹‹åï¼Œä½ çš„ç§¯åˆ†ä¼šç›¸åº”å¢åŠ ã€‚è¿™é‡Œçš„è´­ä¹°è¡Œä¸ºå¯èƒ½è¢«å»ºæ¨¡ä¸ºä¸€ä¸ªè®¢å•ï¼ˆOrderï¼‰å¯¹è±¡ï¼Œè€Œç§¯åˆ†å¯ä»¥å»ºæ¨¡æˆè´¦æˆ·ï¼ˆAccountï¼‰å¯¹è±¡çš„æŸä¸ªå±æ€§ï¼Œè®¢å•å’Œè´¦æˆ·å‡ä¸ºèšåˆæ ¹ï¼Œå¹¶ä¸”åˆ†åˆ«å±äºè®¢å•ç³»ç»Ÿå’Œè´¦æˆ·ç³»ç»Ÿã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è®¢å•å’Œç§¯åˆ†ä¹‹é—´ç»´æŠ¤æ•°æ®ä¸€è‡´æ€§ï¼Œé€šå¸¸çš„åšæ³•æ˜¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­åŒæ—¶æ›´æ–°ä¸¤è€…ï¼Œä½†æ˜¯è¿™ä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š\n\nè¿èƒŒDDDä¸­â€å•ä¸ªäº‹åŠ¡ä¿®æ”¹å•ä¸ªèšåˆæ ¹â€çš„è®¾è®¡åŸåˆ™ï¼›\néœ€è¦åœ¨ä¸åŒçš„ç³»ç»Ÿä¹‹é—´é‡‡ç”¨é‡é‡çº§çš„åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆDistributed Transactioinï¼Œä¹Ÿå«XAäº‹åŠ¡æˆ–è€…å…¨å±€äº‹åŠ¡ï¼‰ï¼›\nåœ¨ä¸åŒç³»ç»Ÿä¹‹é—´äº§ç”Ÿå¼ºè€¦åˆã€‚\n\né€šè¿‡å¼•å…¥é¢†åŸŸäº‹ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå¥½åœ°è§£å†³ä¸Šè¿°é—®é¢˜ã€‚ æ€»çš„æ¥è¯´ï¼Œé¢†åŸŸäº‹ä»¶ç»™æˆ‘ä»¬å¸¦æ¥ä»¥ä¸‹å¥½å¤„ï¼š\n\nè§£è€¦å¾®æœåŠ¡ï¼ˆé™ç•Œä¸Šä¸‹æ–‡ï¼‰ï¼›\nå¸®åŠ©æˆ‘ä»¬æ·±å…¥ç†è§£é¢†åŸŸæ¨¡å‹ï¼›\næä¾›å®¡è®¡å’ŒæŠ¥å‘Šçš„æ•°æ®æ¥æºï¼›\nè¿ˆå‘äº‹ä»¶æº¯æºï¼ˆEvent Sourcingï¼‰å’ŒCQRSç­‰ã€‚\n\nè¿˜æ˜¯ä»¥ä¸Šé¢çš„ç”µå•†ç½‘ç«™ä¸ºä¾‹ï¼Œå½“ç”¨æˆ·ä¸‹å•ä¹‹åï¼Œè®¢å•ç³»ç»Ÿå°†å‘å‡ºä¸€ä¸ªâ€œç”¨æˆ·å·²ä¸‹å•â€çš„é¢†åŸŸäº‹ä»¶ï¼Œå¹¶å‘å¸ƒåˆ°æ¶ˆæ¯ç³»ç»Ÿä¸­ï¼Œæ­¤æ—¶ä¸‹å•ä¾¿å®Œæˆäº†ã€‚è´¦æˆ·ç³»ç»Ÿè®¢é˜…äº†æ¶ˆæ¯ç³»ç»Ÿä¸­çš„â€œç”¨æˆ·å·²ä¸‹å•â€äº‹ä»¶ï¼Œå½“äº‹ä»¶åˆ°è¾¾æ—¶è¿›è¡Œå¤„ç†ï¼Œæå–äº‹ä»¶ä¸­çš„è®¢å•ä¿¡æ¯ï¼Œå†è°ƒç”¨è‡ªèº«çš„ç§¯åˆ†å¼•æ“ï¼ˆä¹Ÿæœ‰å¯èƒ½æ˜¯å¦ä¸€ä¸ªå¾®æœåŠ¡ï¼‰è®¡ç®—ç§¯åˆ†ï¼Œæœ€åæ›´æ–°ç”¨æˆ·ç§¯åˆ†ã€‚å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶çš„è®¢å•ç³»ç»Ÿåœ¨å‘é€äº†äº‹ä»¶ä¹‹åï¼Œæ•´ä¸ªç”¨ä¾‹æ“ä½œä¾¿ç»“æŸäº†ï¼Œæ ¹æœ¬ä¸ç”¨å…³å¿ƒæ˜¯è°æ”¶åˆ°äº†äº‹ä»¶æˆ–è€…å¯¹äº‹ä»¶åšäº†ä»€ä¹ˆå¤„ç†ã€‚äº‹ä»¶çš„æ¶ˆè´¹æ–¹å¯ä»¥æ˜¯è´¦æˆ·ç³»ç»Ÿï¼Œä¹Ÿå¯ä»¥æ˜¯ä»»ä½•ä¸€ä¸ªå¯¹äº‹ä»¶æ„Ÿå…´è¶£çš„ç¬¬ä¸‰æ–¹ï¼Œæ¯”å¦‚ç‰©æµç³»ç»Ÿã€‚ç”±æ­¤ï¼Œå„ä¸ªå¾®æœåŠ¡ä¹‹é—´çš„è€¦åˆå…³ç³»ä¾¿è§£å¼€äº†ã€‚å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œæ­¤æ—¶å„ä¸ªå¾®æœåŠ¡ä¹‹é—´ä¸å†æ˜¯å¼ºä¸€è‡´æ€§ï¼Œè€Œæ˜¯åŸºäºäº‹ä»¶çš„æœ€ç»ˆä¸€è‡´æ€§ã€‚\n\näºŒã€äº‹ä»¶é£æš´ï¼ˆEvent Stormingï¼‰äº‹ä»¶é£æš´æ˜¯ä¸€é¡¹å›¢é˜Ÿæ´»åŠ¨ï¼Œæ—¨åœ¨é€šè¿‡é¢†åŸŸäº‹ä»¶è¯†åˆ«å‡ºèšåˆæ ¹ï¼Œè¿›è€Œåˆ’åˆ†å¾®æœåŠ¡çš„é™ç•Œä¸Šä¸‹æ–‡ã€‚åœ¨æ´»åŠ¨ä¸­ï¼Œå›¢é˜Ÿå…ˆé€šè¿‡å¤´è„‘é£æš´çš„å½¢å¼ç½—åˆ—å‡ºé¢†åŸŸä¸­æ‰€æœ‰çš„é¢†åŸŸäº‹ä»¶ï¼Œæ•´åˆä¹‹åå½¢æˆæœ€ç»ˆçš„é¢†åŸŸäº‹ä»¶é›†åˆï¼Œç„¶åå¯¹äºæ¯ä¸€ä¸ªäº‹ä»¶ï¼Œæ ‡æ³¨å‡ºå¯¼è‡´è¯¥äº‹ä»¶çš„å‘½ä»¤ï¼ˆCommandï¼‰ï¼Œå†ç„¶åä¸ºæ¯ä¸ªäº‹ä»¶æ ‡æ³¨å‡ºå‘½ä»¤å‘èµ·æ–¹çš„è§’è‰²ï¼Œå‘½ä»¤å¯ä»¥æ˜¯ç”¨æˆ·å‘èµ·ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¬¬ä¸‰æ–¹ç³»ç»Ÿè°ƒç”¨æˆ–è€…æ˜¯å®šæ—¶å™¨è§¦å‘ç­‰ã€‚æœ€åå¯¹äº‹ä»¶è¿›è¡Œåˆ†ç±»æ•´ç†å‡ºèšåˆæ ¹ä»¥åŠé™ç•Œä¸Šä¸‹æ–‡ã€‚äº‹ä»¶é£æš´è¿˜æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„æ˜¯å¯ä»¥åŠ æ·±å‚ä¸äººå‘˜å¯¹é¢†åŸŸçš„è®¤è¯†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨äº‹ä»¶é£æš´æ´»åŠ¨ä¸­ï¼Œé¢†åŸŸä¸“å®¶æ˜¯å¿…é¡»åœ¨åœºçš„ã€‚æ›´å¤šæœ‰å…³äº‹ä»¶é£æš´çš„å†…å®¹ï¼Œè¯·å‚è€ƒè¿™é‡Œã€‚\nåˆ›å»ºé¢†åŸŸäº‹ä»¶é¢†åŸŸäº‹ä»¶åº”è¯¥å›ç­”â€œä»€ä¹ˆäººä»€ä¹ˆæ—¶å€™åšäº†ä»€ä¹ˆäº‹æƒ…â€è¿™æ ·çš„é—®é¢˜ï¼Œåœ¨å®é™…ç¼–ç ä¸­ï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨å±‚è¶…ç±»å‹(Layer Supertype)æ¥åŒ…å«äº‹ä»¶çš„æŸäº›å…±æœ‰å±æ€§ï¼š\npublic abstract class Event &#123;    private final UUID id;    private final DateTime createdTime;    public Event() &#123;        this.id = UUID.randomUUID();        this.createdTime = new DateTime();    &#125;&#125;\n\nå¯ä»¥çœ‹åˆ°ï¼Œé¢†åŸŸäº‹ä»¶è¿˜åŒ…å«äº†IDï¼Œä½†æ˜¯è¯¥IDå¹¶ä¸æ˜¯å®ä½“ï¼ˆEntityï¼‰å±‚é¢çš„IDæ¦‚å¿µï¼Œè€Œæ˜¯ä¸»è¦ç”¨äºäº‹ä»¶è¿½æº¯å’Œæ—¥å¿—ã€‚å¦å¤–ï¼Œç”±äºé¢†åŸŸäº‹ä»¶æè¿°çš„æ˜¯è¿‡å»å‘ç”Ÿçš„äº‹æƒ…ï¼Œæˆ‘ä»¬åº”è¯¥å°†é¢†åŸŸäº‹ä»¶å»ºæ¨¡æˆä¸å¯å˜çš„ï¼ˆImmutableï¼‰ã€‚ä»DDDæ¦‚å¿µä¸Šè®²ï¼Œé¢†åŸŸäº‹ä»¶æ›´åƒä¸€ç§ç‰¹æ®Šçš„å€¼å¯¹è±¡ï¼ˆValue Objectï¼‰ã€‚å¯¹äºä¸Šæ–‡ä¸­æåˆ°çš„å’–å•¡å…ä¾‹å­ï¼Œåˆ›å»ºâ€œå®¢æˆ·å·²åˆ°è¾¾â€äº‹ä»¶å¦‚ä¸‹ï¼š\npublic final class CustomerArrivedEvent extends Event &#123;    private final int customerNumber;    public CustomerArrivedEvent(int customerNumber) &#123;        super();        this.customerNumber = customerNumber;    &#125;&#125;\n\nåœ¨è¿™ä¸ªCustomerArrivedEventäº‹ä»¶ä¸­ï¼Œé™¤äº†ç»§æ‰¿è‡ªEventçš„å±æ€§å¤–ï¼Œè¿˜è‡ªå®šä¹‰äº†ä¸€ä¸ªä¸è¯¥äº‹ä»¶å¯†åˆ‡å…³è”çš„ä¸šåŠ¡å±æ€§â€”â€”å®¢æˆ·äººæ•°ï¼ˆcustomerNumberï¼‰â€”â€”è¿™æ ·åç»­æ“ä½œä¾¿å¯é¢„ç•™ç›¸åº”æ•°ç›®çš„åº§ä½äº†ã€‚å¦å¤–ï¼Œæˆ‘ä»¬å°†æ‰€æœ‰å±æ€§ä»¥åŠCustomerArrivedEventæœ¬èº«éƒ½å£°æ˜æˆäº†finalï¼Œå¹¶ä¸”ä¸å‘å¤–æš´éœ²ä»»ä½•å¯èƒ½ä¿®æ”¹è¿™äº›å±æ€§çš„æ–¹æ³•ï¼Œè¿™æ ·ä¾¿ä¿è¯äº†äº‹ä»¶çš„ä¸å˜æ€§ã€‚\nä¸‰ã€å‘å¸ƒé¢†åŸŸäº‹ä»¶åœ¨ä½¿ç”¨é¢†åŸŸäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸é‡‡ç”¨â€œå‘å¸ƒ-è®¢é˜…â€çš„æ–¹å¼æ¥é›†æˆä¸åŒçš„æ¨¡å—æˆ–ç³»ç»Ÿã€‚åœ¨å•ä¸ªå¾®æœåŠ¡å†…éƒ¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨é¢†åŸŸäº‹ä»¶æ¥é›†æˆä¸åŒçš„åŠŸèƒ½ç»„ä»¶ï¼Œæ¯”å¦‚åœ¨ä¸Šæ–‡ä¸­æåˆ°çš„â€œç”¨æˆ·æ³¨å†Œä¹‹åå‘ç”¨æˆ·å‘é€æ¬¢è¿é‚®ä»¶â€çš„ä¾‹å­ä¸­ï¼Œæ³¨å†Œç»„ä»¶å‘å‡ºä¸€ä¸ªäº‹ä»¶ï¼Œé‚®ä»¶å‘é€ç»„ä»¶æ¥æ”¶åˆ°è¯¥äº‹ä»¶åå‘ç”¨æˆ·å‘é€é‚®ä»¶ã€‚\n\nåœ¨å¾®æœåŠ¡å†…éƒ¨ä½¿ç”¨é¢†åŸŸäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬ä¸ä¸€å®šéå¾—å¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶ï¼ˆæ¯”å¦‚ActiveMQç­‰ï¼‰ã€‚è¿˜æ˜¯ä»¥ä¸Šé¢çš„â€œæ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶â€ä¸ºä¾‹ï¼Œæ³¨å†Œè¡Œä¸ºå’Œå‘é€é‚®ä»¶è¡Œä¸ºè™½ç„¶é€šè¿‡é¢†åŸŸäº‹ä»¶é›†æˆï¼Œä½†æ˜¯ä»–ä»¬ä¾ç„¶å‘ç”Ÿåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œå¹¶ä¸”æ˜¯åŒæ­¥çš„ã€‚å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨é™ç•Œä¸Šä¸‹æ–‡ä¹‹å†…ä½¿ç”¨é¢†åŸŸäº‹ä»¶æ—¶ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦éµå¾ªâ€œä¸€ä¸ªäº‹åŠ¡åªæ›´æ–°ä¸€ä¸ªèšåˆæ ¹â€çš„åŸåˆ™ï¼Œè¿åä¹‹å¾€å¾€æ„å‘³ç€æˆ‘ä»¬å¯¹èšåˆæ ¹çš„æ‹†åˆ†æ˜¯é”™çš„ã€‚å³ä¾¿ç¡®å®å­˜åœ¨è¿™æ ·çš„æƒ…å†µï¼Œä¹Ÿåº”è¯¥é€šè¿‡å¼‚æ­¥çš„æ–¹å¼ï¼ˆæ­¤æ—¶éœ€è¦å¼•å…¥æ¶ˆæ¯ä¸­é—´ä»¶ï¼‰å¯¹ä¸åŒçš„èšåˆæ ¹é‡‡ç”¨ä¸åŒçš„äº‹åŠ¡ï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘ä½¿ç”¨åå°ä»»åŠ¡ã€‚\né™¤äº†ç”¨äºå¾®æœåŠ¡çš„å†…éƒ¨ï¼Œé¢†åŸŸäº‹ä»¶æ›´å¤šçš„æ˜¯è¢«ç”¨äºé›†æˆä¸åŒçš„å¾®æœåŠ¡ï¼Œå¦‚ä¸Šæ–‡ä¸­çš„â€œç”µå•†è®¢å•â€ä¾‹å­ã€‚\n\né€šå¸¸ï¼Œé¢†åŸŸäº‹ä»¶äº§ç”Ÿäºé¢†åŸŸå¯¹è±¡ä¸­ï¼Œæˆ–è€…æ›´å‡†ç¡®çš„è¯´æ˜¯äº§ç”Ÿäºèšåˆæ ¹ä¸­ã€‚åœ¨å…·ä½“ç¼–ç å®ç°æ—¶ï¼Œæœ‰å¤šç§æ–¹å¼å¯ç”¨äºå‘å¸ƒé¢†åŸŸäº‹ä»¶ã€‚\nä¸€ç§ç›´æ¥çš„æ–¹å¼æ˜¯åœ¨èšåˆæ ¹ä¸­ç›´æ¥è°ƒç”¨å‘å¸ƒäº‹ä»¶çš„Serviceå¯¹è±¡ã€‚ä»¥ä¸Šæ–‡ä¸­çš„â€œç”µå•†è®¢å•â€ä¸ºä¾‹ï¼Œå½“åˆ›å»ºè®¢å•æ—¶ï¼Œå‘å¸ƒâ€œè®¢å•å·²åˆ›å»ºâ€é¢†åŸŸäº‹ä»¶ã€‚æ­¤æ—¶å¯ä»¥è€ƒè™‘åœ¨è®¢å•å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­å‘å¸ƒäº‹ä»¶ï¼š\npublic class Order &#123;    public Order(EventPublisher eventPublisher) &#123;        //create order                //â€¦                eventPublisher.publish(new OrderPlacedEvent());            &#125;&#125;\n\næ³¨ï¼šä¸ºäº†æŠŠç„¦ç‚¹é›†ä¸­åœ¨äº‹ä»¶å‘å¸ƒä¸Šï¼Œæˆ‘ä»¬å¯¹Orderå¯¹è±¡åšäº†ç®€åŒ–ï¼ŒOrderå¯¹è±¡æœ¬èº«åœ¨å®é™…ç¼–ç ä¸­ä¸å…·å¤‡å‚è€ƒæ€§ã€‚\nå¯ä»¥çœ‹åˆ°ï¼Œä¸ºäº†å‘å¸ƒOrderPlacedEventäº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦å°†Serviceå¯¹è±¡EventPublisherä¼ å…¥ï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸€ç§APIæ±¡æŸ“ï¼Œå³Orderä½œä¸ºä¸€ä¸ªé¢†åŸŸå¯¹è±¡åªéœ€è¦å…³æ³¨å’Œä¸šåŠ¡ç›¸å…³çš„æ•°æ®ï¼Œè€Œä¸æ˜¯è¯¸å¦‚EventPublisherè¿™æ ·çš„åŸºç¡€è®¾æ–½å¯¹è±¡ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯ç”±NServiceBusçš„åˆ›å§‹äººUdi Dahanæå‡ºæ¥çš„ï¼Œå³åœ¨é¢†åŸŸå¯¹è±¡ä¸­é€šè¿‡è°ƒç”¨EventPublisherä¸Šçš„é™æ€æ–¹æ³•å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼š\n public class Order &#123;    public Order() &#123;        //create order        //...        EventPublisher.publish(new OrderPlacedEvent());    &#125;&#125;\n\nè¿™ç§æ–¹æ³•è™½ç„¶é¿å…äº†APIæ±¡æŸ“ï¼Œä½†æ˜¯è¿™é‡Œçš„publish()é™æ€æ–¹æ³•å°†äº§ç”Ÿå‰¯ä½œç”¨ï¼Œå¯¹Orderå¯¹è±¡çš„æµ‹è¯•å¸¦æ¥äº†éš¾å¤„ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨â€œåœ¨èšåˆæ ¹ä¸­ä¸´æ—¶ä¿å­˜é¢†åŸŸäº‹ä»¶â€çš„æ–¹å¼äºˆä»¥æ”¹è¿›ï¼š\npublic class Order &#123;    private List&lt;Event&gt; events;    public Order() &#123;        //create order        //...        events.add(new OrderPlacedEvent());    &#125;    public List&lt;Event&gt; getEvents() &#123;        return events;    &#125;    public void clearEvents() &#123;        events.clear();    &#125;&#125;\n\nåœ¨æµ‹è¯•Orderå¯¹è±¡æ—¶ï¼Œæˆ‘ä»¬ä¾¿ä½ å¯ä»¥é€šè¿‡éªŒè¯eventsé›†åˆä¿è¯Orderå¯¹è±¡åœ¨åˆ›å»ºæ—¶çš„ç¡®å‘å¸ƒäº†OrderPlacedEventäº‹ä»¶ï¼š\n@Testpublic void shouldPublishEventWhenCreateOrder() &#123;    Order order = new Order();    List&lt;Event&gt; events = order.getEvents();    assertEquals(1, events.size());    Event event = events.get(0);    assertTrue(event instanceof OrderPlacedEvent);&#125;\n\nåœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œèšåˆæ ¹å¯¹é¢†åŸŸäº‹ä»¶çš„ä¿å­˜åªèƒ½æ˜¯ä¸´æ—¶çš„ï¼Œåœ¨å¯¹è¯¥èšåˆæ ¹æ“ä½œå®Œæˆä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥å°†é¢†åŸŸäº‹ä»¶å‘å¸ƒå‡ºå»å¹¶åŠæ—¶æ¸…ç©ºeventsé›†åˆã€‚å¯ä»¥è€ƒè™‘åœ¨æŒä¹…åŒ–èšåˆæ ¹æ—¶è¿›è¡Œè¿™æ ·çš„æ“ä½œï¼Œåœ¨DDDä¸­å³ä¸ºèµ„æºåº“ï¼ˆRepositoryï¼‰ï¼š\npublic class OrderRepository &#123;    private EventPublisher eventPublisher;    public void save(Order order) &#123;        List&lt;Event&gt; events = order.getEvents();        events.forEach(event -&gt; eventPublisher.publish(event));        order.clearEvents();        //save the order        //...    &#125;&#125;\n\né™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ç§ä¸â€œä¸´æ—¶ä¿å­˜é¢†åŸŸäº‹ä»¶â€ç›¸ä¼¼çš„åšæ³•æ˜¯â€œåœ¨èšåˆæ ¹æ–¹æ³•ä¸­ç›´æ¥è¿”å›é¢†åŸŸäº‹ä»¶â€ï¼Œç„¶ååœ¨Repositoryä¸­è¿›è¡Œå‘å¸ƒã€‚è¿™ç§æ–¹å¼ä¾ç„¶æœ‰å¾ˆå¥½çš„å¯æµ‹æ€§ï¼Œå¹¶ä¸”å¼€å‘äººå‘˜ä¸ç”¨æ‰‹åŠ¨æ¸…ç©ºå…ˆå‰çš„äº‹ä»¶é›†åˆï¼Œä¸è¿‡è¿˜æ˜¯å¾—è®°ä½åœ¨Repositoryä¸­å°†äº‹ä»¶å‘å¸ƒå‡ºå»ã€‚å¦å¤–ï¼Œè¿™ç§æ–¹å¼ä¸é€‚åˆåˆ›å»ºèšåˆæ ¹çš„åœºæ™¯ï¼Œå› ä¸ºæ­¤æ—¶çš„åˆ›å»ºè¿‡ç¨‹æ—¢è¦è¿”å›èšåˆæ ¹æœ¬èº«ï¼Œåˆè¦è¿”å›é¢†åŸŸäº‹ä»¶ã€‚\nè¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸å¥½çš„åœ°æ–¹ï¼Œæ¯”å¦‚å®ƒè¦æ±‚å¼€å‘äººå‘˜åœ¨æ¯æ¬¡æ›´æ–°èšåˆæ ¹æ—¶éƒ½å¿…é¡»è®°å¾—æ¸…ç©ºeventsé›†åˆï¼Œå¿˜è®°è¿™ä¹ˆåšå°†ä¸ºç¨‹åºå¸¦æ¥ä¸¥é‡çš„bugã€‚ä¸è¿‡è™½ç„¶å¦‚æ­¤ï¼Œè¿™ä¾ç„¶æ˜¯ç¬”è€…æ¯”è¾ƒæ¨èçš„æ–¹å¼ã€‚\nä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶å‘å¸ƒçš„åŸå­æ€§è™½ç„¶åœ¨ä¸åŒèšåˆæ ¹ä¹‹é—´æˆ‘ä»¬é‡‡ç”¨äº†åŸºäºé¢†åŸŸäº‹ä»¶çš„æœ€ç»ˆä¸€è‡´æ€§ï¼Œä½†æ˜¯åœ¨ä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶å‘å¸ƒä¹‹é—´æˆ‘ä»¬ä¾ç„¶éœ€è¦é‡‡ç”¨å¼ºä¸€è‡´æ€§ï¼Œä¹Ÿå³è¿™ä¸¤è€…çš„å‘ç”Ÿåº”è¯¥æ˜¯åŸå­çš„ï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ï¼Œå¦åˆ™æœ€ç»ˆä¸€è‡´æ€§æ ¹æœ¬æ— ä»è°ˆèµ·ã€‚ä»¥ä¸Šæ–‡ä¸­â€œè®¢å•ç§¯åˆ†â€ä¸ºä¾‹ï¼Œå¦‚æœå®¢æˆ·ä¸‹å•æˆåŠŸï¼Œä½†æ˜¯äº‹ä»¶å‘é€å¤±è´¥ï¼Œä¸‹æ¸¸çš„è´¦æˆ·ç³»ç»Ÿä¾¿æ‹¿ä¸åˆ°äº‹ä»¶ï¼Œå¯¼è‡´æœ€ç»ˆå®¢æˆ·çš„ç§¯åˆ†å¹¶ä¸å¢åŠ ã€‚\nè¦ä¿è¯ä¸šåŠ¡æ“ä½œå’Œäº‹ä»¶å‘å¸ƒä¹‹é—´çš„åŸå­æ€§ï¼Œæœ€ç›´æ¥çš„æ–¹æ³•ä¾¿æ˜¯é‡‡ç”¨XAäº‹åŠ¡ï¼Œæ¯”å¦‚Javaä¸­çš„JTAï¼Œè¿™ç§æ–¹å¼ç”±äºå…¶é‡é‡çº§å¹¶ä¸è¢«äººä»¬æ‰€çœ‹å¥½ã€‚ä½†æ˜¯ï¼Œå¯¹äºä¸€äº›å¯¹æ€§èƒ½è¦æ±‚ä¸é‚£ä¹ˆé«˜çš„ç³»ç»Ÿï¼Œè¿™ç§æ–¹å¼æœªå°ä¸æ˜¯ä¸€ä¸ªé€‰æ‹©ã€‚ä¸€äº›å¼€å‘æ¡†æ¶å·²ç»èƒ½å¤Ÿæ”¯æŒç‹¬ç«‹äºåº”ç”¨æœåŠ¡å™¨çš„XAäº‹åŠ¡ç®¡ç†å™¨ï¼ˆå¦‚Atomikoså’ŒBitronixï¼‰ï¼Œæ¯”å¦‚Spring Bootä½œä¸ºä¸€ä¸ªå¾®æœåŠ¡æ¡†æ¶ä¾¿æä¾›äº†å¯¹Atomikoså’ŒBitronixçš„æ”¯æŒã€‚\nå¦‚æœJTAä¸æ˜¯ä½ çš„é€‰é¡¹ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘é‡‡ç”¨äº‹ä»¶è¡¨çš„æ–¹å¼ã€‚è¿™ç§æ–¹å¼é¦–å…ˆå°†äº‹ä»¶ä¿å­˜åˆ°èšåˆæ ¹æ‰€åœ¨çš„æ•°æ®åº“ä¸­ï¼Œç”±äºäº‹ä»¶è¡¨å’Œèšåˆæ ¹è¡¨åŒå±ä¸€ä¸ªæ•°æ®åº“ï¼Œæ•´ä¸ªè¿‡ç¨‹åªéœ€è¦ä¸€ä¸ªæœ¬åœ°äº‹åŠ¡å°±èƒ½å®Œæˆã€‚ç„¶åï¼Œåœ¨ä¸€ä¸ªå•ç‹¬çš„åå°ä»»åŠ¡ä¸­è¯»å–äº‹ä»¶è¡¨ä¸­æœªå‘å¸ƒçš„äº‹ä»¶ï¼Œå†å°†äº‹ä»¶å‘å¸ƒåˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä¸­ã€‚\n\nè¿™ç§æ–¹å¼éœ€è¦æ³¨æ„ä¸¤ä¸ªé—®é¢˜ï¼Œç¬¬ä¸€ä¸ªæ˜¯ç”±äºå‘å¸ƒäº†äº‹ä»¶ä¹‹åéœ€è¦å°†è¡¨ä¸­çš„äº‹ä»¶æ ‡è®°æˆâ€œå·²å‘å¸ƒâ€çŠ¶æ€ï¼Œå³ä¾ç„¶æ¶‰åŠåˆ°å¯¹æ•°æ®åº“çš„æ“ä½œï¼Œå› æ­¤å‘å¸ƒäº‹ä»¶å’Œæ ‡è®°â€œå·²å‘å¸ƒâ€ä¹‹é—´éœ€è¦åŸå­æ€§ã€‚å½“ç„¶ï¼Œæ­¤æ—¶ä¾æ—§å¯ä»¥é‡‡ç”¨XAäº‹åŠ¡ï¼Œä½†æ˜¯è¿™è¿èƒŒäº†é‡‡ç”¨äº‹ä»¶è¡¨çš„åˆè¡·ã€‚ä¸€ç§è§£å†³æ–¹æ³•æ˜¯å°†äº‹ä»¶çš„æ¶ˆè´¹æ–¹åˆ›å»ºæˆå¹‚ç­‰çš„ï¼Œå³æ¶ˆè´¹æ–¹å¯ä»¥å¤šæ¬¡æ¶ˆè´¹åŒä¸€ä¸ªäº‹ä»¶è€Œä¸æ±¡æŸ“ç³»ç»Ÿæ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹å¤§è‡´ä¸ºï¼šæ•´ä¸ªè¿‡ç¨‹ä¸­äº‹ä»¶å‘é€å’Œæ•°æ®åº“æ›´æ–°é‡‡ç”¨å„è‡ªçš„äº‹åŠ¡ç®¡ç†ï¼Œæ­¤æ—¶æœ‰å¯èƒ½å‘ç”Ÿçš„æƒ…å†µæ˜¯äº‹ä»¶å‘é€æˆåŠŸè€Œæ•°æ®åº“æ›´æ–°å¤±è´¥ï¼Œè¿™æ ·åœ¨ä¸‹ä¸€æ¬¡äº‹ä»¶å‘å¸ƒæ“ä½œä¸­ï¼Œç”±äºå…ˆå‰å‘å¸ƒè¿‡çš„äº‹ä»¶åœ¨æ•°æ®åº“ä¸­ä¾ç„¶æ˜¯â€œæœªå‘å¸ƒâ€çŠ¶æ€ï¼Œè¯¥äº‹ä»¶å°†è¢«é‡æ–°å‘å¸ƒåˆ°æ¶ˆæ¯ç³»ç»Ÿä¸­ï¼Œå¯¼è‡´äº‹ä»¶é‡å¤ï¼Œä½†ç”±äºäº‹ä»¶çš„æ¶ˆè´¹æ–¹æ˜¯å¹‚ç­‰çš„ï¼Œå› æ­¤äº‹ä»¶é‡å¤ä¸ä¼šå­˜åœ¨é—®é¢˜ã€‚\nå¦å¤–ä¸€ä¸ªéœ€è¦æ³¨æ„çš„é—®é¢˜æ˜¯æŒä¹…åŒ–æœºåˆ¶çš„é€‰æ‹©ã€‚å…¶å®å¯¹äºDDDä¸­çš„èšåˆæ ¹æ¥è¯´ï¼ŒNoSQLæ˜¯ç›¸æ¯”äºå…³ç³»å‹æ•°æ®åº“æ›´åˆé€‚çš„é€‰æ‹©ï¼Œæ¯”å¦‚ç”¨MongoDBçš„Documentä¿å­˜èšåˆæ ¹ä¾¿æ˜¯ç§å¾ˆè‡ªç„¶çš„æ–¹å¼ã€‚ä½†æ˜¯å¤šæ•°NoSQLæ˜¯ä¸æ”¯æŒACIDçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸èƒ½ä¿è¯èšåˆæ›´æ–°å’Œäº‹ä»¶å‘å¸ƒä¹‹é—´çš„åŸå­æ€§ã€‚è¿˜å¥½ï¼Œå…³ç³»å‹æ•°æ®åº“ä¹Ÿåœ¨å‘NoSQLæ–¹å‘å‘å±•ï¼Œæ¯”å¦‚æ–°ç‰ˆæœ¬çš„PostgreSQL(ç‰ˆæœ¬9.4)å’ŒMySQLï¼ˆç‰ˆæœ¬5.7ï¼‰å·²ç»èƒ½å¤Ÿæä¾›å…·å¤‡NoSQLç‰¹å¾çš„JSONå­˜å‚¨å’ŒåŸºäºJSONçš„æŸ¥è¯¢ã€‚æ­¤æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘å°†èšåˆæ ¹åºåˆ—åŒ–æˆJSONæ ¼å¼çš„æ•°æ®è¿›è¡Œä¿å­˜ï¼Œä»è€Œé¿å…äº†ä½¿ç”¨é‡é‡çº§çš„ORMå·¥å…·ï¼Œåˆå¯ä»¥åœ¨å¤šä¸ªæ•°æ®ä¹‹é—´ä¿è¯ACIDï¼Œä½•ä¹è€Œä¸ä¸ºï¼Ÿ\näº”ã€æ€»ç»“é¢†åŸŸäº‹ä»¶ä¸»è¦ç”¨äºè§£è€¦å¾®æœåŠ¡ï¼Œæ­¤æ—¶å„ä¸ªå¾®æœåŠ¡ä¹‹é—´å°†å½¢æˆæœ€ç»ˆä¸€è‡´æ€§ã€‚äº‹ä»¶é£æš´æ´»åŠ¨æœ‰åŠ©äºæˆ‘ä»¬å¯¹å¾®æœåŠ¡è¿›è¡Œæ‹†åˆ†ï¼Œå¹¶ä¸”æœ‰åŠ©äºæˆ‘ä»¬æ·±å…¥äº†è§£æŸä¸ªé¢†åŸŸã€‚é¢†åŸŸäº‹ä»¶ä½œä¸ºå·²ç»å‘ç”Ÿè¿‡çš„å†å²æ•°æ®ï¼Œåœ¨å»ºæ¨¡æ—¶åº”è¯¥å°†å…¶åˆ›å»ºä¸ºä¸å¯å˜çš„ç‰¹æ®Šå€¼å¯¹è±¡ã€‚å­˜åœ¨å¤šç§æ–¹å¼ç”¨äºå‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼Œå…¶ä¸­â€œåœ¨èšåˆä¸­ä¸´æ—¶ä¿å­˜é¢†åŸŸäº‹ä»¶â€çš„æ–¹å¼æ˜¯å€¼å¾—æ¨å´‡çš„ã€‚å¦å¤–ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘åˆ°èšåˆæ›´æ–°å’Œäº‹ä»¶å‘å¸ƒä¹‹é—´çš„åŸå­æ€§ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨XAäº‹åŠ¡æˆ–è€…é‡‡ç”¨å•ç‹¬çš„äº‹ä»¶è¡¨ã€‚ä¸ºäº†é¿å…äº‹ä»¶é‡å¤å¸¦æ¥çš„é—®é¢˜ï¼Œæœ€å¥½çš„æ–¹å¼æ˜¯å°†äº‹ä»¶çš„æ¶ˆè´¹æ–¹åˆ›å»ºä¸ºå¹‚ç­‰çš„ã€‚\n","categories":["é¢†åŸŸé©±åŠ¨è®¾è®¡"]},{"title":"å¦‚ä½•åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡","url":"/posts/43572/","content":"ä¸€ã€èšåˆåˆ†ç»„æ³•å’Œå®ƒçš„é—®é¢˜åœ¨äº‹ä»¶é£æš´å·¥ä½œåŠä¸­ï¼Œå¸¸ç”¨çš„åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡çš„æ–¹æ³•æ˜¯ï¼š\n\nå¯¹å‰ä¸€æ­¥ï¼ˆäº‹ä»¶é£æš´ï¼‰äº§ç”Ÿçš„èšåˆè¿›è¡Œåˆ†ç»„ï¼Œé€šè¿‡ä¸šåŠ¡çš„å†…èšæ€§å’Œå…³è”åº¦åˆ’åˆ†è¾¹ç•Œï¼Œç»“åˆé™ç•Œä¸Šä¸‹æ–‡çš„å®šä¹‰è¿›è¡Œåˆ¤æ–­ï¼Œå¹¶ç»™å‡ºä¸Šä¸‹æ–‡åç§°ã€‚\n[æœåŠ¡åŒ–è®¾è®¡é˜¶æ®µè·¯å¾„æ–¹æ¡ˆ]\n\næˆ‘å°†å…¶ç§°ä¹‹ä¸ºâ€œèšåˆåˆ†ç»„æ³•â€ã€‚ç„¶è€Œé¢å¯¹ä¸€å †èšåˆï¼Œè¦å¾—å‡ºä¸€å¥—åˆç†çš„åˆ†ç»„æ˜¯éå¸¸å›°éš¾çš„ï¼š\n\nâ€œç›¸å…³æ€§â€å…¨å‡­ç»éªŒ\nç›¸å…³æ€§æ˜¯ä¸€ä¸ªè¿‡äºæŠ½è±¡çš„è§„åˆ™ï¼Œéå¸¸ä¾èµ–ç»éªŒã€‚\nä¸¾ä¸ªä¾‹å­ã€‚åœ¨ä¸€ä¸ªæ´»åŠ¨è¿è¥ç³»ç»Ÿä¸­ï¼Œæœ‰â€œæ³¨å†Œå¥–åŠ±æ´»åŠ¨â€ã€â€œæ³¨å†Œå¥–åŠ±è§„åˆ™â€ã€â€œä»»åŠ¡å¥–åŠ±æ´»åŠ¨â€ã€â€œä»»åŠ¡å¥–åŠ±è§„åˆ™â€ç­‰æ¦‚å¿µã€‚æ˜¯æŠŠæ‰€æœ‰çš„â€œæ´»åŠ¨â€åˆ†ä¸ºä¸€ç»„ï¼Œæ‰€æœ‰â€œè§„åˆ™â€åˆ†ä¸ºä¸€ç»„ï¼Œè¿˜æ˜¯æŠŠâ€œæ³¨å†Œâ€ç›¸å…³çš„åˆ†ä¸ºä¸€ç»„ï¼ŒæŠŠâ€œä»»åŠ¡â€ç›¸å…³çš„åˆ†ä¸ºä¸€ç»„ï¼Ÿè¿™æ˜¯ä¸ªè®©äººå¤´ç–¼çš„é—®é¢˜ã€‚ä¹Ÿè®¸ä½ ä¼šè¯´éœ€è¦ä¸šåŠ¡äººå‘˜çš„è¾“å…¥ï¼Œä½†æ˜¯ä¸šåŠ¡äººå‘˜å¾ˆå¯èƒ½åªä¼šå‘Šè¯‰ä½ è¿™äº›æ¦‚å¿µä¹‹é—´éƒ½æœ‰å…³ç³»ã€‚\n\nä¸å¥åº·çš„èšåˆä¸Šä¸‹æ–‡\nèšåˆåˆ†ç»„æ³•å¾ˆå®¹æ˜“å¯¼å‘ä¸€ç§æŒ‰ç…§èšåˆåˆ’åˆ†çš„æ¶æ„ã€‚æœåŠ¡å›´ç»•èšåˆå»ºè®¾ï¼Œè€Œéé’ˆå¯¹æŸä¸ªä¸šåŠ¡ä»·å€¼ï¼Œä¹Ÿå°±æ— æ³•æä¾›æ­£ç¡®çš„ä¸šåŠ¡ä»·å€¼ã€‚å›´ç»•èšåˆå»ºè®¾çš„æœåŠ¡ï¼Œçœ‹ä¸Šå»å¯ä»¥å¤ç”¨ï¼Œä½†æ˜¯ä¼šé€ æˆæœåŠ¡é—´çš„ç´§è€¦åˆï¼Œå®¹æ˜“æˆä¸ºæœ€ç³Ÿç³•çš„åˆ†å¸ƒå¼å•ä½“æ¶æ„ï¼š\n\nå½“æ¶æ„æ˜¯åˆ†å¸ƒå¼å•ä½“æ—¶ï¼Œå¾€å¾€éœ€è¦åŒæ—¶ä¿®æ”¹å¤šä¸ªæœåŠ¡ï¼ŒåŒæ—¶éƒ¨ç½²å¤šä¸ªæœåŠ¡ã€æœåŠ¡ä¹‹é—´è°ƒç”¨éå¸¸é¢‘ç¹ã€‚\n[Youâ€™re Not Actually Building Microservices]\n\nèšåˆåˆ†ç»„æ³•ä¹Ÿæ— æ³•å¾ˆå¥½çš„è¯†åˆ«â€œé‡å¤çš„æ¦‚å¿µâ€é—®é¢˜ï¼ˆ[é¢†åŸŸé©±åŠ¨è®¾è®¡]14.1ï¼ŒæŒ‡æŸä¸€ä¸ªæ¦‚å¿µï¼Œåº”è¯¥è¢«è®¾è®¡æˆå¤šä¸ªæ¨¡å‹ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸åŒçš„è§„åˆ™ï¼Œç”šè‡³æœ‰ä¸åŒçš„æ•°æ®ï¼‰ã€‚ä½¿ç”¨èšåˆåˆ†ç»„æ³•å¾€å¾€å¯¼è‡´æŠŠå¸¦ç€è¿™æ ·çš„èšåˆç®€å•çš„æ”¾åˆ°æŸä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­ã€‚\n\néšè—çš„åˆ’åˆ†æ–¹æ¡ˆ\nè¿˜å¾ˆå¯èƒ½æ˜¯è¿™ç§æƒ…å†µï¼šåœ¨ä½¿ç”¨èšåˆåˆ†ç»„æ³•æ—¶ï¼Œæ¶æ„å¸ˆå·²ç»æœ‰ä¸€ä¸ªéšè—åœ¨å¿ƒé‡Œçš„æ¨¡ç³Šçš„åˆ’åˆ†æ–¹æ¡ˆï¼Œåœ¨åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡æ—¶éƒ½æ˜¯å¾€è¯¥æ–¹æ¡ˆä¸Šé ã€‚ä½†æ˜¯ç”±äºè¿™ä¸ªåˆ’åˆ†æ–¹æ¡ˆåªæ˜¯æ¨¡ç³Šå­˜åœ¨äºæ¶æ„å¸ˆçš„è„‘ä¸­ï¼Œå¹¶æ²¡æœ‰æ‹¿å‡ºæ¥è®¨è®ºï¼Œå¾ˆå¯èƒ½ç»ä¸èµ·æ¨æ•²ï¼Œæœ€ç»ˆæ— æ³•è¨€è¯´ï¼Œæ²¦ä¸ºâ€œby experienceâ€ã€‚\n\n\näºŒã€å¦‚ä½•åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡å¦‚ä½•åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼Ÿåœ¨å›ç­”è¿™ä¸ªé—®é¢˜å‰ï¼Œè®©æˆ‘ä»¬å…ˆçœ‹çœ‹é™ç•Œä¸Šä¸‹æ–‡åˆ°åº•æ˜¯ä»€ä¹ˆã€‚\nåœ¨[é¢†åŸŸé©±åŠ¨è®¾è®¡]ç¬¬14ç« æå‡ºäº†è‘—åçš„é™ç•Œä¸Šä¸‹æ–‡ã€‚é™ç•Œä¸Šä¸‹æ–‡æ˜¯ä¸ºäº†åˆ†è§£å¤§å‹æ¨¡å‹ï¼š\n\nç„¶è€Œåœ¨å‡ ä¹æ‰€æœ‰è¿™ç§è§„æ¨¡çš„ç»„ç»‡ä¸­ï¼Œæ•´ä¸ªä¸šåŠ¡æ¨¡å‹å¤ªå¤§ä¸”è¿‡äºå¤æ‚ä»¥è‡³äºéš¾ä»¥ç®¡ç†ï¼Œç”šè‡³å¾ˆéš¾æŠŠå®ƒä½œä¸ºä¸€ä¸ªæ•´ä½“æ¥ç†è§£ã€‚æˆ‘ä»¬å¿…é¡»æŠŠç³»ç»Ÿåˆ†è§£ä¸ºè¾ƒå°çš„ç»„æˆéƒ¨åˆ†ï¼Œæ— è®ºåœ¨æ¦‚å¿µè¿˜æ˜¯åœ¨å®ç°ä¸Šã€‚\næœ‰æ—¶ï¼Œä¼ä¸šç³»ç»Ÿä¼šé›†æˆå„ç§ä¸åŒæ¥æºçš„å­ç³»ç»Ÿï¼Œæˆ–è€…åŒ…å«è¯¸å¤šå±äºå®Œå…¨ä¸åŒé¢†åŸŸçš„åº”ç”¨ç¨‹åºã€‚è¦æŠŠè¿™äº›ä¸åŒéƒ¨åˆ†ä¸­éšå«çš„æ¨¡å‹ç»Ÿä¸€èµ·æ¥æ˜¯ä¸å¯èƒ½çš„ã€‚é€šè¿‡ä¸ºæ¯ä¸ªæ¨¡å‹æ˜¾å¼åœ°å®šä¹‰ä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡ï¼Œç„¶ååœ¨å¿…è¦çš„æƒ…å†µä¸‹å®šä¹‰å®ƒä¸å…¶ä»–ä¸Šä¸‹æ–‡çš„å…³ç³»ï¼Œå»ºæ¨¡äººå‘˜å°±å¯ä»¥é¿å…æ¨¡å‹å˜å¾—æ··ä¹±ã€‚\n[é¢†åŸŸé©±åŠ¨è®¾è®¡ ç¬¬å››éƒ¨åˆ†] (https://book.douban.com/subject/26819666/)\n\n\né™ç•Œä¸Šä¸‹æ–‡å‘Šè¯‰æˆ‘ä»¬ï¼ŒåŒä¸€ä¸ªæ¦‚å¿µï¼Œä¸å¿…æ€»æ˜¯å¯¹åº”äºä¸€ä¸ªå•ä¸€æ¨¡å‹ï¼Œä¹Ÿå¯ä»¥å¯¹åº”äºå¤šä¸ªæ¨¡å‹ã€‚ç”¨é™ç•Œä¸Šä¸‹æ–‡æ˜ç¡®æ¨¡å‹è¦è§£å†³çš„é—®é¢˜ï¼Œå¯ä»¥ä¿æŒæ¯ä¸ªæ¨¡å‹çš„æ¸…æ™°ã€‚é™ç•Œä¸Šä¸‹æ–‡æ˜¯é¢†åŸŸæ¨¡å‹çš„è¾¹ç•Œï¼Œä¹Ÿå°±æ˜¯é¢†åŸŸçŸ¥è¯†çš„è¾¹ç•Œã€‚å’Œä¸Šä¸‹æ–‡ä¸»é¢˜ç´§å¯†ç›¸å…³çš„æ¨¡å‹å†…èšåœ¨ä¸Šä¸‹æ–‡å†…ï¼Œè€Œå…¶ä»–æ¨¡å‹è¢«ä¼šåˆ†åˆ°å…¶ä»–é™ç•Œä¸Šä¸‹æ–‡ä¸­ã€‚é™ç•Œä¸Šä¸‹æ–‡å†…çš„é¢†åŸŸçŸ¥è¯†æ˜¯é«˜å†…èšä½è€¦åˆçš„ã€‚\n\né™ç•Œä¸Šä¸‹æ–‡çš„ä¸»é¢˜æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘è®¤ä¸ºæ˜¯å­åŸŸã€‚æ¯ä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸“æ³¨äºè§£å†³æŸä¸ªç‰¹å®šçš„å­åŸŸçš„é—®é¢˜ã€‚æ¯ä¸ªå­åŸŸéƒ½å¯¹åº”ä¸€ä¸ªæ˜ç¡®çš„é—®é¢˜ï¼Œæä¾›ç‹¬ç«‹çš„ä»·å€¼ï¼Œæ‰€ä»¥æ¯ä¸ªå­åŸŸéƒ½ç›¸å¯¹ç‹¬ç«‹ã€‚å­åŸŸåŠå…¶å¯¹åº”çš„é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„æ¨¡å‹ä¼šå› ä¸ºå…¶è¦è§£å†³çš„é—®é¢˜å˜åŒ–è€Œå˜åŒ–ï¼Œä¸ä¼šå› ä¸ºå…¶ä»–å­åŸŸçš„å˜åŒ–è€Œå˜åŒ–ï¼Œå³ä½è€¦åˆï¼›å½“ä¸€ä¸ªå­åŸŸå‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å…¶å¯¹åº”é™ç•Œä¸Šä¸‹æ–‡ä¸­çš„æ¨¡å‹ï¼Œä¸éœ€è¦å˜åŠ¨å…¶ä»–å­åŸŸçš„æ¨¡å‹ï¼Œå³é«˜å†…èšã€‚\nEvansä¹Ÿè°ˆè®ºäº†é™ç•Œä¸Šä¸‹æ–‡å’Œå­åŸŸçš„å…³ç³»ï¼š\n\nOne confusion that Evans sometimes notices in teams is differentiating between bounded contexts and subdomains. In an ideal world they coincide, but in reality they are often misaligned.\nEvansæœ‰æ—¶ä¼šåœ¨å›¢é˜Ÿä¸­å‘ç°çš„ä¸€ä¸ªå›°æƒ‘ï¼Œå°±æ˜¯å¦‚ä½•åŒºåˆ†é™ç•Œä¸Šä¸‹æ–‡å’Œå­åŸŸã€‚åœ¨ç†æƒ³çš„ä¸–ç•Œä¸­å®ƒä»¬æ˜¯é‡åˆçš„ï¼Œä½†åœ¨ç°å®ä¸–ç•Œä¸­å®ƒä»¬å¸¸å¸¸æ˜¯é”™ä½çš„ã€‚\n[Defining Bounded Contexts â€” Eric Evans at DDD Europe]\n\nå½“æˆ‘ä»¬è®¾è®¡ä¸€ä¸ªæ–°ç³»ç»Ÿæˆ–è€…è®¾è®¡é—ç•™ç³»ç»Ÿçš„ç›®æ ‡æ¶æ„æ—¶ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šæŒ‰ç…§ç†æƒ³çš„æ–¹å¼è¿›è¡Œè®¾è®¡ã€‚è€Œåœ¨ç†æƒ³æƒ…å†µä¸‹ï¼Œå­åŸŸå’Œé™ç•Œä¸Šä¸‹æ–‡æ˜¯é‡åˆçš„ã€‚\n[é¢†åŸŸé©±åŠ¨è®¾è®¡ç²¾ç²¹]ä¸­ä¹Ÿè®²è¿°äº†ä¸€ä¸ªé€šè¿‡å¯»æ‰¾æ ¸å¿ƒåŸŸç›¸å…³çš„æ¦‚å¿µæ¥è¯†åˆ«é™ç•Œä¸Šä¸‹æ–‡çš„æ–¹æ³•ã€‚\nä¸‰ã€å¦‚ä½•åˆ†è§£å­åŸŸæ ¹æ®å­åŸŸæ¥è¯†åˆ«é™ç•Œä¸Šä¸‹æ–‡ï¼Œé‚£ä¹ˆå­åŸŸå¦‚ä½•å¾—åˆ°å‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡åˆ†è§£é—®é¢˜åŸŸçš„æ–¹å¼ï¼Œå°†æ•´ä¸ªé—®é¢˜åŸŸåˆ†è§£æˆè‹¥å¹²ä¸ªæ›´å°ã€æ›´ç®€å•ã€æ›´å®¹æ˜“è§£å†³çš„é—®é¢˜å­åŸŸã€‚\næˆ‘ä»¬éœ€è¦æŸç§æ–¹æ³•ï¼Œå°†é¢†åŸŸåˆ†è§£æˆé€»è¾‘ä¸Šç›¸äº’ç‹¬ç«‹ä¸”æ²¡æœ‰äº¤å‰çš„å­åŸŸã€‚åœ¨è¿™é‡Œçš„æ–¹æ³•æ˜¯é€šè¿‡äº§å“æ„¿æ™¯ï¼Œè¯†åˆ«æ ¸å¿ƒåŸŸï¼Œè¿›è€Œè¯†åˆ«æ ¸å¿ƒåŸŸå‘¨è¾¹çš„å­åŸŸã€‚\nè¯†åˆ«æ ¸å¿ƒåŸŸç”±äºæ ¸å¿ƒåŸŸæ˜¯æœ€æ˜æ˜¾ã€æœ€å®¹æ˜“è¯†åˆ«å‡ºæ¥çš„å­åŸŸï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»æ ¸å¿ƒåŸŸå¼€å§‹ã€‚\næ¯ä¸€ä¸ªå­åŸŸç”šè‡³æ¯ä¸€ä¸ªé¢†åŸŸæ¨¡å‹éƒ½æ˜¯ä¸ºäº†äº§å“æ„¿æ™¯è€Œå­˜åœ¨çš„ã€‚æˆ‘ä»¬åˆ†è§£å­åŸŸçš„ç¬¬ä¸€æ­¥ï¼Œå°±æ˜¯ä»äº§å“æ„¿æ™¯ä¸­è·å–æ ¸å¿ƒåŸŸã€‚äº§å“æ„¿æ™¯åŒ…å«â€œç›¸å¯¹æŠ½è±¡çš„äº§å“ä»·å€¼â€ï¼Œä»¥åŠâ€œå®ç°è¯¥ä»·å€¼çš„ä¸»è¦åŠŸèƒ½â€ã€‚å…¶ä¸­ï¼Œä¸»è¦åŠŸèƒ½å°±æ˜¯æˆ‘ä»¬å¯»æ‰¾æ ¸å¿ƒåŸŸçš„ä¾æ®ã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœè¦åšMVPçš„è¯ï¼Œæˆ‘ä»¬ä¼šæŒ‘é€‰æœ€èƒ½å¤Ÿæä¾›å…¶æ ¸å¿ƒä»·å€¼çš„åŠŸèƒ½æ¥å¼€å‘ï¼Œä»¥éªŒè¯äº§å“ä»·å€¼ã€‚MVPå¾€å¾€å°±æ˜¯æ ¸å¿ƒåŸŸã€‚\nä»¥ä¸Šè¿°æ´»åŠ¨è¿è¥ç³»ç»Ÿä¸ºä¾‹ï¼Œå…¶äº§å“æ„¿æ™¯æ˜¯é€šè¿‡å„ç§å¸å¼•ç”¨æˆ·çš„ä¼˜æƒ æ´»åŠ¨ï¼Œä»¥å¸®åŠ©å®¢æˆ·é€šè¿‡æ´»åŠ¨æå‡ç”¨æˆ·é‡å’ŒçŸ¥ååº¦ã€‚å…¶æ ¸å¿ƒåŸŸæ˜¯ç»™å®¢æˆ·æä¾›å¸å¼•ç”¨æˆ·çš„å¤šæ ·çš„çµæ´»çš„æ´»åŠ¨ï¼ŒåŒ…æ‹¬æ´»åŠ¨å½¢å¼ã€æ´»åŠ¨è§„åˆ™å’Œå¤šç§å¥–åŠ±ã€‚\nè¯†åˆ«æ ¸å¿ƒåŸŸå‘¨è¾¹çš„å­åŸŸæ ¸å¿ƒåŸŸè¯†åˆ«å‡ºæ¥äº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯è¯†åˆ«æ ¸å¿ƒåŸŸå‘¨è¾¹çš„å­åŸŸã€‚æ ¸å¿ƒåŸŸå¾€å¾€ä¸ä¼šç‹¬ç«‹å­˜åœ¨ï¼Œä¼šæœ‰å…¶ä»–å­åŸŸåŒæ ¸å¿ƒåŸŸä¸€èµ·æ‰èƒ½è¾¾æˆä¸šåŠ¡ç›®æ ‡ã€‚è¿™é‡Œéœ€è¦å›ç­”çš„é—®é¢˜æ˜¯ï¼š\n\næœ‰å“ªäº›å­åŸŸæ˜¯ç”¨æ¥æ”¯æ’‘æ ¸å¿ƒåŸŸçš„ï¼Ÿ\nè¿™äº›å­åŸŸæ˜¯å¸®åŠ©æ ¸å¿ƒåŸŸæ›´å¥½çš„å·¥ä½œã€‚ä¾‹å¦‚æä¾›å®¡æ‰¹æµç¨‹ä»¥é…ç½®æ ¸å¿ƒåŸŸï¼Œæä¾›å„ç§è¾…åŠ©åŠŸèƒ½æ›´å¥½çš„ä¸ºæ ¸å¿ƒåŸŸæä¾›å†…å®¹ã€‚\n\næœ‰å“ªäº›å­åŸŸæ˜¯æ ¸å¿ƒåŸŸè¡ç”Ÿå‡ºæ¥çš„ï¼Ÿ\næ ¸å¿ƒåŸŸç»å¸¸ä¼šäº§ç”Ÿä¸€äº›æ•°æ®ï¼Œè¿™äº›æ•°æ®ä¹Ÿæœ‰å…¶ä»·å€¼ã€‚æ¯”å¦‚äº§ç”Ÿå„ç§æŠ¥è¡¨ï¼Œæ´»åŠ¨å¥–åŠ±çš„å‘æ”¾è®°å½•ã€‚\n\næœ‰å“ªäº›å­åŸŸæ˜¯ç”¨æ¥æ”¯æ’‘æˆ–è¡ç”Ÿè‡ªè¿™äº›æ–°è¯†åˆ«å‡ºçš„å­åŸŸçš„ï¼Ÿ\nç”¨æ¥æ”¯æ’‘æ ¸å¿ƒåŸŸçš„å­åŸŸã€ä»¥åŠæ ¸å¿ƒåŸŸè¡ç”Ÿçš„å­åŸŸï¼Œä¹Ÿæœ‰å„è‡ªçš„æ”¯æ’‘å­åŸŸå’Œè¡ç”Ÿå­åŸŸã€‚\n\n\n\nè¯†åˆ«å‡ºæ¥çš„æ¯ä¸ªå­åŸŸåªå¯¹åº”ä¸€ä¸ªé—®é¢˜ï¼Œå­åŸŸä¹‹é—´æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰äº¤å‰ï¼Œä¸æ˜¯åŒ…å«å…³ç³»ã€‚æ‰€ä»¥å­åŸŸåŠ èµ·æ¥å°±æ˜¯æ•´ä¸ªé¢†åŸŸã€‚\nä¹Ÿå¯ä»¥é€šè¿‡è§’è‰²ã€æ—¶é—´ç­‰å› ç´ åˆ†è§£å­åŸŸã€‚è§£å†³ä¸åŒè§’è‰²çš„é—®é¢˜å¯èƒ½åˆ†å±ä¸åŒå­åŸŸï¼Œæ¯”å¦‚ç”¨æˆ·å‚ä¸æ´»åŠ¨ã€è¿è¥äººå‘˜é…ç½®æ´»åŠ¨åˆ†å±ä¸åŒå­åŸŸï¼Œä¸¤ä¸ªå­åŸŸçš„å˜åŒ–åŸå› ä¸åŒï¼›ä¸åŒæ—¶é—´ä½¿ç”¨çš„åŠŸèƒ½å¯èƒ½å±äºä¸åˆ°å­åŸŸï¼Œæ¯”å¦‚å…ˆæœ‰è¿è¥äººå‘˜é…ç½®æ´»åŠ¨ï¼Œå†æœ‰ç”¨æˆ·å‚ä¸æ´»åŠ¨ï¼Œé…ç½®æ´»åŠ¨å’Œå‚ä¸æ´»åŠ¨åˆ†å±ä¸åŒå­åŸŸã€‚\nå¦‚æœæŒ‰ç…§èšåˆåˆ†ç»„åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼Œå¾ˆå¯èƒ½å‡ºç°â€œæ´»åŠ¨ä¸Šä¸‹æ–‡â€ï¼ŒåŒæ—¶æ´»åŠ¨æ¨¡å‹ï¼Œå³æ‰¿æ‹…è¿è¥äººå‘˜é…ç½®çš„èŒè´£ï¼Œåˆæ‰¿æ‹…ç”¨æˆ·å‚ä¸è§„åˆ™æ ¡éªŒçš„èŒè´£ï¼Œè¿™ä¼šå¯¼è‡´èŒè´£è¿‡å¤šï¼Œè¿èƒŒäº†å•ä¸€èŒè´£ã€‚å¦å¤–æ´»åŠ¨è§„åˆ™æ ¡éªŒçš„æ¨¡å—éœ€è¦æ”¯æŒé«˜å¹¶å‘ï¼Œéœ€è¦ä½¿ç”¨å’Œé…ç½®æ¨¡å—ä¸åŒçš„æŠ€æœ¯æ¶æ„ã€‚å¦‚æœè¿™äº›ç›¸ä¼¼çš„æ¦‚å¿µå’Œä¸åŒçš„æŠ€æœ¯å®ç°å±äºä¸åŒçš„ä¸Šä¸‹æ–‡ï¼Œå°±å¯ä»¥ä¿æŒå„è‡ªæ¨¡å‹çš„å®Œæ•´ï¼ŒæŠ€æœ¯ä¸Šä¹Ÿå¯ä»¥åšåˆ°ç‹¬ç«‹æ¼”è¿›ã€‚\nå­åŸŸçš„ç²’åº¦ç†è®ºä¸Šå­åŸŸä»ç„¶å¯ä»¥è¢«åˆ†è§£ã€‚ä¾‹å¦‚æ´»åŠ¨å­åŸŸå¯ä»¥åˆ†è§£ä¸ºæ´»åŠ¨å‚ä¸è§„åˆ™å­åŸŸã€å¥–åŠ±å­åŸŸç­‰ã€‚é‚£ä¹ˆå­åŸŸç²’åº¦å¤šå¤§æ˜¯åˆé€‚çš„å‘¢ï¼Ÿ\næˆ‘ä»¬å¸Œæœ›æ¯ä¸ªå­åŸŸå¯ä»¥è§£å†³æŸä¸ªç‰¹å®šçš„é—®é¢˜ï¼Œè®©è¿™ä¸ªé—®é¢˜çš„è§£å†³æ–¹æ¡ˆéƒ½å†…èšåœ¨å­åŸŸå¯¹åº”çš„é™ç•Œä¸Šä¸‹æ–‡å†…ï¼Œæ‰€ä»¥å¦‚æœé—®é¢˜çš„å†åˆ†è§£æ²¡æœ‰çš„è¾¹ç•Œå¹¶ä¸æ¸…æ™°ï¼Œå»ºè®®å…ˆä¸åˆ†è§£ã€‚éšæ„çš„æ‹†åˆ†ä¼šå¯¼è‡´æˆä¸ºâ€œåˆ†å¸ƒå¼å•ä½“â€ã€‚\nå››ã€è¯†åˆ«é™ç•Œä¸Šä¸‹æ–‡\nä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡å°è£…äº†ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹å­é¢†åŸŸçš„é¢†åŸŸæ¨¡å‹å’ŒæœåŠ¡ã€‚\nå­åŸŸsubdomainå’Œé™ç•Œä¸Šä¸‹æ–‡æŸç§æ„ä¹‰ä¸Šæ˜¯äº’ç›¸å°è¯çš„\nDDDæˆ˜æœ¯ç¯‡ï¼šé¢†åŸŸæ¨¡å‹çš„åº”ç”¨\n\nè¿™ä¸ªæ—¶å€™æˆ‘ä»¬é€šè¿‡äº‹ä»¶é£æš´å¾—åˆ°çš„é¢†åŸŸæ¨¡å‹å°±å¯ä»¥å‡ºåœºäº†ã€‚é¢†åŸŸæ¨¡å‹å’Œå­åŸŸéƒ½æ˜¯ä»ä¸šåŠ¡çŸ¥è¯†é‡Œåˆ†æå¾—åˆ°çš„ï¼Œå°†ä¸¤è€…åŒ¹é…èµ·æ¥å¯ä»¥å†æ¬¡éªŒè¯æˆ‘ä»¬å¯¹äºä¸šåŠ¡çš„ç†è§£ã€å­åŸŸçš„åˆ†è§£å’Œé¢†åŸŸæ¨¡å‹æ˜¯å¦åˆç†ã€‚\nä¸ºæ¯ä¸ªå­åŸŸåˆ›å»ºä¸€ä¸ªè§£å†³å…¶é—®é¢˜çš„é™ç•Œä¸Šä¸‹æ–‡ï¼Œç„¶åä¸ºæ¯ä¸ªé¢†åŸŸæ¨¡å‹æ‰¾åˆ°å…¶å½’å±çš„é™ç•Œä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªé¢†åŸŸäº‹ä»¶éƒ½æ˜¯ä¸ºäº†è§£å†³æŸä¸ªé—®é¢˜ï¼Œå®ƒå’Œå®ƒç›¸å…³çš„é¢†åŸŸæ¨¡å‹å°±åº”è¯¥æ”¾åœ¨è¿™ä¸ªé—®é¢˜å­åŸŸå¯¹åº”çš„é™ç•Œä¸Šä¸‹æ–‡é‡Œã€‚\næ¯”å¦‚â€œæ´»åŠ¨å·²ä¸Šçº¿â€œè¿™ä¸ªäº‹ä»¶ï¼Œç”±è¿è¥äººå‘˜åœ¨é…ç½®æ—¶è§¦å‘ï¼Œä¼šå¯¼è‡´ç”¨æˆ·å¯ä»¥å¼€å§‹å‚ä¸æ´»åŠ¨ã€‚é‚£ä¹ˆè¿™ä¸ªäº‹ä»¶åŠå…¶å¯¹åº”çš„â€œæ´»åŠ¨â€æ¦‚å¿µåº”è¯¥è¢«åˆ†ä¸ºä¸¤ä¸ªæ¨¡å‹ï¼Œåˆ†åˆ«å½’å±äºæ´»åŠ¨é…ç½®å­åŸŸå¯¹åº”çš„â€œæ´»åŠ¨é…ç½®ä¸Šä¸‹æ–‡â€å’Œæ´»åŠ¨å­åŸŸå¯¹åº”çš„â€œæ´»åŠ¨ä¸Šä¸‹æ–‡â€ã€‚\nä¸ºé¢†åŸŸæ¨¡å‹å¯»æ‰¾å½’å±å®Œæˆåï¼Œæˆ‘ä»¬ä¼šå‘ç°è¿™ä¹ˆå‡ ä¸ªæƒ…å†µã€‚\n\nåŒä¸€ä¸ªæ¦‚å¿µå¯èƒ½ä¼šå‡ºç°åœ¨å¤šä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­ã€‚å‘ç”Ÿè¿™ç§æƒ…å†µå¾ˆæ­£å¸¸ï¼Œè¯´æ˜è¿™å¤šä¸ªå­åŸŸéƒ½éœ€è¦è¿™ä¸ªæ¦‚å¿µï¼Œè€Œä¸”å¾ˆå¯èƒ½ä¸åŒå­åŸŸçš„é¢†åŸŸæ¨¡å‹ä¸å®Œå…¨ç›¸åŒã€‚\næ¯”å¦‚åˆšæ‰è¯´åˆ°â€œæ´»åŠ¨â€æ—¢å­˜åœ¨äºâ€œæ´»åŠ¨ä¸Šä¸‹æ–‡â€ä¸­ï¼Œåˆåœ¨â€œæ´»åŠ¨é…ç½®ä¸Šä¸‹æ–‡â€ä¸­ã€‚è¿™é‡Œæˆ‘ä»¬å°±å¾ˆå¥½çš„è¯†åˆ«å‡ºäº†â€œé‡å¤çš„æ¦‚å¿µâ€é—®é¢˜ã€‚\n\nä¹Ÿæœ‰ä¸€äº›æ¦‚å¿µé‡å¤åœ¨å¤šä¸ªé™ç•Œä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™äº›æ¦‚å¿µå’Œè¯¥ä¸Šä¸‹æ–‡çš„ä¸»é¢˜å¹¶æ²¡æœ‰ç´§å¯†çš„å…³ç³»ã€‚è¿™äº›æ¨¡å‹å¯ä»¥å•ç‹¬å‡ºä¸€ä¸ªé™ç•Œä¸Šä¸‹æ–‡ï¼Œç”¨ä»¥åŒæ—¶æ”¯æ’‘å¤šä¸ªé™ç•Œä¸Šä¸‹æ–‡ï¼Œä»¥å‡è½»é™ç•Œä¸Šä¸‹æ–‡çš„è´Ÿæ‹…ã€‚\n\næœ‰æ—¶å€™æŸä¸ªæ¨¡å‹æ‰¾ä¸åˆ°åˆé€‚çš„é™ç•Œä¸Šä¸‹æ–‡ï¼Œè¯´æ˜å¾ˆå¯èƒ½æ˜¯é—æ¼äº†ä¸€ä¸ªå­åŸŸï¼Œé‚£å°±éœ€è¦å›åˆ°â€œåˆ†è§£å­åŸŸâ€æ­¥éª¤ï¼Œé‡æ–°å®¡è§†äº§å“æ„¿æ™¯ã€‚\n\n\n\nèšåˆåˆ†ç»„æ³•é‡‡ç”¨â€œç›¸å…³æ€§â€æ¥åˆ’åˆ†é™ç•Œä¸Šä¸‹æ–‡ï¼Œå…¶é—®é¢˜åœ¨äºç¼ºå°‘ä¸€ä¸ªä¸»é¢˜ï¼Œè€Œå­åŸŸæ°å¥½å¯ä»¥ç”¨æ¥æä¾›è¿™ä¸ªä¸»é¢˜ã€‚æœ¬æ–‡çš„â€œæ„¿æ™¯â€-â€œæ ¸å¿ƒåŸŸâ€-â€œå‘¨è¾¹å­åŸŸâ€æ–¹æ³•ï¼Œä¸æ˜¯å”¯ä¸€åˆ†è§£é—®é¢˜åŸŸçš„æ–¹æ³•ï¼Œä»»ä½•å¯ä»¥å°†é¢†åŸŸåˆ†è§£æˆé«˜å†…èšä½è€¦åˆçš„å­åŸŸçš„æ–¹æ³•éƒ½æ˜¯å¯è¡Œçš„æ–¹æ³•ã€‚\n\né¢†åŸŸé©±åŠ¨è®¾è®¡\nå®ç°é¢†åŸŸé©±åŠ¨è®¾è®¡\nå¾®æœåŠ¡è®¾è®¡\nå¾®æœåŠ¡ | Martin Fowler\nPattern: Decompose by subdomain\nDDD &amp; Microservices\nDDDæˆ˜æœ¯ç¯‡ï¼šé¢†åŸŸæ¨¡å‹çš„åº”ç”¨\nå½“Subdomainé‡è§Bounded Context\nã€åšå®¢ã€‘ä½¿ç”¨ DDD æŒ‡å¯¼å¾®æœåŠ¡æ‹†åˆ†çš„é€»è¾‘\né¢†åŸŸé©±åŠ¨è®¾è®¡å®è·µï¼ˆæˆ˜ç•¥ç¯‡ï¼‰\nPROBLEM SPACE vs SOLUTION SPACE\nYouâ€™re Not Actually Building Microservices\nåˆ©ç”¨äº‹ä»¶é£æš´å‘ç°é™ç•Œä¸Šä¸‹æ–‡\nPattern: Saga\nç²¾ç›Šä»·å€¼æ ‘\nComplicated\nDefining Bounded Contexts â€” Eric Evans at DDD Europe\né¢†åŸŸé©±åŠ¨è®¾è®¡ç²¾ç²¹\n\n","categories":["é¢†åŸŸé©±åŠ¨è®¾è®¡"]},{"title":"ä¸å¯å˜åŸºç¡€è®¾æ–½ã€ä»å¾®æœåŠ¡åˆ°äº‘åŸç”Ÿã€‘","url":"/posts/34368/","content":"\näº‘åŸç”Ÿå®šä¹‰ï¼ˆCloud Native Definitionï¼‰Cloud native technologies empower organizations to build and run scalable applications in modern, dynamic environments such as public, private, and hybrid clouds. Containers, service meshes, microservices, immutable infrastructure, and declarative APIs exemplify this approach.\nThese techniques enable loosely coupled systems that are resilient, manageable, and observable. Combined with robust automation, they allow engineers to make high-impact changes frequently and predictably with minimal toil.\näº‘åŸç”ŸæŠ€æœ¯æœ‰åˆ©äºå„ç»„ç»‡åœ¨å…¬æœ‰äº‘ã€ç§æœ‰äº‘å’Œæ··åˆäº‘ç­‰æ–°å‹åŠ¨æ€ç¯å¢ƒä¸­ï¼Œæ„å»ºå’Œè¿è¡Œå¯å¼¹æ€§æ‰©å±•çš„åº”ç”¨ã€‚äº‘åŸç”Ÿçš„ä»£è¡¨æŠ€æœ¯åŒ…æ‹¬å®¹å™¨ã€æœåŠ¡ç½‘æ ¼ã€å¾®æœåŠ¡ã€ä¸å¯å˜åŸºç¡€è®¾æ–½å’Œå£°æ˜å¼ APIã€‚\nè¿™äº›æŠ€æœ¯èƒ½å¤Ÿæ„å»ºå®¹é”™æ€§å¥½ã€æ˜“äºç®¡ç†å’Œä¾¿äºè§‚å¯Ÿçš„æ¾è€¦åˆç³»ç»Ÿã€‚ç»“åˆå¯é çš„è‡ªåŠ¨åŒ–æ‰‹æ®µï¼Œäº‘åŸç”ŸæŠ€æœ¯ä½¿å·¥ç¨‹å¸ˆèƒ½å¤Ÿè½»æ¾åœ°å¯¹ç³»ç»Ÿä½œå‡ºé¢‘ç¹å’Œå¯é¢„æµ‹çš„é‡å¤§å˜æ›´ã€‚\nâ€‹                                                                                                                                                     â€”â€” Cloud Native Definition, CNCFï¼Œ2018\n\nâ€œä¸å¯å˜åŸºç¡€è®¾æ–½â€è¿™ä¸ªæ¦‚å¿µç”±æ¥å·²ä¹…ã€‚2012 å¹´ Martin Fowler è®¾æƒ³çš„â€œå‡¤å‡°æœåŠ¡å™¨â€ä¸ 2013 å¹´ Chad Fowler æ­£å¼æå‡ºçš„â€œä¸å¯å˜åŸºç¡€è®¾æ–½ï¼Œéƒ½é˜æ˜äº†åŸºç¡€è®¾æ–½ä¸å˜æ€§æ‰€èƒ½å¸¦æ¥çš„ç›Šå¤„ã€‚åœ¨äº‘åŸç”ŸåŸºé‡‘ä¼šå®šä¹‰çš„â€œäº‘åŸç”Ÿâ€æ¦‚å¿µä¸­ï¼Œâ€œä¸å¯å˜åŸºç¡€è®¾æ–½â€æå‡åˆ°äº†ä¸å¾®æœåŠ¡å¹³çº§çš„é‡è¦ç¨‹åº¦ï¼Œæ­¤æ—¶å®ƒçš„å†…æ¶µå·²ä¸å†å±€é™äºæ–¹ä¾¿è¿ç»´ã€ç¨‹åºå‡çº§å’Œéƒ¨ç½²çš„æ‰‹æ®µï¼Œè€Œæ˜¯å‡åä¸ºå‘åº”ç”¨ä»£ç éšè—åˆ†å¸ƒå¼æ¶æ„å¤æ‚åº¦ã€è®©åˆ†å¸ƒå¼æ¶æ„å¾—ä»¥æˆä¸ºä¸€ç§å¯æ™®éæ¨å¹¿çš„æ™®é€‚æ¶æ„é£æ ¼çš„å¿…è¦å‰æã€‚\nå‰ä¸€ç« ä»¥â€œåˆ†å¸ƒå¼çš„åŸºçŸ³â€ä¸ºé¢˜ï¼Œä»‹ç»äº†å¾®æœåŠ¡ä¸­å…³é”®çš„æŠ€æœ¯é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆï¼Œè§£å†³è¿™äº›é—®é¢˜åŸæœ¬åº”è¯¥æ˜¯æ¶æ„å¸ˆä¸ç¨‹åºå‘˜çš„æœ¬èŒå·¥ä½œã€‚åœ¨æœ¬ç« ï¼Œç¬”è€…ä¼šä»¥å®¹å™¨ã€ç¼–æ’ç³»ç»Ÿå’ŒæœåŠ¡ç½‘æ ¼çš„å‘å±•ä¸ºä¸»çº¿ï¼Œä»‹ç»è™šæ‹ŸåŒ–å®¹å™¨ä¸æœåŠ¡ç½‘æ ¼æ˜¯å¦‚ä½•æ¨¡ç³Šæ‰è½¯ä»¶ä¸ç¡¬ä»¶ä¹‹é—´çš„ç•Œé™ï¼Œå¦‚ä½•åœ¨åŸºç¡€è®¾æ–½ä¸é€šè®¯å±‚é¢ä¸Šå¸®åŠ©å¾®æœåŠ¡éšè—å¤æ‚æ€§ï¼Œè§£å†³åŸæœ¬åªèƒ½ç”±ç¨‹åºå‘˜é€šè¿‡è½¯ä»¶ç¼–ç¨‹æ¥è§£å†³çš„åˆ†å¸ƒå¼é—®é¢˜ã€‚\n","categories":["å‡¤å‡°æ¶æ„"]},{"title":"ä¸å¯å˜åŸºç¡€è®¾æ–½ã€è™šæ‹ŸåŒ–å®¹å™¨ã€‘","url":"/posts/30140/","content":"å®¹å™¨æ˜¯äº‘è®¡ç®—ã€å¾®æœåŠ¡ç­‰è¯¸å¤šè½¯ä»¶ä¸šç•Œæ ¸å¿ƒæŠ€æœ¯çš„å…±åŒåŸºçŸ³ï¼Œå®¹å™¨çš„é¦–è¦ç›®æ ‡æ˜¯è®©è½¯ä»¶åˆ†å‘éƒ¨ç½²è¿‡ç¨‹ä»ä¼ ç»Ÿçš„å‘å¸ƒå®‰è£…åŒ…ã€é äººå·¥éƒ¨ç½²è½¬å˜ä¸ºç›´æ¥å‘å¸ƒå·²ç»éƒ¨ç½²å¥½çš„ã€åŒ…å«æ•´å¥—è¿è¡Œç¯å¢ƒçš„è™šæ‹ŸåŒ–é•œåƒã€‚åœ¨å®¹å™¨æŠ€æœ¯æˆç†Ÿä¹‹å‰ï¼Œä¸»æµçš„è½¯ä»¶éƒ¨ç½²è¿‡ç¨‹æ˜¯ç”±ç³»ç»Ÿç®¡ç†å‘˜ç¼–è¯‘æˆ–ä¸‹è½½å¥½äºŒè¿›åˆ¶å®‰è£…åŒ…ï¼Œæ ¹æ®è½¯ä»¶çš„éƒ¨ç½²è¯´æ˜æ–‡æ¡£å‡†å¤‡å¥½æ­£ç¡®çš„æ“ä½œç³»ç»Ÿã€ç¬¬ä¸‰æ–¹åº“ã€é…ç½®æ–‡ä»¶ã€èµ„æºæƒé™ç­‰å„ç§å‰ç½®ä¾èµ–ä»¥åï¼Œæ‰èƒ½å°†ç¨‹åºæ­£ç¡®åœ°è¿è¡Œèµ·æ¥ã€‚Chad Fowleråœ¨æå‡ºâ€œä¸å¯å˜åŸºç¡€è®¾æ–½â€è¿™ä¸ªæ¦‚å¿µçš„æ–‡ç« ã€ŠTrash Your Servers and Burn Your Codeã€‹é‡Œï¼Œå¼€ç¯‡å°±ç›´æ¥åæ§½ï¼šè¦æŠŠä¸€ä¸ªä¸çŸ¥é“æ‰“è¿‡å¤šå°‘ä¸ªå‡çº§è¡¥ä¸ï¼Œä¸çŸ¥é“ç»å†äº†å¤šå°‘ä»»ç®¡ç†å‘˜çš„ç³»ç»Ÿè¿ç§»åˆ°å…¶ä»–æœºå™¨ä¸Šï¼Œæ¯«æ— ç–‘é—®ä¼šæ˜¯ä¸€åœºç¾éš¾ã€‚\nè®©è½¯ä»¶èƒ½å¤Ÿåœ¨ä»»ä½•ç¯å¢ƒã€ä»»ä½•ç‰©ç†æœºå™¨ä¸Šè¾¾åˆ°â€œä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œâ€æ›¾æ˜¯ Java æ—©å¹´çš„å®£ä¼ å£å·ï¼Œè¿™å¹¶ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ç›®æ ‡ï¼Œä¸è®¾å‰æçš„â€œåˆ°å¤„è¿è¡Œâ€ï¼Œä»…é  Java è¯­è¨€å’Œ Java è™šæ‹Ÿæœºæ˜¯ä¸å¯èƒ½è¾¾æˆçš„ï¼Œå› ä¸ºä¸€ä¸ªè®¡ç®—æœºè½¯ä»¶è¦èƒ½å¤Ÿæ­£ç¡®è¿è¡Œï¼Œéœ€è¦æœ‰ä»¥ä¸‹ä¸‰æ–¹é¢çš„å…¼å®¹æ€§æ¥å…±åŒä¿éšœï¼ˆè¿™é‡Œä»…è®¨è®ºè½¯ä»¶å…¼å®¹æ€§ï¼Œä¸å»æ¶‰åŠâ€œå¦‚æœæ²¡æœ‰æ‘„åƒå¤´å°±æ— æ³•è¿è¡Œç…§ç›¸ç¨‹åºâ€è¿™ç±»é—®é¢˜ï¼‰ï¼š\n\nISA å…¼å®¹ï¼šç›®æ ‡æœºå™¨æŒ‡ä»¤é›†å…¼å®¹æ€§ï¼Œè­¬å¦‚ ARM æ¶æ„çš„è®¡ç®—æœºæ— æ³•ç›´æ¥è¿è¡Œé¢å‘ x86 æ¶æ„ç¼–è¯‘çš„ç¨‹åºã€‚\nABI å…¼å®¹ï¼šç›®æ ‡ç³»ç»Ÿæˆ–è€…ä¾èµ–åº“çš„äºŒè¿›åˆ¶å…¼å®¹æ€§ï¼Œè­¬å¦‚ Windows ç³»ç»Ÿç¯å¢ƒä¸­æ— æ³•ç›´æ¥è¿è¡Œ Linux çš„ç¨‹åºï¼Œåˆè­¬å¦‚ DirectX 12 çš„æ¸¸æˆæ— æ³•è¿è¡Œåœ¨ DirectX 9 ä¹‹ä¸Šã€‚\nç¯å¢ƒå…¼å®¹ï¼šç›®æ ‡ç¯å¢ƒçš„å…¼å®¹æ€§ï¼Œè­¬å¦‚æ²¡æœ‰æ­£ç¡®è®¾ç½®çš„é…ç½®æ–‡ä»¶ã€ç¯å¢ƒå˜é‡ã€æ³¨å†Œä¸­å¿ƒã€æ•°æ®åº“åœ°å€ã€æ–‡ä»¶ç³»ç»Ÿçš„æƒé™ç­‰ç­‰ï¼Œä»»ä½•ä¸€ä¸ªç¯å¢ƒå› ç´ å‡ºç°é”™è¯¯ï¼Œéƒ½ä¼šè®©ä½ çš„ç¨‹åºæ— æ³•æ­£å¸¸è¿è¡Œã€‚\n\né¢å¤–çŸ¥è¯†ï¼šISA ä¸ ABI\næŒ‡ä»¤é›†æ¶æ„ï¼ˆInstruction Set Architectureï¼ŒISAï¼‰æ˜¯è®¡ç®—æœºä½“ç³»ç»“æ„ä¸­ä¸ç¨‹åºè®¾è®¡æœ‰å…³çš„éƒ¨åˆ†ï¼ŒåŒ…å«äº†åŸºæœ¬æ•°æ®ç±»å‹ï¼ŒæŒ‡ä»¤é›†ï¼Œå¯„å­˜å™¨ï¼Œå¯»å€æ¨¡å¼ï¼Œå­˜å‚¨ä½“ç³»ï¼Œä¸­æ–­ï¼Œå¼‚å¸¸å¤„ç†ä»¥åŠå¤–éƒ¨ I/Oã€‚æŒ‡ä»¤é›†æ¶æ„åŒ…å«ä¸€ç³»åˆ—çš„ Opcode æ“ä½œç ï¼ˆå³é€šå¸¸æ‰€è¯´çš„æœºå™¨è¯­è¨€ï¼‰ï¼Œä»¥åŠç”±ç‰¹å®šå¤„ç†å™¨æ‰§è¡Œçš„åŸºæœ¬å‘½ä»¤ã€‚\nåº”ç”¨äºŒè¿›åˆ¶æ¥å£ï¼ˆApplication Binary Interfaceï¼ŒABIï¼‰æ˜¯åº”ç”¨ç¨‹åºä¸æ“ä½œç³»ç»Ÿä¹‹é—´æˆ–å…¶ä»–ä¾èµ–åº“ä¹‹é—´çš„ä½çº§æ¥å£ã€‚ABI æ¶µç›–äº†å„ç§åº•å±‚ç»†èŠ‚ï¼Œå¦‚æ•°æ®ç±»å‹çš„å®½åº¦å¤§å°ã€å¯¹è±¡çš„å¸ƒå±€ã€æ¥å£è°ƒç”¨çº¦å®šç­‰ç­‰ã€‚ABI ä¸åŒäºåº”ç”¨ç¨‹åºæ¥å£ï¼ˆApplication Programming Interfaceï¼ŒAPIï¼‰ï¼ŒAPI å®šä¹‰çš„æ˜¯æºä»£ç å’Œåº“ä¹‹é—´çš„æ¥å£ï¼Œå› æ­¤åŒæ ·çš„ä»£ç å¯ä»¥åœ¨æ”¯æŒè¿™ä¸ª API çš„ä»»ä½•ç³»ç»Ÿä¸­ç¼–è¯‘ï¼Œè€Œ ABI å…è®¸ç¼–è¯‘å¥½çš„ç›®æ ‡ä»£ç åœ¨ä½¿ç”¨å…¼å®¹ ABI çš„ç³»ç»Ÿä¸­æ— éœ€æ”¹åŠ¨å°±èƒ½ç›´æ¥è¿è¡Œã€‚\nç¬”è€…æŠŠä½¿ç”¨ä»¿çœŸï¼ˆEmulationï¼‰ä»¥åŠè™šæ‹ŸåŒ–ï¼ˆVirtualizationï¼‰æŠ€æœ¯æ¥è§£å†³ä»¥ä¸Šä¸‰é¡¹å…¼å®¹æ€§é—®é¢˜çš„æ–¹æ³•éƒ½ç»Ÿç§°ä¸ºè™šæ‹ŸåŒ–æŠ€æœ¯ã€‚æ ¹æ®æŠ½è±¡ç›®æ ‡ä¸å…¼å®¹æ€§é«˜ä½çš„ä¸åŒï¼Œè™šæ‹ŸåŒ–æŠ€æœ¯åˆåˆ†ä¸ºä¸‹åˆ—äº”ç±»ï¼š\n\næŒ‡ä»¤é›†è™šæ‹ŸåŒ–ï¼ˆISA Level Virtualizationï¼‰ã€‚é€šè¿‡è½¯ä»¶æ¥æ¨¡æ‹Ÿä¸åŒ ISA æ¶æ„çš„å¤„ç†å™¨å·¥ä½œè¿‡ç¨‹ï¼Œå°†è™šæ‹Ÿæœºå‘å‡ºçš„æŒ‡ä»¤è½¬æ¢ä¸ºç¬¦åˆæœ¬æœº ISA çš„æŒ‡ä»¤ï¼Œä»£è¡¨ä¸ºQEMUå’ŒBochsã€‚æŒ‡ä»¤é›†è™šæ‹ŸåŒ–å°±æ˜¯ä»¿çœŸï¼Œèƒ½æä¾›äº†å‡ ä¹å®Œå…¨ä¸å—å±€é™çš„å…¼å®¹æ€§ï¼Œç”šè‡³èƒ½åšåˆ°ç›´æ¥åœ¨ Web æµè§ˆå™¨ä¸Šè¿è¡Œå®Œæ•´æ“ä½œç³»ç»Ÿè¿™ç§ä»¤äººæƒŠè®¶çš„æ•ˆæœï¼Œä½†ç”±äºæ¯æ¡æŒ‡ä»¤éƒ½è¦ç”±è½¯ä»¶æ¥è½¬æ¢å’Œæ¨¡æ‹Ÿï¼Œå®ƒä¹Ÿæ˜¯æ€§èƒ½æŸå¤±æœ€å¤§çš„è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚\nç¡¬ä»¶æŠ½è±¡å±‚è™šæ‹ŸåŒ–ï¼ˆHardware Abstraction Level Virtualizationï¼‰ã€‚ä»¥è½¯ä»¶æˆ–è€…ç›´æ¥é€šè¿‡ç¡¬ä»¶æ¥æ¨¡æ‹Ÿå¤„ç†å™¨ã€èŠ¯ç‰‡ç»„ã€å†…å­˜ã€ç£ç›˜æ§åˆ¶å™¨ã€æ˜¾å¡ç­‰è®¾å¤‡çš„å·¥ä½œè¿‡ç¨‹ã€‚æ—¢å¯ä»¥ä½¿ç”¨çº¯è½¯ä»¶çš„äºŒè¿›åˆ¶ç¿»è¯‘æ¥æ¨¡æ‹Ÿè™šæ‹Ÿè®¾å¤‡ï¼Œä¹Ÿå¯ä»¥ç”±ç¡¬ä»¶çš„Intel VT-dã€AMD-Viè¿™ç±»è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œå°†æŸä¸ªç‰©ç†è®¾å¤‡ç›´é€šï¼ˆPassthroughï¼‰åˆ°è™šæ‹Ÿæœºä¸­ä½¿ç”¨ï¼Œä»£è¡¨ä¸ºVMware ESXiå’ŒHyper-Vã€‚å¦‚æœæ²¡æœ‰é¢„è®¾è¯­å¢ƒï¼Œä¸€èˆ¬äººä»¬æ‰€è¯´çš„â€œè™šæ‹Ÿæœºâ€å°±æ˜¯æŒ‡è¿™ä¸€ç±»è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚\næ“ä½œç³»ç»Ÿå±‚è™šæ‹ŸåŒ–ï¼ˆOS Level Virtualizationï¼‰ã€‚æ— è®ºæ˜¯æŒ‡ä»¤é›†è™šæ‹ŸåŒ–è¿˜æ˜¯ç¡¬ä»¶æŠ½è±¡å±‚è™šæ‹ŸåŒ–ï¼Œéƒ½ä¼šè¿è¡Œä¸€å¥—å®Œå…¨çœŸå®çš„æ“ä½œç³»ç»Ÿæ¥è§£å†³ ABI å…¼å®¹æ€§å’Œç¯å¢ƒå…¼å®¹æ€§é—®é¢˜ï¼Œè™½ç„¶ ISA å…¼å®¹æ€§æ˜¯è™šæ‹Ÿå‡ºæ¥çš„ï¼Œä½† ABI å…¼å®¹æ€§å’Œç¯å¢ƒå…¼å®¹æ€§å´æ˜¯çœŸå®å­˜åœ¨çš„ã€‚è€Œæ“ä½œç³»ç»Ÿå±‚è™šæ‹ŸåŒ–åˆ™ä¸ä¼šæä¾›çœŸå®çš„æ“ä½œç³»ç»Ÿï¼Œè€Œæ˜¯é‡‡ç”¨éš”ç¦»æ‰‹æ®µï¼Œä½¿å¾—ä¸åŒè¿›ç¨‹æ‹¥æœ‰ç‹¬ç«‹çš„ç³»ç»Ÿèµ„æºå’Œèµ„æºé…é¢ï¼Œçœ‹èµ·æ¥ä»¿ä½›æ˜¯ç‹¬äº«äº†æ•´ä¸ªæ“ä½œç³»ç»Ÿä¸€èˆ¬ï¼Œå…¶å®ç³»ç»Ÿçš„å†…æ ¸ä»ç„¶æ˜¯è¢«ä¸åŒè¿›ç¨‹æ‰€å…±äº«çš„ã€‚æ“ä½œç³»ç»Ÿå±‚è™šæ‹ŸåŒ–çš„å¦ä¸€ä¸ªåå­—å°±æ˜¯æœ¬ç« çš„ä¸»è§’â€œå®¹å™¨åŒ–â€ï¼ˆContainerizationï¼‰ï¼Œç”±æ­¤å¯è§ï¼Œå®¹å™¨åŒ–ä»…ä»…æ˜¯è™šæ‹ŸåŒ–çš„ä¸€ä¸ªå­é›†ï¼Œåªèƒ½æä¾›æ“ä½œç³»ç»Ÿå†…æ ¸ä»¥ä¸Šçš„éƒ¨åˆ† ABI å…¼å®¹æ€§ä¸å®Œæ•´çš„ç¯å¢ƒå…¼å®¹æ€§ã€‚è¿™æ„å‘³ç€å¦‚æœæ²¡æœ‰å…¶ä»–è™šæ‹ŸåŒ–æ‰‹æ®µçš„è¾…åŠ©ï¼Œåœ¨ Windows ç³»ç»Ÿä¸Šæ˜¯ä¸å¯èƒ½è¿è¡Œ Linux çš„ Docker é•œåƒçš„ï¼ˆç°åœ¨å¯ä»¥ï¼Œæ˜¯å› ä¸ºæœ‰å…¶ä»–è™šæ‹Ÿæœºæˆ–è€… WSL2 çš„æ”¯æŒï¼‰ï¼Œåä¹‹äº¦ç„¶ã€‚ä¹ŸåŒæ ·å†³å®šäº†å¦‚æœ Docker å®¿ä¸»æœºçš„å†…æ ¸ç‰ˆæœ¬æ˜¯ Linux Kernel 5.6ï¼Œé‚£æ— è®ºä¸Šé¢è¿è¡Œçš„é•œåƒæ˜¯ Ubuntuã€RHELã€Fedoraã€Mint æˆ–è€…ä»»ä½•å‘è¡Œç‰ˆçš„é•œåƒï¼Œçœ‹åˆ°çš„å†…æ ¸ä¸€å®šéƒ½æ˜¯ç›¸åŒçš„ Linux Kernel 5.6ã€‚å®¹å™¨åŒ–ç‰ºç‰²äº†ä¸€å®šçš„éš”ç¦»æ€§ä¸å…¼å®¹æ€§ï¼Œæ¢æ¥çš„æ˜¯æ¯”å‰ä¸¤ç§è™šæ‹ŸåŒ–æ›´é«˜çš„å¯åŠ¨é€Ÿåº¦ã€è¿è¡Œæ€§èƒ½å’Œæ›´ä½çš„æ‰§è¡Œè´Ÿæ‹…ã€‚\nè¿è¡Œåº“è™šæ‹ŸåŒ–ï¼ˆLibrary Level Virtualizationï¼‰ã€‚ä¸æ“ä½œç³»ç»Ÿè™šæ‹ŸåŒ–é‡‡ç”¨éš”ç¦»æ‰‹æ®µæ¥æ¨¡æ‹Ÿç³»ç»Ÿä¸åŒï¼Œè¿è¡Œåº“è™šæ‹ŸåŒ–é€‰æ‹©ä½¿ç”¨è½¯ä»¶ç¿»è¯‘çš„æ–¹æ³•æ¥æ¨¡æ‹Ÿç³»ç»Ÿï¼Œå®ƒä»¥ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹æ¥ä»£æ›¿æ“ä½œç³»ç»Ÿå†…æ ¸æ¥æä¾›ç›®æ ‡è½¯ä»¶è¿è¡Œæ‰€éœ€çš„å…¨éƒ¨èƒ½åŠ›ï¼Œè¿™ç§è™šæ‹ŸåŒ–æ–¹æ³•è·å¾—çš„ ABI å…¼å®¹æ€§é«˜ä½ï¼Œå–å†³äºè½¯ä»¶æ˜¯å¦èƒ½è¶³å¤Ÿå‡†ç¡®å’Œå…¨é¢åœ°å®Œæˆç¿»è¯‘å·¥ä½œï¼Œå…¶ä»£è¡¨ä¸ºWINEï¼ˆWine Is Not an Emulator çš„ç¼©å†™ï¼Œä¸€æ¬¾åœ¨ Linux ä¸‹è¿è¡Œ Windows ç¨‹åºçš„è½¯ä»¶ï¼‰å’ŒWSLï¼ˆç‰¹æŒ‡ Windows Subsystem for Linux Version 1ï¼‰ã€‚\nè¯­è¨€å±‚è™šæ‹ŸåŒ–ï¼ˆProgramming Language Level Virtualizationï¼‰ã€‚ç”±è™šæ‹Ÿæœºå°†é«˜çº§è¯­è¨€ç”Ÿæˆçš„ä¸­é—´ä»£ç è½¬æ¢ä¸ºç›®æ ‡æœºå™¨å¯ä»¥ç›´æ¥æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä»£è¡¨ä¸º Java çš„ JVM å’Œ.NET çš„ CLRã€‚è™½ç„¶å‚å•†è‚¯å®šä¼šæä¾›ä¸åŒç³»ç»Ÿä¸‹éƒ½æœ‰ç›¸åŒæ¥å£çš„æ ‡å‡†åº“ï¼Œä½†æœ¬è´¨ä¸Šè¿™ç§è™šæ‹ŸåŒ–å¹¶ä¸ç›´æ¥è§£å†³ä»»ä½• ABI å…¼å®¹æ€§å’Œç¯å¢ƒå…¼å®¹æ€§é—®é¢˜ã€‚\n\nä¸€ã€å®¹å™¨çš„å´›èµ·å®¹å™¨çš„æœ€åˆçš„ç›®çš„ä¸æ˜¯ä¸ºäº†éƒ¨ç½²è½¯ä»¶ï¼Œè€Œæ˜¯ä¸ºäº†éš”ç¦»è®¡ç®—æœºä¸­çš„å„ç±»èµ„æºï¼Œä»¥ä¾¿é™ä½è½¯ä»¶å¼€å‘ã€æµ‹è¯•é˜¶æ®µå¯èƒ½äº§ç”Ÿçš„è¯¯æ“ä½œé£é™©ï¼Œæˆ–è€…ä¸“é—¨å……å½“èœœç½ï¼Œå¸å¼•é»‘å®¢çš„æ”»å‡»ï¼Œä»¥ä¾¿ç›‘è§†é»‘å®¢çš„è¡Œä¸ºã€‚ä¸‹é¢ï¼Œç¬”è€…å°†ä»¥å®¹å™¨å‘å±•å†å²ä¸ºçº¿ç´¢ï¼Œä»‹ç»å®¹å™¨æŠ€æœ¯åœ¨ä¸åŒå†å²é˜¶æ®µä¸­çš„ä¸»è¦å…³æ³¨ç‚¹ã€‚\néš”ç¦»æ–‡ä»¶ï¼šchrootå®¹å™¨çš„èµ·ç‚¹å¯ä»¥è¿½æº¯åˆ° 1979 å¹´Version 7 UNIXç³»ç»Ÿä¸­æä¾›çš„chrootå‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤æ˜¯è‹±æ–‡å•è¯â€œChange Rootâ€çš„ç¼©å†™ï¼ŒåŠŸèƒ½æ˜¯å½“æŸä¸ªè¿›ç¨‹ç»è¿‡chrootæ“ä½œä¹‹åï¼Œå®ƒçš„æ ¹ç›®å½•å°±ä¼šè¢«é”å®šåœ¨å‘½ä»¤å‚æ•°æ‰€æŒ‡å®šçš„ä½ç½®ï¼Œä»¥åå®ƒæˆ–è€…å®ƒçš„å­è¿›ç¨‹å°†ä¸èƒ½å†è®¿é—®å’Œæ“ä½œè¯¥ç›®å½•ä¹‹å¤–çš„å…¶ä»–æ–‡ä»¶ã€‚\n1991 å¹´ï¼Œä¸–ç•Œä¸Šç¬¬ä¸€ä¸ªç›‘æ§é»‘å®¢è¡ŒåŠ¨çš„èœœç½ç¨‹åºå°±æ˜¯ä½¿ç”¨chrootæ¥å®ç°çš„ï¼Œé‚£ä¸ªå‚æ•°æŒ‡å®šçš„æ ¹ç›®å½•å½“æ—¶è¢«ä½œè€…æˆç§°ä¸ºâ€œChroot ç›‘ç‹±â€ï¼ˆChroot Jailï¼‰ï¼Œé»‘å®¢çªç ´chrooté™åˆ¶çš„æ–¹æ³•å°±ç§°ä¸º Jailbreakã€‚åæ¥ï¼ŒFreeBSD 4.0 ç³»ç»Ÿé‡æ–°å®ç°äº†chrootå‘½ä»¤ï¼Œç”¨å®ƒä½œä¸ºç³»ç»Ÿä¸­è¿›ç¨‹æ²™ç®±éš”ç¦»çš„åŸºç¡€ï¼Œå¹¶å°†å…¶å‘½åä¸ºFreeBSD jailï¼Œå†åæ¥ï¼Œè‹¹æœå…¬å¸åˆä»¥ FreeBSD ä¸ºåŸºç¡€ç ”å‘å‡ºäº†ä¸¾ä¸–é—»åçš„ iOS æ“ä½œç³»ç»Ÿï¼Œæ­¤æ—¶ï¼Œé»‘å®¢ä»¬å°±å°†ç»•è¿‡ iOS æ²™ç®±æœºåˆ¶ä»¥ root æƒé™ä»»æ„å®‰è£…ç¨‹åºçš„æ–¹æ³•ç§°ä¸ºâ€œè¶Šç‹±â€ï¼ˆJailbreakï¼‰ï¼Œè¿™äº›æ•…äº‹éƒ½æ˜¯é¢˜å¤–è¯äº†ã€‚\n2000 å¹´ï¼ŒLinux Kernel 2.3.41 ç‰ˆå†…æ ¸å¼•å…¥äº†pivot_rootæŠ€æœ¯æ¥å®ç°æ–‡ä»¶éš”ç¦»ï¼Œpivot_rootç›´æ¥åˆ‡æ¢äº†æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆrootfsï¼‰ï¼Œæœ‰æ•ˆåœ°é¿å…äº†chrootå‘½ä»¤å¯èƒ½å‡ºç°çš„å®‰å…¨æ€§æ¼æ´ã€‚æœ¬æ–‡åç»­æåˆ°çš„å®¹å™¨æŠ€æœ¯ï¼Œå¦‚ LXCã€Docker ç­‰ä¹Ÿéƒ½æ˜¯ä¼˜å…ˆä½¿ç”¨pivot_rootæ¥å®ç°æ ¹æ–‡ä»¶ç³»ç»Ÿåˆ‡æ¢çš„ã€‚\næ—¶è‡³ä»Šæ—¥ï¼Œchrootå‘½ä»¤ä¾ç„¶æ´»è·ƒåœ¨ UNIX ç³»ç»Ÿä¸å‡ ä¹æ‰€æœ‰ä¸»æµçš„ Linux å‘è¡Œç‰ˆä¸­ï¼ŒåŒæ—¶ä»¥å‘½ä»¤è¡Œå·¥å…·ï¼ˆchroot(8)ï¼‰æˆ–è€…ç³»ç»Ÿè°ƒç”¨ï¼ˆchroot(2)ï¼‰çš„å½¢å¼å­˜åœ¨ï¼Œä½†æ— è®ºæ˜¯chrootå‘½ä»¤æŠ‘æˆ–æ˜¯pivot_rootï¼Œéƒ½å¹¶ä¸èƒ½æä¾›å®Œç¾çš„éš”ç¦»æ€§ã€‚åŸæœ¬æŒ‰ç…§ UNIX çš„è®¾è®¡å“²å­¦ï¼Œä¸€åˆ‡èµ„æºéƒ½å¯ä»¥è§†ä¸ºæ–‡ä»¶ï¼ˆIn UNIXï¼ŒEverything is a Fileï¼‰ï¼Œä¸€åˆ‡å¤„ç†éƒ½å¯ä»¥è§†ä¸ºå¯¹æ–‡ä»¶çš„æ“ä½œï¼Œç†è®ºä¸Šï¼Œåªè¦éš”ç¦»äº†æ–‡ä»¶ç³»ç»Ÿï¼Œä¸€åˆ‡èµ„æºéƒ½åº”è¯¥è¢«è‡ªåŠ¨éš”ç¦»æ‰å¯¹ã€‚å¯æ˜¯å“²å­¦å½’å“²å­¦ï¼Œç°å®å½’ç°å®ï¼Œä»ç¡¬ä»¶å±‚é¢æš´éœ²çš„ä½å±‚æ¬¡èµ„æºï¼Œå¦‚ç£ç›˜ã€ç½‘ç»œã€å†…å­˜ã€å¤„ç†å™¨ï¼Œåˆ°ç»æ“ä½œç³»ç»Ÿå±‚é¢å°è£…çš„é«˜å±‚æ¬¡èµ„æºï¼Œå¦‚ UNIX åˆ†æ—¶ï¼ˆUNIX Time-Sharingï¼ŒUTSï¼‰ã€è¿›ç¨‹ IDï¼ˆProcess IDï¼ŒPIDï¼‰ã€ç”¨æˆ· IDï¼ˆUser IDï¼ŒUIDï¼‰ã€è¿›ç¨‹é—´é€šä¿¡ï¼ˆInter-Process Communicationï¼ŒIPCï¼‰éƒ½å­˜åœ¨å¤§é‡ä»¥éæ–‡ä»¶å½¢å¼æš´éœ²çš„æ“ä½œå…¥å£ï¼Œå› æ­¤ï¼Œä»¥chrootä¸ºä»£è¡¨çš„æ–‡ä»¶éš”ç¦»ï¼Œä»…ä»…æ˜¯å®¹å™¨å´›èµ·ä¹‹è·¯çš„èµ·ç‚¹è€Œå·²ã€‚\néš”ç¦»è®¿é—®ï¼šnamespaces2002 å¹´ï¼ŒLinux Kernel 2.4.19 ç‰ˆå†…æ ¸å¼•å…¥äº†ä¸€ç§å…¨æ–°çš„éš”ç¦»æœºåˆ¶ï¼šLinux åç§°ç©ºé—´ï¼ˆLinux Namespacesï¼‰ã€‚åç§°ç©ºé—´çš„æ¦‚å¿µåœ¨å¾ˆå¤šç°ä»£çš„é«˜çº§ç¨‹åºè¯­è¨€ä¸­éƒ½å­˜åœ¨ï¼Œç”¨äºé¿å…ä¸åŒå¼€å‘è€…æä¾›çš„ API ç›¸äº’å†²çªï¼Œç›¸ä¿¡ä½œä¸ºä¸€åå¼€å‘äººå‘˜çš„ä½ è‚¯å®šä¸é™Œç”Ÿã€‚\nLinux çš„åç§°ç©ºé—´æ˜¯ä¸€ç§ç”±å†…æ ¸ç›´æ¥æä¾›çš„å…¨å±€èµ„æºå°è£…ï¼Œæ˜¯å†…æ ¸é’ˆå¯¹è¿›ç¨‹è®¾è®¡çš„è®¿é—®éš”ç¦»æœºåˆ¶ã€‚è¿›ç¨‹åœ¨ä¸€ä¸ªç‹¬ç«‹çš„ Linux åç§°ç©ºé—´ä¸­æœç³»ç»Ÿçœ‹å»ï¼Œä¼šè§‰å¾—è‡ªå·±ä»¿ä½›å°±æ˜¯è¿™æ–¹å¤©åœ°çš„ä¸»äººï¼Œæ‹¥æœ‰è¿™å° Linux ä¸»æœºä¸Šçš„ä¸€åˆ‡èµ„æºï¼Œä¸ä»…æ–‡ä»¶ç³»ç»Ÿæ˜¯ç‹¬ç«‹çš„ï¼Œè¿˜æœ‰ç€ç‹¬ç«‹çš„ PID ç¼–å·ï¼ˆè­¬å¦‚æ‹¥æœ‰è‡ªå·±çš„ 0 å·è¿›ç¨‹ï¼Œå³ç³»ç»Ÿåˆå§‹åŒ–çš„è¿›ç¨‹ï¼‰ã€UID/GID ç¼–å·ï¼ˆè­¬å¦‚æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ root ç”¨æˆ·ï¼‰ã€ç½‘ç»œï¼ˆè­¬å¦‚å®Œå…¨ç‹¬ç«‹çš„ IP åœ°å€ã€ç½‘ç»œæ ˆã€é˜²ç«å¢™ç­‰è®¾ç½®ï¼‰ï¼Œç­‰ç­‰ï¼Œæ­¤æ—¶è¿›ç¨‹çš„å¿ƒæƒ…ç®€ç›´ä¸èƒ½å†å¥½äº†ã€‚\nLinux çš„åç§°ç©ºé—´æ˜¯å—â€œè´å°”å®éªŒå®¤ä¹å·é¡¹ç›®â€ï¼ˆä¸€ä¸ªåˆ†å¸ƒå¼æ“ä½œç³»ç»Ÿï¼Œâ€œä¹å·â€é¡¹ç›®å¹¶éä»£å·ï¼Œæ“ä½œç³»ç»Ÿçš„åå­—å°±å«â€œPlan 9 from Bell Labsâ€ï¼Œå……æ»¡äº†èµ›åšæœ‹å…‹é£æ ¼ï¼‰çš„å¯å‘è€Œè®¾è®¡çš„ï¼Œæœ€åˆçš„ç›®çš„ä¾ç„¶åªæ˜¯ä¸ºäº†éš”ç¦»æ–‡ä»¶ç³»ç»Ÿï¼Œè€Œéä¸ºäº†ä»€ä¹ˆå®¹å™¨åŒ–çš„å®ç°ã€‚è¿™ç‚¹ä» 2002 å¹´å‘å¸ƒæ—¶åªæä¾›äº† Mount åç§°ç©ºé—´ï¼Œå¹¶ä¸”å…¶æ„é€ å‚æ•°ä¸ºâ€œCLONE_NEWNSâ€ï¼ˆå³ Clone New Namespace çš„ç¼©å†™ï¼‰è€Œéâ€œCLONE_NEWMOUNTâ€ä¾¿èƒ½çœ‹å‡ºä¸€äº›ç«¯å€ªã€‚åæ¥ï¼Œè¦æ±‚ç³»ç»Ÿéš”ç¦»å…¶ä»–è®¿é—®æ“ä½œçš„å‘¼å£°æ„ˆå‘å¼ºçƒˆï¼Œä» 2006 å¹´èµ·ï¼Œå†…æ ¸é™†ç»­æ·»åŠ äº† UTSã€IPC ç­‰åç§°ç©ºé—´éš”ç¦»ï¼Œç›´åˆ°ç›®å‰æœ€æ–°çš„ Linux Kernel 5.6 ç‰ˆå†…æ ¸ä¸ºæ­¢ï¼ŒLinux åç§°ç©ºé—´æ”¯æŒä»¥ä¸‹å…«ç§èµ„æºçš„éš”ç¦»ï¼ˆå†…æ ¸çš„å®˜ç½‘Kernel.orgä¸Šä»ç„¶åªåˆ—å‡ºäº†å‰å…­ç§ï¼Œä» Linux çš„ Man å‘½ä»¤èƒ½æŸ¥åˆ°å…¨éƒ¨å…«ç§ï¼‰ã€‚\nè¡¨ 11-1 Linux åç§°ç©ºé—´æ”¯æŒä»¥ä¸‹å…«ç§èµ„æºçš„éš”ç¦»\n\n\n\nåç§°ç©ºé—´\néš”ç¦»å†…å®¹\nå†…æ ¸ç‰ˆæœ¬\n\n\n\nMount\néš”ç¦»æ–‡ä»¶ç³»ç»Ÿï¼ŒåŠŸèƒ½ä¸Šå¤§è‡´å¯ä»¥ç±»æ¯”chroot\n2.4.19\n\n\nUTS\néš”ç¦»ä¸»æœºçš„Hostnameã€Domain names\n2.6.19\n\n\nIPC\néš”ç¦»è¿›ç¨‹é—´é€šä¿¡çš„æ¸ é“ï¼ˆè¯¦è§â€œè¿œç¨‹æœåŠ¡è°ƒç”¨â€ä¸­å¯¹ IPC çš„ä»‹ç»ï¼‰\n2.6.19\n\n\nPID\néš”ç¦»è¿›ç¨‹ç¼–å·ï¼Œæ— æ³•çœ‹åˆ°å…¶ä»–åç§°ç©ºé—´ä¸­çš„ PIDï¼Œæ„å‘³ç€æ— æ³•å¯¹å…¶ä»–è¿›ç¨‹äº§ç”Ÿå½±å“\n2.6.24\n\n\nNetwork\néš”ç¦»ç½‘ç»œèµ„æºï¼Œå¦‚ç½‘å¡ã€ç½‘ç»œæ ˆã€IP åœ°å€ã€ç«¯å£ï¼Œç­‰ç­‰\n2.6.29\n\n\nUser\néš”ç¦»ç”¨æˆ·å’Œç”¨æˆ·ç»„\n3.8\n\n\nCgroup\néš”ç¦»cgroupsä¿¡æ¯ï¼Œè¿›ç¨‹æœ‰è‡ªå·±çš„cgroupsçš„æ ¹ç›®å½•è§†å›¾ï¼ˆåœ¨/proc/self/cgroup ä¸ä¼šçœ‹åˆ°æ•´ä¸ªç³»ç»Ÿçš„ä¿¡æ¯ï¼‰ã€‚cgroupsçš„è¯é¢˜å¾ˆé‡è¦ï¼Œç¨åç¬”è€…ä¼šå®‰æ’ä¸€æ•´èŠ‚æ¥ä»‹ç»\n4.6\n\n\nTime\néš”ç¦»ç³»ç»Ÿæ—¶é—´ï¼Œ2020 å¹´ 3 æœˆæœ€æ–°çš„ 5.6 å†…æ ¸å¼€å§‹æ”¯æŒè¿›ç¨‹ç‹¬ç«‹è®¾ç½®ç³»ç»Ÿæ—¶é—´\n5.6\n\n\nå¦‚ä»Šï¼Œå¯¹æ–‡ä»¶ã€è¿›ç¨‹ã€ç”¨æˆ·ã€ç½‘ç»œç­‰å„ç±»ä¿¡æ¯çš„è®¿é—®ï¼Œéƒ½è¢«å›Šæ‹¬åœ¨ Linux çš„åç§°ç©ºé—´ä¸­ï¼Œå³ä½¿ä»Šå¤©ä»æœ‰ä¸€äº›æ²¡è¢«éš”ç¦»çš„è®¿é—®ï¼ˆè­¬å¦‚syslogå°±è¿˜æ²¡è¢«éš”ç¦»ï¼Œå®¹å™¨å†…å¯ä»¥çœ‹åˆ°å®¹å™¨å¤–å…¶ä»–è¿›ç¨‹äº§ç”Ÿçš„å†…æ ¸ syslogï¼‰ï¼Œæ—¥åä¹Ÿå¯ä»¥éšå†…æ ¸ç‰ˆæœ¬çš„æ›´æ–°çº³å…¥åˆ°è¿™å¥—æ¡†æ¶ä¹‹å†…ï¼Œç°åœ¨è·ç¦»å®Œç¾çš„éš”ç¦»æ€§å°±åªå·®æœ€åä¸€æ­¥äº†ï¼šèµ„æºçš„éš”ç¦»ã€‚\néš”ç¦»èµ„æºï¼šcgroupså¦‚æœè¦è®©ä¸€å°ç‰©ç†è®¡ç®—æœºä¸­çš„å„ä¸ªè¿›ç¨‹çœ‹èµ·æ¥åƒç‹¬äº«æ•´å°è™šæ‹Ÿè®¡ç®—æœºçš„è¯ï¼Œä¸ä»…è¦éš”ç¦»å„è‡ªè¿›ç¨‹çš„è®¿é—®æ“ä½œï¼Œè¿˜å¿…é¡»èƒ½ç‹¬ç«‹æ§åˆ¶åˆ†é…ç»™å„ä¸ªè¿›ç¨‹çš„èµ„æºä½¿ç”¨é…é¢ï¼Œä¸ç„¶çš„è¯ï¼Œä¸€ä¸ªè¿›ç¨‹å‘ç”Ÿäº†å†…å­˜æº¢å‡ºæˆ–è€…å æ»¡äº†å¤„ç†å™¨ï¼Œå…¶ä»–è¿›ç¨‹å°±è«åå…¶å¦™åœ°è¢«ç‰µè¿æŒ‚èµ·ï¼Œè¿™æ ·è‚¯å®šç®—ä¸ä¸Šæ˜¯å®Œç¾çš„éš”ç¦»ã€‚\nLinux ç³»ç»Ÿè§£å†³ä»¥ä¸Šé—®é¢˜çš„æ–¹æ¡ˆæ˜¯æ§åˆ¶ç¾¤ç»„ï¼ˆControl Groupsï¼Œç›®å‰å¸¸ç”¨çš„ç®€å†™ä¸ºcgroupsï¼‰ï¼Œå®ƒä¸åç§°ç©ºé—´ä¸€æ ·éƒ½æ˜¯ç›´æ¥ç”±å†…æ ¸æä¾›çš„åŠŸèƒ½ï¼Œç”¨äºéš”ç¦»æˆ–è€…è¯´åˆ†é…å¹¶é™åˆ¶æŸä¸ªè¿›ç¨‹ç»„èƒ½å¤Ÿä½¿ç”¨çš„èµ„æºé…é¢ï¼Œèµ„æºé…é¢åŒ…æ‹¬å¤„ç†å™¨æ—¶é—´ã€å†…å­˜å¤§å°ã€ç£ç›˜ I/O é€Ÿåº¦ï¼Œç­‰ç­‰ï¼Œå…·ä½“å¯ä»¥å‚è§è¡¨ 11-2 æ‰€ç¤ºã€‚\nè¡¨ 11-2 Linux æ§åˆ¶ç¾¤ç»„å­ç³»ç»Ÿ\n\n\n\næ§åˆ¶ç»„å­ç³»ç»Ÿ\nåŠŸèƒ½\n\n\n\nblkio\nä¸ºå—è®¾å¤‡ï¼ˆå¦‚ç£ç›˜ï¼Œå›ºæ€ç¡¬ç›˜ï¼ŒUSB ç­‰ç­‰ï¼‰è®¾å®š I/O é™é¢ã€‚\n\n\ncpu\næ§åˆ¶cgroupsä¸­è¿›ç¨‹çš„å¤„ç†å™¨å ç”¨æ¯”ç‡ã€‚\n\n\ncpuacct\nè‡ªåŠ¨ç”Ÿæˆcgroupsä¸­è¿›ç¨‹æ‰€ä½¿ç”¨çš„å¤„ç†å™¨æ—¶é—´çš„æŠ¥å‘Šã€‚\n\n\ncpuset\nä¸ºcgroupsä¸­çš„è¿›ç¨‹åˆ†é…ç‹¬ç«‹çš„å¤„ç†å™¨ï¼ˆåŒ…æ‹¬å¤šè·¯ç³»ç»Ÿçš„å¤„ç†å™¨ï¼Œå¤šæ ¸ç³»ç»Ÿçš„å¤„ç†å™¨æ ¸å¿ƒï¼‰ã€‚\n\n\ndevices\nè®¾ç½®cgroupsä¸­çš„è¿›ç¨‹è®¿é—®æŸä¸ªè®¾å¤‡çš„æƒé™ï¼ˆè¯»ã€å†™ã€åˆ›å»ºä¸‰ç§æƒé™ï¼‰ã€‚\n\n\nfreezer\næŒ‚èµ·æˆ–è€…æ¢å¤cgroupsä¸­çš„è¿›ç¨‹ã€‚\n\n\nmemory\nè®¾å®šcgroupsä¸­è¿›ç¨‹ä½¿ç”¨å†…å­˜çš„é™åˆ¶ï¼Œå¹¶è‡ªåŠ¨ç”Ÿæˆå†…å­˜èµ„æºä½¿ç”¨æŠ¥å‘Šã€‚\n\n\nnet_cls\nä½¿ç”¨ç­‰çº§è¯†åˆ«ç¬¦æ ‡è®°ç½‘ç»œæ•°æ®åŒ…ï¼Œå¯å…è®¸ Linux æµé‡æ§åˆ¶ç¨‹åºè¯†åˆ«ä»å…·ä½“ cgroupsä¸­ç”Ÿæˆçš„æ•°æ®åŒ…ã€‚\n\n\nnet_prio\nç”¨æ¥è®¾ç½®ç½‘ç»œæµé‡çš„ä¼˜å…ˆçº§ã€‚\n\n\nhugetlb\nä¸»è¦é’ˆå¯¹äº HugeTLB ç³»ç»Ÿè¿›è¡Œé™åˆ¶ã€‚\n\n\nperf_event\nå…è®¸ Perf å·¥å…·åŸºäºcgroupsåˆ†ç»„åšæ€§èƒ½ç›‘æµ‹ã€‚\n\n\ncgroupsé¡¹ç›®æœ€æ—©æ˜¯ç”± Google çš„å·¥ç¨‹å¸ˆï¼ˆä¸»è¦æ˜¯ Paul Menage å’Œ Rohit Sethï¼‰åœ¨ 2006 å¹´å‘èµ·çš„ï¼Œå½“æ—¶å–çš„åå­—å°±å«ä½œâ€œè¿›ç¨‹å®¹å™¨â€ï¼ˆProcess Containersï¼‰ï¼Œä¸è¿‡â€œå®¹å™¨â€ï¼ˆContainerï¼‰è¿™ä¸ªåè¯çš„å®šä¹‰åœ¨é‚£æ—¶å€™å°šä¸å¦‚ä»Šå¤©æ¸…æ™°ï¼Œä¸åŒåœºæ™¯ä¸­å¸¸æœ‰ä¸åŒæ‰€æŒ‡ï¼Œä¸ºé¿å…æ··ä¹±ï¼Œ2007 å¹´è¿™ä¸ªé¡¹ç›®æ‰è¢«é‡å‘½åä¸ºcgroupsï¼Œåœ¨ 2008 å¹´åˆå¹¶åˆ° 2.6.24 ç‰ˆçš„å†…æ ¸åæ­£å¼å¯¹å¤–å‘å¸ƒï¼Œè¿™ä¸€é˜¶æ®µçš„cgroupsè¢«ç§°ä¸ºâ€œç¬¬ä¸€ä»£cgroupsâ€ã€‚2016 å¹´ 3 æœˆå‘å¸ƒçš„ Linux Kernel 4.5 ä¸­ï¼Œæ­è½½äº†ç”± Facebook å·¥ç¨‹å¸ˆï¼ˆä¸»è¦æ˜¯ Tejun Heoï¼‰é‡æ–°ç¼–å†™çš„â€œç¬¬äºŒä»£cgroupsâ€ï¼Œå…¶å…³é”®æ”¹è¿›æ˜¯æ”¯æŒç»Ÿä¸€å±‚çº§ç®¡ç†ï¼ˆUnified Hierarchyï¼‰ï¼Œä½¿å¾—ç®¡ç†å‘˜èƒ½æ›´åŠ æ¸…æ™°ç²¾ç¡®åœ°æ§åˆ¶èµ„æºçš„å±‚çº§å…³ç³»ã€‚ç›®å‰è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„cgroupsåœ¨ Linux å†…æ ¸ä»£ç ä¸­æ˜¯å¹¶å­˜çš„ï¼Œç¨åä»‹ç»çš„ Docker æš‚æ—¶ä»…æ”¯æŒç¬¬ä¸€ä»£çš„cgroupsã€‚\nå°è£…ç³»ç»Ÿï¼šLXCå½“æ–‡ä»¶ç³»ç»Ÿã€è®¿é—®ã€èµ„æºéƒ½å¯ä»¥è¢«éš”ç¦»åï¼Œå®¹å™¨å·²ç»æœ‰å®ƒé™ç”Ÿæ‰€éœ€çš„å…¨éƒ¨å‰ç½®æ”¯æ’‘æ¡ä»¶ï¼Œå¹¶ä¸” Linux çš„å¼€å‘è€…ä»¬ä¹Ÿå·²ç»æ˜ç¡®åœ°çœ‹åˆ°äº†è¿™ä¸€ç‚¹ã€‚ä¸ºé™ä½æ™®é€šç”¨æˆ·ç»¼åˆä½¿ç”¨namespacesã€cgroupsè¿™äº›ä½çº§ç‰¹æ€§çš„é—¨æ§›ï¼Œ2008 å¹´ Linux Kernel 2.6.24 å†…æ ¸åˆšåˆšå¼€å§‹æä¾›cgroupsçš„åŒä¸€æ—¶é—´ï¼Œå°±é©¬ä¸Šå‘å¸ƒäº†åä¸ºLinux å®¹å™¨ï¼ˆLinuX Containersï¼ŒLXCï¼‰çš„ç³»ç»Ÿçº§è™šæ‹ŸåŒ–åŠŸèƒ½ã€‚\næ­¤å‰ï¼Œåœ¨ Linux ä¸Šå¹¶ä¸æ˜¯æ²¡æœ‰ç³»ç»Ÿçº§è™šæ‹ŸåŒ–çš„è§£å†³æ–¹æ¡ˆï¼Œè­¬å¦‚ä¼ ç»Ÿçš„OpenVZå’ŒLinux-VServeréƒ½èƒ½å¤Ÿå®ç°å®¹å™¨éš”ç¦»ï¼Œå¹¶ä¸”åªä¼šæœ‰å¾ˆä½çš„æ€§èƒ½æŸå¤±ï¼ˆæŒ‰ OpenVZ æä¾›çš„æ•°æ®ï¼Œåªä¼šæœ‰ 1-3%çš„æŸå¤±ï¼‰ï¼Œä½†å®ƒä»¬éƒ½æ˜¯éå®˜æ–¹çš„æŠ€æœ¯ï¼Œä½¿ç”¨å®ƒä»¬æœ€å¤§çš„é˜»ç¢æ˜¯ç³»ç»Ÿçº§è™šæ‹ŸåŒ–å¿…é¡»è¦æœ‰å†…æ ¸çš„æ”¯æŒï¼Œä¸ºæ­¤å®ƒä»¬å°±åªèƒ½é€šè¿‡éå®˜æ–¹å†…æ ¸è¡¥ä¸çš„æ–¹å¼ä¿®æ”¹æ ‡å‡†å†…æ ¸ï¼Œæ‰èƒ½è·å¾—é‚£äº›åŸæœ¬åœ¨å†…æ ¸ä¸­ä¸å­˜åœ¨çš„èƒ½åŠ›ã€‚\nLXC å¸¦ç€ä»¤äººç©ç›®çš„å…‰ç¯ç™»åœºï¼Œå®ƒçš„å‡ºç°ä¿ƒä½¿â€œå®¹å™¨â€ä»ä¸€ä¸ªé˜³æ˜¥ç™½é›ªçš„åªæµä¼ äºå¼€å‘äººå‘˜å£ä¸­çš„æŠ€æœ¯è¯æ±‡ï¼Œé€æ¸å‘æ•´ä¸ªè½¯ä»¶ä¸šçš„å…¬å…±æ¦‚å¿µã€å…±åŒè¯­è¨€å‘å±•ï¼Œå°±å¦‚åŒä»Šå¤©çš„â€œæœåŠ¡å™¨â€ã€â€œå®¢æˆ·ç«¯â€å’Œâ€œäº’è”ç½‘â€ä¸€æ ·ã€‚ç›¸ä¿¡ä½ ç°åœ¨è‚¯å®šä¼šå¥½å¥‡ä¸ºä»€ä¹ˆç°åœ¨ä¸€æåˆ°å®¹å™¨ï¼Œå¤§å®¶é¦–å…ˆè”æƒ³åˆ°çš„æ˜¯ Docker è€Œä¸æ˜¯ LXCï¼Ÿä¸ºä»€ä¹ˆå»é—® 10 ä¸ªå¼€å‘äººå‘˜ï¼Œè‡³å°‘æœ‰ 9 ä¸ªå¬è¿‡ Dockerï¼Œä½†å¦‚æœé—® LXCï¼Œå¯èƒ½åªæœ‰ 1 ä¸ªäººä¼šå¬è¯´è¿‡ï¼Ÿ\nLXC çš„å‡ºç°è‚¯å®šå—åˆ°äº† OpenVZ å’Œ Linux-VServer çš„å¯å‘ï¼Œæ‘¸ç€å·¨äººçš„è‚©è†€è¿‡æ²³è¿™å¹¶æ²¡æœ‰ä»€ä¹ˆä¸å¯¹ã€‚å¯æƒœçš„æ˜¯ï¼ŒLXC åœ¨è®¾å®šè‡ªå·±çš„å‘å±•ç›®æ ‡æ—¶ï¼Œä¹Ÿè¢«å‰è¾ˆä»¬çš„å½±å“æ‰€å±€é™ä½ã€‚LXC çœ¼ä¸­çš„å®¹å™¨çš„å®šä¹‰ä¸ OpenVZ å’Œ Linux-VServer å¹¶æ— å·®åˆ«ï¼Œæ˜¯ä¸€ç§å°è£…ç³»ç»Ÿçš„è½»é‡çº§è™šæ‹Ÿæœºï¼Œè€Œ Docker çœ¼ä¸­çš„å®¹å™¨çš„å®šä¹‰åˆ™æ˜¯ä¸€ç§å°è£…åº”ç”¨çš„æŠ€æœ¯æ‰‹æ®µã€‚è¿™ä¸¤ç§å°è£…ç†å¿µåœ¨æŠ€æœ¯å±‚é¢å¹¶æ²¡æœ‰ä»€ä¹ˆæœ¬è´¨åŒºåˆ«ï¼Œä½†åº”ç”¨æ•ˆæœå°±å·®å¼‚å·¨å¤§ã€‚ä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œå¦‚æœä½ è¦å»ºè®¾ä¸€ä¸ªLAMPï¼ˆLinuxã€Apacheã€MySQLã€PHPï¼‰åº”ç”¨ï¼ŒæŒ‰ç…§ LXC çš„æ€è·¯ï¼Œä½ åº”è¯¥å…ˆç¼–å†™æˆ–è€…å¯»æ‰¾åˆ°LAMP çš„ templateï¼ˆå¯ä»¥æš‚ä¸”ä¸å‡†ç¡®åœ°ç±»æ¯”ä¸º LXC ç‰ˆæœ¬çš„ Dockerfile å§ï¼‰ï¼Œä»¥æ­¤æ„é€ å‡ºä¸€ä¸ªå®‰è£…äº† LAMP çš„è™šæ‹Ÿç³»ç»Ÿã€‚å¦‚æœæŒ‰éƒ¨ç½²è™šæ‹Ÿæœºçš„è§’åº¦æ¥çœ‹ï¼Œè¿™è¿˜ç®—æŒºæ–¹ä¾¿çš„ï¼Œä½œä¸ºé‚£ä¸ªæ—¶ä»£ï¼ˆè·ä»Šä¹Ÿå°±åå¹´ï¼‰çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼Œæ‰€æœ‰è½¯ä»¶ã€è¡¥ä¸ã€é…ç½®éƒ½æ˜¯è‡ªå·±æå®šçš„ï¼Œéƒ¨ç½²ä¸€å°æ–°è™šæ‹Ÿæœºè¦èŠ±è´¹ä¸€ä¸¤å¤©æ—¶é—´éƒ½å¾ˆæ­£å¸¸ï¼Œæœ‰ LXC çš„ templateï¼Œä¸€ä¸‹å­å¸®ä½ æŠŠ LAMP éƒ½å®‰è£…å¥½äº†ï¼Œè¿˜æƒ³è¦å•¥è‡ªè¡Œè½¦ï¼Ÿä½†æ˜¯ï¼Œä½œä¸ºä¸€åç°ä»£çš„ç³»ç»Ÿç®¡ç†å‘˜ï¼Œè¿™é‡Œé—®é¢˜å°±ç›¸å½“å¤§ï¼Œå¦‚æœæˆ‘æƒ³æŠŠ LAMP æ”¹ä¸º LNMPï¼ˆLinuxã€Nginxã€MySQLã€PHPï¼‰è¯¥æ€ä¹ˆåŠï¼Ÿå¦‚æœæˆ‘æƒ³æŠŠ LAMP é‡Œçš„ MySQL 5 è°ƒæ•´ä¸º MySQL 8 è¯¥æ€ä¹ˆåŠï¼Ÿéƒ½å¾—æ‰¾åˆ°æˆ–è€…è‡ªå·±ç¼–å†™æ–°çš„ template æ¥è§£å†³ã€‚å¥½å§ï¼Œé‚£è¿™å°æœºçš„è½¯ä»¶ã€ç‰ˆæœ¬éƒ½é…ç½®å¯¹äº†ï¼Œä¸‹ä¸€å°æœºæˆ‘è¦æ„å»ºLYMEæˆ–è€…MEANï¼Œåˆè¯¥æ€ä¹ˆåŠï¼Ÿä»¥å°è£…ç³»ç»Ÿä¸ºå‡ºå‘ç‚¹ï¼Œä»æ˜¯æŒ‰ç…§å…ˆè£…ç³»ç»Ÿç„¶å†è£…è½¯ä»¶çš„æ€è·¯ï¼Œå°±æ°¸è¿œæ— æ³•åšåˆ°ä¸€ä¸¤åˆ†é’Ÿç”šè‡³åå‡ ç§’é’Ÿå°±æ„é€ å‡ºä¸€ä¸ªåˆä¹è¦æ±‚çš„è½¯ä»¶è¿è¡Œç¯å¢ƒï¼Œä¹Ÿå†³å®šäº† LXC ä¸å¯èƒ½å½¢æˆä»Šå¤©çš„å®¹å™¨ç”Ÿæ€çš„ï¼Œæ‰€ä»¥ï¼Œæ¥ä¸‹æ¥èˆå°çš„èšå…‰ç¯ç»ˆäºè½åˆ°äº† Docker èº«ä¸Šã€‚\nå°è£…åº”ç”¨ï¼šDocker2013 å¹´å®£å¸ƒå¼€æºçš„ Docker æ¯«æ— ç–‘é—®æ˜¯å®¹å™¨å‘å±•å†å²ä¸Šé‡Œç¨‹ç¢‘å¼çš„å‘æ˜ï¼Œç„¶è€Œ Docker çš„æˆåŠŸä¼¼ä¹æ²¡æœ‰å¤ªå¤šæŠ€æœ¯é©±åŠ¨çš„æˆåˆ†ã€‚è‡³å°‘å¯¹å¼€æºæ—©æœŸçš„ Docker è€Œè¨€ï¼Œç¡®å®æ²¡æœ‰ä»€ä¹ˆèƒ½æ„æˆå£å’çš„æŠ€æœ¯ã€‚å®ƒçš„å®¹å™¨åŒ–èƒ½åŠ›ç›´æ¥æ¥æºäº LXCï¼Œå®ƒé•œåƒåˆ†å±‚ç»„åˆçš„æ–‡ä»¶ç³»ç»Ÿç›´æ¥æ¥æºäºAUFSï¼ŒDocker å¼€æºåä¸ä¹…ï¼Œå°±æœ‰äººä»…ç”¨äº†ä¸€ç™¾å¤šè¡Œ Shell è„šæœ¬ä¾¿å®ç°äº† Docker çš„æ ¸å¿ƒåŠŸèƒ½ï¼ˆåä¸ºBockerï¼Œæä¾›äº†docker build/pull/images/ps/run/exec/logs/commit/rm/rmiç­‰åŠŸèƒ½ï¼‰ã€‚\né‚£ä¸ºä½•å†å²é€‰æ‹©äº† Dockerï¼Œè€Œä¸æ˜¯ LXC æˆ–è€…å…¶ä»–å®¹å™¨æŠ€æœ¯å‘¢ï¼Ÿå¯¹äºè¿™ä¸ªé—®é¢˜ï¼Œç¬”è€…å¼•ç”¨ï¼ˆè½¬è¿°éç›´è¯‘ï¼Œæœ‰æ‰€ç²¾ç®€ï¼‰DotCloud å…¬å¸ï¼ˆå½“å¹´åˆ›é€  Docker çš„å…¬å¸ï¼Œå·²äº 2016 å¹´å€’é—­ï¼‰åˆ›å§‹äºº Solomon Hykes åœ¨Stackoverflow ä¸Šçš„ä¸€æ®µé—®ç­”ï¼š\nä¸ºä»€ä¹ˆè¦ç”¨ Docker è€Œä¸æ˜¯ LXCï¼Ÿï¼ˆWhy would I use Docker over plain LXCï¼Ÿï¼‰\nDocker é™¤äº†åŒ…è£…æ¥è‡ª Linux å†…æ ¸çš„ç‰¹æ€§ä¹‹å¤–ï¼Œå®ƒçš„ä»·å€¼è¿˜åœ¨äºï¼š\n\nè·¨æœºå™¨çš„ç»¿è‰²éƒ¨ç½²ï¼šDocker å®šä¹‰äº†ä¸€ç§å°†åº”ç”¨åŠå…¶æ‰€æœ‰çš„ç¯å¢ƒä¾èµ–éƒ½æ‰“åŒ…åˆ°ä¸€èµ·çš„æ ¼å¼ï¼Œä»¿ä½›å®ƒåŸæœ¬å°±æ˜¯ç»¿è‰²è½¯ä»¶ä¸€æ ·ã€‚LXC å¹¶æ²¡æœ‰æä¾›è¿™æ ·çš„èƒ½åŠ›ï¼Œä½¿ç”¨ LXC éƒ¨ç½²çš„æ–°æœºå™¨å¾ˆå¤šç»†èŠ‚éƒ½ä¾èµ–äººçš„ä»‹å…¥ï¼Œè™šæ‹Ÿæœºçš„ç¯å¢ƒå‡ ä¹è‚¯å®šä¼šè·Ÿä½ åŸæœ¬éƒ¨ç½²ç¨‹åºçš„æœºå™¨æœ‰æ‰€å·®åˆ«ã€‚\nä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„å°è£…ï¼šDocker å°è£…åº”ç”¨è€Œéå°è£…æœºå™¨çš„ç†å¿µè´¯ç©¿äº†å®ƒçš„è®¾è®¡ã€APIã€ç•Œé¢ã€æ–‡æ¡£ç­‰å¤šä¸ªæ–¹é¢ã€‚ç›¸æ¯”ä¹‹ä¸‹ï¼ŒLXC å°†å®¹å™¨è§†ä¸ºå¯¹ç³»ç»Ÿçš„å°è£…ï¼Œè¿™å±€é™äº†å®¹å™¨çš„å‘å±•ã€‚\nè‡ªåŠ¨æ„å»ºï¼šDocker æä¾›äº†å¼€å‘äººå‘˜ä»åœ¨å®¹å™¨ä¸­æ„å»ºäº§å“çš„å…¨éƒ¨æ”¯æŒï¼Œå¼€å‘äººå‘˜æ— éœ€å…³æ³¨ç›®æ ‡æœºå™¨çš„å…·ä½“é…ç½®ï¼Œå³å¯ä½¿ç”¨ä»»æ„çš„æ„å»ºå·¥å…·é“¾ï¼Œåœ¨å®¹å™¨ä¸­è‡ªåŠ¨æ„å»ºå‡ºæœ€ç»ˆäº§å“ã€‚\nå¤šç‰ˆæœ¬æ”¯æŒï¼šDocker æ”¯æŒåƒ Git ä¸€æ ·ç®¡ç†å®¹å™¨çš„è¿ç»­ç‰ˆæœ¬ï¼Œè¿›è¡Œæ£€æŸ¥ç‰ˆæœ¬é—´å·®å¼‚ã€æäº¤æˆ–è€…å›æ»šç­‰æ“ä½œã€‚ä»å†å²è®°å½•ä¸­ä½ å¯ä»¥æŸ¥çœ‹åˆ°è¯¥å®¹å™¨æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥æ„å»ºæˆçš„ï¼Œå¹¶ä¸”åªå¢é‡ä¸Šä¼ æˆ–ä¸‹è½½æ–°ç‰ˆæœ¬ä¸­å˜æ›´çš„éƒ¨åˆ†ã€‚\nç»„ä»¶é‡ç”¨ï¼šDocker å…è®¸å°†ä»»ä½•ç°æœ‰å®¹å™¨ä½œä¸ºåŸºç¡€é•œåƒæ¥ä½¿ç”¨ï¼Œä»¥æ­¤æ„å»ºå‡ºæ›´åŠ ä¸“ä¸šçš„é•œåƒã€‚\nå…±äº«ï¼šDocker æ‹¥æœ‰å…¬å…±çš„é•œåƒä»“åº“ï¼Œæˆåƒä¸Šä¸‡çš„ Docker ç”¨æˆ·åœ¨ä¸Šé¢ä¸Šä¼ äº†è‡ªå·±çš„é•œåƒï¼ŒåŒæ—¶ä¹Ÿä½¿ç”¨ä»–äººä¸Šä¼ çš„é•œåƒã€‚\nå·¥å…·ç”Ÿæ€ï¼šDocker å¼€æ”¾äº†ä¸€å¥—å¯è‡ªåŠ¨åŒ–å’Œè‡ªè¡Œæ‰©å±•çš„æ¥å£ï¼Œåœ¨æ­¤ä¹‹ä¸Šï¼Œè¿˜æœ‰å¾ˆå¤šå·¥å…·æ¥æ‰©å±•å…¶åŠŸèƒ½ï¼Œè­¬å¦‚å®¹å™¨ç¼–æ’ã€ç®¡ç†ç•Œé¢ã€æŒç»­é›†æˆç­‰ç­‰ã€‚\n\nâ€”â€” Solomon Hykesï¼ŒStackoverflowï¼Œ2013\nä»¥ä¸Šè¿™æ®µå›ç­”ä¹ŸåŒæ—¶è¢«æ”¶å½•åˆ°äº†Docker å®˜ç½‘çš„ FAQä¸Šï¼Œä» Docker å¼€æºè‡³ä»Šä»æœªæ”¹å˜ã€‚ä¿ƒä½¿ Docker çš„ä¸€é—®ä¸–å°±æƒŠè‰³ä¸–é—´çš„ï¼Œä¸æ˜¯ä»€ä¹ˆé»‘ç§‘æŠ€å¼çš„ç§˜å¯†æ­¦å™¨ï¼Œè€Œæ˜¯å…¶ç¬¦åˆå†å²æ½®æµçš„åˆ›æ„ä¸è®¾è®¡ç†å¿µï¼Œè¿˜æœ‰å……åˆ†å¼€æ”¾çš„ç”Ÿæ€è¿è¥ã€‚å¯è§ï¼Œåœ¨æ­£ç¡®çš„æ—¶å€™ï¼Œæ­£ç¡®çš„äººæ‰‹ä¸Šæœ‰ä¸€ä¸ªä¼˜ç§€çš„ç‚¹å­ï¼Œç¡®å®æœ‰æœºä¼šå¼•çˆ†ä¸€ä¸ªæ—¶ä»£ã€‚\nä»¥ä¸Šæ˜¯ Docker å¼€æºä¸€å¹´åï¼ˆæˆªè‡³ 2014 å¹´ 12 æœˆï¼‰è·å¾—çš„æˆç»©ï¼Œå›¾ç‰‡æ¥è‡ªDocker å®˜ç½‘\nä»å¼€æºåˆ°ç°åœ¨ä¹Ÿåªè¿‡äº†çŸ­çŸ­æ•°å¹´æ—¶é—´ï¼ŒDocker å·²æˆä¸ºè½¯ä»¶å¼€å‘ã€æµ‹è¯•ã€åˆ†å‘ã€éƒ¨ç½²ç­‰å„ä¸ªç¯èŠ‚éƒ½éš¾ä»¥æˆ–ç¼ºçš„åŸºç¡€æ”¯æ’‘ï¼Œè‡ªèº«çš„æ¶æ„ä¹Ÿå‘ç”Ÿäº†ç›¸å½“å¤§çš„æ”¹å˜ï¼ŒDocker è¢«åˆ†è§£ä¸ºç”± Docker Clientã€Docker Daemonã€Docker Registryã€Docker Container ç­‰å­ç³»ç»Ÿï¼Œä»¥åŠ Graphã€Driverã€libcontainer ç­‰å„å¸å…¶èŒçš„æ¨¡å—ç»„æˆï¼Œæ­¤æ—¶å†è¯´ä¸€ç™¾å¤šè¡Œè„šæœ¬èƒ½å®ç° Docker æ ¸å¿ƒåŠŸèƒ½ï¼Œå†è¯´ Docker æ²¡æœ‰å¤ªé«˜çš„æŠ€æœ¯å«é‡ï¼Œå°±å·²ç»ä¸å†åˆé€‚äº†ã€‚\n2014 å¹´ï¼ŒDocker å¼€æºäº†è‡ªå·±ç”¨ Golang å¼€å‘çš„libcontainerï¼Œè¿™æ˜¯ä¸€ä¸ªè¶Šè¿‡ LXC ç›´æ¥æ“ä½œnamespaceså’Œcgroupsçš„æ ¸å¿ƒæ¨¡å—ï¼Œæœ‰äº† libcontainer ä»¥åï¼ŒDocker å°±èƒ½ç›´æ¥ä¸ç³»ç»Ÿå†…æ ¸æ‰“äº¤é“ï¼Œä¸å¿…ä¾èµ– LXC æ¥æä¾›å®¹å™¨åŒ–éš”ç¦»èƒ½åŠ›äº†ã€‚\n2015 å¹´ï¼Œåœ¨ Docker çš„ä¸»å¯¼å’Œå€¡è®®ä¸‹ï¼Œå¤šå®¶å…¬å¸è”åˆåˆ¶å®šäº†â€œå¼€æ”¾å®¹å™¨äº¤äº’æ ‡å‡†â€ï¼ˆOpen Container Initiativeï¼ŒOCIï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå…³äºå®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶çš„è§„èŒƒæ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«è¿è¡Œæ—¶æ ‡å‡†ï¼ˆruntime-spec ï¼‰ã€å®¹å™¨é•œåƒæ ‡å‡†ï¼ˆimage-specï¼‰å’Œé•œåƒåˆ†å‘æ ‡å‡†ï¼ˆdistribution-specï¼Œåˆ†å‘æ ‡å‡†è¿˜æœªæ­£å¼å‘å¸ƒï¼‰ã€‚è¿è¡Œæ—¶æ ‡å‡†å®šä¹‰äº†åº”è¯¥å¦‚ä½•è¿è¡Œä¸€ä¸ªå®¹å™¨ã€å¦‚ä½•ç®¡ç†å®¹å™¨çš„çŠ¶æ€å’Œç”Ÿå‘½å‘¨æœŸã€å¦‚ä½•ä½¿ç”¨æ“ä½œç³»ç»Ÿçš„åº•å±‚ç‰¹æ€§ï¼ˆnamespacesã€cgroupã€pivot_rootç­‰ï¼‰ï¼›å®¹å™¨é•œåƒæ ‡å‡†è§„å®šäº†å®¹å™¨é•œåƒçš„æ ¼å¼ã€é…ç½®ã€å…ƒæ•°æ®çš„æ ¼å¼ï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹é•œåƒçš„é™æ€æè¿°ï¼›é•œåƒåˆ†å‘æ ‡å‡†åˆ™è§„å®šäº†é•œåƒæ¨é€å’Œæ‹‰å–çš„ç½‘ç»œäº¤äº’è¿‡ç¨‹ã€‚\nä¸ºäº†ç¬¦åˆ OCI æ ‡å‡†ï¼ŒDocker æ¨åŠ¨è‡ªèº«çš„æ¶æ„ç»§ç»­å‘å‰æ¼”è¿›ï¼Œé¦–å…ˆå°† libcontainer ç‹¬ç«‹å‡ºæ¥ï¼Œå°è£…é‡æ„æˆrunC é¡¹ç›®ï¼Œå¹¶æçŒ®ç»™äº† Linux åŸºé‡‘ä¼šç®¡ç†ã€‚runC æ˜¯ OCI Runtime çš„é¦–ä¸ªå‚è€ƒå®ç°ï¼Œæå‡ºäº†â€œè®©æ ‡å‡†å®¹å™¨æ— æ‰€ä¸åœ¨â€ï¼ˆMake Standard Containers Available Everywhereï¼‰çš„å£å·ã€‚ä¸ºäº†èƒ½å¤Ÿå…¼å®¹æ‰€æœ‰ç¬¦åˆæ ‡å‡†çš„ OCI Runtime å®ç°ï¼ŒDocker è¿›ä¸€æ­¥é‡æ„äº† Docker Daemon å­ç³»ç»Ÿï¼Œå°†å…¶ä¸­ä¸è¿è¡Œæ—¶äº¤äº’çš„éƒ¨åˆ†æŠ½è±¡ä¸ºcontainerd é¡¹ç›®ï¼Œè¿™æ˜¯ä¸€ä¸ªè´Ÿè´£ç®¡ç†å®¹å™¨æ‰§è¡Œã€åˆ†å‘ã€ç›‘æ§ã€ç½‘ç»œã€æ„å»ºã€æ—¥å¿—ç­‰åŠŸèƒ½çš„æ ¸å¿ƒæ¨¡å—ï¼Œå†…éƒ¨ä¼šä¸ºæ¯ä¸ªå®¹å™¨è¿è¡Œæ—¶åˆ›å»ºä¸€ä¸ª containerd-shim é€‚é…è¿›ç¨‹ï¼Œé»˜è®¤ä¸ runC æ­é…å·¥ä½œï¼Œä½†ä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°å…¶ä»– OCI Runtime å®ç°ä¸Šï¼ˆç„¶è€Œå®é™…å¹¶æ²¡åšåˆ°ï¼Œæœ€å containerd ä»æ˜¯ç´§å¯†ç»‘å®šäº runCï¼‰ã€‚2016 å¹´ï¼ŒDocker æŠŠ containerd æçŒ®ç»™äº† CNCF ç®¡ç†ï¼ŒrunC ä¸ containerd ä¸¤ä¸ªé¡¹ç›®çš„æèµ æ‰˜ç®¡ï¼Œå³å¸¦æœ‰ Docker å¯¹å¼€æºä¿¡å¿µçš„è¿½æ±‚ï¼Œä¹Ÿå¸¦æœ‰ Docker åœ¨ä¼—å¤šäº‘è®¡ç®—å¤§å‚å¤¹å‡»ä¸‹è‡ªæ•‘çš„æ— å¥ˆï¼Œè¿™ä¸¤ä¸ªé¡¹ç›®å°†æˆä¸ºæœªæ¥ Docker æ¶ˆäº¡å’Œå­˜ç»­çš„ä¼ç¬”ï¼ˆçœ‹åˆ°æœ¬èŠ‚æœ«å°¾ä½ å°±èƒ½ç†è§£è¿™å¥çŸ›ç›¾çš„è¯äº†ï¼‰ã€‚\n\nä»¥ä¸Šç¬”è€…åˆ—ä¸¾çš„è¿™äº› Docker æ¨åŠ¨çš„å¼€æºä¸æ ‡å‡†åŒ–å·¥ä½œï¼Œæ—¢æ˜¯å¯¹ Docker ä¸ºå¼€æºä¹ƒè‡³æ•´ä¸ªè½¯ä»¶ä¸šåšå‡ºè´¡çŒ®çš„èµèµï¼Œä¹Ÿæ˜¯ä¸ºåé¢ä»‹ç»å®¹å™¨ç¼–æ’æ—¶ï¼Œè®²è¿°å½“å‰å®¹å™¨å¼•æ“çš„æ··ä¹±å…³ç³»åšçš„å‰ç½®é“ºå«ã€‚Docker ç›®å‰æ— ç–‘åœ¨å®¹å™¨é¢†åŸŸå…·æœ‰ç»Ÿæ²»åœ°ä½ï¼Œä½†ç»Ÿæ²»çš„ç¨³å›ºç¨‹åº¦ä¸ä»…æ²¡åˆ°é«˜æ•æ— å¿§ï¼Œè¯´æ˜¯å±æœºå››ä¼éƒ½ä¸ä¸ºè¿‡ã€‚ç›®å‰å·²ç»æœ‰äº†å¯è§çš„ã€è¶³ä»¥å¨èƒåŠ¨æ‘‡ Docker åœ°ä½çš„æ½œåœ¨å¯èƒ½æ€§æ­£åœ¨é…é…¿ï¼Œé£é™©æºäºè™½ç„¶ Docker èµ¢å¾—äº†å®¹å™¨æˆ˜äº‰ï¼Œä½† Docker Swarm å´è¾“æ‰äº†å®¹å™¨ç¼–æ’æˆ˜äº‰ã€‚ä»ç»“æœå›æœ›å½“åˆï¼ŒDocker èµ¢å¾—å®¹å™¨æˆ˜äº‰æœ‰ä¸€äº›å¶ç„¶ï¼ŒDocker Swarm è¾“æ‰çš„ç¼–æ’æˆ˜äº‰å´æ˜¯å¿…ç„¶çš„ã€‚\nå°è£…é›†ç¾¤ï¼šKuberneteså¦‚æœè¯´ä»¥ Docker ä¸ºä»£è¡¨çš„å®¹å™¨å¼•æ“å°†è½¯ä»¶çš„å‘å¸ƒæµç¨‹ä»åˆ†å‘äºŒè¿›åˆ¶å®‰è£…åŒ…è½¬å˜ä¸ºç›´æ¥åˆ†å‘è™šæ‹ŸåŒ–åçš„æ•´ä¸ªè¿è¡Œç¯å¢ƒï¼Œä»¤åº”ç”¨å¾—ä»¥å®ç°è·¨æœºå™¨çš„ç»¿è‰²éƒ¨ç½²ï¼›é‚£ä»¥ Kubernetes ä¸ºä»£è¡¨çš„å®¹å™¨ç¼–æ’æ¡†æ¶ï¼Œå°±æ˜¯æŠŠå¤§å‹è½¯ä»¶ç³»ç»Ÿè¿è¡Œæ‰€ä¾èµ–çš„é›†ç¾¤ç¯å¢ƒä¹Ÿè¿›è¡Œäº†è™šæ‹ŸåŒ–ï¼Œä»¤é›†ç¾¤å¾—ä»¥å®ç°è·¨æ•°æ®ä¸­å¿ƒçš„ç»¿è‰²éƒ¨ç½²ï¼Œå¹¶èƒ½å¤Ÿæ ¹æ®å®é™…æƒ…å†µè‡ªåŠ¨æ‰©ç¼©ã€‚\nå®¹å™¨çš„å´›èµ·ä¹‹è·¯è®²åˆ° Docker å’Œ Kubernetes è¿™é˜¶æ®µï¼Œå·²ç»ä¸å†æ˜¯ä»‹ç»å†å²äº†ï¼Œä»è¿™é‡Œå¼€å§‹å‘ç”Ÿçš„å˜åŒ–ï¼Œéƒ½æ˜¯è¿‘å‡ å¹´è½¯ä»¶ä¸šç•Œä¸­çš„çƒ­ç‚¹äº‹ä»¶ï¼Œä¹Ÿæ˜¯è¿™ç« è¦è®¨è®ºçš„ä¸»è¦è¯é¢˜ã€‚ç°åœ¨ç¬”è€…æš‚æ—¶ä¸æ‰“ç®—ä»‹ç» Kubernetes çš„æŠ€æœ¯ç»†èŠ‚ï¼Œå®ƒä»¬å°†ä¼šè¢«ç•™åˆ°åé¢çš„æ–‡ç« ä¸­æ›´è¯¦ç»†çš„è§£æã€‚è¿™èŠ‚é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆä»å®è§‚å±‚é¢å»ç†è§£ Kubernetes çš„è¯ç”Ÿä¸æ¼”å˜çš„é©±åŠ¨åŠ›ï¼Œè¿™å¯¹æ­£ç¡®ç†è§£æœªæ¥äº‘åŸç”Ÿçš„å‘å±•æ–¹å‘è‡³å…³é‡è¦ã€‚\nKubernetes å¯è°“å‡ºèº«åé—¨ï¼Œå‰èº«æ˜¯ Google å†…éƒ¨å·²è¿è¡Œå¤šå¹´çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿ Borgï¼Œ2014 å¹´ 6 æœˆä½¿ç”¨ Golang å®Œå…¨é‡å†™åå¼€æºã€‚è‡ªè¯ç”Ÿä¹‹æ—¥èµ·ï¼Œåªè¦ä¸äº‘è®¡ç®—èƒ½ç¨å¾®æ‰¯ä¸Šå…³ç³»çš„ä¸šç•Œå·¨å¤´éƒ½å¯¹ Kubernetes äº‰ç›¸è¿½æ§ï¼ŒIBMã€RedHatã€Microsoftã€VMware å’Œåä¸ºéƒ½æ˜¯å®ƒæœ€æ—©æœŸçš„ä»£ç è´¡çŒ®è€…ã€‚æ­¤æ—¶ï¼Œäº‘è®¡ç®—ä»å®éªŒå®¤åˆ°å·¥ä¸šåŒ–åº”ç”¨å·²ç»æœ‰åä¸ªå¹´å¤´ï¼Œç„¶è€Œå¤§é‡åº”ç”¨ä½¿ç”¨äº‘è®¡ç®—çš„æ–¹å¼ä»åœæ»åœ¨ä¼ ç»Ÿ IDCï¼ˆInternet Data Centerï¼‰æ—¶ä»£ï¼Œä»…ä»…æ˜¯ç”¨äº‘ç«¯çš„è™šæ‹Ÿæœºä»£æ›¿äº†ä¼ ç»Ÿçš„ç‰©ç†æœºã€‚å°½ç®¡æ—©åœ¨ 2013 å¹´ï¼ŒPivotalï¼ˆæŒæœ‰ç€ Spring Framework å’Œ Cloud Foundry çš„å…¬å¸ï¼‰å°±æå‡ºäº†â€œäº‘åŸç”Ÿâ€çš„æ¦‚å¿µï¼Œä½†æ˜¯è¦å®ç°æœåŠ¡åŒ–ã€å…·å¤‡éŸ§æ€§ï¼ˆResilienceï¼‰ã€å¼¹æ€§ï¼ˆElasticityï¼‰ã€å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰çš„è½¯ä»¶ç³»ç»Ÿååˆ†å›°éš¾ï¼Œåœ¨å½“æ—¶åŸºæœ¬åªèƒ½ä¾é æ¶æ„å¸ˆå’Œç¨‹åºå‘˜é«˜è¶…çš„ä¸ªäººèƒ½åŠ›ï¼Œäº‘è®¡ç®—æœ¬èº«å¸®ä¸ä¸Šä»€ä¹ˆå¿™ã€‚åœ¨äº‘çš„æ—¶ä»£ä¸èƒ½å……åˆ†åˆ©ç”¨äº‘çš„å¼ºå¤§èƒ½åŠ›ï¼Œè¿™è®©äº‘è®¡ç®—å‚å•†æ— æ¯”é—æ†¾ï¼Œä¹Ÿæ— æ¯”ç„¦è™‘ã€‚ç›´åˆ° Kubernetes æ¨ªç©ºå‡ºä¸–ï¼Œå¤§å®¶ç»ˆäºç­‰åˆ°äº†ç ´å±€çš„å¸Œæœ›ï¼Œè®¤å‡†äº†è¿™å°±æ˜¯äº‘åŸç”Ÿæ—¶ä»£çš„æ“ä½œç³»ç»Ÿï¼Œæ˜¯è®©å¤æ‚è½¯ä»¶åœ¨äº‘è®¡ç®—ä¸‹è·å¾—éŸ§æ€§ã€å¼¹æ€§ã€å¯è§‚æµ‹æ€§çš„æœ€ä½³è·¯å¾„ï¼Œä¹Ÿæ˜¯ä¸ºå‚å•†ä»¬æ¨åŠ¨äº‘è®¡ç®—æ—¶ä»£åŠ é€Ÿåˆ°æ¥çš„å…³é”®å¼•æ“ä¹‹ä¸€ã€‚\n2015 å¹´ 7 æœˆï¼ŒKubernetes å‘å¸ƒäº†ç¬¬ä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ 1.0 ç‰ˆï¼Œæ›´é‡è¦çš„äº‹ä»¶æ˜¯ Google å®£å¸ƒä¸ Linux åŸºé‡‘ä¼šå…±åŒç­¹å»ºäº‘åŸç”ŸåŸºé‡‘ä¼šï¼ˆCloud Native Computing Foundationï¼ŒCNCFï¼‰ï¼Œå¹¶ä¸”å°† Kubernetes æ‰˜ç®¡åˆ° CNCFï¼Œæˆä¸ºå…¶ç¬¬ä¸€ä¸ªé¡¹ç›®ã€‚éšåï¼ŒKubernetes ä»¥æ‘§æ¯æ‹‰æœ½ä¹‹åŠ¿è¦†ç­äº†å®¹å™¨ç¼–æ’é¢†åŸŸçš„å…¶ä»–ç«äº‰å¯¹æ‰‹ï¼Œå“ªæ€• Docker Swarm æœ‰ç€ Docker åœ¨å®¹å™¨å¼•æ“æ–¹é¢çš„å…ˆå¤©ä¼˜åŠ¿ï¼ŒDotCloud åæ¥ç”šè‡³å°† Swarm ç›´æ¥å†…ç½®å…¥ Docker ä¹‹ä¸­éƒ½æœªèƒ½ç¨ç¨é˜»æŒ¡ Kubernetes çš„å‰è¿›çš„æ­¥ä¼ã€‚\nKubernetes çš„æˆåŠŸä¸ Docker çš„æˆåŠŸå¹¶ä¸ç›¸åŒï¼ŒDocker é çš„æ˜¯ä¼˜ç§€çš„ç†å¿µï¼Œä»¥ä¸€ä¸ªâ€œå¥½ç‚¹å­â€å¼•çˆ†äº†ä¸€ä¸ªæ—¶ä»£ã€‚ç¬”è€…ç›¸ä¿¡å°±ç®—æ²¡æœ‰ Docker ä¹Ÿä¼šæœ‰ Cocker æˆ–è€… Eocker çš„å‡ºç°ï¼Œä½†ç”±æˆç«‹ä»…ä¸‰å¹´çš„ DotCloud å…¬å¸ï¼ˆä¸‰å¹´ååˆå€’é—­ï¼‰åšæˆäº†è¿™æ ·çš„äº§å“ç¡®å®æœ‰ä¸€å®šçš„å¶ç„¶æ€§ã€‚è€Œ Kubernetes çš„æˆåŠŸä¸ä»…æœ‰ Google æ·±åšçš„æŠ€æœ¯åŠŸåº•ä½œæ”¯æ’‘ï¼Œæœ‰é¢†å…ˆæ—¶ä»£çš„è®¾è®¡ç†å¿µï¼Œæ›´åŠ å…³é”®çš„æ˜¯ Kubernetes çš„å‡ºç°ç¬¦åˆæ‰€æœ‰äº‘è®¡ç®—å¤§å‚çš„åˆ‡èº«åˆ©ç›Šï¼Œæœ‰ç€ä¸šç•Œå·¨å¤´ä¸é—ä½™åŠ›çš„å¹¿æ³›æ”¯æŒï¼Œå®ƒçš„æˆåŠŸä¾¿æ˜¯ä¸€ç§å¿…ç„¶ã€‚\n\nKubernetes ä¸ Docker ä¸¤è€…çš„å…³ç³»ååˆ†å¾®å¦™ï¼ŒæŠŠæ¡ä½ä¸¤è€…å…³ç³»çš„å˜åŒ–è¿‡ç¨‹ï¼Œæ˜¯ç†è§£ Kubernetes æ¶æ„æ¼”å˜ä¸ CRIã€OCI è§„èŒƒçš„è‰¯å¥½çº¿ç´¢ã€‚åœ¨ Kubernetes å¼€æºçš„æ—©æœŸï¼Œå®ƒæ˜¯å®Œå…¨ä¾èµ–ä¸”ç»‘å®š Docker çš„ï¼Œå¹¶æ²¡æœ‰è¿‡å¤šè€ƒè™‘å¤Ÿæ—¥åæœ‰ä½¿ç”¨å…¶ä»–å®¹å™¨å¼•æ“çš„å¯èƒ½æ€§ã€‚ç›´è‡³ Kubernetes 1.5 ä¹‹å‰ï¼ŒKubernetes ç®¡ç†å®¹å™¨çš„æ–¹å¼éƒ½æ˜¯é€šè¿‡å†…éƒ¨çš„ DockerManager å‘ Docker Engine ä»¥ HTTP æ–¹å¼å‘é€æŒ‡ä»¤ï¼Œé€šè¿‡ Docker æ¥æ“ä½œé•œåƒçš„å¢åˆ æ”¹æŸ¥çš„ï¼Œå¦‚ä¸Šå›¾æœ€å³è¾¹çº¿è·¯çš„ç®­å¤´æ‰€ç¤ºï¼ˆå›¾ä¸­çš„ kubelet æ˜¯é›†ç¾¤èŠ‚ç‚¹ä¸­çš„ä»£ç†ç¨‹åºï¼Œè´Ÿè´£ä¸ç®¡ç†é›†ç¾¤çš„ Master é€šä¿¡ï¼Œå…¶ä»–èŠ‚ç‚¹çš„å«ä¹‰åœ¨åæ–‡ä»‹ç»åˆ°æ—¶éƒ½ä¼šæœ‰è§£é‡Šï¼‰ã€‚å°†è¿™ä¸ªé˜¶æ®µ Kubernetes ä¸å®¹å™¨å¼•æ“çš„è°ƒç”¨å…³ç³»æ‹ç›´ï¼Œå¹¶ç»“åˆä¸Šä¸€èŠ‚æåˆ°çš„ Docker æçŒ® containerd ä¸ runC åé‡æ„çš„è°ƒç”¨ï¼Œå®Œæ•´çš„è°ƒç”¨é“¾æ¡å¦‚ä¸‹æ‰€ç¤ºï¼š\n\nKubernetes Master â†’ kubelet â†’ DockerManager â†’ Docker Engine â†’ containerd â†’ runC\n\n2016 å¹´ï¼ŒKubernetes 1.5 ç‰ˆæœ¬å¼€å§‹å¼•å…¥â€œå®¹å™¨è¿è¡Œæ—¶æ¥å£â€ï¼ˆContainer Runtime Interfaceï¼ŒCRIï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªå®šä¹‰å®¹å™¨è¿è¡Œæ—¶åº”è¯¥å¦‚ä½•æ¥å…¥åˆ° kubelet çš„è§„èŒƒæ ‡å‡†ï¼Œä»æ­¤ Kubernetes å†…éƒ¨çš„ DockerManager å°±è¢«æ›´ä¸ºé€šç”¨çš„ KubeGenericRuntimeManager æ‰€æ›¿ä»£ï¼ˆå®é™…ä¸Šåœ¨ 1.6.6 ä¹‹å‰éƒ½ä»ç„¶å¯ä»¥çœ‹åˆ° DockerManagerï¼‰ï¼Œkubelet ä¸ KubeGenericRuntimeManager ä¹‹é—´é€šè¿‡ gRPC åè®®é€šä¿¡ã€‚ç”±äº CRI æ˜¯åœ¨ Docker ä¹‹åæ‰å‘å¸ƒçš„è§„èŒƒï¼ŒDocker æ˜¯è‚¯å®šä¸æ”¯æŒ CRI çš„ï¼Œæ‰€ä»¥ Kubernetes åˆæä¾›äº† DockerShim æœåŠ¡ä½œä¸º Docker ä¸ CRI çš„é€‚é…å±‚ï¼Œç”±å®ƒä¸ Docker Engine ä»¥ HTTP å½¢å¼é€šä¿¡ï¼Œå®ç°äº†åŸæ¥ DockerManager çš„å…¨éƒ¨åŠŸèƒ½ã€‚æ­¤æ—¶ï¼ŒDocker å¯¹ Kubernetes æ¥è¯´åªæ˜¯ä¸€é¡¹é»˜è®¤ä¾èµ–ï¼Œè€Œéä¹‹å‰çš„æ— å¯æˆ–ç¼ºäº†ï¼Œå®ƒä»¬çš„è°ƒç”¨é“¾ä¸ºï¼š\n\nKubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ DockerShim â†’ Docker Engine â†’ containerd â†’ runC\n\n2017 å¹´ï¼Œç”± Googleã€RedHatã€Intelã€SUSEã€IBM è”åˆå‘èµ·çš„CRI-Oï¼ˆContainer Runtime Interface Orchestratorï¼‰é¡¹ç›®å‘å¸ƒäº†é¦–ä¸ªæ­£å¼ç‰ˆæœ¬ã€‚ä»åå­—å°±å¯ä»¥çœ‹å‡ºï¼Œå®ƒè‚¯å®šæ˜¯å®Œå…¨éµå¾ª CRI è§„èŒƒè¿›è¡Œå®ç°çš„ï¼Œå¦ä¸€æ–¹é¢ï¼Œå®ƒå¯ä»¥æ”¯æŒæ‰€æœ‰ç¬¦åˆ OCI è¿è¡Œæ—¶æ ‡å‡†çš„å®¹å™¨å¼•æ“ï¼Œé»˜è®¤ä»ç„¶æ˜¯ä¸ runC æ­é…å·¥ä½œçš„ï¼Œè‹¥è¦æ¢æˆClear Containersã€Kata Containersç­‰å…¶ä»– OCI è¿è¡Œæ—¶ä¹Ÿå®Œå…¨æ²¡æœ‰é—®é¢˜ã€‚è™½ç„¶å¼€æºç‰ˆ Kubernetes æ˜¯ä½¿ç”¨ CRI-Oã€cri-containerd æŠ‘æˆ–æ˜¯ DockerShim ä½œä¸º CRI å®ç°ï¼Œå®Œå…¨å¯ä»¥ç”±ç”¨æˆ·è‡ªç”±é€‰æ‹©ï¼ˆæ ¹æ®ç”¨æˆ·å®¿ä¸»æœºçš„ç¯å¢ƒé€‰æ‹©ï¼‰ï¼Œä½†åœ¨ RedHat è‡ªå·±æ‰©å±•å®šåˆ¶çš„ Kubernetes ä¼ä¸šç‰ˆï¼Œå³OpenShift 4ä¸­ï¼Œè°ƒç”¨é“¾å·²ç»æ²¡æœ‰äº† Docker Engine çš„èº«å½±ï¼š\n\nKubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ CRI-Oâ†’ runC\n\nç”±äºæ­¤æ—¶ Docker åœ¨å®¹å™¨å¼•æ“ä¸­çš„å¸‚åœºä»½é¢ä»ç„¶å æœ‰ç»å¯¹ä¼˜åŠ¿ï¼Œå¯¹äºæ™®é€šç”¨æˆ·æ¥è¯´ï¼Œå¦‚æœæ²¡æœ‰æ˜ç¡®çš„æ”¶ç›Šï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆåŠ¨åŠ›è¦æŠŠ Docker æ¢æˆåˆ«çš„å¼•æ“ï¼Œæ‰€ä»¥ CRI-O å³ä½¿æ‘†å‡ºäº†ç›´æ¥æŒ–æ‰ Docker æ ¹åŸºçš„å‡¶æ‚å§¿åŠ¿ï¼Œå…¶å®ä¹Ÿå¹¶æ²¡æœ‰ç»™ Docker å¸¦æ¥å¤ªå¤šå³æ—¶å¯è§çš„å½±å“ï¼Œä¸è¿‡èƒ½å¤Ÿæƒ³åƒæ­¤æ—¶ Docker å¿ƒä¸­è‚¯å®šå……æ–¥äº†éš¾ä»¥è¨€å–»çš„å±æœºæ„Ÿã€‚\n2018 å¹´ï¼Œç”± Docker æçŒ®ç»™ CNCF çš„ containerdï¼Œåœ¨ CNCF çš„ç²¾å¿ƒå­µåŒ–ä¸‹å‘å¸ƒäº† 1.1 ç‰ˆï¼Œ1.1 ç‰ˆä¸ 1.0 ç‰ˆçš„æœ€å¤§åŒºåˆ«æ˜¯æ­¤æ—¶å®ƒå·²å®Œç¾åœ°æ”¯æŒäº† CRI æ ‡å‡†ï¼Œè¿™æ„å‘³ç€åŸæœ¬ç”¨ä½œ CRI é€‚é…å™¨çš„ cri-containerd ä»æ­¤ä¸å†éœ€è¦ã€‚æ­¤æ—¶ï¼Œå†è§‚å¯Ÿ Kubernetes åˆ°å®¹å™¨è¿è¡Œæ—¶çš„è°ƒç”¨é“¾ï¼Œä½ ä¼šå‘ç°è°ƒç”¨æ­¥éª¤ä¼šæ¯”é€šè¿‡ DockerShimã€Docker Engine ä¸ containerd äº¤äº’çš„æ­¥éª¤è¦å‡å°‘ä¸¤æ­¥ï¼Œè¿™åˆæ„å‘³ç€ç”¨æˆ·åªè¦æ„¿æ„æŠ›å¼ƒæ‰ Docker æƒ…æ€€çš„è¯ï¼Œåœ¨å®¹å™¨ç¼–æ’ä¸Šä¾¿å¯è‡³å°‘çœç•¥ä¸€æ¬¡ HTTP è°ƒç”¨ï¼Œè·å¾—æ€§èƒ½ä¸Šçš„æ”¶ç›Šï¼Œä¸”æ ¹æ® Kubernetes å®˜æ–¹ç»™å‡ºçš„æµ‹è¯•æ•°æ®ï¼Œè¿™äº›å…è´¹çš„æ”¶ç›Šè¿˜ç›¸å½“åœ°å¯è§‚ã€‚Kubernetes ä» 1.10 ç‰ˆæœ¬å®£å¸ƒå¼€å§‹æ”¯æŒ containerd 1.1ï¼Œåœ¨è°ƒç”¨é“¾ä¸­å·²ç»èƒ½å¤Ÿå®Œå…¨æŠ¹å» Docker Engine çš„å­˜åœ¨ï¼š\n\nKubernetes Master â†’ kubelet â†’ KubeGenericRuntimeManager â†’ containerd â†’ runC\n\nä»Šå¤©ï¼Œè¦ä½¿ç”¨å“ªä¸€ç§å®¹å™¨è¿è¡Œæ—¶å–å†³äºä½ å®‰è£… Kubernetes æ—¶å®¿ä¸»æœºä¸Šçš„å®¹å™¨è¿è¡Œæ—¶ç¯å¢ƒï¼Œä½†å¯¹äºäº‘è®¡ç®—å‚å•†æ¥è¯´ï¼Œè­¬å¦‚å›½å†…çš„é˜¿é‡Œäº‘ ACKã€è…¾è®¯äº‘ TKEç­‰ç›´æ¥æä¾›çš„ Kubernetes å®¹å™¨ç¯å¢ƒï¼Œé‡‡ç”¨çš„å®¹å™¨è¿è¡Œæ—¶æ™®ééƒ½å·²æ˜¯ containerdï¼Œæ¯•ç«Ÿè¿è¡Œæ€§èƒ½å¯¹å®ƒä»¬æ¥è¯´å°±æ˜¯æ ¸å¿ƒç”Ÿäº§åŠ›å’Œç«äº‰åŠ›ã€‚\næœªæ¥ï¼Œéšç€ Kubernetes çš„æŒç»­å‘å±•å£®å¤§ï¼ŒDocker Engine ç»å†ä»ä¸å¯æˆ–ç¼ºã€é»˜è®¤ä¾èµ–ã€å¯é€‰æ‹©ã€ç›´åˆ°æ·˜æ±°æ˜¯å¤§æ¦‚ç‡äº‹ä»¶ï¼Œè¿™ä»¶äº‹æƒ…è¡¨é¢ä¸Šæ˜¯ Googleã€RedHat ç­‰äº‘è®¡ç®—å¤§å‚è”æ‰‹æ‰€ä¸ºï¼Œå®é™…æ·˜æ±°å®ƒçš„è¿˜æ˜¯æŠ€æœ¯å‘å±•çš„æ½®æµè¶‹åŠ¿ï¼Œå°±å¦‚åŒ Docker è¯ç”Ÿæ—¶ä¾èµ– LXCï¼Œåˆ°æœ€åç”¨ libcontainer å–ä»£æ‰ LXC ä¸€èˆ¬ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿè¯¥çœ‹åˆ°äº‹æƒ…çš„å¦ä¸€é¢ï¼Œç°åœ¨è¿ LXC éƒ½è¿˜æ²¡æœ‰æŒ‚æ‰ï¼Œåå€’è¿˜å‘å±•å‡ºäº†æ›´åŠ ä¸“æ³¨äºä¸ OpenVZ ç­‰ç³»ç»Ÿçº§è™šæ‹ŸåŒ–ç«äº‰çš„LXDï¼Œç›¸ä¿¡ Docker æœ¬èº«ä¹Ÿå¾ˆéš¾å½»åº•æ¶ˆäº¡çš„ï¼Œå·²ç»å…»æˆä¹ æƒ¯çš„ CLI ç•Œé¢ï¼Œå·²ç»å½¢æˆæˆç†Ÿç”Ÿæ€çš„é•œåƒä»“åº“ç­‰éƒ½åº”è¯¥ä¼šé•¿æœŸå­˜åœ¨ï¼Œåªæ˜¯åœ¨å®¹å™¨ç¼–æ’é¢†åŸŸï¼Œæœªæ¥çš„ Docker å¾ˆå¯èƒ½åªä¼šä»¥ runC å’Œ containerd çš„å½¢å¼å­˜ç»­ä¸‹å»ï¼Œæ¯•ç«Ÿå®ƒä»¬æœ€åˆéƒ½æºäº Docker çš„è¡€è„‰ã€‚\näºŒã€ä»¥å®¹å™¨æ„å»ºç³»ç»Ÿè‡ªä» Docker æå‡ºâ€œä»¥å°è£…åº”ç”¨ä¸ºä¸­å¿ƒâ€çš„å®¹å™¨å‘å±•ç†å¿µï¼ŒæˆåŠŸå–ä»£äº†â€œä»¥å°è£…ç³»ç»Ÿä¸ºä¸­å¿ƒâ€çš„ LXC ä»¥åï¼Œä¸€ä¸ªå®¹å™¨å°è£…ä¸€ä¸ªå•è¿›ç¨‹åº”ç”¨å·²ç»æˆä¸ºè¢«å¹¿æ³›è®¤å¯çš„æœ€ä½³å®è·µã€‚ç„¶è€Œå•ä½“æ—¶ä»£è¿‡å»ä¹‹åï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿé‡Œåº”ç”¨çš„æ¦‚å¿µå·²ä¸å†ç­‰åŒäºè¿›ç¨‹ï¼Œæ­¤æ—¶çš„åº”ç”¨éœ€è¦å¤šä¸ªè¿›ç¨‹å…±åŒåä½œï¼Œé€šè¿‡é›†ç¾¤çš„å½¢å¼å¯¹å¤–æä¾›æœåŠ¡ï¼Œä»¥è™šæ‹ŸåŒ–æ–¹æ³•å®ç°è¿™ä¸ªç›®æ ‡çš„è¿‡ç¨‹å°±è¢«ç§°ä¸ºå®¹å™¨ç¼–æ’ï¼ˆContainer Orchestrationï¼‰ã€‚\nå®¹å™¨ä¹‹é—´é¡ºç•…åœ°äº¤äº’é€šä¿¡æ˜¯åä½œçš„æ ¸å¿ƒéœ€æ±‚ï¼Œä½†å®¹å™¨åä½œå¹¶ä¸ä»…ä»…æ˜¯å°†å®¹å™¨ä»¥é«˜é€Ÿç½‘ç»œäº’ç›¸è¿æ¥è€Œå·²ã€‚å¦‚ä½•è°ƒåº¦å®¹å™¨ï¼Œå¦‚ä½•åˆ†é…èµ„æºï¼Œå¦‚ä½•æ‰©ç¼©è§„æ¨¡ï¼Œå¦‚ä½•æœ€å¤§é™åº¦åœ°æ¥ç®¡ç³»ç»Ÿä¸­çš„éåŠŸèƒ½ç‰¹æ€§ï¼Œè®©ä¸šåŠ¡ç³»ç»Ÿå°½å¯èƒ½å…å—åˆ†å¸ƒå¼å¤æ‚æ€§çš„å›°æ‰°éƒ½æ˜¯å®¹å™¨ç¼–æ’æ¡†æ¶å¿…é¡»è€ƒè™‘çš„é—®é¢˜ï¼Œåªæœ‰æ°å½“è§£å†³äº†è¿™ä¸€ç³»åˆ—é—®é¢˜ï¼Œäº‘åŸç”Ÿåº”ç”¨æ‰æœ‰å¯èƒ½è·å¾—æ¯”ä¼ ç»Ÿåº”ç”¨æ›´é«˜çš„ç”Ÿäº§åŠ›ã€‚\néš”ç¦»ä¸åä½œç¬”è€…å¹¶ä¸æ‰“ç®—è¿‡å¤šä»‹ç» Kubernetes å…·ä½“æœ‰å“ªäº›åŠŸèƒ½ï¼Œå‘ä½ è¯´æ˜ Kubernetes ç”± Podã€Nodeã€Deploymentã€ReplicaSet ç­‰å„ç§ç±»å‹çš„èµ„æºç»„æˆå¯ç”¨çš„æœåŠ¡ã€é›†ç¾¤ç®¡ç†å¹³é¢ä¸èŠ‚ç‚¹ä¹‹é—´å¦‚ä½•å·¥ä½œã€æ¯ç§èµ„æºè¯¥å¦‚ä½•é…ç½®ä½¿ç”¨ç­‰ç­‰ï¼Œå¹¶ä¸æ˜¯ç¬”è€…çš„æœ¬æ„ï¼Œå¦‚æœä½ å¸Œæœ›äº†è§£è¿™æ–¹é¢ä¿¡æ¯ï¼Œå¯ä»¥ä» Kubernetes å®˜ç½‘çš„æ–‡æ¡£åº“æˆ–ä»»ä½•ä¸€æœ¬ä»¥ Kubernetes ä¸ºä¸»é¢˜çš„ä½¿ç”¨æ‰‹å†Œä¸­å¾—åˆ°ã€‚\nç¬”è€…çœŸæ­£å¸Œæœ›è¯´æ¸…æ¥šçš„é—®é¢˜æ˜¯â€œä¸ºä»€ä¹ˆ Kubernetes ä¼šè®¾è®¡æˆç°åœ¨è¿™ä¸ªæ ·å­ï¼Ÿâ€ã€â€œä¸ºä»€ä¹ˆä»¥å®¹å™¨æ„å»ºç³»ç»Ÿåº”è¯¥è¿™æ ·åšï¼Ÿâ€ï¼Œå¯»æ‰¾è¿™äº›é—®é¢˜çš„ç­”æ¡ˆæœ€å¥½æ˜¯ä»å®ƒä»¬è®¾è®¡çš„å®ç°æ„å›¾å‡ºå‘ï¼Œä¸ºæ­¤ï¼Œç¬”è€…è™šæ„äº†ä¸€ç³»åˆ—ä»ç®€å•åˆ°å¤æ‚çš„åœºæ™¯ä¾›ä½ ä»£å…¥å…¶ä¸­ï¼Œç†è§£å¹¶è§£å†³è¿™äº›åœºæ™¯ä¸­çš„é—®é¢˜ï¼Œå¹¶ä¸è¦æ±‚ä½ å¯¹ Kubernetes å·²æœ‰å¤šæ·±å…¥çš„äº†è§£ï¼Œä½†è¦æ±‚ä½ è‡³å°‘ä½¿ç”¨è¿‡ Kubernetes å’Œ Dockerï¼ŒåŸºæœ¬äº†è§£å®ƒçš„æ ¸å¿ƒåŠŸèƒ½ä¸å‘½ä»¤ï¼›æ­¤å¤–è¿˜ä¼šæ¶‰åŠåˆ°ä¸€ç‚¹å„¿ Linux ç³»ç»Ÿå†…æ ¸èµ„æºéš”ç¦»çš„åŸºç¡€çŸ¥è¯†ï¼Œåˆ«æ‹…å¿ƒï¼Œåªè¦ä½ ä»”ç»†è¯»æ‡‚äº†ä¸Šä¸€èŠ‚â€œå®¹å™¨çš„å´›èµ·â€ï¼Œå°±å·²ç»å®Œå…¨å¤Ÿç”¨äº†ã€‚\nç°åœ¨å°±æ¥è®¾æƒ³ä¸€ä¸‹ï¼Œå¦‚æœè®©ä½ æ¥è®¾è®¡ä¸€å¥—å®¹å™¨ç¼–æ’ç³»ç»Ÿï¼Œåè°ƒå„ç§å®¹å™¨æ¥å…±åŒæ¥å®Œæˆä¸€é¡¹å·¥ä½œï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿä¼šå¦‚ä½•ç€æ‰‹è§£å†³ï¼Ÿè®©æˆ‘ä»¬ä»æœ€ç®€å•çš„åœºæ™¯å‡ºå‘ï¼š\n\nåœºæ™¯ä¸€ï¼šå‡è®¾ä½ ç°åœ¨æœ‰ä¸¤ä¸ªåº”ç”¨ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯ Nginxï¼Œå¦ä¸€ä¸ªæ˜¯ä¸ºè¯¥ Nginx æ”¶é›†æ—¥å¿—çš„ Filebeatï¼Œä½ å¸Œæœ›å°†å®ƒä»¬å°è£…ä¸ºå®¹å™¨é•œåƒï¼Œä»¥æ–¹ä¾¿æ—¥ååˆ†å‘ã€‚\n\næœ€ç›´æ¥çš„æ–¹æ¡ˆå°±å°† Nginx å’Œ Filebeat ç›´æ¥ç¼–è¯‘æˆåŒä¸€ä¸ªå®¹å™¨é•œåƒï¼Œè¿™æ˜¯å¯ä»¥åšåˆ°çš„ï¼Œè€Œä¸”å¹¶ä¸å¤æ‚ï¼Œç„¶è€Œè¿™æ ·åšä¼šåŸ‹ä¸‹å¾ˆå¤§éšæ‚£ï¼šå®ƒè¿èƒŒäº† Docker æå€¡çš„å•ä¸ªå®¹å™¨å°è£…å•è¿›ç¨‹åº”ç”¨çš„æœ€ä½³å®è·µã€‚Docker è®¾è®¡çš„ Dockerfile åªå…è®¸æœ‰ä¸€ä¸ª ENTRYPOINTï¼Œè¿™å¹¶éæ— æ•…æ·»åŠ çš„äººä¸ºé™åˆ¶ï¼Œè€Œæ˜¯å› ä¸º Docker åªèƒ½é€šè¿‡ç›‘è§† PID ä¸º 1 çš„è¿›ç¨‹ï¼ˆå³ç”± ENTRYPOINT å¯åŠ¨çš„è¿›ç¨‹ï¼‰çš„è¿è¡ŒçŠ¶æ€æ¥åˆ¤æ–­å®¹å™¨çš„å·¥ä½œçŠ¶æ€æ˜¯å¦æ­£å¸¸ï¼Œå®¹å™¨é€€å‡ºæ‰§è¡Œæ¸…ç†ï¼Œå®¹å™¨å´©æºƒè‡ªåŠ¨é‡å¯ç­‰æ“ä½œéƒ½å¿…é¡»å…ˆåˆ¤æ–­çŠ¶æ€ã€‚è®¾æƒ³ä¸€ä¸‹ï¼Œå³ä½¿æˆ‘ä»¬ä½¿ç”¨äº†supervisordä¹‹ç±»çš„è¿›ç¨‹æ§åˆ¶å™¨æ¥è§£å†³åŒæ—¶å¯åŠ¨ Nginx å’Œ Filebeat è¿›ç¨‹çš„é—®é¢˜ï¼Œå¦‚æœå› æŸç§åŸå› å®ƒä»¬ä¸åœå‘ç”Ÿå´©æºƒã€é‡å¯ï¼Œé‚£ Docker ä¹Ÿæ— æ³•å¯Ÿè§‰åˆ°ï¼Œå®ƒåªèƒ½è§‚å¯Ÿåˆ° supervisord çš„è¿è¡ŒçŠ¶æ€ï¼Œå› æ­¤ï¼Œä»¥ä¸Šéœ€æ±‚ä¼šç†æ‰€å½“ç„¶åœ°æ¼”åŒ–æˆåœºæ™¯äºŒã€‚\n\nåœºæ™¯äºŒï¼šå‡è®¾ä½ ç°åœ¨æœ‰ä¸¤ä¸ª Docker é•œåƒï¼Œå…¶ä¸­ä¸€ä¸ªå°è£…äº† HTTP æœåŠ¡ï¼Œä¸ºä¾¿äºç§°å‘¼ï¼Œæˆ‘ä»¬å«å®ƒ Nginx å®¹å™¨ï¼Œå¦ä¸€ä¸ªå°è£…äº†æ—¥å¿—æ”¶é›†æœåŠ¡ï¼Œæˆ‘ä»¬å«å®ƒ Filebeat å®¹å™¨ã€‚ç°åœ¨è¦æ±‚ Filebeat å®¹å™¨èƒ½æ”¶é›† Nginx å®¹å™¨äº§ç”Ÿçš„æ—¥å¿—ä¿¡æ¯ã€‚\n\nåœºæ™¯äºŒä¾ç„¶ä¸éš¾è§£å†³ï¼Œåªè¦åœ¨ Nginx å®¹å™¨å’Œ Filebeat å®¹å™¨å¯åŠ¨æ—¶ï¼Œåˆ†åˆ«å°†å®ƒä»¬çš„æ—¥å¿—ç›®å½•å’Œæ”¶é›†ç›®å½•æŒ‚è½½ä¸ºå®¿ä¸»æœºåŒä¸€ä¸ªç£ç›˜ä½ç½®çš„ Volume å³å¯ï¼Œè¿™ç§æ“ä½œåœ¨ Docker ä¸­æ˜¯ååˆ†å¸¸ç”¨çš„å®¹å™¨é—´ä¿¡æ¯äº¤æ¢æ‰‹æ®µã€‚ä¸è¿‡ï¼Œå®¹å™¨é—´ä¿¡æ¯äº¤æ¢ä¸ä»…ä»…æ˜¯æ–‡ä»¶ç³»ç»Ÿï¼Œå‡å¦‚æ­¤æ—¶æˆ‘åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„å·¥å…·confdâ€”â€”Linux ä¸‹çš„ä¸€ç§é…ç½®ç®¡ç†å·¥å…·ï¼Œä½œç”¨æ˜¯æ ¹æ®é…ç½®ä¸­å¿ƒï¼ˆEtcdã€ZooKeeperã€Consulï¼‰çš„å˜åŒ–è‡ªåŠ¨æ›´æ–° Nginx çš„é…ç½®ï¼Œè¿™é‡Œä¾¿åˆä¼šé‡åˆ°æ–°çš„é—®é¢˜ã€‚confd éœ€è¦å‘ Nginx å‘é€ HUP ä¿¡å·ä»¥ä¾¿é€šçŸ¥ Nginxé…ç½®å·²ç»å‘ç”Ÿäº†å˜æ›´ï¼Œè€Œå‘é€ HUP ä¿¡å·è‡ªç„¶è¦æ±‚ confd ä¸ Nginx èƒ½å¤Ÿè¿›è¡Œ IPC é€šä¿¡æ‰è¡Œã€‚å°½ç®¡å…±äº« IPC åç§°ç©ºé—´ä¸å¦‚å…±äº« Volume å¸¸è§ï¼Œä½† Docker åŒæ ·æ”¯æŒäº†è¯¥åŠŸèƒ½ï¼Œdocker run æä¾›äº†--ipcå‚æ•°ï¼Œç”¨äºæŠŠå¤šä¸ªå®¹å™¨æŒ‚è½½åˆ°åŒä¸€ä¸ªçˆ¶å®¹å™¨çš„ IPC åç§°ç©ºé—´ä¹‹ä¸‹ï¼Œä»¥å®ç°å®¹å™¨é—´å…±äº« IPC åç§°ç©ºé—´çš„éœ€æ±‚ã€‚ç±»ä¼¼åœ°ï¼Œå¦‚æœè¦å…±äº« UTS åç§°ç©ºé—´ï¼Œå¯ä»¥ä½¿ç”¨--utså‚æ•°ï¼Œè¦å…±äº«ç½‘ç»œåç§°ç©ºé—´çš„è¯ï¼Œå°±ä½¿ç”¨--netå‚æ•°ã€‚\nä»¥ä¸Šä¾¿æ˜¯ Docker é’ˆå¯¹åœºæ™¯äºŒè¿™ç§ä¸è·¨æœºå™¨çš„å¤šå®¹å™¨åä½œæ‰€ç»™å‡ºçš„è§£å†³æ–¹æ¡ˆï¼Œè‡ªåŠ¨åœ°ä¸ºå¤šä¸ªå®¹å™¨è®¾ç½®å¥½å…±äº«åç§°ç©ºé—´å…¶å®å°±æ˜¯Docker Composeæä¾›çš„æ ¸å¿ƒèƒ½åŠ›ã€‚è¿™ç§é’ˆå¯¹å…·ä½“åº”ç”¨éœ€æ±‚æ¥å…±äº«åç§°ç©ºé—´çš„æ–¹æ¡ˆï¼Œçš„ç¡®å¯ä»¥å·¥ä½œï¼Œå´å¹¶ä¸å¤Ÿä¼˜é›…ï¼Œä¹Ÿè°ˆä¸ä¸Šæœ‰ä»€ä¹ˆæ‰©å±•æ€§ã€‚å®¹å™¨çš„æœ¬è´¨æ˜¯å¯¹ cgroups å’Œ namespaces æ‰€æä¾›çš„éš”ç¦»èƒ½åŠ›çš„ä¸€ç§å°è£…ï¼Œåœ¨ Docker æå€¡çš„å•è¿›ç¨‹å°è£…çš„ç†å¿µå½±å“ä¸‹ï¼Œå®¹å™¨è•´å«çš„éš”ç¦»æ€§ä¹Ÿå¤šäº†ä»…é’ˆå¯¹äºå•ä¸ªè¿›ç¨‹çš„é¢å¤–å±€é™ï¼Œç„¶è€Œ Linux çš„ cgroups å’Œ namespaces åŸæœ¬éƒ½æ˜¯é’ˆå¯¹è¿›ç¨‹ç»„è€Œä¸ä»…ä»…æ˜¯å•ä¸ªè¿›ç¨‹æ¥è®¾è®¡çš„ï¼ŒåŒä¸€ä¸ªè¿›ç¨‹ç»„ä¸­çš„å¤šä¸ªè¿›ç¨‹å¤©ç„¶å°±å¯ä»¥å…±äº«ç€ç›¸åŒçš„è®¿é—®æƒé™ä¸èµ„æºé…é¢ã€‚å¦‚æœç°åœ¨æˆ‘ä»¬æŠŠå®¹å™¨ä¸è¿›ç¨‹åœ¨æ¦‚å¿µä¸Šå¯¹åº”èµ·æ¥ï¼Œé‚£å®¹å™¨ç¼–æ’çš„ç¬¬ä¸€ä¸ªæ‰©å±•ç‚¹ï¼Œå°±æ˜¯è¦æ‰¾åˆ°å®¹å™¨é¢†åŸŸä¸­ä¸â€œè¿›ç¨‹ç»„â€ç›¸å¯¹åº”çš„æ¦‚å¿µï¼Œè¿™æ˜¯å®ç°å®¹å™¨ä»éš”ç¦»åˆ°åä½œçš„ç¬¬ä¸€æ­¥ï¼Œåœ¨ Kubernetes çš„è®¾è®¡é‡Œï¼Œè¿™ä¸ªå¯¹åº”ç‰©å«ä½œ Podã€‚\né¢å¤–çŸ¥è¯†ï¼šPod åå­—çš„ç”±æ¥ä¸å«ä¹‰\nPod çš„æ¦‚å¿µåœ¨å®¹å™¨æ­£å¼å‡ºç°ä¹‹å‰çš„ Borg ç³»ç»Ÿä¸­å°±å·²ç»å­˜åœ¨ï¼Œä» Google çš„å‘è¡¨çš„ã€ŠLarge-Scale Cluster Management at Google with Borgã€‹å¯ä»¥çœ‹å‡ºï¼ŒKubernetes æ—¶ä»£çš„ Pod æ•´åˆäº† Borg æ—¶ä»£çš„â€œProdâ€ï¼ˆProduction Task çš„ç¼©å†™ï¼‰ä¸â€œNon-Prodâ€çš„èŒèƒ½ã€‚ç”±äº Pod ä¸€ç›´æ²¡æœ‰æƒå¨çš„ä¸­æ–‡ç¿»è¯‘ï¼Œç¬”è€…åœ¨åç»­æ–‡ç« ä¸­ä¼šå°½é‡ç”¨è‹±æ–‡æŒ‡ä»£ï¼Œå¶å°”éœ€è¦ä¸­æ–‡çš„åœºåˆå°±ä½¿ç”¨ Borg ä¸­ Prod çš„è¯‘æ³•ï¼Œå³â€œç”Ÿäº§ä»»åŠ¡â€æ¥æŒ‡ä»£ã€‚\næœ‰äº†â€œå®¹å™¨ç»„â€çš„æ¦‚å¿µï¼Œåœºæ™¯äºŒçš„é—®é¢˜ä¾¿åªéœ€è¦å°†å¤šä¸ªå®¹å™¨æ”¾åˆ°åŒä¸€ä¸ª Pod ä¸­å³å¯è§£å†³ã€‚æ‰®æ¼”å®¹å™¨ç»„çš„è§’è‰²ï¼Œæ»¡è¶³å®¹å™¨å…±äº«åç§°ç©ºé—´çš„éœ€æ±‚ï¼Œæ˜¯ Pod çš„ä¸¤å¤§æœ€åŸºæœ¬èŒè´£ä¹‹ä¸€ï¼ŒåŒå¤„äºä¸€ä¸ª Pod å†…çš„å¤šä¸ªå®¹å™¨ï¼Œç›¸äº’ä¹‹é—´ä»¥è¶…äº²å¯†çš„æ–¹å¼åä½œã€‚è¯·æ³¨æ„ï¼Œâ€œè¶…äº²å¯†â€åœ¨è¿™é‡Œå¹¶éæŸç§å¸¦å¼ºçƒˆæ„Ÿæƒ…è‰²å½©çš„å½¢å®¹è¯ï¼Œè€Œæ˜¯æœ‰ä¸€ç§æœ‰å…·ä½“å®šä¹‰çš„åä½œç¨‹åº¦ã€‚å¯¹äºæ™®é€šéäº²å¯†çš„å®¹å™¨ï¼Œå®ƒä»¬ä¸€èˆ¬ä»¥ç½‘ç»œäº¤äº’æ–¹å¼ï¼ˆå…¶ä»–è­¬å¦‚å…±äº«åˆ†å¸ƒå¼å­˜å‚¨æ¥äº¤æ¢ä¿¡æ¯ä¹Ÿç®—è·¨ç½‘ç»œï¼‰åä½œï¼›å¯¹äº²å¯†åä½œçš„å®¹å™¨ï¼Œæ˜¯æŒ‡å®ƒä»¬è¢«è°ƒåº¦åˆ°åŒä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥é€šè¿‡å…±äº«æœ¬åœ°ç£ç›˜ç­‰æ–¹å¼åä½œï¼›è€Œè¶…äº²å¯†çš„åä½œæ˜¯ç‰¹æŒ‡å¤šä¸ªå®¹å™¨ä½äºåŒä¸€ä¸ª Pod è¿™ç§ç‰¹æ®Šå…³ç³»ï¼Œå®ƒä»¬å°†é»˜è®¤å…±äº«ï¼š\n\nUTS åç§°ç©ºé—´ï¼šæ‰€æœ‰å®¹å™¨éƒ½æœ‰ç›¸åŒçš„ä¸»æœºåå’ŒåŸŸåã€‚\nç½‘ç»œåç§°ç©ºé—´ï¼šæ‰€æœ‰å®¹å™¨éƒ½å…±äº«ä¸€æ ·çš„ç½‘å¡ã€ç½‘ç»œæ ˆã€IP åœ°å€ï¼Œç­‰ç­‰ã€‚å› æ­¤ï¼ŒåŒä¸€ä¸ª Pod ä¸­ä¸åŒå®¹å™¨å ç”¨çš„ç«¯å£ä¸èƒ½å†²çªã€‚\nIPC åç§°ç©ºé—´ï¼šæ‰€æœ‰å®¹å™¨éƒ½å¯ä»¥é€šè¿‡ä¿¡å·é‡æˆ–è€… POSIX å…±äº«å†…å­˜ç­‰æ–¹å¼é€šä¿¡ã€‚\næ—¶é—´åç§°ç©ºé—´ï¼šæ‰€æœ‰å®¹å™¨éƒ½å…±äº«ç›¸åŒçš„ç³»ç»Ÿæ—¶é—´ã€‚\n\nåŒä¸€ä¸ª Pod çš„å®¹å™¨ï¼Œåªæœ‰ PID åç§°ç©ºé—´å’Œæ–‡ä»¶åç§°ç©ºé—´é»˜è®¤æ˜¯éš”ç¦»çš„ã€‚PID çš„éš”ç¦»ä»¤æ¯ä¸ªå®¹å™¨éƒ½æœ‰ç‹¬ç«‹çš„è¿›ç¨‹ ID ç¼–å·ï¼Œå®ƒä»¬å°è£…çš„åº”ç”¨è¿›ç¨‹å°±æ˜¯ PID ä¸º 1 çš„è¿›ç¨‹ï¼Œå¯ä»¥é€šè¿‡ Pod å…ƒæ•°æ®å®šä¹‰ä¸­çš„spec.shareProcessNamespaceæ¥æ”¹å˜è¿™ç‚¹ã€‚ä¸€æ—¦è¦æ±‚å…±äº« PID åç§°ç©ºé—´ï¼Œå®¹å™¨å°è£…çš„åº”ç”¨è¿›ç¨‹å°±ä¸å†å…·æœ‰ PID ä¸º 1 çš„ç‰¹å¾äº†ï¼Œè¿™æœ‰å¯èƒ½å¯¼è‡´éƒ¨åˆ†ä¾èµ–è¯¥ç‰¹å¾çš„åº”ç”¨å‡ºç°å¼‚å¸¸ã€‚åœ¨æ–‡ä»¶åç§°ç©ºé—´æ–¹é¢ï¼Œå®¹å™¨è¦æ±‚æ–‡ä»¶åç§°ç©ºé—´çš„éš”ç¦»æ˜¯å¾ˆç†æ‰€å½“ç„¶çš„éœ€æ±‚ï¼Œå› ä¸ºå®¹å™¨éœ€è¦ç›¸äº’ç‹¬ç«‹çš„æ–‡ä»¶ç³»ç»Ÿä»¥é¿å…å†²çªã€‚ä½†å®¹å™¨é—´å¯ä»¥å…±äº«å­˜å‚¨å·ï¼Œè¿™æ˜¯é€šè¿‡ Kubernetes çš„ Volume æ¥å®ç°çš„ã€‚\né¢å¤–çŸ¥è¯†ï¼šKubernetes ä¸­ Pod åç§°ç©ºé—´å…±äº«çš„å®ç°ç»†èŠ‚\nPod å†…éƒ¨å¤šä¸ªå®¹å™¨å…±äº« UTSã€IPCã€ç½‘ç»œç­‰åç§°ç©ºé—´æ˜¯é€šè¿‡ä¸€ä¸ªåä¸º Infra Container çš„å®¹å™¨æ¥å®ç°çš„ï¼Œè¿™ä¸ªå®¹å™¨æ˜¯æ•´ä¸ª Pod ä¸­ç¬¬ä¸€ä¸ªå¯åŠ¨çš„å®¹å™¨ï¼Œåªæœ‰å‡ ç™¾ KB å¤§å°ï¼ˆä»£ç åªæœ‰å¾ˆçŸ­çš„å‡ åè¡Œï¼Œè§è¿™é‡Œï¼‰ï¼ŒPod ä¸­çš„å…¶ä»–å®¹å™¨éƒ½ä¼šä»¥ Infra Container ä½œä¸ºçˆ¶å®¹å™¨ï¼ŒUTSã€IPCã€ç½‘ç»œç­‰åç§°ç©ºé—´å®è´¨ä¸Šéƒ½æ˜¯æ¥è‡ª Infra Container å®¹å™¨ã€‚\nå¦‚æœå®¹å™¨è®¾ç½®ä¸ºå…±äº« PID åç§°ç©ºé—´çš„è¯ï¼ŒInfra Container ä¸­çš„è¿›ç¨‹å°†ä½œä¸º PID 1 è¿›ç¨‹ï¼Œå…¶ä»–å®¹å™¨çš„è¿›ç¨‹å°†ä»¥å®ƒçš„å­è¿›ç¨‹çš„æ–¹å¼å­˜åœ¨ï¼Œæ­¤æ—¶å°†ç”± Infra Container æ¥è´Ÿè´£è¿›ç¨‹ç®¡ç†ï¼ˆè­¬å¦‚æ¸…ç†åƒµå°¸è¿›ç¨‹ï¼‰ã€æ„ŸçŸ¥çŠ¶æ€å’Œä¼ é€’çŠ¶æ€ã€‚\nç”±äº Infra Container çš„ä»£ç é™¤äº†æ³¨å†Œ SIGINTã€SIGTERMã€SIGCHLD ç­‰ä¿¡å·çš„å¤„ç†å™¨å¤–ï¼Œå°±åªæ˜¯ä¸€ä¸ªä»¥ pause()æ–¹æ³•ä¸ºå¾ªç¯ä½“çš„æ— é™å¾ªç¯ï¼Œæ°¸è¿œå¤„äº Pause çŠ¶æ€ï¼Œæ‰€ä»¥ä¹Ÿå¸¸è¢«ç§°ä¸ºâ€œPause Containerâ€ã€‚\nPod çš„å¦å¤–ä¸€ä¸ªåŸºæœ¬èŒè´£æ˜¯å®ç°åŸå­æ€§è°ƒåº¦ï¼Œå¦‚æœå®¹å™¨ç¼–æ’ä¸è·¨è¶Šé›†ç¾¤èŠ‚ç‚¹ï¼Œæ˜¯å¦å…·æœ‰åŸå­æ€§éƒ½æ— å…³ç´§è¦ã€‚ä½†æ˜¯åœ¨é›†ç¾¤ç¯å¢ƒä¸­ï¼Œå®¹å™¨å¯èƒ½è·¨æœºå™¨è°ƒåº¦æ—¶ï¼Œè¿™ä¸ªç‰¹æ€§å°±å˜å¾—éå¸¸é‡è¦ã€‚å¦‚æœä»¥å®¹å™¨ä¸ºå•ä½æ¥è°ƒåº¦çš„è¯ï¼Œä¸åŒå®¹å™¨å°±æœ‰å¯èƒ½è¢«åˆ†é…åˆ°ä¸åŒæœºå™¨ä¸Šã€‚ä¸¤å°æœºå™¨ä¹‹é—´æœ¬æ¥å°±æ˜¯ç‰©ç†éš”ç¦»ï¼Œä¾é ç½‘ç»œè¿æ¥çš„ï¼Œè¿™æ—¶å€™è°ˆä»€ä¹ˆåç§°ç©ºé—´å…±äº«ã€cgroupsé…é¢å…±äº«éƒ½å¤±å»äº†æ„ä¹‰ï¼Œæˆ‘ä»¬ç”±æ­¤ä»åœºæ™¯äºŒåˆæ¼”åŒ–å‡ºä»¥ä¸‹åœºæ™¯ä¸‰ã€‚\n\nåœºæ™¯ä¸‰ï¼šå‡è®¾ä½ ç°åœ¨æœ‰ Filebeatã€Nginx ä¸¤ä¸ª Docker é•œåƒï¼Œåœ¨ä¸€ä¸ªå…·æœ‰å¤šä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œè¦æ±‚æ¯æ¬¡è°ƒåº¦éƒ½å¿…é¡»è®© Filebeat å’Œ Nginx å®¹å™¨è¿è¡ŒäºåŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚\n\nä¸¤ä¸ªå…³è”çš„åä½œä»»åŠ¡å¿…é¡»ä¸€èµ·è°ƒåº¦çš„éœ€æ±‚åœ¨å®¹å™¨å‡ºç°ä¹‹å‰å°±å­˜åœ¨å·²ä¹…ï¼Œè­¬å¦‚åœ¨ä¼ ç»Ÿçš„å¤šçº¿ç¨‹ï¼ˆæˆ–å¤šè¿›ç¨‹ï¼‰å¹¶å‘è°ƒåº¦ä¸­ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹ï¼ˆæˆ–è¿›ç¨‹ï¼‰çš„å·¥ä½œæ˜¯å¼ºä¾èµ–çš„ï¼Œå•ç‹¬ç»™è°åˆ†é…å¤„ç†æ—¶é—´ã€è€Œå¦ä¸€ä¸ªè¢«æŒ‚èµ·éƒ½ä¼šå¯¼è‡´ç¨‹åºæ— æ³•å·¥ä½œï¼Œå¦‚æ­¤å°±æœ‰äº†ååŒè°ƒåº¦ï¼ˆCoschedulingï¼‰çš„æ¦‚å¿µï¼Œä»¥ä¿è¯ä¸€ç»„ç´§å¯†è”ç³»çš„ä»»åŠ¡èƒ½å¤Ÿè¢«åŒæ—¶åˆ†é…èµ„æºã€‚å¦‚æœæˆ‘ä»¬åœ¨å®¹å™¨ç¼–æ’ä¸­ä»ç„¶åšæŒå°†å®¹å™¨è§†ä¸ºè°ƒåº¦çš„æœ€å°ç²’åº¦ï¼Œé‚£å¯¹å®¹å™¨è¿è¡Œæ‰€éœ€èµ„æºçš„éœ€æ±‚å£°æ˜å°±åªèƒ½è®¾å®šåœ¨å®¹å™¨ä¸Šï¼Œè¿™æ ·é›†ç¾¤æ¯ä¸ªèŠ‚ç‚¹å‰©ä½™èµ„æºè¶Šç´§å¼ ï¼Œå•ä¸ªèŠ‚ç‚¹æ— æ³•å®¹çº³å…¨éƒ¨ååŒå®¹å™¨çš„æ¦‚ç‡å°±è¶Šå¤§ï¼ŒååŒçš„å®¹å™¨è¢«åˆ†é…åˆ°ä¸åŒèŠ‚ç‚¹çš„å¯èƒ½æ€§å°±è¶Šé«˜ã€‚\nååŒè°ƒåº¦æ˜¯ååˆ†éº»çƒ¦çš„ï¼Œå®ç°èµ·æ¥è¦ä¹ˆå¾ˆä½æ•ˆï¼Œè­¬å¦‚ Apache Mesos çš„ Resource Hoarding è°ƒåº¦ç­–ç•¥ï¼Œå°±è¦ç­‰æ‰€æœ‰éœ€è¦è°ƒåº¦çš„ä»»åŠ¡éƒ½å®Œå¤‡åæ‰ä¼šå¼€å§‹åˆ†é…èµ„æºï¼›è¦ä¹ˆå°±ä¼šå®ç°å¾—å¾ˆå¤æ‚ï¼Œè­¬å¦‚ Google å°±æ›¾é’ˆå¯¹ Borg çš„ä¸‹ä¸€ä»£ Omega ç³»ç»Ÿå‘è¡¨è¿‡è®ºæ–‡ã€ŠOmega: Flexible, Scalable Schedulers for Large Compute Clustersã€‹ä»‹ç»å®ƒå¦‚ä½•ä½¿ç”¨é€šè¿‡ä¹è§‚å¹¶å‘ï¼ˆOptimistic Concurrencyï¼‰ã€å†²çªå›æ»šçš„æ–¹å¼åšåˆ°é«˜æ•ˆç‡ï¼Œä¹ŸåŒæ ·é«˜åº¦å¤æ‚çš„ååŒè°ƒåº¦ã€‚ä½†æ˜¯å¦‚æœå°†è¿è¡Œèµ„æºçš„éœ€æ±‚å£°æ˜å®šä¹‰åœ¨ Pod ä¸Šï¼Œç›´æ¥ä»¥ Pod ä¸ºæœ€å°çš„åŸå­å•ä½æ¥å®ç°è°ƒåº¦çš„è¯ï¼Œç”±äºå¤šä¸ª Pod ä¹‹é—´å¿…å®šä¸å­˜åœ¨è¶…äº²å¯†çš„ååŒå…³ç³»ï¼Œåªä¼šé€šè¿‡ç½‘ç»œéäº²å¯†åœ°åä½œï¼Œé‚£å°±æ ¹æœ¬æ²¡æœ‰ååŒçš„è¯´æ³•ï¼Œè‡ªç„¶ä¹Ÿä¸éœ€è¦è€ƒè™‘å¤æ‚çš„è°ƒåº¦äº†ï¼Œå…³äº Kubernetes çš„å…·ä½“è°ƒåº¦å®ç°ï¼Œç¬”è€…ä¼šåœ¨â€œèµ„æºä¸è°ƒåº¦â€ä¸­å±•å¼€è®²è§£ã€‚\nPod æ˜¯éš”ç¦»ä¸è°ƒåº¦çš„åŸºæœ¬å•ä½ï¼Œä¹Ÿæ˜¯æˆ‘ä»¬æ¥è§¦çš„ç¬¬ä¸€ç§ Kubernetes èµ„æºã€‚Kubernetes å°†ä¸€åˆ‡çš†è§†ä¸ºèµ„æºï¼Œä¸åŒèµ„æºä¹‹é—´ä¾é å±‚çº§å…³ç³»ç›¸äº’ç»„åˆåä½œï¼Œè¿™ä¸ªæ€æƒ³æ˜¯è´¯ç©¿ Kubernetes æ•´ä¸ªç³»ç»Ÿçš„ä¸¤å¤§æ ¸å¿ƒè®¾è®¡ç†å¿µä¹‹ä¸€ï¼Œä¸ä»…åœ¨å®¹å™¨ã€Podã€ä¸»æœºã€é›†ç¾¤ç­‰è®¡ç®—èµ„æºä¸Šæ˜¯è¿™æ ·ï¼Œåœ¨å·¥ä½œè´Ÿè½½ã€æŒä¹…å­˜å‚¨ã€ç½‘ç»œç­–ç•¥ã€èº«ä»½æƒé™ç­‰å…¶ä»–é¢†åŸŸä¸­ä¹Ÿéƒ½æœ‰ç€ä¸€è‡´çš„ä½“ç°ã€‚\n\nç”±äº Pod æ˜¯ Kubernetes ä¸­æœ€é‡è¦çš„èµ„æºï¼Œåˆæ˜¯èµ„æºæ¨¡å‹ä¸­ä¸€ç§ä»…åœ¨é€»è¾‘ä¸Šå­˜åœ¨ã€æ²¡æœ‰ç‰©ç†å¯¹åº”çš„æ¦‚å¿µï¼ˆå› ä¸ºå¯¹åº”çš„â€œè¿›ç¨‹ç»„â€ä¹Ÿåªæ˜¯ä¸ªé€»è¾‘æ¦‚å¿µï¼‰ï¼Œæ˜¯å…¶ä»–ç¼–æ’ç³»ç»Ÿæ²¡æœ‰çš„æ¦‚å¿µï¼Œæ‰€ä»¥ç¬”è€…ä¸“é—¨èŠ±è´¹äº†ä¸€äº›ç¯‡å¹…å»ä»‹ç»å®ƒçš„è®¾è®¡æ„å›¾ï¼Œè€Œä¸æ˜¯åƒå¸®åŠ©æ‰‹å†Œé‚£æ ·ç›´æ¥ç»™å‡ºå®ƒçš„ä½œç”¨å’Œç‰¹æ€§ã€‚å¯¹äº Kubernetes ä¸­çš„å…¶ä»–è®¡ç®—èµ„æºï¼Œåƒ Nodeã€Cluster ç­‰éƒ½æœ‰åˆ‡å®çš„ç‰©ç†å¯¹åº”ç‰©ï¼Œå¾ˆå®¹æ˜“å°±èƒ½å½¢æˆå…±åŒçš„è®¤çŸ¥ï¼Œç¬”è€…ä¹Ÿå°±ä¸å¿…é€ä¸€ä»‹ç»äº†ï¼Œä»…å°†å®ƒä»¬çš„è®¾è®¡æ„å›¾åˆ—ä¸¾å¦‚ä¸‹ï¼š\n\nå®¹å™¨ï¼ˆContainerï¼‰ï¼šå»¶ç»­äº†è‡ª Docker ä»¥æ¥ä¸€ä¸ªå®¹å™¨å°è£…ä¸€ä¸ªåº”ç”¨è¿›ç¨‹çš„ç†å¿µï¼Œæ˜¯é•œåƒç®¡ç†çš„æœ€å°å•ä½ã€‚\nç”Ÿäº§ä»»åŠ¡ï¼ˆPodï¼‰ï¼šè¡¥å……äº†å®¹å™¨åŒ–åç¼ºå¤±çš„ä¸è¿›ç¨‹ç»„å¯¹åº”çš„â€œå®¹å™¨ç»„â€çš„æ¦‚å¿µï¼ŒPod ä¸­å®¹å™¨å…±äº« UTSã€IPCã€ç½‘ç»œç­‰åç§°ç©ºé—´ï¼Œæ˜¯èµ„æºè°ƒåº¦çš„æœ€å°å•ä½ã€‚\nèŠ‚ç‚¹ï¼ˆNodeï¼‰ï¼šå¯¹åº”äºé›†ç¾¤ä¸­çš„å•å°æœºå™¨ï¼Œè¿™é‡Œçš„æœºå™¨å³å¯ä»¥æ˜¯ç”Ÿäº§ç¯å¢ƒä¸­çš„ç‰©ç†æœºï¼Œä¹Ÿå¯ä»¥æ˜¯äº‘è®¡ç®—ç¯å¢ƒä¸­çš„è™šæ‹ŸèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹æ˜¯å¤„ç†å™¨å’Œå†…å­˜ç­‰èµ„æºçš„èµ„æºæ± ï¼Œæ˜¯ç¡¬ä»¶å•å…ƒçš„æœ€å°å•ä½ã€‚\né›†ç¾¤ï¼ˆClusterï¼‰ï¼šå¯¹åº”äºæ•´ä¸ªé›†ç¾¤ï¼ŒKubernetes æå€¡ç†å¿µæ˜¯é¢å‘é›†ç¾¤æ¥ç®¡ç†åº”ç”¨ã€‚å½“ä½ è¦éƒ¨ç½²åº”ç”¨çš„æ—¶å€™ï¼Œåªéœ€è¦é€šè¿‡å£°æ˜å¼ API å°†ä½ çš„æ„å›¾å†™æˆä¸€ä»½å…ƒæ•°æ®ï¼ˆManifestsï¼‰ï¼Œå°†å®ƒæäº¤ç»™é›†ç¾¤å³å¯ï¼Œè€Œæ— éœ€å…³å¿ƒå®ƒå…·ä½“åˆ†é…åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼ˆå°½ç®¡é€šè¿‡æ ‡ç­¾é€‰æ‹©å™¨å®Œå…¨å¯ä»¥æ§åˆ¶å®ƒåˆ†é…åˆ°å“ªä¸ªèŠ‚ç‚¹ï¼Œä½†ä¸€èˆ¬ä¸éœ€è¦è¿™æ ·åšï¼‰ã€å¦‚ä½•å®ç° Pod é—´é€šä¿¡ã€å¦‚ä½•ä¿è¯éŸ§æ€§ä¸å¼¹æ€§ï¼Œç­‰ç­‰ï¼Œæ‰€ä»¥é›†ç¾¤æ˜¯å¤„ç†å…ƒæ•°æ®çš„æœ€å°å•ä½ã€‚\né›†ç¾¤è”é‚¦ï¼ˆFederationï¼‰ï¼šå¯¹åº”äºå¤šä¸ªé›†ç¾¤ï¼Œé€šè¿‡è”é‚¦å¯ä»¥ç»Ÿä¸€ç®¡ç†å¤šä¸ª Kubernetes é›†ç¾¤ï¼Œè”é‚¦çš„ä¸€ç§å¸¸è§åº”ç”¨æ˜¯æ”¯æŒè·¨å¯ç”¨åŒºåŸŸå¤šæ´»ã€è·¨åœ°åŸŸå®¹ç¾çš„éœ€æ±‚ã€‚\n\néŸ§æ€§ä¸å¼¹æ€§ç¬”è€…æ›¾çœ‹è¿‡ä¸€éƒ¨å«ä½œã€ŠBubble Boyã€‹çš„ç”µå½±ï¼Œè®²è¿°äº†ä¸€ä¸ªä½“å†…æ²¡æœ‰ä»»ä½•å…ç–«ç³»ç»Ÿçš„å°ç”·å­©ï¼Œç»ˆæ—¥åªèƒ½ç”Ÿæ´»åœ¨æ— èŒçš„åœ†å½¢æ°”çƒé‡Œï¼Œå¯¹å¸¸äººæ¥è¯´ä¸å€¼ä¸€æçš„ç»†èŒï¼Œéƒ½èƒ½å¤Ÿç›´æ¥å¨èƒåˆ°ä»–çš„æ€§å‘½ã€‚å°ç”·å­©å°½ç®¡èƒ½å¤Ÿé™ç”Ÿäºä¸–é—´ï¼Œä½†å¹¶ä¸èƒ½çœŸæ­£ä¸ä¸–ç•Œäº¤æµï¼Œè¿™ç§ç”Ÿå‘½æ˜¯æåº¦è„†å¼±çš„ã€‚\nçœŸå®ä¸–ç•Œçš„è½¯ä»¶ç³»ç»Ÿä¸ç”µå½±ä¸–ç•Œä¸­çš„å°ç”·å­©äº¦å…·æœ‰å¯æ¯”æ€§ã€‚è®©å®¹å™¨å¾—ä»¥ç›¸äº’è¿é€šï¼Œç›¸äº’åä½œä»…ä»…æ˜¯ä»¥å®¹å™¨æ„å»ºç³»ç»Ÿçš„ç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬ä¸ä»…å¸Œæœ›å¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿè¿è¡Œèµ·æ¥çš„ç³»ç»Ÿï¼Œè€Œä¸”è¿˜å¸Œæœ›å¾—åˆ°ä¸€ä¸ªèƒ½å¤Ÿå¥å£®è¿è¡Œçš„ç³»ç»Ÿã€èƒ½å¤ŸæŠµå¾¡æ„å¤–ä¸é£é™©çš„ç³»ç»Ÿã€‚åœ¨ Kubernetes çš„æ”¯æŒä¸‹ï¼Œä½ ç¡®å®å¯ä»¥ç›´æ¥åˆ›å»º Pod å°†åº”ç”¨è¿è¡Œèµ·æ¥ï¼Œä½†è¿™æ ·çš„åº”ç”¨å°±å¦‚åŒç”µå½±ä¸­åªèƒ½å­˜æ´»åœ¨æ°”çƒä¸­çš„å°ç”·å­©ä¸€èˆ¬è„†å¼±ï¼Œæ— è®ºæ˜¯è½¯ä»¶ç¼ºé™·ã€æ„å¤–æ“ä½œæˆ–è€…ç¡¬ä»¶æ•…éšœï¼Œéƒ½å¯èƒ½å¯¼è‡´åœ¨å¤æ‚åä½œçš„è¿‡ç¨‹ä¸­æŸä¸ªå®¹å™¨å‡ºç°å¼‚å¸¸ï¼Œè¿›è€Œå‡ºç°ç³»ç»Ÿæ€§çš„å´©æºƒã€‚ä¸ºæ­¤ï¼Œæ¶æ„å¸ˆä¸“é—¨è®¾è®¡äº†æœåŠ¡å®¹é”™çš„ç­–ç•¥å’Œæ¨¡å¼ï¼ŒKubernetes ä½œä¸ºäº‘åŸç”Ÿæ—¶ä»£çš„åŸºç¡€è®¾æ–½ï¼Œä¹Ÿå°½åŠ›å¸®åŠ©ç¨‹åºå‘˜ä»¥æœ€å°çš„ä»£ä»·æ¥å®ç°å®¹é”™ï¼Œä¸ºç³»ç»Ÿå¥å£®è¿è¡Œæä¾›åº•å±‚æ”¯æŒã€‚\nå¦‚ä½•å®ç°å…·æœ‰éŸ§æ€§ä¸å¼¹æ€§çš„ç³»ç»Ÿæ˜¯å±•ç¤º Kubernetes æ§åˆ¶å™¨è®¾è®¡æ¨¡å¼çš„æœ€å¥½ç¤ºä¾‹ï¼Œæ§åˆ¶å™¨æ¨¡å¼æ˜¯ç»§èµ„æºæ¨¡å‹ä¹‹åï¼Œæœ¬èŠ‚ä»‹ç»çš„å¦ä¸€ä¸ª Kubernetes æ ¸å¿ƒè®¾è®¡ç†å¿µã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±ä»å¦‚ä½•è§£å†³ä»¥ä¸‹åœºæ™¯å››çš„é—®é¢˜å¼€å§‹ã€‚\n\nåœºæ™¯å››ï¼šå‡è®¾æœ‰ä¸€ä¸ªç”±æ•°åä¸ª Nodeã€æ•°ç™¾ä¸ª Podã€è¿‘åƒä¸ª Container æ‰€ç»„æˆçš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œè¦é¿å…ç³»ç»Ÿå› ä¸ºå¤–éƒ¨æµé‡å‹åŠ›ã€ä»£ç ç¼ºé™·ã€è½¯ä»¶æ›´æ–°ã€ç¡¬ä»¶å‡çº§ã€èµ„æºåˆ†é…ç­‰å„ç§åŸå› è€Œå‡ºç°ä¸­æ–­ï¼Œä½œä¸ºç®¡ç†å‘˜ï¼Œä½ å¸Œæœ›ç¼–æ’ç³»ç»Ÿèƒ½ä¸ºä½ æä¾›ä½•ç§æ”¯æŒï¼Ÿ\n\nä½œä¸ºç”¨æˆ·ï¼Œå½“ç„¶æœ€å¸Œæœ›å®¹å™¨ç¼–æ’ç³»ç»Ÿèƒ½è‡ªåŠ¨æŠŠæ‰€æœ‰æ„å¤–å› ç´ éƒ½æ¶ˆç­æ‰ï¼Œè®©ä»»ä½•æ¯ä¸€ä¸ªæœåŠ¡éƒ½æ°¸è¿œå¥åº·ï¼Œæ°¸ä¸å‡ºé”™ã€‚ä½†æ°¸ä¸å‡ºé”™çš„æœåŠ¡æ˜¯ä¸åˆ‡å®é™…çš„ï¼Œåªæœ‰å‡‘é½ä¸ƒé¢—é¾™ç æ‰æœ‰æœ›åŠåˆ°ã€‚é‚£å°±åªèƒ½é€€è€Œæ±‚å…¶æ¬¡ï¼Œè®©ç¼–æ’ç³»ç»Ÿåœ¨è¿™äº›æœåŠ¡å‡ºç°é—®é¢˜ï¼Œè¿è¡ŒçŠ¶æ€ä¸æ­£ç¡®çš„æ—¶å€™ï¼Œèƒ½è‡ªåŠ¨å°†å®ƒä»¬è°ƒæ•´æˆæ­£ç¡®çš„çŠ¶æ€ã€‚è¿™ç§éœ€æ±‚å¬èµ·æ¥ä¹Ÿæ˜¯è´ªå¿ƒçš„ï¼Œå´å·²ç»å…·å¤‡è¶³å¤Ÿçš„å¯è¡Œæ€§ï¼Œåº”å¯¹çš„è§£å†³åŠæ³•åœ¨å·¥ä¸šæ§åˆ¶ç³»ç»Ÿé‡Œå·²ç»æœ‰éå¸¸æˆç†Ÿçš„åº”ç”¨ï¼Œå«ä½œæ§åˆ¶å›è·¯ï¼ˆControl Loopï¼‰ã€‚\nKubernetes å®˜æ–¹æ–‡æ¡£æ˜¯ä»¥æˆ¿é—´ä¸­ç©ºè°ƒè‡ªåŠ¨è°ƒèŠ‚æ¸©åº¦ä¸ºä¾‹å­ä»‹ç»äº†æ§åˆ¶å›è·¯çš„ä¸€èˆ¬å·¥ä½œè¿‡ç¨‹çš„ï¼šå½“ä½ è®¾ç½®å¥½äº†æ¸©åº¦ï¼Œå°±æ˜¯å‘Šè¯‰ç©ºè°ƒä½ å¯¹æ¸©åº¦çš„â€œæœŸæœ›çŠ¶æ€â€ï¼ˆDesired Stateï¼‰ï¼Œè€Œä¼ æ„Ÿå™¨æµ‹é‡å‡ºçš„æˆ¿é—´å®é™…æ¸©åº¦æ˜¯â€œå½“å‰çŠ¶æ€â€ï¼ˆCurrent Stateï¼‰ã€‚æ ¹æ®å½“å‰çŠ¶æ€ä¸æœŸæœ›çŠ¶æ€çš„å·®è·ï¼Œæ§åˆ¶å™¨å¯¹ç©ºè°ƒåˆ¶å†·çš„å¼€å…³è¿›è¡Œè°ƒèŠ‚æ§åˆ¶ï¼Œå°±èƒ½è®©å…¶å½“å‰çŠ¶æ€é€æ¸æ¥è¿‘æœŸæœ›çŠ¶æ€ã€‚\n\nå°†è¿™ç§æ§åˆ¶å›è·¯çš„æ€æƒ³è¿ç§»åº”ç”¨åˆ°å®¹å™¨ç¼–æ’ä¸Šï¼Œè‡ªç„¶ä¼šä¸º Kubernetes ä¸­çš„èµ„æºé™„åŠ ä¸Šäº†æœŸæœ›çŠ¶æ€ä¸å®é™…çŠ¶æ€ä¸¤é¡¹å±æ€§ã€‚ä¸è®ºæ˜¯å·²ç»å‡ºç°åœ¨ä¸ŠèŠ‚çš„èµ„æºæ¨¡å‹ä¸­ï¼Œç”¨äºæŠ½è±¡å®¹å™¨è¿è¡Œç¯å¢ƒçš„è®¡ç®—èµ„æºï¼Œè¿˜æ˜¯æ²¡æœ‰ç™»åœºçš„å¦ä¸€éƒ¨åˆ†å¯¹åº”äºå®‰å…¨ã€æœåŠ¡ã€ä»¤ç‰Œã€ç½‘ç»œç­‰åŠŸèƒ½çš„èµ„æºï¼Œç”¨æˆ·è¦æƒ³ä½¿ç”¨è¿™äº›èµ„æºæ¥å®ç°æŸç§éœ€æ±‚ï¼Œå¹¶ä¸æå€¡åƒå¹³å¸¸ç¼–ç¨‹é‚£æ ·å»è°ƒç”¨æŸä¸ªæˆ–æŸä¸€ç»„æ–¹æ³•æ¥è¾¾æˆç›®çš„ï¼Œè€Œæ˜¯é€šè¿‡æè¿°æ¸…æ¥šè¿™äº›èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œç”± Kubernetes ä¸­å¯¹åº”ç›‘è§†è¿™äº›èµ„æºçš„æ§åˆ¶å™¨æ¥é©±åŠ¨èµ„æºçš„å®é™…çŠ¶æ€é€æ¸å‘æœŸæœ›çŠ¶æ€é æ‹¢ï¼Œä»¥æ­¤æ¥è¾¾æˆç›®çš„ã€‚è¿™ç§äº¤äº’é£æ ¼è¢«ç§°ä¸ºæ˜¯ Kubernetes çš„å£°æ˜å¼ APIï¼Œå¦‚æœä½ å·²æœ‰è¿‡å®é™…æ“ä½œ Kubernetes çš„ç»éªŒï¼Œé‚£ä½ æ—¥å¸¸åœ¨å…ƒæ•°æ®æ–‡ä»¶ä¸­çš„specå­—æ®µæ‰€æè¿°çš„ä¾¿æ˜¯èµ„æºçš„æœŸæœ›çŠ¶æ€ã€‚\né¢å¤–çŸ¥è¯†ï¼šKubernates çš„èµ„æºå¯¹è±¡ä¸æ§åˆ¶å™¨\nç›®å‰ï¼ŒKubernetes å·²å†…ç½®æ”¯æŒç›¸å½“å¤šçš„èµ„æºå¯¹è±¡ï¼Œå¹¶ä¸”è¿˜å¯ä»¥ä½¿ç”¨CRDï¼ˆCustom Resource Definitionï¼‰æ¥è‡ªå®šä¹‰æ‰©å……ï¼Œä½ å¯ä»¥ä½¿ç”¨kubectl api-resourcesæ¥æŸ¥çœ‹å®ƒä»¬ã€‚ç¬”è€…æ ¹æ®ç”¨é€”åˆ†ç±»åˆ—ä¸¾äº†ä»¥ä¸‹å¸¸è§çš„èµ„æºï¼š\n\nç”¨äºæè¿°å¦‚ä½•åˆ›å»ºã€é”€æ¯ã€æ›´æ–°ã€æ‰©ç¼© Podï¼ŒåŒ…æ‹¬ï¼šAutoscalingï¼ˆHPAï¼‰ã€CronJobã€DaemonSetã€Deploymentã€Jobã€Podã€ReplicaSetã€StatefulSet\nç”¨äºé…ç½®ä¿¡æ¯çš„è®¾ç½®ä¸æ›´æ–°ï¼ŒåŒ…æ‹¬ï¼šConfigMapã€Secret\nç”¨äºæŒä¹…æ€§åœ°å­˜å‚¨æ–‡ä»¶æˆ–è€… Pod ä¹‹é—´çš„æ–‡ä»¶å…±äº«ï¼ŒåŒ…æ‹¬ï¼šVolumeã€LocalVolumeã€PersistentVolumeã€PersistentVolumeClaimã€StorageClass\nç”¨äºç»´æŠ¤ç½‘ç»œé€šä¿¡å’ŒæœåŠ¡è®¿é—®çš„å®‰å…¨ï¼ŒåŒ…æ‹¬ï¼šSecurityContextã€ServiceAccountã€Endpointã€NetworkPolicy\nç”¨äºå®šä¹‰æœåŠ¡ä¸è®¿é—®ï¼ŒåŒ…æ‹¬ï¼šIngressã€Serviceã€EndpointSlice\nç”¨äºåˆ’åˆ†è™šæ‹Ÿé›†ç¾¤ã€èŠ‚ç‚¹å’Œèµ„æºé…é¢ï¼ŒåŒ…æ‹¬ï¼šNamespaceã€Nodeã€ResourceQuota\n\nè¿™äº›èµ„æºåœ¨æ§åˆ¶å™¨ç®¡ç†æ¡†æ¶ä¸­ä¸€èˆ¬éƒ½ä¼šæœ‰ç›¸åº”çš„æ§åˆ¶å™¨æ¥ç®¡ç†ï¼Œç¬”è€…åˆ—ä¸¾å¸¸è§çš„æ§åˆ¶å™¨ï¼ŒæŒ‰ç…§å®ƒä»¬çš„å¯åŠ¨æƒ…å†µåˆ†ç±»å¦‚ä¸‹ï¼š\n\nå¿…é¡»å¯ç”¨çš„æ§åˆ¶å™¨ï¼šEndpointControllerã€ReplicationControllerã€PodGCControllerã€ResourceQuotaControllerã€NamespaceControllerã€ServiceAccountControllerã€GarbageCollectorControllerã€DaemonSetControllerã€JobControllerã€DeploymentControllerã€ReplicaSetControllerã€HPAControllerã€DisruptionControllerã€StatefulSetControllerã€CronJobControllerã€CSRSigningControllerã€CSRApprovingControllerã€TTLController\né»˜è®¤å¯ç”¨çš„å¯é€‰æ§åˆ¶å™¨ï¼Œå¯é€šè¿‡é€‰é¡¹ç¦æ­¢ï¼šTokenControllerã€NodeControllerã€ServiceControllerã€RouteControllerã€PVBinderControllerã€AttachDetachController\né»˜è®¤ç¦æ­¢çš„å¯é€‰æ§åˆ¶å™¨ï¼Œå¯é€šè¿‡é€‰é¡¹å¯ç”¨ï¼šBootstrapSignerControllerã€TokenCleanerController\n\nä¸èµ„æºç›¸å¯¹åº”ï¼Œåªè¦æ˜¯å®é™…çŠ¶æ€æœ‰å¯èƒ½å‘ç”Ÿå˜åŒ–çš„èµ„æºå¯¹è±¡ï¼Œé€šå¸¸éƒ½ä¼šç”±å¯¹åº”çš„æ§åˆ¶å™¨è¿›è¡Œè¿½è¸ªï¼Œæ¯ä¸ªæ§åˆ¶å™¨è‡³å°‘ä¼šè¿½è¸ªä¸€ç§ç±»å‹çš„èµ„æºã€‚ä¸ºäº†ç®¡ç†ä¼—å¤šèµ„æºæ§åˆ¶å™¨ï¼ŒKubernetes è®¾è®¡äº†ç»Ÿä¸€çš„æ§åˆ¶å™¨ç®¡ç†æ¡†æ¶ï¼ˆkube-controller-managerï¼‰æ¥ç»´æŠ¤è¿™äº›æ§åˆ¶å™¨çš„æ­£å¸¸è¿ä½œï¼Œä»¥åŠç»Ÿä¸€çš„æŒ‡æ ‡ç›‘è§†å™¨ï¼ˆkube-apiserverï¼‰æ¥ä¸ºæ§åˆ¶å™¨å·¥ä½œæ—¶æä¾›å…¶è¿½è¸ªèµ„æºçš„åº¦é‡æ•°æ®ã€‚\nç”±äºæ¯•ç«Ÿä¸æ˜¯åœ¨å†™ Kubernetes çš„æ“ä½œæ‰‹å†Œï¼Œç¬”è€…åªèƒ½é’ˆå¯¹ä¸¤ä¸‰ç§èµ„æºå’Œæ§åˆ¶å™¨ä¸ºä»£è¡¨æ¥ä¸¾ä¾‹è¯´æ˜ï¼Œè€Œæ— æ³•å°†æ¯ä¸ªæ§åˆ¶å™¨éƒ½è¯¦ç»†å±•å¼€è®²è§£ã€‚è¿™é‡Œåªè¦å°†åœºæ™¯å››è¿›ä¸€æ­¥å…·ä½“åŒ–ï¼Œè½¬æ¢æˆä¸‹é¢çš„åœºæ™¯äº”ï¼Œä¾¿å¯ä»¥å¾—åˆ°ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œä»¥éƒ¨ç½²æ§åˆ¶å™¨ï¼ˆDeployment Controllerï¼‰ã€å‰¯æœ¬é›†æ§åˆ¶å™¨ï¼ˆReplicaSet Controllerï¼‰å’Œè‡ªåŠ¨æ‰©ç¼©æ§åˆ¶å™¨ï¼ˆHPA Controllerï¼‰ä¸ºä¾‹æ¥ä»‹ç» Kubernetes æ§åˆ¶å™¨æ¨¡å¼çš„å·¥ä½œåŸç†ã€‚\n\nåœºæ™¯äº”ï¼šé€šè¿‡æœåŠ¡ç¼–æ’ï¼Œå¯¹ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿè‡ªåŠ¨å®ç°ä»¥ä¸‹ä¸‰ç§é€šç”¨çš„èƒ½åŠ›ï¼š\n\nPod å‡ºç°æ•…éšœæ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ¢å¤ï¼Œä¸ä¸­æ–­æœåŠ¡ï¼›\nPod æ›´æ–°ç¨‹åºæ—¶ï¼Œèƒ½å¤Ÿæ»šåŠ¨æ›´æ–°ï¼Œä¸ä¸­æ–­æœåŠ¡ï¼›\nPod é‡åˆ°å‹åŠ›æ—¶ï¼Œèƒ½å¤Ÿæ°´å¹³æ‰©å±•ï¼Œä¸ä¸­æ–­æœåŠ¡ï¼›\n\n\nå‰æ–‡æ›¾æåˆ°è™½ç„¶ Pod æœ¬èº«ä¹Ÿæ˜¯èµ„æºï¼Œå®Œå…¨å¯ä»¥ç›´æ¥åˆ›å»ºï¼Œä½†ç”± Pod ç›´æ¥æ„æˆçš„ç³»ç»Ÿæ˜¯ååˆ†è„†å¼±çš„ï¼ŒçŠ¹å¦‚æ°”çƒä¸­çš„å°ç”·å­©ï¼Œç”Ÿäº§ä¸­å¹¶ä¸æå€¡ã€‚æ­£ç¡®çš„åšæ³•æ˜¯é€šè¿‡å‰¯æœ¬é›†ï¼ˆReplicaSetï¼‰æ¥åˆ›å»º Podã€‚ReplicaSet ä¹Ÿæ˜¯ä¸€ç§èµ„æºï¼Œæ˜¯å±äºå·¥ä½œè´Ÿè·ä¸€ç±»çš„èµ„æºï¼Œå®ƒä»£è¡¨ä¸€ä¸ªæˆ–å¤šä¸ª Pod å‰¯æœ¬çš„é›†åˆï¼Œä½ å¯ä»¥åœ¨ ReplicaSet èµ„æºçš„å…ƒæ•°æ®ä¸­æè¿°ä½ æœŸæœ› Pod å‰¯æœ¬çš„æ•°é‡ï¼ˆå³spec.replicasçš„å€¼ï¼‰ã€‚å½“ ReplicaSet æˆåŠŸåˆ›å»ºä¹‹åï¼Œå‰¯æœ¬é›†æ§åˆ¶å™¨å°±ä¼šæŒç»­è·Ÿè¸ªè¯¥èµ„æºï¼Œå¦‚æœä¸€æ—¦æœ‰ Pod å‘ç”Ÿå´©æºƒé€€å‡ºï¼Œæˆ–è€…çŠ¶æ€å¼‚å¸¸ï¼ˆé»˜è®¤æ˜¯é è¿›ç¨‹è¿”å›å€¼ï¼Œä½ è¿˜å¯ä»¥åœ¨ Pod ä¸­è®¾ç½®æ¢é’ˆï¼Œä»¥è‡ªå®šä¹‰çš„æ–¹å¼å‘Šè¯‰ Kubernetes å‡ºç°ä½•ç§æƒ…å†µ Pod æ‰ç®—çŠ¶æ€å¼‚å¸¸ï¼‰ï¼ŒReplicaSet éƒ½ä¼šè‡ªåŠ¨åˆ›å»ºæ–°çš„ Pod æ¥æ›¿ä»£å¼‚å¸¸çš„ Podï¼›å¦‚æœå¼‚å¸¸å¤šå‡ºç°äº†é¢å¤–æ•°é‡çš„ Podï¼Œä¹Ÿä¼šè¢« ReplicaSet è‡ªåŠ¨å›æ”¶æ‰ï¼Œæ€»ä¹‹å°±æ˜¯ç¡®ä¿ä»»ä½•æ—¶å€™é›†ç¾¤ä¸­è¿™ä¸ª Pod å‰¯æœ¬çš„æ•°é‡éƒ½å‘æœŸæœ›çŠ¶æ€é æ‹¢ã€‚\nReplicaSet æœ¬èº«å°±èƒ½æ»¡è¶³åœºæ™¯äº”ä¸­çš„ç¬¬ä¸€é¡¹èƒ½åŠ›ï¼Œå¯ä»¥ä¿è¯ Pod å‡ºç°æ•…éšœæ—¶è‡ªåŠ¨æ¢å¤ï¼Œä½†æ˜¯åœ¨å‡çº§ç¨‹åºç‰ˆæœ¬æ—¶ï¼ŒReplicaSet ä¸å¾—ä¸ä¸»åŠ¨ä¸­æ–­æ—§ Pod çš„è¿è¡Œï¼Œé‡æ–°åˆ›å»ºæ–°ç‰ˆçš„ Podï¼Œè¿™ä¼šé€ æˆæœåŠ¡ä¸­æ–­ã€‚å¯¹äºé‚£äº›ä¸å…è®¸ä¸­æ–­çš„ä¸šåŠ¡ï¼Œä»¥å‰çš„ Kubernetes æ›¾ç»æä¾›è¿‡kubectl rolling-updateå‘½ä»¤æ¥è¾…åŠ©å®ç°æ»šåŠ¨æ›´æ–°ã€‚\næ‰€è°“æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updatesï¼‰æ˜¯æŒ‡å…ˆåœæ­¢å°‘é‡æ—§å‰¯æœ¬ï¼Œç»´æŒå¤§é‡æ—§å‰¯æœ¬ç»§ç»­æä¾›æœåŠ¡ï¼Œå½“åœæ­¢çš„æ—§å‰¯æœ¬æ›´æ–°æˆåŠŸï¼Œæ–°å‰¯æœ¬å¯ä»¥æä¾›æœåŠ¡ä»¥åï¼Œå†é‡å¤ä»¥ä¸Šæ“ä½œï¼Œç›´è‡³æ‰€æœ‰çš„å‰¯æœ¬éƒ½æ›´æ–°æˆåŠŸã€‚å°†è¿™ä¸ªè¿‡ç¨‹æ”¾åˆ° ReplicaSet ä¸Šï¼Œå°±æ˜¯å…ˆåˆ›å»ºæ–°ç‰ˆæœ¬çš„ ReplicaSetï¼Œç„¶åä¸€è¾¹è®©æ–° ReplicaSet é€æ­¥åˆ›å»ºæ–°ç‰ˆ Pod çš„å‰¯æœ¬ï¼Œä¸€è¾¹è®©æ—§çš„ ReplicaSet é€æ¸å‡å°‘æ—§ç‰ˆ Pod çš„å‰¯æœ¬ã€‚\nä¹‹æ‰€ä»¥kubectl rolling-updateå‘½ä»¤ä¼šè¢«æ·˜æ±°ï¼Œæ˜¯å› ä¸ºè¿™æ ·çš„å‘½ä»¤å¼äº¤äº’å®Œå…¨ä¸ç¬¦åˆ Kubernetes çš„è®¾è®¡ç†å¿µï¼ˆè¿™æ˜¯å°é¢ä¸Šçš„è¯´æ³•ï¼Œç¬”è€…è§‰å¾—æ·˜æ±°çš„æ ¹æœ¬åŸå› ä¸»è¦æ˜¯å› ä¸ºå®ƒä¸å¤Ÿå¥½ç”¨ï¼‰ï¼Œå¦‚æœä½ å¸Œæœ›æ”¹å˜æŸä¸ªèµ„æºçš„æŸç§çŠ¶æ€ï¼Œåº”è¯¥å°†æœŸæœ›çŠ¶æ€å‘Šè¯‰ Kubernetesï¼Œè€Œä¸æ˜¯å»æ•™ Kubernetes å…·ä½“è¯¥å¦‚ä½•æ“ä½œã€‚å› æ­¤ï¼Œæ–°çš„éƒ¨ç½²èµ„æºï¼ˆDeploymentï¼‰ä¸éƒ¨ç½²æ§åˆ¶å™¨è¢«è®¾è®¡å‡ºæ¥ï¼Œå¯ä»¥ç”± Deployment æ¥åˆ›å»º ReplicaSetï¼Œå†ç”± ReplicaSet æ¥åˆ›å»º Podï¼Œå½“ä½ æ›´æ–° Deployment ä¸­çš„ä¿¡æ¯ï¼ˆè­¬å¦‚æ›´æ–°äº†é•œåƒçš„ç‰ˆæœ¬ï¼‰ä»¥åï¼Œéƒ¨ç½²æ§åˆ¶å™¨å°±ä¼šè·Ÿè¸ªåˆ°ä½ æ–°çš„æœŸæœ›çŠ¶æ€ï¼Œè‡ªåŠ¨åœ°åˆ›å»ºæ–° ReplicaSetï¼Œå¹¶é€æ¸ç¼©å‡æ—§çš„ ReplicaSet çš„å‰¯æœ¬æ•°ï¼Œç›´è‡³å‡çº§å®Œæˆåå½»åº•åˆ é™¤æ‰æ—§ ReplicaSetï¼Œå¦‚å›¾ 11-6 æ‰€ç¤ºã€‚\n\nå¯¹äºåœºæ™¯äº”çš„æœ€åä¸€ç§æƒ…å†µï¼Œé‡åˆ°æµé‡å‹åŠ›æ—¶ï¼Œç®¡ç†å‘˜å®Œå…¨å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ Deployment ä¸­çš„å‰¯æœ¬æ•°é‡ï¼Œæˆ–è€…é€šè¿‡kubectl scaleå‘½ä»¤æŒ‡å®šå‰¯æœ¬æ•°é‡ï¼Œä¿ƒä½¿ Kubernetes éƒ¨ç½²æ›´å¤šçš„ Pod å‰¯æœ¬æ¥åº”å¯¹å‹åŠ›ï¼Œç„¶è€Œè¿™ç§æ‰©å®¹æ–¹å¼ä¸ä»…éœ€è¦äººå·¥å‚ä¸ï¼Œä¸”åªé äººç±»ç»éªŒæ¥åˆ¤æ–­éœ€è¦æ‰©å®¹çš„å‰¯æœ¬æ•°é‡ï¼Œä¸å®¹æ˜“åšåˆ°ç²¾ç¡®ä¸åŠæ—¶ã€‚ä¸ºæ­¤ Kubernetes åˆæä¾›äº† Autoscaling èµ„æºå’Œè‡ªåŠ¨æ‰©ç¼©æ§åˆ¶å™¨ï¼Œèƒ½å¤Ÿè‡ªåŠ¨æ ¹æ®åº¦é‡æŒ‡æ ‡ï¼Œå¦‚å¤„ç†å™¨ã€å†…å­˜å ç”¨ç‡ã€ç”¨æˆ·è‡ªå®šä¹‰çš„åº¦é‡å€¼ç­‰ï¼Œæ¥è®¾ç½® Deploymentï¼ˆæˆ–è€… ReplicaSetï¼‰çš„æœŸæœ›çŠ¶æ€ï¼Œå®ç°å½“åº¦é‡æŒ‡æ ‡å‡ºç°å˜åŒ–æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æŒ‰ç…§â€œAutoscalingâ†’Deploymentâ†’ReplicaSetâ†’Podâ€è¿™æ ·çš„é¡ºåºå±‚å±‚å˜æ›´ï¼Œæœ€ç»ˆå®ç°æ ¹æ®åº¦é‡æŒ‡æ ‡è‡ªåŠ¨æ‰©å®¹ç¼©å®¹ã€‚\næ•…éšœæ¢å¤ã€æ»šåŠ¨æ›´æ–°ã€è‡ªåŠ¨æ‰©ç¼©è¿™äº›ç‰¹æ€§ï¼Œåœ¨äº‘åŸç”Ÿä¸­æ—¶ä»£é‡Œå¸¸è¢«æ¦‚æ‹¬æˆæœåŠ¡çš„å¼¹æ€§ï¼ˆElasticityï¼‰ä¸éŸ§æ€§ï¼ˆResilienceï¼‰ï¼ŒReplicaSetã€Deploymentã€Autoscaling çš„ç”¨æ³•ï¼Œä¹Ÿå±äºæ˜¯æ‰€æœ‰ Kubernetes æ•™æèµ„æ–™éƒ½ä¼šè®²åˆ°çš„â€œåŸºç¡€å¿…ä¿®è¯¾â€ã€‚å¦‚æœä½ å‡†å¤‡å­¦ä¹  Kubernetes æˆ–è€…å…¶ä»–äº‘åŸç”Ÿç›¸å…³æŠ€æœ¯ï¼Œç¬”è€…å»ºè®®æœ€å¥½ä¸è¦æ­»è®°ç¡¬èƒŒåœ°å­¦ä¹ æ¯ä¸ªèµ„æºçš„å…ƒæ•°æ®æ–‡ä»¶è¯¥å¦‚ä½•ç¼–å†™ã€æœ‰å“ªäº›æŒ‡ä»¤ã€æœ‰å“ªäº›åŠŸèƒ½ï¼Œæ›´å¥½çš„æ–¹å¼æ˜¯ç«™åœ¨è§£å†³é—®é¢˜çš„è§’åº¦å»ç†è§£ä¸ºä»€ä¹ˆ Kubernetes è¦è®¾è®¡è¿™äº›èµ„æºå’Œæ§åˆ¶å™¨ï¼Œç†è§£ä¸ºä»€ä¹ˆè¿™äº›èµ„æºå’Œæ§åˆ¶å™¨ä¼šè¢«è®¾è®¡æˆç°åœ¨è¿™ç§æ ·å­ã€‚\nå¦‚æœä½ è§‰å¾—å·²ç»ç†è§£äº†å‰é¢çš„å‡ ç§èµ„æºå’Œæ§åˆ¶å™¨çš„ä¾‹å­ï¼Œé‚£ä¸å¦¨æ€è€ƒä¸€ä¸‹ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼šå‡è®¾æˆ‘æƒ³é™åˆ¶æŸä¸ª Pod æŒæœ‰çš„æœ€å¤§å­˜å‚¨å·æ•°é‡ï¼Œåº”è¯¥ä¼šå¦‚ä½•è®¾è®¡ï¼Ÿå‡è®¾é›†ç¾¤ä¸­æŸä¸ª Node å‘ç”Ÿç¡¬ä»¶æ•…éšœï¼ŒKubernetes è¦è®©è°ƒåº¦ä»»åŠ¡é¿å¼€è¿™ä¸ª Nodeï¼Œåº”è¯¥å¦‚ä½•è®¾è®¡ï¼Ÿå‡è®¾ä¸€æ—¦è¿™ä¸ª Node é‡æ–°æ¢å¤ï¼ŒKubernetes è¦èƒ½å°½å¿«åˆ©ç”¨ä¸Šé¢çš„èµ„æºï¼Œåˆè¯¥å¦‚ä½•å»è®¾è®¡ï¼Ÿåªè¦ä½ çœŸæ­£æ¥å—äº†èµ„æºä¸æ§åˆ¶å™¨æ˜¯è´¯ç©¿æ•´ä¸ª Kubernetes çš„ä¸¤å¤§è®¾è®¡ç†å¿µï¼Œå³ä¾¿ä¸å»æŸ¥æ–‡æ¡£æ‰‹å†Œï¼Œä¹Ÿåº”è¯¥èƒ½æ¨æƒ³å‡ºä¸ªå¤§æ¦‚è½®å»“ï¼Œä»¥æ­¤ä¸ºåŸºç¡€å½“ä½ å†å»çœ‹æ‰‹å†Œæˆ–è€…æºç æ—¶ï¼Œæƒ³å¿…å°±èƒ½å¤Ÿäº‹åŠåŠŸå€ã€‚\nä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„å°è£…çœ‹å®Œå®¹å™¨æŠ€æœ¯å‘å±•çš„å†ç¨‹ï¼Œä¸çŸ¥ä½ ä¼šä¸ä¼šæ„Ÿåˆ°æœ‰ç§â€œå¥—å¨ƒå¼â€çš„è¿·æƒ‘æ„Ÿï¼Ÿå®¹å™¨çš„å´›èµ·ç¼˜äº chrootã€namespacesã€cgroups ç­‰å†…æ ¸æä¾›çš„éš”ç¦»èƒ½åŠ›ï¼Œç³»ç»Ÿçº§è™šæ‹ŸåŒ–æŠ€æœ¯ä½¿å¾—åŒä¸€å°æœºå™¨ä¸Šäº’ä¸å¹²æ‰°åœ°è¿è¡Œå¤šä¸ªæœåŠ¡æˆä¸ºå¯èƒ½ï¼›ä¸ºäº†é™ä½ç”¨æˆ·ä½¿ç”¨å†…æ ¸éš”ç¦»èƒ½åŠ›çš„é—¨æ§›ï¼Œéšåå‡ºç°äº† LXCï¼Œå®ƒæ˜¯ namespacesã€cgroups ç‰¹æ€§çš„ä¸Šå±‚å°è£…ï¼Œä½¿å¾—â€œå®¹å™¨â€ä¸€è¯çœŸæ­£èµ°å‡ºå®éªŒå®¤ï¼Œèµ°å…¥å·¥ä¸šç•Œå®é™…åº”ç”¨ï¼›ä¸ºäº†å®ç°è·¨æœºå™¨çš„è½¯ä»¶ç»¿è‰²éƒ¨ç½²ï¼Œå‡ºç°äº† Dockerï¼Œå®ƒï¼ˆæœ€åˆï¼‰æ˜¯ LXC çš„ä¸Šå±‚å°è£…ï¼Œå½»åº•æ”¹å˜äº†è½¯ä»¶æ‰“åŒ…åˆ†å‘çš„æ–¹å¼ï¼Œè¿…é€Ÿè¢«å¤§é‡ä¼ä¸šå¹¿æ³›é‡‡ç”¨ï¼›ä¸ºäº†æ»¡è¶³å¤§å‹ç³»ç»Ÿå¯¹æœåŠ¡é›†ç¾¤åŒ–çš„éœ€è¦ï¼Œå‡ºç°äº† Kubernetesï¼Œå®ƒï¼ˆæœ€åˆï¼‰æ˜¯ Docker çš„ä¸Šå±‚å°è£…ï¼Œè®©ä»¥å¤šä¸ªå®¹å™¨å…±åŒåä½œæ„å»ºå‡ºå¥å£®çš„åˆ†å¸ƒå¼ç³»ç»Ÿï¼Œæˆä¸ºä»Šå¤©äº‘åŸç”Ÿæ—¶ä»£çš„æŠ€æœ¯åŸºç¡€è®¾æ–½ã€‚\né‚£ Kubernetes ä¼šæ˜¯å®¹å™¨åŒ–å´›èµ·ä¹‹è·¯çš„ç»ˆç‚¹çº¿å—ï¼Ÿå®ƒè¾¾åˆ°äº†äººä»¬å¯¹äº‘åŸç”Ÿæ—¶ä»£æŠ€æœ¯åŸºç¡€è®¾æ–½çš„æœŸæœ›äº†å—ï¼Ÿä»èƒ½åŠ›è§’åº¦è®²ï¼Œæ˜¯å¯ä»¥è¯´æ˜¯çš„ï¼ŒKubernetes è¢«èª‰ä¸ºäº‘åŸç”Ÿæ—¶ä»£çš„æ“ä½œç³»ç»Ÿï¼Œè‡ªè¯ç”Ÿä¹‹æ—¥èµ·å°±å› å…¶å‡ºè‰²çš„ç®¡ç†èƒ½åŠ›ã€æ‰©å±•æ€§ä¸ä»¥å£°æ˜ä»£æ›¿å‘½ä»¤çš„äº¤äº’ç†å¿µæ”¶è·äº†æ— æ•°å–å½©å£°ï¼›ä½†æ˜¯ï¼Œä»æ˜“ç”¨è§’åº¦è®²ï¼Œå¦ç™½è¯´å·®è·è¿˜éå¸¸å¤§ï¼Œäº‘åŸç”ŸåŸºç¡€è®¾æ–½çš„å…¶ä¸­ä¸€ä¸ªé‡è¦ç›®æ ‡æ˜¯æ¥ç®¡æ‰ä¸šåŠ¡ç³»ç»Ÿå¤æ‚çš„éåŠŸèƒ½ç‰¹æ€§ï¼Œè®©ä¸šåŠ¡ç ”å‘ä¸è¿ç»´å·¥ä½œå˜å¾—è¶³å¤Ÿç®€å•ï¼Œä¸å—åˆ†å¸ƒå¼çš„ç‰µç»Šï¼Œç„¶è€Œ Kubernetes è¢«è¯Ÿç—…å¾—æœ€å¤šçš„å°±æ˜¯å¤æ‚ï¼Œè‡ªè¯ç”Ÿä¹‹æ—¥èµ·å°±ä»¥é™¡å³­çš„å­¦ä¹ æ›²çº¿è€Œé—»åã€‚\nä¸¾ä¸ªå…·ä½“ä¾‹å­ï¼Œç”¨ Kubernetes éƒ¨ç½²ä¸€å¥—Spring Cloud ç‰ˆçš„ Fenixâ€™s Bookstoreï¼Œä½ éœ€è¦åˆ†åˆ«éƒ¨ç½²ä¸€ä¸ªåˆ°å¤šä¸ªçš„é…ç½®ä¸­å¿ƒã€æ³¨å†Œä¸­å¿ƒã€æœåŠ¡ç½‘å…³ã€å®‰å…¨è®¤è¯ã€ç”¨æˆ·æœåŠ¡ã€å•†å“æœåŠ¡ã€äº¤æ˜“æœåŠ¡ï¼Œå¯¹æ¯ä¸ªå¾®æœåŠ¡éƒ½é…ç½®å¥½ç›¸åº”çš„ Kubernetes å·¥ä½œè´Ÿè½½ä¸æœåŠ¡è®¿é—®ï¼Œä¸ºæ¯ä¸€ä¸ªå¾®æœåŠ¡çš„ Deploymentã€ConfigMapã€StatefulSetã€HPAã€Serviceã€ServiceAccountã€Ingress ç­‰èµ„æºéƒ½ç¼–å†™å¥½å…ƒæ•°æ®é…ç½®ã€‚è¿™ä¸ªè¿‡ç¨‹æœ€éš¾çš„åœ°æ–¹ä¸ä»…åœ¨äºç¹çï¼Œè¿˜åœ¨äºè¦å†™å‡ºåˆé€‚çš„å…ƒæ•°æ®æè¿°æ–‡ä»¶ï¼Œæ—¢éœ€è¦æ‡‚çš„å¼€å‘ï¼ˆç½‘å…³ä¸­æœåŠ¡è°ƒç”¨å…³ç³»ã€ä½¿ç”¨å®¹å™¨çš„é•œåƒç‰ˆæœ¬ã€è¿è¡Œä¾èµ–çš„ç¯å¢ƒå˜é‡è¿™äº›å‚æ•°ç­‰ç­‰ï¼Œåªæœ‰å¼€å‘æœ€æ¸…æ¥šï¼‰ï¼Œåˆéœ€è¦æ‡‚è¿ç»´ï¼ˆè¦éƒ¨ç½²å¤šå°‘ä¸ªæœåŠ¡ï¼Œé…ç½®ä½•ç§æ‰©å®¹ç¼©å®¹ç­–ç•¥ã€æ•°æ®åº“çš„å¯†é’¥æ–‡ä»¶åœ°å€ç­‰ç­‰ï¼Œåªæœ‰è¿ç»´æœ€æ¸…æ¥šï¼‰ï¼Œæœ‰æ—¶å€™è¿˜éœ€è¦æ‡‚å¹³å°ï¼ˆéœ€è¦ä»€ä¹ˆçš„è°ƒåº¦ç­–ç•¥ï¼Œå¦‚ä½•ç®¡ç†é›†ç¾¤èµ„æºï¼Œé€šå¸¸åªæœ‰å¹³å°ç»„ã€ä¸­é—´ä»¶ç»„æˆ–è€…æ ¸å¿ƒç³»ç»Ÿç»„çš„åŒå­¦æ‰ä¼šå…³å¿ƒï¼‰ï¼Œä¸€èˆ¬ä¼ä¸šæ ¹æœ¬æ‰¾ä¸åˆ°åˆé€‚çš„è§’è‰²æ¥ä¸ºå®ƒç®¡ç†ã€éƒ¨ç½²å’Œç»´æŠ¤åº”ç”¨ã€‚\nè¿™ä¸ªäº‹å„¿ Kubernetes å¿ƒé‡Œå…¶å®ä¹ŸæŒºå§”å±ˆï¼Œå› ä¸ºä»¥ä¸Šå¤æ‚æ€§ä¸èƒ½è¯´æ˜¯ Kubernetes å¸¦æ¥çš„ï¼Œè€Œæ˜¯åˆ†å¸ƒå¼æ¶æ„æœ¬èº«çš„åŸç½ªã€‚å¯¹äºå¤§è§„æ¨¡çš„åˆ†å¸ƒå¼é›†ç¾¤ï¼Œæ— è®ºæ˜¯æœ€ç»ˆç”¨æˆ·éƒ¨ç½²åº”ç”¨ï¼Œè¿˜æ˜¯è½¯ä»¶å…¬å¸ç®¡ç†åº”ç”¨éƒ½å­˜åœ¨è¯¸å¤šç—›ç‚¹ã€‚è¿™äº›å›°éš¾çš„å®è´¨æºäº Docker å®¹å™¨é•œåƒå°è£…äº†å•ä¸ªæœåŠ¡ï¼ŒKubernetes é€šè¿‡èµ„æºå°è£…äº†æœåŠ¡é›†ç¾¤ï¼Œå´æ²¡æœ‰ä¸€ä¸ªè½½ä½“çœŸæ­£å°è£…æ•´ä¸ªåº”ç”¨ï¼Œå°†åŸæœ¬å±äºåº”ç”¨å†…éƒ¨çš„æŠ€æœ¯ç»†èŠ‚åœˆç¦èµ·æ¥ï¼Œä¸è¦æš´éœ²ç»™æœ€ç»ˆç”¨æˆ·ã€ç³»ç»Ÿç®¡ç†å‘˜å’Œå¹³å°ç»´æŠ¤è€…ï¼Œè®©ä½¿ç”¨è€…å»åŸ‹å•ï¼›åº”ç”¨éš¾ä»¥ç®¡ç†çŸ›ç›¾åœ¨äºå°è£…åº”ç”¨çš„æ–¹æ³•æ²¡èƒ½å°†å¼€å‘ã€è¿ç»´ã€å¹³å°ç­‰å„ç§è§’è‰²çš„å…³æ³¨ç‚¹æ°å½“åœ°åˆ†ç¦»ã€‚\næ—¢ç„¶å¾®æœåŠ¡æ—¶ä»£ï¼Œåº”ç”¨çš„å½¢å¼å·²ç»ä¸å†é™äºå•ä¸ªè¿›ç¨‹ï¼Œé‚£ä¹Ÿè¯¥åˆ°äº†é‡æ–°å®šä¹‰â€œä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„å°è£…â€è¿™å¥è¯çš„æ—¶å€™äº†ã€‚è‡³äºå…·ä½“æ€æ ·çš„å°è£…æ‰ç®—æ˜¯æ­£ç¡®ï¼Œä»Šå¤©è¿˜æœªæœ‰ç‰¹åˆ«æƒå¨çš„ç»“è®ºï¼Œä¸è¿‡ç»è¿‡äººä»¬çš„å°è¯•æ¢ç´¢ï¼Œå·²ç»çª¥è§æœªæ¥å®¹å™¨åº”ç”¨çš„ä¸€äº›é›å½¢ï¼Œç¬”è€…å°†è¿‘å‡ å¹´æ¥ç ”ç©¶çš„å‡ ç§ä¸»æµæ€è·¯åˆ—å‡ºä¾›ä½ å‚è€ƒã€‚\nKustomizeæœ€åˆï¼Œç”± Kubernetes å®˜æ–¹ç»™å‡ºâ€œå¦‚ä½•å°è£…åº”ç”¨â€çš„è§£å†³æ–¹æ¡ˆæ˜¯â€œç”¨é…ç½®æ–‡ä»¶æ¥é…ç½®é…ç½®æ–‡ä»¶â€ï¼Œè¿™ä¸æ˜¯ç»•å£ä»¤ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸€ç§é’ˆå¯¹ YAML çš„æ¨¡ç‰ˆå¼•æ“çš„å˜ä½“ã€‚Kubernetes å®˜æ–¹è®¤ä¸ºåº”ç”¨å°±æ˜¯ä¸€ç»„å…·æœ‰ç›¸åŒç›®æ ‡çš„ Kubernetes èµ„æºçš„é›†åˆï¼Œå¦‚æœé€ä¸€ç®¡ç†ã€éƒ¨ç½²æ¯é¡¹èµ„æºå…ƒæ•°æ®è¿‡äºç¹ççš„è¯ï¼Œé‚£å°±æä¾›ä¸€ç§ä¾¿æ·çš„æ–¹å¼ï¼ŒæŠŠåº”ç”¨ä¸­ä¸å˜çš„ä¿¡æ¯ä¸æ˜“å˜çš„ä¿¡æ¯åˆ†ç¦»å¼€æ¥è§£å†³ç®¡ç†é—®é¢˜ï¼ŒæŠŠåº”ç”¨æ‰€æœ‰æ¶‰åŠçš„èµ„æºè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå¤šåˆä¸€ï¼ˆAll-in-Oneï¼‰çš„æ•´åˆåŒ…æ¥è§£å†³éƒ¨ç½²é—®é¢˜ã€‚\nå®Œæˆè¿™é¡¹å·¥ä½œçš„å·¥å…·å«ä½œKustomizeï¼Œå®ƒåŸæœ¬åªæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å°ç¨‹åºï¼Œä» Kubernetes 1.14 èµ·ï¼Œè¢«å¸çº³å…¥kubectlå‘½ä»¤ä¹‹ä¸­ï¼Œæˆä¸ºéšç€ Kubernetes æä¾›çš„å†…ç½®åŠŸèƒ½ã€‚Kustomize ä½¿ç”¨Kustomization æ–‡ä»¶æ¥ç»„ç»‡ä¸åº”ç”¨ç›¸å…³çš„æ‰€æœ‰èµ„æºï¼ŒKustomization æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªä»¥ YAML æ ¼å¼ç¼–å†™çš„é…ç½®æ–‡ä»¶ï¼Œé‡Œé¢å®šä¹‰äº†æ„æˆåº”ç”¨çš„å…¨éƒ¨èµ„æºï¼Œä»¥åŠèµ„æºä¸­éœ€æ ¹æ®æƒ…å†µè¢«è¦†ç›–çš„å˜é‡å€¼ã€‚\nKustomize çš„ä¸»è¦ä»·å€¼æ˜¯æ ¹æ®ç¯å¢ƒæ¥ç”Ÿæˆä¸åŒçš„éƒ¨ç½²é…ç½®ã€‚åªè¦å»ºç«‹å¤šä¸ª Kustomization æ–‡ä»¶ï¼Œå¼€å‘äººå‘˜å°±èƒ½ä»¥åŸºäºåŸºå‡†è¿›è¡Œæ´¾ç”Ÿï¼ˆBase and Overlayï¼‰çš„æ–¹å¼ï¼Œå¯¹ä¸åŒçš„æ¨¡å¼ï¼ˆè­¬å¦‚ç”Ÿäº§æ¨¡å¼ã€è°ƒè¯•æ¨¡å¼ï¼‰ã€ä¸åŒçš„é¡¹ç›®ï¼ˆåŒä¸€ä¸ªäº§å“å¯¹ä¸åŒå®¢æˆ·çš„å®¢åˆ¶åŒ–ï¼‰å®šåˆ¶å‡ºä¸åŒçš„èµ„æºæ•´åˆåŒ…ã€‚åœ¨é…ç½®æ–‡ä»¶é‡Œï¼Œæ— è®ºæ˜¯å¼€å‘å…³å¿ƒçš„ä¿¡æ¯ï¼Œè¿˜æ˜¯è¿ç»´å…³å¿ƒçš„ä¿¡æ¯ï¼Œåªè¦æ˜¯åœ¨å…ƒæ•°æ®ä¸­æœ‰æè¿°çš„å†…å®¹ï¼Œæœ€åˆéƒ½æ˜¯ç”±å¼€å‘äººå‘˜æ¥ç¼–å†™çš„ï¼Œç„¶ååœ¨ç¼–è¯‘æœŸé—´ç”±è´Ÿè´£ CI/CD çš„äº§å“äººå‘˜é’ˆå¯¹é¡¹ç›®è¿›è¡Œå®šåˆ¶ï¼Œæœ€ååœ¨éƒ¨ç½²æœŸé—´ç”±è¿ç»´äººå‘˜é€šè¿‡ kubectl çš„è¡¥ä¸ï¼ˆPatchï¼‰æœºåˆ¶æ›´æ”¹å…¶ä¸­éœ€è¦è¿ç»´å»å…³æ³¨çš„å±æ€§ï¼Œè­¬å¦‚æ„é€ ä¸€ä¸ªè¡¥ä¸æ¥å¢åŠ  Deployment çš„å‰¯æœ¬ä¸ªæ•°ï¼Œæ„é€ å¦å¤–ä¸€ä¸ªè¡¥ä¸æ¥è®¾ç½® Pod çš„å†…å­˜é™åˆ¶ï¼Œç­‰ç­‰ã€‚\nk8s â”œâ”€â”€ base â”‚     â”œâ”€â”€ deployment.yaml â”‚     â”œâ”€â”€ kustomization.yaml â”‚     â””â”€â”€ service.yaml â””â”€â”€ overlays       â””â”€â”€ prod       â”‚     â”œâ”€â”€ load-loadbalancer-service.yaml       â”‚     â””â”€â”€ kustomization.yaml       â””â”€â”€ debug             â””â”€â”€ kustomization.yaml\n\nKustomize ä½¿ç”¨ Baseã€Overlay å’Œ Patch ç”Ÿæˆæœ€ç»ˆé…ç½®æ–‡ä»¶çš„æ€è·¯ä¸ Docker ä¸­åˆ†å±‚é•œåƒçš„æ€è·¯æœ‰äº›ç›¸ä¼¼ï¼Œæ—¢è§„é¿äº†ä»¥â€œå­—ç¬¦æ›¿æ¢â€å¯¹èµ„æºå…ƒæ•°æ®æ–‡ä»¶çš„å…¥ä¾µï¼Œä¹Ÿä¸éœ€è¦ç”¨æˆ·å­¦ä¹ é¢å¤–çš„ DSL è¯­æ³•ï¼ˆè­¬å¦‚ Luaï¼‰ã€‚ä»æ•ˆæœæ¥çœ‹ï¼Œä½¿ç”¨ç”± Kustomize ç¼–è¯‘ç”Ÿæˆçš„ All-in-One æ•´åˆåŒ…æ¥éƒ¨ç½²åº”ç”¨æ˜¯ç›¸å½“æ–¹ä¾¿çš„ï¼Œåªè¦ä¸€è¡Œå‘½ä»¤å°±èƒ½å¤ŸæŠŠåº”ç”¨æ¶‰åŠçš„æ‰€æœ‰æœåŠ¡ä¸€æ¬¡å®‰è£…å¥½ï¼Œæœ¬æ–‡æ¡£é™„å¸¦çš„Kubernetes ç‰ˆæœ¬å’ŒIstio ç‰ˆæœ¬çš„ Fenixâ€™s Booktstore éƒ½ä½¿ç”¨äº†è¿™ç§æ–¹å¼æ¥å‘å¸ƒåº”ç”¨çš„ï¼Œä½ ä¸å¦¨å®é™…ä½“éªŒä¸€ä¸‹ã€‚\nä½†æ˜¯æ¯•ç«Ÿ Kustomize åªæ˜¯ä¸€ä¸ªâ€œå°å·¥å…·â€æ€§è´¨çš„è¾…åŠ©åŠŸèƒ½ï¼Œå¯¹äºå¼€å‘äººå‘˜ï¼ŒKustomize åªèƒ½ç®€åŒ–äº§å“é’ˆå¯¹ä¸åŒæƒ…å†µçš„é‡å¤é…ç½®ï¼Œå…¶å®å¹¶æ²¡æœ‰çœŸæ­£è§£å†³åº”ç”¨ç®¡ç†å¤æ‚çš„é—®é¢˜ï¼Œè¦åšçš„äº‹ã€è¦å†™çš„é…ç½®ï¼Œæœ€ç»ˆéƒ½æ²¡æœ‰å‡å°‘ï¼Œåªæ˜¯ä¸ç”¨åå¤å»å†™ç½¢äº†ï¼›å¯¹äºè¿ç»´äººå‘˜ï¼Œåº”ç”¨ç»´æŠ¤ä¸ä»…ä»…åªæ˜¯éƒ¨ç½²é‚£ä¸€ä¸‹ï¼Œåº”ç”¨çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œé™¤äº†å®‰è£…å¤–è¿˜æœ‰æ›´æ–°ã€å›æ»šã€å¸è½½ã€å¤šç‰ˆæœ¬ã€å¤šå®ä¾‹ã€ä¾èµ–é¡¹ç»´æŠ¤ç­‰è¯¸å¤šé—®é¢˜éƒ½å¾ˆéº»çƒ¦ã€‚è¿™äº›é—®é¢˜éœ€è¦æ›´åŠ å¼ºå¤§çš„ç®¡ç†å·¥å…·å»è§£å†³ï¼Œè­¬å¦‚ä¸‹ä¸€èŠ‚çš„ä¸»è§’ Helmã€‚ä¸è¿‡ Kustomize èƒ½å¤Ÿä»¥æå°çš„æˆæœ¬ï¼Œåœ¨ä¸€å®šç¨‹åº¦ä¸Šåˆ†ç¦»äº†å¼€å‘å’Œè¿ç»´çš„å·¥ä½œï¼Œæ— éœ€åƒ Helm é‚£æ ·éœ€è¦ä¸€å¥—ç‹¬ç«‹çš„ä½“ç³»æ¥ç®¡ç†åº”ç”¨ï¼Œè¿™ç§è½»é‡ä¾¿æ·ï¼Œæœ¬èº«ä¹Ÿæ˜¯ä¸€ç§å¯è´µçš„ä»·å€¼ã€‚\nHelm ä¸ Chartå¦ä¸€ç§æ›´å…·ç³»ç»Ÿæ€§çš„ç®¡ç†å’Œå°è£…åº”ç”¨çš„è§£å†³æ–¹æ¡ˆå‚è€ƒäº†å„å¤§ Linux å‘è¡Œç‰ˆç®¡ç†åº”ç”¨çš„æ€è·¯ï¼Œä»£è¡¨ä¸ºDeis å…¬å¸å¼€å‘çš„Helmå’Œå®ƒçš„åº”ç”¨æ ¼å¼ Chartã€‚Helm ä¸€å¼€å§‹çš„ç›®æ ‡å°±å¾ˆæ˜ç¡®ï¼šå¦‚æœè¯´ Kubernetes æ˜¯äº‘åŸç”Ÿæ“ä½œç³»ç»Ÿçš„è¯ï¼Œé‚£ Helm å°±è¦æˆä¸ºè¿™ä¸ªæ“ä½œç³»ç»Ÿä¸Šé¢çš„åº”ç”¨å•†åº—ä¸åŒ…ç®¡ç†å·¥å…·ã€‚\nLinux ä¸‹çš„åŒ…ç®¡ç†å·¥å…·å’Œå°è£…æ ¼å¼ï¼Œå¦‚ Debian ç³»çš„ apt-get å‘½ä»¤ä¸ dpkg æ ¼å¼ã€RHEL ç³»çš„ yum å‘½ä»¤ä¸ rpm æ ¼å¼ç›¸ä¿¡å¤§å®¶è‚¯å®šä¸é™Œç”Ÿã€‚æœ‰äº†åŒ…ç®¡ç†å·¥å…·ï¼Œä½ åªè¦çŸ¥é“åº”ç”¨çš„åç§°ï¼Œå°±å¯ä»¥å¾ˆæ–¹ä¾¿åœ°ä»åº”ç”¨ä»“åº“ä¸­ä¸‹è½½ã€å®‰è£…ã€å‡çº§ã€éƒ¨ç½²ã€å¸è½½ã€å›æ»šç¨‹åºï¼Œè€Œä¸”åŒ…ç®¡ç†å·¥å…·è‡ªå·±æŒæ¡ç€åº”ç”¨çš„ä¾èµ–ä¿¡æ¯å’Œç‰ˆæœ¬å˜æ›´æƒ…å†µï¼Œå…·å¤‡å®Œæ•´çš„è‡ªç®¡ç†èƒ½åŠ›ï¼Œæ¯ä¸ªåº”ç”¨éœ€è¦ä¾èµ–å“ªäº›å‰ç½®çš„ç¬¬ä¸‰æ–¹åº“ï¼Œåœ¨å®‰è£…çš„æ—¶å€™éƒ½ä¼šä¸€å¹¶å¤„ç†å¥½ã€‚\nHelm æ¨¡æ‹Ÿçš„å°±æ˜¯ä¸Šé¢è¿™ç§åšæ³•ï¼Œå®ƒæå‡ºäº†ä¸ Linux åŒ…ç®¡ç†ç›´æ¥å¯¹åº”çš„ Chart æ ¼å¼å’Œ Repository åº”ç”¨ä»“åº“ï¼Œé’ˆå¯¹ Kubernetes ä¸­ç‰¹æœ‰çš„ä¸€ä¸ªåº”ç”¨ç»å¸¸è¦éƒ¨ç½²å¤šä¸ªç‰ˆæœ¬çš„ç‰¹ç‚¹ï¼Œä¹Ÿæå‡ºäº† Release çš„ä¸“æœ‰æ¦‚å¿µã€‚\nChart ç”¨äºå°è£… Kubernetes åº”ç”¨æ¶‰åŠåˆ°çš„æ‰€æœ‰èµ„æºï¼Œé€šå¸¸ä»¥ç›®å½•å†…çš„æ–‡ä»¶é›†åˆçš„å½¢å¼å­˜åœ¨ã€‚ç›®å½•åç§°å°±æ˜¯ Chart çš„åç§°ï¼ˆæ²¡æœ‰ç‰ˆæœ¬ä¿¡æ¯ï¼‰ï¼Œè­¬å¦‚å®˜æ–¹ä»“åº“ä¸­ WordPress Chart çš„ç›®å½•ç»“æ„æ˜¯è¿™æ ·çš„ï¼š\nWordPress â”œâ”€â”€ templates â”‚     â”œâ”€â”€ NOTES.txt â”‚     â”œâ”€â”€ deployment.yaml â”‚     â”œâ”€â”€ externaldb-secrets.yaml â”‚     â””â”€â”€ ç‰ˆé¢åŸå› çœç•¥å…¶ä»–èµ„æºæ–‡ä»¶ â”‚     â””â”€â”€ ingress.yaml â””â”€â”€ Chart.yaml â””â”€â”€ requirements.yaml â””â”€â”€ values.yaml\n\nå…¶ä¸­æœ‰å‡ ä¸ªå›ºå®šçš„é…ç½®æ–‡ä»¶ï¼šChart.yamlç»™å‡ºäº†åº”ç”¨è‡ªèº«çš„è¯¦ç»†ä¿¡æ¯ï¼ˆåç§°ã€ç‰ˆæœ¬ã€è®¸å¯è¯ã€è‡ªè¿°ã€è¯´æ˜ã€å›¾æ ‡ï¼Œç­‰ç­‰ï¼‰ï¼Œrequirements.yamlç»™å‡ºäº†åº”ç”¨çš„ä¾èµ–å…³ç³»ï¼Œä¾èµ–é¡¹æŒ‡å‘çš„æ˜¯å¦ä¸€ä¸ªåº”ç”¨çš„åæ ‡ï¼ˆåç§°ã€ç‰ˆæœ¬ã€Repository åœ°å€ï¼‰ï¼Œvalues.yamlç»™å‡ºäº†æ‰€æœ‰å¯é…ç½®é¡¹ç›®çš„é¢„å®šä¹‰å€¼ã€‚å¯é…ç½®é¡¹æ˜¯æŒ‡éœ€è¦éƒ¨ç½²æœŸé—´ç”±è¿ç»´äººå‘˜è°ƒæ•´çš„é‚£äº›å‚æ•°ï¼Œå®ƒä»¬ä»¥èŠ±æ‹¬å·åŒ…è£¹åœ¨templatesç›®å½•ä¸‹çš„èµ„æºæ–‡ä»¶ä¸­ï¼Œéƒ¨ç½²åº”ç”¨æ—¶ï¼ŒHelm ä¼šå…ˆå°†ç®¡ç†å‘˜è®¾ç½®çš„å€¼è¦†ç›–åˆ°values.yamlçš„é»˜è®¤å€¼ä¸Šï¼Œç„¶åä»¥å­—ç¬¦ä¸²æ›¿æ¢çš„å½¢å¼ä¼ é€’ç»™templatesç›®å½•çš„èµ„æºæ¨¡ç‰ˆï¼Œæœ€åç”Ÿæˆè¦éƒ¨ç½²åˆ° Kubernetes çš„èµ„æºæ–‡ä»¶ã€‚ç”±äº Chart å°è£…äº†è¶³å¤Ÿä¸°å¯Œçš„ä¿¡æ¯ï¼Œæ‰€ä»¥ Helm é™¤äº†æ”¯æŒå‘½ä»¤è¡Œæ“ä½œå¤–ï¼Œä¹Ÿèƒ½å¾ˆå®¹æ˜“åœ°æ ¹æ®è¿™äº›ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆå›¾å½¢åŒ–çš„åº”ç”¨å®‰è£…ã€å‚æ•°è®¾ç½®ç•Œé¢ã€‚\nRepository ä»“åº“ç”¨äºå®ç° Chart çš„æœç´¢ä¸ä¸‹è½½æœåŠ¡ï¼ŒHelm ç¤¾åŒºç»´æŠ¤äº†å…¬å¼€çš„ Stable å’Œ Incubator çš„ä¸­å¤®ä»“åº“ï¼ˆç•Œé¢å¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ï¼Œä¹Ÿæ”¯æŒå…¶ä»–äººæˆ–ç»„ç»‡æ­å»ºç§æœ‰ä»“åº“å’Œå…¬å…±ä»“åº“ï¼Œå¹¶èƒ½å¤Ÿé€šè¿‡ Hub æœåŠ¡æŠŠä¸åŒä¸ªäººæˆ–ç»„ç»‡æ­å»ºçš„å…¬å…±ä»“åº“èšåˆèµ·æ¥ï¼Œå½¢æˆæ›´å¤§å‹çš„åˆ†å¸ƒå¼åº”ç”¨ä»“åº“ï¼Œæœ‰åˆ©äº Chart çš„æŸ¥æ‰¾ä¸å…±äº«ã€‚\n\nï¼ˆå›¾ç‰‡æ¥è‡ªHelm å®˜ç½‘)\nHelm æä¾›äº†åº”ç”¨å…¨ç”Ÿå‘½å‘¨æœŸã€ç‰ˆæœ¬ã€ä¾èµ–é¡¹çš„ç®¡ç†èƒ½åŠ›ï¼ŒåŒæ—¶ï¼ŒHelm è¿˜æ”¯æŒé¢å¤–çš„æ‰©å±•æ’ä»¶ï¼Œèƒ½å¤ŸåŠ å…¥ CI/CD æˆ–è€…å…¶ä»–æ–¹é¢çš„è¾…åŠ©åŠŸèƒ½ï¼Œè¿™æ ·çš„å®šä½å·²ç»ä»å•çº¯çš„å·¥å…·å‡çº§åˆ°åº”ç”¨ç®¡ç†å¹³å°äº†ã€‚å¼ºå¤§çš„åŠŸèƒ½è®© Helm å—åˆ°äº†ä¸å°‘æ”¯æŒï¼Œæœ‰å¾ˆå¤šåº”ç”¨ä¸»åŠ¨å…¥é©»åˆ°å®˜æ–¹çš„ä»“åº“ä¸­ã€‚ä» 2018 å¹´èµ·ï¼ŒHelm é¡¹ç›®è¢«æ‰˜ç®¡åˆ° CNCFï¼Œæˆä¸ºå…¶ä¸­çš„ä¸€ä¸ªå­µåŒ–é¡¹ç›®ã€‚\nHelm ä»¥æ¨¡ä»¿ Linux åŒ…ç®¡ç†å™¨çš„æ€è·¯å»ç®¡ç† Kubernetes åº”ç”¨ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ˜¯å¯è¡Œçš„ï¼Œä¸è¿‡ï¼ŒLinux ä¸ Kubernetes ä¸­éƒ¨ç½²åº”ç”¨è¿˜æ˜¯å­˜åœ¨ä¸€äº›å·®åˆ«ï¼Œæœ€é‡è¦çš„ä¸€ç‚¹æ˜¯åœ¨ Linux ä¸­ 99%çš„åº”ç”¨éƒ½åªä¼šå®‰è£…ä¸€ä»½ï¼Œè€Œ Kubernetes é‡Œä¸ºäº†ä¿è¯å¯ç”¨æ€§ï¼ŒåŒä¸€ä¸ªåº”ç”¨éƒ¨ç½²å¤šä»½å‰¯æœ¬æ‰æ˜¯å¸¸è§„æ“ä½œã€‚Helm ä¸ºäº†æ”¯æŒå¯¹åŒä¸€ä¸ª Chart åŒ…è¿›è¡Œå¤šæ¬¡éƒ¨ç½²ï¼Œæ¯æ¬¡å®‰è£…åº”ç”¨éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªç‰ˆæœ¬ï¼ˆReleaseï¼‰ ï¼Œç‰ˆæœ¬ç›¸å½“äºè¯¥ Chart çš„å®‰è£…å®ä¾‹ã€‚å¯¹äºæ— çŠ¶æ€çš„æœåŠ¡ï¼ŒHelm é ç€ä¸åŒçš„ç‰ˆæœ¬å°±å·²ç»è¶³å¤Ÿæ”¯æŒå¤šä¸ªæœåŠ¡å¹¶è¡Œå·¥ä½œäº†ï¼Œä½†å¯¹äºæœ‰çŠ¶æ€çš„æœåŠ¡æ¥è¯´ï¼Œè¿™äº›æœåŠ¡ä¼šä¸ç‰¹å®šèµ„æºæˆ–è€…æœåŠ¡äº§ç”Ÿä¾èµ–å…³ç³»ï¼Œè­¬å¦‚è¦éƒ¨ç½²æ•°æ®åº“ï¼Œé€šå¸¸è¦ä¾èµ–ç‰¹å®šçš„å­˜å‚¨æ¥ä¿å­˜æŒä¹…åŒ–æ•°æ®ï¼Œè¿™æ ·äº‹æƒ…å°±å˜å¾—å¤æ‚èµ·æ¥ã€‚Helm æ— æ³•å¾ˆå¥½åœ°ç®¡ç†è¿™ç§æœ‰çŠ¶æ€çš„ä¾èµ–å…³ç³»ï¼Œè¿™ä¸€ç±»é—®é¢˜å°±æ˜¯ Operator è¦è§£å†³çš„ç—›ç‚¹äº†ã€‚\nOperator ä¸ CRDOperatorä¸åº”å½“è¢«ç§°ä½œæ˜¯ä¸€ç§å·¥å…·æˆ–è€…ç³»ç»Ÿï¼Œå®ƒåº”è¯¥ç®—æ˜¯ä¸€ç§å°è£…ã€éƒ¨ç½²å’Œç®¡ç† Kubernetes åº”ç”¨çš„æ–¹æ³•ï¼Œå°¤å…¶æ˜¯é’ˆå¯¹æœ€å¤æ‚çš„æœ‰çŠ¶æ€åº”ç”¨å»å°è£…è¿ç»´èƒ½åŠ›çš„è§£å†³æ–¹æ¡ˆï¼Œæœ€æ—©ç”± CoreOS å…¬å¸ï¼ˆäº 2018 å¹´è¢« RedHat æ”¶è´­ï¼‰çš„åäººç¨‹åºå‘˜é‚“æ´ªè¶…æ‰€æå‡ºã€‚\nå¦‚æœä¸Šä¸€èŠ‚â€œä»¥å®¹å™¨æ„å»ºç³»ç»Ÿâ€ä»‹ç» Kubernetes èµ„æºä¸æ§åˆ¶å™¨æ¨¡å¼æ—¶ä½ æ²¡æœ‰å¼€å°å·®çš„è¯ï¼Œé‚£ä¹ˆ Operator ä¸­æœ€æ ¸å¿ƒçš„ç†å¿µä½ å…¶å®å°±å·²ç»ç†è§£å¾—å·®ä¸å¤šäº†ã€‚ç®€å•åœ°è¯´ï¼ŒOperator æ˜¯é€šè¿‡ Kubernetes 1.7 å¼€å§‹æ”¯æŒçš„è‡ªå®šä¹‰èµ„æºï¼ˆCustom Resource Definitionsï¼ŒCRDï¼Œæ­¤å‰æ›¾ç»ä»¥ TPRï¼Œå³ Third Party Resource çš„å½¢å¼æä¾›è¿‡ç±»ä¼¼çš„èƒ½åŠ›ï¼‰ï¼ŒæŠŠåº”ç”¨å°è£…ä¸ºå¦ä¸€ç§æ›´é«˜å±‚æ¬¡çš„èµ„æºï¼Œå†æŠŠ Kubernetes çš„æ§åˆ¶å™¨æ¨¡å¼ä»é¢å‘äºå†…ç½®èµ„æºï¼Œæ‰©å±•åˆ°äº†é¢å‘æ‰€æœ‰è‡ªå®šä¹‰èµ„æºï¼Œä»¥æ­¤æ¥å®Œæˆå¯¹å¤æ‚åº”ç”¨çš„ç®¡ç†ã€‚ä¸‹é¢æ˜¯ç¬”è€…å¼•ç”¨äº†ä¸€æ®µ RedHat å®˜æ–¹å¯¹ Operator è®¾è®¡ç†å¿µçš„é˜è¿°ï¼š\n\nOperator è®¾è®¡ç†å¿µOperator æ˜¯ä½¿ç”¨è‡ªå®šä¹‰èµ„æºï¼ˆCRï¼Œç¬”è€…æ³¨ï¼šCR å³ Custom Resourceï¼Œæ˜¯ CRD çš„å®ä¾‹ï¼‰ç®¡ç†åº”ç”¨åŠå…¶ç»„ä»¶çš„è‡ªå®šä¹‰ Kubernetes æ§åˆ¶å™¨ã€‚é«˜çº§é…ç½®å’Œè®¾ç½®ç”±ç”¨æˆ·åœ¨ CR ä¸­æä¾›ã€‚Kubernetes Operator åŸºäºåµŒå…¥åœ¨ Operator é€»è¾‘ä¸­çš„æœ€ä½³å®è·µå°†é«˜çº§æŒ‡ä»¤è½¬æ¢ä¸ºä½çº§æ“ä½œã€‚Kubernetes Operator ç›‘è§† CR ç±»å‹å¹¶é‡‡å–ç‰¹å®šäºåº”ç”¨çš„æ“ä½œï¼Œç¡®ä¿å½“å‰çŠ¶æ€ä¸è¯¥èµ„æºçš„ç†æƒ³çŠ¶æ€ç›¸ç¬¦ã€‚\nâ€‹                                                                                                                                                   â€”â€” ä»€ä¹ˆæ˜¯ Kubernetes Operatorï¼ŒRedHat\n\nä»¥ä¸Šè¿™æ®µæ–‡å­—ä¸æ˜¯ç¬”è€…è½¬è¿°ï¼Œè€Œæ˜¯ç›´æ¥ç”± RedHat å®˜æ–¹æ’°å†™å’Œç¿»è¯‘æˆä¸­æ–‡çš„ï¼Œå‡†ç¡®ä¸¥è°¨ä½†æ¯”è¾ƒæ‹—å£ï¼Œå¯¹äºæ²¡æ¥è§¦è¿‡ Operator çš„äººå¹¶ä¸å‹å¥½ï¼Œä»€ä¹ˆå«ä½œâ€œé«˜çº§æŒ‡ä»¤â€ï¼Ÿä»€ä¹ˆå«ä½œâ€œä½çº§æ“ä½œâ€ï¼Ÿä¸¤è€…ä¹‹é—´å…·ä½“å¦‚ä½•è½¬æ¢ï¼Ÿä¸ºäº†èƒ½å¤Ÿç†è§£è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå¼„æ¸…æ¥šæœ‰çŠ¶æ€å’Œæ— çŠ¶æ€åº”ç”¨çš„å«ä¹‰åŠå½±å“ï¼Œç„¶åå†æ¥ç†è§£ Operator æ‰€åšçš„å·¥ä½œã€‚\næœ‰çŠ¶æ€åº”ç”¨ï¼ˆStateful Applicationï¼‰ä¸æ— çŠ¶æ€åº”ç”¨ï¼ˆStateless Applicationï¼‰è¯´çš„æ˜¯åº”ç”¨ç¨‹åºæ˜¯å¦è¦è‡ªå·±æŒæœ‰å…¶è¿è¡Œæ‰€éœ€çš„æ•°æ®ï¼Œå¦‚æœç¨‹åºæ¯æ¬¡è¿è¡Œéƒ½è·Ÿé¦–æ¬¡è¿è¡Œä¸€æ ·ï¼Œä¸ä¼šä¾èµ–ä¹‹å‰ä»»ä½•æ“ä½œæ‰€é—ç•™ä¸‹æ¥çš„ç—•è¿¹ï¼Œé‚£å®ƒå°±æ˜¯æ— çŠ¶æ€çš„ï¼›åä¹‹ï¼Œå¦‚æœç¨‹åºæ¨å€’é‡æ¥ä¹‹åï¼Œç”¨æˆ·èƒ½å¯Ÿè§‰åˆ°è¯¥åº”ç”¨å·²ç»å‘ç”Ÿå˜åŒ–ï¼Œé‚£å®ƒå°±æ˜¯æœ‰çŠ¶æ€çš„ã€‚æ— çŠ¶æ€åº”ç”¨åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å…·æœ‰éå¸¸å·¨å¤§çš„ä»·å€¼ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“åˆ†å¸ƒå¼ä¸­çš„ CAP ä¸å…¼å®¹åŸç†ï¼Œå¦‚æœæ— çŠ¶æ€ï¼Œé‚£å°±ä¸å¿…è€ƒè™‘çŠ¶æ€ä¸€è‡´æ€§ï¼Œæ²¡æœ‰äº† Cï¼Œé‚£ A å’Œ P ä¾¿å¯ä»¥å…¼å¾—ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œåªè¦èµ„æºè¶³å¤Ÿï¼Œæ— çŠ¶æ€åº”ç”¨å¤©ç”Ÿå°±æ˜¯é«˜å¯ç”¨çš„ã€‚ä½†ä¸å¹¸çš„æ˜¯ç°åœ¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¤šæ•°å…³é”®çš„åŸºç¡€æœåŠ¡éƒ½æ˜¯æœ‰çŠ¶æ€çš„ï¼Œå¦‚ç¼“å­˜ã€æ•°æ®åº“ã€å¯¹è±¡å­˜å‚¨ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç­‰ç­‰ï¼Œåªæœ‰ Web æœåŠ¡å™¨è¿™ç±»æœåŠ¡å±äºæ— çŠ¶æ€ã€‚\nç«™åœ¨ Kubernetes çš„è§’åº¦çœ‹ï¼Œæ˜¯å¦æœ‰çŠ¶æ€çš„æœ¬è´¨å·®å¼‚åœ¨äºæœ‰çŠ¶æ€åº”ç”¨ä¼šå¯¹æŸäº›å¤–éƒ¨èµ„æºæœ‰ç»‘å®šæ€§çš„ç›´æ¥ä¾èµ–ï¼Œè­¬å¦‚ Elasticsearch å»ºç«‹å®ä¾‹æ—¶å¿…é¡»ä¾èµ–ç‰¹å®šçš„å­˜å‚¨ä½ç½®ï¼Œé‡å¯åä»ç„¶æŒ‡å‘åŒä¸€ä¸ªæ•°æ®æ–‡ä»¶çš„å®ä¾‹æ‰èƒ½è¢«è®¤ä¸ºæ˜¯ç›¸åŒçš„å®ä¾‹ã€‚å¦å¤–ï¼Œæœ‰çŠ¶æ€åº”ç”¨çš„å¤šä¸ªåº”ç”¨å®ä¾‹ä¹‹é—´å¾€å¾€æœ‰ç€ç‰¹å®šçš„æ‹“æ‰‘å…³ç³»ä¸é¡ºåºå…³ç³»ï¼Œè­¬å¦‚ Etcd çš„èŠ‚ç‚¹é—´é€‰ä¸»å’ŒæŠ•ç¥¨ï¼ŒèŠ‚ç‚¹ä»¬éƒ½éœ€è¦å¾—çŸ¥å½¼æ­¤çš„å­˜åœ¨ã€‚ä¸ºäº†ç®¡ç†å¥½é‚£äº›ä¸åº”ç”¨å®ä¾‹å¯†åˆ‡ç›¸å…³çš„çŠ¶æ€ä¿¡æ¯ï¼ŒKubernetes ä» 1.9 ç‰ˆæœ¬å¼€å§‹æ­£å¼å‘å¸ƒäº† StatefulSet åŠå¯¹åº”çš„ StatefulSetControllerã€‚ä¸æ™®é€š ReplicaSet ä¸­çš„ Pod ç›¸æ¯”ï¼Œç”± StatefulSet ç®¡ç†çš„ Pod å…·å¤‡ä»¥ä¸‹å‡ é¡¹é¢å¤–ç‰¹æ€§ï¼š\n\nPod ä¼šæŒ‰é¡ºåºåˆ›å»ºå’ŒæŒ‰é¡ºåºé”€æ¯ï¼šStatefulSet ä¸­çš„å„ä¸ª Pod ä¼šæŒ‰é¡ºåºåœ°åˆ›å»ºå‡ºæ¥ï¼Œåˆ›å»ºåç»­çš„ Pod å‰ï¼Œå¿…é¡»è¦ä¿è¯å‰é¢çš„ Pod å·²ç»è½¬å…¥å°±ç»ªçŠ¶æ€ã€‚åˆ é™¤ StatefulSet ä¸­çš„ Pod æ—¶ä¼šæŒ‰ç…§ä¸åˆ›å»ºé¡ºåºçš„é€†åºæ¥æ‰§è¡Œã€‚\nPod å…·æœ‰ç¨³å®šçš„ç½‘ç»œåç§°ï¼šKubernetes ä¸­çš„ Pod éƒ½å…·æœ‰å”¯ä¸€çš„åç§°ï¼Œåœ¨æ™®é€šçš„å‰¯æœ¬é›†ä¸­è¿™æ˜¯é éšæœºå­—ç¬¦äº§ç”Ÿçš„ï¼Œè€Œåœ¨ StatefulSet ä¸­ç®¡ç†çš„ Podï¼Œä¼šä»¥å¸¦æœ‰é¡ºåºçš„ç¼–å·ä½œä¸ºåç§°ï¼Œä¸”èƒ½å¤Ÿåœ¨é‡å¯åä¾ç„¶ä¿æŒä¸å˜ã€‚ã€‚\nPod å…·æœ‰ç¨³å®šçš„æŒä¹…å­˜å‚¨ï¼šStatefulSet ä¸­çš„æ¯ä¸ª Pod éƒ½å¯ä»¥æ‹¥æœ‰è‡ªå·±ç‹¬ç«‹çš„ PersistentVolumeClaim èµ„æºã€‚å³ä½¿ Pod è¢«é‡æ–°è°ƒåº¦åˆ°å…¶å®ƒèŠ‚ç‚¹ä¸Šï¼Œå®ƒæ‰€æ‹¥æœ‰çš„æŒä¹…ç£ç›˜ä¹Ÿä¾ç„¶ä¼šè¢«æŒ‚è½½åˆ°è¯¥ Podï¼Œè¿™ç‚¹ä¼šåœ¨â€œå®¹å™¨æŒä¹…åŒ–â€ä¸­è¿›ä¸€æ­¥ä»‹ç»ã€‚\n\nåªæ˜¯ç½—åˆ—å‡ºç‰¹æ€§ï¼Œåº”è¯¥å¾ˆéš¾å¿«é€Ÿç†è§£ StatefulSet çš„è®¾è®¡æ„å›¾ï¼Œç¬”è€…æ‰“ä¸ªæ¯”æ–¹æ¥å¸®åŠ©ä½ ç†è§£ï¼šå¦‚æœæŠŠ ReplicaSet ä¸­çš„ Pod æ¯”å–»ä¸ºå…»æ®–åœºä¸­çš„â€œè‚‰çŒªâ€ï¼Œé‚£ StatefulSet å°±æ˜¯è¢«å®¶åº­å½“å® ç‰©åœˆå…»çš„â€œè·å…°çŒªâ€ï¼Œä¸åŒçš„è‚‰çŒªåœ¨é£Ÿç”¨åŠŸèƒ½ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œä½†æ¯åªå® ç‰©çŒªéƒ½æ˜¯ç‹¬ä¸€æ— äºŒçš„ï¼Œæœ‰ä¸“å±äºè‡ªå·±çš„åå­—ã€ä¹ æ€§ä¸è®°å¿†ï¼Œäº‹å®ä¸Šï¼Œæ—©æœŸçš„ StatefulSet å°±æ›¾ç»æœ‰ä¸€æ®µæ—¶é—´ç”¨è¿‡ PetSet è¿™ä¸ªåå­—ã€‚\nå½“ StatefulSet å‡ºç°ä»¥åï¼ŒKubernetes å°±èƒ½æ»¡è¶³ Pod é‡æ–°åˆ›å»ºåä»ç„¶ä¿ç•™ä¸Šä¸€æ¬¡è¿è¡ŒçŠ¶æ€çš„éœ€æ±‚ï¼Œä¸è¿‡æœ‰çŠ¶æ€åº”ç”¨çš„ç»´æŠ¤å¹¶ä¸ä»…é™äºæ­¤ï¼Œè­¬å¦‚å¯¹äºä¸€å¥— Elasticsearch é›†ç¾¤æ¥è¯´ï¼Œé€šè¿‡ StatefulSet æœ€å¤šåªèƒ½åšåˆ°åˆ›å»ºé›†ç¾¤ã€åˆ é™¤é›†ç¾¤ã€æ‰©å®¹ç¼©å®¹ç­‰æœ€åŸºæœ¬çš„æ“ä½œï¼Œå…¶ä»–çš„è¿ç»´æ“ä½œï¼Œè­¬å¦‚å¤‡ä»½å’Œæ¢å¤æ•°æ®ã€åˆ›å»ºå’Œåˆ é™¤ç´¢å¼•ã€è°ƒæ•´å¹³è¡¡ç­–ç•¥ç­‰æ“ä½œä¹Ÿååˆ†å¸¸ç”¨ï¼Œä½†æ˜¯ StatefulSet å¹¶ä¸èƒ½ä¸ºæ­¤æä¾›ä»»ä½•å¸®åŠ©ã€‚\nç¬”è€…å†ä¸¾ä¸ªå®é™…ä¾‹å­æ¥è¯´æ˜ Operator æ˜¯å¦‚ä½•è§£å†³é‚£äº› StatefulSet è¦†ç›–ä¸åˆ°çš„æœ‰çŠ¶æ€æœåŠ¡ç®¡ç†éœ€æ±‚çš„ï¼šå‡è®¾è¦éƒ¨ç½²ä¸€å¥— Elasticsearch é›†ç¾¤ï¼Œé€šå¸¸è¦åœ¨ StatefulSet ä¸­å®šä¹‰ç›¸å½“å¤šçš„ç»†èŠ‚ï¼Œè­¬å¦‚æœåŠ¡çš„ç«¯å£ã€Elasticsearch çš„é…ç½®ã€æ›´æ–°ç­–ç•¥ã€å†…å­˜å¤§å°ã€è™šæ‹Ÿæœºå‚æ•°ã€ç¯å¢ƒå˜é‡ã€æ•°æ®æ–‡ä»¶ä½ç½®ï¼Œç­‰ç­‰ï¼Œä¸ºäº†ä¾¿äºä½ å¯¹å·²ç»åå¤æåŠçš„ Kubernetes çš„å¤æ‚æœ‰æ›´åŠ ç›´è§‚çš„ä½“éªŒï¼Œè¿™é‡Œå°±å¥¢ä¾ˆä¸€æ¬¡ï¼ŒæŒ¥éœä¸€æ¬¡ç‰ˆé¢ï¼Œå°†æ»¡è¶³è¿™ä¸ªéœ€æ±‚çš„ YAML å…¨æ–‡è´´å‡ºå¦‚ä¸‹ï¼š\napiVersion: v1kind: Servicemetadata:  name: elasticsearch-clusterspec:  clusterIP: None  selector:    app: es-cluster  ports:  - name: transport    port: 9300---apiVersion: v1kind: Servicemetadata:  name: elasticsearch-loadbalancerspec:  selector:    app: es-cluster  ports:  - name: http    port: 80    targetPort: 9200  type: LoadBalancer---apiVersion: v1kind: ConfigMapmetadata:  name: es-configdata:  elasticsearch.yml: |    cluster.name: my-elastic-cluster    network.host: &quot;0.0.0.0&quot;    bootstrap.memory_lock: false    discovery.zen.ping.unicast.hosts: elasticsearch-cluster    discovery.zen.minimum_master_nodes: 1    xpack.security.enabled: false    xpack.monitoring.enabled: false  ES_JAVA_OPTS: -Xms512m -Xmx512m---apiVersion: apps/v1beta1kind: StatefulSetmetadata:  name: esnodespec:  serviceName: elasticsearch  replicas: 3  updateStrategy:    type: RollingUpdate  template:    metadata:      labels:        app: es-cluster    spec:      securityContext:        fsGroup: 1000      initContainers:      - name: init-sysctl        image: busybox        imagePullPolicy: IfNotPresent        securityContext:          privileged: true        command: [&quot;sysctl&quot;, &quot;-w&quot;, &quot;vm.max_map_count=262144&quot;]      containers:      - name: elasticsearch        resources:            requests:                memory: 1Gi        securityContext:          privileged: true          runAsUser: 1000          capabilities:            add:            - IPC_LOCK            - SYS_RESOURCE        image: docker.elastic.co/elasticsearch/elasticsearch:7.9.1        env:        - name: ES_JAVA_OPTS          valueFrom:              configMapKeyRef:                  name: es-config                  key: ES_JAVA_OPTS        readinessProbe:          httpGet:            scheme: HTTP            path: /_cluster/health?local=true            port: 9200          initialDelaySeconds: 5        ports:        - containerPort: 9200          name: es-http        - containerPort: 9300          name: es-transport        volumeMounts:        - name: es-data          mountPath: /usr/share/elasticsearch/data        - name: elasticsearch-config          mountPath: /usr/share/elasticsearch/config/elasticsearch.yml          subPath: elasticsearch.yml      volumes:        - name: elasticsearch-config          configMap:            name: es-config            items:              - key: elasticsearch.yml                path: elasticsearch.yml  volumeClaimTemplates:  - metadata:      name: es-data    spec:      accessModes: [ &quot;ReadWriteOnce&quot; ]      resources:        requests:          storage: 5Gi\n\nå‡ºç°å¦‚æ­¤å¤§é‡çš„ç»†èŠ‚é…ç½®ï¼Œå…¶æ ¹æœ¬åŸå› åœ¨äº Kubernetes å®Œå…¨ä¸çŸ¥é“ Elasticsearch æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿ï¼Œæ‰€æœ‰ Kubernetes ä¸çŸ¥é“çš„ä¿¡æ¯ã€ä¸èƒ½å¯å‘å¼æ¨æ–­å‡ºæ¥çš„ä¿¡æ¯ï¼Œéƒ½å¿…é¡»ç”±ç”¨æˆ·åœ¨èµ„æºçš„å…ƒæ•°æ®å®šä¹‰ä¸­æ˜ç¡®åˆ—å‡ºï¼Œå¿…é¡»ä¸€æ­¥ä¸€æ­¥æ‰‹æŠŠæ‰‹åœ°â€œæ•™ä¼šâ€Kubernetes å¦‚ä½•éƒ¨ç½² Elasticsearchï¼Œè¿™ç§å½¢å¼å°±å±äº RedHat åœ¨ Operator è®¾è®¡ç†å¿µä»‹ç»ä¸­æ‰€è¯´çš„â€œä½çº§æ“ä½œâ€ã€‚\nå¦‚æœæˆ‘ä»¬ä½¿ç”¨Elastic.co å®˜æ–¹æä¾›çš„ Operatorï¼Œé‚£æƒ…å†µå°±ä¼šç®€å•å¾—å¤šäº†ï¼ŒElasticsearch Operator æä¾›äº†ä¸€ç§kind: Elasticsearchçš„è‡ªå®šä¹‰èµ„æºï¼Œåœ¨å®ƒçš„å¸®åŠ©ä¸‹ï¼Œä»…éœ€åè¡Œä»£ç ï¼Œå°†ç”¨æˆ·çš„æ„å›¾æ˜¯â€œéƒ¨ç½²ä¸‰ä¸ªç‰ˆæœ¬ä¸º 7.9.1 çš„ ES é›†ç¾¤èŠ‚ç‚¹â€è¯´æ¸…æ¥šå³å¯ï¼Œä¾¿èƒ½å®ç°ä¸å‰é¢ StatefulSet é‚£ä¸€å¤§å †é…ç½®ç›¸åŒä¹ƒè‡³æ›´å¼ºå¤§çš„æ•ˆæœï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºã€‚\napiVersion: elasticsearch.k8s.elastic.co/v1kind: Elasticsearchmetadata:  name: elasticsearch-clusterspec:  version: 7.9.1  nodeSets:  - name: default    count: 3    config:      node.master: true      node.data: true      node.ingest: true      node.store.allow_mmap: false\n\næœ‰äº† Elasticsearch Operator çš„è‡ªå®šä¹‰èµ„æºï¼Œç›¸å½“äº Kubernetes å·²ç»å­¦ä¼šæ€æ ·æ“ä½œäº† Elasticsearchï¼ŒçŸ¥é“æ‰€æœ‰å®ƒç›¸å…³çš„å‚æ•°å«ä¹‰ä¸é»˜è®¤å€¼ï¼Œæ— éœ€ç”¨æˆ·å†æ‰‹æŠŠæ‰‹åœ°æ•™äº†ï¼Œè¿™ç§å°±æ˜¯æ‰€è°“çš„â€œé«˜çº§æŒ‡ä»¤â€ã€‚\nOperator å°†ç®€æ´çš„é«˜çº§æŒ‡ä»¤è½¬åŒ–ä¸º Kubernetes ä¸­å…·ä½“æ“ä½œçš„æ–¹æ³•ï¼Œä¸å‰é¢ Helm æˆ–è€… Kustomize çš„æ€è·¯å¹¶ä¸ç›¸åŒã€‚Helm å’Œ Kustomize æœ€ç»ˆä»ç„¶æ˜¯ä¾é  Kubernetes çš„å†…ç½®èµ„æºæ¥è·Ÿ Kubernetes æ‰“äº¤é“çš„ï¼ŒOperator åˆ™æ˜¯è¦æ±‚å¼€å‘è€…è‡ªå·±å®ç°ä¸€ä¸ªä¸“é—¨é’ˆå¯¹è¯¥è‡ªå®šä¹‰èµ„æºçš„æ§åˆ¶å™¨ï¼Œåœ¨æ§åˆ¶å™¨ä¸­ç»´æŠ¤è‡ªå®šä¹‰èµ„æºçš„æœŸæœ›çŠ¶æ€ã€‚é€šè¿‡ç¨‹åºç¼–ç æ¥æ‰©å±• Kubernetesï¼Œæ¯”åªé€šè¿‡å†…ç½®èµ„æºæ¥ä¸ Kubernetes æ‰“äº¤é“è¦çµæ´»å¾—å¤šï¼Œè­¬å¦‚å½“éœ€è¦æ›´æ–°é›†ç¾¤ä¸­æŸä¸ª Pod å¯¹è±¡çš„æ—¶å€™ï¼Œç”± Operator å¼€å‘è€…è‡ªå·±ç¼–ç å®ç°çš„æ§åˆ¶å™¨å®Œå…¨å¯ä»¥åœ¨åŸåœ°å¯¹ Pod è¿›è¡Œé‡å¯ï¼Œè€Œæ— éœ€åƒ Deployment é‚£æ ·å¿…é¡»å…ˆåˆ é™¤æ—§ Podï¼Œç„¶åå†åˆ›å»ºæ–° Podã€‚\nä½¿ç”¨ CRD å®šä¹‰é«˜å±‚æ¬¡èµ„æºã€ä½¿ç”¨é…å¥—çš„æ§åˆ¶å™¨æ¥ç»´æŠ¤æœŸæœ›çŠ¶æ€ï¼Œå¸¦æ¥çš„å¥½å¤„ä¸ä»…ä»…æ˜¯â€œé«˜çº§æŒ‡ä»¤â€çš„ä¾¿æ·ï¼Œè€Œæ˜¯éµå¾ª Kubernetes ä¸€è´¯åŸºäºèµ„æºä¸æ§åˆ¶å™¨çš„è®¾è®¡åŸåˆ™çš„åŒæ—¶ï¼Œåˆä¸å¿…å†å—åˆ¶äº Kubernetes å†…ç½®èµ„æºçš„è¡¨è¾¾èƒ½åŠ›ã€‚åªè¦ Operator çš„å¼€å‘è€…æ„¿æ„ç¼–å†™ä»£ç ï¼Œå‰é¢æ›¾ç»æåˆ°é‚£äº› StatfulSet ä¸èƒ½æ”¯æŒçš„èƒ½åŠ›ï¼Œå¦‚å¤‡ä»½æ¢å¤æ•°æ®ã€åˆ›å»ºåˆ é™¤ç´¢å¼•ã€è°ƒæ•´å¹³è¡¡ç­–ç•¥ç­‰æ“ä½œï¼Œéƒ½å®Œå…¨å¯ä»¥å®ç°å‡ºæ¥ã€‚\næŠŠè¿ç»´çš„æ“ä½œå°è£…åœ¨ç¨‹åºä»£ç ä¸Šï¼Œè¡¨é¢çœ‹æœ€å¤§çš„å—ç›Šè€…æ˜¯è¿ç»´äººå‘˜ï¼Œå¼€å‘äººå‘˜è¦ä¸ºæ­¤ä»˜å‡ºæ›´å¤šåŠ³åŠ¨ã€‚ç„¶è€Œ Operator å¹¶æ²¡æœ‰å—åˆ°å¼€å‘äººå‘˜çš„æŠµåˆ¶ï¼Œè®©å®ƒå˜å¾—å°ä¼—ï¼Œåè€Œç”±äºä»£ç ç›¸å¯¹äºèµ„æºé…ç½®çš„è¡¨è¾¾èƒ½åŠ›æå‡ï¼Œè®©å¼€å‘ä¸è¿ç»´ä¹‹é—´çš„åä½œæˆæœ¬é™ä½è€Œå¤‡å—å¼€å‘è€…çš„å¥½è¯„ã€‚Operator å˜æˆäº†è¿‘ä¸¤ã€ä¸‰å¹´å®¹å™¨å°è£…åº”ç”¨çš„ä¸€è‚¡æ–°æ½®æµï¼Œç°åœ¨å¾ˆå¤šå¤æ‚åˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æœ‰äº†å®˜æ–¹æˆ–è€…ç¬¬ä¸‰æ–¹æä¾›çš„ Operatorï¼ˆè¿™é‡Œæ”¶é›†äº†ä¸€éƒ¨åˆ†ï¼‰ã€‚RedHat å…¬å¸ä¹ŸæŒç»­åœ¨ Operator ä¸Šé¢å¤§é‡æŠ•å…¥ï¼Œæ¨å‡ºäº†ç®€åŒ–å¼€å‘äººå‘˜ç¼–å†™ Operator çš„Operator Framework/SDKã€‚\nç›®å‰çœ‹æ¥ï¼Œåº”å¯¹æœ‰çŠ¶æ€åº”ç”¨çš„å°è£…è¿ç»´ï¼ŒOperator ä¹Ÿè®¸æ˜¯æœ€æœ‰å¯è¡Œæ€§çš„æ–¹æ¡ˆï¼Œä½†è¿™ä¾ç„¶ä¸æ˜¯ä¸€é¡¹è½»æ¾çš„å·¥ä½œã€‚ä»¥Etcd çš„ Operatorä¸ºä¾‹ï¼ŒEtcd æœ¬èº«ä¸ç®—ä»€ä¹ˆç‰¹åˆ«å¤æ‚çš„åº”ç”¨ï¼ŒOperator å®ç°çš„åŠŸèƒ½çœ‹èµ·æ¥ä¹Ÿç›¸å½“åŸºç¡€ï¼Œä¸»è¦æœ‰åˆ›å»ºé›†ç¾¤ã€åˆ é™¤é›†ç¾¤ã€æ‰©å®¹ç¼©å®¹ã€æ•…éšœè½¬ç§»ã€æ»šåŠ¨æ›´æ–°ã€å¤‡ä»½æ¢å¤ç­‰åŠŸèƒ½ï¼Œå…¶ä»£ç å°±å·²ç»è¶…è¿‡ä¸€ä¸‡è¡Œäº†ã€‚ç°åœ¨å¼€å‘ Operator çš„ç¡®è¿˜æ˜¯æœ‰ç€ç›¸å¯¹è¾ƒé«˜çš„é—¨æ§›ï¼Œé€šå¸¸ç”±ä¸“ä¸šçš„å¹³å°å¼€å‘è€…è€Œéä¸šåŠ¡å¼€å‘æˆ–è€…è¿ç»´äººå‘˜å»å®Œæˆï¼Œä½†æ˜¯ Operator ç¬¦åˆæŠ€æœ¯æ½®æµï¼Œé¡ºåº”è½¯ä»¶ä¸šç•Œæ‰€æå€¡çš„ DevOps ä¸€ä½“åŒ–ç†å¿µï¼Œç­‰ Operator çš„æ”¯æŒå’Œç”Ÿæ€è¿›ä¸€æ­¥æˆç†Ÿä¹‹åï¼Œå¼€å‘å’Œè¿ç»´éƒ½èƒ½ä»ä¸­å—ç›Šï¼Œæœªæ¥åº”è¯¥èƒ½æˆé•¿ä¸ºä¸€ç§åº”ç”¨å°è£…çš„ä¸»æµå½¢å¼ã€‚\nå¼€æ”¾åº”ç”¨æ¨¡å‹æœ¬èŠ‚ä»‹ç»çš„æœ€åä¸€ç§åº”ç”¨å°è£…çš„æ–¹æ¡ˆï¼Œæ˜¯é˜¿é‡Œäº‘å’Œå¾®è½¯åœ¨ 2019 å¹´ 10 æœˆä¸Šæµ· QCon å¤§ä¼šä¸Šè”åˆå‘å¸ƒçš„å¼€æ”¾åº”ç”¨æ¨¡å‹ï¼ˆOpen Application Modelï¼ŒOAMï¼‰ï¼Œå®ƒä¸ä»…æ˜¯ä¸­å›½äº‘è®¡ç®—ä¼ä¸šå‚ä¸åˆ¶å®šä¹ƒè‡³ä¸»å¯¼å‘èµ·çš„å›½é™…æŠ€æœ¯è§„èŒƒï¼Œä¹Ÿæ˜¯ä¸šç•Œé¦–ä¸ªäº‘åŸç”Ÿåº”ç”¨æ ‡å‡†å®šä¹‰ä¸æ¶æ„æ¨¡å‹ã€‚\nå¼€æ”¾åº”ç”¨æ¨¡å‹æ€æƒ³çš„æ ¸å¿ƒæ˜¯å¦‚ä½•å°†å¼€å‘äººå‘˜ã€è¿ç»´äººå‘˜ä¸å¹³å°äººå‘˜å…³æ³¨ç‚¹åˆ†ç¦»ï¼Œå¼€å‘äººå‘˜å…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å®ç°ï¼Œè¿ç»´äººå‘˜å…³æ³¨ç¨‹åºå¹³ç¨³è¿è¡Œï¼Œå¹³å°äººå‘˜å…³æ³¨åŸºç¡€è®¾æ–½çš„èƒ½åŠ›ä¸ç¨³å®šæ€§ï¼Œé•¿æœŸè®©å‡ ä¸ªè§’è‰²å®æ··åœ¨åŒä¸€ä¸ª All-in-One èµ„æºæ–‡ä»¶é‡Œï¼Œå¹¶ä¸èƒ½æ“¦å‡ºä»€ä¹ˆç«èŠ±ï¼Œåè€Œå°†é…ç½®å·¥ä½œå¼„å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå°†â€œYAML Engineerâ€å¼„æˆäº†å®¹å™¨ç•Œçš„å˜²è®½æ¢—ã€‚\nå¼€æ”¾åº”ç”¨æ¨¡å‹æŠŠäº‘åŸç”Ÿåº”ç”¨å®šä¹‰ä¸ºâ€œç”±ä¸€ç»„ç›¸äº’å…³è”ä½†åˆç¦»æ•£ç‹¬ç«‹çš„ç»„ä»¶æ„æˆï¼Œè¿™äº›ç»„ä»¶å®ä¾‹åŒ–åœ¨åˆé€‚çš„è¿è¡Œæ—¶ä¸Šï¼Œç”±é…ç½®æ¥æ§åˆ¶è¡Œä¸ºå¹¶å…±åŒåä½œæä¾›ç»Ÿä¸€çš„åŠŸèƒ½â€ã€‚æ²¡çœ‹æ˜ç™½å®šä¹‰å¹¶æ²¡æœ‰å…³ç³»ï¼Œä¸ºäº†ä¾¿äºè·Ÿç¨åçš„æ¦‚å¿µå¯¹åº”ï¼Œç¬”è€…é¦–å…ˆæŠŠè¿™å¥è¯æ‹†è§£ã€ç¿»è¯‘ä¸ºä½ æ›´åŠ çœ‹ä¸æ˜ç™½çš„å¦ä¸€ç§å½¢å¼ï¼š\nOAM å®šä¹‰çš„åº”ç”¨\nä¸€ä¸ªApplicationç”±ä¸€ç»„Componentsæ„æˆï¼Œæ¯ä¸ªComponentçš„è¿è¡ŒçŠ¶æ€ç”±Workloadæè¿°ï¼Œæ¯ä¸ªComponentå¯ä»¥æ–½åŠ Traitsæ¥è·å–é¢å¤–çš„è¿ç»´èƒ½åŠ›ï¼ŒåŒæ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨Application Scopeså°†Componentsåˆ’åˆ†åˆ°ä¸€æˆ–è€…å¤šä¸ªåº”ç”¨è¾¹ç•Œä¸­ï¼Œä¾¿äºç»Ÿä¸€åšé…ç½®ã€é™åˆ¶ã€ç®¡ç†ã€‚æŠŠComponentsã€Traitså’ŒScopesç»„åˆåœ¨ä¸€èµ·å®ä¾‹åŒ–éƒ¨ç½²ï¼Œå½¢æˆå…·ä½“çš„Application Configurationï¼Œä»¥ä¾¿è§£å†³åº”ç”¨çš„å¤šå®ä¾‹éƒ¨ç½²ä¸å‡çº§ã€‚\nç„¶åï¼Œç¬”è€…é€šè¿‡è§£æä¸Šè¿°æ‰€åˆ—çš„æ ¸å¿ƒæ¦‚å¿µæ¥å¸®åŠ©ä½ ç†è§£ OAM å¯¹åº”ç”¨çš„å®šä¹‰ã€‚è¿™æ®µè¯é‡Œé¢æ¯ä¸€ä¸ªç”¨è‹±æ–‡æ ‡æ³¨å‡ºæ¥çš„æŠ€æœ¯åè¯éƒ½æ˜¯ OAM åœ¨ Kubernetes åŸºç¡€ä¸Šæ‰©å±•è€Œæ¥æ¦‚å¿µï¼Œæ¯ä¸€ä¸ªåè¯éƒ½æœ‰ä¸“é—¨çš„è‡ªå®šä¹‰èµ„æºä¸ä¹‹å¯¹åº”ï¼Œæ¢è€Œè¨€ä¹‹ï¼Œå®ƒä»¬å¹¶éçº¯ç²¹çš„æŠ½è±¡æ¦‚å¿µï¼Œè€Œæ˜¯å¯ä»¥è¢«å®é™…ä½¿ç”¨çš„è‡ªå®šä¹‰èµ„æºã€‚è¿™äº›æ¦‚å¿µçš„å…·ä½“å«ä¹‰æ˜¯ï¼š\n\næœåŠ¡ç»„ä»¶ï¼ˆComponentsï¼‰ï¼šç”± Component æ„æˆåº”ç”¨çš„æ€æƒ³è‡ª SOA ä»¥æ¥å°±å±¡è§ä¸é²œï¼Œç„¶è€Œ OAM çš„ Component ä¸ä»…ä»…æ˜¯ç‰¹æŒ‡æ„æˆåº”ç”¨â€œæ•´ä½“â€çš„ä¸€ä¸ªâ€œéƒ¨åˆ†â€ï¼Œå®ƒè¿˜æœ‰ä¸€ä¸ªé‡è¦èŒè´£æ˜¯æŠ½è±¡é‚£äº›åº”è¯¥ç”±å¼€å‘äººå‘˜å»å…³æ³¨çš„å…ƒç´ ã€‚è­¬å¦‚åº”ç”¨çš„åå­—ã€è‡ªè¿°ã€å®¹å™¨é•œåƒã€è¿è¡Œæ‰€éœ€çš„å‚æ•°ï¼Œç­‰ç­‰ã€‚\n\nå·¥ä½œè´Ÿè·ï¼ˆWorkloadï¼‰ï¼šWorkload å†³å®šäº†åº”ç”¨çš„è¿è¡Œæ¨¡å¼ï¼Œæ¯ä¸ª Component éƒ½è¦è®¾å®šè‡ªå·±çš„ Workload ç±»å‹ï¼ŒOAM æŒ‰ç…§â€œæ˜¯å¦å¯è®¿é—®ã€æ˜¯å¦å¯å¤åˆ¶ã€æ˜¯å¦é•¿æœŸè¿è¡Œâ€é¢„å®šä¹‰äº†å…­ç§ Workload ç±»å‹ï¼Œå¦‚è¡¨ 11-2 æ‰€ç¤ºã€‚å¦‚æœ‰å¿…è¦è¿˜å¯ä»¥é€šè¿‡ CRD ä¸ Operator å»æ‰©å±•ã€‚\nè¡¨ 11-2 OAM çš„å…­ç§å·¥ä½œè´Ÿè·\n\n\n\nå·¥ä½œè´Ÿè·\nå¯è®¿é—®\nå¯å¤åˆ¶\né•¿æœŸè¿è¡Œ\n\n\n\nServer\nâˆš\nâˆš\nâˆš\n\n\nSingleton Server\nâˆš\nÃ—\nâˆš\n\n\nWorker\nÃ—\nâˆš\nâˆš\n\n\nSingleton Worker\nÃ—\nÃ—\nâˆš\n\n\nTask\nÃ—\nâˆš\nÃ—\n\n\nSingleton Task\nÃ—\nÃ—\nÃ—\n\n\n\nè¿ç»´ç‰¹å¾ï¼ˆTraitsï¼‰ï¼šå¼€å‘æ´»åŠ¨æœ‰å¤§é‡å¤ç”¨åŠŸèƒ½çš„æŠ€å·§ï¼Œä½†è¿ç»´æ´»åŠ¨å´å¾ˆè´«ä¹ï¼Œå¹³æ—¶èƒ½ä¸ºè¿ç»´å†™ä¸ª Shell è„šæœ¬æˆ–è€…ç®€å•å·¥å…·å·²ç»ç®—æ˜¯ä¸ªé«˜çº§çš„è¿ç»´äººå‘˜äº†ã€‚OAM çš„ Traits å°±ç”¨äºå°è£…æ¨¡å—åŒ–åçš„è¿ç»´èƒ½åŠ›ï¼Œå¯ä»¥é’ˆå¯¹è¿ç»´ä¸­çš„å¯é‡å¤æ“ä½œé¢„å…ˆè®¾å®šå¥½ä¸€äº›å…·ä½“çš„ Traitsï¼Œè­¬å¦‚æ—¥å¿—æ”¶é›† Traitã€è´Ÿè½½å‡è¡¡ Traitã€æ°´å¹³æ‰©ç¼©å®¹ Traitï¼Œç­‰ç­‰ã€‚ è¿™äº›é¢„å®šä¹‰çš„ Traits å®šä¹‰é‡Œï¼Œä¼šæ³¨æ˜å®ƒä»¬å¯ä»¥ä½œç”¨äºå“ªç§ç±»å‹çš„å·¥ä½œè´Ÿè·ã€åŒ…å«èƒ½å¡«å“ªäº›å‚æ•°ã€å“ªäº›å¿…å¡«é€‰å¡«é¡¹ã€å‚æ•°çš„ä½œç”¨æè¿°æ˜¯ä»€ä¹ˆï¼Œç­‰ç­‰ã€‚\n\nåº”ç”¨è¾¹ç•Œï¼ˆApplication Scopesï¼‰ï¼šå¤šä¸ª Component å…±åŒç»„æˆä¸€ä¸ª Scopeï¼Œä½ å¯ä»¥æ ¹æ® Component çš„ç‰¹æ€§æˆ–è€…ä½œç”¨åŸŸæ¥åˆ’åˆ† Scopeï¼Œè­¬å¦‚å…·æœ‰ç›¸åŒç½‘ç»œç­–ç•¥çš„ Component æ”¾åœ¨åŒä¸€ä¸ª Scope ä¸­ï¼Œå…·æœ‰ç›¸åŒå¥åº·åº¦é‡ç­–ç•¥çš„ Component æ”¾åˆ°å¦ä¸€ä¸ª Scope ä¸­ã€‚åŒæ—¶ï¼Œä¸€ä¸ª Component ä¹Ÿå¯èƒ½å±äºå¤šä¸ª Scopeï¼Œè­¬å¦‚ä¸€ä¸ª Component å®Œå…¨å¯èƒ½æ—¢éœ€è¦é…ç½®ç½‘ç»œç­–ç•¥ï¼Œä¹Ÿéœ€è¦é…ç½®å¥åº·åº¦é‡ç­–ç•¥ã€‚\n\nåº”ç”¨é…ç½®ï¼ˆApplication Configurationï¼‰ï¼šå°† Componentï¼ˆå¿…é¡»ï¼‰ã€Traitï¼ˆå¿…é¡»ï¼‰ã€Scopeï¼ˆéå¿…é¡»ï¼‰ç»„åˆåˆ°ä¸€èµ·è¿›è¡Œå®ä¾‹åŒ–ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªå®Œæ•´çš„åº”ç”¨é…ç½®ã€‚\n\n\nOAM ä½¿ç”¨ä¸Šè¿°ä»‹ç»çš„è¿™äº›è‡ªå®šä¹‰èµ„æºå°†åŸå…ˆ All-in-One çš„å¤æ‚é…ç½®åšäº†ä¸€å®šå±‚æ¬¡çš„è§£è€¦ï¼Œå¼€å‘äººå‘˜è´Ÿè´£ç®¡ç† Componentï¼›è¿ç»´äººå‘˜å°† Component ç»„åˆå¹¶ç»‘å®š Trait å˜æˆ Application Configurationï¼›å¹³å°äººå‘˜æˆ–åŸºç¡€è®¾æ–½æä¾›æ–¹è´Ÿè´£æä¾› OAM çš„è§£é‡Šèƒ½åŠ›ï¼Œå°†è¿™äº›è‡ªå®šä¹‰èµ„æºæ˜ å°„åˆ°å®é™…çš„åŸºç¡€è®¾æ–½ã€‚ä¸åŒè§’è‰²åˆ†å·¥åä½œï¼Œæ•´ä½“ç®€åŒ–äº†å•ä¸ªè§’è‰²å…³æ³¨çš„å†…å®¹ï¼Œä½¿å¾—ä¸åŒè§’è‰²å¯ä»¥æ›´èšç„¦æ›´ä¸“ä¸šçš„åšå¥½æœ¬è§’è‰²çš„å·¥ä½œï¼Œæ•´ä¸ªè¿‡ç¨‹å¦‚å›¾ 11-8 æ‰€ç¤ºã€‚\n\nï¼ˆå›¾ç‰‡æ¥è‡ªOAM è§„èŒƒ GitHub)\nOAM æœªæ¥èƒ½å¦æˆåŠŸï¼Œå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºäº‘è®¡ç®—å‚å•†çš„æ”¯æŒåŠ›åº¦ï¼Œå› ä¸º OAM çš„è‡ªå®šä¹‰èµ„æºä¸€èˆ¬æ˜¯ç”±äº‘è®¡ç®—åŸºç¡€è®¾æ–½è´Ÿè´£è§£é‡Šå’Œé©±åŠ¨çš„ï¼Œè­¬å¦‚é˜¿é‡Œäº‘çš„EDASå°±å·²å†…ç½®äº† OAM çš„æ”¯æŒã€‚å¦‚æœä½ å¸Œæœ›èƒ½å¤Ÿåº”ç”¨äºç§æœ‰ Kubernetes ç¯å¢ƒï¼Œç›®å‰ OAM çš„ä¸»è¦å‚è€ƒå®ç°æ˜¯Rudrï¼ˆå·²å£°æ˜åºŸå¼ƒï¼‰å’ŒCrossplaneï¼ŒCrossplane æ˜¯ä¸€ä¸ªä»…å‘èµ·ä¸€å¹´å¤šçš„ CNCF æ²™ç®±é¡¹ç›®ï¼Œä¸»è¦å‚ä¸è€…åŒ…æ‹¬é˜¿é‡Œäº‘ã€å¾®è½¯ã€Googleã€RedHat ç­‰å·¥ç¨‹å¸ˆã€‚Crossplane æä¾›äº† OAM ä¸­å…¨éƒ¨çš„è‡ªå®šä¹‰èµ„æºä»¥åŠæ§åˆ¶å™¨ï¼Œå®‰è£…åä¾¿å¯ç”¨ OAM å®šä¹‰çš„èµ„æºæ¥æè¿°åº”ç”¨ã€‚\n\nåè®°ï¼šä»Šå¤©å®¹å™¨åœˆçš„å‘å±•æ˜¯ä¸€æ—¥åƒé‡Œï¼Œå„ç§æ–°è§„èŒƒã€æ–°æŠ€æœ¯å±‚å‡ºä¸ç©·ï¼Œæœ¬èŠ‚æ ¹æ®äººæ°”å’Œä»£è¡¨æ€§ï¼Œåˆ—ä¸¾äº†å…¶ä¸­æœ€å‡ºåçš„å››ç§ï¼Œå…¶ä»–ç¬”è€…æœªæåˆ°çš„åº”ç”¨å°è£…æŠ€æœ¯è¿˜æœ‰CNABã€Armadaã€Pulumiç­‰ç­‰ã€‚è¿™äº›å°è£…æŠ€æœ¯ä¼šæœ‰ä¸€å®šçš„é‡å ä¹‹å¤„ï¼Œä½†å¹¶ééƒ½æ˜¯é‡å¤çš„è½®å­ï¼Œå®é™…åº”ç”¨æ—¶å¾€å¾€ä¼šè”åˆå…¶ä¸­å¤šä¸ªå·¥å…·ä¸€èµ·ä½¿ç”¨ã€‚åº”è¯¥å¦‚ä½•å°è£…åº”ç”¨æ‰æ˜¯æœ€ä½³çš„å®è·µï¼Œç›®å‰å°šä¸”æ²¡æœ‰å®šè®ºï¼Œä½†æ˜¯ä»¥åº”ç”¨ä¸ºä¸­å¿ƒçš„ç†å¿µå´å·²ç»æˆä¸ºæ˜ç¡®çš„å…±è¯†ã€‚\n","categories":["å‡¤å‡°æ¶æ„"]},{"title":"I/Oæ¨¡å‹ä¸å•æœåŠ¡å™¨é«˜æ€§èƒ½æ¶æ„","url":"/posts/10118/","content":"ä¸€ã€å‰è¨€é«˜æ€§èƒ½æ˜¯æ¯ä¸ªç¨‹åºå‘˜çš„è¿½æ±‚ï¼Œæ— è®ºæˆ‘ä»¬æ˜¯åšä¸€ä¸ªç³»ç»Ÿè¿˜æ˜¯å†™ä¸€è¡Œä»£ç ï¼Œéƒ½å¸Œæœ›èƒ½å¤Ÿè¾¾åˆ°é«˜æ€§èƒ½çš„æ•ˆæœï¼Œè€Œé«˜æ€§èƒ½åˆæ˜¯æœ€å¤æ‚çš„ä¸€ç¯ï¼Œç£ç›˜ã€æ“ä½œç³»ç»Ÿã€CPUã€å†…å­˜ã€ç¼“å­˜ã€ç½‘ç»œã€ç¼–ç¨‹è¯­è¨€ã€æ¶æ„ç­‰ï¼Œæ¯ä¸ªéƒ½æœ‰å¯èƒ½å½±å“ç³»ç»Ÿè¾¾åˆ°é«˜æ€§èƒ½ï¼Œä¸€è¡Œä¸æ°å½“çš„ debug æ—¥å¿—ï¼Œå°±å¯èƒ½å°†æœåŠ¡å™¨çš„æ€§èƒ½ä» TPS 30000 é™ä½åˆ° 8000ï¼›ä¸€ä¸ª tcp_nodelay å‚æ•°ï¼Œå°±å¯èƒ½å°†å“åº”æ—¶é—´ä» 2 æ¯«ç§’å»¶é•¿åˆ° 40 æ¯«ç§’ã€‚å› æ­¤ï¼Œè¦åšåˆ°é«˜æ€§èƒ½è®¡ç®—æ˜¯ä¸€ä»¶å¾ˆå¤æ‚å¾ˆæœ‰æŒ‘æˆ˜çš„äº‹æƒ…ï¼Œè½¯ä»¶ç³»ç»Ÿå¼€å‘è¿‡ç¨‹ä¸­çš„ä¸åŒé˜¶æ®µéƒ½å…³ç³»ç€é«˜æ€§èƒ½æœ€ç»ˆæ˜¯å¦èƒ½å¤Ÿå®ç°ã€‚\nç«™åœ¨æ¶æ„å¸ˆçš„è§’åº¦ï¼Œå½“ç„¶éœ€è¦ç‰¹åˆ«å…³æ³¨é«˜æ€§èƒ½æ¶æ„çš„è®¾è®¡ã€‚\né«˜æ€§èƒ½æ¶æ„è®¾è®¡ä¸»è¦é›†ä¸­åœ¨ä¸¤æ–¹é¢ï¼š\n\nå°½é‡æå‡å•æœåŠ¡å™¨çš„æ€§èƒ½ï¼Œå°†å•æœåŠ¡å™¨çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ã€‚\nå¦‚æœå•æœåŠ¡å™¨æ— æ³•æ”¯æ’‘æ€§èƒ½ï¼Œè®¾è®¡æœåŠ¡å™¨é›†ç¾¤æ–¹æ¡ˆã€‚\n\né™¤äº†ä»¥ä¸Šä¸¤ç‚¹ï¼Œæœ€ç»ˆç³»ç»Ÿèƒ½å¦å®ç°é«˜æ€§èƒ½ï¼Œè¿˜å’Œå…·ä½“çš„å®ç°åŠç¼–ç ç›¸å…³ã€‚ä½†æ¶æ„è®¾è®¡æ˜¯é«˜æ€§èƒ½çš„åŸºç¡€ï¼Œå¦‚æœæ¶æ„è®¾è®¡æ²¡æœ‰åšåˆ°é«˜æ€§èƒ½ï¼Œåˆ™åé¢çš„å…·ä½“å®ç°å’Œç¼–ç èƒ½æå‡çš„ç©ºé—´æ˜¯æœ‰é™çš„ã€‚å½¢è±¡åœ°è¯´ï¼Œæ¶æ„è®¾è®¡å†³å®šäº†ç³»ç»Ÿæ€§èƒ½çš„ä¸Šé™ï¼Œå®ç°ç»†èŠ‚å†³å®šäº†ç³»ç»Ÿæ€§èƒ½çš„ä¸‹é™ã€‚\nå•æœåŠ¡å™¨é«˜æ€§èƒ½çš„å…³é”®ä¹‹ä¸€å°±æ˜¯ æœåŠ¡å™¨é‡‡å–çš„å¹¶å‘æ¨¡å‹ã€‚\nå¹¶å‘æ¨¡å‹æœ‰å¦‚ä¸‹ä¸¤ä¸ªå…³é”®è®¾è®¡ç‚¹ï¼š\n\næœåŠ¡å™¨å¦‚ä½•ç®¡ç†è¿æ¥ã€‚\næœåŠ¡å™¨å¦‚ä½•å¤„ç†è¯·æ±‚ã€‚\n\nä»¥ä¸Šä¸¤ä¸ªè®¾è®¡ç‚¹æœ€ç»ˆéƒ½å’Œæ“ä½œç³»ç»Ÿçš„ I/O æ¨¡å‹åŠè¿›ç¨‹æ¨¡å‹ç›¸å…³ã€‚\n\nI/O æ¨¡å‹ï¼šé˜»å¡ã€éé˜»å¡ã€åŒæ­¥ã€å¼‚æ­¥ã€‚\nè¿›ç¨‹æ¨¡å‹ï¼šå•è¿›ç¨‹ã€å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ã€‚\n\nä»€ä¹ˆæ˜¯SocketSocketæ˜¯ åº”ç”¨å±‚ä¸TCP/IPåè®®æ—é€šä¿¡çš„ä¸­é—´è½¯ä»¶æŠ½è±¡å±‚ï¼Œå®ƒæ˜¯ä¸€ç»„æ¥å£ã€‚\nåœ¨è®¾è®¡æ¨¡å¼ä¸­ï¼ŒSocketå…¶å®å°±æ˜¯ä¸€ä¸ªé—¨é¢æ¨¡å¼ï¼Œå®ƒæŠŠå¤æ‚çš„TCP/IPåè®®æ—éšè—åœ¨Socket æ¥å£åé¢ï¼Œå¯¹ç”¨æˆ·æ¥è¯´ï¼Œä¸€ç»„ç®€å•çš„æ¥å£å°±æ˜¯å…¨éƒ¨ï¼Œè®©Socketå»ç»„ç»‡æ•°æ®ï¼Œä»¥ç¬¦åˆæŒ‡å®šçš„åè®®ã€‚\n\näºŒã€I/Oæ¨¡å‹1.å¸¸è§I/Oæ¨¡å‹\nåŒæ­¥é˜»å¡IOï¼ˆBlocking IOï¼‰ï¼šå³ä¼ ç»ŸIOæ¨¡å‹ï¼Œåœ¨å†…æ ¸å‡†å¤‡å¥½æ•°æ®å¹¶ä¼ è¾“å®Œæ¯•ä¹‹å‰ï¼Œç”¨æˆ·çº¿ç¨‹éƒ½å¤„äºé˜»å¡ç­‰å¾…çŠ¶æ€ï¼›\nåŒæ­¥éé˜»å¡IOï¼ˆNon-Blocking IOï¼‰ï¼šå¦‚æœæ•°æ®æœªå‡†å¤‡å¥½ï¼Œç«‹å³è¿”å›é”™è¯¯ä¸ç­‰å¾…ã€‚ç”¨æˆ·çº¿ç¨‹é‡‡ç”¨è½®è¯¢çš„æ–¹å¼ä¸æ–­å°è¯•è¯»ã€‚æ ¹æ®å®ç°ä¸åŒï¼Œä¹Ÿå¯ä»¥åœ¨æ•°æ®å°±ç»ªæ—¶ä¸è¿”å›å†…å®¹è€Œè¿”å›å°±ç»ªæ ‡å¿—ï¼Œéšåè°ƒç”¨æ–¹å†å‘èµ·è·å–æ•°æ®çš„è°ƒç”¨ï¼›\nIOå¤šè·¯å¤ç”¨ï¼ˆIO Multiplexingï¼‰ï¼šä¹Ÿè¢«ç§°ä¸º å¼‚æ­¥é˜»å¡IOã€‚æ˜¯å¯¹NIOçš„å¢å¼ºï¼Œå¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªNIOå¥æŸ„çš„çŠ¶æ€ï¼Œæ¯æ¬¡è°ƒç”¨æ—¶å°†è½®è¯¢æ‰€æœ‰çš„NIOå¥æŸ„å¹¶è¿”å›æ‰€æœ‰å·²å°±ç»ªçš„é›†åˆã€‚å¤šè·¯å¤ç”¨æœ¬èº«ä¹Ÿæ˜¯åŒæ­¥IOã€‚Javaä¸­çš„ Selector å’Œ linux ä¸­çš„ epoll éƒ½æ˜¯è¿™ç§æ¨¡å‹ï¼›\nå¼‚æ­¥IOï¼ˆAsynchronous IOï¼‰ï¼šä¹Ÿè¢«ç§°ä¸º å¼‚æ­¥éé˜»å¡IOï¼Œæ— è®ºæ•°æ®æ˜¯å¦å‡†å¤‡å¥½éƒ½ç«‹å³è¿”å›ç©ºï¼Œç³»ç»Ÿå†…æ ¸å‡†å¤‡å¥½æ•°æ®å¹¶ä¼ è¾“å®Œæ¯•åï¼Œé€šè¿‡ä¿¡å·æˆ–å›è°ƒå‡½æ•°é€šçŸ¥ç”¨æˆ·çº¿ç¨‹ã€‚å¯¹äºç³»ç»Ÿè°ƒç”¨æ¥è¯´ï¼ŒAIOçš„æ•°æ®ä¼ è¾“æ“ä½œç”±æ“ä½œç³»ç»Ÿå†…æ ¸è¿›ç¨‹æ¥æ‰§è¡Œã€‚\n\nåŒæ­¥ä¸å¼‚æ­¥åŒæ­¥ä¸å¼‚æ­¥æè¿°çš„æ˜¯ ç”¨æˆ·çº¿ç¨‹ä¸å†…æ ¸çš„äº¤äº’æ–¹å¼ï¼Œå³ç”¨æˆ·çº¿ç¨‹ä»å‘èµ·IOè¯·æ±‚ååˆ°çœŸæ­£å¾—åˆ°æˆ–å†™å…¥æ•°æ®å®Œæˆçš„æ•´ä¸ªè¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹åŒ…æ‹¬ä¸‹é¢çš„é˜»å¡æˆ–éã€‚\n\nåŒæ­¥ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ·IOè¯·æ±‚åéœ€è¦ç­‰å¾…æˆ–è€…è½®è¯¢å†…æ ¸IOæ“ä½œï¼Œå®Œæˆåæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚\nå¼‚æ­¥ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹å‘èµ·IOè¯·æ±‚åä»ç»§ç»­æ‰§è¡Œï¼Œå½“å†…æ ¸IOæ“ä½œå®Œæˆåå›é€šçŸ¥ç”¨æˆ·çº¿ç¨‹ï¼Œæˆ–è€…è°ƒç”¨ç”¨æˆ·çº¿ç¨‹æ³¨å†Œçš„å›è°ƒå‡½æ•°ã€‚\n\né˜»å¡ä¸éé˜»å¡é˜»å¡ä¸éé˜»å¡æè¿°çš„æ˜¯ ç”¨æˆ·çº¿ç¨‹è°ƒç”¨å†…æ ¸IOæ“ä½œæ–¹å¼ï¼Œä¾‹å¦‚ï¼šreadå’Œwriteæ–¹æ³•ã€‚\n\n\né˜»å¡ï¼šå½“ read buffer ä¸ºç©ºæ—¶ï¼Œç”¨æˆ·çº¿ç¨‹é˜»å¡ç­‰å¾…å¯è¯»ï¼Œå½“ write buffer æ»¡äº†æˆ–å®¹é‡ä¸è¶³æ—¶ï¼Œç”¨æˆ·çº¿ç¨‹é˜»å¡ç­‰å¾…å¯å†™ã€‚\néé˜»å¡ï¼šæŒ‡IOæ“ä½œï¼ˆreadæˆ–writeï¼‰è¢«è°ƒç”¨åç«‹å³è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªçŠ¶æ€å€¼ï¼Œæ— éœ€ç­‰å¾…IOæ“ä½œå½»åº•å®Œæˆã€‚\n\nä¸¾ä¸ªä¾‹å­ï¼š\nNIO ä¹‹æ‰€ä»¥æ˜¯éé˜»å¡çš„ï¼Œæ˜¯å› ä¸ºç”¨æˆ·çº¿ç¨‹åœ¨çŸ¥é“ä¸å¯è¯»æ—¶ï¼Œå¹¶æ²¡æœ‰é˜»å¡è‡ªå·±ï¼Œè€Œæ˜¯ä¸æ–­è½®è¯¢æ˜¯å¦å¯è¯»ã€‚\nåœ¨ Java IOå¤šè·¯å¤ç”¨ ä¸­ï¼Œä¼šç”¨ä¸€ä¸ªæ­»å¾ªç¯è°ƒç”¨ select æ–¹æ³•ï¼Œè€Œ select æ–¹æ³•æ˜¯ä¼šé˜»å¡çº¿ç¨‹çš„ï¼Œæ‰€ä»¥å®ƒæ˜¯é˜»å¡IOã€‚\nä½†æ˜¯ä¸€ä¸ª Selector å¯ä»¥åŒæ—¶ç›‘æ§å¤šä¸ª socket çš„çŠ¶æ€ï¼Œé€ æˆäº†å¼‚æ­¥çš„å‡è±¡ã€‚åªæœ‰ AIO æ˜¯çœŸæ­£çš„å¼‚æ­¥ã€‚\n2.åŒæ­¥é˜»å¡IOåŒæ­¥é˜»å¡IOæ˜¯æœ€ç®€å•çš„IOæ¨¡å‹ï¼Œç”¨æˆ·çº¿ç¨‹åœ¨å†…æ ¸è¿›è¡ŒIOæ“ä½œæ—¶è¢«é˜»å¡ã€‚ç”¨æˆ·çº¿ç¨‹é€šè¿‡è°ƒç”¨ç³»ç»Ÿè°ƒç”¨readå‘èµ·IOè¯»æ“ä½œï¼Œç”±ç”¨æˆ·ç©ºé—´è½¬åˆ°å†…æ ¸ç©ºé—´ã€‚å†…æ ¸ç­‰åˆ°æ•°æ®åŒ…åˆ°è¾¾åï¼Œç„¶åå°†æ¥å—çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼Œå®Œæˆreadæ“ä½œã€‚æ•´ä¸ªIOè¯·æ±‚è¿‡ç¨‹ï¼Œç”¨æˆ·çº¿ç¨‹éƒ½æ˜¯è¢«é˜»å¡çš„ï¼Œå¯¹CPUåˆ©ç”¨ç‡ä¸å¤Ÿå‹å¥½ã€‚\n\nä»£ç ç¤ºä¾‹import java.io.BufferedWriter;import java.io.IOException;import java.io.OutputStreamWriter;import java.net.ServerSocket;import java.net.Socket;public class BIOTest &#123;    public static void main(String[] args) throws IOException &#123;        ServerSocket serverSocket = new ServerSocket(8888, 1024, null);        System.out.println(&quot;æœåŠ¡å¯åŠ¨&quot;);        while (true) &#123;            Socket socket = serverSocket.accept();            System.out.println(socket.getRemoteSocketAddress());            BufferedWriter bufferedWriter = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream()));            bufferedWriter.append(IOUtils.buildResp());            bufferedWriter.flush();        &#125;    &#125;&#125;\n\n3.åŒæ­¥éé˜»å¡IOåœ¨åŒæ­¥åŸºç¡€ä¸Šï¼Œå°†socketè®¾ç½®ä¸ºNONBLOCKï¼Œè¿™æ ·ç”¨æˆ·çº¿ç¨‹å¯ä»¥åœ¨å‘èµ·IOè¯·æ±‚åç«‹å³è¿”å›ã€‚è™½è¯´å¯ä»¥ç«‹å³è¿”å›ï¼Œä½†å¹¶æœªè¯»åˆ°ä»»ä½•æ•°æ®ï¼Œç”¨æˆ·çº¿ç¨‹éœ€è¦ä¸æ–­çš„å‘èµ·IOè¯·æ±‚ï¼Œç›´åˆ°æ•°æ®åˆ°è¾¾åæ‰èƒ½çœŸæ­£è¯»åˆ°æ•°æ®ï¼Œç„¶åå»å¤„ç†ã€‚\n æ•´ä¸ªIOè¯·æ±‚ä¸­ï¼Œè™½ç„¶å¯ä»¥ç«‹å³è¿”å›ï¼Œä½†æ˜¯å› ä¸ºæ˜¯åŒæ­¥çš„ï¼Œä¸ºäº†ç­‰åˆ°æ•°æ®ï¼Œéœ€è¦ä¸æ–­çš„è½®è¯¢ã€é‡å¤è¯·æ±‚ï¼Œæ¶ˆè€—äº†å¤§é‡çš„CPUèµ„æºã€‚å› æ­¤ï¼Œè¿™ç§æ¨¡å‹å¾ˆå°‘ä½¿ç”¨ï¼Œå®é™…ç”¨å¤„ä¸å¤§ã€‚\n\n4.IOå¤šè·¯å¤ç”¨ä¸ç®¡æ˜¯åŒæ­¥é˜»å¡è¿˜æ˜¯åŒæ­¥éé˜»å¡ï¼Œå¯¹ç³»ç»Ÿæ€§èƒ½çš„æå‡éƒ½æ˜¯å¾ˆå°çš„ã€‚è€Œé€šè¿‡å¤ç”¨å¯ä»¥ä½¿ä¸€ä¸ªæˆ–ä¸€ç»„çº¿ç¨‹ï¼ˆçº¿ç¨‹æ± ï¼‰å¤„ç†å¤šä¸ªTCPè¿æ¥ã€‚IOå¤šè·¯å¤ç”¨ä½¿ç”¨ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨ï¼ˆselect/poll/epollå’Œrecvfromï¼‰ï¼Œblocking IOåªè°ƒç”¨äº†recvfromã€‚select/poll/epollæ ¸å¿ƒæ˜¯å¯ä»¥åŒæ—¶å¤„ç†å¤šä¸ªconnectionï¼Œè€Œä¸æ˜¯æ›´å¿«ï¼Œæ‰€ä»¥è¿æ¥æ•°ä¸é«˜çš„è¯ï¼Œæ€§èƒ½ä¸ä¸€å®šæ¯”å¤šçº¿ç¨‹+é˜»å¡IOå¥½ã€‚\n selectæ˜¯å†…æ ¸æä¾›çš„å¤šè·¯åˆ†ç¦»å‡½æ•°ï¼Œä½¿ç”¨å®ƒå¯ä»¥é¿å…åŒæ­¥éé˜»å¡IOä¸­è½®è¯¢ç­‰å¾…é—®é¢˜ã€‚\n\nç”¨æˆ·é¦–å…ˆå°†éœ€è¦è¿›è¡ŒIOæ“ä½œçš„socketæ·»åŠ åˆ°selectä¸­ï¼Œç„¶åé˜»å¡ç­‰å¾…selectç³»ç»Ÿè°ƒç”¨è¿”å›ã€‚å½“æ•°æ®åˆ°è¾¾æ—¶ï¼Œsocketè¢«æ¿€æ´»ï¼Œselectå‡½æ•°è¿”å›ï¼Œç”¨æˆ·çº¿ç¨‹æ­£å¼å‘èµ·readè¯·æ±‚ï¼Œè¯»å–æ•°æ®å¹¶ç»§ç»­æ‰§è¡Œã€‚\n è¿™ä¹ˆä¸€çœ‹ï¼Œè¿™ç§æ–¹å¼å’ŒåŒæ­¥é˜»å¡IOå¹¶æ²¡æœ‰å¤ªå¤§åŒºåˆ«ï¼Œç”šè‡³è¿˜å¤šäº†æ·»åŠ ç›‘è§†socketä»¥åŠè°ƒç”¨selectå‡½æ•°çš„é¢å¤–æ“ä½œï¼Œæ•ˆç‡æ›´å·®ã€‚ä½†æ˜¯ä½¿ç”¨selectä»¥åï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹å†…åŒæ—¶å¤„ç†å¤šä¸ªsocketçš„IOè¯·æ±‚ï¼Œè¿™å°±æ˜¯å®ƒçš„æœ€å¤§ä¼˜åŠ¿ã€‚ç”¨æˆ·å¯ä»¥æ³¨å†Œå¤šä¸ªsocketï¼Œç„¶åä¸æ–­è°ƒç”¨selectè¯»å–è¢«æ¿€æ´»çš„socketï¼Œå³å¯è¾¾åˆ°åŒä¸€ä¸ªçº¿ç¨‹åŒæ—¶å¤„ç†å¤šä¸ªIOè¯·æ±‚çš„ç›®çš„ã€‚è€Œåœ¨åŒæ­¥é˜»å¡æ¨¡å‹ä¸­ï¼Œå¿…é¡»é€šè¿‡å¤šçº¿ç¨‹æ–¹å¼æ‰èƒ½è¾¾åˆ°è¿™ä¸ªç›®çš„ã€‚æ‰€ä»¥IOå¤šè·¯å¤ç”¨è®¾è®¡ç›®çš„å…¶å®ä¸æ˜¯ä¸ºäº†å¿«ï¼Œè€Œæ˜¯ä¸ºäº†è§£å†³çº¿ç¨‹/è¿›ç¨‹æ•°é‡è¿‡å¤šå¯¹æœåŠ¡å™¨å¼€é”€é€ æˆçš„å‹åŠ›ã€‚\nè™½ç„¶è¿™ç§æ–¹å¼å…è®¸å•çº¿ç¨‹å†…å¤„ç†å¤šä¸ªIOè¯·æ±‚ï¼Œä½†æ˜¯æ¯ä¸ªIOè¯·æ±‚çš„è¿‡ç¨‹è¿˜æ˜¯é˜»å¡çš„ï¼ˆåœ¨selectå‡½æ•°ä¸Šé˜»å¡ï¼‰ï¼Œå¹³å‡æ—¶é—´ç”šè‡³æ¯”åŒæ­¥é˜»å¡IOæ¨¡å‹è¿˜è¦é•¿ã€‚å¦‚æœç”¨æˆ·çº¿ç¨‹åªæ³¨å†Œè‡ªå·±æ„Ÿå…´è¶£çš„socketï¼Œç„¶åå»åšè‡ªå·±çš„äº‹æƒ…ï¼Œç­‰åˆ°æ•°æ®åˆ°æ¥æ—¶åœ¨è¿›è¡Œå¤„ç†ï¼Œåˆ™å¯ä»¥æé«˜CPUåˆ©ç”¨ç‡ã€‚\n5.å¼‚æ­¥éé˜»å¡IO åœ¨IOå¤šè·¯å¤ç”¨æ¨¡å‹ä¸­ï¼Œäº‹ä»¶å¾ªç¯æ–‡ä»¶å¥æŸ„çš„çŠ¶æ€äº‹ä»¶é€šçŸ¥ç»™ç”¨æˆ·çº¿ç¨‹ï¼Œç”±ç”¨æˆ·çº¿ç¨‹è‡ªè¡Œè¯»å–æ•°æ®ã€å¤„ç†æ•°æ®ã€‚è€Œå¼‚æ­¥IOä¸­ï¼Œå½“ç”¨æˆ·çº¿ç¨‹æ”¶åˆ°é€šçŸ¥æ—¶å€™ï¼Œæ•°æ®å·²ç»è¢«å†…æ ¸è¯»å–å®Œæ¯•ï¼Œå¹¶æ”¾åœ¨äº†ç”¨æˆ·çº¿ç¨‹æŒ‡å®šçš„ç¼“å†²åŒºå†…ï¼Œå†…æ ¸åœ¨IOå®Œæˆåé€šçŸ¥ç”¨æˆ·çº¿ç¨‹ç›´æ¥ä½¿ç”¨å°±è¡Œäº†ã€‚å› æ­¤è¿™ç§æ¨¡å‹éœ€è¦æ“ä½œç³»ç»Ÿæ›´å¼ºçš„æ”¯æŒï¼ŒæŠŠreadæ“ä½œä»ç”¨æˆ·çº¿ç¨‹è½¬ç§»åˆ°äº†å†…æ ¸ã€‚\n ç›¸æ¯”äºIOå¤šè·¯å¤ç”¨æ¨¡å‹ï¼Œå¼‚æ­¥IOå¹¶ä¸ååˆ†å¸¸ç”¨ï¼Œä¸å°‘é«˜æ€§èƒ½å¹¶å‘æœåŠ¡ç¨‹åºä½¿ç”¨IOå¤šè·¯å¤ç”¨+å¤šçº¿ç¨‹ä»»åŠ¡å¤„ç†çš„æ¶æ„åŸºæœ¬å¯ä»¥æ»¡è¶³éœ€æ±‚ã€‚ä¸è¿‡æœ€ä¸»è¦åŸå› è¿˜æ˜¯æ“ä½œç³»ç»Ÿå¯¹å¼‚æ­¥IOçš„æ”¯æŒå¹¶éç‰¹åˆ«å®Œå–„ï¼Œæ›´å¤šçš„é‡‡ç”¨IOå¤šè·¯å¤ç”¨æ¨¡æ‹Ÿå¼‚æ­¥IOæ–¹å¼ï¼ˆIOäº‹ä»¶è§¦å‘æ—¶ä¸ç›´æ¥é€šçŸ¥ç”¨æˆ·çº¿ç¨‹ï¼Œè€Œæ˜¯å°†æ•°æ®è¯»å†™å®Œæ¯•åæ”¾åˆ°ç”¨æˆ·æŒ‡å®šçš„ç¼“å†²åŒºï¼‰ã€‚\nä¸‰ã€å•æœåŠ¡å™¨é«˜æ€§èƒ½æ¶æ„1.PPCPPC æ˜¯ Process Per Connection çš„ç¼©å†™ï¼Œå…¶å«ä¹‰æ˜¯æŒ‡æ¯æ¬¡æœ‰æ–°çš„è¿æ¥å°±æ–°å»ºä¸€ä¸ªè¿›ç¨‹å»ä¸“é—¨å¤„ç†è¿™ä¸ªè¿æ¥çš„è¯·æ±‚ï¼Œè¿™æ˜¯ä¼ ç»Ÿçš„ UNIX ç½‘ç»œæœåŠ¡å™¨æ‰€é‡‡ç”¨çš„æ¨¡å‹ã€‚åŸºæœ¬çš„æµç¨‹å›¾æ˜¯ï¼š\n\n\nçˆ¶è¿›ç¨‹æ¥å—è¿æ¥ï¼ˆå›¾ä¸­ acceptï¼‰\nçˆ¶è¿›ç¨‹â€œforkâ€å­è¿›ç¨‹ï¼ˆå›¾ä¸­ forkï¼‰\nå­è¿›ç¨‹å¤„ç†è¿æ¥çš„è¯»å†™è¯·æ±‚ï¼ˆå›¾ä¸­å­è¿›ç¨‹ readã€ä¸šåŠ¡å¤„ç†ã€writeï¼‰\nå­è¿›ç¨‹å…³é—­è¿æ¥ï¼ˆå›¾ä¸­å­è¿›ç¨‹ä¸­çš„ closeï¼‰\n\næ³¨æ„ï¼Œå›¾ä¸­æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œçˆ¶è¿›ç¨‹â€œforkâ€å­è¿›ç¨‹åï¼Œç›´æ¥è°ƒç”¨äº† closeï¼Œçœ‹èµ·æ¥å¥½åƒæ˜¯å…³é—­äº†è¿æ¥ï¼Œå…¶å®åªæ˜¯å°†è¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨è®¡æ•°å‡ä¸€ï¼ŒçœŸæ­£çš„å…³é—­è¿æ¥æ˜¯ç­‰å­è¿›ç¨‹ä¹Ÿè°ƒç”¨ close åï¼Œè¿æ¥å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦å¼•ç”¨è®¡æ•°å˜ä¸º 0 åï¼Œæ“ä½œç³»ç»Ÿæ‰ä¼šçœŸæ­£å…³é—­è¿æ¥ï¼Œæ›´å¤šç»†èŠ‚è¯·å‚è€ƒã€ŠUNIX ç½‘ç»œç¼–ç¨‹ï¼šå·ä¸€ã€‹ã€‚\nPPC æ¨¡å¼å®ç°ç®€å•ï¼Œæ¯”è¾ƒé€‚åˆæœåŠ¡å™¨çš„è¿æ¥æ•°æ²¡é‚£ä¹ˆå¤šçš„æƒ…å†µï¼Œä¾‹å¦‚æ•°æ®åº“æœåŠ¡å™¨ã€‚å¯¹äºæ™®é€šçš„ä¸šåŠ¡æœåŠ¡å™¨ï¼Œåœ¨äº’è”ç½‘å…´èµ·ä¹‹å‰ï¼Œç”±äºæœåŠ¡å™¨çš„è®¿é—®é‡å’Œå¹¶å‘é‡å¹¶æ²¡æœ‰é‚£ä¹ˆå¤§ï¼Œè¿™ç§æ¨¡å¼å…¶å®è¿ä½œå¾—ä¹ŸæŒºå¥½ï¼Œä¸–ç•Œä¸Šç¬¬ä¸€ä¸ª web æœåŠ¡å™¨ CERN httpd å°±é‡‡ç”¨äº†è¿™ç§æ¨¡å¼ï¼ˆå…·ä½“ä½ å¯ä»¥å‚è€ƒhttps://en.wikipedia.org/wiki/CERN_httpdï¼‰ã€‚äº’è”ç½‘å…´èµ·åï¼ŒæœåŠ¡å™¨çš„å¹¶å‘å’Œè®¿é—®é‡ä»å‡ åå‰§å¢åˆ°æˆåƒä¸Šä¸‡ï¼Œè¿™ç§æ¨¡å¼çš„å¼Šç«¯å°±å‡¸æ˜¾å‡ºæ¥äº†ï¼Œä¸»è¦ä½“ç°åœ¨è¿™å‡ ä¸ªæ–¹é¢ï¼š\n\nfork ä»£ä»·é«˜ï¼šç«™åœ¨æ“ä½œç³»ç»Ÿçš„è§’åº¦ï¼Œåˆ›å»ºä¸€ä¸ªè¿›ç¨‹çš„ä»£ä»·æ˜¯å¾ˆé«˜çš„ï¼Œéœ€è¦åˆ†é…å¾ˆå¤šå†…æ ¸èµ„æºï¼Œéœ€è¦å°†å†…å­˜æ˜ åƒä»çˆ¶è¿›ç¨‹å¤åˆ¶åˆ°å­è¿›ç¨‹ã€‚å³ä½¿ç°åœ¨çš„æ“ä½œç³»ç»Ÿåœ¨å¤åˆ¶å†…å­˜æ˜ åƒæ—¶ç”¨åˆ°äº† Copy on Writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰æŠ€æœ¯ï¼Œæ€»ä½“æ¥è¯´åˆ›å»ºè¿›ç¨‹çš„ä»£ä»·è¿˜æ˜¯å¾ˆå¤§çš„ã€‚\nçˆ¶å­è¿›ç¨‹é€šä¿¡å¤æ‚ï¼šçˆ¶è¿›ç¨‹â€œforkâ€å­è¿›ç¨‹æ—¶ï¼Œæ–‡ä»¶æè¿°ç¬¦å¯ä»¥é€šè¿‡å†…å­˜æ˜ åƒå¤åˆ¶ä»çˆ¶è¿›ç¨‹ä¼ åˆ°å­è¿›ç¨‹ï¼Œä½†â€œforkâ€å®Œæˆåï¼Œçˆ¶å­è¿›ç¨‹é€šä¿¡å°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦é‡‡ç”¨ IPCï¼ˆInterprocess Communicationï¼‰ä¹‹ç±»çš„è¿›ç¨‹é€šä¿¡æ–¹æ¡ˆã€‚ä¾‹å¦‚ï¼Œå­è¿›ç¨‹éœ€è¦åœ¨ close ä¹‹å‰å‘Šè¯‰çˆ¶è¿›ç¨‹è‡ªå·±å¤„ç†äº†å¤šå°‘ä¸ªè¯·æ±‚ä»¥æ”¯æ’‘çˆ¶è¿›ç¨‹è¿›è¡Œå…¨å±€çš„ç»Ÿè®¡ï¼Œé‚£ä¹ˆå­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹å¿…é¡»é‡‡ç”¨ IPC æ–¹æ¡ˆæ¥ä¼ é€’ä¿¡æ¯ã€‚\næ”¯æŒçš„å¹¶å‘è¿æ¥æ•°é‡æœ‰é™ï¼šå¦‚æœæ¯ä¸ªè¿æ¥å­˜æ´»æ—¶é—´æ¯”è¾ƒé•¿ï¼Œè€Œä¸”æ–°çš„è¿æ¥åˆæºæºä¸æ–­çš„è¿›æ¥ï¼Œåˆ™è¿›ç¨‹æ•°é‡ä¼šè¶Šæ¥è¶Šå¤šï¼Œæ“ä½œç³»ç»Ÿè¿›ç¨‹è°ƒåº¦å’Œåˆ‡æ¢çš„é¢‘ç‡ä¹Ÿè¶Šæ¥è¶Šé«˜ï¼Œç³»ç»Ÿçš„å‹åŠ›ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒPPC æ–¹æ¡ˆèƒ½å¤„ç†çš„å¹¶å‘è¿æ¥æ•°é‡æœ€å¤§ä¹Ÿå°±å‡ ç™¾ã€‚\n\npreforkPPC æ¨¡å¼ä¸­ï¼Œå½“è¿æ¥è¿›æ¥æ—¶æ‰ fork æ–°è¿›ç¨‹æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œç”±äº fork è¿›ç¨‹ä»£ä»·é«˜ï¼Œç”¨æˆ·è®¿é—®æ—¶å¯èƒ½æ„Ÿè§‰æ¯”è¾ƒæ…¢ï¼Œprefork æ¨¡å¼çš„å‡ºç°å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\né¡¾åæ€ä¹‰ï¼Œprefork å°±æ˜¯æå‰åˆ›å»ºè¿›ç¨‹ï¼ˆpre-forkï¼‰ã€‚ç³»ç»Ÿåœ¨å¯åŠ¨çš„æ—¶å€™å°±é¢„å…ˆåˆ›å»ºå¥½è¿›ç¨‹ï¼Œç„¶åæ‰å¼€å§‹æ¥å—ç”¨æˆ·çš„è¯·æ±‚ï¼Œå½“æœ‰æ–°çš„è¿æ¥è¿›æ¥çš„æ—¶å€™ï¼Œå°±å¯ä»¥çœå» fork è¿›ç¨‹çš„æ“ä½œï¼Œè®©ç”¨æˆ·è®¿é—®æ›´å¿«ã€ä½“éªŒæ›´å¥½ã€‚prefork çš„åŸºæœ¬ç¤ºæ„å›¾æ˜¯ï¼š\n\nprefork çš„å®ç°å…³é”®å°±æ˜¯å¤šä¸ªå­è¿›ç¨‹éƒ½ accept åŒä¸€ä¸ª socketï¼Œå½“æœ‰æ–°çš„è¿æ¥è¿›å…¥æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¿è¯åªæœ‰ä¸€ä¸ªè¿›ç¨‹èƒ½æœ€å accept æˆåŠŸã€‚\nä½†è¿™é‡Œä¹Ÿå­˜åœ¨ä¸€ä¸ªå°å°çš„é—®é¢˜ï¼šâ€œæƒŠç¾¤â€ç°è±¡ï¼Œå°±æ˜¯æŒ‡è™½ç„¶åªæœ‰ä¸€ä¸ªå­è¿›ç¨‹èƒ½ accept æˆåŠŸï¼Œä½†æ‰€æœ‰é˜»å¡åœ¨ accept ä¸Šçš„å­è¿›ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œè¿™æ ·å°±å¯¼è‡´äº†ä¸å¿…è¦çš„è¿›ç¨‹è°ƒåº¦å’Œä¸Šä¸‹æ–‡åˆ‡æ¢äº†ã€‚\nå¹¸è¿çš„æ˜¯ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¾‹å¦‚ Linux 2.6 ç‰ˆæœ¬åå†…æ ¸å·²ç»è§£å†³äº† accept æƒŠç¾¤é—®é¢˜ã€‚\nprefork æ¨¡å¼å’Œ PPC ä¸€æ ·ï¼Œè¿˜æ˜¯å­˜åœ¨çˆ¶å­è¿›ç¨‹é€šä¿¡å¤æ‚ã€æ”¯æŒçš„å¹¶å‘è¿æ¥æ•°é‡æœ‰é™çš„é—®é¢˜ï¼Œå› æ­¤ç›®å‰å®é™…åº”ç”¨ä¹Ÿä¸å¤šã€‚Apache æœåŠ¡å™¨æä¾›äº† MPM prefork æ¨¡å¼ï¼Œæ¨èåœ¨éœ€è¦å¯é æ€§æˆ–è€…ä¸æ—§è½¯ä»¶å…¼å®¹çš„ç«™ç‚¹æ—¶é‡‡ç”¨è¿™ç§æ¨¡å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹æœ€å¤§æ”¯æŒ 256 ä¸ªå¹¶å‘è¿æ¥ã€‚\n2.TPCTPC æ˜¯ Thread Per Connection çš„ç¼©å†™ï¼Œå…¶å«ä¹‰æ˜¯æŒ‡æ¯æ¬¡æœ‰æ–°çš„è¿æ¥å°±æ–°å»ºä¸€ä¸ªçº¿ç¨‹å»ä¸“é—¨å¤„ç†è¿™ä¸ªè¿æ¥çš„è¯·æ±‚ã€‚ä¸è¿›ç¨‹ç›¸æ¯”ï¼Œçº¿ç¨‹æ›´è½»é‡çº§ï¼Œåˆ›å»ºçº¿ç¨‹çš„æ¶ˆè€—æ¯”è¿›ç¨‹è¦å°‘å¾—å¤šï¼›åŒæ—¶å¤šçº¿ç¨‹æ˜¯å…±äº«è¿›ç¨‹å†…å­˜ç©ºé—´çš„ï¼Œçº¿ç¨‹é€šä¿¡ç›¸æ¯”è¿›ç¨‹é€šä¿¡æ›´ç®€å•ã€‚å› æ­¤ï¼ŒTPC å®é™…ä¸Šæ˜¯è§£å†³æˆ–è€…å¼±åŒ–äº† PPC fork ä»£ä»·é«˜çš„é—®é¢˜å’Œçˆ¶å­è¿›ç¨‹é€šä¿¡å¤æ‚çš„é—®é¢˜ã€‚\nTPC çš„åŸºæœ¬æµç¨‹æ˜¯ï¼š\n\n\nçˆ¶è¿›ç¨‹æ¥å—è¿æ¥ï¼ˆå›¾ä¸­ acceptï¼‰\nçˆ¶è¿›ç¨‹åˆ›å»ºå­çº¿ç¨‹ï¼ˆå›¾ä¸­ pthreadï¼‰\nå­çº¿ç¨‹å¤„ç†è¿æ¥çš„è¯»å†™è¯·æ±‚ï¼ˆå›¾ä¸­å­çº¿ç¨‹ readã€ä¸šåŠ¡å¤„ç†ã€writeï¼‰\nå­çº¿ç¨‹å…³é—­è¿æ¥ï¼ˆå›¾ä¸­å­çº¿ç¨‹ä¸­çš„ closeï¼‰\n\næ³¨æ„ï¼Œå’Œ PPC ç›¸æ¯”ï¼Œä¸»è¿›ç¨‹ä¸ç”¨â€œcloseâ€è¿æ¥äº†ã€‚åŸå› æ˜¯åœ¨äºå­çº¿ç¨‹æ˜¯å…±äº«ä¸»è¿›ç¨‹çš„è¿›ç¨‹ç©ºé—´çš„ï¼Œè¿æ¥çš„æ–‡ä»¶æè¿°ç¬¦å¹¶æ²¡æœ‰è¢«å¤åˆ¶ï¼Œå› æ­¤åªéœ€è¦ä¸€æ¬¡ close å³å¯ã€‚\nTPC è™½ç„¶è§£å†³äº† fork ä»£ä»·é«˜å’Œè¿›ç¨‹é€šä¿¡å¤æ‚çš„é—®é¢˜ï¼Œä½†æ˜¯ä¹Ÿå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼Œå…·ä½“è¡¨ç°åœ¨ï¼š\n\nåˆ›å»ºçº¿ç¨‹è™½ç„¶æ¯”åˆ›å»ºè¿›ç¨‹ä»£ä»·ä½ï¼Œä½†å¹¶ä¸æ˜¯æ²¡æœ‰ä»£ä»·ï¼Œé«˜å¹¶å‘æ—¶ï¼ˆä¾‹å¦‚æ¯ç§’ä¸Šä¸‡è¿æ¥ï¼‰è¿˜æ˜¯æœ‰æ€§èƒ½é—®é¢˜ã€‚\næ— é¡»è¿›ç¨‹é—´é€šä¿¡ï¼Œä½†æ˜¯çº¿ç¨‹é—´çš„äº’æ–¥å’Œå…±äº«åˆå¼•å…¥äº†å¤æ‚åº¦ï¼Œå¯èƒ½ä¸€ä¸å°å¿ƒå°±å¯¼è‡´äº†æ­»é”é—®é¢˜ã€‚\nå¤šçº¿ç¨‹ä¼šå‡ºç°äº’ç›¸å½±å“çš„æƒ…å†µï¼ŒæŸä¸ªçº¿ç¨‹å‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯èƒ½å¯¼è‡´æ•´ä¸ªè¿›ç¨‹é€€å‡ºï¼ˆä¾‹å¦‚å†…å­˜è¶Šç•Œï¼‰ã€‚\n\né™¤äº†å¼•å…¥äº†æ–°çš„é—®é¢˜ï¼ŒTPC è¿˜æ˜¯å­˜åœ¨ CPU çº¿ç¨‹è°ƒåº¦å’Œåˆ‡æ¢ä»£ä»·çš„é—®é¢˜ã€‚å› æ­¤ï¼ŒTPC æ–¹æ¡ˆæœ¬è´¨ä¸Šå’Œ PPC æ–¹æ¡ˆåŸºæœ¬ç±»ä¼¼ï¼Œåœ¨å¹¶å‘å‡ ç™¾è¿æ¥çš„åœºæ™¯ä¸‹ï¼Œåè€Œæ›´å¤šåœ°æ˜¯é‡‡ç”¨ PPC çš„æ–¹æ¡ˆï¼Œå› ä¸º PPC æ–¹æ¡ˆä¸ä¼šæœ‰æ­»é”çš„é£é™©ï¼Œä¹Ÿä¸ä¼šå¤šè¿›ç¨‹äº’ç›¸å½±å“ï¼Œç¨³å®šæ€§æ›´é«˜ã€‚\nprethreadTPC æ¨¡å¼ä¸­ï¼Œå½“è¿æ¥è¿›æ¥æ—¶æ‰åˆ›å»ºæ–°çš„çº¿ç¨‹æ¥å¤„ç†è¿æ¥è¯·æ±‚ï¼Œè™½ç„¶åˆ›å»ºçº¿ç¨‹æ¯”åˆ›å»ºè¿›ç¨‹è¦æ›´åŠ è½»é‡çº§ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€å®šçš„ä»£ä»·ï¼Œè€Œ prethread æ¨¡å¼å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚\nå’Œ prefork ç±»ä¼¼ï¼Œprethread æ¨¡å¼ä¼šé¢„å…ˆåˆ›å»ºçº¿ç¨‹ï¼Œç„¶åæ‰å¼€å§‹æ¥å—ç”¨æˆ·çš„è¯·æ±‚ï¼Œå½“æœ‰æ–°çš„è¿æ¥è¿›æ¥çš„æ—¶å€™ï¼Œå°±å¯ä»¥çœå»åˆ›å»ºçº¿ç¨‹çš„æ“ä½œï¼Œè®©ç”¨æˆ·æ„Ÿè§‰æ›´å¿«ã€ä½“éªŒæ›´å¥½ã€‚\nç”±äºå¤šçº¿ç¨‹ä¹‹é—´æ•°æ®å…±äº«å’Œé€šä¿¡æ¯”è¾ƒæ–¹ä¾¿ï¼Œå› æ­¤å®é™…ä¸Š prethread çš„å®ç°æ–¹å¼ç›¸æ¯” prefork è¦çµæ´»ä¸€äº›ï¼Œå¸¸è§çš„å®ç°æ–¹å¼æœ‰ä¸‹é¢å‡ ç§ï¼š\n\nä¸»è¿›ç¨‹ acceptï¼Œç„¶åå°†è¿æ¥äº¤ç»™æŸä¸ªçº¿ç¨‹å¤„ç†ã€‚\nå­çº¿ç¨‹éƒ½å°è¯•å» acceptï¼Œæœ€ç»ˆåªæœ‰ä¸€ä¸ªçº¿ç¨‹ accept æˆåŠŸï¼Œæ–¹æ¡ˆçš„åŸºæœ¬ç¤ºæ„å›¾å¦‚ä¸‹ï¼š\n\n\nApache æœåŠ¡å™¨çš„ MPM worker æ¨¡å¼æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ç§ prethread æ–¹æ¡ˆï¼Œä½†ç¨å¾®åšäº†æ”¹è¿›ã€‚Apache æœåŠ¡å™¨ä¼šé¦–å…ˆåˆ›å»ºå¤šä¸ªè¿›ç¨‹ï¼Œæ¯ä¸ªè¿›ç¨‹é‡Œé¢å†åˆ›å»ºå¤šä¸ªçº¿ç¨‹ï¼Œè¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†è€ƒè™‘ç¨³å®šæ€§ï¼Œå³ï¼šå³ä½¿æŸä¸ªå­è¿›ç¨‹é‡Œé¢çš„æŸä¸ªçº¿ç¨‹å¼‚å¸¸å¯¼è‡´æ•´ä¸ªå­è¿›ç¨‹é€€å‡ºï¼Œè¿˜ä¼šæœ‰å…¶ä»–å­è¿›ç¨‹ç»§ç»­æä¾›æœåŠ¡ï¼Œä¸ä¼šå¯¼è‡´æ•´ä¸ªæœåŠ¡å™¨å…¨éƒ¨æŒ‚æ‰ã€‚\nprethread ç†è®ºä¸Šå¯ä»¥æ¯” prefork æ”¯æŒæ›´å¤šçš„å¹¶å‘è¿æ¥ï¼ŒApache æœåŠ¡å™¨ MPM worker æ¨¡å¼é»˜è®¤æ”¯æŒ 16 Ã— 25 = 400 ä¸ªå¹¶å‘å¤„ç†çº¿ç¨‹ã€‚\nå°ç»“å¯¹äº PPC å’Œ TPCï¼Œç”±äºå…¶è¿æ¥æ•°æœ‰é™ï¼Œæ‰€ä»¥æ¯”è¾ƒé€‚åˆä»¥ä¸‹åœºæ™¯ï¼š\n\nå¸¸é‡è¿æ¥æµ·é‡è¯·æ±‚ï¼Œå¦‚æ•°æ®åº“ã€mqã€ä¸­é—´ä»¶ç­‰ã€‚\nå¸¸é‡è¿æ¥å¸¸é‡è¯·æ±‚ï¼Œå¦‚å†…éƒ¨è¿è¥ç³»ç»Ÿã€ç®¡ç†ç³»ç»Ÿã€é—¨æˆ·ç½‘ç«™ç­‰ã€‚\n\n3.ReactorPPC æ¨¡å¼æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯æ¯ä¸ªè¿æ¥éƒ½è¦åˆ›å»ºè¿›ç¨‹ï¼ˆä¸ºäº†æè¿°ç®€æ´ï¼Œè¿™é‡Œåªä»¥ PPC å’Œè¿›ç¨‹ä¸ºä¾‹ï¼Œå®é™…ä¸Šæ¢æˆ TPC å’Œçº¿ç¨‹ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ï¼‰ï¼Œè¿æ¥ç»“æŸåè¿›ç¨‹å°±é”€æ¯äº†ï¼Œè¿™æ ·åšå…¶å®æ˜¯å¾ˆå¤§çš„æµªè´¹ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¸€ä¸ªè‡ªç„¶è€Œç„¶çš„æƒ³æ³•å°±æ˜¯èµ„æºå¤ç”¨ï¼Œå³ä¸å†å•ç‹¬ä¸ºæ¯ä¸ªè¿æ¥åˆ›å»ºè¿›ç¨‹ï¼Œè€Œæ˜¯åˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ± ï¼Œå°†è¿æ¥åˆ†é…ç»™è¿›ç¨‹ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ã€‚\nå¼•å…¥èµ„æºæ± çš„å¤„ç†æ–¹å¼åï¼Œä¼šå¼•å‡ºä¸€ä¸ªæ–°çš„é—®é¢˜ï¼šè¿›ç¨‹å¦‚ä½•æ‰èƒ½é«˜æ•ˆåœ°å¤„ç†å¤šä¸ªè¿æ¥çš„ä¸šåŠ¡ï¼Ÿå½“ä¸€ä¸ªè¿æ¥ä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œè¿›ç¨‹å¯ä»¥é‡‡ç”¨â€œread -&gt; ä¸šåŠ¡å¤„ç† -&gt; writeâ€çš„å¤„ç†æµç¨‹ï¼Œå¦‚æœå½“å‰è¿æ¥æ²¡æœ‰æ•°æ®å¯ä»¥è¯»ï¼Œåˆ™è¿›ç¨‹å°±é˜»å¡åœ¨ read æ“ä½œä¸Šã€‚è¿™ç§é˜»å¡çš„æ–¹å¼åœ¨ä¸€ä¸ªè¿æ¥ä¸€ä¸ªè¿›ç¨‹çš„åœºæ™¯ä¸‹æ²¡æœ‰é—®é¢˜ï¼Œä½†å¦‚æœä¸€ä¸ªè¿›ç¨‹å¤„ç†å¤šä¸ªè¿æ¥ï¼Œè¿›ç¨‹é˜»å¡åœ¨æŸä¸ªè¿æ¥çš„ read æ“ä½œä¸Šï¼Œæ­¤æ—¶å³ä½¿å…¶ä»–è¿æ¥æœ‰æ•°æ®å¯è¯»ï¼Œè¿›ç¨‹ä¹Ÿæ— æ³•å»å¤„ç†ï¼Œå¾ˆæ˜¾ç„¶è¿™æ ·æ˜¯æ— æ³•åšåˆ°é«˜æ€§èƒ½çš„ã€‚\nè§£å†³è¿™ä¸ªé—®é¢˜çš„æœ€ç®€å•çš„æ–¹å¼æ˜¯å°† read æ“ä½œæ”¹ä¸ºéé˜»å¡ï¼Œç„¶åè¿›ç¨‹ä¸æ–­åœ°è½®è¯¢å¤šä¸ªè¿æ¥ã€‚è¿™ç§æ–¹å¼èƒ½å¤Ÿè§£å†³é˜»å¡çš„é—®é¢˜ï¼Œä½†è§£å†³çš„æ–¹å¼å¹¶ä¸ä¼˜é›…ã€‚é¦–å…ˆï¼Œè½®è¯¢æ˜¯è¦æ¶ˆè€— CPU çš„ï¼›å…¶æ¬¡ï¼Œå¦‚æœä¸€ä¸ªè¿›ç¨‹å¤„ç†å‡ åƒä¸Šä¸‡çš„è¿æ¥ï¼Œåˆ™è½®è¯¢çš„æ•ˆç‡æ˜¯å¾ˆä½çš„ã€‚ï¼ˆä¾‹å¦‚NIOï¼‰\nä¸ºäº†èƒ½å¤Ÿæ›´å¥½åœ°è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¾ˆå®¹æ˜“å¯ä»¥æƒ³åˆ°ï¼Œåªæœ‰å½“è¿æ¥ä¸Šæœ‰æ•°æ®çš„æ—¶å€™è¿›ç¨‹æ‰å»å¤„ç†ï¼Œè¿™å°±æ˜¯ I/O å¤šè·¯å¤ç”¨æŠ€æœ¯çš„æ¥æºã€‚\nI/O å¤šè·¯å¤ç”¨æŠ€æœ¯å½’çº³èµ·æ¥æœ‰ä¸¤ä¸ªå…³é”®å®ç°ç‚¹ï¼š\n\nå½“å¤šæ¡è¿æ¥å…±ç”¨ä¸€ä¸ªé˜»å¡å¯¹è±¡åï¼Œè¿›ç¨‹åªéœ€è¦åœ¨ä¸€ä¸ªé˜»å¡å¯¹è±¡ä¸Šç­‰å¾…ï¼Œè€Œæ— é¡»å†è½®è¯¢æ‰€æœ‰è¿æ¥ï¼Œå¸¸è§çš„å®ç°æ–¹å¼æœ‰ selectã€epollã€kqueue ç­‰ã€‚\nå½“æŸæ¡è¿æ¥æœ‰æ–°çš„æ•°æ®å¯ä»¥å¤„ç†æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šé€šçŸ¥è¿›ç¨‹ï¼Œè¿›ç¨‹ä»é˜»å¡çŠ¶æ€è¿”å›ï¼Œå¼€å§‹è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚\n\nI/O å¤šè·¯å¤ç”¨ç»“åˆçº¿ç¨‹æ± ï¼Œå®Œç¾åœ°è§£å†³äº† PPC å’Œ TPC çš„é—®é¢˜ï¼Œè€Œä¸”â€œå¤§ç¥ä»¬â€ç»™å®ƒå–äº†ä¸€ä¸ªå¾ˆç‰›çš„åå­—ï¼šReactorï¼Œä¸­æ–‡æ˜¯â€œååº”å †â€ã€‚è”æƒ³åˆ°â€œæ ¸ååº”å †â€ï¼Œå¬èµ·æ¥å°±å¾ˆå“äººï¼Œå®é™…ä¸Šè¿™é‡Œçš„â€œååº”â€ä¸æ˜¯èšå˜ã€è£‚å˜ååº”çš„æ„æ€ï¼Œè€Œæ˜¯â€œäº‹ä»¶ååº”â€çš„æ„æ€ï¼Œå¯ä»¥é€šä¿—åœ°ç†è§£ä¸ºâ€œæ¥äº†ä¸€ä¸ªäº‹ä»¶æˆ‘å°±æœ‰ç›¸åº”çš„ååº”â€ï¼Œè¿™é‡Œçš„â€œæˆ‘â€å°±æ˜¯ Reactorï¼Œå…·ä½“çš„ååº”å°±æ˜¯æˆ‘ä»¬å†™çš„ä»£ç ï¼ŒReactor ä¼šæ ¹æ®äº‹ä»¶ç±»å‹æ¥è°ƒç”¨ç›¸åº”çš„ä»£ç è¿›è¡Œå¤„ç†ã€‚Reactor æ¨¡å¼ä¹Ÿå« Dispatcher æ¨¡å¼ï¼ˆåœ¨å¾ˆå¤šå¼€æºçš„ç³»ç»Ÿé‡Œé¢ä¼šçœ‹åˆ°è¿™ä¸ªåç§°çš„ç±»ï¼Œå…¶å®å°±æ˜¯å®ç° Reactor æ¨¡å¼çš„ï¼‰ï¼Œæ›´åŠ è´´è¿‘æ¨¡å¼æœ¬èº«çš„å«ä¹‰ï¼Œå³ I/O å¤šè·¯å¤ç”¨ç»Ÿä¸€ç›‘å¬äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶ååˆ†é…ï¼ˆDispatchï¼‰ç»™æŸä¸ªè¿›ç¨‹ã€‚\nReactor æ¨¡å¼çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†åŒ…æ‹¬ Reactor å’Œå¤„ç†èµ„æºæ± ï¼ˆè¿›ç¨‹æ± æˆ–çº¿ç¨‹æ± ï¼‰ï¼Œå…¶ä¸­ Reactor è´Ÿè´£ç›‘å¬å’Œåˆ†é…äº‹ä»¶ï¼Œå¤„ç†èµ„æºæ± è´Ÿè´£å¤„ç†äº‹ä»¶ã€‚åˆçœ‹ Reactor çš„å®ç°æ˜¯æ¯”è¾ƒç®€å•çš„ï¼Œä½†å®é™…ä¸Šç»“åˆä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼ŒReactor æ¨¡å¼çš„å…·ä½“å®ç°æ–¹æ¡ˆçµæ´»å¤šå˜ï¼Œä¸»è¦ä½“ç°åœ¨ï¼š\n\nReactor çš„æ•°é‡å¯ä»¥å˜åŒ–ï¼šå¯ä»¥æ˜¯ä¸€ä¸ª Reactorï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ª Reactorã€‚\nèµ„æºæ± çš„æ•°é‡å¯ä»¥å˜åŒ–ï¼šä»¥è¿›ç¨‹ä¸ºä¾‹ï¼Œå¯ä»¥æ˜¯å•ä¸ªè¿›ç¨‹ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªè¿›ç¨‹ï¼ˆçº¿ç¨‹ç±»ä¼¼ï¼‰ã€‚\n\nå°†ä¸Šé¢ä¸¤ä¸ªå› ç´ æ’åˆ—ç»„åˆä¸€ä¸‹ï¼Œç†è®ºä¸Šå¯ä»¥æœ‰ 4 ç§é€‰æ‹©ï¼Œä½†ç”±äºâ€œå¤š Reactor å•è¿›ç¨‹â€å®ç°æ–¹æ¡ˆç›¸æ¯”â€œå• Reactor å•è¿›ç¨‹â€æ–¹æ¡ˆï¼Œæ—¢å¤æ‚åˆæ²¡æœ‰æ€§èƒ½ä¼˜åŠ¿ï¼Œå› æ­¤â€œå¤š Reactor å•è¿›ç¨‹â€æ–¹æ¡ˆä»…ä»…æ˜¯ä¸€ä¸ªç†è®ºä¸Šçš„æ–¹æ¡ˆï¼Œå®é™…æ²¡æœ‰åº”ç”¨ã€‚\næœ€ç»ˆ Reactor æ¨¡å¼æœ‰è¿™ä¸‰ç§å…¸å‹çš„å®ç°æ–¹æ¡ˆï¼š\n\nå• Reactor å•è¿›ç¨‹ / çº¿ç¨‹\nå• Reactor å¤šçº¿ç¨‹\nå¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹\n\nä»¥ä¸Šæ–¹æ¡ˆå…·ä½“é€‰æ‹©è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼Œæ›´å¤šåœ°æ˜¯å’Œç¼–ç¨‹è¯­è¨€åŠå¹³å°ç›¸å…³ã€‚ä¾‹å¦‚ï¼ŒJava è¯­è¨€ä¸€èˆ¬ä½¿ç”¨çº¿ç¨‹ï¼ˆä¾‹å¦‚ï¼ŒNettyï¼‰ï¼ŒC è¯­è¨€ä½¿ç”¨è¿›ç¨‹å’Œçº¿ç¨‹éƒ½å¯ä»¥ã€‚ä¾‹å¦‚ï¼ŒNginx ä½¿ç”¨è¿›ç¨‹ï¼ŒMemcache ä½¿ç”¨çº¿ç¨‹ã€‚\nå• Reactor å•è¿›ç¨‹ / çº¿ç¨‹å• Reactor å•è¿›ç¨‹ / çº¿ç¨‹çš„æ–¹æ¡ˆç¤ºæ„å›¾å¦‚ä¸‹ï¼ˆä»¥è¿›ç¨‹ä¸ºä¾‹ï¼‰ï¼š\n\næ³¨æ„ï¼Œselectã€acceptã€readã€send æ˜¯æ ‡å‡†çš„ç½‘ç»œç¼–ç¨‹ APIï¼Œdispatch å’Œâ€œä¸šåŠ¡å¤„ç†â€æ˜¯éœ€è¦å®Œæˆçš„æ“ä½œï¼Œå…¶ä»–æ–¹æ¡ˆç¤ºæ„å›¾ç±»ä¼¼ã€‚\nè¯¦ç»†è¯´æ˜ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼š\n\nReactor å¯¹è±¡é€šè¿‡ select ç›‘æ§è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ã€‚\nå¦‚æœæ˜¯è¿æ¥å»ºç«‹çš„äº‹ä»¶ï¼Œåˆ™ç”± Acceptor å¤„ç†ï¼ŒAcceptor é€šè¿‡ accept æ¥å—è¿æ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler æ¥å¤„ç†è¿æ¥åç»­çš„å„ç§äº‹ä»¶ã€‚\nå¦‚æœä¸æ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handlerï¼ˆç¬¬ 2 æ­¥ä¸­åˆ›å»ºçš„ Handlerï¼‰æ¥è¿›è¡Œå“åº”ã€‚\nHandler ä¼šå®Œæˆ read-&gt; ä¸šåŠ¡å¤„ç† -&gt;send çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ã€‚\n\nå• Reactor å•è¿›ç¨‹çš„æ¨¡å¼ä¼˜ç‚¹å°±æ˜¯å¾ˆç®€å•ï¼Œæ²¡æœ‰è¿›ç¨‹é—´é€šä¿¡ï¼Œæ²¡æœ‰è¿›ç¨‹ç«äº‰ï¼Œå…¨éƒ¨éƒ½åœ¨åŒä¸€ä¸ªè¿›ç¨‹å†…å®Œæˆã€‚\nä½†å…¶ç¼ºç‚¹ä¹Ÿæ˜¯éå¸¸æ˜æ˜¾ï¼Œå…·ä½“è¡¨ç°æœ‰ï¼š\n\nåªæœ‰ä¸€ä¸ªè¿›ç¨‹ï¼Œæ— æ³•å‘æŒ¥å¤šæ ¸ CPU çš„æ€§èƒ½ï¼›åªèƒ½é‡‡å–éƒ¨ç½²å¤šä¸ªç³»ç»Ÿæ¥åˆ©ç”¨å¤šæ ¸ CPUï¼Œä½†è¿™æ ·ä¼šå¸¦æ¥è¿ç»´å¤æ‚åº¦ï¼Œæœ¬æ¥åªè¦ç»´æŠ¤ä¸€ä¸ªç³»ç»Ÿï¼Œç”¨è¿™ç§æ–¹å¼éœ€è¦åœ¨ä¸€å°æœºå™¨ä¸Šç»´æŠ¤å¤šå¥—ç³»ç»Ÿã€‚\nHandler åœ¨å¤„ç†æŸä¸ªè¿æ¥ä¸Šçš„ä¸šåŠ¡æ—¶ï¼Œæ•´ä¸ªè¿›ç¨‹æ— æ³•å¤„ç†å…¶ä»–è¿æ¥çš„äº‹ä»¶ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´æ€§èƒ½ç“¶é¢ˆã€‚\n\nå› æ­¤ï¼Œå• Reactor å•è¿›ç¨‹çš„æ–¹æ¡ˆåœ¨å®è·µä¸­åº”ç”¨åœºæ™¯ä¸å¤šï¼Œåªé€‚ç”¨äºä¸šåŠ¡å¤„ç†éå¸¸å¿«é€Ÿçš„åœºæ™¯ï¼Œç›®å‰æ¯”è¾ƒè‘—åçš„å¼€æºè½¯ä»¶ä¸­ä½¿ç”¨å• Reactor å•è¿›ç¨‹çš„æ˜¯ Redisã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒC è¯­è¨€ç¼–å†™ç³»ç»Ÿçš„ä¸€èˆ¬ä½¿ç”¨å• Reactor å•è¿›ç¨‹ï¼Œå› ä¸ºæ²¡æœ‰å¿…è¦åœ¨è¿›ç¨‹ä¸­å†åˆ›å»ºçº¿ç¨‹ï¼›\nè€Œ Java è¯­è¨€ç¼–å†™çš„ä¸€èˆ¬ä½¿ç”¨å• Reactor å•çº¿ç¨‹ï¼Œå› ä¸º Java è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼Œè™šæ‹Ÿæœºä¸­æœ‰å¾ˆå¤šçº¿ç¨‹ï¼Œä¸šåŠ¡çº¿ç¨‹åªæ˜¯å…¶ä¸­çš„ä¸€ä¸ªçº¿ç¨‹è€Œå·²ã€‚\nå• Reactor å¤šçº¿ç¨‹ä¸ºäº†å…‹æœå• Reactor å•è¿›ç¨‹ / çº¿ç¨‹æ–¹æ¡ˆçš„ç¼ºç‚¹ï¼Œå¼•å…¥å¤šè¿›ç¨‹ / å¤šçº¿ç¨‹æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œè¿™å°±äº§ç”Ÿäº†ç¬¬ 2 ä¸ªæ–¹æ¡ˆï¼šå• Reactor å¤šçº¿ç¨‹ã€‚\nå• Reactor å¤šçº¿ç¨‹æ–¹æ¡ˆç¤ºæ„å›¾æ˜¯ï¼š\n\nä»‹ç»ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼š\n\nä¸»çº¿ç¨‹ä¸­ï¼ŒReactor å¯¹è±¡é€šè¿‡ select ç›‘æ§è¿æ¥äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ dispatch è¿›è¡Œåˆ†å‘ã€‚\nå¦‚æœæ˜¯è¿æ¥å»ºç«‹çš„äº‹ä»¶ï¼Œåˆ™ç”± Acceptor å¤„ç†ï¼ŒAcceptor é€šè¿‡ accept æ¥å—è¿æ¥ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler æ¥å¤„ç†è¿æ¥åç»­çš„å„ç§äº‹ä»¶ã€‚\nå¦‚æœä¸æ˜¯è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œåˆ™ Reactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handlerï¼ˆç¬¬ 2 æ­¥ä¸­åˆ›å»ºçš„ Handlerï¼‰æ¥è¿›è¡Œå“åº”ã€‚\nHandler åªè´Ÿè´£å“åº”äº‹ä»¶ï¼Œä¸è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼›Handler é€šè¿‡ read è¯»å–åˆ°æ•°æ®åï¼Œä¼šå‘ç»™ Processor è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚\nProcessor ä¼šåœ¨ç‹¬ç«‹çš„å­çº¿ç¨‹ä¸­å®ŒæˆçœŸæ­£çš„ä¸šåŠ¡å¤„ç†ï¼Œç„¶åå°†å“åº”ç»“æœå‘ç»™ä¸»è¿›ç¨‹çš„ Handler å¤„ç†ï¼›Handler æ”¶åˆ°å“åº”åé€šè¿‡ send å°†å“åº”ç»“æœè¿”å›ç»™ clientã€‚\n\nå• Reator å¤šçº¿ç¨‹æ–¹æ¡ˆèƒ½å¤Ÿå……åˆ†åˆ©ç”¨å¤šæ ¸å¤š CPU çš„å¤„ç†èƒ½åŠ›ï¼Œä½†åŒæ—¶ä¹Ÿå­˜åœ¨ä¸‹é¢çš„é—®é¢˜ï¼š\n\nå¤šçº¿ç¨‹æ•°æ®å…±äº«å’Œè®¿é—®æ¯”è¾ƒå¤æ‚ã€‚ä¾‹å¦‚ï¼Œå­çº¿ç¨‹å®Œæˆä¸šåŠ¡å¤„ç†åï¼Œè¦æŠŠç»“æœä¼ é€’ç»™ä¸»çº¿ç¨‹çš„ Reactor è¿›è¡Œå‘é€ï¼Œè¿™é‡Œæ¶‰åŠå…±äº«æ•°æ®çš„äº’æ–¥å’Œä¿æŠ¤æœºåˆ¶ã€‚ä»¥ Java çš„ NIO ä¸ºä¾‹ï¼ŒSelector æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯é€šè¿‡ Selector.selectKeys() è¿”å›çš„é”®çš„é›†åˆæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼Œå¯¹ selected keys çš„å¤„ç†å¿…é¡»å•çº¿ç¨‹å¤„ç†æˆ–è€…é‡‡å–åŒæ­¥æªæ–½è¿›è¡Œä¿æŠ¤ã€‚\nReactor æ‰¿æ‹…æ‰€æœ‰äº‹ä»¶çš„ç›‘å¬å’Œå“åº”ï¼Œåªåœ¨ä¸»çº¿ç¨‹ä¸­è¿è¡Œï¼Œç¬é—´é«˜å¹¶å‘æ—¶ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆã€‚\n\nä½ å¯èƒ½ä¼šå‘ç°ï¼Œæˆ‘åªåˆ—å‡ºäº†â€œå• Reactor å¤šçº¿ç¨‹â€æ–¹æ¡ˆï¼Œæ²¡æœ‰åˆ—å‡ºâ€œå• Reactor å¤šè¿›ç¨‹â€æ–¹æ¡ˆï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿä¸»è¦åŸå› åœ¨äºå¦‚æœé‡‡ç”¨å¤šè¿›ç¨‹ï¼Œå­è¿›ç¨‹å®Œæˆä¸šåŠ¡å¤„ç†åï¼Œå°†ç»“æœè¿”å›ç»™çˆ¶è¿›ç¨‹ï¼Œå¹¶é€šçŸ¥çˆ¶è¿›ç¨‹å‘é€ç»™å“ªä¸ª clientï¼Œè¿™æ˜¯å¾ˆéº»çƒ¦çš„äº‹æƒ…ã€‚å› ä¸ºçˆ¶è¿›ç¨‹åªæ˜¯é€šè¿‡ Reactor ç›‘å¬å„ä¸ªè¿æ¥ä¸Šçš„äº‹ä»¶ç„¶åè¿›è¡Œåˆ†é…ï¼Œå­è¿›ç¨‹ä¸çˆ¶è¿›ç¨‹é€šä¿¡æ—¶å¹¶ä¸æ˜¯ä¸€ä¸ªè¿æ¥ã€‚å¦‚æœè¦å°†çˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ¨¡æ‹Ÿä¸ºä¸€ä¸ªè¿æ¥ï¼Œå¹¶åŠ å…¥ Reactor è¿›è¡Œç›‘å¬ï¼Œåˆ™æ˜¯æ¯”è¾ƒå¤æ‚çš„ã€‚è€Œé‡‡ç”¨å¤šçº¿ç¨‹æ—¶ï¼Œå› ä¸ºå¤šçº¿ç¨‹æ˜¯å…±äº«æ•°æ®çš„ï¼Œå› æ­¤çº¿ç¨‹é—´é€šä¿¡æ˜¯éå¸¸æ–¹ä¾¿çš„ã€‚è™½ç„¶è¦é¢å¤–è€ƒè™‘çº¿ç¨‹é—´å…±äº«æ•°æ®æ—¶çš„åŒæ­¥é—®é¢˜ï¼Œä½†è¿™ä¸ªå¤æ‚åº¦æ¯”è¿›ç¨‹é—´é€šä¿¡çš„å¤æ‚åº¦è¦ä½å¾ˆå¤šã€‚\nå¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ä¸ºäº†è§£å†³å• Reactor å¤šçº¿ç¨‹çš„é—®é¢˜ï¼Œæœ€ç›´è§‚çš„æ–¹æ³•å°±æ˜¯å°†å• Reactor æ”¹ä¸ºå¤š Reactorï¼Œè¿™å°±äº§ç”Ÿäº†ç¬¬ 3 ä¸ªæ–¹æ¡ˆï¼šå¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹ã€‚\nå¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹æ–¹æ¡ˆç¤ºæ„å›¾æ˜¯ï¼ˆä»¥è¿›ç¨‹ä¸ºä¾‹ï¼‰ï¼š\n\næ–¹æ¡ˆè¯¦ç»†è¯´æ˜å¦‚ä¸‹ï¼š\n\nçˆ¶è¿›ç¨‹ä¸­ mainReactor å¯¹è±¡é€šè¿‡ select ç›‘æ§è¿æ¥å»ºç«‹äº‹ä»¶ï¼Œæ”¶åˆ°äº‹ä»¶åé€šè¿‡ Acceptor æ¥æ”¶ï¼Œå°†æ–°çš„è¿æ¥åˆ†é…ç»™æŸä¸ªå­è¿›ç¨‹ã€‚\nå­è¿›ç¨‹çš„ subReactor å°† mainReactor åˆ†é…çš„è¿æ¥åŠ å…¥è¿æ¥é˜Ÿåˆ—è¿›è¡Œç›‘å¬ï¼Œå¹¶åˆ›å»ºä¸€ä¸ª Handler ç”¨äºå¤„ç†è¿æ¥çš„å„ç§äº‹ä»¶ã€‚\nå½“æœ‰æ–°çš„äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒsubReactor ä¼šè°ƒç”¨è¿æ¥å¯¹åº”çš„ Handlerï¼ˆå³ç¬¬ 2 æ­¥ä¸­åˆ›å»ºçš„ Handlerï¼‰æ¥è¿›è¡Œå“åº”ã€‚\nHandler å®Œæˆ readâ†’ä¸šåŠ¡å¤„ç†â†’send çš„å®Œæ•´ä¸šåŠ¡æµç¨‹ã€‚\n\nå¤š Reactor å¤šè¿›ç¨‹ / çº¿ç¨‹çš„æ–¹æ¡ˆçœ‹èµ·æ¥æ¯”å• Reactor å¤šçº¿ç¨‹è¦å¤æ‚ï¼Œä½†å®é™…å®ç°æ—¶åè€Œæ›´åŠ ç®€å•ï¼Œä¸»è¦åŸå› æ˜¯ï¼š\n\nçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„èŒè´£éå¸¸æ˜ç¡®ï¼Œçˆ¶è¿›ç¨‹åªè´Ÿè´£æ¥æ”¶æ–°è¿æ¥ï¼Œå­è¿›ç¨‹è´Ÿè´£å®Œæˆåç»­çš„ä¸šåŠ¡å¤„ç†ã€‚\nçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹çš„äº¤äº’å¾ˆç®€å•ï¼Œçˆ¶è¿›ç¨‹åªéœ€è¦æŠŠæ–°è¿æ¥ä¼ ç»™å­è¿›ç¨‹ï¼Œå­è¿›ç¨‹æ— é¡»è¿”å›æ•°æ®ã€‚\nå­è¿›ç¨‹ä¹‹é—´æ˜¯äº’ç›¸ç‹¬ç«‹çš„ï¼Œæ— é¡»åŒæ­¥å…±äº«ä¹‹ç±»çš„å¤„ç†ï¼ˆè¿™é‡Œä»…é™äºç½‘ç»œæ¨¡å‹ç›¸å…³çš„ selectã€readã€send ç­‰æ— é¡»åŒæ­¥å…±äº«ï¼Œâ€œä¸šåŠ¡å¤„ç†â€è¿˜æ˜¯æœ‰å¯èƒ½éœ€è¦åŒæ­¥å…±äº«çš„ï¼‰ã€‚\n\nç›®å‰è‘—åçš„å¼€æºç³»ç»Ÿ Nginx é‡‡ç”¨çš„æ˜¯å¤š Reactor å¤šè¿›ç¨‹ï¼Œé‡‡ç”¨å¤š Reactor å¤šçº¿ç¨‹çš„å®ç°æœ‰ Memcache å’Œ Nettyã€‚\næˆ‘å¤šè¯´ä¸€å¥ï¼ŒNginx é‡‡ç”¨çš„æ˜¯å¤š Reactor å¤šè¿›ç¨‹çš„æ¨¡å¼ï¼Œä½†æ–¹æ¡ˆä¸æ ‡å‡†çš„å¤š Reactor å¤šè¿›ç¨‹æœ‰å·®å¼‚ã€‚å…·ä½“å·®å¼‚è¡¨ç°ä¸ºä¸»è¿›ç¨‹ä¸­ä»…ä»…åˆ›å»ºäº†ç›‘å¬ç«¯å£ï¼Œå¹¶æ²¡æœ‰åˆ›å»º mainReactor æ¥â€œacceptâ€è¿æ¥ï¼Œè€Œæ˜¯ç”±å­è¿›ç¨‹çš„ Reactor æ¥â€œacceptâ€è¿æ¥ï¼Œé€šè¿‡é”æ¥æ§åˆ¶ä¸€æ¬¡åªæœ‰ä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œâ€œacceptâ€ï¼Œå­è¿›ç¨‹â€œacceptâ€æ–°è¿æ¥åå°±æ”¾åˆ°è‡ªå·±çš„ Reactor è¿›è¡Œå¤„ç†ï¼Œä¸ä¼šå†åˆ†é…ç»™å…¶ä»–å­è¿›ç¨‹ï¼Œæ›´å¤šç»†èŠ‚è¯·æŸ¥é˜…ç›¸å…³èµ„æ–™æˆ–é˜…è¯» Nginx æºç ã€‚\n4.ProactorReactor æ˜¯éé˜»å¡åŒæ­¥ç½‘ç»œæ¨¡å‹ï¼Œå› ä¸ºçœŸæ­£çš„ read å’Œ send æ“ä½œéƒ½éœ€è¦ç”¨æˆ·è¿›ç¨‹åŒæ­¥æ“ä½œã€‚è¿™é‡Œçš„â€œåŒæ­¥â€æŒ‡ç”¨æˆ·è¿›ç¨‹åœ¨æ‰§è¡Œ read å’Œ send è¿™ç±» I/O æ“ä½œçš„æ—¶å€™æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœæŠŠ I/O æ“ä½œæ”¹ä¸ºå¼‚æ­¥å°±èƒ½å¤Ÿè¿›ä¸€æ­¥æå‡æ€§èƒ½ï¼Œè¿™å°±æ˜¯å¼‚æ­¥ç½‘ç»œæ¨¡å‹ Proactorã€‚\nProactor ä¸­æ–‡ç¿»è¯‘ä¸ºâ€œå‰æ‘„å™¨â€æ¯”è¾ƒéš¾ç†è§£ï¼Œä¸å…¶ç±»ä¼¼çš„å•è¯æ˜¯ proactiveï¼Œå«ä¹‰ä¸ºâ€œä¸»åŠ¨çš„â€ï¼Œå› æ­¤æˆ‘ä»¬ç…§çŒ«ç”»è™ç¿»è¯‘ä¸ºâ€œä¸»åŠ¨å™¨â€åè€Œæ›´å¥½ç†è§£ã€‚Reactor å¯ä»¥ç†è§£ä¸ºâ€œæ¥äº†äº‹ä»¶æˆ‘é€šçŸ¥ä½ ï¼Œä½ æ¥å¤„ç†â€ï¼Œè€Œ Proactor å¯ä»¥ç†è§£ä¸º â€œæ¥äº†äº‹ä»¶æˆ‘æ¥å¤„ç†ï¼Œå¤„ç†å®Œäº†æˆ‘é€šçŸ¥ä½ â€ã€‚\nè¿™é‡Œçš„â€œæˆ‘â€å°±æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸ï¼Œâ€œäº‹ä»¶â€å°±æ˜¯æœ‰æ–°è¿æ¥ã€æœ‰æ•°æ®å¯è¯»ã€æœ‰æ•°æ®å¯å†™çš„è¿™äº› I/O äº‹ä»¶ï¼Œâ€œä½ â€å°±æ˜¯æˆ‘ä»¬çš„ç¨‹åºä»£ç ã€‚\nProactor æ¨¡å‹ç¤ºæ„å›¾æ˜¯ï¼š\n\nè¯¦ç»†ä»‹ç»ä¸€ä¸‹ Proactor æ–¹æ¡ˆï¼š\n\nProactor Initiator è´Ÿè´£åˆ›å»º Proactor å’Œ Handlerï¼Œå¹¶å°† Proactor å’Œ Handler éƒ½é€šè¿‡ Asynchronous Operation Processor æ³¨å†Œåˆ°å†…æ ¸ã€‚\nAsynchronous Operation Processor è´Ÿè´£å¤„ç†æ³¨å†Œè¯·æ±‚ï¼Œå¹¶å®Œæˆ I/O æ“ä½œã€‚\nAsynchronous Operation Processor å®Œæˆ I/O æ“ä½œåé€šçŸ¥ Proactorã€‚\nProactor æ ¹æ®ä¸åŒçš„äº‹ä»¶ç±»å‹å›è°ƒä¸åŒçš„ Handler è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚\nHandler å®Œæˆä¸šåŠ¡å¤„ç†ï¼ŒHandler ä¹Ÿå¯ä»¥æ³¨å†Œæ–°çš„ Handler åˆ°å†…æ ¸è¿›ç¨‹ã€‚\n\nç†è®ºä¸Š Proactor æ¯” Reactor æ•ˆç‡è¦é«˜ä¸€äº›ï¼Œå¼‚æ­¥ I/O èƒ½å¤Ÿå……åˆ†åˆ©ç”¨ DMA ç‰¹æ€§ï¼Œè®© I/O æ“ä½œä¸è®¡ç®—é‡å ï¼Œä½†è¦å®ç°çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œæ“ä½œç³»ç»Ÿéœ€è¦åšå¤§é‡çš„å·¥ä½œã€‚\nç›®å‰ Windows ä¸‹é€šè¿‡ IOCP å®ç°äº†çœŸæ­£çš„å¼‚æ­¥ I/Oï¼Œè€Œåœ¨ Linux ç³»ç»Ÿä¸‹çš„ AIO å¹¶ä¸å®Œå–„ï¼Œå› æ­¤åœ¨ Linux ä¸‹å®ç°é«˜å¹¶å‘ç½‘ç»œç¼–ç¨‹æ—¶éƒ½æ˜¯ä»¥ Reactor æ¨¡å¼ä¸ºä¸»ã€‚\næ‰€ä»¥å³ä½¿ Boost.Asio å·ç§°å®ç°äº† Proactor æ¨¡å‹ï¼Œå…¶å®å®ƒåœ¨ Windows ä¸‹é‡‡ç”¨ IOCPï¼Œè€Œåœ¨ Linux ä¸‹æ˜¯ç”¨ Reactor æ¨¡å¼ï¼ˆé‡‡ç”¨ epollï¼‰æ¨¡æ‹Ÿå‡ºæ¥çš„å¼‚æ­¥æ¨¡å‹ã€‚\n","categories":["Java","IO"]},{"title":"Java NIOï¼šBufferã€Channel å’Œ Selector","url":"/posts/46709/","content":"ä¸€ã€Bufferä¸€ä¸ª Buffer æœ¬è´¨ä¸Šæ˜¯å†…å­˜ä¸­çš„ä¸€å—ï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®å†™å…¥è¿™å—å†…å­˜ï¼Œä¹‹åä»è¿™å—å†…å­˜è·å–æ•°æ®ã€‚\njava.nio å®šä¹‰äº†ä»¥ä¸‹å‡ ä¸ª Buffer çš„å®ç°ã€‚\n\nå…¶å®æ ¸å¿ƒæ˜¯æœ€åçš„ ByteBufferï¼Œå‰é¢çš„ä¸€å¤§ä¸²ç±»åªæ˜¯åŒ…è£…äº†ä¸€ä¸‹å®ƒè€Œå·²ï¼Œæˆ‘ä»¬ä½¿ç”¨æœ€å¤šçš„é€šå¸¸ä¹Ÿæ˜¯ ByteBufferã€‚\næˆ‘ä»¬åº”è¯¥å°† Buffer ç†è§£ä¸ºä¸€ä¸ªæ•°ç»„ï¼ŒIntBufferã€CharBufferã€DoubleBuffer ç­‰åˆ†åˆ«å¯¹åº” int[]ã€char[]ã€double[] ç­‰ã€‚\nMappedByteBuffer ç”¨äºå®ç°å†…å­˜æ˜ å°„æ–‡ä»¶ï¼Œä¹Ÿä¸æ˜¯æœ¬æ–‡å…³æ³¨çš„é‡ç‚¹ã€‚\næˆ‘è§‰å¾—æ“ä½œ Buffer å’Œæ“ä½œæ•°ç»„ã€ç±»é›†å·®ä¸å¤šï¼Œåªä¸è¿‡å¤§éƒ¨åˆ†æ—¶å€™æˆ‘ä»¬éƒ½æŠŠå®ƒæ”¾åˆ°äº† NIO çš„åœºæ™¯é‡Œé¢æ¥ä½¿ç”¨è€Œå·²ã€‚ä¸‹é¢ä»‹ç» Buffer ä¸­çš„å‡ ä¸ªé‡è¦å±æ€§å’Œå‡ ä¸ªé‡è¦æ–¹æ³•ã€‚\npositionã€limitã€capacityå°±åƒæ•°ç»„æœ‰æ•°ç»„å®¹é‡ï¼Œæ¯æ¬¡è®¿é—®å…ƒç´ è¦æŒ‡å®šä¸‹æ ‡ï¼ŒBuffer ä¸­ä¹Ÿæœ‰å‡ ä¸ªé‡è¦å±æ€§ï¼špositionã€limitã€capacityã€‚\n\næœ€å¥½ç†è§£çš„å½“ç„¶æ˜¯ capacityï¼Œå®ƒä»£è¡¨è¿™ä¸ªç¼“å†²åŒºçš„å®¹é‡ï¼Œä¸€æ—¦è®¾å®šå°±ä¸å¯ä»¥æ›´æ”¹ã€‚æ¯”å¦‚ capacity ä¸º 1024 çš„ IntBufferï¼Œä»£è¡¨å…¶ä¸€æ¬¡å¯ä»¥å­˜æ”¾ 1024 ä¸ª int ç±»å‹çš„å€¼ã€‚ä¸€æ—¦ Buffer çš„å®¹é‡è¾¾åˆ° capacityï¼Œéœ€è¦æ¸…ç©º Bufferï¼Œæ‰èƒ½é‡æ–°å†™å…¥å€¼ã€‚\nposition å’Œ limit æ˜¯å˜åŒ–çš„ï¼Œæˆ‘ä»¬åˆ†åˆ«çœ‹ä¸‹è¯»å’Œå†™æ“ä½œä¸‹ï¼Œå®ƒä»¬æ˜¯å¦‚ä½•å˜åŒ–çš„ã€‚\nposition çš„åˆå§‹å€¼æ˜¯ 0ï¼Œæ¯å¾€ Buffer ä¸­å†™å…¥ä¸€ä¸ªå€¼ï¼Œposition å°±è‡ªåŠ¨åŠ  1ï¼Œä»£è¡¨ä¸‹ä¸€æ¬¡çš„å†™å…¥ä½ç½®ã€‚è¯»æ“ä½œçš„æ—¶å€™ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œæ¯è¯»ä¸€ä¸ªå€¼ï¼Œposition å°±è‡ªåŠ¨åŠ  1ã€‚\nä»å†™æ“ä½œæ¨¡å¼åˆ°è¯»æ“ä½œæ¨¡å¼åˆ‡æ¢çš„æ—¶å€™ï¼ˆflipï¼‰ï¼Œposition éƒ½ä¼šå½’é›¶ï¼Œè¿™æ ·å°±å¯ä»¥ä»å¤´å¼€å§‹è¯»å†™äº†ã€‚\nLimitï¼šå†™æ“ä½œæ¨¡å¼ä¸‹ï¼Œlimit ä»£è¡¨çš„æ˜¯æœ€å¤§èƒ½å†™å…¥çš„æ•°æ®ï¼Œè¿™ä¸ªæ—¶å€™ limit ç­‰äº capacityã€‚å†™ç»“æŸåï¼Œåˆ‡æ¢åˆ°è¯»æ¨¡å¼ï¼Œæ­¤æ—¶çš„ limit ç­‰äº Buffer ä¸­å®é™…çš„æ•°æ®å¤§å°ï¼Œå› ä¸º Buffer ä¸ä¸€å®šè¢«å†™æ»¡äº†ã€‚\n\nåˆå§‹åŒ– Bufferæ¯ä¸ª Buffer å®ç°ç±»éƒ½æä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³• allocate(int capacity) å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®ä¾‹åŒ–ä¸€ä¸ª Bufferã€‚å¦‚ï¼š\nByteBuffer byteBuf = ByteBuffer.allocate(1024);IntBuffer intBuf = IntBuffer.allocate(1024);LongBuffer longBuf = LongBuffer.allocate(1024);// ...\n\nå¦å¤–ï¼Œæˆ‘ä»¬ç»å¸¸ä½¿ç”¨ wrap æ–¹æ³•æ¥åˆå§‹åŒ–ä¸€ä¸ª Bufferã€‚\npublic static ByteBuffer wrap(byte[] array) &#123;    ...&#125;\n\nå¡«å…… Bufferå„ä¸ª Buffer ç±»éƒ½æä¾›äº†ä¸€äº› put æ–¹æ³•ç”¨äºå°†æ•°æ®å¡«å……åˆ° Buffer ä¸­ï¼Œå¦‚ ByteBuffer ä¸­çš„å‡ ä¸ª put æ–¹æ³•ï¼š\n// å¡«å……ä¸€ä¸ª byte å€¼public abstract ByteBuffer put(byte b);// åœ¨æŒ‡å®šä½ç½®å¡«å……ä¸€ä¸ª int å€¼public abstract ByteBuffer put(int index, byte b);// å°†ä¸€ä¸ªæ•°ç»„ä¸­çš„å€¼å¡«å……è¿›å»public final ByteBuffer put(byte[] src) &#123;...&#125;public ByteBuffer put(byte[] src, int offset, int length) &#123;...&#125;\n\nä¸Šè¿°è¿™äº›æ–¹æ³•éœ€è¦è‡ªå·±æ§åˆ¶ Buffer å¤§å°ï¼Œä¸èƒ½è¶…è¿‡ capacityï¼Œè¶…è¿‡ä¼šæŠ› java.nio.BufferOverflowException å¼‚å¸¸ã€‚\nå¯¹äº Buffer æ¥è¯´ï¼Œå¦ä¸€ä¸ªå¸¸è§çš„æ“ä½œä¸­å°±æ˜¯ï¼Œæˆ‘ä»¬è¦å°†æ¥è‡ª Channel çš„æ•°æ®å¡«å……åˆ° Buffer ä¸­ï¼Œåœ¨ç³»ç»Ÿå±‚é¢ä¸Šï¼Œè¿™ä¸ªæ“ä½œæˆ‘ä»¬ç§°ä¸ºè¯»æ“ä½œï¼Œå› ä¸ºæ•°æ®æ˜¯ä»å¤–éƒ¨ï¼ˆæ–‡ä»¶æˆ–ç½‘ç»œç­‰ï¼‰è¯»åˆ°å†…å­˜ä¸­ã€‚\nint num = channel.read(buf);\n\nä¸Šè¿°æ–¹æ³•ä¼šè¿”å›ä» Channel ä¸­è¯»å…¥åˆ° Buffer çš„æ•°æ®å¤§å°ã€‚\næå– Buffer ä¸­çš„å€¼å‰é¢ä»‹ç»äº†å†™æ“ä½œï¼Œæ¯å†™å…¥ä¸€ä¸ªå€¼ï¼Œposition çš„å€¼éƒ½éœ€è¦åŠ  1ï¼Œæ‰€ä»¥ position æœ€åä¼šæŒ‡å‘æœ€åä¸€æ¬¡å†™å…¥çš„ä½ç½®çš„åé¢ä¸€ä¸ªï¼Œå¦‚æœ Buffer å†™æ»¡äº†ï¼Œé‚£ä¹ˆ position ç­‰äº capacityï¼ˆposition ä» 0 å¼€å§‹ï¼‰ã€‚\nå¦‚æœè¦è¯» Buffer ä¸­çš„å€¼ï¼Œéœ€è¦åˆ‡æ¢æ¨¡å¼ï¼Œä»å†™å…¥æ¨¡å¼åˆ‡æ¢åˆ°è¯»å‡ºæ¨¡å¼ã€‚æ³¨æ„ï¼Œé€šå¸¸åœ¨è¯´ NIO çš„è¯»æ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´çš„æ˜¯ä» Channel ä¸­è¯»æ•°æ®åˆ° Buffer ä¸­ï¼Œå¯¹åº”çš„æ˜¯å¯¹ Buffer çš„å†™å…¥æ“ä½œï¼Œåˆå­¦è€…éœ€è¦ç†æ¸…æ¥šè¿™ä¸ªã€‚\nè°ƒç”¨ Buffer çš„ flip() æ–¹æ³•ï¼Œå¯ä»¥ä»å†™å…¥æ¨¡å¼åˆ‡æ¢åˆ°è¯»å–æ¨¡å¼ã€‚å…¶å®è¿™ä¸ªæ–¹æ³•ä¹Ÿå°±æ˜¯è®¾ç½®äº†ä¸€ä¸‹ position å’Œ limit å€¼ç½¢äº†ã€‚\npublic final Buffer flip() &#123;    limit = position; // å°† limit è®¾ç½®ä¸ºå®é™…å†™å…¥çš„æ•°æ®æ•°é‡    position = 0; // é‡ç½® position ä¸º 0    mark = -1; // mark ä¹‹åå†è¯´    return this;&#125;\n\nå¯¹åº”å†™å…¥æ“ä½œçš„ä¸€ç³»åˆ— put æ–¹æ³•ï¼Œè¯»æ“ä½œæä¾›äº†ä¸€ç³»åˆ—çš„ get æ–¹æ³•ï¼š\n// æ ¹æ® position æ¥è·å–æ•°æ®public abstract byte get();// è·å–æŒ‡å®šä½ç½®çš„æ•°æ®public abstract byte get(int index);// å°† Buffer ä¸­çš„æ•°æ®å†™å…¥åˆ°æ•°ç»„ä¸­public ByteBuffer get(byte[] dst)\n\né™„ä¸€ä¸ªç»å¸¸ä½¿ç”¨çš„æ–¹æ³•ï¼š\nnew String(buffer.array()).trim();\n\nå½“ç„¶äº†ï¼Œé™¤äº†å°†æ•°æ®ä» Buffer å–å‡ºæ¥ä½¿ç”¨ï¼Œæ›´å¸¸è§çš„æ“ä½œæ˜¯å°†æˆ‘ä»¬å†™å…¥çš„æ•°æ®ä¼ è¾“åˆ° Channel ä¸­ï¼Œå¦‚é€šè¿‡ FileChannel å°†æ•°æ®å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œé€šè¿‡ SocketChannel å°†æ•°æ®å†™å…¥ç½‘ç»œå‘é€åˆ°è¿œç¨‹æœºå™¨ç­‰ã€‚å¯¹åº”çš„ï¼Œè¿™ç§æ“ä½œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºå†™æ“ä½œã€‚\nint num = channel.write(buf);\n\nmark() &amp; reset()é™¤äº† positionã€limitã€capacity è¿™ä¸‰ä¸ªåŸºæœ¬çš„å±æ€§å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸ç”¨çš„å±æ€§å°±æ˜¯ markã€‚\nmark ç”¨äºä¸´æ—¶ä¿å­˜ position çš„å€¼ï¼Œæ¯æ¬¡è°ƒç”¨ mark() æ–¹æ³•éƒ½ä¼šå°† mark è®¾å€¼ä¸ºå½“å‰çš„ positionï¼Œä¾¿äºåç»­éœ€è¦çš„æ—¶å€™ä½¿ç”¨ã€‚\npublic final Buffer mark() &#123;    mark = position;    return this;&#125;\n\né‚£åˆ°åº•ä»€ä¹ˆæ—¶å€™ç”¨å‘¢ï¼Ÿè€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼Œæˆ‘ä»¬åœ¨ position ä¸º 5 çš„æ—¶å€™ï¼Œå…ˆ mark() ä¸€ä¸‹ï¼Œç„¶åç»§ç»­å¾€ä¸‹è¯»ï¼Œè¯»åˆ°ç¬¬ 10 çš„æ—¶å€™ï¼Œæˆ‘æƒ³é‡æ–°å›åˆ° position ä¸º 5 çš„åœ°æ–¹é‡æ–°æ¥ä¸€éï¼Œé‚£åªè¦è°ƒä¸€ä¸‹ reset() æ–¹æ³•ï¼Œposition å°±å›åˆ° 5 äº†ã€‚\npublic final Buffer reset() &#123;    int m = mark;    if (m &lt; 0)        throw new InvalidMarkException();    position = m;    return this;&#125;\n\nrewind() &amp; clear() &amp; compact()**rewind()**ï¼šä¼šé‡ç½® position ä¸º 0ï¼Œé€šå¸¸ç”¨äºé‡æ–°ä»å¤´è¯»å†™ Bufferã€‚\npublic final Buffer rewind() &#123;    position = 0;    mark = -1;    return this;&#125;\n\n**clear()**ï¼šæœ‰ç‚¹é‡ç½® Buffer çš„æ„æ€ï¼Œç›¸å½“äºé‡æ–°å®ä¾‹åŒ–äº†ä¸€æ ·ã€‚\né€šå¸¸ï¼Œæˆ‘ä»¬ä¼šå…ˆå¡«å…… Bufferï¼Œç„¶åä» Buffer è¯»å–æ•°æ®ï¼Œä¹‹åæˆ‘ä»¬å†é‡æ–°å¾€é‡Œå¡«å……æ–°çš„æ•°æ®ï¼Œæˆ‘ä»¬ä¸€èˆ¬åœ¨é‡æ–°å¡«å……ä¹‹å‰å…ˆè°ƒç”¨ clear()ã€‚\npublic final Buffer clear() &#123;    position = 0;    limit = capacity;    mark = -1;    return this;&#125;\n\n**compact()**ï¼šå’Œ clear() ä¸€æ ·çš„æ˜¯ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨å‡†å¤‡å¾€ Buffer å¡«å……æ–°çš„æ•°æ®ä¹‹å‰è°ƒç”¨ã€‚\nå‰é¢è¯´çš„ clear() æ–¹æ³•ä¼šé‡ç½®å‡ ä¸ªå±æ€§ï¼Œä½†æ˜¯æˆ‘ä»¬è¦çœ‹åˆ°ï¼Œclear() æ–¹æ³•å¹¶ä¸ä¼šå°† Buffer ä¸­çš„æ•°æ®æ¸…ç©ºï¼Œåªä¸è¿‡åç»­çš„å†™å…¥ä¼šè¦†ç›–æ‰åŸæ¥çš„æ•°æ®ï¼Œä¹Ÿå°±ç›¸å½“äºæ¸…ç©ºäº†æ•°æ®äº†ã€‚\nè€Œ compact() æ–¹æ³•æœ‰ç‚¹ä¸ä¸€æ ·ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³•ä»¥åï¼Œä¼šå…ˆå¤„ç†è¿˜æ²¡æœ‰è¯»å–çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ position åˆ° limit ä¹‹é—´çš„æ•°æ®ï¼ˆè¿˜æ²¡æœ‰è¯»è¿‡çš„æ•°æ®ï¼‰ï¼Œå…ˆå°†è¿™äº›æ•°æ®ç§»åˆ°å·¦è¾¹ï¼Œç„¶ååœ¨è¿™ä¸ªåŸºç¡€ä¸Šå†å¼€å§‹å†™å…¥ã€‚å¾ˆæ˜æ˜¾ï¼Œæ­¤æ—¶ limit è¿˜æ˜¯ç­‰äº capacityï¼Œposition æŒ‡å‘åŸæ¥æ•°æ®çš„å³è¾¹ã€‚\näºŒã€Channelæ‰€æœ‰çš„ NIO æ“ä½œå§‹äºé€šé“ï¼Œé€šé“æ˜¯æ•°æ®æ¥æºæˆ–æ•°æ®å†™å…¥çš„ç›®çš„åœ°ï¼Œä¸»è¦åœ°ï¼Œæˆ‘ä»¬å°†å…³å¿ƒ java.nio åŒ…ä¸­å®ç°çš„ä»¥ä¸‹å‡ ä¸ª Channelï¼š\n\n\nFileChannelï¼šæ–‡ä»¶é€šé“ï¼Œç”¨äºæ–‡ä»¶çš„è¯»å’Œå†™\nDatagramChannelï¼šç”¨äº UDP è¿æ¥çš„æ¥æ”¶å’Œå‘é€\nSocketChannelï¼šæŠŠå®ƒç†è§£ä¸º TCP è¿æ¥é€šé“ï¼Œç®€å•ç†è§£å°±æ˜¯ TCP å®¢æˆ·ç«¯\nServerSocketChannelï¼šTCP å¯¹åº”çš„æœåŠ¡ç«¯ï¼Œç”¨äºç›‘å¬æŸä¸ªç«¯å£è¿›æ¥çš„è¯·æ±‚\n\nè¿™é‡Œä¸æ˜¯å¾ˆç†è§£è¿™äº›ä¹Ÿæ²¡å…³ç³»ï¼Œåé¢ä»‹ç»äº†ä»£ç ä¹‹åå°±æ¸…æ™°äº†ã€‚è¿˜æœ‰ï¼Œæˆ‘ä»¬æœ€åº”è¯¥å…³æ³¨ï¼Œä¹Ÿæ˜¯åé¢å°†ä¼šé‡ç‚¹ä»‹ç»çš„æ˜¯ SocketChannel å’Œ ServerSocketChannelã€‚\nChannel ç»å¸¸ç¿»è¯‘ä¸ºé€šé“ï¼Œç±»ä¼¼ IO ä¸­çš„æµï¼Œç”¨äºè¯»å–å’Œå†™å…¥ã€‚å®ƒä¸å‰é¢ä»‹ç»çš„ Buffer æ‰“äº¤é“ï¼Œè¯»æ“ä½œçš„æ—¶å€™å°† Channel ä¸­çš„æ•°æ®å¡«å……åˆ° Buffer ä¸­ï¼Œè€Œå†™æ“ä½œæ—¶å°† Buffer ä¸­çš„æ•°æ®å†™å…¥åˆ° Channel ä¸­ã€‚\n\n\nè‡³å°‘è¯»è€…åº”è¯¥è®°ä½ä¸€ç‚¹ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯ channel å®ä¾‹çš„æ–¹æ³•ã€‚\nFileChannelæˆ‘æƒ³æ–‡ä»¶æ“ä½œå¯¹äºå¤§å®¶æ¥è¯´åº”è¯¥æ˜¯æœ€ç†Ÿæ‚‰çš„ï¼Œä¸è¿‡æˆ‘ä»¬åœ¨è¯´ NIO çš„æ—¶å€™ï¼Œå…¶å® FileChannel å¹¶ä¸æ˜¯å…³æ³¨çš„é‡ç‚¹ã€‚è€Œä¸”åé¢æˆ‘ä»¬è¯´éé˜»å¡çš„æ—¶å€™ä¼šçœ‹åˆ°ï¼ŒFileChannel æ˜¯ä¸æ”¯æŒéé˜»å¡çš„ã€‚\nè¿™é‡Œç®—æ˜¯ç®€å•ä»‹ç»ä¸‹å¸¸ç”¨çš„æ“ä½œå§ï¼Œæ„Ÿå…´è¶£çš„è¯»è€…ç„ä¸€çœ¼å°±æ˜¯äº†ã€‚\nåˆå§‹åŒ–ï¼š\nFileInputStream inputStream = new FileInputStream(new File(&quot;/data.txt&quot;));FileChannel fileChannel = inputStream.getChannel();\n\nå½“ç„¶äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä» RandomAccessFile#getChannel æ¥å¾—åˆ° FileChannelã€‚\nè¯»å–æ–‡ä»¶å†…å®¹ï¼š\nByteBuffer buffer = ByteBuffer.allocate(1024);int num = fileChannel.read(buffer);\n\nå‰é¢æˆ‘ä»¬ä¹Ÿè¯´äº†ï¼Œæ‰€æœ‰çš„ Channel éƒ½æ˜¯å’Œ Buffer æ‰“äº¤é“çš„ã€‚\nå†™å…¥æ–‡ä»¶å†…å®¹ï¼š\nByteBuffer buffer = ByteBuffer.allocate(1024);buffer.put(&quot;éšæœºå†™å…¥ä¸€äº›å†…å®¹åˆ° Buffer ä¸­&quot;.getBytes());// Buffer åˆ‡æ¢ä¸ºè¯»æ¨¡å¼buffer.flip();while(buffer.hasRemaining()) &#123;    // å°† Buffer ä¸­çš„å†…å®¹å†™å…¥æ–‡ä»¶    fileChannel.write(buffer);&#125;\n\nSocketChannelæˆ‘ä»¬å‰é¢è¯´äº†ï¼Œæˆ‘ä»¬å¯ä»¥å°† SocketChannel ç†è§£æˆä¸€ä¸ª TCP å®¢æˆ·ç«¯ã€‚è™½ç„¶è¿™ä¹ˆç†è§£æœ‰ç‚¹ç‹­éš˜ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨ä»‹ç» ServerSocketChannel çš„æ—¶å€™ä¼šçœ‹åˆ°å¦ä¸€ç§ä½¿ç”¨æ–¹å¼ã€‚\næ‰“å¼€ä¸€ä¸ª TCP è¿æ¥ï¼š\nSocketChannel socketChannel = SocketChannel.open(new InetSocketAddress(&quot;https://www.javadoop.com&quot;, 80));\n\nå½“ç„¶äº†ï¼Œä¸Šé¢çš„è¿™è¡Œä»£ç ç­‰ä»·äºä¸‹é¢çš„ä¸¤è¡Œï¼š\n// æ‰“å¼€ä¸€ä¸ªé€šé“SocketChannel socketChannel = SocketChannel.open();// å‘èµ·è¿æ¥socketChannel.connect(new InetSocketAddress(&quot;https://www.javadoop.com&quot;, 80));\n\nSocketChannel çš„è¯»å†™å’Œ FileChannel æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œå°±æ˜¯æ“ä½œç¼“å†²åŒºã€‚\n// è¯»å–æ•°æ®socketChannel.read(buffer);// å†™å…¥æ•°æ®åˆ°ç½‘ç»œè¿æ¥ä¸­while(buffer.hasRemaining()) &#123;    socketChannel.write(buffer);   &#125;\n\nä¸è¦åœ¨è¿™é‡Œåœç•™å¤ªä¹…ï¼Œå…ˆç»§ç»­å¾€ä¸‹èµ°ã€‚\nServerSocketChannelä¹‹å‰è¯´ SocketChannel æ˜¯ TCP å®¢æˆ·ç«¯ï¼Œè¿™é‡Œè¯´çš„ ServerSocketChannel å°±æ˜¯å¯¹åº”çš„æœåŠ¡ç«¯ã€‚\nServerSocketChannel ç”¨äºç›‘å¬æœºå™¨ç«¯å£ï¼Œç®¡ç†ä»è¿™ä¸ªç«¯å£è¿›æ¥çš„ TCP è¿æ¥ã€‚\n// å®ä¾‹åŒ–ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();// ç›‘å¬ 8080 ç«¯å£serverSocketChannel.socket().bind(new InetSocketAddress(8080));while (true) &#123;    // ä¸€æ—¦æœ‰ä¸€ä¸ª TCP è¿æ¥è¿›æ¥ï¼Œå°±å¯¹åº”åˆ›å»ºä¸€ä¸ª SocketChannel è¿›è¡Œå¤„ç†    SocketChannel socketChannel = serverSocketChannel.accept();&#125;\n\n\nè¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ° SocketChannel çš„ç¬¬äºŒä¸ªå®ä¾‹åŒ–æ–¹å¼\n\nåˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥èƒ½ç†è§£ SocketChannel äº†ï¼Œå®ƒä¸ä»…ä»…æ˜¯ TCP å®¢æˆ·ç«¯ï¼Œå®ƒä»£è¡¨çš„æ˜¯ä¸€ä¸ªç½‘ç»œé€šé“ï¼Œå¯è¯»å¯å†™ã€‚\nServerSocketChannel ä¸å’Œ Buffer æ‰“äº¤é“äº†ï¼Œå› ä¸ºå®ƒå¹¶ä¸å®é™…å¤„ç†æ•°æ®ï¼Œå®ƒä¸€æ—¦æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå®ä¾‹åŒ– SocketChannelï¼Œä¹‹ååœ¨è¿™ä¸ªè¿æ¥é€šé“ä¸Šçš„æ•°æ®ä¼ é€’å®ƒå°±ä¸ç®¡äº†ï¼Œå› ä¸ºå®ƒéœ€è¦ç»§ç»­ç›‘å¬ç«¯å£ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªè¿æ¥ã€‚\nDatagramChannelUDP å’Œ TCP ä¸ä¸€æ ·ï¼ŒDatagramChannel ä¸€ä¸ªç±»å¤„ç†äº†æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯ã€‚\n\nç§‘æ™®ä¸€ä¸‹ï¼ŒUDP æ˜¯é¢å‘æ— è¿æ¥çš„ï¼Œä¸éœ€è¦å’Œå¯¹æ–¹æ¡æ‰‹ï¼Œä¸éœ€è¦é€šçŸ¥å¯¹æ–¹ï¼Œå°±å¯ä»¥ç›´æ¥å°†æ•°æ®åŒ…æŠ•å‡ºå»ï¼Œè‡³äºèƒ½ä¸èƒ½é€è¾¾ï¼Œå®ƒæ˜¯ä¸çŸ¥é“çš„\n\nç›‘å¬ç«¯å£ï¼š\nDatagramChannel channel = DatagramChannel.open();channel.socket().bind(new InetSocketAddress(9090));å¤åˆ¶ä»£ç ByteBuffer buf = ByteBuffer.allocate(48);channel.receive(buf);\n\nå‘é€æ•°æ®ï¼š\nString newData = &quot;New String to write to file...&quot;                    + System.currentTimeMillis();ByteBuffer buf = ByteBuffer.allocate(48);buf.put(newData.getBytes());buf.flip();int bytesSent = channel.send(buf, new InetSocketAddress(&quot;jenkov.com&quot;, 80));\n\nä¸‰ã€SelectorNIO ä¸‰å¤§ç»„ä»¶å°±å‰© Selector äº†ï¼ŒSelector å»ºç«‹åœ¨éé˜»å¡çš„åŸºç¡€ä¹‹ä¸Šï¼Œå¤§å®¶ç»å¸¸å¬åˆ°çš„ å¤šè·¯å¤ç”¨ åœ¨ Java ä¸–ç•Œä¸­æŒ‡çš„å°±æ˜¯å®ƒï¼Œç”¨äºå®ç°ä¸€ä¸ªçº¿ç¨‹ç®¡ç†å¤šä¸ª Channelã€‚\nè¯»è€…åœ¨è¿™ä¸€èŠ‚ä¸èƒ½æ¶ˆåŒ– Selector ä¹Ÿæ²¡å…³ç³»ï¼Œå› ä¸ºåç»­åœ¨ä»‹ç»éé˜»å¡ IO çš„æ—¶å€™è¿˜å¾—è¯´åˆ°è¿™ä¸ªï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€äº›åŸºæœ¬çš„æ¥å£æ“ä½œã€‚\n\né¦–å…ˆï¼Œæˆ‘ä»¬å¼€å¯ä¸€ä¸ª Selectorã€‚ä½ ä»¬çˆ±ç¿»è¯‘æˆé€‰æ‹©å™¨ä¹Ÿå¥½ï¼Œå¤šè·¯å¤ç”¨å™¨ä¹Ÿå¥½ã€‚\nSelector selector = Selector.open();\nå°† Channel æ³¨å†Œåˆ° Selector ä¸Šã€‚å‰é¢æˆ‘ä»¬è¯´äº†ï¼ŒSelector å»ºç«‹åœ¨éé˜»å¡æ¨¡å¼ä¹‹ä¸Šï¼Œæ‰€ä»¥æ³¨å†Œåˆ° Selector çš„ Channel å¿…é¡»è¦æ”¯æŒéé˜»å¡æ¨¡å¼ï¼ŒFileChannel ä¸æ”¯æŒéé˜»å¡ï¼Œæˆ‘ä»¬è¿™é‡Œè®¨è®ºæœ€å¸¸è§çš„ SocketChannel å’Œ ServerSocketChannelã€‚\n// å°†é€šé“è®¾ç½®ä¸ºéé˜»å¡æ¨¡å¼ï¼Œå› ä¸ºé»˜è®¤éƒ½æ˜¯é˜»å¡æ¨¡å¼çš„channel.configureBlocking(false);// æ³¨å†ŒSelectionKey key = channel.register(selector, SelectionKey.OP_READ);\n\nregister æ–¹æ³•çš„ç¬¬äºŒä¸ª int å‹å‚æ•°ï¼ˆä½¿ç”¨äºŒè¿›åˆ¶çš„æ ‡è®°ä½ï¼‰ç”¨äºè¡¨æ˜éœ€è¦ç›‘å¬å“ªäº›æ„Ÿå…´è¶£çš„äº‹ä»¶ï¼Œå…±ä»¥ä¸‹å››ç§äº‹ä»¶ï¼š\n\nSelectionKey.OP_READ\n\nå¯¹åº” 00000001ï¼Œé€šé“ä¸­æœ‰æ•°æ®å¯ä»¥è¿›è¡Œè¯»å–\n\n\nSelectionKey.OP_WRITE\n\nå¯¹åº” 00000100ï¼Œå¯ä»¥å¾€é€šé“ä¸­å†™å…¥æ•°æ®\n\n\nSelectionKey.OP_CONNECT\n\nå¯¹åº” 00001000ï¼ŒæˆåŠŸå»ºç«‹ TCP è¿æ¥\n\n\nSelectionKey.OP_ACCEPT\n\nå¯¹åº” 00010000ï¼Œæ¥å— TCP è¿æ¥\n\n\n\næˆ‘ä»¬å¯ä»¥åŒæ—¶ç›‘å¬ä¸€ä¸ª Channel ä¸­çš„å‘ç”Ÿçš„å¤šä¸ªäº‹ä»¶ï¼Œæ¯”å¦‚æˆ‘ä»¬è¦ç›‘å¬ ACCEPT å’Œ READ äº‹ä»¶ï¼Œé‚£ä¹ˆæŒ‡å®šå‚æ•°ä¸ºäºŒè¿›åˆ¶çš„ 00010001 å³åè¿›åˆ¶æ•°å€¼ 17 å³å¯ã€‚\næ³¨å†Œæ–¹æ³•è¿”å›å€¼æ˜¯ SelectionKey å®ä¾‹ï¼Œå®ƒåŒ…å«äº† Channel å’Œ Selector ä¿¡æ¯ï¼Œä¹ŸåŒ…æ‹¬äº†ä¸€ä¸ªå«åš Interest Set çš„ä¿¡æ¯ï¼Œå³æˆ‘ä»¬è®¾ç½®çš„æˆ‘ä»¬æ„Ÿå…´è¶£çš„æ­£åœ¨ç›‘å¬çš„äº‹ä»¶é›†åˆã€‚\n\nè°ƒç”¨ select() æ–¹æ³•è·å–é€šé“ä¿¡æ¯ã€‚ç”¨äºåˆ¤æ–­æ˜¯å¦æœ‰æˆ‘ä»¬æ„Ÿå…´è¶£çš„äº‹ä»¶å·²ç»å‘ç”Ÿäº†ã€‚\n\n\nSelector çš„æ“ä½œå°±æ˜¯ä»¥ä¸Š 3 æ­¥ï¼Œè¿™é‡Œæ¥ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå¤§å®¶çœ‹ä¸€ä¸‹å°±å¥½äº†ã€‚ä¹‹ååœ¨ä»‹ç»éé˜»å¡ IO çš„æ—¶å€™ï¼Œä¼šæ¼”ç¤ºä¸€ä»½å¯æ‰§è¡Œçš„ç¤ºä¾‹ä»£ç ã€‚\nSelector selector = Selector.open();channel.configureBlocking(false);SelectionKey key = channel.register(selector, SelectionKey.OP_READ);while(true) &#123;  // åˆ¤æ–­æ˜¯å¦æœ‰äº‹ä»¶å‡†å¤‡å¥½  int readyChannels = selector.select();  if(readyChannels == 0) continue;  // éå†  Set&lt;SelectionKey&gt; selectedKeys = selector.selectedKeys();  Iterator&lt;SelectionKey&gt; keyIterator = selectedKeys.iterator();  while(keyIterator.hasNext()) &#123;    SelectionKey key = keyIterator.next();    if(key.isAcceptable()) &#123;        // a connection was accepted by a ServerSocketChannel.    &#125; else if (key.isConnectable()) &#123;        // a connection was established with a remote server.    &#125; else if (key.isReadable()) &#123;        // a channel is ready for reading    &#125; else if (key.isWritable()) &#123;        // a channel is ready for writing    &#125;    keyIterator.remove();  &#125;&#125;\n\nå¯¹äº Selectorï¼Œæˆ‘ä»¬è¿˜éœ€è¦éå¸¸ç†Ÿæ‚‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š\n\nselect()\nè°ƒç”¨æ­¤æ–¹æ³•ï¼Œä¼šå°†ä¸Šæ¬¡ select ä¹‹åçš„å‡†å¤‡å¥½çš„ channel å¯¹åº”çš„ SelectionKey å¤åˆ¶åˆ° selected set ä¸­ã€‚å¦‚æœæ²¡æœ‰ä»»ä½•é€šé“å‡†å¤‡å¥½ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡ï¼Œç›´åˆ°è‡³å°‘æœ‰ä¸€ä¸ªé€šé“å‡†å¤‡å¥½ã€‚\n\nselectNow()\nåŠŸèƒ½å’Œ select ä¸€æ ·ï¼ŒåŒºåˆ«åœ¨äºå¦‚æœæ²¡æœ‰å‡†å¤‡å¥½çš„é€šé“ï¼Œé‚£ä¹ˆæ­¤æ–¹æ³•ä¼šç«‹å³è¿”å› 0ã€‚\n\nselect(long timeout)\nçœ‹äº†å‰é¢ä¸¤ä¸ªï¼Œè¿™ä¸ªåº”è¯¥å¾ˆå¥½ç†è§£äº†ï¼Œå¦‚æœæ²¡æœ‰é€šé“å‡†å¤‡å¥½ï¼Œæ­¤æ–¹æ³•ä¼šç­‰å¾…ä¸€ä¼š\n\nwakeup()\nè¿™ä¸ªæ–¹æ³•æ˜¯ç”¨æ¥å”¤é†’ç­‰å¾…åœ¨ select() å’Œ select(timeout) ä¸Šçš„çº¿ç¨‹çš„ã€‚å¦‚æœ wakeup() å…ˆè¢«è°ƒç”¨ï¼Œæ­¤æ—¶æ²¡æœ‰çº¿ç¨‹åœ¨ select ä¸Šé˜»å¡ï¼Œé‚£ä¹ˆä¹‹åçš„ä¸€ä¸ª select() æˆ– select(timeout) ä¼šç«‹å³è¿”å›ï¼Œè€Œä¸ä¼šé˜»å¡ï¼Œå½“ç„¶ï¼Œå®ƒåªä¼šä½œç”¨ä¸€æ¬¡ã€‚\n\n\n","categories":["Java","IO"]},{"title":"G1 åƒåœ¾æ”¶é›†å™¨","url":"/posts/63375/","content":"ä¸€ã€ä»‹ç»Gartage First (ç®€ç§°G1)æ”¶é›†å™¨æ˜¯åƒåœ¾æ”¶é›†å™¨æŠ€æœ¯å‘å±•å†å²ä¸Šçš„é‡Œç¨‹ç¢‘å¼çš„æˆæœï¼Œå®ƒå¼€åˆ›äº†æ”¶é›†å™¨é¢å‘å±€éƒ¨æ”¶é›†çš„è®¾è®¡æ€è·¯å’ŒåŸºäº Region çš„å†…å­˜å¸ƒå±€å½¢å¼ã€‚\næ—©åœ¨ JDK7 åˆšåˆšç¡®ç«‹é¡¹ç›®ç›®æ ‡ã€Oracleå…¬å¸åˆ¶å®šçš„ JDK7 RoadMap é‡Œé¢ï¼ŒG1 æ”¶é›†å™¨å°±è¢«è§†ä½œ JDK7 ä¸­ HotSpot è™šæ‹Ÿæœºçš„ä¸€é¡¹é‡è¦è¿›åŒ–ç‰¹å¾ã€‚ä»JDK 6 Update 14å¼€å§‹å°±æœ‰Early Accessç‰ˆæœ¬çš„ G1 æ”¶é›†å™¨ä¾›å¼€å‘äººå‘˜å®éªŒå’Œè¯•ç”¨ï¼Œä½†ç”±æ­¤å¼€å§‹ G1 æ”¶é›†å™¨çš„â€œå®éªŒçŠ¶æ€â€ï¼ˆExperimentalï¼‰æŒç»­äº†æ•°å¹´æ—¶é—´ï¼Œç›´è‡³JDK 7 Update 4ï¼ŒOracle æ‰è®¤ä¸ºå®ƒè¾¾åˆ°è¶³å¤Ÿæˆç†Ÿçš„å•†ç”¨ç¨‹åº¦ï¼Œç§»é™¤äº† â€œExperimentalâ€ çš„æ ‡è¯†ï¼›\nåˆ°äº†JDK 8 Update 40çš„æ—¶å€™ï¼ŒG1 æä¾›å¹¶å‘çš„ç±»å¸è½½çš„æ”¯æŒï¼Œè¡¥å…¨äº†å…¶è®¡åˆ’åŠŸèƒ½çš„æœ€åä¸€å—æ‹¼å›¾ã€‚è¿™ä¸ªç‰ˆæœ¬ä»¥åçš„ G1 æ”¶é›†å™¨æ‰è¢« Oracle å®˜æ–¹ç§°ä¸º â€œå…¨åŠŸèƒ½çš„åƒåœ¾æ”¶é›†å™¨â€ ï¼ˆFully-Featured Garbage Collectorï¼‰ã€‚\nG1æ˜¯ä¸€æ¬¾ä¸»è¦é¢å‘æœåŠ¡ç«¯åº”ç”¨çš„åƒåœ¾æ”¶é›†å™¨ã€‚\nHotSpot å¼€å‘å›¢é˜Ÿæœ€åˆèµ‹äºˆå®ƒçš„æœŸæœ›æ˜¯ï¼ˆåœ¨æ¯”è¾ƒé•¿æœŸçš„ï¼‰æœªæ¥å¯ä»¥æ›¿æ¢æ‰ JDK 5 ä¸­å‘å¸ƒçš„ CMS æ”¶é›†å™¨ã€‚ç°åœ¨è¿™ä¸ªæœŸæœ›ç›®æ ‡å·²ç»å®ç°è¿‡åŠäº†ï¼ŒJDK9 å‘å¸ƒä¹‹æ—¥ï¼ŒG1 å®£å‘Šå–ä»£ Parallel Scavenge åŠ  Parallel Old ç»„åˆï¼Œæˆä¸ºæœåŠ¡ç«¯æ¨¡å¼ä¸‹çš„é»˜è®¤åƒåœ¾æ”¶é›†å™¨ï¼Œè€Œ CMS åˆ™æ²¦è½è‡³è¢«å£°æ˜ä¸ºä¸æ¨èä½¿ç”¨ï¼ˆDeprecateï¼‰çš„æ”¶é›†å™¨æ—¥ã€‚\nå¦‚æœå¯¹ JDK9 åŠä»¥ä¸Šç‰ˆæœ¬çš„ HotSpot è™šæ‹Ÿæœºä½¿ç”¨å‚æ•°  -XX:+UseConcMarkSweepGC æ¥å¼€å¯ CMS æ”¶é›†å™¨çš„è¯ï¼Œç”¨æˆ·ä¼šæ”¶åˆ°ä¸€ä¸ªè­¦å‘Šä¿¡æ¯ï¼Œæç¤º CMS æœªæ¥å°†ä¼šè¢«åºŸå¼ƒï¼š\n\nJavaHot Spot (TM)64-BitServer VMwarning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\n\nä½†ä½œä¸ºä¸€æ¬¾æ›¾è¢«å¹¿æ³›è¿ç”¨è¿‡çš„æ”¶é›†å™¨ï¼Œç»è¿‡å¤šä¸ªç‰ˆæœ¬çš„å¼€å‘è¿­ä»£åï¼ŒCMSï¼ˆä»¥åŠä¹‹å‰å‡ æ¬¾æ”¶é›†å™¨ï¼‰çš„ä»£ç ä¸ HotSpot çš„å†…å­˜ç®¡ç†ã€æ‰§è¡Œã€ç¼–è¯‘ã€ç›‘æ§ç­‰å­ç³»ç»Ÿéƒ½æœ‰åƒä¸ä¸‡ç¼•çš„è”ç³»ï¼Œè¿™æ˜¯å†å²åŸå› å¯¼è‡´çš„ï¼Œå¹¶ä¸ç¬¦åˆèŒè´£åˆ†ç¦»çš„è®¾è®¡åŸåˆ™ã€‚\nä¸ºæ­¤ï¼Œè§„åˆ’ JDK 10 åŠŸèƒ½ç›®æ ‡æ—¶ï¼ŒHotSpotè™šæ‹Ÿæœºæå‡ºäº† â€œç»Ÿä¸€åƒåœ¾æ”¶é›†å™¨æ¥å£â€ï¼Œå°†å†…å­˜å›æ”¶çš„ â€œè¡Œä¸ºâ€ ä¸ â€œå®ç°â€ è¿›è¡Œåˆ†ç¦»ï¼ŒCMS ä»¥åŠå…¶ä»–æ”¶é›†å™¨éƒ½é‡æ„æˆåŸºäºè¿™å¥—æ¥å£çš„ä¸€ç§å®ç°ã€‚ä»¥æ­¤ä¸ºåŸºç¡€ï¼Œæ—¥åè¦ç§»é™¤æˆ–è€…åŠ å…¥æŸä¸€æ¬¾æ”¶é›†å™¨ï¼Œéƒ½ä¼šå˜å¾—å®¹æ˜“è®¸å¤šï¼Œé£é™©ä¹Ÿå¯ä»¥æ§åˆ¶ï¼Œè¿™ç®—æ˜¯åœ¨ä¸º CMS é€€å‡ºå†å²èˆå°é“ºä¸‹æœ€åçš„é“è·¯äº†ã€‚\nä½œä¸º CMS æ”¶é›†å™¨çš„æ›¿ä»£è€…å’Œç»§æ‰¿äººï¼Œè®¾è®¡è€…ä»¬å¸Œæœ›åšå‡ºä¸€æ¬¾èƒ½å¤Ÿå»ºç«‹èµ· â€œåœé¡¿æ—¶é—´æ¨¡å‹â€ ï¼ˆPause Prediction Modelï¼‰çš„æ”¶é›†å™¨ï¼Œåœé¡¿æ—¶é—´æ¨¡å‹çš„æ„æ€æ˜¯èƒ½å¤Ÿæ”¯æŒæŒ‡å®šåœ¨ä¸€ä¸ªé•¿åº¦ä¸ºMæ¯«ç§’çš„æ—¶é—´ç‰‡æ®µå†…ï¼Œæ¶ˆè€—åœ¨åƒåœ¾æ”¶é›†ä¸Šçš„æ—¶é—´å¤§æ¦‚ç‡ä¸è¶…è¿‡Næ¯«ç§’è¿™æ ·çš„ç›®æ ‡ï¼Œè¿™å‡ ä¹å·²ç»æ˜¯å®æ—¶ Javaï¼ˆRTSJï¼‰çš„ä¸­è½¯å®æ—¶åƒåœ¾æ”¶é›†å™¨ç‰¹å¾äº†ã€‚\näºŒã€G1è®¾è®¡æ€æƒ³åœ¨ G1 æ”¶é›†å™¨å‡ºç°ä¹‹å‰çš„æ‰€æœ‰å…¶ä»–æ”¶é›†å™¨ï¼ŒåŒ…æ‹¬ CMS åœ¨å†…ï¼Œåƒåœ¾æ”¶é›†çš„ç›®æ ‡èŒƒå›´è¦ä¹ˆæ˜¯æ•´ä¸ªæ–°ç”Ÿä»£ï¼ˆMinor GCï¼‰ï¼Œè¦ä¹ˆå°±æ˜¯æ•´ä¸ªè€å¹´ä»£ï¼ˆMajor GCï¼‰ï¼Œå†è¦ä¹ˆå°±æ˜¯æ•´ä¸ªJavaå †ï¼ˆFull GCï¼‰ã€‚\nè€Œ G1 è·³å‡ºäº†è¿™ä¸ªæ¨Šç¬¼ï¼Œå®ƒå¯ä»¥é¢å‘å †å†…å­˜ä»»ä½•éƒ¨åˆ†æ¥ç»„æˆ å›æ”¶é›†ï¼ˆCollection Setï¼Œä¸€èˆ¬ç®€ç§° CSetï¼‰è¿›è¡Œå›æ”¶ï¼Œè¡¡é‡æ ‡å‡†ä¸å†æ˜¯å®ƒå±äºå“ªä¸ªåˆ†ä»£ï¼Œè€Œæ˜¯å“ªå—å†…å­˜ä¸­å­˜æ”¾çš„åƒåœ¾æ•°é‡æœ€å¤šï¼Œå›æ”¶æ”¶ç›Šæœ€å¤§ï¼Œè¿™å°±æ˜¯ G1 æ”¶é›†å™¨çš„ Mixed GC æ¨¡å¼ã€‚\nG1 å¼€åˆ›çš„åŸºäº Region çš„å †å†…å­˜å¸ƒå±€æ˜¯å®ƒèƒ½å¤Ÿå®ç°è¿™ä¸ªç›®æ ‡çš„å…³é”®ã€‚\nä¸‰ã€é‡è¦æ¦‚å¿µ1. RegionG1 ä¸å†åšæŒå›ºå®šå¤§å°ä»¥åŠå›ºå®šæ•°é‡çš„åˆ†ä»£åŒºåŸŸåˆ’åˆ†ï¼Œè€Œæ˜¯æŠŠè¿ç»­çš„ Java å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ˆRegionï¼‰ï¼Œæ¯ä¸€ä¸ª Region éƒ½å¯ä»¥æ ¹æ®éœ€è¦ï¼Œæ‰®æ¼”æ–°ç”Ÿä»£çš„ Eden ç©ºé—´ã€Survivor ç©ºé—´ï¼Œæˆ–è€…è€å¹´ä»£ç©ºé—´ã€‚\næ”¶é›†å™¨èƒ½å¤Ÿå¯¹æ‰®æ¼”ä¸åŒè§’è‰²çš„ Region é‡‡ç”¨ä¸åŒçš„ç­–ç•¥å»å¤„ç†ï¼Œè¿™æ ·æ— è®ºæ˜¯æ–°åˆ›å»ºçš„å¯¹è±¡è¿˜æ˜¯å·²ç»å­˜æ´»äº†ä¸€æ®µæ—¶é—´ã€ç†¬è¿‡å¤šæ¬¡æ”¶é›†çš„æ—§å¯¹è±¡éƒ½èƒ½è·å–å¾ˆå¥½çš„æ”¶é›†æ•ˆæœã€‚\nRegion ä¸­è¿˜æœ‰ä¸€ç±»ç‰¹æ®Šçš„ Humongous åŒºåŸŸï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨å¤§å¯¹è±¡ã€‚\nG1 è®¤ä¸ºåªè¦å¤§å°è¶…è¿‡äº†ä¸€ä¸ª Region å®¹é‡ä¸€åŠçš„å¯¹è±¡å³å¯åˆ¤å®šä¸ºå¤§å¯¹è±¡ã€‚\næ¯ä¸ª Region çš„å¤§å°å¯ä»¥é€šè¿‡å‚æ•° -XX:G1HeapRegionSize è®¾å®šï¼Œå–å€¼èŒƒå›´ä¸º1MBï½32MBï¼Œä¸”åº”ä¸º 2 çš„Næ¬¡å¹‚ã€‚å¦‚æœä¸è®¾å®šï¼Œé‚£ä¹ˆG1ä¼šæ ¹æ®Heapå¤§å°è‡ªåŠ¨å†³å®šã€‚\nè€Œå¯¹äºé‚£äº›è¶…è¿‡äº†æ•´ä¸ª Region å®¹é‡çš„è¶…çº§å¤§å¯¹è±¡ï¼Œå°†ä¼šè¢«å­˜æ”¾ åœ¨Nä¸ªè¿ç»­çš„Humongous Region ä¹‹ä¸­ï¼ŒG1 çš„å¤§å¤šæ•°è¡Œä¸ºéƒ½æŠŠ Humongous Region ä½œä¸ºè€å¹´ä»£çš„ä¸€éƒ¨åˆ†æ¥è¿›è¡Œçœ‹å¾…ã€‚\n\nè™½ç„¶ G1 ä»ç„¶ä¿ç•™æ–°ç”Ÿä»£å’Œè€å¹´ä»£çš„æ¦‚å¿µï¼Œä½†æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸å†æ˜¯å›ºå®šçš„äº†ï¼Œå®ƒä»¬éƒ½æ˜¯ä¸€ç³»åˆ—åŒºåŸŸï¼ˆä¸éœ€è¦è¿ç»­ï¼‰çš„åŠ¨æ€é›†åˆã€‚\nG1 æ”¶é›†å™¨ä¹‹æ‰€ä»¥èƒ½å»ºç«‹å¯é¢„æµ‹çš„åœé¡¿æ—¶é—´æ¨¡å‹ï¼Œæ˜¯å› ä¸ºå®ƒå°† Region ä½œä¸ºå•æ¬¡å›æ”¶çš„æœ€å°å•å…ƒï¼Œå³æ¯æ¬¡æ”¶é›†åˆ°çš„å†…å­˜ç©ºé—´éƒ½æ˜¯ Region å¤§å°çš„æ•´æ•°å€ï¼Œè¿™æ ·å¯ä»¥æœ‰è®¡åˆ’åœ°é¿å…åœ¨æ•´ä¸ªJavaå †ä¸­è¿›è¡Œå…¨åŒºåŸŸçš„åƒåœ¾æ”¶é›†ã€‚\næ›´å…·ä½“çš„å¤„ç†æ€è·¯æ˜¯è®© G1 æ”¶é›†å™¨å»è·Ÿè¸ªå„ä¸ª Region é‡Œé¢çš„åƒåœ¾å †ç§¯çš„ â€œä»·å€¼â€ å¤§å°ï¼Œä»·å€¼å³å›æ”¶æ‰€è·å¾—çš„ç©ºé—´å¤§å°ä»¥åŠå›æ”¶æ‰€éœ€æ—¶é—´çš„ç»éªŒå€¼ï¼Œç„¶ååœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼Œæ¯æ¬¡æ ¹æ®ç”¨æˆ·è®¾å®šå…è®¸çš„ æ”¶é›†åœé¡¿æ—¶é—´ï¼ˆä½¿ç”¨å‚æ•° -XX:MasGCPatseMs æŒ‡å®šï¼Œé»˜è®¤å€¼æ˜¯200æ¯«ç§’ï¼‰ä¼˜å…ˆå¤„ç†å›æ”¶ä»·å€¼æ”¶ç›Šæœ€å¤§çš„é‚£äº› Regionã€‚\nè¿™ä¹Ÿå°±æ˜¯ â€œCartbolseFirstâ€ åå­—çš„ç”±æ¥ã€‚è¿™ç§ä½¿ç”¨ Region åˆ’åˆ†å†…å­˜ç©ºé—´ï¼Œä»¥åŠå…·æœ‰ä¼˜å…ˆçº§çš„åŒºåŸŸå›æ”¶æ–¹å¼ï¼Œä¿è¯äº† G1 æ”¶é›†å™¨åœ¨æœ‰é™çš„æ—¶é—´å†…è·å–å°½å¯èƒ½é«˜çš„æ”¶é›†æ•ˆç‡ã€‚\nG1 å°†å †å†…å­˜ â€œåŒ–æ•´ä¸ºé›¶â€ çš„ â€œè§£é¢˜æ€è·¯â€ ï¼Œçœ‹èµ·æ¥ä¼¼ä¹æ²¡æœ‰å¤ªå¤šä»¤äººæƒŠè®¶ä¹‹å¤„ï¼Œä¹Ÿå®Œå…¨ä¸éš¾ç†è§£ï¼Œä½†å…¶ä¸­çš„å®ç°ç»†èŠ‚å¯æ˜¯è¿œè¿œæ²¡æœ‰æƒ³è±¡ä¸­é‚£ä¹ˆç®€å•ï¼Œå¦åˆ™å°±ä¸ä¼šä»2004å¹´Sunå®éªŒå®¤å‘è¡¨ç¬¬ä¸€ç¯‡å…³äº G1çš„è®ºæ–‡åä¸€ç›´æ‹–åˆ°2012å¹´4æœˆJDK 7 Update 4å‘å¸ƒï¼Œç”¨å°†è¿‘10å¹´æ—¶é—´æ‰å€’è…¾å‡ºèƒ½å¤Ÿå•†ç”¨çš„ G1 æ”¶é›†å™¨æ¥ã€‚\n2. RSetå…¨ç§°æ˜¯ Remembered Setï¼Œæ˜¯è¾…åŠ© GC è¿‡ç¨‹çš„ä¸€ç§ç»“æ„ï¼Œå…¸å‹çš„ç©ºé—´æ¢æ—¶é—´å·¥å…·ï¼Œå’Œ Card Tableæœ‰äº›ç±»ä¼¼ã€‚è¿˜æœ‰ä¸€ç§æ•°æ®ç»“æ„ä¹Ÿæ˜¯è¾…åŠ©GCçš„ï¼šCollection Setï¼ˆCSetï¼‰ï¼Œå®ƒè®°å½•äº†GCè¦æ”¶é›†çš„Regioné›†åˆï¼Œé›†åˆé‡Œçš„Regionå¯ä»¥æ˜¯ä»»æ„å¹´ä»£çš„ã€‚åœ¨ GC çš„æ—¶å€™ï¼Œå¯¹äºold-&gt;youngå’Œ young-&gt;oldçš„è·¨ä»£å¯¹è±¡å¼•ç”¨ï¼Œåªè¦æ‰«æå¯¹åº”çš„ CSet ä¸­çš„ RSet å³å¯ã€‚\nä½¿ç”¨ RSet å¯ä»¥é¿å…å…¨å †ä½œä¸º GC Roots æ‰«æï¼Œä½†åœ¨ G1 æ”¶é›†å™¨ä¸Š RSet çš„åº”ç”¨å…¶å®è¦å¤æ‚å¾ˆå¤šï¼Œå®ƒçš„æ¯ä¸ª Region éƒ½ç»´æŠ¤æœ‰è‡ªå·±çš„ RSetï¼Œè¿™äº›è®°å¿†é›†ä¼šè®°å½•ä¸‹åˆ«çš„ Region æŒ‡å‘è‡ªå·±çš„æŒ‡é’ˆã€‚å¹¶æ ‡è®°è¿™äº›æŒ‡é’ˆåˆ†åˆ«åœ¨å“ªäº›å¡é¡µçš„èŒƒå›´ä¹‹å†…ã€‚\nG1 çš„ RSet åœ¨å­˜å‚¨ç»“æ„çš„æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å“ˆå¸Œè¡¨ï¼ŒKey æ˜¯åˆ«çš„ Region çš„èµ·å§‹åœ°å€ï¼ˆè¡¨ç¤ºè¿™ä¸ª Region ä¸­æœ‰æŒ‡é’ˆæŒ‡å‘ â€æˆ‘â€œï¼‰ï¼ŒValue æ˜¯ä¸€ä¸ªé›†åˆï¼Œé‡Œé¢å­˜å‚¨çš„å…ƒç´ æ˜¯å¡è¡¨çš„ç´¢å¼•å·ï¼ˆå³è¿™ä¸ª Region ä¸­å“ªä¸ª card ä¸­æœ‰å¯¹è±¡æŒ‡å‘äº†æˆ‘ï¼‰ã€‚\nè¿™ç§ â€œåŒå‘â€ çš„å¡è¡¨ç»“æ„ï¼ˆå¡è¡¨æ˜¯ â€œæˆ‘æŒ‡å‘è°â€ï¼Œè¿™ç§ç»“æ„è¿˜è®°å½•äº† â€œè°æŒ‡å‘æˆ‘â€ ï¼‰æ¯”åŸæ¥çš„å¡è¡¨å®ç°èµ·æ¥æ›´å¤æ‚ï¼ŒåŒæ—¶ç”±äº Region æ•°é‡æ¯”ä¼ ç»Ÿæ”¶é›†å™¨çš„åˆ†ä»£æ•°é‡æ˜æ˜¾è¦å¤šå¾—å¤šï¼Œå› æ­¤ G1 æ”¶é›†å™¨è¦æ¯”å…¶ä»–çš„ä¼ ç»Ÿåƒåœ¾æ”¶é›†å™¨æœ‰ç€æ›´é«˜çš„å†…å­˜å ç”¨è´Ÿæ‹…ã€‚\næ ¹æ®ç»éªŒï¼ŒG1 è‡³å°‘è¦è€—è´¹å¤§çº¦ç›¸å½“äº Java å †å®¹é‡ 10% è‡³ 20% çš„é¢å¤–å†…å­˜æ¥ç»´æŒæ”¶é›†å™¨å·¥ä½œã€‚\n\nä¸Šå›¾ä¸­æœ‰ä¸‰ä¸ª Regionï¼Œæ¯ä¸ª Region è¢«åˆ†æˆäº†å¤šä¸ª Cardï¼Œåœ¨ä¸åŒ Region ä¸­çš„ Card ä¼šç›¸äº’å¼•ç”¨ï¼ŒRegion1 ä¸­çš„ Card ä¸­çš„å¯¹è±¡å¼•ç”¨äº† Region2 ä¸­çš„ Card ä¸­çš„å¯¹è±¡ï¼Œè“è‰²å®çº¿è¡¨ç¤ºçš„å°±æ˜¯points-outçš„å…³ç³»ï¼Œè€Œåœ¨ Region2 çš„ RSet ä¸­ï¼Œè®°å½•äº† Region1 çš„ Cardï¼Œå³çº¢è‰²è™šçº¿è¡¨ç¤ºçš„å…³ç³»ï¼Œè¿™å°±æ˜¯ points-intoã€‚ è€Œç»´ç³» RSet ä¸­çš„å¼•ç”¨å…³ç³»é  post-write barrier å’Œ Concurrent refinement threads æ¥ç»´æŠ¤\n3. TAMSå¹¶å‘æ ‡è®°é˜¶æ®µå¦‚ä½•ä¿è¯æ”¶é›†çº¿ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹äº’ä¸å¹²æ‰°åœ°è¿è¡Œï¼Ÿ\nè¿™é‡Œé¦–å…ˆè¦è§£å†³çš„æ˜¯ç”¨æˆ·çº¿ç¨‹æ”¹å˜å¯¹è±¡å¼•ç”¨å…³ç³»æ—¶ï¼Œå¿…é¡»ä¿è¯å…¶ä¸èƒ½æ‰“ç ´åŸæœ¬çš„å¯¹è±¡å›¾ç»“æ„ï¼Œå¯¼è‡´æ ‡è®°ç»“æœå‡ºç°é”™è¯¯ã€‚\nCMS æ”¶é›†å™¨é‡‡ç”¨ å¢é‡æ›´æ–°ç®—æ³• å®ç°ï¼Œè€Œ G1 æ”¶é›†å™¨åˆ™æ˜¯é€šè¿‡ åŸå§‹å¿«ç…§ï¼ˆSATBï¼‰ç®—æ³•æ¥å®ç°çš„ã€‚\næ­¤å¤–ï¼Œåƒåœ¾æ”¶é›†å¯¹ç”¨æˆ·çº¿ç¨‹çš„å½±å“è¿˜ä½“ç°åœ¨å›æ”¶è¿‡ç¨‹ä¸­æ–°åˆ›å»ºå¯¹è±¡çš„å†…å­˜åˆ†é…ä¸Šï¼Œç¨‹åºè¦ç»§ç»­è¿è¡Œå°±è‚¯å®šä¼šæŒç»­æœ‰æ–°å¯¹è±¡è¢«åˆ›å»ºã€‚\nG1 ä¸ºæ¯ä¸€ä¸ª Region è®¾è®¡äº†ä¸¤ä¸ªåä¸º TAMSï¼ˆTop at Mark Startï¼‰ çš„æŒ‡é’ˆï¼ŒæŠŠ Region ä¸­çš„ä¸€éƒ¨åˆ†ç©ºé—´åˆ’åˆ†å‡ºæ¥ç”¨äºå¹¶å‘å›æ”¶è¿‡ç¨‹ä¸­çš„æ–°å¯¹è±¡åˆ†é…ï¼Œå¹¶å‘å›æ”¶æ—¶æ–°åˆ†é…çš„å¯¹è±¡åœ°å€éƒ½å¿…é¡»è¦åœ¨è¿™ä¸¤ä¸ªæŒ‡é’ˆä½ç½®ä»¥ä¸Šã€‚G1 æ”¶é›†å™¨é»˜è®¤åœ¨è¿™ä¸ªåœ°å€ä»¥ä¸Šçš„å¯¹è±¡æ˜¯è¢«éšå¼æ ‡è®°è¿‡çš„ï¼Œå³é»˜è®¤å®ƒä»¬æ˜¯å­˜æ´»çš„ï¼Œä¸çº³å…¥å›æ”¶èŒƒå›´ã€‚\nä¸ CMS ä¸­çš„ â€œConcurrentMode Failureâ€ å¤±è´¥ä¼šå¯¼è‡´ Full GC ç±»ä¼¼ï¼Œå¦‚æœå†…å­˜å›æ”¶çš„é€Ÿåº¦èµ¶ä¸ä¸Šå†…å­˜åˆ†é…çš„é€Ÿåº¦ï¼ŒG1 æ”¶é›†å™¨ä¹Ÿè¦è¢«è¿«å†»ç»“ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œï¼Œå¯¼è‡´ Full GC è€Œäº§ç”Ÿé•¿æ—¶é—´ â€œStop TheWorldâ€œã€‚\n4. åœé¡¿é¢„æµ‹æ¨¡å‹ï¼ˆPause Prediction Modelï¼‰ç”¨æˆ·é€šè¿‡  -XX:MaxGCPauseMillis å‚æ•°æŒ‡å®šçš„åœé¡¿æ—¶é—´åªæ„å‘³ç€åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰çš„æœŸæœ›å€¼ï¼Œä½†G1æ”¶é›†å™¨è¦æ€ä¹ˆåšæ‰èƒ½æ»¡è¶³ç”¨æˆ·çš„æœŸæœ›å‘¢ï¼Ÿ\nG1 æ”¶é›†å™¨çš„åœé¡¿é¢„æµ‹æ¨¡å‹æ˜¯ä»¥ è¡°å‡å‡å€¼ï¼ˆDecaying Averageï¼‰ä¸ºç†è®ºåŸºç¡€æ¥å®ç°çš„ã€‚\nåœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­ï¼ŒG1 æ”¶é›†å™¨ä¼šè®°å½•æ¯ä¸ª Region çš„å›æ”¶è€—æ—¶ã€æ¯ä¸ª Region è®°å¿†é›†é‡Œçš„è„å¡æ•°é‡ç­‰å„ä¸ªå¯æµ‹é‡çš„æ­¥éª¤èŠ±è´¹çš„æˆæœ¬ï¼Œå¹¶åˆ†æå¾—å‡ºå¹³å‡å€¼ã€æ ‡å‡†åå·®ã€ç½®ä¿¡åº¦ç­‰ç»Ÿè®¡ä¿¡æ¯ã€‚\nè¿™é‡Œå¼ºè°ƒçš„ â€œè¡°å‡å¹³å‡å€¼â€ æ˜¯æŒ‡å®ƒä¼šæ¯”æ™®é€šçš„å¹³å‡å€¼æ›´å®¹æ˜“å—åˆ°æ–°æ•°æ®çš„å½±å“ï¼Œå¹³å‡å€¼ä»£è¡¨æ•´ä½“å¹³å‡çŠ¶æ€ï¼Œä½†è¡°å‡å¹³å‡å€¼æ›´å‡†ç¡®åœ°ä»£è¡¨ â€œæœ€è¿‘çš„â€ å¹³å‡çŠ¶æ€ã€‚\næ¢å¥è¯è¯´ï¼ŒRegionçš„ç»Ÿè®¡çŠ¶æ€è¶Šæ–°è¶Šèƒ½å†³å®šå…¶å›æ”¶çš„ä»·å€¼ã€‚ç„¶åé€šè¿‡è¿™äº›ä¿¡æ¯é¢„æµ‹ç°åœ¨å¼€å§‹å›æ”¶çš„è¯ï¼Œç”±å“ªäº› Region ç»„æˆå›æ”¶é›†æ‰å¯ä»¥åœ¨ä¸è¶…è¿‡æœŸæœ›åœé¡¿æ—¶é—´çš„çº¦æŸä¸‹è·å¾—æœ€é«˜çš„æ”¶ç›Šã€‚\n5. Mixed GCå¦‚æœæˆ‘ä»¬ä¸å»è®¡ç®—ç”¨æˆ·çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­çš„åŠ¨ä½œï¼ˆå¦‚ä½¿ç”¨å†™å±éšœç»´æŠ¤è®°å¿†é›†çš„æ“ä½œï¼‰ï¼ŒG1 æ”¶é›†å™¨çš„è¿ä½œè¿‡ç¨‹å¤§è‡´å¯åˆ’åˆ†ä¸ºä»¥ä¸‹å››ä¸ªæ­¥éª¤ï¼šåˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€æœ€ç»ˆæ ‡è®°ã€ç­›é€‰å›æ”¶ã€‚\n\nåˆå§‹æ ‡è®°ï¼ˆInitial Markingï¼‰ï¼šä»…ä»…åªæ˜¯æ ‡è®°ä¸€ä¸‹ GC Roots èƒ½ç›´æ¥å…³è”åˆ°çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä¿®æ”¹ TAMS æŒ‡é’ˆçš„å€¼ï¼Œè®©ä¸‹ä¸€é˜¶æ®µç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿è¡Œæ—¶ï¼Œèƒ½æ­£ç¡®åœ°åœ¨å¯ç”¨çš„ Region ä¸­åˆ†é…æ–°å¯¹è±¡ã€‚è¿™ä¸ªé˜¶æ®µéœ€è¦åœé¡¿çº¿ç¨‹ï¼Œä½†è€—æ—¶å¾ˆçŸ­ï¼Œè€Œä¸”æ˜¯å€Ÿç”¨è¿›è¡Œ Minor GC çš„æ—¶å€™åŒæ­¥å®Œæˆçš„ï¼Œæ‰€ä»¥ G1 æ”¶é›†å™¨åœ¨è¿™ä¸ªé˜¶æ®µå®é™…å¹¶æ²¡æœ‰é¢å¤–çš„åœé¡¿ã€‚\nå¹¶å‘æ ‡è®°ï¼ˆConcurrent Markingï¼‰ï¼šä» GC Root å¼€å§‹å¯¹å †ä¸­å¯¹è±¡è¿›è¡Œå¯è¾¾æ€§åˆ†æï¼Œé€’å½’æ‰«ææ•´ä¸ªå †é‡Œçš„å¯¹è±¡å›¾ï¼Œæ‰¾å‡ºè¦å›æ”¶çš„å¯¹è±¡ï¼Œè¿™é˜¶æ®µè€—æ—¶è¾ƒé•¿ï¼Œä½†å¯ä¸ç”¨æˆ·ç¨‹åºå¹¶å‘æ‰§è¡Œã€‚å½“å¯¹è±¡å›¾æ‰«æå®Œæˆä»¥åï¼Œè¿˜è¦é‡æ–°å¤„ç† SATB è®°å½•ä¸‹çš„åœ¨å¹¶å‘æ—¶æœ‰å¼•ç”¨å˜åŠ¨çš„å¯¹è±¡ã€‚\næœ€ç»ˆæ ‡è®°ï¼ˆFinal Markingï¼‰ï¼šå¯¹ç”¨æˆ·çº¿ç¨‹åšå¦ä¸€ä¸ªçŸ­æš‚çš„æš‚åœï¼Œç”¨äºå¤„ç†å¹¶å‘é˜¶æ®µç»“æŸåä»é—ç•™ä¸‹æ¥çš„æœ€åé‚£å°‘é‡çš„ SATB è®°å½•ã€‚\nç­›é€‰å›æ”¶ï¼ˆLive Data Counting and Evacuationï¼‰ï¼šè´Ÿè´£æ›´æ–° Region çš„ç»Ÿè®¡æ•°æ®ï¼Œå¯¹å„ä¸ª Region çš„å›æ”¶ä»·å€¼å’Œæˆæœ¬è¿›è¡Œæ’åºï¼Œæ ¹æ®ç”¨æˆ·æ‰€æœŸæœ›çš„åœé¡¿æ—¶é—´æ¥åˆ¶å®šå›æ”¶è®¡åˆ’ï¼Œå¯ä»¥è‡ªç”±é€‰æ‹©ä»»æ„å¤šä¸ª Reion æ„æˆå›æ”¶é›†ï¼Œç„¶åæŠŠå†³å®šå›æ”¶çš„é‚£ä¸€éƒ¨åˆ† Region çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ç©ºçš„ Rerion ä¸­ï¼Œå†æ¸…ç†æ‰æ•´ä¸ªæ—§ Region çš„å…¨éƒ¨ç©ºé—´ã€‚è¿™é‡Œçš„æ“ä½œæ¶‰åŠå­˜æ´»å¯¹è±¡çš„ç§»åŠ¨ï¼Œæ˜¯å¿…é¡»æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œç”±å¤šæ¡æ”¶é›†å™¨çº¿ç¨‹å¹¶è¡Œå®Œæˆçš„ã€‚\n\nä»ä¸Šè¿°é˜¶æ®µçš„æè¿°å¯ä»¥çœ‹å‡ºï¼ŒG1æ”¶é›†å™¨é™¤äº†å¹¶å‘æ ‡è®°å¤–ï¼Œå…¶ä½™é˜¶æ®µä¹Ÿæ˜¯è¦å®Œå…¨æš‚åœç”¨æˆ·çº¿ç¨‹çš„ã€‚\næ¢è¨€ä¹‹ï¼Œå®ƒå¹¶éçº¯ç²¹åœ°è¿½æ±‚ä½å»¶è¿Ÿï¼Œå®˜æ–¹ç»™å®ƒè®¾å®šçš„ç›®æ ‡æ˜¯åœ¨å»¶è¿Ÿå¯æ§çš„æƒ…å†µä¸‹è·å¾—å°½å¯èƒ½é«˜çš„ååé‡ï¼Œæ‰€ä»¥æ‰èƒ½æ‹…å½“èµ· â€œå…¨åŠŸèƒ½æ”¶é›†å™¨â€  çš„é‡ä»»ä¸æœŸæœ›ã€‚\nä»Oracleå®˜æ–¹é€éœ²å‡ºæ¥çš„ä¿¡æ¯å¯è·çŸ¥ï¼Œå›æ”¶é˜¶æ®µï¼ˆEvacuationï¼‰å…¶å®æœ¬ä¹Ÿæœ‰æƒ³è¿‡è®¾è®¡æˆä¸ç”¨æˆ·ç¨‹åºä¸€èµ·å¹¶å‘æ‰§è¡Œï¼Œä½†è¿™ä»¶äº‹æƒ…åšèµ·æ¥æ¯”è¾ƒå¤æ‚ï¼Œè€ƒè™‘åˆ° G1 åªæ˜¯å›æ”¶ä¸€éƒ¨åˆ† Regionï¼Œåœé¡¿æ—¶é—´æ˜¯ç”¨æˆ·å¯æ§åˆ¶çš„ï¼Œæ‰€ä»¥å¹¶ä¸è¿«åˆ‡å»å®ç°ï¼Œè€Œé€‰æ‹©æŠŠè¿™ä¸ªç‰¹æ€§æ”¾åˆ°äº† G1 ä¹‹åå‡ºç°çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼ˆå³ZGCï¼‰ä¸­ã€‚\nå¦å¤–ï¼Œè¿˜è€ƒè™‘åˆ° G1 ä¸æ˜¯ä»…ä»…é¢å‘ä½å»¶è¿Ÿï¼Œåœé¡¿ç”¨æˆ·çº¿ç¨‹èƒ½å¤Ÿæœ€å¤§å¹…åº¦æé«˜åƒåœ¾æ”¶é›†æ•ˆç‡ï¼Œä¸ºäº†ä¿è¯ååé‡æ‰€ä»¥æ‰é€‰æ‹©äº†å®Œå…¨æš‚åœç”¨æˆ·çº¿ç¨‹çš„å®ç°æ–¹æ¡ˆã€‚\né€šè¿‡ä¸‹å›¾å¯ä»¥æ¯”è¾ƒæ¸…æ¥šåœ°çœ‹åˆ° G1 æ”¶é›†å™¨çš„è¿ä½œæ­¥éª¤ä¸­å¹¶å‘å’Œéœ€è¦åœé¡¿çš„é˜¶æ®µã€‚\n\næ¯«æ— ç–‘é—®ï¼Œå¯ä»¥ç”±ç”¨æˆ·æŒ‡å®šæœŸæœ›çš„åœé¡¿æ—¶é—´æ˜¯ G1 æ”¶é›†å™¨å¾ˆå¼ºå¤§çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œè®¾ç½®ä¸åŒçš„æœŸæœ›åœé¡¿æ—¶é—´ï¼Œå¯ä½¿å¾— G1 åœ¨ä¸åŒåº”ç”¨åœºæ™¯ä¸­å–å¾—å…³æ³¨ååé‡å’Œå…³æ³¨å»¶è¿Ÿä¹‹é—´çš„æœ€ä½³å¹³è¡¡ã€‚\nä¸è¿‡ï¼Œè¿™é‡Œè®¾ç½®çš„ â€œæœŸæœ›å€¼â€ å¿…é¡»æ˜¯ç¬¦åˆå®é™…çš„ï¼Œä¸èƒ½å¼‚æƒ³å¤©å¼€ï¼Œæ¯•ç«Ÿ G1 æ˜¯è¦å†»ç»“ç”¨æˆ·çº¿ç¨‹æ¥å¤åˆ¶å¯¹è±¡çš„ï¼Œè¿™ä¸ªåœé¡¿æ—¶é—´å†æ€ä¹ˆä½ä¹Ÿå¾—æœ‰ä¸ªé™åº¦ã€‚\nå®ƒé»˜è®¤çš„åœé¡¿ç›®æ ‡ä¸ºä¸¤ç™¾æ¯«ç§’ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå›æ”¶é˜¶æ®µå åˆ°å‡ ååˆ°ä¸€ç™¾ç”šè‡³æ¥è¿‘ä¸¤ç™¾æ¯«ç§’éƒ½å¾ˆæ­£å¸¸ï¼Œä½†å¦‚æœæˆ‘ä»¬æŠŠåœé¡¿æ—¶é—´è°ƒå¾—éå¸¸ä½ï¼Œè­¬å¦‚è®¾ç½®ä¸ºäºŒåæ¯«ç§’ï¼Œå¾ˆå¯èƒ½å‡ºç°çš„ç»“æœå°±æ˜¯ç”±äºåœé¡¿ç›®æ ‡æ—¶é—´å¤ªçŸ­ï¼Œå¯¼è‡´æ¯æ¬¡é€‰å‡ºæ¥çš„å›æ”¶é›†åªå å †å†…å­˜å¾ˆå°çš„ä¸€éƒ¨åˆ†ï¼Œæ”¶é›†å™¨æ”¶é›†çš„é€Ÿåº¦é€æ¸è·Ÿä¸ä¸Šåˆ†é…å™¨åˆ†é…çš„é€Ÿåº¦ï¼Œå¯¼è‡´åƒåœ¾æ…¢æ…¢å †ç§¯ã€‚\nå¾ˆå¯èƒ½ä¸€å¼€å§‹æ”¶é›†å™¨è¿˜èƒ½ä»ç©ºé—²çš„å †å†…å­˜ä¸­è·å¾—ä¸€äº›å–˜æ¯çš„æ—¶é—´ï¼Œä½†åº”ç”¨è¿è¡Œæ—¶é—´ä¸€é•¿å°±ä¸è¡Œäº†ï¼Œæœ€ç»ˆå æ»¡å †å¼•å‘ Full GC åè€Œé™ä½æ€§èƒ½ï¼Œæ‰€ä»¥é€šå¸¸æŠŠæœŸæœ›åœé¡¿æ—¶é—´è®¾ç½®ä¸ºä¸€ä¸¤ç™¾æ¯«ç§’æˆ–è€…ä¸¤ä¸‰ç™¾æ¯«ç§’ä¼šæ˜¯æ¯”è¾ƒåˆç†çš„ã€‚\nä» G1 å¼€å§‹ï¼Œæœ€å…ˆè¿›çš„åƒåœ¾æ”¶é›†å™¨çš„è®¾è®¡å¯¼å‘éƒ½ä¸çº¦è€ŒåŒåœ°å˜ä¸ºè¿½æ±‚èƒ½å¤Ÿåº”ä»˜åº”ç”¨çš„å†…å­˜åˆ†é…é€Ÿç‡ï¼ˆAllocation Rateï¼‰ï¼Œè€Œä¸è¿½æ±‚ä¸€æ¬¡æŠŠæ•´ä¸ª Java å †å…¨éƒ¨æ¸…ç†å¹²å‡€ã€‚\nè¿™æ ·ï¼Œåº”ç”¨åœ¨åˆ†é…ï¼ŒåŒæ—¶æ”¶é›†å™¨åœ¨æ”¶é›†ï¼Œåªè¦æ”¶é›†çš„é€Ÿåº¦èƒ½è·Ÿå¾—ä¸Šå¯¹è±¡åˆ†é…çš„é€Ÿåº¦ï¼Œé‚£ä¸€åˆ‡å°±èƒ½è¿ä½œå¾—å¾ˆå®Œç¾ã€‚è¿™ç§æ–°çš„æ”¶é›†å™¨è®¾è®¡æ€è·¯ä»å·¥ç¨‹å®ç°ä¸Šçœ‹æ˜¯ä» G1 å¼€å§‹å…´èµ·çš„ï¼Œæ‰€ä»¥è¯´ G1 æ˜¯æ”¶é›†å™¨æŠ€æœ¯å‘å±•çš„ä¸€ä¸ªé‡Œç¨‹ç¢‘ã€‚\nå››ã€G1åƒåœ¾æ”¶é›†å™¨è¿è¡Œç»†èŠ‚1. ä½•æ—¶è§¦å‘ Minor GCåœ¨ G1 ä¸­ï¼ŒEdenã€Survivorã€è€å¹´ä»£çš„å¤§å°æ˜¯åœ¨åŠ¨æ€å˜åŒ–çš„ã€‚åœ¨åˆå§‹æ—¶ï¼Œæ–°ç”Ÿä»£å æ•´ä¸ªå †å†…å­˜çš„ 5%ï¼Œå¯ä»¥é€šè¿‡å‚æ•° G1NewSizePercent è®¾ç½®ï¼Œé»˜è®¤å€¼ä¸º 5ã€‚\nåœ¨ G1 ä¸­ï¼Œè™½ç„¶è¿›è¡Œäº† Region åˆ†åŒºï¼Œä½†æ˜¯æ–°ç”Ÿä»£ä¾æ—§å¯ä»¥è¢«åˆ†ä¸º Eden åŒºå’Œ Survivor åŒºï¼Œå‚æ•° SurvivorRatio ä¾æ—§è¡¨ç¤º Eden/Survivor çš„æ¯”å€¼ã€‚\néšç€ç³»ç»Ÿçš„è¿è¡Œï¼ŒEden åŒºçš„å¯¹è±¡è¶Šæ¥è¶Šå¤šï¼Œå½“è¾¾åˆ° Eden åŒºçš„æœ€å¤§å¤§å°æ—¶ï¼Œå°±ä¼šè§¦å‘ Minor GCã€‚æ–°ç”Ÿä»£çš„æœ€å¤§å¤§å°é»˜è®¤ä¸ºæ•´ä¸ªå †å†…å­˜çš„ 60%ï¼Œå¯ä»¥é€šè¿‡å‚æ•° G1MaxNewSizePercent æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 60ã€‚\nG1 åƒåœ¾å›æ”¶å™¨åœ¨è¿›è¡Œæ–°ç”Ÿä»£çš„åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šé‡‡ç”¨å¤åˆ¶ç®—æ³•æ¥å›æ”¶åƒåœ¾ï¼Œä¸ç”¨è€ƒè™‘å¹¶å‘çš„åœºæ™¯ï¼Œå…¨ç¨‹éƒ½æ˜¯ STWï¼Œå®ƒä¼šæ ¹æ®è®¾ç½®çš„åœé¡¿æ—¶é—´ï¼Œå°½å¯èƒ½çš„æœ€å¤§æ•ˆç‡çš„å›æ”¶æ–°ç”Ÿä»£åŒºåŸŸã€‚\n2. å¯¹è±¡ä½•æ—¶è¿›å…¥åˆ°è€å¹´ä»£æ–°ç”Ÿä»£çš„å¯¹è±¡è¦è¿›å…¥è€å¹´ä»£ï¼Œéœ€è¦è¾¾åˆ°ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸­çš„å…¶ä¸­ä¹‹ä¸€å³å¯ã€‚\n\nå¤šæ¬¡èº²è¿‡æ–°ç”Ÿä»£çš„å›æ”¶ï¼Œå¯¹è±¡å¹´é¾„è¾¾åˆ° MaxTenuringThresholdï¼Œè¯¥å‚æ•°é»˜è®¤å€¼ä¸º 15ã€‚ åœ¨æ¯æ¬¡ Minor GC æ—¶ï¼Œæ–°ç”Ÿä»£çš„å¯¹è±¡å¦‚æœå­˜æ´»ï¼Œä¼šè¢«ç§»åŠ¨åˆ° Survivor åŒºä¸­ï¼ŒåŒæ—¶ä¼šå°†å¯¹è±¡çš„å¹´é¾„åŠ  1ï¼Œå½“å¯¹è±¡çš„å¹´é¾„è¾¾åˆ° MaxTenuringThreshold åï¼Œå°±è¢«è¢«ç§»åˆ°è€å¹´ä»£ä¸­ã€‚\nç¬¦åˆåŠ¨æ€å¹´é¾„åˆ¤æ–­è§„åˆ™ã€‚å¦‚æœæŸæ¬¡ Minor GC è¿‡åï¼Œå‘ç° Survivor åŒºä¸­ç›¸åŒå¹´é¾„çš„å¯¹è±¡è¾¾åˆ°äº† Survivor çš„ 50%ï¼Œé‚£ä¹ˆè¯¥å¹´é¾„åŠä»¥ä¸Šçš„å¯¹è±¡ï¼Œä¼šè¢«ç›´æ¥ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚ ä¾‹å¦‚æŸæ¬¡ Minor GC è¿‡åï¼ŒSurvivor åŒºä¸­å­˜åœ¨å¹´é¾„åˆ†åˆ«ä¸º 1ã€2ã€3ã€4 çš„å¯¹è±¡ï¼Œè€Œå¹´é¾„ä¸º 3 çš„å¯¹è±¡è¶…è¿‡äº† Survivor åŒºçš„ 50%ï¼Œé‚£ä¹ˆå¹´é¾„å¤§äºç­‰äº 3 çš„å¯¹è±¡ï¼Œå°±ä¼šè¢«å…¨éƒ¨ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚\n\n3. ä½•æ—¶è§¦å‘ Mixed GCåœ¨ G1 ä¸­ï¼Œä¸å­˜åœ¨å•ç‹¬å›æ”¶è€å¹´ä»£çš„è¡Œä¸ºï¼Œè€Œæ˜¯å½“è¦å‘ç”Ÿè€å¹´ä»£çš„å›æ”¶æ—¶ï¼ŒåŒæ—¶ä¹Ÿä¼šå¯¹æ–°ç”Ÿä»£ä»¥åŠå¤§å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå› æ­¤è¿™ä¸ªé˜¶æ®µç§°ä¹‹ä¸ºæ··åˆå›æ”¶ï¼ˆMixed GCï¼‰ã€‚\nå½“è€å¹´ä»£å¯¹å †å†…å­˜çš„å æ¯”è¾¾åˆ° 45%æ—¶ï¼Œå°±ä¼šè§¦å‘ Mixed GCã€‚å¯ä»¥é€šè¿‡å‚æ•° InitiatingHeapOccupancyPercent æ¥è®¾ç½®å½“å †å†…å­˜è¾¾åˆ°å¤šå°‘æ—¶ï¼Œè§¦å‘ Mixed GCï¼Œè¯¥å‚æ•°çš„é»˜è®¤å€¼ä¸º 45ã€‚\nå½“è§¦å‘ Mixed GC æ—¶ï¼Œä¼šä¾æ¬¡æ‰§è¡Œåˆå§‹æ ‡è®°ï¼ˆåœ¨ Minor GC æ—¶å®Œæˆï¼‰ã€å¹¶å‘æ ‡è®°ã€æœ€ç»ˆæ ‡è®°ã€ç­›é€‰å›æ”¶è¿™å››ä¸ªè¿‡ç¨‹ã€‚æœ€ç»ˆä¼šæ ¹æ®è®¾ç½®çš„æœ€å¤§åœé¡¿æ—¶é—´ï¼Œæ¥è®¡ç®—å¯¹å“ªäº› Region åŒºåŸŸè¿›è¡Œå›æ”¶å¸¦æ¥çš„æ”¶ç›Šæœ€å¤§ã€‚\nå®é™…ä¸Šï¼Œåœ¨ç­›é€‰å›æ”¶é˜¶æ®µï¼Œå¯ä»¥åˆ†å¤šæ¬¡å›æ”¶ Regionï¼Œå…·ä½“å¤šå°‘æ¬¡å¯ä»¥é€šè¿‡å‚æ•° G1MixedGCCountTarget æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 8 æ¬¡ã€‚å…·ä½“ä»€ä¹ˆæ„æ€å‘¢ï¼Ÿ\nå‡å¦‚ç°åœ¨æœ‰ 80 ä¸ª Region éœ€è¦è¢«å›æ”¶ï¼Œå› ä¸ºç­›é€‰å›æ”¶é˜¶æ®µä¼šé€ æˆ STWï¼Œå¦‚æœä¸€ä¸‹å­å…¨éƒ¨å›æ”¶è¿™ 80 ä¸ª Regionï¼Œå¯èƒ½é€ æˆçš„åœé¡¿æ—¶é—´è¾ƒé•¿ï¼Œå› æ­¤ JVM ä¼šåˆ† 8 æ¬¡æ¥å›æ”¶è¿™äº› Regionï¼Œæ¯æ¬¡å…ˆå›æ”¶ 10 ä¸ª Regionï¼Œç„¶åè®©ç”¨æˆ·çº¿ç¨‹æ‰§è¡Œä¸€ä¼šï¼Œæ¥ç€å†è®© GC çº¿ç¨‹å›æ”¶ 10 ä¸ª Regionï¼Œç›´è‡³å›æ”¶å®Œè¿™ 80 ä¸ª Regionï¼Œè¿™æ ·å°½å¯èƒ½çš„é™ä½äº†ç³»ç»Ÿçš„æš‚åœæ—¶é—´ã€‚\nG1 åƒåœ¾å›æ”¶å™¨çš„å›æ”¶æ€è·¯æ˜¯ï¼šä¸éœ€è¦å¯¹æ•´ä¸ªå †è¿›è¡Œå›æ”¶ï¼Œåªéœ€è¦ä¿è¯åƒåœ¾å›æ”¶çš„é€Ÿåº¦å¤§äºå†…å­˜åˆ†é…çš„é€Ÿåº¦å³å¯ã€‚å› æ­¤åœ¨æ¯æ¬¡è¿›è¡Œ Mixed GC æ—¶ï¼Œè™½ç„¶æˆ‘ä»¬è®¾ç½®äº†åœé¡¿æ—¶é—´ï¼Œä½†æ˜¯å½“å›æ”¶å¾—åˆ°çš„ç©ºé—² Region æ•°é‡è¾¾åˆ°äº†æ•´ä¸ªå †å†…å­˜çš„ 5%ï¼Œé‚£ä¹ˆå°±ä¼šåœæ­¢å›æ”¶ã€‚å¯ä»¥ç”±å‚æ•° G1HeapWaterPercent æ§åˆ¶ï¼Œé»˜è®¤å€¼ä¸º 5%ã€‚\nå¦å¤–ï¼Œåœ¨æ··åˆå›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œç”±äºä½¿ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•ï¼Œå› æ­¤å½“ä¸€ä¸ª Region ä¸­å­˜æ´»çš„å¯¹è±¡è¿‡å¤šçš„è¯ï¼Œå¤åˆ¶è¿™ä¸ª Region æ‰€è€—è´¹çš„æ—¶é—´å°±ä¼šè¾ƒå¤šï¼Œå› æ­¤ G1 æä¾›äº†ä¸€ä¸ªå‚æ•°ï¼Œç”¨æ¥æ§åˆ¶å½“å­˜æ´»å¯¹è±¡å å½“å‰ Region çš„æ¯”ä¾‹è¶…è¿‡å¤šå°‘åï¼Œå°±ä¸ä¼šå¯¹è¯¥ Region è¿›è¡Œå›æ”¶ã€‚è¯¥å‚æ•°ä¸º G1MixedGCLiveThresholdPercent ï¼Œé»˜è®¤å€¼ä¸º 85%ã€‚\n4. ä½•æ—¶è§¦å‘ Full GCåœ¨è¿›è¡Œæ··åˆå›æ”¶æ—¶ï¼Œä½¿ç”¨çš„æ˜¯å¤åˆ¶ç®—æ³•ï¼Œå¦‚æœå½“å‘ç°ç©ºé—²çš„ Region å¤§å°æ— æ³•æ”¾å¾—ä¸‹å­˜æ´»å¯¹è±¡çš„å†…å­˜å¤§å°ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ä½¿ç”¨å¤åˆ¶ç®—æ³•å°±ä¼šå¤±è´¥ï¼Œå› æ­¤æ­¤æ—¶ç³»ç»Ÿå°±ä¸å¾—ä¸æš‚åœåº”ç”¨ç¨‹åºï¼Œè¿›è¡Œä¸€æ¬¡ Full GCã€‚è¿›è¡Œ Full GC æ—¶é‡‡ç”¨çš„æ˜¯å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ã€æ¸…ç†å’Œæ•´ç†å†…å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯éå¸¸æ¼«é•¿çš„ï¼Œå› æ­¤åº”è¯¥å°½é‡é¿å… Full GC çš„è§¦å‘ã€‚\näº”ã€G1ä¸CMSçš„æ¯”è¾ƒG1æ”¶é›†å™¨å¸¸ä¼šè¢«æ‹¿æ¥ä¸CMSæ”¶é›†å™¨äº’ç›¸æ¯”è¾ƒï¼Œæ¯•ç«Ÿå®ƒä»¬éƒ½éå¸¸å…³æ³¨åœé¡¿æ—¶é—´çš„æ§åˆ¶ï¼Œå®˜æ–¹èµ„æ–™ä¸­å°†å®ƒä»¬ä¸¤ä¸ªå¹¶ç§°ä¸º â€œThe Mostly Concurrent Collectorsâ€ ã€‚\nåœ¨æœªæ¥ï¼ŒG1 æ”¶é›†å™¨æœ€ç»ˆè¿˜æ˜¯è¦å–ä»£ CMS çš„ï¼Œè€Œå½“ä¸‹å®ƒä»¬ä¸¤è€…å¹¶å­˜çš„æ—¶é—´é‡Œï¼Œåˆ†ä¸ªé«˜ä½ä¼˜åŠ£å°±æ— å¯é¿å…ã€‚\nç›¸æ¯” CMSï¼ŒG1 çš„ä¼˜ç‚¹æœ‰å¾ˆå¤šï¼Œæš‚ä¸”ä¸è®ºå¯ä»¥æŒ‡å®šæœ€å¤§åœé¡¿æ—¶é—´ã€åˆ† Region çš„å†…å­˜å¸ƒå±€ã€æŒ‰æ”¶ç›ŠåŠ¨æ€ç¡®å®šå›æ”¶é›†è¿™äº›åˆ›æ–°æ€§è®¾è®¡å¸¦æ¥çš„çº¢åˆ©ï¼Œå•ä»æœ€ä¼ ç»Ÿçš„ç®—æ³•ç†è®ºä¸Šçœ‹ï¼ŒG1 ä¹Ÿæ›´æœ‰å‘å±•æ½œåŠ›ã€‚\nä¸ CMS çš„ â€œæ ‡è®°-æ¸…é™¤â€ ç®—æ³•ä¸åŒï¼ŒG1 ä»æ•´ä½“æ¥çœ‹æ˜¯åŸºäº â€œæ ‡è®°-æ•´ç†â€ ç®—æ³•å®ç°çš„æ”¶é›†å™¨ï¼Œä½†ä»å±€éƒ¨ï¼ˆä¸¤ä¸ªRegionä¹‹é—´ï¼‰ä¸Šçœ‹åˆæ˜¯åŸºäº â€œæ ‡è®°-å¤åˆ¶â€ ç®—æ³•å®ç°ã€‚\næ— è®ºå¦‚ä½•ï¼Œè¿™ä¸¤ç§ç®—æ³•éƒ½æ„å‘³ç€ G1 è¿ä½œæœŸé—´ä¸ä¼šäº§ç”Ÿå†…å­˜ç©ºé—´ç¢ç‰‡ï¼Œåƒåœ¾æ”¶é›†å®Œæˆä¹‹åèƒ½æä¾›è§„æ•´çš„å¯ç”¨å†…å­˜ã€‚è¿™ç§ç‰¹æ€§æœ‰åˆ©äºç¨‹åºé•¿æ—¶é—´è¿è¡Œï¼Œåœ¨ç¨‹åºä¸ºå¤§å¯¹è±¡åˆ†é…å†…å­˜æ—¶ä¸å®¹æ˜“å› æ— æ³•æ‰¾åˆ°è¿ç»­å†…å­˜ç©ºé—´è€Œæå‰è§¦å‘ä¸‹ä¸€æ¬¡æ”¶é›†ã€‚\nä¸è¿‡ï¼ŒG1 ç›¸å¯¹äº CMS ä»ç„¶ä¸æ˜¯å å…¨æ–¹ä½ã€å‹å€’æ€§ä¼˜åŠ¿çš„ï¼Œä»å®ƒå‡ºç°å‡ å¹´ä»ä¸èƒ½åœ¨æ‰€æœ‰åº”ç”¨åœºæ™¯ä¸­ä»£æ›¿ CMS å°±å¯ä»¥å¾—çŸ¥è¿™ä¸ªç»“è®ºã€‚\næ¯”èµ· CMSï¼ŒG1 çš„å¼±é¡¹ä¹Ÿå¯ä»¥åˆ—ä¸¾å‡ºä¸å°‘ï¼Œå¦‚åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒG1 æ— è®ºæ˜¯ä¸ºäº†åƒåœ¾æ”¶é›†äº§ç”Ÿçš„å†…å­˜å ç”¨ï¼ˆFootprintï¼‰è¿˜æ˜¯ç¨‹åºè¿è¡Œæ—¶çš„é¢å¤–æ‰§è¡Œè´Ÿè½½ï¼ˆOverloadï¼‰éƒ½è¦æ¯” CMS è¦é«˜ã€‚\nå°±å†…å­˜å ç”¨æ¥è¯´ï¼Œè™½ç„¶ G1 å’Œ CMS éƒ½ä½¿ç”¨å¡è¡¨æ¥å¤„ç†è·¨ä»£æŒ‡é’ˆï¼Œä½† G1 çš„å¡è¡¨å®ç°æ›´ä¸ºå¤æ‚ï¼Œè€Œä¸”å †ä¸­æ¯ä¸ª Regionï¼Œæ— è®ºæ‰®æ¼”çš„æ˜¯æ–°ç”Ÿä»£è¿˜æ˜¯è€å¹´ä»£è§’è‰²ï¼Œéƒ½å¿…é¡»æœ‰ä¸€ä»½å¡è¡¨ï¼Œè¿™å¯¼è‡´ G1 çš„è®°å¿†é›†ï¼ˆå’Œå…¶ä»–å†…å­˜æ¶ˆè€—ï¼‰å¯èƒ½ä¼šå æ•´ä¸ªå †å®¹é‡çš„ 20% ä¹ƒè‡³æ›´å¤šçš„å†…å­˜ç©ºé—´ã€‚\nç›¸æ¯”èµ·æ¥ CMS çš„å¡è¡¨å°±ç›¸å½“ç®€å•ï¼Œåªæœ‰å”¯ä¸€ä¸€ä»½ï¼Œè€Œä¸”åªéœ€è¦å¤„ç†è€å¹´ä»£åˆ°æ–°ç”Ÿä»£çš„å¼•ç”¨ï¼Œåè¿‡æ¥åˆ™ä¸éœ€è¦ï¼Œç”±äºæ–°ç”Ÿä»£çš„å¯¹è±¡å…·æœ‰æœç”Ÿå¤•ç­çš„ä¸ç¨³å®šæ€§ï¼Œå¼•ç”¨å˜åŒ–é¢‘ç¹ï¼Œèƒ½çœä¸‹è¿™ä¸ªåŒºåŸŸçš„ç»´æŠ¤å¼€é”€æ˜¯å¾ˆåˆ’ç®—çš„ã€‚\nåœ¨æ‰§è¡Œè´Ÿè½½çš„è§’åº¦ä¸Šï¼ŒåŒæ ·ç”±äºä¸¤ä¸ªæ”¶é›†å™¨å„è‡ªçš„ç»†èŠ‚å®ç°ç‰¹ç‚¹å¯¼è‡´äº†ç”¨æˆ·ç¨‹åºè¿è¡Œæ—¶çš„è´Ÿè½½ä¼šæœ‰ä¸åŒï¼Œè­¬å¦‚å®ƒä»¬éƒ½ä½¿ç”¨åˆ°å†™å±éšœï¼ŒCMS ç”¨å†™åå±éšœæ¥æ›´æ–°ç»´æŠ¤å¡è¡¨ã€‚\nè€Œ G1 é™¤äº†ä½¿ç”¨å†™åå±éšœæ¥è¿›è¡ŒåŒæ ·çš„ï¼ˆç”±äº G1 çš„å¡è¡¨ç»“æ„å¤æ‚ï¼Œå…¶å®æ˜¯æ›´çƒ¦ççš„ï¼‰å¡è¡¨ç»´æŠ¤æ“ä½œå¤–ï¼Œä¸ºäº†å®ç°åŸå§‹å¿«ç…§æœç´¢ï¼ˆSATBï¼‰ç®—æ³•ï¼Œè¿˜éœ€è¦ä½¿ç”¨å†™å‰å±éšœæ¥è·Ÿè¸ªå¹¶å‘æ—¶çš„æŒ‡é’ˆå˜åŒ–æƒ…å†µã€‚\nç›¸æ¯”èµ·å¢é‡æ›´æ–°ç®—æ³•ï¼ŒåŸå§‹å¿«ç…§æœç´¢èƒ½å¤Ÿå‡å°‘å¹¶å‘æ ‡è®°å’Œé‡æ–°æ ‡è®°é˜¶æ®µçš„æ¶ˆè€—ï¼Œé¿å… CMS é‚£æ ·åœ¨æœ€ç»ˆæ ‡è®°é˜¶æ®µåœé¡¿æ—¶é—´è¿‡é•¿çš„ç¼ºç‚¹ï¼Œä½†æ˜¯åœ¨ç”¨æˆ·ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ç¡®å®ä¼šäº§ç”Ÿç”±è·Ÿè¸ªå¼•ç”¨å˜åŒ–å¸¦æ¥çš„é¢å¤–è´Ÿæ‹…ã€‚\nç”±äº G1 å¯¹å†™å±éšœçš„å¤æ‚æ“ä½œè¦æ¯” CMS æ¶ˆè€—æ›´å¤šçš„è¿ç®—èµ„æºï¼Œæ‰€ä»¥ CMS çš„å†™å±éšœå®ç°æ˜¯ç›´æ¥çš„åŒæ­¥æ“ä½œï¼Œè€Œ G1 å°±ä¸å¾—ä¸å°†å…¶å®ç°ä¸ºç±»ä¼¼äºæ¶ˆæ¯é˜Ÿåˆ—çš„ç»“æ„ï¼ŒæŠŠå†™å‰å±éšœå’Œå†™åå±éšœä¸­è¦åšçš„äº‹æƒ…éƒ½æ”¾åˆ°é˜Ÿåˆ—é‡Œï¼Œç„¶åå†å¼‚æ­¥å¤„ç†ã€‚\nä»¥ä¸Šçš„ä¼˜ç¼ºç‚¹å¯¹æ¯”ä»…ä»…æ˜¯é’ˆå¯¹ G1 å’Œ CMS ä¸¤æ¬¾åƒåœ¾æ”¶é›†å™¨å•ç‹¬æŸæ–¹é¢çš„å®ç°ç»†èŠ‚çš„å®šæ€§åˆ†æï¼Œé€šå¸¸æˆ‘ä»¬è¯´å“ªæ¬¾æ”¶é›†å™¨è¦æ›´å¥½ã€è¦å¥½ä¸Šå¤šå°‘ï¼Œå¾€å¾€æ˜¯é’ˆå¯¹å…·ä½“åœºæ™¯æ‰èƒ½åšçš„å®šé‡æ¯”è¾ƒã€‚\næŒ‰ç…§ç¬”è€…çš„å®è·µç»éªŒï¼Œç›®å‰åœ¨å°å†…å­˜åº”ç”¨ä¸Š CMS çš„è¡¨ç°å¤§æ¦‚ç‡ä»ç„¶è¦ä¼šä¼˜äº G1ï¼Œè€Œåœ¨å¤§å†…å­˜åº”ç”¨ä¸Š G1 åˆ™å¤§å¤šèƒ½å‘æŒ¥å…¶ä¼˜åŠ¿ï¼Œè¿™ä¸ªä¼˜åŠ£åŠ¿çš„ Java å †å®¹é‡å¹³è¡¡ç‚¹é€šå¸¸åœ¨ 6GB è‡³ 8GB ä¹‹é—´ï¼Œå½“ç„¶ï¼Œä»¥ä¸Šè¿™äº›ä¹Ÿä»…æ˜¯ç»éªŒä¹‹è°ˆï¼Œä¸åŒåº”ç”¨éœ€è¦é‡ä½“è£è¡£åœ°å®é™…æµ‹è¯•æ‰èƒ½å¾—å‡ºæœ€åˆé€‚çš„ç»“è®ºï¼Œéšç€HotSpotçš„å¼€å‘è€…å¯¹ G1 çš„ä¸æ–­ä¼˜åŒ–ï¼Œä¹Ÿä¼šè®©å¯¹æ¯”ç»“æœç»§ç»­å‘ G1 å€¾æ–œã€‚\nå…­ã€G1 GC ç›¸å…³å‚æ•°\n\n\nå‚æ•°\nå«ä¹‰\n\n\n\n-XX:G1HeapRegionSize=n\nè®¾ç½®Regionå¤§å°ï¼Œå¹¶éæœ€ç»ˆå€¼\n\n\n-XX:MaxGCPauseMillis\nè®¾ç½®G1æ”¶é›†è¿‡ç¨‹ç›®æ ‡æ—¶é—´ï¼Œé»˜è®¤å€¼200msï¼Œä¸æ˜¯ç¡¬æ€§æ¡ä»¶\n\n\n-XX:G1NewSizePercent\næ–°ç”Ÿä»£æœ€å°å€¼ï¼Œé»˜è®¤å€¼5%\n\n\n-XX:G1MaxNewSizePercent\næ–°ç”Ÿä»£æœ€å¤§å€¼ï¼Œé»˜è®¤å€¼60%\n\n\n-XX:ParallelGCThreads\nSTWæœŸé—´ï¼Œå¹¶è¡ŒGCçº¿ç¨‹æ•°\n\n\n-XX:ConcGCThreads=n\nå¹¶å‘æ ‡è®°é˜¶æ®µï¼Œå¹¶è¡Œæ‰§è¡Œçš„çº¿ç¨‹æ•°\n\n\n-XX:InitiatingHeapOccupancyPercent\nè®¾ç½®è§¦å‘æ ‡è®°å‘¨æœŸçš„ Java å †å ç”¨ç‡é˜ˆå€¼ã€‚é»˜è®¤å€¼æ˜¯45%ã€‚è¿™é‡Œçš„javaå †å æ¯”æŒ‡çš„æ˜¯non_young_capacity_bytesï¼ŒåŒ…æ‹¬old+humongous\n\n\n","categories":["Java","JVM"],"tags":["æ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰"]},{"title":"Java å†…å­˜æ¨¡å‹","url":"/posts/1904/","content":"ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ›¾è¯•å›¾å®šä¹‰ä¸€ç§ â€œJavaå†…å­˜æ¨¡å‹â€ï¼ˆJava Memory Modelï¼ŒJMMï¼‰æ¥ å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œä»¥å®ç°è®©Javaç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœã€‚\nå®šä¹‰Javaå†…å­˜æ¨¡å‹å¹¶éä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œè¿™ä¸ªæ¨¡å‹å¿…é¡»å®šä¹‰å¾—è¶³å¤Ÿä¸¥è°¨ï¼Œæ‰èƒ½è®©Javaçš„å¹¶å‘è®¿é—®æ“ä½œä¸ä¼šäº§ç”Ÿæ­§ä¹‰ã€‚\nä½†æ˜¯ä¹Ÿå¿…é¡»å®šä¹‰å¾—è¶³å¤Ÿå®½æ¾ï¼Œæ˜¯çš„è™šæ‹Ÿæœºçš„å®ç°èƒ½æœ‰è¶³å¤Ÿçš„è‡ªç”±ç©ºé—´å»åˆ©ç”¨ç¡¬ä»¶çš„å„ç§ç‰¹æ€§ï¼ˆå¯„å­˜å™¨ã€é«˜é€Ÿç¼“å­˜å’ŒæŒ‡ä»¤é›†ä¸­æŸäº›ç‰¹æœ‰çš„æŒ‡ä»¤ï¼‰æ¥è·å–æ›´å¥½æ‰§è¡Œé€Ÿåº¦ã€‚\nJavaå†…å­˜æ¨¡å‹åœ¨ JDK1.2 ä¹‹åå»ºç«‹èµ·æ¥ï¼Œç›´åˆ° JDK5 ï¼ˆJSR-133ï¼‰å‘å¸ƒåï¼ŒJavaå†…å­˜æ¨¡å‹æ‰ç»ˆäºæˆç†Ÿã€å®Œå–„èµ·æ¥ã€‚\n\nåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„ç¬¬2ç‰ˆåŠä¹‹å‰ï¼Œä¸“é—¨æœ‰ä¸€ç«  â€œThreads and Locksâ€ æ¥æè¿°å†…å­˜æ¨¡å‹ï¼Œåæ¥ç”±äºè¿™éƒ¨åˆ†å†…å®¹éš¾ä»¥æŠŠæ¡å®½ç´§é™åº¦ï¼Œè¢«åå¤ä¿®æ­£æ›´æ–°ï¼Œä»ç¬¬3ç‰ˆï¼ˆJava SE 7ç‰ˆï¼‰å¼€å§‹ç´¢æ€§å°±è¢«ç§»é™¤å‡ºè§„èŒƒï¼Œç‹¬ç«‹ä»¥ JSR å½¢å¼ç»´æŠ¤ã€‚\n\n1. Javaå†…å­˜æ¨¡å‹ä½œç”¨Java å†…å­˜æ¨¡å‹çš„ä¸»è¦ç›®çš„æ˜¯å®šä¹‰ç¨‹åºä¸­å„ç§ å˜é‡ çš„è®¿é—®è§„åˆ™ï¼Œå³å…³æ³¨ åœ¨è™šæ‹Ÿæœºä¸­æŠŠå˜é‡å€¼å­˜å‚¨åˆ°å†…å­˜å’Œä»å†…å­˜ä¸­å–å‡ºå˜é‡å€¼è¿™æ ·çš„åº•å±‚ç»†èŠ‚ã€‚\næ­¤å¤„çš„å˜é‡ä¸ Java ç¼–ç¨‹ä¸­æ‰€è¯´çš„å˜é‡æœ‰æ‰€åŒºåˆ«ï¼Œå®ƒåŒ…æ‹¬äº†ï¼š\n\nå®ä¾‹å­—æ®µ\né™æ€å­—æ®µ\næ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ \n\nä½†æ˜¯ä¸åŒ…æ‹¬ å±€éƒ¨å˜é‡ ä¸ æ–¹æ³•å‚æ•°ï¼Œå› ä¸ºåè€… æ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œä¸ä¼šè¢«å…±äº«ï¼Œè‡ªç„¶ä¸å­˜åœ¨ç«äº‰é—®é¢˜ã€‚\n\nå¦‚æœå±€éƒ¨å˜é‡æ˜¯ä¸€ä¸ª reference ç±»å‹ï¼Œå®ƒå¼•ç”¨çš„å¯¹è±¡åœ¨Javaå †ä¸­å¯è¢«å„ä¸ªçº¿ç¨‹å…±äº«ï¼Œä½†æ˜¯ reference æœ¬èº«åœ¨Javaæ ˆçš„å±€éƒ¨å˜é‡è¡¨ä¸­æ˜¯çº¿ç¨‹ç§æœ‰çš„ã€‚\n\nä¸ºäº†è·å¾—æ›´å¥½çš„æ‰§è¡Œæ•ˆèƒ½ï¼ŒJavaå†…å­˜æ¨¡å‹ å¹¶æ²¡æœ‰é™åˆ¶æ‰§è¡Œå¼•æ“ä½¿ç”¨å¤„ç†å™¨çš„ç‰¹å®šå¯„å­˜å™¨æˆ–ç¼“å­˜æ¥å’Œä¸»å†…å­˜äº¤äº’ï¼Œ ä¹Ÿæ²¡æœ‰é™åˆ¶å³æ—¶ç¼–è¯‘å™¨æ˜¯å¦è¦è¿›è¡Œè°ƒæ•´ä»£ç æ‰§è¡Œé¡ºåºè¿™ç±»ä¼˜åŒ–æªæ–½ã€‚\n2. ä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ ä¸Javaå†…å­˜åŒºåŸŸçš„ Javaå †ã€æ ˆã€æ–¹æ³•åŒº ç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å¯¹å†…å­˜çš„åˆ’åˆ†ï¼Œè¿™ä¸¤è€…åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰ä»»ä½•å…³ç³»çš„ã€‚\nå¦‚æœä¸¤è€…ä¸€å®šè¦å‹‰å¼ºå¯¹åº”èµ·æ¥ï¼Œé‚£ä¹ˆä»å˜é‡ã€ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜çš„å®šä¹‰æ¥çœ‹ï¼Œ\nä¸»å†…å­˜ä¸»è¦å¯¹åº”äºJavaå †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†\n\nä¹‹æ‰€ä»¥è¯´å¯¹åº”çš„æ˜¯Javaå †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®ï¼Œæ˜¯å› ä¸ºï¼š\né™¤äº†å®ä¾‹æ•°æ®ï¼ŒJavaå †è¿˜ä¿å­˜äº†å¯¹è±¡çš„å…¶ä»–ä¿¡æ¯ï¼Œå¯¹äº HotSpot è™šæ‹Ÿæœºæ¥è®²ï¼Œæœ‰ Mark wordï¼ˆå­˜å‚¨å¯¹è±¡å“ˆå¸Œç ã€GCæ ‡å¿—ã€GCå¹´é¾„ã€åŒæ­¥é”ç­‰ä¿¡æ¯ï¼‰ã€Klass Pointï¼ˆæŒ‡å‘å­˜å‚¨ç±»å‹å…ƒæ•°æ®çš„æŒ‡é’ˆï¼‰åŠä¸€äº›ç”¨äºå­—èŠ‚ç å¯¹é½è¡¥ç™½çš„å¡«å……æ•°æ®ï¼ˆå¦‚æœå®ä¾‹æ•°æ®åˆšå¥½æ»¡è¶³ 8 å­—èŠ‚å¯¹é½ï¼Œåˆ™å¯ä»¥ä¸è¡¥ç™½ï¼‰ã€‚\n\nå·¥ä½œå†…å­˜å¯¹åº”äºè™šæ‹Ÿæœºæ ˆçš„éƒ¨åˆ†åŒºåŸŸ\nä»æ›´åŸºç¡€çš„å±‚æ¬¡ä¸Šè¯´ï¼Œä¸»å†…å­˜ç›´æ¥å¯¹åº”äºç‰©ç†ç¡¬ä»¶çš„å†…å­˜ï¼Œè€Œä¸ºäº†æ›´å¥½çš„è¿è¡Œé€Ÿåº¦ï¼Œè™šæ‹Ÿæœºï¼ˆæˆ–è€…æ˜¯ç¡¬ä»¶ã€æ“ä½œç³»ç»Ÿæœ¬èº«çš„ä¼˜åŒ–æªæ–½ï¼‰å¯èƒ½ä¼šè®©å·¥ä½œå†…å­˜ä¼˜å…ˆå­˜å‚¨äºå¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜ä¸­ï¼Œå› ä¸ºç¨‹åºè¿è¡Œæ—¶ä¸»è¦è®¿é—®çš„æ˜¯å·¥ä½œå†…å­˜ã€‚\n2.1 ä¸»å†…å­˜Java å†…å­˜æ¨¡å‹è§„å®šäº†æ‰€æœ‰çš„å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å†…å­˜ã€‚\n\næ­¤å¤„çš„ä¸»å†…å­˜ä¸ç‰©ç†ç¡¬ä»¶çš„ä¸»å†…å­˜åå­—ä¸€æ ·ï¼Œä¸¤è€…ä¹Ÿå¯ä»¥ç±»æ¯”ï¼Œä½† ç‰©ç†ä¸Šå®ƒä»…æ˜¯è™šæ‹Ÿæœºå†…å­˜çš„ä¸€éƒ¨åˆ†ã€‚\n\n2.2 å·¥ä½œå†…å­˜æ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ã€‚\nï¼ˆ1ï¼‰çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ä¿å­˜äº†è¢«è¯¥çº¿ç¨‹ä½¿ç”¨çš„å˜é‡çš„ä¸»å†…å­˜å‰¯æœ¬ã€‚\n\nå‡å¦‚çº¿ç¨‹ä¸­è®¿é—®ä¸€ä¸ª 10MB å¤§å°çš„å¯¹è±¡ï¼Œä¹Ÿä¼šæŠŠè¿™ 10MB çš„å†…å­˜å¤åˆ¶ä¸€ä»½å‡ºæ¥å—ï¼Ÿ\näº‹å®ä¸Šå¹¶ä¸ä¼šå¦‚æ­¤ï¼Œè¿™ä¸ªå¯¹è±¡çš„å¼•ç”¨ã€å¯¹è±¡ä¸­æŸä¸ªåœ¨çº¿ç¨‹è®¿é—®åˆ°çš„å­—æ®µæ˜¯æœ‰å¯èƒ½è¢«å¤åˆ¶çš„ï¼Œä½†ä¸ä¼šæœ‰è™šæ‹ŸæœºæŠŠæ•´ä¸ªå¯¹è±¡å¤åˆ¶ä¸€æ¬¡ã€‚\n\nï¼ˆ2ï¼‰çº¿ç¨‹å¯¹å˜é‡çš„æ‰€æœ‰æ“ä½œï¼ˆè¯»å–ã€èµ‹å€¼ç­‰ï¼‰éƒ½å¿…é¡»åœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œè€Œä¸èƒ½ç›´æ¥è¯»å–ä¸»å†…å­˜ä¸­çš„æ•°æ®ã€‚\n\næ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œvolatile å˜é‡ä¾ç„¶æœ‰å·¥ä½œå†…å­˜çš„æ‹·è´ï¼Œä½†æ˜¯ç”±äºå®ƒç‰¹æ®Šçš„æ“ä½œé¡ºåºæ€§è§„å®šï¼Œæ‰€ä»¥çœ‹èµ·æ¥å¦‚åŒç›´æ¥åœ¨ä¸»å†…å­˜ä¸­è¯»å†™è®¿é—®ä¸€èˆ¬ï¼Œå› æ­¤è¿™é‡Œçš„æè¿°å¯¹äº volatile ä¹Ÿå¹¶ä¸å­˜åœ¨ä¾‹å¤–ã€‚\n\nï¼ˆ3ï¼‰ä¸åŒçš„çº¿ç¨‹ä¹‹é—´æ— æ³•ç›´æ¥è®¿é—®å¯¹æ–¹å·¥ä½œå†…å­˜ä¸­çš„å˜é‡ã€‚\nï¼ˆ4ï¼‰çº¿ç¨‹é—´å˜é‡å€¼çš„ä¼ é€’å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚\n\n3. å†…å­˜é—´äº¤äº’æ“ä½œ3.1 å…«ç§åŸºæœ¬æ“ä½œå…³äºä¸»å†…å­˜ä¸å·¥ä½œå†…å­˜ä¹‹é—´å…·ä½“çš„äº¤äº’åè®®ï¼Œå³ä¸€ä¸ªå˜é‡å¦‚ä½•ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ã€å¦‚ä½•ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜è¿™ä¸€ç±»çš„å®ç°ç»†èŠ‚ï¼ŒJava å†…å­˜æ¨¡å‹ ä¸­å®šä¹‰äº†ä»¥ä¸‹ 8 ç§æ“ä½œæ¥å®Œæˆã€‚\n\nJava è™šæ‹Ÿæœºå®ç°æ—¶å¿…é¡»ä¿è¯ä¸‹é¢æåˆ°çš„æ¯ä¸€ç§æ“ä½œéƒ½æ˜¯åŸå­çš„ã€ä¸å¯å†åˆ†çš„ã€‚\nå¯¹äº double å’Œ long ç±»å‹çš„å˜é‡æ¥è¯´ï¼Œloadã€storeã€read å’Œ write æ“ä½œåœ¨æŸäº›å¹³å°ä¸Šå…è®¸æœ‰ä¾‹å¤–ã€‚\n\n\nlockï¼ˆé”å®šï¼‰ï¼š ä½œç”¨äº ä¸»å†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çš„çŠ¶æ€ã€‚\nunlockï¼ˆè§£é”ï¼‰ï¼š ä½œç”¨äº ä¸»å†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚\nreadï¼ˆè¯»å–ï¼‰ï¼š ä½œç”¨äº ä¸»å†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ load åŠ¨ä½œä½¿ç”¨ã€‚\nloadï¼ˆè½½å…¥ï¼‰ï¼šä½œç”¨äº å·¥ä½œå†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠ read æ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚\nuseï¼ˆä½¿ç”¨ï¼‰ï¼šä½œç”¨äº å·¥ä½œå†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶ï¼Œå°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚\nassignï¼ˆèµ‹å€¼ï¼‰ï¼šä½œç”¨äº å·¥ä½œå†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚\nstoreï¼ˆå­˜å‚¨ï¼‰ï¼šä½œç”¨äº å·¥ä½œå†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„ write æ“ä½œä½¿ç”¨ã€‚\nwriteï¼ˆå†™å…¥ï¼‰ï¼šä½œç”¨äº ä¸»å†…å­˜ çš„å˜é‡ï¼Œå®ƒæŠŠ store æ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚\n\nå¦‚æœè¦æŠŠä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜æ‹·è´åˆ°å·¥ä½œå†…å­˜ï¼Œé‚£å°±è¦æŒ‰é¡ºåºæ‰§è¡Œ read å’Œ load æ“ä½œï¼Œ\nå¦‚æœè¦æŠŠå˜é‡ä»å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ï¼Œå°±è¦æŒ‰é¡ºåºä¸­ store å’Œ write æ“ä½œã€‚\næ³¨æ„ï¼š\n\nJava å†…å­˜æ¨¡å‹åªè¦æ±‚ä¸Šè¿°ä¸¤ä¸ªæ“ä½œå¿…é¡»æŒ‰é¡ºåºæ‰§è¡Œï¼Œä½†ä¸è¦æ±‚è¿ç»­æ‰§è¡Œã€‚\nä¹Ÿå°±æ˜¯è¯´ read å’Œ load ä¹‹é—´ã€store ä¸ write ä¹‹é—´æ˜¯å¯ä»¥æ’å…¥å…¶ä»–æŒ‡ä»¤çš„ã€‚\nå¦‚æœå¯¹ä¸»å†…å­˜ä¸­çš„å˜é‡aã€bè¿›è¡Œè®¿é—®æ—¶ï¼Œä¸€ç§å¯èƒ½å‡ºç°çš„é¡ºåºæ˜¯ read aã€read bã€load bã€load aã€‚\n\n3.2 å…«ç§æ“ä½œå¿…é¡»æ»¡è¶³çš„è§„åˆ™\nä¸å…è®¸ read å’Œ load ã€store å’Œ write æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå³ä¸å…è®¸ä¸€ä¸ªå˜é‡ä»ä¸»å†…å­˜è¯»å–äº†ä½†å·¥ä½œå†…å­˜ä¸æ¥å—ï¼Œæˆ–è€…å·¥ä½œå†…å­˜å‘èµ·äº†å›å†™ä½†ä¸»å†…å­˜ä¸æ¥å—çš„æƒ…å†µã€‚\nä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒå®ƒæœ€è¿‘çš„ assign æ“ä½œï¼Œå³å˜é‡åœ¨å·¥ä½œå†…å­˜ä¸­æ”¹å˜äº†ä¹‹åå¿…é¡»æŠŠè¯¥å˜åŒ–åŒæ­¥å›ä¸»å†…å­˜ã€‚\nä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»çº¿ç¨‹çš„å·¥ä½œå†…å­˜åŒæ­¥å›ä¸»å†…å­˜ä¸­ã€‚\nä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­ â€œè¯ç”Ÿâ€ï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆload æˆ– assignï¼‰çš„å˜é‡ï¼Œæ¢å¥è¯è¯´å°±æ˜¯å¯¹ä¸€ä¸ªå˜é‡å®æ–½ useã€store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œ assign å’Œ load æ“ä½œã€‚\nä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€æ¡çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ã€‚\nå¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œé‚£å°†ä¼šæ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡å‰ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œ load æˆ– assign æ“ä½œä»¥åˆå§‹åŒ–å˜é‡çš„å€¼ã€‚\nå¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œé‚£å°±ä¸å…è®¸å¯¹å®ƒæ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡ã€‚\nå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ï¼ˆæ‰§è¡Œ store ã€write æ“ä½œï¼‰ã€‚\n\n3.3 å°ç»“è¿™ 8 ç§å†…å­˜è®¿é—®æ“ä½œä»¥åŠä¸Šè¿°è§„åˆ™é™å®šï¼Œå†åŠ ä¸Š volatile çš„ä¸€äº›ç‰¹æ®Šè§„å®šï¼Œå°±å·²ç»èƒ½å¤Ÿå‡†ç¡®åœ°æè¿°å‡º Java ç¨‹åºä¸­å“ªäº›å†…å­˜è®¿é—®æ“ä½œåœ¨å¹¶å‘ä¸‹æ‰æ˜¯å®‰å…¨çš„ã€‚\nè¿™ç§å®šä¹‰ç›¸å½“ä¸¥è°¨ï¼Œä½†ä¹Ÿæ˜¯æä¸ºçƒ¦çï¼Œåæ¥ Java è®¾è®¡å›¢é˜Ÿå°† Java å†…å­˜æ¨¡å‹çš„æ“ä½œç®€åŒ–ä¸º readã€writeã€lock å’Œ unlock å››ç§ï¼Œä½† è¿™åªæ˜¯è¯­è¨€æè¿°ä¸Šçš„ç­‰ä»·åŒ–ç®€ï¼ŒJava å†…å­˜æ¨¡å‹çš„åŸºç¡€è®¾è®¡å¹¶æœªæ”¹å˜ã€‚\n4. volatile å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™å…³é”®å­— volatile å¯ä»¥è¯´æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„ æœ€è½»é‡çº§çš„åŒæ­¥æœºåˆ¶ã€‚\n4.1 volatile ä¿®é¥°çš„å˜é‡ä¸¤ä¸ªç‰¹æ€§ï¼ˆ1ï¼‰ä¿è¯æ­¤å˜é‡å¯¹æ‰€æœ‰çº¿ç¨‹çš„å¯è§æ€§è¿™é‡Œçš„ â€œå¯è§æ€§â€ æ˜¯æŒ‡ å½“ä¸€æ¡çº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œæ–°å€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯å¯ä»¥ç«‹å³å¾—çŸ¥çš„ã€‚\nè€Œ æ™®é€šå˜é‡å¹¶ä¸èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼Œæ™®é€šå˜é‡çš„å€¼åœ¨çº¿ç¨‹é—´ä¼ é€’æ—¶å‡éœ€è¦é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆã€‚\nvolatile å˜é‡åœ¨å„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­æ˜¯ä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜çš„ã€‚\n\nä»ç‰©ç†å­˜å‚¨çš„è§’åº¦çœ‹ï¼Œå„ä¸ªçº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ volatile å˜é‡ä¹Ÿå¯ä»¥å­˜åœ¨ä¸ä¸€è‡´çš„æƒ…å†µï¼Œä½†ç”±äºæ¯æ¬¡ä½¿ç”¨ä¹‹å‰éƒ½è¦å…ˆåˆ·æ–°ï¼Œæ‰§è¡Œå¼•æ“çœ‹ä¸åˆ°ä¸ä¸€è‡´çš„æƒ…å†µï¼Œå› æ­¤å¯ä»¥è®¤ä¸ºä¸å­˜åœ¨ä¸€è‡´æ€§é—®é¢˜ï¼‰\n\nä½†æ˜¯ Java é‡Œé¢çš„è¿ç®—æ“ä½œç¬¦å¹¶éåŸå­æ“ä½œï¼Œè¿™å¯¼è‡´ volatile å˜é‡çš„è¿ç®—åœ¨å¹¶å‘ä¸‹ä¸€æ ·æ˜¯ä¸å®‰å…¨çš„ã€‚\nåº”ç”¨åœºæ™¯ç”±äº volatile å˜é‡åªèƒ½ä¿è¯å¯è§æ€§ï¼Œåœ¨ä¸ç¬¦åˆä»¥ä¸‹ä¸¤æ¡è§„åˆ™çš„è¿ç®—åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬ä»è¦é€šè¿‡åŠ é”æ¥ä¿è¯åŸå­æ€§ï¼š\n\nè¿ç®—ç»“æœå¹¶ä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½å¤Ÿä¿è¯åªæœ‰å•ä¸€çš„çº¿ç¨‹ä¿®æ”¹å˜é‡çš„å€¼ã€‚\nå˜é‡ä¸éœ€è¦ä¸å…¶ä»–çš„çŠ¶æ€å˜é‡å…±åŒå‚ä¸ä¸å˜çº¦æŸã€‚\n\nï¼ˆ2ï¼‰ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–æ™®é€šçš„å˜é‡ä»…ä¼šä¿è¯åœ¨è¯¥æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰ä¾èµ–èµ‹å€¼ç»“æœçš„åœ°æ–¹éƒ½èƒ½è·å–åˆ°æ­£ç¡®çš„ç»“æœï¼Œè€Œ ä¸èƒ½ä¿è¯å˜é‡èµ‹å€¼æ“ä½œçš„é¡ºåºä¸ç¨‹åºä¸­çš„æ‰§è¡Œé¡ºåºä¸€è‡´ã€‚\nè¿™å°±æ˜¯ Java å†…å­˜æ¨¡å‹ä¸­æè¿°çš„æ‰€è°“ â€œçº¿ç¨‹å†…è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰â€œã€‚\nå¦‚ä½•å®ç°åœ¨æ±‡ç¼–ä»£ç ä¸­ï¼Œè¢« volatile ä¿®é¥°çš„å˜é‡ï¼Œåœ¨èµ‹å€¼åï¼Œå¤šæ‰§è¡Œäº†ä¸€ä¸ª â€œlock add1 $0x0,(%sep)â€ æ“ä½œã€‚\nè¿™ä¸ªæ“ä½œçš„ä½œç”¨ç›¸å½“äºä¸€ä¸ªå†…å­˜å±éšœï¼Œåªæœ‰ä¸€ä¸ªå¤„ç†å™¨è®¿é—®å†…å­˜æ—¶ï¼Œå¹¶ä¸éœ€è¦å†…å­˜å±éšœã€‚\nä½†å¦‚æœæœ‰ä¸¤ä¸ªæˆ–æ›´å¤šå¤„ç†å™¨è®¿é—®åŒä¸€å—å†…å­˜ï¼Œä¸”å…¶ä¸­æœ‰ä¸€ä¸ªåœ¨è§‚æµ‹å¦ä¸€ä¸ªï¼Œå°±éœ€è¦å†…å­˜å±éšœæ¥ä¿è¯ä¸€è‡´æ€§äº†ã€‚\nè¿™å¥æŒ‡ä»¤ä¸­çš„ â€œadd1 $0x0,(%sep)â€ ï¼ˆæŠŠ ESP å¯„å­˜å™¨çš„å€¼åŠ 0ï¼‰æ˜¾ç„¶æ˜¯ä¸€ä¸ªç©ºæ“ä½œï¼Œä¹‹æ‰€ä»¥ç”¨è¿™ä¸ªç©ºæ“ä½œè€Œä¸æ˜¯ç©ºæ“ä½œä¸“ç”¨æŒ‡ä»¤ nop ï¼Œæ˜¯å› ä¸º IA32 æ‰‹å†Œè§„å®š lock å‰ç¼€ä¸å…è®¸é…åˆ nop æŒ‡ä»¤ä½¿ç”¨ã€‚\nè¿™é‡Œçš„ lock å‰ç¼€ï¼Œä½œç”¨æ˜¯ å°†æœ¬å¤„ç†å™¨çš„ç¼“å­˜å†™å…¥äº†å†…å­˜ï¼Œè¯¥å†™å…¥åŠ¨ä½œä¹Ÿä¼šå¼•èµ·åˆ«çš„å¤„ç†å™¨æˆ–è€…åˆ«çš„å†…æ ¸æ— æ•ˆåŒ–å…¶ç¼“å­˜ã€‚\nè¿™ç§æ“ä½œç›¸å½“äºå¯¹ç¼“å­˜ä¸­çš„å˜é‡åšäº†ä¸€æ¬¡å‰é¢ä»‹ç»Javaå†…å­˜æ¨¡å‹ä¸­çš„ â€œstore å’Œ write æ“ä½œã€‚\næ‰€ä»¥é€šè¿‡è¿™æ ·ä¸€ä¸ªç©ºæ“ä½œï¼Œå¯è®©å‰é¢ volatile å˜é‡çš„ä¿®æ”¹å¯¹å…¶ä»–å¤„ç†å™¨ç«‹å³å¯è§ã€‚\n\nä»ç¡¬ä»¶ æ¶æ„ä¸Šè®²ï¼ŒæŒ‡ä»¤é‡æ’åºæ˜¯æŒ‡å¤„ç†å™¨é‡‡ç”¨äº†å…è®¸å°†å¤šæ¡æŒ‡ä»¤ä¸æŒ‰ç¨‹åºè§„å®šçš„é¡ºåºåˆ†å¼€å‘é€ç»™å„ä¸ªç›¸åº”çš„ç”µè·¯å•å…ƒè¿›è¡Œå¤„ç†ã€‚\n\n4.2 å°ç»“è§„åˆ™æ€»ç»“\nåœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨ volatile å˜é‡å‰éƒ½å¿…é¡»ä»ä¸»å†…å­˜åˆ·æ–°æœ€æ–°çš„å€¼ï¼Œç”¨äºä¿è¯èƒ½çœ‹è§å…¶ä»–çº¿ç¨‹å¯¹å˜é‡æ‰€åšçš„ä¿®æ”¹ã€‚\nåœ¨å·¥ä½œå†…å­˜ä¸­ï¼Œæ¯æ¬¡ä¿®æ”¹ä½¿ç”¨ volatile çš„å˜é‡åéƒ½å¿…é¡»ç«‹åˆ»åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼Œç”¨äºä¿è¯å…¶ä»–çº¿ç¨‹å¯ä»¥çœ‹è§è‡ªå·±å¯¹å˜é‡åšçš„ä¿®æ”¹ã€‚\nvolatile ä¿®é¥°çš„å˜é‡ä¸ä¼šè¢«æŒ‡ä»¤é‡æ’åºä¼˜åŒ–ï¼Œä»è€Œä¿è¯ä»£ç çš„æ‰§è¡Œé¡ºåºä¸ç¨‹åºçš„é¡ºåºç›¸åŒã€‚\n\næ€§èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œvolatile çš„åŒæ­¥æœºåˆ¶çš„æ€§èƒ½ç¡®å®è¦ä¼˜äºé”ï¼ˆä½¿ç”¨ synchronized å…³é”®å­—æˆ– java.util.concurrent åŒ…é‡Œçš„é”ï¼‰ï¼Œä½†æ˜¯ç”±äºè™šæ‹Ÿæœºå¯¹é”å®è¡Œçš„è®¸å¤šæ¶ˆé™¤å’Œä¼˜åŒ–ï¼Œä½¿å¾—æˆ‘ä»¬å¾ˆéš¾ç¡®åˆ‡åœ°è¯´ volatile å°±ä¼šæ¯” synchronized å¿«ä¸Šå¤šå°‘ã€‚\nvolatile  å˜é‡è¯»æ“ä½œçš„æ€§èƒ½æ¶ˆè€—ä¸æ™®é€šå˜é‡å‡ ä¹æ²¡æœ‰ä»€ä¹ˆå·®åˆ«ï¼Œä½†æ˜¯å†™æ“ä½œåˆ™å¯èƒ½ä¼šæ…¢ä¸Šä¸€äº›ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥è®¸å¤šå†…å­˜å±éšœæŒ‡ä»¤æ¥ä¿è¯å¤„ç†å™¨ä¸å‘ç”Ÿä¹±åºæ‰§è¡Œï¼Œä¸è¿‡å³ä¾¿å¦‚æ­¤ï¼Œå¤§å¤šæ•°åœºæ™¯ä¸‹ volatile çš„æ€»å¼€é”€ä»ç„¶è¦æ¯”é”æ¥çš„æ›´ä½ã€‚\n5. é’ˆå¯¹ long å’Œ double ç±»å‹å˜é‡çš„ç‰¹æ®Šè§„åˆ™5.1 long å’Œ double çš„éåŸå­æ€§åå®šJava å†…å­˜æ¨¡å‹è¦æ±‚ lockã€unlockã€readã€loadã€assignã€useã€storeã€write è¿™å…«ç§æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ï¼Œä½†æ˜¯å¯¹äº 64 ä½çš„æ•°æ®ç±»å‹ï¼ˆlong å’Œ doubleï¼‰ï¼Œåœ¨æ¨¡å‹ä¸­ç‰¹åˆ«å®šä¹‰äº†ä¸€æ¡å®½æ¾çš„è§„å®šï¼š\nå…è®¸è™šæ‹Ÿæœºå°†æ²¡æœ‰è¢« volatile ä¿®é¥°çš„ 64 ä½æ•°æ®çš„è¯»å†™æ“ä½œåˆ’åˆ†ä¸ºä¸¤æ¬¡ 32 ä½çš„æ“ä½œæ¥è¿›è¡Œã€‚\nå³ å…è®¸è™šæ‹Ÿæœºå®ç°è‡ªè¡Œé€‰æ‹©æ˜¯å¦è¦ä¿è¯ 64 ä½æ•°æ®ç±»å‹çš„ loadã€storeã€read å’Œ write è¿™å››ä¸ªæ“ä½œçš„åŸå­æ€§ã€‚\n5.2 å°ç»“å¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹å…±äº«ä¸€ä¸ªå¹¶æœªå£°æ˜ä¸º volatile çš„ long æˆ– double ç±»å‹çš„å˜é‡ï¼Œå¹¶ä¸”åŒæ—¶å¯¹å®ƒä»¬è¿›è¡Œè¯»å–å’Œä¿®æ”¹æ“ä½œï¼Œé‚£ä¹ˆæŸäº›çº¿ç¨‹å¯èƒ½ä¼šè¯»å–åˆ°ä¸€ä¸ªæ—¢ä¸æ˜¯åŸå€¼ï¼Œä¹Ÿä¸æ˜¯å…¶ä»–çº¿ç¨‹ä¿®æ”¹å€¼çš„ä»£è¡¨äº† â€åŠä¸ªå˜é‡â€œ çš„æ•°å€¼ã€‚\nè¿›è¿‡å®é™…æµ‹è¯•ï¼Œåœ¨ç›®å‰ä¸»æµå¹³å°ä¸‹å•†ç”¨çš„ 64 ä½ Java è™šæ‹Ÿæœºä¸­å¹¶ä¸ä¼šå‡ºç°éåŸå­æ€§è®¿é—®è¡Œä¸ºï¼Œä½†æ˜¯å¯¹äº 32 ä½çš„Javaè™šæ‹Ÿæœºï¼Œè­¬å¦‚æ¯”è¾ƒå¸¸ç”¨çš„ 32 ä½ x86 å¹³å°ä¸‹çš„ HotSpot è™šæ‹Ÿæœºï¼Œå¯¹ long ç±»å‹çš„æ•°æ®ç¡®å®å­˜åœ¨éåŸå­æ€§è®¿é—®çš„é£é™©ã€‚\nä» JDK9 èµ·ï¼ŒHotSpot è™šæ‹Ÿæœºå¢åŠ äº†ä¸€ä¸ªå®éªŒæ€§çš„å‚æ•° -XX:+AlwaysAtomicAccesses ï¼ˆè¿™æ˜¯ JEP 188 å¯¹ Java å†…å­˜æ¨¡å‹æ›´æ–°çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼‰æ¥çº¦æŸè™šæ‹Ÿæœºå¯¹æ‰€æœ‰æ•°æ®ç±»å‹è¿›è¡ŒåŸå­æ€§çš„è®¿é—®ã€‚\nè€Œé’ˆå¯¹ double ç±»å‹ï¼Œç”±äºç°ä»£ä¸­å¤®å¤„ç†å™¨ä¸­ä¸€èˆ¬éƒ½åŒ…å«ä¸“é—¨ç”¨äºå¤„ç†æµ®ç‚¹æ•°æ®çš„æµ®ç‚¹è¿ç®—å™¨ï¼ˆFloating Point unitï¼ŒFPUï¼‰ï¼Œç”¨æ¥ä¸“é—¨å¤„ç†å•ã€åŒç²¾åº¦çš„æµ®ç‚¹æ•°æ®ï¼Œæ‰€ä»¥å“ªæ€•æ˜¯ 32 ä½è™šæ‹Ÿæœºä¸­é€šå¸¸ä¹Ÿä¸ä¼šå‡ºç°éåŸå­æ€§è®¿é—®çš„é—®é¢˜ã€‚\nåœ¨å®é™…å¼€å‘ä¸­ï¼Œé™¤éè¯¥æ•°æ®æœ‰æ˜ç¡®å¯çŸ¥çš„çº¿ç¨‹ç«äº‰ï¼Œå¦åˆ™æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸éœ€è¦å› ä¸ºè¿™ä¸ªåŸå› åˆ»æ„æŠŠç”¨åˆ°çš„    long å’Œ double å˜é‡ä¸“é—¨å£°æ˜ä¸º volatileã€‚\n6. åŸå­æ€§ã€å¯è§æ€§ä¸æœ‰åºæ€§Java å†…å­˜æ¨¡å‹æ˜¯å›´ç»•ç€åœ¨å¹¶å‘è¿‡ç¨‹ä¸­å¦‚ä½•å¤„ç†åŸå­æ€§ã€å¯è§æ€§å’Œæœ‰åºæ€§è¿™ä¸‰ä¸ªç‰¹å¾æ¥å»ºç«‹çš„ã€‚\n6.1 åŸå­æ€§ç”± Java å†…å­˜æ¨¡å‹æ¥ç›´æ¥ä¿è¯çš„åŸå­æ€§å˜é‡æ“ä½œåŒ…æ‹¬ readã€loadã€assignã€useã€store å’Œ write è¿™å…­ä¸ªã€‚\næˆ‘ä»¬å¤§è‡´å¯ä»¥è®¤ä¸ºï¼ŒåŸºæœ¬æ•°æ®ç±»å‹çš„è®¿é—®ã€è¯»å†™éƒ½æ˜¯å…·å¤‡åŸå­æ€§çš„ ï¼ˆä¾‹å¤–å°±æ˜¯ long å’Œ double çš„éåŸå­æ€§åå®šï¼Œåªè¦çŸ¥é“è¿™ä»¶äº‹æƒ…å°±å¯ä»¥äº†ï¼Œæ— é¡»å¤ªè¿‡åœ¨æ„è¿™äº›å‡ ä¹ä¸ä¼šå‘ç”Ÿçš„ä¾‹å¤–æƒ…å†µï¼‰ã€‚\nå¦‚æœéœ€è¦ä¸€ä¸ªæ›´å¤§èŒƒå›´çš„åŸå­æ€§ä¿è¯ï¼ŒJava å†…å­˜æ¨¡å‹è¿˜æä¾›äº† lock å’Œ unlock æ“ä½œæ¥æ»¡è¶³éœ€æ±‚ã€‚\nå°½ç®¡è™šæ‹ŸæœºæœªæŠŠ lock å’Œ unlock æ“ä½œç›´æ¥å¼€æ”¾ç»™ç”¨æˆ·ä½¿ç”¨ï¼Œä½†å´æä¾›äº†æ›´é«˜å±‚æ¬¡çš„å­—èŠ‚ç æŒ‡ä»¤ monitorenter å’Œ monitorexit æ¥éšå¼åœ°ä½¿ç”¨è¿™ä¸¤ä¸ªæ“ä½œã€‚\nè¿™ä¸¤ä¸ªå­—èŠ‚ç æŒ‡ä»¤åæ˜ åˆ° Java ä»£ç ä¸­å°±æ˜¯åŒæ­¥å— synchronized å…³é”®å­—ï¼Œå› æ­¤åœ¨ synchronized å—ä¹‹é—´çš„æ“ä½œä¹Ÿå…·å¤‡äº†åŸå­æ€§ã€‚\n6.2 å¯è§æ€§å¯è§æ€§å°±æ˜¯æŒ‡ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡çš„å€¼æ—¶ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³å¾—çŸ¥è¿™ä¸ªä¿®æ”¹ã€‚\nJava å†…å­˜æ¨¡å‹æ˜¯é€šè¿‡åœ¨å˜é‡ä¿®æ”¹åå°†æ–°å€¼åŒæ­¥å›ä¸»å†…å­˜ï¼Œåœ¨å˜é‡è¯»å–å‰ä»ä¸»å†…å­˜åˆ·æ–°å˜é‡å€¼è¿™ç§ä¾èµ–ä¸»å†…å­˜ä½œä¸ºä¼ é€’åª’ä»‹çš„æ–¹å¼æ¥å®ç°å¯è§æ€§çš„ï¼Œæ— è®ºæ˜¯æ™®é€šå˜é‡è¿˜æ˜¯ volatile å˜é‡éƒ½æ˜¯å¦‚æ­¤ã€‚\næ™®é€šå˜é‡ä¸ volatile å˜é‡çš„åŒºåˆ«æ˜¯ï¼Œvolatile çš„ç‰¹æ®Šè§„åˆ™ä¿è¯äº†æ–°å€¼èƒ½ç«‹å³åŒæ­¥åˆ°ä¸»å†…å­˜ï¼Œä»¥åŠæ¯æ¬¡ä½¿ç”¨å‰ç«‹å³ä»ä¸»å†…å­˜åˆ·æ–°ã€‚å› æ­¤ volatile ä¿è¯äº†å¤šçº¿ç¨‹æ“ä½œæ—¶å˜é‡çš„å¯è§æ€§ï¼Œè€Œæ™®é€šå˜é‡åˆ™ä¸èƒ½ä¿è¯è¿™ä¸€ç‚¹ã€‚\nï¼ˆ1ï¼‰synchronized å®ç°å¯è§æ€§åŒæ­¥å—çš„å¯è§æ€§æ˜¯ç”± â€å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆæŠŠæ­¤å˜é‡åŒæ­¥å›ä¸»å†…å­˜ä¸­ï¼ˆæ‰§è¡Œ storeã€writeæ“ä½œï¼‰â€œ è¿™æ¡è§„åˆ™è·å¾—çš„ã€‚\nï¼ˆ2ï¼‰final å…³é”®å­—å®ç°å¯è§æ€§final å…³é”®å­—çš„å¯è§æ€§æ˜¯æŒ‡ï¼š\nè¢« final ä¿®é¥°çš„å­—æ®µåœ¨æ„é€ å™¨ä¸­ä¸€æ—¦è¢«åˆå§‹åŒ–å®Œæˆï¼Œå¹¶ä¸”æ„é€ å™¨æ²¡æœ‰æŠŠ â€œthisâ€ çš„å¼•ç”¨ä¼ é€’å‡ºå»ï¼ˆthis å¼•ç”¨é€ƒé€¸æ˜¯ä¸€ä»¶å¾ˆå±é™©çš„äº‹æƒ…ï¼Œå…¶ä»–çº¿ç¨‹æœ‰å¯èƒ½é€šè¿‡è¿™ä¸ªå¼•ç”¨è®¿é—®çš„ â€œåˆå§‹åŒ–äº†ä¸€åŠâ€ çš„å¯¹è±¡ï¼‰ï¼Œé‚£ä¹ˆåœ¨å…¶ä»–çº¿ç¨‹ä¸­å°±èƒ½çœ‹è§ final å­—æ®µçš„å€¼ã€‚\n6.3 æœ‰åºæ€§Java ç¨‹åºä¸­å¤©ç„¶çš„æœ‰åºæ€§å¯ä»¥æ€»ç»“ä¸ºä¸€å¥è¯ï¼š\nå¦‚æœåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›å¦‚æœåœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰çš„æ“ä½œéƒ½æ˜¯æ— åºçš„ã€‚\nå‰åŠå¥æ˜¯æŒ‡ â€œçº¿ç¨‹å†…ä¼¼è¡¨ç°ä¸ºä¸²è¡Œçš„è¯­ä¹‰ã€‚\nååŠå¥æ˜¯æŒ‡ â€æŒ‡ä»¤é‡æ’åºâ€œ ç°è±¡å’Œ â€å·¥ä½œå†…å­˜ä¸ä¸»å†…å­˜åŒæ­¥å»¶è¿Ÿâ€œ ç°è±¡ã€‚\nï¼ˆ1ï¼‰volatile å®ç°æœ‰åºæ€§volatile å…³é”®å­—æœ¬èº«å°±åŒ…å«äº†ç¦æ­¢æŒ‡ä»¤é‡æ’åºçš„è¯­ä¹‰ã€‚\nï¼ˆ2ï¼‰synchronized å®ç°æœ‰åºæ€§synchronized ç”± â€œä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œâ€ è¿™æ¡è§„åˆ™è·å¾—çš„ï¼Œ\nè¿™ä¸ªè§„åˆ™å†³å®šäº†æŒæœ‰åŒä¸€ä¸ªé”çš„ä¸¤ä¸ªåŒæ­¥å—åªèƒ½ä¸²è¡Œåœ°è¿›å…¥ã€‚\n7. å…ˆè¡Œå‘ç”ŸåŸåˆ™7.1 ä»€ä¹ˆæ˜¯å…ˆè¡Œå‘ç”ŸåŸåˆ™å…ˆè¡Œå‘ç”ŸåŸåˆ™æ˜¯ Java å†…å­˜æ¨¡å‹ä¸­å®šä¹‰çš„ä¸¤é¡¹æ“ä½œä¹‹é—´çš„ååºå…³ç³»ã€‚\næ¯”å¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œå…¶å®å°±æ˜¯è¯´åœ¨å‘ç”Ÿæ“ä½œ B ä¹‹å‰ï¼Œæ“ä½œ A äº§ç”Ÿçš„å½±å“èƒ½è¢«æ“ä½œ B è§‚å¯Ÿåˆ°ã€‚\nâ€œå½±å“â€ åŒ…æ‹¬ä¿®æ”¹äº†å†…å­˜ä¸­å…±äº«å˜é‡çš„å€¼ã€å‘é€äº†æ¶ˆæ¯ã€è°ƒç”¨äº†æ–¹æ³•ç­‰ã€‚\nä¾‹å¦‚ï¼š\n// ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹Aä¸­æ‰§è¡Œi = 1;// ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹Bä¸­æ‰§è¡Œj = i;// ä»¥ä¸‹æ“ä½œåœ¨çº¿ç¨‹Cä¸­æ‰§è¡Œi = 2;\n\n7.2 å…ˆè¡Œå‘ç”Ÿè§„åˆ™ä»¥ä¸‹æ˜¯ Java å†…å­˜æ¨¡å‹ä¸‹ä¸€äº› â€œå¤©ç„¶çš„â€ å…ˆè¡Œå‘ç”Ÿå…³ç³»ï¼Œè¿™äº›å…ˆè¡Œå‘ç”Ÿå…³ç³»æ— éœ€ä»»ä½•åŒæ­¥å™¨ååŠ©å°±å·²ç»å­˜åœ¨ï¼Œå¯ä»¥åœ¨ç¼–ç ä¸­ç›´æ¥ä½¿ç”¨ã€‚\nå¦‚æœä¸¤ä¸ªæ“ä½œä¹‹é—´çš„å…³ç³»ä¸åœ¨æ­¤åˆ—ï¼Œå¹¶ä¸”æ— æ³•ä»ä¸‹åˆ—è§„åˆ™æ¨å¯¼å‡ºæ¥ï¼Œåˆ™å®ƒä»¬å°±æ²¡æœ‰é¡ºåºæ€§ä¿éšœï¼Œè™šæ‹Ÿæœºå¯ä»¥å¯¹å®ƒä»¬éšæ„è¿›è¡Œé‡æ’åºã€‚\n\nç¨‹åºæ¬¡åºè§„åˆ™ï¼š åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼ŒæŒ‰ç…§æ§åˆ¶æµé¡ºåºï¼Œä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºå†™åœ¨åé¢çš„æ“ä½œã€‚æ³¨æ„ï¼Œè¿™é‡Œè¯´çš„æ˜¯ æ§åˆ¶æµé¡ºåº è€Œä¸æ˜¯ ç¨‹åºä»£ç é¡ºåº ï¼Œå› ä¸ºè¦è€ƒè™‘åˆ†æ”¯ã€å¾ªç¯ç­‰ç»“æ„ã€‚\nç®¡ç¨‹é”å®šè§„åˆ™ï¼šä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚è¿™é‡Œå¿…é¡»å¼ºè°ƒçš„æ˜¯ â€œåŒä¸€ä¸ªé”â€ï¼Œè€Œ â€œåé¢â€ æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåã€‚\nvolatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œï¼Œè¿™é‡Œçš„ â€œåé¢â€ åŒæ ·æ˜¯æŒ‡æ—¶é—´ä¸Šçš„å…ˆåã€‚\nçº¿ç¨‹å¯åŠ¨è§„åˆ™ï¼šThread å¯¹è±¡çš„ start() æ–¹æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚\nçº¿ç¨‹ç»ˆæ­¢è§„åˆ™ï¼šçº¿ç¨‹ä¸­çš„æ‰€æœ‰æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºå¯¹æ­¤çº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ Thread::join æ–¹æ³•æ˜¯å¦ç»“æŸã€Thread::isAlive() æ–¹æ³•çš„è¿”å›å€¼ç­‰æ‰‹æ®µæ£€æµ‹çº¿ç¨‹æ˜¯å¦å·²ç»ç»ˆæ­¢æ‰§è¡Œã€‚\nçº¿ç¨‹ä¸­æ–­è§„åˆ™ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­æ—¶é—´çš„å‘ç”Ÿã€‚å¯ä»¥é€šè¿‡ Thread::interrupted() æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚\nå¯¹è±¡ç»ˆç»“è§„åˆ™ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹ã€‚\nä¼ é€’æ€§ï¼šå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ B ï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£å°±å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C çš„ç»“è®ºã€‚\n\n","categories":["Java","JVM"],"tags":["æ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰"]},{"title":"ZGC åƒåœ¾æ”¶é›†å™¨","url":"/posts/39233/","content":"ä¸€ã€ä»‹ç»ZGC (â€œZâ€å¹¶éä»€ä¹ˆä¸“ä¸šåè¯çš„ç¼©å†™ï¼Œè¿™æ¬¾æ”¶é›†å™¨çš„åå­—å°±å«ä½œZGarbage Collector)æ˜¯ä¸€æ¬¾åœ¨JDK 11ä¸­æ–°åŠ å…¥çš„å…·æœ‰å®éªŒæ€§è´¨çš„ä½å»¶è¿Ÿåƒåœ¾æ”¶é›†å™¨ï¼Œæ˜¯ç”±Oracle å…¬å¸ç ”å‘çš„ã€‚\n2018å¹´Oracleåˆ›å»ºäº†JEP333å°†ZGCæäº¤ç»™OpenJDKï¼Œæ¨åŠ¨å…¶è¿›å…¥OpenJDK11çš„å‘å¸ƒæ¸…å•ä¹‹ä¸­ã€‚\nZGC å’Œ Shenandoah çš„ç›®æ ‡æ˜¯é«˜åº¦ç›¸ä¼¼çš„ï¼Œéƒ½å¸Œæœ›åœ¨å°½å¯èƒ½å¯¹ååé‡å½±å“ä¸å¤ªå¤§çš„å‰æä¸‹ç›®ï¼Œå®ç°åœ¨ä»»æ„å †å†…å­˜å¤§å°ä¸‹éƒ½å¯ä»¥æŠŠåƒåœ¾æ”¶é›†çš„åœé¡¿æ—¶é—´é™åˆ¶åœ¨åæ¯«ç§’ä»¥å†…çš„ä½å»¶è¿Ÿã€‚\nä½†æ˜¯ ZGC å’Œ Shenandoah çš„å®ç°æ€è·¯åˆæ˜¯å·®å¼‚æ˜¾è‘—çš„ã€‚\nå¦‚æœè¯´ RedHat å…¬å¸å¼€å‘çš„ Shenandoah åƒæ˜¯Oracleçš„ G1 æ”¶é›†å™¨çš„å®é™…ç»§æ‰¿è€…çš„è¯ï¼Œé‚£Oracle å…¬å¸å¼€å‘çš„ ZGC å°±æ›´åƒæ˜¯Azul Systemå…¬å¸ç‹¬æ­¥å¤©ä¸‹çš„ PGC (Pauseless GC)å’Œ C4 (Concurrent Continuously Compacting Collector)æ”¶é›†å™¨çš„åŒèƒå…„å¼Ÿã€‚\næ—©åœ¨2005å¹´ï¼Œè¿è¡Œåœ¨AzulVMä¸Šçš„ PGC å°±å·²ç»å®ç°äº†æ ‡è®°å’Œæ•´ç†é˜¶æ®µéƒ½å…¨ç¨‹ä¸ç”¨æˆ·çº¿ç¨‹å¹¶å‘è¿è¡Œçš„åƒåœ¾æ”¶é›†ï¼Œè€Œè¿è¡Œåœ¨ZingVMä¸Šçš„C4æ”¶é›†å™¨æ˜¯PGCç»§ç»­æ¼”è¿›çš„äº§ç‰©ï¼Œä¸»è¦å¢åŠ äº†åˆ†ä»£æ”¶é›†æ”¯æŒï¼Œå¤§å¹…æå‡äº†æ”¶é›†å™¨èƒ½å¤Ÿæ‰¿å—çš„å¯¹è±¡åˆ†é…é€Ÿåº¦ã€‚\næ— è®ºä»ç®—æ³•è¿˜æ˜¯å®ç°åŸç†ä¸Šæ¥è®²ï¼ŒPGC å’Œ C4 è‚¯å®šç®—æ˜¯ä¸€è„‰ç›¸æ‰¿çš„ï¼Œè€ŒZGCè™½ç„¶å¹¶éAzulå…¬å¸çš„äº§å“ï¼Œä½†ä¹Ÿåº”è§†ä¸ºè¿™æ¡è„‰ç»œä¸Šçš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå› ä¸º ZGC å‡ ä¹æ‰€æœ‰çš„å…³é”®æŠ€æœ¯ä¸Šï¼Œä¸PGCå’ŒC4éƒ½åªå­˜åœ¨æœ¯è¯­ç§°è°“ä¸Šçš„å·®åˆ«ï¼Œå®è´¨å†…å®¹å‡ ä¹æ˜¯ä¸€æ¨¡ä¸€æ ·çš„ã€‚\nç›¸ä¿¡åˆ°è¿™é‡Œè¯»è€…åº”è¯¥å·²ç»å¯¹ Java è™šæ‹Ÿæœºæ”¶é›†å™¨å¸¸è§çš„ä¸“ä¸šæœ¯è¯­éƒ½æœ‰æ‰€äº†è§£äº†ï¼Œå¦‚æœä¸é¿è®³ä¸“ä¸šæœ¯è¯­çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ZGCä¸‹ä¸€ä¸ªè¿™æ ·çš„å®šä¹‰æ¥æ¦‚æ‹¬å®ƒçš„ä¸»è¦ç‰¹å¾ï¼š\nZGC æ”¶é›†å™¨æ˜¯ä¸€æ¬¾åŸºäº Region å†…å­˜å¸ƒå±€çš„ï¼Œ(æš‚æ—¶)ä¸è®¾åˆ†ä»£çš„ï¼Œä½¿ç”¨äº†è¯»å±éšœã€æŸ“è‰²æŒ‡é’ˆå’Œå†…å­˜å¤šé‡æ˜ å°„ç­‰æŠ€æœ¯æ¥å®ç°å¯å¹¶å‘çš„ æ ‡è®°-æ•´ç† ç®—æ³•çš„ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ä¸€æ¬¾åƒåœ¾æ”¶é›†å™¨ã€‚\näºŒã€ZGC å†…å­˜å¸ƒå±€ä¸ Shenandoah å’Œ G1 ä¸€æ ·ï¼ŒZGC ä¹Ÿé‡‡ç”¨åŸºäº Region çš„å †å†…å­˜å¸ƒå±€ï¼Œä½†ä¸å®ƒä»¬ä¸åŒçš„æ˜¯ï¼Œ\nZGC çš„ Region ï¼ˆåœ¨ä¸€äº›å®˜æ–¹èµ„æ–™ä¸­å°†å®ƒç§°ä¸º Page æˆ–è€… ZPageï¼Œæœ¬ç« ä¸ºè¡Œæ–‡ä¸€è‡´ç»§ç»­ç§°ä¸º Regionï¼‰å…·æœ‰åŠ¨æ€æ€§â€”â€”åŠ¨æ€åˆ›å»ºå’Œé”€æ¯ï¼Œä»¥åŠåŠ¨æ€çš„åŒºåŸŸå®¹é‡å¤§å°ã€‚\nåœ¨x64ç¡¬ä»¶å¹³å°ä¸‹ï¼ŒZGC çš„ Region å¯ä»¥å…·æœ‰å¦‚å›¾3-19æ‰€ç¤ºçš„å¤§ã€ä¸­ã€å°ä¸‰ç±»å®¹é‡ï¼š\n\nå°å‹ Regionï¼ˆSmall Regionï¼‰ï¼šå®¹é‡å›ºå®šä¸º2MBï¼Œç”¨äºæ”¾ç½®å°äº256KBçš„å°å¯¹è±¡ã€‚\nä¸­å‹ Regionï¼ˆMedium Regionï¼‰ï¼šå®¹é‡å›ºå®šä¸º32MBï¼Œç”¨äºæ”¾ç½®å¤§äºç­‰äº256KB ä½†å°äº4MBçš„å¯¹è±¡ã€‚\nå¤§å‹Regionï¼ˆLarge Regionï¼‰ï¼šå®¹é‡ä¸å›ºå®šï¼Œå¯ä»¥åŠ¨æ€å˜åŒ–ï¼Œä½†å¿…é¡»ä¸º2MBçš„æ•´æ•°å€ï¼Œç”¨äºæ”¾ç½®4MBæˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ã€‚æ¯ä¸ªå¤§å‹ Region ä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§å¯¹è±¡ï¼Œè¿™ä¹Ÿé¢„ç¤ºç€è™½ç„¶åå­—å«ä½œâ€å¤§å‹Regionâ€ï¼Œä½†å®ƒçš„å®é™…å®¹é‡å®Œå…¨æœ‰å¯èƒ½å°äºä¸­å‹Regionï¼Œæœ€å°å®¹é‡å¯ä½è‡³4MBã€‚å¤§å‹Regionåœ¨ZGCçš„å®ç°ä¸­æ˜¯ä¸ä¼šè¢«é‡åˆ†é…ï¼ˆé‡åˆ†é…æ˜¯ZGCçš„ä¸€ç§å¤„ç†åŠ¨ä½œï¼Œç”¨äºå¤åˆ¶å¯¹è±¡çš„æ”¶é›†å™¨é˜¶æ®µï¼Œç¨åä¼šä»‹ç»åˆ°ï¼‰çš„ï¼Œå› ä¸ºå¤åˆ¶ä¸€ä¸ªå¤§å¯¹è±¡çš„ä»£ä»·éå¸¸é«˜æ˜‚ã€‚\n\n\nä¸‰ã€æŸ“è‰²æŒ‡é’ˆShenandoah ä½¿ç”¨ è½¬å‘æŒ‡é’ˆ å’Œ è¯»å±éšœ æ¥å®ç°å¹¶å‘æ•´ç†ï¼ŒZGC è™½ç„¶åŒæ ·ç”¨åˆ°äº† è¯»å±éšœï¼Œä½†ç”¨çš„å´æ˜¯ä¸€æ¡ä¸ Shenandoah å®Œå…¨ä¸åŒï¼Œæ›´åŠ å¤æ‚ç²¾å·§çš„è§£é¢˜æ€è·¯ã€‚\nZGC æ”¶é›†å™¨æœ‰ä¸€ä¸ªæ ‡å¿—æ€§çš„è®¾è®¡æ˜¯å®ƒé‡‡ç”¨çš„ æŸ“è‰²æŒ‡é’ˆ æŠ€æœ¯ï¼ˆColored Pointerï¼Œå…¶ä»–ç±»ä¼¼çš„æŠ€æœ¯ä¸­å¯èƒ½å°†å®ƒç§°ä¸ºTag Pointeræˆ–è€…Version Pointerï¼‰ã€‚\nï¼ˆ1ï¼‰ä¸ºä»€ä¹ˆéœ€è¦æŸ“è‰²æŒ‡é’ˆï¼Ÿä»å‰ï¼Œå¦‚æœæˆ‘ä»¬è¦åœ¨å¯¹è±¡ä¸Šå­˜å‚¨ä¸€äº›é¢å¤–çš„ã€åªä¾›æ”¶é›†å™¨æˆ–è€…è™šæ‹Ÿæœºæœ¬èº«ä½¿ç”¨çš„æ•°æ®ï¼Œé€šå¸¸ä¼šåœ¨å¯¹è±¡å¤´ä¸­å¢åŠ é¢å¤–çš„å­˜å‚¨å­—æ®µï¼Œå¦‚å¯¹è±¡çš„å“ˆå¸Œç ã€åˆ†ä»£å¹´é¾„ã€é”è®°å½•ç­‰å°±æ˜¯è¿™æ ·å­˜å‚¨çš„ã€‚\nè¿™ç§è®°å½•æ–¹å¼åœ¨æœ‰å¯¹è±¡è®¿é—®çš„åœºæ™¯ä¸‹æ˜¯å¾ˆè‡ªç„¶æµç•…çš„ï¼Œä¸ä¼šæœ‰ä»€ä¹ˆé¢å¤–è´Ÿæ‹…ã€‚ä½†å¦‚æœå¯¹è±¡å­˜åœ¨è¢«ç§»åŠ¨è¿‡çš„å¯èƒ½æ€§ï¼Œå³ä¸èƒ½ä¿è¯å¯¹è±¡è®¿é—®èƒ½å¤ŸæˆåŠŸå‘¢ï¼Ÿåˆæˆ–è€…æœ‰ä¸€äº›æ ¹æœ¬å°±ä¸ä¼šå»è®¿é—®å¯¹è±¡ï¼Œä½†åˆå¸Œæœ›å¾—çŸ¥è¯¥å¯¹è±¡çš„æŸäº›ä¿¡æ¯çš„åº”ç”¨åœºæ™¯å‘¢ï¼Ÿ\nèƒ½ä¸èƒ½ä»æŒ‡é’ˆæˆ–è€…ä¸å¯¹è±¡å†…å­˜æ— å…³çš„åœ°æ–¹å¾—åˆ°è¿™äº›ä¿¡æ¯ï¼Œè­¬å¦‚æ˜¯å¦èƒ½å¤Ÿçœ‹å‡ºæ¥å¯¹è±¡è¢«ç§»åŠ¨è¿‡ï¼Ÿ\nè¿™æ ·çš„è¦æ±‚å¹¶éä¸åˆç†çš„åˆéš¾ï¼Œå…ˆä¸å»è¯´å¹¶å‘ç§»åŠ¨å¯¹è±¡å¯èƒ½å¸¦æ¥çš„å¯è®¿é—®æ€§é—®é¢˜ï¼Œæ­¤å‰æˆ‘ä»¬å°±é‡åˆ°è¿‡è¿™æ ·çš„è¦æ±‚â€”â€”è¿½è¸ªå¼æ”¶é›†ç®—æ³• çš„æ ‡è®°é˜¶æ®µå°±å¯èƒ½å­˜åœ¨åªè·ŸæŒ‡é’ˆæ‰“äº¤é“è€Œä¸å¿…æ¶‰åŠæŒ‡é’ˆæ‰€å¼•ç”¨çš„å¯¹è±¡æœ¬èº«çš„åœºæ™¯ã€‚\nä¾‹å¦‚å¯¹è±¡æ ‡è®°çš„è¿‡ç¨‹ä¸­éœ€è¦ç»™å¯¹è±¡æ‰“ä¸Šä¸‰è‰²æ ‡è®°ï¼Œè¿™äº›æ ‡è®°æœ¬è´¨ä¸Šå°±åªå’Œå¯¹è±¡çš„å¼•ç”¨æœ‰å…³ï¼Œè€Œä¸å¯¹è±¡æœ¬èº«æ— å…³â€”â€”æŸä¸ªå¯¹è±¡åªæœ‰å®ƒçš„å¼•ç”¨å…³ç³»èƒ½å†³å®šå®ƒå­˜æ´»ä¸å¦ï¼Œå¯¹è±¡ä¸Šå…¶ä»–æ‰€æœ‰çš„å±æ€§éƒ½ä¸èƒ½å¤Ÿå½±å“å®ƒçš„å­˜æ´»åˆ¤å®šç»“æœã€‚\nHotSpot è™šæ‹Ÿæœºçš„å‡ ç§æ”¶é›†å™¨æœ‰ä¸åŒçš„æ ‡è®°å®ç°æ–¹æ¡ˆã€‚\næœ‰çš„æŠŠæ ‡è®°ç›´æ¥è®°å½•åœ¨å¯¹è±¡å¤´ä¸Š(å¦‚Serialæ”¶é›†å™¨)ï¼Œæœ‰çš„æŠŠæ ‡è®°è®°å½•åœ¨ä¸å¯¹è±¡ç›¸äº’ç‹¬ç«‹çš„æ•°æ®ç»“æ„ä¸Šï¼ˆå¦‚G1ã€Shenandoah ä½¿ç”¨äº†ä¸€ç§ç›¸å½“äºå †å†…å­˜çš„1/64å¤§å°çš„ã€ç§°ä¸ºBitMapçš„ç»“æ„æ¥è®°å½•æ ‡è®°ä¿¡æ¯ï¼‰ã€‚\nè€Œ ZGC çš„æŸ“è‰²æŒ‡é’ˆæ˜¯æœ€ç›´æ¥çš„ã€æœ€çº¯ç²¹çš„ï¼Œå®ƒç›´æ¥æŠŠæ ‡è®°ä¿¡æ¯è®°åœ¨å¼•ç”¨å¯¹è±¡çš„æŒ‡é’ˆä¸Šï¼Œè¿™æ—¶ï¼Œä¸å…¶è¯´å¯è¾¾æ€§åˆ†ææ˜¯éå†å¯¹è±¡å›¾æ¥æ ‡è®°å¯¹è±¡ã€è¿˜ä¸å¦‚è¯´æ˜¯éå†â€œå¼•ç”¨å›¾â€æ¥æ ‡è®°â€œå¼•ç”¨â€äº†ã€‚\nï¼ˆ2ï¼‰ä¸ºä»€ä¹ˆæŒ‡é’ˆæœ¬èº«ä¹Ÿå¯ä»¥å­˜å‚¨é¢å¤–ä¿¡æ¯ï¼ŸæŸ“è‰²æŒ‡é’ˆæ˜¯ä¸€ç§ç›´æ¥å°†å°‘é‡é¢å¤–çš„ä¿¡æ¯å­˜å‚¨åœ¨æŒ‡é’ˆä¸Šçš„æŠ€æœ¯ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆæŒ‡é’ˆæœ¬èº«ä¹Ÿå¯ä»¥å­˜å‚¨é¢å¤–ä¿¡æ¯å‘¢ï¼Ÿ\nåœ¨64ä½ç³»ç»Ÿä¸­ï¼Œç†è®ºå¯ä»¥è®¿é—®çš„å†…å­˜é«˜è¾¾16EBï¼ˆ2çš„64æ¬¡å¹‚ï¼‰å­—èŠ‚ã€‚\nå®é™…ä¸Šï¼ŒåŸºäºéœ€æ±‚ï¼ˆç”¨ä¸åˆ°é‚£ä¹ˆå¤šå†…å­˜ï¼‰ã€æ€§èƒ½ï¼ˆåœ°å€è¶Šå®½åœ¨åšåœ°å€è½¬æ¢æ—¶éœ€è¦çš„é¡µè¡¨çº§æ•°è¶Šå¤šï¼‰å’Œæˆæœ¬ï¼ˆæ¶ˆè€—æ›´å¤šæ™¶ä½“ç®¡ï¼‰çš„è€ƒè™‘ï¼Œåœ¨AMD64æ¶æ„ä¸­åªæ”¯æŒåˆ°52ä½ï¼ˆ4PBï¼‰çš„åœ°å€æ€»çº¿å’Œ48ä½ï¼ˆ256TBï¼‰çš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œæ‰€ä»¥ç›®å‰64ä½çš„ç¡¬ä»¶å®é™…èƒ½å¤Ÿæ”¯æŒçš„æœ€å¤§å†…å­˜åªæœ‰256TBã€‚\næ­¤å¤–ï¼Œæ“ä½œç³»ç»Ÿä¸€ä¾§ä¹Ÿè¿˜ä¼šæ–½åŠ è‡ªå·±çš„çº¦æŸï¼Œ64ä½çš„Linuxåˆ™åˆ†åˆ«æ”¯æŒ47ä½ï¼ˆ128TBï¼‰çš„è¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´å’Œ46ä½ï¼ˆ64TBï¼‰çš„ç‰©ç†åœ°å€ç©ºé—´ï¼Œ64ä½çš„Windowsç³»ç»Ÿç”šè‡³åªæ”¯æŒ44ä½ï¼ˆ16TBï¼‰çš„ç‰©ç†åœ°å€ç©ºé—´ã€‚\nå°½ç®¡ Linuxä¸‹64ä½æŒ‡é’ˆçš„é«˜18ä½ä¸èƒ½ç”¨æ¥å¯»å€ï¼Œä½†å‰©ä½™çš„46ä½æŒ‡é’ˆæ‰€èƒ½æ”¯æŒçš„ 64TBå†…å­˜åœ¨ä»Šå¤©ä»ç„¶èƒ½å¤Ÿå……åˆ†æ»¡è¶³å¤§å‹æœåŠ¡å™¨çš„éœ€è¦ã€‚\né‰´äºæ­¤ï¼ŒZGC çš„æŸ“è‰²æŒ‡é’ˆæŠ€æœ¯ç»§ç»­ç›¯ä¸Šäº†è¿™å‰©ä¸‹çš„46ä½æŒ‡é’ˆå®½åº¦ï¼Œå°†å…¶é«˜4ä½æå–å‡ºæ¥å­˜å‚¨å››ä¸ªæ ‡å¿—ä¿¡æ¯ã€‚\né€šè¿‡è¿™äº›æ ‡å¿—ä½ï¼Œè™šæ‹Ÿæœºå¯ä»¥ç›´æ¥ä»æŒ‡é’ˆä¸­çœ‹åˆ°å…¶å¼•ç”¨å¯¹è±¡çš„ä¸‰è‰²æ ‡è®°çŠ¶æ€ã€æ˜¯å¦è¿›å…¥äº†é‡åˆ†é…é›†ï¼ˆå³è¢«ç§»è¿‡ï¼‰ã€æ˜¯å¦åªèƒ½é€šè¿‡finalize()æ–¹æ³•æ‰èƒ½è¢«è®¿é—®åˆ°ã€‚\n\nç”±äºè¿™äº›æ ‡å¿—è¿›ä¸€æ­¥å‹ç¼©äº†åŸæœ¬å°±åªæœ‰46ä½çš„åœ°å€ç©ºé—´ï¼Œä¹Ÿç›´æ¥å¯¼è‡´ ZGC èƒ½å¤Ÿç®¡ç†çš„å†…å­˜ä¸å¯ä»¥è¶…è¿‡4TBï¼ˆ2çš„42æ¬¡å¹‚ï¼‰ã€‚\nè™½ç„¶ æŸ“è‰²æŒ‡é’ˆæœ‰4TBçš„å†…å­˜é™åˆ¶ï¼Œä¸èƒ½æ”¯æŒ32ä½å¹³å°ï¼Œä¸èƒ½æ”¯æŒå‹ç¼©æŒ‡é’ˆï¼ˆ-XX:+UseCompressedOopsï¼‰ç­‰è¯¸å¤šçº¦æŸï¼Œä½†å®ƒå¸¦æ¥çš„æ”¶ç›Šä¹Ÿæ˜¯éå¸¸å¯è§‚çš„ã€‚\nï¼ˆ3ï¼‰æŸ“è‰²æŒ‡é’ˆä¸‰å¤§ä¼˜åŠ¿\næŸ“è‰²æŒ‡é’ˆå¯ä»¥ä½¿å¾—ä¸€æ—¦æŸä¸ª Region çš„å­˜æ´»å¯¹è±¡è¢«ç§»èµ°ä¹‹åï¼Œè¿™ä¸ª Region ç«‹å³å°±èƒ½å¤Ÿè¢«é‡Šæ”¾å’Œé‡ç”¨æ‰ï¼Œè€Œä¸å¿…ç­‰å¾…æ•´ä¸ªå †ä¸­æ‰€æœ‰æŒ‡å‘è¯¥ Region çš„å¼•ç”¨éƒ½è¢«ä¿®æ­£åæ‰èƒ½æ¸…ç†ã€‚è¿™ç‚¹ç›¸æ¯”èµ· Shenandoah æ˜¯ä¸€ä¸ªé¢‡å¤§çš„ä¼˜åŠ¿ï¼Œä½¿å¾—ç†è®ºä¸Šåªè¦è¿˜æœ‰ä¸€ä¸ªç©ºé—² Regionï¼ŒZGC å°±èƒ½å®Œæˆæ”¶é›†ï¼Œè€Œ Shenandoah éœ€è¦ç­‰åˆ°å¼•ç”¨æ›´æ–°é˜¶æ®µç»“æŸä»¥åæ‰èƒ½é‡Šæ”¾å›æ”¶é›†ä¸­çš„ Regionï¼Œè¿™æ„å‘³ç€å †ä¸­å‡ ä¹æ‰€æœ‰å¯¹è±¡éƒ½å­˜æ´»çš„æç«¯æƒ…å†µï¼Œéœ€è¦1:1å¤åˆ¶å¯¹è±¡åˆ°æ–° Region çš„è¯ï¼Œå°±å¿…é¡»è¦æœ‰ä¸€åŠçš„ç©ºé—² Region æ¥å®Œæˆæ”¶é›†ã€‚è‡³äºä¸ºä»€ä¹ˆæŸ“è‰²æŒ‡é’ˆèƒ½å¤Ÿå¯¼è‡´è¿™æ ·çš„ç»“æœï¼Œç¬”è€…å°†åœ¨åç»­è§£é‡Šå…¶â€œè‡ªæ„ˆâ€ç‰¹æ€§çš„æ—¶å€™è¿›è¡Œè§£é‡Šã€‚\næŸ“è‰²æŒ‡é’ˆå¯ä»¥å¤§å¹…å‡å°‘åœ¨åƒåœ¾æ”¶é›†è¿‡ç¨‹ä¸­å†…å­˜å±éšœçš„ä½¿ç”¨æ•°é‡ï¼Œè®¾ç½®å†…å­˜å±éšœï¼Œå°¤å…¶æ˜¯å†™å±éšœçš„ç›®çš„é€šå¸¸æ˜¯ä¸ºäº†è®°å½•å¯¹è±¡å¼•ç”¨çš„å˜åŠ¨æƒ…å†µï¼Œå¦‚æœå°†è¿™äº›ä¿¡æ¯ç›´æ¥ç»´æŠ¤åœ¨æŒ‡é’ˆä¸­ï¼Œæ˜¾ç„¶å°±å¯ä»¥çœå»ä¸€äº›ä¸“é—¨çš„è®°å½•æ“ä½œã€‚å®é™…ä¸Šï¼Œåˆ°ç›®å‰ä¸ºæ­¢ ZGC éƒ½å¹¶æœªä½¿ç”¨ä»»ä½•å†™å±éšœï¼Œåªä½¿ç”¨äº†è¯»å±éšœï¼ˆä¸€éƒ¨åˆ†æ˜¯æŸ“è‰²æŒ‡é’ˆçš„åŠŸåŠ³ï¼Œä¸€éƒ¨åˆ†æ˜¯ZGCç°åœ¨è¿˜ä¸æ”¯æŒåˆ†ä»£æ”¶é›†ï¼Œå¤©ç„¶å°±æ²¡æœ‰è·¨ä»£å¼•ç”¨çš„é—®é¢˜ï¼‰ã€‚å†…å­˜å±éšœå¯¹ç¨‹åºè¿è¡Œæ—¶æ€§èƒ½çš„æŸè€—åœ¨å‰é¢ç« èŠ‚ä¸­å·²ç»è®²è§£è¿‡ï¼Œèƒ½å¤Ÿçœå»ä¸€éƒ¨åˆ†çš„å†…å­˜å±éšœï¼Œæ˜¾ç„¶å¯¹ç¨‹åºè¿è¡Œæ•ˆç‡æ˜¯å¤§æœ‰è£¨ç›Šçš„ï¼Œæ‰€ä»¥ ZGC å¯¹ååé‡çš„å½±å“ä¹Ÿç›¸å¯¹è¾ƒä½ã€‚\næŸ“è‰²æŒ‡é’ˆå¯ä»¥ä½œä¸ºä¸€ç§å¯æ‰©å±•çš„å­˜å‚¨ç»“æ„ç”¨æ¥è®°å½•æ›´å¤šä¸å¯¹è±¡æ ‡è®°ã€é‡å®šä½è¿‡ç¨‹ç›¸å…³çš„æ•°æ®ï¼Œä»¥ä¾¿æ—¥åè¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚ç°åœ¨Linuxä¸‹çš„64ä½æŒ‡é’ˆè¿˜æœ‰å‰18ä½å¹¶æœªä½¿ç”¨ï¼Œå®ƒä»¬è™½ç„¶ä¸èƒ½ç”¨æ¥å¯»å€ï¼Œå´å¯ä»¥é€šè¿‡å…¶ä»–æ‰‹æ®µç”¨äºä¿¡æ¯è®°å½•ã€‚å¦‚æœå¼€å‘äº†è¿™18ä½ï¼Œæ—¢å¯ä»¥è…¾å‡ºå·²ç”¨çš„4ä¸ªæ ‡å¿—ä½ï¼Œå°† ZGC å¯æ”¯æŒçš„æœ€å¤§å †å†…å­˜ä»4TB æ‹“å±•åˆ°64TBï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨å…¶ä½™ä½ç½®å†å­˜å‚¨æ›´å¤šçš„æ ‡å¿—ï¼Œè­¬å¦‚å­˜å‚¨ä¸€äº›è¿½è¸ªä¿¡æ¯æ¥è®©åƒåœ¾æ”¶é›†å™¨åœ¨ç§»åŠ¨å¯¹è±¡æ—¶èƒ½å°†ä½é¢‘æ¬¡ä½¿ç”¨çš„å¯¹è±¡ç§»åŠ¨åˆ°ä¸å¸¸è®¿é—®çš„å†…å­˜åŒºåŸŸã€‚\n\nä¸è¿‡è¦é¡ºåˆ©åº”ç”¨æŸ“è‰²æŒ‡é’ˆæœ‰ä¸€ä¸ªå¿…é¡»è§£å†³çš„å‰ç½®é—®é¢˜ï¼š\nJava è™šæ‹Ÿæœºä½œä¸ºä¸€ä¸ªæ™®æ™®é€šé€šçš„è¿›ç¨‹ï¼Œè¿™æ ·éšæ„é‡æ–°å®šä¹‰å†…å­˜ä¸­æŸäº›æŒ‡é’ˆçš„å…¶ä¸­å‡ ä½ï¼Œæ“ä½œç³»ç»Ÿæ˜¯å¦æ”¯æŒï¼Ÿå¤„ç†å™¨æ˜¯å¦æ”¯æŒï¼Ÿ\nè¿™æ˜¯å¾ˆç°å®çš„é—®é¢˜ï¼Œæ— è®ºä¸­é—´è¿‡ç¨‹å¦‚ä½•ï¼Œç¨‹åºä»£ç æœ€ç»ˆéƒ½è¦è½¬æ¢ä¸ºæœºå™¨æŒ‡ä»¤æµäº¤ä»˜ç»™å¤„ç†å™¨å»æ‰§è¡Œï¼Œå¤„ç†å™¨å¯ä¸ä¼šç®¡æŒ‡ä»¤æµä¸­çš„æŒ‡é’ˆå“ªéƒ¨åˆ†å­˜çš„æ˜¯æ ‡å¿—ä½ï¼Œå“ªéƒ¨åˆ†æ‰æ˜¯çœŸæ­£çš„å¯»å€åœ°å€ï¼Œåªä¼šæŠŠæ•´ä¸ªæŒ‡é’ˆéƒ½è§†ä½œä¸€ä¸ªå†…å­˜åœ°å€æ¥å¯¹å¾…ã€‚\nè¿™ä¸ªé—®é¢˜åœ¨ Solaris/SPARC å¹³å°ä¸Šæ¯”è¾ƒå®¹æ˜“è§£å†³ï¼Œå› ä¸º SPARC ç¡¬ä»¶å±‚é¢æœ¬èº«å°±æ”¯æŒè™šæ‹Ÿåœ°å€æ©ç ï¼Œè®¾ç½®ä¹‹åå…¶æœºå™¨æŒ‡ä»¤ç›´æ¥å°±å¯ä»¥å¿½ç•¥æ‰æŸ“è‰²æŒ‡é’ˆä¸­çš„æ ‡å¿—ä½ã€‚\nä½†åœ¨x86-64å¹³å°ä¸Šå¹¶æ²¡æœ‰æä¾›ç±»ä¼¼çš„é»‘ç§‘æŠ€ ZGC è®¾è®¡è€…å°±åªèƒ½é‡‡å–å…¶ä»–çš„è¡¥æ•‘æªæ–½äº†ï¼Œè¿™é‡Œé¢çš„è§£å†³æ–¹æ¡ˆè¦æ¶‰åŠè™šæ‹Ÿå†…å­˜æ˜ å°„æŠ€æœ¯ï¼Œè®©æˆ‘ä»¬å…ˆæ¥å¤ä¹ ä¸€ä¸‹è¿™ä¸ªx86è®¡ç®—æœºä½“ç³»ä¸­çš„ç»å…¸è®¾è®¡ã€‚\nï¼ˆ4ï¼‰è™šæ‹Ÿå†…å­˜æ˜ å°„æŠ€æœ¯åœ¨è¿œå¤æ—¶ä»£çš„ x86 è®¡ç®—æœºç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰è¿›ç¨‹éƒ½æ˜¯å…±ç”¨åŒä¸€å—ç‰©ç†å†…å­˜ç©ºé—´çš„ï¼Œè¿™æ ·ä¼šå¯¼è‡´ä¸åŒè¿›ç¨‹ä¹‹é—´çš„å†…å­˜æ— æ³•ç›¸äº’éš”ç¦»ï¼Œå½“ä¸€ä¸ªè¿›ç¨‹æ±¡æŸ“äº†åˆ«çš„è¿›ç¨‹å†…å­˜åï¼Œå°±åªèƒ½å¯¹æ•´ä¸ªç³»ç»Ÿè¿›è¡Œå¤ä½åæ‰èƒ½å¾—ä»¥æ¢å¤ã€‚\nä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä» Intel 80386 å¤„ç†å™¨å¼€å§‹ï¼Œæä¾›äº† â€œä¿æŠ¤æ¨¡å¼â€ ç”¨äºéš”ç¦»è¿›ç¨‹ï¼Œ 386 å¤„ç†å™¨çš„å…¨éƒ¨ 32 æ¡åœ°å€å¯»å€çº¿éƒ½æœ‰æ•ˆï¼Œè¿›ç¨‹å¯è®¿é—®æœ€é«˜å†…å­˜ä¹Ÿå¯è¾¾ 4 GB çš„å†…å­˜ç©ºé—´ï¼Œä½†æ­¤æ—¶å·²ä¸åŒäºä¹‹å‰å®æ¨¡å¼ä¸‹çš„ç‰©ç†å†…å­˜å¯»å€äº†ã€‚\nå¤„ç†å™¨ä¼šä½¿ç”¨åˆ†é¡µç®¡ç†æœºåˆ¶æŠŠçº¿æ€§åœ°å€ç©ºé—´å’Œç‰©ç†åœ°å€ç©ºé—´åˆ†åˆ«åˆ’åˆ†ä¸ºå¤§å°ç›¸åŒçš„å—ï¼Œè¿™æ ·çš„å†…å­˜å—è¢«ç§°ä¸ºâ€œé¡µâ€ï¼ˆPageï¼‰ã€‚\né€šè¿‡åœ¨çº¿æ€§è™šæ‹Ÿç©ºé—´çš„é¡µä¸ç‰©ç†åœ°å€ç©ºé—´çš„é¡µä¹‹é—´å»ºç«‹çš„æ˜ å°„è¡¨ï¼Œåˆ†é¡µç®¡ç†æœºåˆ¶ä¼šè¿›è¡Œçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€ç©ºé—´çš„æ˜ å°„ï¼Œå®Œæˆçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢ã€‚\nå¦‚æœè¯»è€…å¯¹è®¡ç®—æœºç»“æ„ä½“ç³»äº†è§£ä¸å¤šçš„è¯ï¼Œä¸å¦¨è®¾æƒ³è¿™æ ·ä¸€ä¸ªåœºæ™¯æ¥ç±»æ¯”ï¼šå‡å¦‚ä½ è¦å»â€œä¸­å±±ä¸€è·¯3å·â€è¿™ä¸ªåœ°å€æ‹œè®¿ä¸€ä½æœ‹å‹ï¼Œæ ¹æ®ä½ æ‰€å¤„åŸå¸‚çš„ä¸åŒï¼Œè­¬å¦‚åœ¨å¹¿å·æˆ–è€…åœ¨ä¸Šæµ·ï¼Œæ˜¯èƒ½å¤Ÿé€šè¿‡è¿™ä¸ªâ€œç›¸åŒçš„åœ°å€â€å®šä½åˆ°ä¸¤ä¸ªå®Œå…¨ç‹¬ç«‹çš„ç‰©ç†ä½ç½®çš„ï¼Œè¿™æ—¶åœ°å€ä¸ç‰©ç†ä½ç½®æ˜¯ä¸€å¯¹å¤šå…³ç³»æ˜ å°„ã€‚\nä¸åŒå±‚æ¬¡çš„è™šæ‹Ÿå†…å­˜åˆ°ç‰©ç†å†…å­˜çš„è½¬æ¢å…³ç³»å¯ä»¥åœ¨ç¡¬ä»¶å±‚é¢ã€æ“ä½œç³»ç»Ÿå±‚é¢æˆ–è€…è½¯ä»¶è¿›ç¨‹å±‚é¢å®ç°ï¼Œå¦‚ä½•å®Œæˆåœ°å€è½¬æ¢ï¼Œæ˜¯ä¸€å¯¹ä¸€ã€å¤šå¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šçš„æ˜ å°„ï¼Œä¹Ÿå¯ä»¥æ ¹æ®å®é™…éœ€è¦æ¥è®¾è®¡ã€‚\nLinux/x86-64å¹³å°ä¸Šçš„ ZGC ä½¿ç”¨äº† å¤šé‡æ˜ å°„ï¼ˆMulti-Mappingï¼‰å°†å¤šä¸ªä¸åŒçš„è™šæ‹Ÿå†…å­˜åœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€ä¸Šï¼Œè¿™æ˜¯ä¸€ç§å¤šå¯¹ä¸€æ˜ å°„ï¼Œæ„å‘³ç€ ZGC åœ¨è™šæ‹Ÿå†…å­˜ä¸­çœ‹åˆ°çš„åœ°å€ç©ºé—´è¦æ¯”å®é™…çš„å †å†…å­˜å®¹é‡æ¥å¾—æ›´å¤§ã€‚\næŠŠæŸ“è‰²æŒ‡é’ˆä¸­çš„æ ‡å¿—ä½çœ‹ä½œæ˜¯åœ°å€çš„åˆ†æ®µç¬¦ï¼Œé‚£åªè¦å°†è¿™äº›ä¸åŒçš„åœ°å€æ®µéƒ½æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜ç©ºé—´ï¼Œç»è¿‡å¤šé‡æ˜ å°„è½¬æ¢åï¼Œå°±å¯ä»¥ä½¿ç”¨æŸ“è‰²æŒ‡é’ˆæ­£å¸¸è¿›è¡Œå¯»å€äº†ã€‚\n\nåœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¤šé‡æ˜ å°„æŠ€æœ¯ç¡®å®å¯èƒ½ä¼šå¸¦æ¥ä¸€äº›è¯¸å¦‚å¤åˆ¶å¤§å¯¹è±¡æ—¶ä¼šæ›´å®¹æ˜“è¿™æ ·çš„é¢å¤–å¥½å¤„ï¼Œå¯ä»æ ¹æºä¸Šè®²ï¼ŒZGC çš„å¤šé‡æ˜ å°„åªæ˜¯å®ƒé‡‡ç”¨æŸ“è‰²æŒ‡é’ˆæŠ€æœ¯çš„ä¼´ç”Ÿäº§ç‰©ï¼Œå¹¶ä¸æ˜¯ä¸“é—¨ä¸ºäº†å®ç°å…¶ä»–æŸç§ç‰¹æ€§éœ€æ±‚è€Œå»åšçš„ã€‚\nå››ã€ZGC æ”¶é›†è¿‡ç¨‹ZGC çš„è¿ä½œè¿‡ç¨‹å¤§è‡´å¯åˆ’åˆ†ä¸ºä»¥ä¸‹å››ä¸ªå¤§çš„é˜¶æ®µã€‚\nå…¨éƒ¨å››ä¸ªé˜¶æ®µéƒ½æ˜¯å¯ä»¥å¹¶å‘æ‰§è¡Œçš„ï¼Œä»…æ˜¯ä¸¤ä¸ªé˜¶æ®µä¸­é—´ä¼šå­˜åœ¨çŸ­æš‚çš„åœé¡¿å°é˜¶æ®µï¼Œè¿™äº›å°é˜¶æ®µï¼Œè­¬å¦‚åˆå§‹åŒ– GCRoot ç›´æ¥å…³è”å¯¹è±¡çš„ MarkStartï¼Œä¸ä¹‹å‰ G1 å’Œ Shenandoah çš„ Initial Mark é˜¶æ®µå¹¶æ²¡æœ‰ä»€ä¹ˆå·®å¼‚ã€‚\n\n\nå¹¶å‘æ ‡è®°ï¼ˆConcurrent Markï¼‰ï¼šä¸ G1ã€Shenandoah ä¸€æ ·ï¼Œå¹¶å‘æ ‡è®°æ˜¯éå†å¯¹è±¡å›¾åšå¯è¾¾æ€§åˆ†æçš„é˜¶æ®µï¼Œå‰åä¹Ÿè¦ç»è¿‡ç±»ä¼¼äºG1ã€Shenandoah çš„åˆå§‹æ ‡è®°ã€æœ€ç»ˆæ ‡è®°ï¼ˆå°½ç®¡ ZGC ä¸­çš„åå­—ä¸å«è¿™äº›ï¼‰çš„çŸ­æš‚åœé¡¿ï¼Œè€Œä¸”è¿™äº›åœé¡¿é˜¶æ®µæ‰€åšçš„äº‹æƒ…åœ¨ç›®æ ‡ä¸Šä¹Ÿæ˜¯ç›¸ç±»ä¼¼çš„ã€‚ä¸ G1ã€Shenandoah ä¸åŒçš„æ˜¯ï¼ŒZGC çš„æ ‡è®°æ˜¯åœ¨æŒ‡é’ˆä¸Šè€Œä¸æ˜¯åœ¨å¯¹è±¡ä¸Šè¿›è¡Œçš„ï¼Œæ ‡è®°é˜¶æ®µä¼šæ›´æ–°æŸ“è‰²æŒ‡é’ˆä¸­çš„ Marked0ã€Marked1 æ ‡å¿—ä½ã€‚\nå¹¶å‘é¢„å¤‡é‡åˆ†é…ï¼ˆConcurrent Prepare for Relocateï¼‰ï¼šè¿™ä¸ªé˜¶æ®µéœ€è¦æ ¹æ®ç‰¹å®šçš„æŸ¥è¯¢æ¡ä»¶ç»Ÿè®¡å¾—å‡ºæœ¬æ¬¡æ”¶é›†è¿‡ç¨‹è¦æ¸…ç†å“ªäº› Regionï¼Œå°†è¿™äº› Region ç»„æˆé‡åˆ†é…é›†ï¼ˆRelocation Setï¼‰ã€‚é‡åˆ†é…é›†ä¸ G1 æ”¶é›†å™¨çš„å›æ”¶é›†ï¼ˆCollection Setï¼‰è¿˜æ˜¯æœ‰åŒºåˆ«çš„ ZGC åˆ’åˆ† Region çš„ç›®çš„å¹¶éä¸ºäº†åƒ G1 é‚£æ ·åšæ”¶ç›Šä¼˜å…ˆçš„å¢é‡å›æ”¶ã€‚ç›¸åï¼ŒZGC æ¯æ¬¡å›æ”¶éƒ½ä¼šæ‰«ææ‰€æœ‰çš„ Regionï¼Œç”¨èŒƒå›´æ›´å¤§çš„æ‰«ææˆæœ¬æ¢å–çœå» G1 ä¸­è®°å¿†é›†çš„ç»´æŠ¤æˆæœ¬ã€‚å› æ­¤ï¼ŒZGC çš„é‡åˆ†é…é›†åªæ˜¯å†³å®šäº†é‡Œé¢çš„å­˜æ´»å¯¹è±¡ä¼šè¢«é‡æ–°å¤åˆ¶åˆ°å…¶ä»–çš„ Region ä¸­ï¼Œé‡Œé¢çš„ Region ä¼šè¢«é‡Šæ”¾ï¼Œè€Œå¹¶ä¸èƒ½è¯´å›æ”¶è¡Œä¸ºå°±åªæ˜¯é’ˆå¯¹è¿™ä¸ªé›†åˆé‡Œé¢çš„ Region è¿›è¡Œï¼Œå› ä¸ºæ ‡è®°è¿‡ç¨‹æ˜¯é’ˆå¯¹å…¨å †çš„ã€‚æ­¤å¤–ï¼Œåœ¨JDK 12 çš„ ZGC ä¸­å¼€å§‹æ”¯æŒçš„ç±»å¸è½½ä»¥åŠå¼±å¼•ç”¨çš„å¤„ç†ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªé˜¶æ®µä¸­å®Œæˆçš„ã€‚\nå¹¶å‘é‡åˆ†é…ï¼ˆConcurrent Relocateï¼‰ï¼šé‡åˆ†é…æ˜¯ ZGC æ‰§è¡Œè¿‡ç¨‹ä¸­çš„æ ¸å¿ƒé˜¶æ®µï¼Œè¿™ä¸ªè¿‡ç¨‹è¦æŠŠé‡åˆ†é…é›†ä¸­çš„å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°æ–°çš„ Region ä¸Šï¼Œå¹¶ä¸ºé‡åˆ†é…é›†ä¸­çš„æ¯ä¸ª Region ç»´æŠ¤ä¸€ä¸ªè½¬å‘è¡¨ï¼ˆForward Tableï¼‰ï¼Œè®°å½•ä»æ—§å¯¹è±¡åˆ°æ–°å¯¹è±¡çš„è½¬å‘å…³ç³»ã€‚å¾—ç›ŠäºæŸ“è‰²æŒ‡é’ˆçš„æ”¯æŒï¼ŒZGC æ”¶é›†å™¨èƒ½ä»…ä»å¼•ç”¨ä¸Šå°±æ˜ç¡®å¾—çŸ¥ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å¤„äºé‡åˆ†é…é›†ä¹‹ä¸­ï¼Œå¦‚æœç”¨æˆ·çº¿ç¨‹æ­¤æ—¶å¹¶å‘è®¿é—®äº†ä½äºé‡åˆ†é…é›†ä¸­çš„å¯¹è±¡ï¼Œè¿™æ¬¡è®¿é—®å°†ä¼šè¢«é¢„ç½®çš„å†…å­˜å±éšœæ‰€æˆªè·ï¼Œç„¶åç«‹å³æ ¹æ® Region ä¸Šçš„è½¬å‘è¡¨è®°å½•å°†è®¿é—®è½¬å‘åˆ°æ–°å¤åˆ¶çš„å¯¹è±¡ä¸Šï¼Œå¹¶åŒæ—¶ä¿®æ­£æ›´æ–°è¯¥å¼•ç”¨çš„å€¼ï¼Œä½¿å…¶ç›´æ¥æŒ‡å‘æ–°å¯¹è±¡ï¼ŒZGC å°†è¿™ç§è¡Œä¸ºç§°ä¸ºæŒ‡é’ˆçš„ â€œè‡ªæ„ˆâ€ ï¼ˆSelf-Healingï¼‰èƒ½åŠ›ã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯åªæœ‰ç¬¬ä¸€æ¬¡è®¿é—®æ—§å¯¹è±¡ä¼šé™·å…¥è½¬å‘ï¼Œä¹Ÿå°±æ˜¯åªæ…¢ä¸€æ¬¡ï¼Œå¯¹æ¯” Shenandoah çš„ Brooks è½¬å‘æŒ‡é’ˆï¼Œé‚£æ˜¯æ¯æ¬¡å¯¹è±¡è®¿é—®éƒ½å¿…é¡»ä»˜å‡ºçš„å›ºå®šå¼€é”€ï¼Œç®€å•åœ°è¯´å°±æ˜¯æ¯æ¬¡éƒ½æ…¢ï¼Œå› æ­¤ ZGC å¯¹ç”¨æˆ·ç¨‹åºçš„è¿è¡Œæ—¶è´Ÿè½½è¦æ¯” Shenandoah æ¥å¾—æ›´ä½ä¸€äº›ã€‚è¿˜æœ‰å¦å¤–ä¸€ä¸ªç›´æ¥çš„å¥½å¤„æ˜¯ç”±äºæŸ“è‰²æŒ‡é’ˆçš„å­˜åœ¨ï¼Œä¸€æ—¦é‡åˆ†é…é›†ä¸­æŸä¸ª Region çš„å­˜æ´»å¯¹è±¡éƒ½å¤åˆ¶å®Œæ¯•åï¼Œè¿™ä¸ª Region å°±å¯ä»¥ç«‹å³é‡Šæ”¾ç”¨äºæ–°å¯¹è±¡çš„åˆ†é…ï¼ˆä½†æ˜¯è½¬å‘è¡¨è¿˜å¾—ç•™ç€ä¸èƒ½é‡Šæ”¾æ‰ï¼‰ï¼Œå“ªæ€•å †ä¸­è¿˜æœ‰å¾ˆå¤šæŒ‡å‘è¿™ä¸ªå¯¹è±¡çš„æœªæ›´æ–°æŒ‡é’ˆä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œè¿™äº›æ—§æŒ‡é’ˆä¸€æ—¦è¢«ä½¿ç”¨ï¼Œå®ƒä»¬éƒ½æ˜¯å¯ä»¥è‡ªæ„ˆçš„ã€‚ \nå¹¶å‘é‡æ˜ å°„ï¼ˆConcurrent Remapï¼‰ï¼šé‡æ˜ å°„æ‰€åšçš„å°±æ˜¯ä¿®æ­£æ•´ä¸ªå †ä¸­æŒ‡å‘é‡åˆ†é…é›†ä¸­æ—§å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨ï¼Œè¿™ä¸€ç‚¹ä»ç›®æ ‡è§’åº¦çœ‹æ˜¯ä¸ Shenandoah å¹¶å‘å¼•ç”¨æ›´æ–°é˜¶æ®µä¸€æ ·çš„ï¼Œä½†æ˜¯ ZGC çš„å¹¶å‘é‡æ˜ å°„å¹¶ä¸æ˜¯ä¸€ä¸ªå¿…é¡»è¦ â€œè¿«åˆ‡â€ å»å®Œæˆçš„ä»»åŠ¡ï¼Œå› ä¸ºå‰é¢è¯´è¿‡ï¼Œå³ä½¿æ˜¯æ—§å¼•ç”¨ï¼Œå®ƒä¹Ÿæ˜¯å¯ä»¥è‡ªæ„ˆçš„ï¼Œæœ€å¤šåªæ˜¯ç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶å¤šä¸€æ¬¡è½¬å‘å’Œä¿®æ­£æ“ä½œã€‚é‡æ˜ å°„æ¸…ç†è¿™äº›æ—§å¼•ç”¨çš„ä¸»è¦ç›®çš„æ˜¯ä¸ºäº†ä¸å˜æ…¢ï¼ˆè¿˜æœ‰æ¸…ç†ç»“æŸåå¯ä»¥é‡Šæ”¾è½¬å‘è¡¨è¿™æ ·çš„é™„å¸¦æ”¶ç›Šï¼‰ï¼Œæ‰€ä»¥è¯´è¿™å¹¶ä¸æ˜¯å¾ˆ â€œè¿«åˆ‡â€ã€‚å› æ­¤ï¼ŒZGC å¾ˆå·§å¦™åœ°æŠŠå¹¶å‘é‡æ˜ å°„é˜¶æ®µè¦åšçš„å·¥ä½œï¼Œåˆå¹¶åˆ°äº†ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å¾ªç¯ä¸­çš„å¹¶å‘æ ‡è®°é˜¶æ®µé‡Œå»å®Œæˆåæ­£å®ƒä»¬éƒ½æ˜¯è¦éå†æ‰€æœ‰å¯¹è±¡çš„ï¼Œè¿™æ ·åˆå¹¶å°±èŠ‚çœäº†ä¸€æ¬¡éå†å¯¹è±¡å›¾çš„å¼€é”€ã€‚ä¸€æ—¦æ‰€æœ‰æŒ‡é’ˆéƒ½è¢«ä¿®æ­£ä¹‹åï¼ŒåŸæ¥è®°å½•æ–°æ—§å¯¹è±¡å…³ç³»çš„è½¬å‘è¡¨å°±å¯ä»¥é‡Šæ”¾æ‰äº†ã€‚\n\nZGC çš„è®¾è®¡ç†å¿µä¸AzulSystemå…¬å¸çš„ PGC å’Œ C4 æ”¶é›†å™¨ä¸€è„‰ç›¸æ‰¿ï¼Œæ˜¯è¿„ä»Šåƒåœ¾æ”¶é›†å™¨ç ”ç©¶çš„æœ€å‰æ²¿æˆæœï¼Œå®ƒä¸ Shenandoah ä¸€æ ·åšåˆ°äº†å‡ ä¹æ•´ä¸ªæ”¶é›†è¿‡ç¨‹éƒ½å…¨ç¨‹å¯å¹¶å‘ï¼ŒçŸ­æš‚åœé¡¿ä¹Ÿåªä¸ GC Roots å¤§å°ç›¸å…³è€Œä¸å †å†…å­˜å¤§å°æ— å…³ï¼Œå› è€ŒåŒæ ·å®ç°äº†ä»»ä½•å †ä¸Šåœé¡¿éƒ½å°äºåæ¯«ç§’çš„ç›®æ ‡ã€‚\nç›¸æ¯” G1ã€Shenandoah ç­‰å…ˆè¿›çš„åƒåœ¾æ”¶é›†å™¨ï¼ŒZGC åœ¨å®ç°ç»†èŠ‚ä¸Šåšäº†ä¸€äº›ä¸åŒçš„æƒè¡¡é€‰æ‹©ã€‚\nè­¬å¦‚ G1 éœ€è¦é€šè¿‡å†™å±éšœæ¥ç»´æŠ¤è®°å¿†é›†ï¼Œæ‰èƒ½å¤„ç†è·¨ä»£æŒ‡é’ˆï¼Œå¾—ä»¥å®ç° Region çš„å¢é‡å›æ”¶ã€‚è®°å¿†é›†è¦å ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´ï¼Œå†™å±éšœä¹Ÿå¯¹æ­£å¸¸ç¨‹åºè¿è¡Œé€ æˆé¢å¤–è´Ÿæ‹…ï¼Œè¿™äº›éƒ½æ˜¯æƒè¡¡é€‰æ‹©çš„ä»£ä»·ã€‚\nZGCå°±å®Œå…¨æ²¡æœ‰ä½¿ç”¨è®°å¿†é›†ï¼Œå®ƒç”šè‡³è¿åˆ†ä»£éƒ½æ²¡æœ‰ï¼Œè¿åƒ CMS ä¸­é‚£æ ·åªè®°å½•æ–°ç”Ÿä»£å’Œè€å¹´ä»£é—´å¼•ç”¨çš„å¡è¡¨ä¹Ÿä¸éœ€è¦ï¼Œå› è€Œå®Œå…¨æ²¡æœ‰ç”¨åˆ°å†™å±éšœï¼Œæ‰€ä»¥ç»™ç”¨æˆ·çº¿ç¨‹å¸¦æ¥çš„è¿è¡Œè´Ÿæ‹…ä¹Ÿè¦å°å¾—å¤šã€‚\nå¯æ˜¯ï¼Œå¿…å®šè¦æœ‰ä¼˜æœ‰åŠ£æ‰ä¼šç§°ä½œæƒè¡¡ã€‚\nZGC åŠ£åŠ¿ZGC çš„è¿™ç§é€‰æ‹©ä¹Ÿé™åˆ¶äº†å®ƒèƒ½æ‰¿å—çš„å¯¹è±¡åˆ†é…é€Ÿç‡ä¸ä¼šå¤ªé«˜ï¼Œå¯ä»¥æƒ³è±¡ä»¥ä¸‹åœºæ™¯æ¥ç†è§£ ZGC çš„è¿™ä¸ªåŠ£åŠ¿ï¼š\nZGC å‡†å¤‡è¦å¯¹ä¸€ä¸ªå¾ˆå¤§çš„å †åšä¸€æ¬¡å®Œæ•´çš„å¹¶å‘æ”¶é›†ï¼Œå‡è®¾å…¶å…¨è¿‡ç¨‹è¦æŒç»­ååˆ†é’Ÿä»¥ä¸Šï¼ˆè¯·è¯»è€…åˆ‡å‹¿æ··æ·†å¹¶å‘æ—¶é—´ä¸åœé¡¿æ—¶é—´ï¼ŒZGC ç«‹çš„Flagæ˜¯åœé¡¿æ—¶é—´ä¸è¶…è¿‡åæ¯«ç§’ï¼‰ï¼Œåœ¨è¿™æ®µæ—¶é—´é‡Œé¢ï¼Œç”±äºåº”ç”¨çš„å¯¹è±¡åˆ†é…é€Ÿç‡å¾ˆé«˜ï¼Œå°†åˆ›é€ å¤§é‡çš„æ–°å¯¹è±¡ï¼Œè¿™äº›æ–°å¯¹è±¡å¾ˆéš¾è¿›å…¥å½“æ¬¡æ”¶é›†çš„æ ‡è®°èŒƒå›´ï¼Œé€šå¸¸å°±åªèƒ½å…¨éƒ¨å½“ä½œå­˜æ´»å¯¹è±¡æ¥çœ‹å¾…â€”â€”å°½ç®¡å…¶ä¸­ç»å¤§éƒ¨åˆ†å¯¹è±¡éƒ½æ˜¯æœç”Ÿå¤•ç­çš„ï¼Œè¿™å°±äº§ç”Ÿäº†å¤§é‡çš„æµ®åŠ¨åƒåœ¾ã€‚\nå¦‚æœè¿™ç§é«˜é€Ÿåˆ†é…æŒç»­ç»´æŒçš„è¯ï¼Œæ¯ä¸€æ¬¡å®Œæ•´çš„å¹¶å‘æ”¶é›†å‘¨æœŸéƒ½ä¼šå¾ˆé•¿ï¼Œå›æ”¶åˆ°çš„å†…å­˜ç©ºé—´æŒç»­å°äºæœŸé—´å¹¶å‘äº§ç”Ÿçš„æµ®åŠ¨åƒåœ¾æ‰€å çš„ç©ºé—´å †ä¸­å‰©ä½™å¯è…¾æŒªçš„ç©ºé—´å°±è¶Šæ¥è¶Šå°äº†ã€‚\nç›®å‰å”¯ä¸€çš„åŠæ³•å°±æ˜¯å°½å¯èƒ½åœ°å¢åŠ å †å®¹é‡å¤§å°ï¼Œè·å¾—æ›´å¤šå–˜æ¯çš„æ—¶é—´ã€‚ä½†æ˜¯è‹¥è¦ä»æ ¹æœ¬ä¸Šæå‡ ZGC èƒ½å¤Ÿåº”å¯¹çš„å¯¹è±¡åˆ†é…é€Ÿç‡ï¼Œè¿˜æ˜¯éœ€è¦å¼•å…¥åˆ†ä»£æ”¶é›†ï¼Œè®©æ–°ç”Ÿå¯¹è±¡éƒ½åœ¨ä¸€ä¸ªä¸“é—¨çš„åŒºåŸŸä¸­åˆ›å»ºï¼Œç„¶åä¸“é—¨é’ˆå¯¹è¿™ä¸ªåŒºåŸŸè¿›è¡Œæ›´é¢‘ç¹ã€æ›´å¿«çš„æ”¶é›†ã€‚\nAzulçš„ C4 æ”¶é›†å™¨å®ç°äº†åˆ†ä»£æ”¶é›†åï¼Œèƒ½å¤Ÿåº”å¯¹çš„å¯¹è±¡åˆ†é…é€Ÿç‡å°±æ¯”ä¸åˆ†ä»£çš„ PGC æ”¶é›†å™¨æå‡äº†åå€ä¹‹å¤šã€‚\nZGC ä¼˜ç‚¹ZGC è¿˜æœ‰ä¸€ä¸ªå¸¸åœ¨æŠ€æœ¯èµ„æ–™ä¸Šè¢«æåŠçš„ä¼˜ç‚¹æ˜¯æ”¯æŒ â€œNUMA-Awareâ€ çš„å†…å­˜åˆ†é…ã€‚\nNUMAï¼ˆNon-Uniform Memory Accessï¼Œéç»Ÿä¸€å†…å­˜è®¿é—®æ¶æ„ï¼‰æ˜¯ä¸€ç§ä¸ºå¤šå¤„ç†å™¨æˆ–è€…å¤šæ ¸å¤„ç†å™¨çš„è®¡ç®—æœºæ‰€è®¾è®¡çš„å†…å­˜æ¶æ„ã€‚\nç”±äºæ‘©å°”å®šå¾‹é€æ¸å¤±æ•ˆï¼Œç°ä»£å¤„ç†å™¨å› é¢‘ç‡å‘å±•å—é™è½¬è€Œå‘å¤šæ ¸æ–¹å‘å‘å±•ï¼Œä»¥å‰åŸæœ¬åœ¨åŒ—æ¡¥èŠ¯ç‰‡ä¸­çš„å†…å­˜æ§åˆ¶å™¨ä¹Ÿè¢«é›†æˆåˆ°äº†å¤„ç†å™¨å†…æ ¸ä¸­ï¼Œè¿™æ ·æ¯ä¸ªå¤„ç†å™¨æ ¸å¿ƒæ‰€åœ¨çš„è£¸æ™¶ï¼ˆDIEï¼‰éƒ½æœ‰å±äºè‡ªå·±å†…å­˜ç®¡ç†å™¨æ‰€ç®¡ç†çš„å†…å­˜ï¼Œå¦‚æœè¦è®¿é—®è¢«å…¶ä»–å¤–ç†å™¨æ ¸å¿ƒç®¡ç†çš„å†…å­˜ï¼Œå°±å¿…é¡»é€šè¿‡ Inter-Connect é€šé“æ¥å®Œæˆï¼Œè¿™è¦æ¯”è®¿é—®å¤„ç†å™¨çš„æœ¬åœ°å†…å­˜æ…¢å¾—å¤šã€‚\nåœ¨ NUMA æ¶æ„ä¸‹ï¼ŒZGC æ”¶é›†å™¨ä¼šä¼˜å…ˆå°è¯•åœ¨è¯·æ±‚çº¿ç¨‹å½“å‰æ‰€å¤„çš„å¤„ç†å™¨çš„æœ¬åœ°å†…å­˜ä¸Šåˆ†é…å¯¹è±¡ï¼Œä»¥ä¿è¯é«˜æ•ˆå†…å­˜è®¿é—®ã€‚\nåœ¨ ZGC ä¹‹å‰çš„æ”¶é›†å™¨å°±åªæœ‰é’ˆå¯¹ååé‡è®¾è®¡çš„ Parallel Scavenge æ”¯æŒ NUMA å†…å­˜åˆ†é…ï¼Œå¦‚ä»Š ZGC ä¹Ÿæˆä¸ºå¦å¤–ä¸€ä¸ªé€‰æ‹©ã€‚\nåœ¨æ€§èƒ½æ–¹é¢ï¼Œå°½ç®¡ç›®å‰è¿˜å¤„äºå®éªŒçŠ¶æ€ï¼Œè¿˜æ²¡æœ‰å®Œæˆæ‰€æœ‰ç‰¹æ€§ï¼Œç¨³å®šæ€§æ‰“ç£¨å’Œæ€§èƒ½è°ƒä¼˜ä¹Ÿä»åœ¨è¿›è¡Œï¼Œä½†å³ä½¿æ˜¯è¿™ç§çŠ¶æ€ä¸‹çš„ ZGCï¼Œå…¶æ€§èƒ½è¡¨ç°å·²ç»ç›¸å½“äº®çœ¼ï¼Œä»å®˜æ–¹ç»™å‡ºçš„æµ‹è¯•ç»“æœæ¥çœ‹ï¼Œç”¨ â€œä»¤äººéœ‡æƒŠçš„ã€é©å‘½æ€§çš„ ZGCâ€ æ¥å½¢å®¹éƒ½ä¸ä¸ºè¿‡ã€‚\nå›¾3-23 å’Œå›¾3-24æ˜¯ ZGC ä¸ Parallel Scavenge ã€G1 ä¸‰æ¬¾æ”¶é›†å™¨é€šè¿‡ SPECjbb 2015çš„æµ‹è¯•ç»“æœã€‚\nåœ¨ ZGC çš„ â€œå¼±é¡¹â€ ååé‡æ–¹é¢ï¼Œä»¥ä½å»¶è¿Ÿä¸ºé¦–è¦ç›®æ ‡çš„ ZGC å·²ç»è¾¾åˆ°äº†ä»¥é«˜ååé‡ä¸ºç›®æ ‡ Parallel Scavenge çš„ 99%ï¼Œç›´æ¥è¶…è¶Šäº†G1ã€‚å¦‚æœå°†ååé‡æµ‹è¯•è®¾å®šä¸ºé¢å‘ SLAï¼ˆService Level Agreementsï¼‰åº”ç”¨çš„ â€œCritical Throughputâ€ çš„è¯ï¼ŒZGC çš„è¡¨ç°ç”šè‡³è¿˜åè¶…äº† Parallel Scavenge æ”¶é›†å™¨ã€‚è€Œåœ¨ ZGC çš„å¼ºé¡¹åœé¡¿æ—¶é—´æµ‹è¯•ä¸Šï¼Œå®ƒå°±æ¯«ä¸ç•™æƒ…åœ°ä¸ Parallel Scavengeã€G1 æ‹‰å¼€äº†ä¸¤ä¸ªæ•°é‡çº§çš„å·®è·ã€‚ä¸è®ºæ˜¯å¹³å‡åœé¡¿ï¼Œè¿˜æ˜¯95%åœé¡¿ã€99%åœé¡¿ã€99.9%åœé¡¿ï¼ŒæŠ‘æˆ–æ˜¯æœ€å¤§åœé¡¿æ—¶é—´ï¼ŒZGC å‡èƒ½æ¯«ä¸è´¹åŠ²åœ°æ§åˆ¶åœ¨åæ¯«ç§’ä¹‹å†…ï¼Œä»¥è‡³äºæŠŠå®ƒå’Œå¦å¤–ä¸¤æ¬¾åœé¡¿æ•°ç™¾è¿‘åƒæ¯«ç§’çš„æ”¶é›†å™¨æ”¾åˆ°ä¸€èµ·å¯¹æ¯”ï¼Œå°±å‡ ä¹æ˜¾ç¤ºä¸äº† ZGC çš„æŸ±çŠ¶æ¡(å›¾3-24a)ï¼Œå¿…é¡»æŠŠç»“æœçš„çºµåæ ‡ä»çº¿æ€§å°ºåº¦è°ƒæ•´æˆå¯¹æ•°å°ºåº¦ï¼ˆå›¾ 3-24bï¼Œçºµåæ ‡è½´çš„å°ºåº¦æ˜¯å¯¹æ•°å¢é•¿çš„ï¼‰æ‰èƒ½è§‚å¯Ÿåˆ° ZGC çš„æµ‹è¯•ç»“æœã€‚\n\n","categories":["Java","JVM"],"tags":["æ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰"]},{"title":"è¿è¡Œæ—¶æ•°æ®åŒº","url":"/posts/53185/","content":"\n1.ç¨‹åºè®¡æ•°å™¨ç¨‹åºè®¡æ•°å™¨ æ˜¯ä¸€å—è¾ƒå°çš„å†…å­˜ç©ºé—´ï¼Œå®ƒå¯ä»¥çœ‹ä½œæ˜¯å½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚\nåœ¨ Java è™šæ‹Ÿæœºçš„æ¦‚å¿µæ¨¡å‹é‡Œï¼Œå­—èŠ‚ç è§£é‡Šå™¨å·¥ä½œæ—¶å°±æ˜¯é€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥é€‰å–ä¸‹ä¸€æ¡éœ€è¦æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ï¼Œå®ƒæ˜¯ç¨‹åºæ§åˆ¶æµçš„æŒ‡ç¤ºå™¨ï¼Œåˆ†æ”¯ã€å¾ªç¯ã€è·³è½¬ã€å¼‚å¸¸å¤„ç†ã€çº¿ç¨‹æ¢å¤ç­‰åŸºç¡€åŠŸèƒ½éƒ½éœ€è¦ä¾èµ–è¿™ä¸ªè®¡æ•°å™¨æ¥å®Œæˆã€‚\nç”±äº Java è™šæ‹Ÿæœºçš„å¤šçº¿ç¨‹æ˜¯é€šè¿‡çº¿ç¨‹è½®æµåˆ‡æ¢ã€åˆ†é…å¤„ç†å™¨æ‰§è¡Œæ—¶é—´çš„æ–¹å¼æ¥å®ç°çš„ï¼Œåœ¨ä»»ä½•ä¸€ä¸ªç¡®å®šçš„æ—¶åˆ»ï¼Œä¸€ä¸ªå¤„ç†å™¨ï¼ˆå¯¹äºå¤šæ ¸å¤„ç†å™¨æ¥è¯´æ˜¯ä¸€ä¸ªå†…æ ¸ï¼‰éƒ½åªä¼šæ‰§è¡Œä¸€æ¡çº¿ç¨‹ä¸­çš„æŒ‡ä»¤ã€‚\nå› æ­¤ï¼Œä¸ºäº†çº¿ç¨‹åˆ‡æ¢åèƒ½æ¢å¤åˆ°æ­£ç¡®çš„æ‰§è¡Œä½ç½®ï¼Œæ¯æ¡çº¿ç¨‹éƒ½éœ€è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºè®¡æ•°å™¨ï¼Œå„æ¡çº¿ç¨‹ä¹‹é—´è®¡æ•°å™¨äº’ä¸å½±å“ï¼Œç‹¬ç«‹å­˜å‚¨ï¼Œæˆ‘ä»¬ç§°è¿™ç±»å†…å­˜åŒºåŸŸä¸º â€œçº¿ç¨‹ç§æœ‰â€ çš„å†…å­˜ã€‚\nå¦‚æœçº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ª Java æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨è®°å½•çš„æ˜¯ æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ã€‚\nå¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯æœ¬åœ°æ–¹æ³•ï¼Œè¿™ä¸ªè®¡æ•°å™¨å€¼ä¸ºç©ºï¼ˆUndefinedï¼‰ã€‚\nå¼‚å¸¸çŠ¶å†µæ­¤å†…å­˜åŒºåŸŸæ˜¯å”¯ä¸€ä¸€ä¸ªåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æ²¡æœ‰è§„å®šä»»ä½• OutOfMemoryError æƒ…å†µçš„åŒºåŸŸã€‚\n2.Java è™šæ‹Ÿæœºæ ˆJava è™šæ‹Ÿæœºæ ˆæ˜¯çº¿ç¨‹ç§æœ‰çš„ï¼Œç”Ÿå‘½å‘¨æœŸä¸çº¿ç¨‹ç›¸åŒã€‚\nè™šæ‹Ÿæœºæ ˆæè¿°çš„æ˜¯ Java æ–¹æ³•æ‰§è¡Œçš„çº¿ç¨‹å†…å­˜æ¨¡å‹ï¼š\næ¯ä¸ªæ–¹æ³•è¢«æ‰§è¡Œçš„æ—¶å€™ï¼ŒJava è™šæ‹Ÿæœºéƒ½ä¼šåŒæ­¥åˆ›å»ºä¸€ä¸ª æ ˆå¸§ ç”¨äºå­˜å‚¨ å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ ç­‰ä¿¡æ¯ã€‚\næ¯ä¸€ä¸ªæ ˆå¸§è¢«è°ƒç”¨ç›´è‡³æ‰§è¡Œå®Œæ¯•çš„è¿‡ç¨‹ï¼Œå°±å¯¹åº”ç€ä¸€ä¸ªæ ˆå¸§åœ¨è™šæ‹Ÿæœºæ ˆä¸­ä»å…¥æ ˆåˆ°å‡ºæ ˆçš„è¿‡ç¨‹ã€‚\nå±€éƒ¨å˜é‡è¡¨å±€éƒ¨å˜é‡è¡¨ å­˜æ”¾äº†ç¼–è¯‘æœŸå¯çŸ¥çš„å„ç§ Java è™šæ‹ŸæœºåŸºæœ¬æ•°æ®ç±»å‹ï¼ˆbooleanã€byteã€charã€shortã€intã€floatã€longã€doubleï¼‰ã€å¯¹è±¡å¼•ç”¨ï¼ˆreferenceç±»å‹ï¼Œå®ƒå¹¶ä¸ç­‰åŒäºå¯¹è±¡æœ¬èº«ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªæŒ‡å‘å¯¹è±¡èµ·å§‹åœ°å€çš„å¼•ç”¨æŒ‡é’ˆï¼Œä¹Ÿå¯èƒ½æ˜¯æŒ‡å‘ä¸€ä¸ªä»£è¡¨å¯¹è±¡çš„å¥æŸ„æˆ–è€…å…¶ä»–ä¸æ­¤å¯¹è±¡ç›¸å…³çš„ä½ç½®ï¼‰å’Œ returnAddress ç±»å‹ ï¼ˆæŒ‡å‘äº†ä¸€æ¡å­—èŠ‚ç æŒ‡ä»¤çš„åœ°å€ï¼‰ã€‚\nè¿™äº›æ•°æ®ç±»å‹åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­çš„å­˜å‚¨ç©ºé—´ä»¥ å±€éƒ¨å˜é‡æ§½ï¼ˆSlotï¼‰ æ¥è¡¨ç¤ºã€‚\nlong å’Œ double ç±»å‹çš„æ•°æ®ä¼šå ç”¨ä¸¤ä¸ªå˜é‡æ§½ï¼Œå…¶ä½™çš„ç±»å‹åªå ç”¨ä¸€ä¸ªã€‚\nå±€éƒ¨å˜é‡æ‰€éœ€çš„å†…å­˜ç©ºé—´åœ¨ç¼–è¯‘æœŸé—´å®Œæˆåˆ†é…ï¼Œå½“è¿›å…¥ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œè¿™ä¸ªæ–¹æ³•éœ€è¦åœ¨æ ˆå¸§ä¸­åˆ†é…å¤šå¤§çš„å±€éƒ¨å˜é‡ç©ºé—´æ˜¯å®Œå…¨ç¡®å®šçš„ï¼Œåœ¨æ–¹æ³•è¿è¡ŒæœŸé—´ä¸ä¼šæ”¹å˜å±€éƒ¨å˜é‡è¡¨çš„å¤§å°ã€‚\nè¿™é‡Œè¯´çš„ â€œå¤§å°â€ æ˜¯æŒ‡å˜é‡æ§½çš„æ•°é‡ã€‚\nè™šæ‹ŸæœºçœŸæ­£ä½¿ç”¨å¤šå¤§çš„å†…å­˜ç©ºé—´æ¥å®ç°ä¸€ä¸ªå˜é‡æ§½ï¼Œè­¬å¦‚æŒ‰ç…§1ä¸ªå˜é‡æ§½å ç”¨32ä¸ªæ¯”ç‰¹ã€64ä¸ªæ¯”ç‰¹ï¼Œæˆ–è€…æ›´å¤šï¼Œè¿™å®Œå…¨ç”±å…·ä½“çš„è™šæ‹Ÿæœºå®ç°è‡ªè¡Œå†³å®šã€‚\nå¼‚å¸¸çŠ¶å†µåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­ï¼Œå¯¹è¿™ä¸ªå†…å­˜åŒºåŸŸè§„å®šäº†ä¸¤ç±»å¼‚å¸¸çŠ¶å†µï¼š\n\nStackOverflowErrorï¼šçº¿ç¨‹è¯·æ±‚çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºæ‰€å…è®¸çš„æ·±åº¦ï¼›\nOutOfMemoryErrorï¼šå¦‚æœJavaè™šæ‹Ÿæœºæ ˆå®¹é‡å¯ä»¥åŠ¨æ€æ‰©å±•ï¼Œå½“æ ˆæ‰©å±•æ—¶æ— æ³•ç”³è¯·åˆ°è¶³å¤Ÿçš„å†…å­˜ä¼šæŠ›å‡ºã€‚\n\n\nHotSpot è™šæ‹Ÿæœºçš„æ ˆå®¹é‡æ˜¯ä¸å¯ä»¥åŠ¨æ€æ‰©å±•çš„ï¼Œä»¥å‰çš„ Classic è™šæ‹Ÿæœºå€’æ˜¯å¯ä»¥ã€‚\næ‰€ä»¥åœ¨ HotSpot è™šæ‹Ÿæœºä¸Šæ˜¯ä¸ä¼šç”±äºè™šæ‹Ÿæœºæ ˆæ— æ³•æ‰©å±•è€Œå¯¼è‡´ OutOfMemoryError å¼‚å¸¸ â€”â€”åªè¦çº¿ç¨‹ç”³è¯·æ ˆç©ºé—´æˆåŠŸäº†å°±ä¸ä¼šæœ‰ OOMã€‚\nä½†æ˜¯å¦‚æœç”³è¯·æ—¶å°±å¤±è´¥äº†ï¼Œä»ç„¶ä¼šå‡ºç° OOMå¼‚å¸¸ã€‚\n\n3.Java å †Java å †æ˜¯è™šæ‹Ÿæœºæ‰€ç®¡ç†çš„å†…å­˜ä¸­æœ€å¤§çš„ä¸€å—ã€‚\nJava å †æ˜¯è¢«æ‰€æœ‰çº¿ç¨‹å…±äº«çš„ä¸€å—å†…å­˜åŒºåŸŸï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚\næ­¤å†…å­˜åŒºåŸŸçš„å”¯ä¸€ç›®çš„å°±æ˜¯å­˜æ”¾å¯¹è±¡å®ä¾‹ï¼Œâ€œå‡ ä¹â€æ‰€æœ‰çš„ å¯¹è±¡å®ä¾‹éƒ½åœ¨è¿™é‡Œåˆ†é…å†…å­˜ã€‚\nåœ¨ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å¯¹Javaå †çš„æè¿°æ˜¯ï¼šæ‰€æœ‰çš„å¯¹è±¡å®ä¾‹ä»¥åŠæ•°ç»„éƒ½åº”å½“åœ¨å †ä¸Šåˆ†é…ã€‚\nè¿™é‡Œçš„ å‡ ä¹ æ˜¯æŒ‡ä»å®ç°è§’åº¦çœ‹ï¼Œéšç€Javaè¯­è¨€çš„å‘å±•ï¼Œç°åœ¨å·²ç»èƒ½çœ‹åˆ°äº›è®¸è¿¹è±¡è¡¨æ˜æ—¥åå¯èƒ½å‡ºç°å€¼ç±»å‹çš„æ”¯æŒï¼Œå³ä½¿å€¼è€ƒè™‘ç°åœ¨ï¼Œç”±äºå³æ—¶ç¼–è¯‘æŠ€æœ¯çš„è¿›æ­¥ï¼Œå°¤å…¶æ˜¯é€ƒé€¸åˆ†ææŠ€æœ¯çš„æ—¥æ¸å¼ºå¤§ï¼Œæ ˆä¸Šåˆ†é…ã€æ ‡é‡æ›¿æ¢ä¼˜åŒ–æ‰‹æ®µå·²ç»å¯¼è‡´ä¸€äº›å¾®å¦™çš„å˜åŒ–æ‚„ç„¶å‘ç”Ÿï¼Œæ‰€ä»¥è¯´Javaå¯¹è±¡å®ä¾‹éƒ½åˆ†é…åœ¨å †ä¸Šä¹Ÿæ¸æ¸å˜å¾—ä¸æ˜¯é‚£ä¹ˆç»å¯¹äº†ã€‚\næ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼ŒJavaå †å¯ä»¥å¤„äºç‰©ç†ä¸Šä¸è¿ç»­çš„å†…å­˜ç©ºé—´ä¸­ï¼Œä½†åœ¨é€»è¾‘ä¸Šå®ƒåº”è¯¥è¢«è§†ä¸ºè¿ç»­çš„ã€‚\nè¿™ç‚¹å°±åƒæˆ‘ä»¬ç”¨ç£ç›˜ç©ºé—´å»å­˜å‚¨æ–‡ä»¶ä¸€æ ·ï¼Œå¹¶ä¸è¦æ±‚æ¯ä¸ªæ–‡ä»¶éƒ½è¿ç»­å­˜æ”¾ã€‚\nä½†å¯¹äºå¤§å¯¹è±¡ï¼ˆå¦‚æ•°ç»„å¯¹è±¡ï¼‰ï¼Œå¤šæ•°è™šæ‹Ÿæœºå®ç°å‡ºäºå®ç°ç®€å•ã€å­˜å‚¨é«˜æ•ˆçš„è€ƒè™‘ï¼Œå¾ˆå¯èƒ½ä¼šè¦æ±‚è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚\nå¼‚å¸¸çŠ¶å†µå¦‚æœåœ¨Javaå †ä¸­æ²¡æœ‰å†…å­˜å®Œæˆå®ä¾‹åˆ†é…ï¼Œå¹¶ä¸”å †ä¹Ÿæ— æ³•å†æ‰©å±•æ—¶ï¼ŒJavaè™šæ‹Ÿæœºå°†ä¼šæŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚\n4.æ–¹æ³•åŒºæ–¹æ³•åŒºæ˜¯å„ä¸ªçº¿ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºå­˜å‚¨ å·²è¢«è™šæ‹ŸæœºåŠ è½½çš„ç±»å‹ä¿¡æ¯ã€å¸¸é‡ã€é™æ€å˜é‡ã€å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘åçš„ä»£ç ç¼“å­˜ ç­‰æ•°æ®ã€‚\nã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­æŠŠæ–¹æ³•åŒºæè¿°ä¸º å †çš„ä¸€ä¸ªé€»è¾‘åˆ†åŒºï¼Œä½†ä»–å´æœ‰ä¸€ä¸ªåˆ«åå«ä½œ â€œéå †â€ï¼ˆNon-Heapï¼‰ï¼Œç›®çš„æ˜¯ä¸Javaå †åŒºåˆ†å¼€ã€‚\nä¸æ°¸ä¹…ä»£çš„åŒºåˆ«æ°¸ä¹…ä»£ä¸æ–¹æ³•åŒºæœ¬è´¨ä¸Šå¹¶ä¸æ˜¯ç­‰ä»·çš„ï¼Œå› ä¸ºä»…ä»…æ˜¯å½“æ—¶çš„ HotSpot è™šæ‹Ÿæœºè®¾è®¡å›¢é˜Ÿé€‰æ‹©æŠŠæ”¶é›†å™¨çš„åˆ†ä»£è®¾è®¡æ‰©å±•è‡³æ–¹æ³•åŒºï¼Œæˆ–è€…è¯´ä½¿ç”¨æ°¸ä¹…ä»£æ¥å®ç°æ–¹æ³•åŒºè€Œå·²ã€‚\nè¿™æ ·åšæ˜¯çš„ HotSpot çš„åƒåœ¾æ”¶é›†å™¨èƒ½å¤Ÿåƒç®¡ç†Javaå †ä¸€æ ·ç®¡ç†è¿™éƒ¨åˆ†å†…å­˜ï¼Œçœå»ä¸“é—¨ä¸ºæ–¹æ³•åŒºç¼–å†™å†…å­˜ç®¡ç†ä»£ç çš„å·¥ä½œã€‚\nåœ¨ JDK 6 çš„æ—¶å€™ HotSpot å¼€å‘å›¢é˜Ÿå°±æœ‰æ”¾å¼ƒæ°¸ä¹…ä»£ï¼Œé€æ­¥æ”¹ä¸ºé‡‡ç”¨æœ¬åœ°å†…å­˜ï¼ˆNative Memoryï¼‰æ¥å®ç°æ–¹æ³•åŒºçš„è®¡åˆ’äº†ã€‚\nJDK 7 æ—¶ï¼ŒæŠŠåŸæœ¬æ”¾åœ¨æ°¸ä¹…ä»£çš„ å­—ç¬¦ä¸²å¸¸é‡æ± ã€é™æ€å˜é‡ ç­‰ç§»è‡³ç§»è‡³Javaå †ä¸­ã€‚\nJDK 8 æ—¶ï¼Œå®Œå…¨æ”¾å¼ƒäº†æ°¸ä¹…ä»£çš„æ¦‚å¿µï¼Œç”¨åœ¨æœ¬åœ°å†…å­˜ä¸­å®ç°çš„ å…ƒç©ºé—´ï¼ˆMeta-spaceï¼‰æ¥ä»£æ›¿ï¼ŒæŠŠ JDK 7 ä¸­æ°¸ä¹…ä»£è¿˜å‰©ä½™çš„å†…å®¹ï¼ˆä¸»è¦æ˜¯ç±»å‹ä¿¡æ¯ï¼‰å…¨éƒ¨ç§»åˆ°å…ƒç©ºé—´ä¸­äº†ã€‚\nè¿è¡Œæ—¶å¸¸é‡æ± è¿è¡Œæ—¶å¸¸é‡æ± æ˜¯æ–¹æ³•åŒºçš„ä¸€éƒ¨åˆ†ã€‚\nClass æ–‡ä»¶ä¸­é™¤äº†æœ‰ç±»çš„ç‰ˆæœ¬ã€å­—æ®µã€æ–¹æ³•ã€æ¥å£ç­‰æè¿°ä¿¡æ¯å¤–ï¼Œè¿˜æœ‰ä¸€é¡¹ä¿¡æ¯æ˜¯ å¸¸é‡æ± è¡¨ï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ä¸ç¬¦å·å¼•ç”¨ï¼Œè¿™éƒ¨åˆ†å†…å®¹å°†åœ¨ç±»åŠ è½½åå­˜æ”¾åˆ°æ–¹æ³•åŒºçš„è¿è¡Œæ—¶å¸¸é‡æ± ã€‚\né™¤äº†ä¿å­˜ Class æ–‡ä»¶ä¸­æè¿°çš„ç¬¦å·å¼•ç”¨å¤–ï¼Œè¿˜ä¼šæŠŠ ç”±ç¬¦å·å¼•ç”¨ç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨ä¹Ÿå­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ã€‚\nå¼‚å¸¸çŠ¶å†µæ ¹æ®ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹çš„è§„å®šï¼Œå¦‚æœæ–¹æ³•åŒºæ— æ³•æ»¡è¶³æ–°çš„å†…å­˜åˆ†é…éœ€æ±‚æ—¶ï¼Œå°†æŠ›å‡º OutOfMemoryError å¼‚å¸¸ã€‚\n5.ç›´æ¥å†…å­˜ç›´æ¥å†…å­˜ï¼ˆDirect Memoryï¼‰å¹¶ä¸æ˜¯è™šæ‹Ÿæœºè¿è¡Œæ—¶æ•°æ®åŒºçš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¸æ˜¯ã€ŠJavaè™šæ‹Ÿæœºè§„èŒƒã€‹ä¸­å®šä¹‰çš„å†…å­˜åŒºåŸŸã€‚\nä½†æ˜¯è¿™éƒ¨åˆ†å†…å­˜ä¹Ÿè¢«é¢‘ç¹ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿå¯èƒ½å¯¼è‡´ OutOfMemoryError å¼‚å¸¸å‡ºç°ã€‚\nåœ¨ JDK 1.4 ä¸­æ–°åŠ å…¥çš„ NIO ç±»ï¼Œå¼•å…¥äº†ä¸€ç§åŸºäºé€šé“ï¼ˆChannelï¼‰å¯¹äºç¼“å†²åŒºï¼ˆBufferï¼‰çš„ I/O æ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨ Native å‡½æ•°åº“ç›´æ¥åˆ†é…å¯¹å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †é‡Œé¢çš„ DirectByteBuffer å¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚è¿™æ ·èƒ½åœ¨ä¸€äº›åœºæ™¯æ€»æ˜¾è‘—æé«˜æ€§èƒ½ï¼Œå› ä¸ºé¿å…äº†åœ¨Javaå †å’ŒNativeå †ä¸­æ¥å›å¤åˆ¶æ•°æ®ã€‚\næ˜¾ç„¶ï¼Œæœ¬æœºç›´æ¥å†…å­˜çš„åˆ†é…ä¸ä¼šå—åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ï¼Œæ—¢ç„¶æ˜¯å†…å­˜ï¼Œåˆ™è‚¯å®šä¼šæ”¶åˆ°æœ¬æœºæ€»å†…å­˜ï¼ˆåŒ…æ‹¬ç‰©ç†å†…å­˜ã€SWAPåˆ†åŒºæˆ–è€…åˆ†é¡µæ–‡ä»¶ï¼‰å¤§å°ä»¥åŠå¤„ç†å™¨å¯»å€ç©ºé—´çš„é™åˆ¶ï¼Œä¸€èˆ¬æœåŠ¡å™¨ç®¡ç†å‘˜é…ç½®è™šæ‹Ÿæœºå‚æ•°æ—¶ï¼Œä¼šæ ¹æ®å®é™…å†…å­˜å»è®¾ç½® -Xmx ç­‰å‚æ•°ä¿¡æ¯ï¼Œä½†ç»å¸¸å¿½ç•¥æ‰ç›´æ¥å†…å­˜ï¼Œä½¿å¾—å„ä¸ªå†…å­˜åŒºåŸŸæ€»å’Œå¤§äºç‰©ç†å†…å­˜é™åˆ¶ï¼ˆåŒ…æ‹¬ç‰©ç†çš„å’Œæ“ä½œç³»ç»Ÿçº§çš„é™åˆ¶ï¼‰ï¼Œä»è€Œå¯¼è‡´åŠ¨æ€æ‰©å±•æ—¶å‡ºç° OutOfMemoryError å¼‚å¸¸ã€‚\n","categories":["Java","JVM"],"tags":["æ·±å…¥ç†è§£JVMè™šæ‹Ÿæœºï¼ˆç¬¬ä¸‰ç‰ˆï¼‰"]},{"title":"Containerd å‘½ä»¤","url":"/posts/6486/","content":"ä¸€ã€ctr å‘½ä»¤\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\nctr image ls\næŸ¥çœ‹é•œåƒ\n\n\nctr task ls\næ­£åœ¨è¿è¡Œçš„é•œåƒ\n\n\näºŒã€crictl å‘½ä»¤é•œåƒç›¸å…³\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ncrictl images\næŸ¥çœ‹é•œåƒ\n\n\ncrictl pull\næ‹‰å–é•œåƒ\n\n\ncrictl rmi\nåˆ é™¤é•œåƒ\n\n\ncrictl inspecti -o yaml\né•œåƒè¯¦æƒ…\n\n\nå®¹å™¨ç›¸å…³\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ncrictl ps\næ­£åœ¨è¿è¡Œçš„å®¹å™¨åˆ—è¡¨\n\n\ncrictl inspect -o yaml\nå®¹å™¨è¯¦æƒ…\n\n\ncrictl create\nåˆ›å»ºå®¹å™¨\n\n\ncrictl start\nå¯åŠ¨å®¹å™¨\n\n\ncrictl stop\nåœæ­¢å®¹å™¨\n\n\ncrictl rm\nåˆ é™¤å®¹å™¨\n\n\ncrictl attach\nattach\n\n\ncrictl exec\nexec\n\n\ncrictl logs\næ—¥å¿—\n\n\ncrictl stats\nstats\n\n\nPOD ç›¸å…³\n\n\nå‘½ä»¤\nä½œç”¨\n\n\n\ncrictl pods\nPOD åˆ—è¡¨\n\n\ncrictl inspectp -o yaml\nPOD è¯¦æƒ…\n\n\ncrictl runp\nè¿è¡Œ POD\n\n\ncrictl stopp\nåœæ­¢ POD\n\n\n","categories":["è¿ç»´","Containerd"]},{"title":"Alpine","url":"/posts/36793/","content":"ç®€ä»‹Alpine æ“ä½œç³»ç»Ÿæ˜¯ä¸€ä¸ªé¢å‘å®‰å…¨çš„è½»å‹ Linux å‘è¡Œç‰ˆã€‚\nå®ƒä¸åŒäºé€šå¸¸ Linux å‘è¡Œç‰ˆï¼ŒAlpine é‡‡ç”¨äº† musl libc å’Œ busybox ä»¥å‡å°ç³»ç»Ÿçš„ä½“ç§¯å’Œè¿è¡Œæ—¶èµ„æºæ¶ˆè€—ï¼Œä½†åŠŸèƒ½ä¸Šæ¯” busybox åˆå®Œå–„çš„å¤šï¼Œå› æ­¤å¾—åˆ°å¼€æºç¤¾åŒºè¶Šæ¥è¶Šå¤šçš„é’çã€‚\nåœ¨ä¿æŒç˜¦èº«çš„åŒæ—¶ï¼ŒAlpine è¿˜æä¾›äº†è‡ªå·±çš„åŒ…ç®¡ç†å·¥å…· apkï¼Œå¯ä»¥é€šè¿‡ https://pkgs.alpinelinux.org/packages ç½‘ç«™ä¸ŠæŸ¥è¯¢åŒ…ä¿¡æ¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥é€šè¿‡ apk å‘½ä»¤ç›´æ¥æŸ¥è¯¢å’Œå®‰è£…å„ç§è½¯ä»¶ã€‚\nAlpine ç”±éå•†ä¸šç»„ç»‡ç»´æŠ¤çš„ï¼Œæ”¯æŒå¹¿æ³›åœºæ™¯çš„ Linuxå‘è¡Œç‰ˆï¼Œå®ƒç‰¹åˆ«ä¸ºèµ„æ·±/é‡åº¦Linuxç”¨æˆ·è€Œä¼˜åŒ–ï¼Œå…³æ³¨å®‰å…¨ï¼Œæ€§èƒ½å’Œèµ„æºæ•ˆèƒ½ã€‚Alpine é•œåƒå¯ä»¥é€‚ç”¨äºæ›´å¤šå¸¸ç”¨åœºæ™¯ï¼Œå¹¶ä¸”æ˜¯ä¸€ä¸ªä¼˜ç§€çš„å¯ä»¥é€‚ç”¨äºç”Ÿäº§çš„åŸºç¡€ç³»ç»Ÿ/ç¯å¢ƒã€‚\nAlpine Docker é•œåƒä¹Ÿç»§æ‰¿äº† Alpine Linux å‘è¡Œç‰ˆçš„è¿™äº›ä¼˜åŠ¿ã€‚ç›¸æ¯”äºå…¶ä»– Docker é•œåƒï¼Œå®ƒçš„å®¹é‡éå¸¸å°ï¼Œä»…ä»…åªæœ‰ 5 MB å·¦å³ï¼ˆå¯¹æ¯” Ubuntu ç³»åˆ—é•œåƒæ¥è¿‘ 200 MBï¼‰ï¼Œä¸”æ‹¥æœ‰éå¸¸å‹å¥½çš„åŒ…ç®¡ç†æœºåˆ¶ã€‚å®˜æ–¹é•œåƒæ¥è‡ª docker-alpine é¡¹ç›®ã€‚\nç›®å‰ Docker å®˜æ–¹å·²å¼€å§‹æ¨èä½¿ç”¨ Alpine æ›¿ä»£ä¹‹å‰çš„ Ubuntu åšä¸ºåŸºç¡€é•œåƒç¯å¢ƒã€‚è¿™æ ·ä¼šå¸¦æ¥å¤šä¸ªå¥½å¤„ã€‚åŒ…æ‹¬é•œåƒä¸‹è½½é€Ÿåº¦åŠ å¿«ï¼Œé•œåƒå®‰å…¨æ€§æé«˜ï¼Œä¸»æœºä¹‹é—´çš„åˆ‡æ¢æ›´æ–¹ä¾¿ï¼Œå ç”¨æ›´å°‘ç£ç›˜ç©ºé—´ç­‰ã€‚\nä¸‹è¡¨æ˜¯å®˜æ–¹é•œåƒçš„å¤§å°æ¯”è¾ƒï¼š\nREPOSITORY          TAG           IMAGE ID          VIRTUAL SIZEalpine              latest        4e38e38c8ce0      4.799 MBdebian              latest        4d6ce913b130      84.98 MBubuntu              latest        b39b81afc8ca      188.3 MBcentos              latest        8efe422e6104      210 MB\n\nè·å–å¹¶ä½¿ç”¨å®˜æ–¹é•œåƒç”±äºé•œåƒå¾ˆå°ï¼Œä¸‹è½½æ—¶é—´å¾€å¾€å¾ˆçŸ­ï¼Œè¯»è€…å¯ä»¥ç›´æ¥ä½¿ç”¨ docker run æŒ‡ä»¤ç›´æ¥è¿è¡Œä¸€ä¸ª Alpine å®¹å™¨ï¼Œå¹¶æŒ‡å®šè¿è¡Œçš„ Linux æŒ‡ä»¤ï¼Œä¾‹å¦‚ï¼š\ndocker run alpine echo &#x27;123&#x27;123\n\n\n\ndocker run --rm -it --entrypoint /bin/sh alpine\n\nè¿ç§»è‡³ Alpine åŸºç¡€é•œåƒç›®å‰ï¼Œå¤§éƒ¨åˆ† Docker å®˜æ–¹é•œåƒéƒ½å·²ç»æ”¯æŒ Alpine ä½œä¸ºåŸºç¡€é•œåƒï¼Œå¯ä»¥å¾ˆå®¹æ˜“è¿›è¡Œè¿ç§»ã€‚\nä¾‹å¦‚ï¼š\n\nubuntu/debian -&gt; alpine\npython:3 -&gt; python:3-alpine\nruby:2.6 -&gt; ruby:2.6-alpine\n\nå¦å¤–ï¼Œå¦‚æœä½¿ç”¨ Alpine é•œåƒæ›¿æ¢ Ubuntu åŸºç¡€é•œåƒï¼Œå®‰è£…è½¯ä»¶åŒ…æ—¶éœ€è¦ç”¨ apk åŒ…ç®¡ç†å™¨æ›¿æ¢ apt å·¥å…·ï¼Œå¦‚\napk add --no-cache &lt;package&gt;\n\nAlpine ä¸­è½¯ä»¶å®‰è£…åŒ…çš„åå­—å¯èƒ½ä¼šä¸å…¶ä»–å‘è¡Œç‰ˆæœ‰æ‰€ä¸åŒï¼Œå¯ä»¥åœ¨ https://pkgs.alpinelinux.org/packages ç½‘ç«™æœç´¢å¹¶ç¡®å®šå®‰è£…åŒ…åç§°ã€‚å¦‚æœéœ€è¦çš„å®‰è£…åŒ…ä¸åœ¨ä¸»ç´¢å¼•å†…ï¼Œä½†æ˜¯åœ¨æµ‹è¯•æˆ–ç¤¾åŒºç´¢å¼•ä¸­ã€‚é‚£ä¹ˆå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ–¹æ³•ä½¿ç”¨è¿™äº›å®‰è£…åŒ…ã€‚\n$ echo &quot;http://dl-cdn.alpinelinux.org/alpine/edge/testing&quot; &gt;&gt; /etc/apk/repositories$ apk --update add --no-cache &lt;package&gt;\n\nç”±äºåœ¨å›½å†…è®¿é—® apk ä»“åº“è¾ƒç¼“æ…¢ï¼Œå»ºè®®åœ¨ä½¿ç”¨ apk ä¹‹å‰å…ˆæ›¿æ¢ä»“åº“åœ°å€ä¸ºå›½å†…é•œåƒã€‚\nRUN sed -i &quot;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&quot; /etc/apk/repositories \\      &amp;&amp; apk add --no-cache &lt;package&gt;\n\nç›¸å…³èµ„æº\nAlpine å®˜ç½‘ï¼šhttps://www.alpinelinux.org/\nAlpine å®˜æ–¹ä»“åº“ï¼šhttps://github.com/alpinelinux\nAlpine å®˜æ–¹é•œåƒï¼šhttps://hub.docker.com/_/alpine/\nAlpine å®˜æ–¹é•œåƒä»“åº“ï¼šhttps://github.com/gliderlabs/docker-alpine\n\n","categories":["è¿ç»´","Docker"]},{"title":"Docker Desktop for Mac å®¹å™¨è®¿é—®å®¿ä¸»æœºIP","url":"/posts/62365/","content":"æ–‡æ¡£åœ°å€ï¼šhttps://dockerdocs.cn/docker-for-mac/networking/\nä¸»æœºçš„IPåœ°å€æ­£åœ¨æ›´æ”¹ï¼ˆå¦‚æœæ²¡æœ‰ç½‘ç»œè®¿é—®æƒé™ï¼Œåˆ™æ²¡æœ‰IPåœ°å€ï¼‰ã€‚æˆ‘ä»¬å»ºè®®æ‚¨è¿æ¥åˆ°ç‰¹æ®Šçš„DNSåç§° host.docker.internal\nè¯¥åç§° è§£æä¸ºä¸»æœºä½¿ç”¨çš„å†…éƒ¨IPåœ°å€\nè¿™æ˜¯å‡ºäºå¼€å‘ç›®çš„ï¼Œä¸é€‚ç”¨äºDocker Desktop for Macä»¥å¤–çš„ç”Ÿäº§ç¯å¢ƒã€‚\n","categories":["è¿ç»´","Docker"]},{"title":"Dockerfile ç¯å¢ƒå˜é‡é…ç½®Javaå¯åŠ¨å‚æ•°","url":"/posts/6088/","content":"ENTRYPOINT [&quot;sh&quot;,&quot;-c&quot;,&quot;java $&#123;JAVA_OPTS&#125; -jar /opt/app.jar&quot;]\næˆ–è€…\nENTRYPOINT java $&#123;JAVA_OPTS&#125; -jar /opt/app.jar\n\nè¿™ç§æ–¹å¼ä¸ä¼šæ›¿æ¢ç¯å¢ƒå˜é‡\nENTRYPOINT [&quot;java&quot;,&quot;$&#123;JAVA_OPTS&#125;&quot;,&quot;-jar&quot;,&quot;app.jar&quot;]\n","categories":["è¿ç»´","Docker"]},{"title":"Docker éƒ¨ç½² Kafka","url":"/posts/30060/","content":"ä¸€ã€å®‰è£…Zookeeperdocker run -d -e TZ=&quot;Asia/Shanghai&quot; -p 2181:2181 --name zk zookeeper\näºŒã€å®‰è£…Kafkadocker run  -d --name kafka -p 9092:9092 \\\t--link zk \\\t-e KAFKA_BROKER_ID=0 \\\t-e KAFKA_ZOOKEEPER_CONNECT=zk:2181/kafka \\\t-e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://127.0.0.1:9092 \\\t-e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 \\\twurstmeister/kafka\nKAFKA_LISTENERS å’Œ KAFKA_ADVERTISED_LISTENERS å‚æ•°å«ä¹‰\nä¸‰ã€æµ‹è¯•1.è¿›å…¥å®¹å™¨docker exec -it kafka bash\n\n2.å¯åŠ¨ç”Ÿäº§è€…./opt/kafka_2.13-2.7.1/bin/kafka-console-producer.sh --broker-list localhost:9092 --topic test\n\n3.å¯åŠ¨æ¶ˆè´¹è€…å¦å¼€ä¸€ä¸ªç»ˆç«¯è¿›å…¥å®¹å™¨\n./opt/kafka_2.13-2.7.1/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 -topic test --from-beginning\n\n4.å‘é€æ¶ˆæ¯åœ¨ç”Ÿäº§è€…ä¸­è¾“å…¥æ¶ˆæ¯ï¼Œåœ¨æ¶ˆè´¹è€…ä¸­èƒ½æ¥å—åˆ°æ¶ˆæ¯å³ä¸ºæ­£å¸¸ã€‚\n","categories":["è¿ç»´","Kafka"]},{"title":"Kafka æ ¸å¿ƒé…ç½®","url":"/posts/59696/","content":"ä¸€ã€producer æ ¸å¿ƒé…ç½®Producer é…ç½®å®˜æ–¹æ–‡æ¡£\n1ã€acks ï¼šå‘é€åº”ç­”ï¼ˆé»˜è®¤å€¼ï¼š1ï¼‰ç”Ÿäº§è€…åœ¨è€ƒè™‘å®Œæˆè¯·æ±‚ä¹‹å‰è¦æ±‚leaderæ”¶åˆ°çš„ç¡®è®¤çš„æ•°é‡ã€‚è¿™æ§åˆ¶äº†å‘é€çš„è®°å½•çš„æŒä¹…æ€§ã€‚å…è®¸ä»¥ä¸‹è®¾ç½®:\n\nacks=0ï¼šè®¾ç½®ä¸º0ï¼Œåˆ™ç”Ÿäº§è€…å°†å®Œå…¨ä¸ç­‰å¾…æ¥è‡ªæœåŠ¡å™¨çš„ä»»ä½•ç¡®è®¤ã€‚è®°å½•å°†ç«‹å³æ·»åŠ åˆ°socketç¼“å†²åŒºï¼Œå¹¶è¢«è®¤ä¸ºå·²å‘é€ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸èƒ½ä¿è¯æœåŠ¡å™¨å·²ç»æ”¶åˆ°è®°å½•ï¼Œé‡è¯•é…ç½®å°†ä¸ä¼šç”Ÿæ•ˆ(å› ä¸ºå®¢æˆ·æœºé€šå¸¸ä¸ä¼šçŸ¥é“ä»»ä½•å¤±è´¥)ã€‚æ¯ä¸ªè®°å½•è¿”å›çš„åç§»é‡æ€»æ˜¯-1ã€‚\n**acks=1:**leaderä¼šå°†è®°å½•å†™åˆ°æœ¬åœ°æ—¥å¿—ä¸­ï¼Œä½†ä¸ä¼šç­‰å¾…æ‰€æœ‰followerçš„å®Œå…¨ç¡®è®¤ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœleaderåœ¨è®°å½•å¤±è´¥åç«‹å³å¤±è´¥ï¼Œä½†åœ¨è¿½éšè€…å¤åˆ¶è®°å½•ä¹‹å‰å¤±è´¥ï¼Œé‚£ä¹ˆè®°å½•å°±ä¼šä¸¢å¤±ã€‚\n**acks=all / -1:**leaderå°†ç­‰å¾…å®Œæ•´çš„åŒæ­¥å‰¯æœ¬æ¥ç¡®è®¤è®°å½•ã€‚è¿™ä¿è¯äº†åªè¦è‡³å°‘æœ‰ä¸€ä¸ªåŒæ­¥å‰¯æœ¬ä»ç„¶å­˜åœ¨ï¼Œè®°å½•å°±ä¸ä¼šä¸¢å¤±ã€‚è¿™æ˜¯æœ€æœ‰åŠ›çš„ä¿è¯ã€‚è¿™ç›¸å½“äºacks=-1è®¾ç½®ã€‚\n\n2ã€batch.sizeï¼šæ‰¹é‡å‘é€å¤§å°ï¼ˆé»˜è®¤ï¼š16384ï¼Œ16Kï¼‰ç¼“å­˜åˆ°æœ¬åœ°å†…å­˜ï¼Œæ‰¹é‡å‘é€å¤§å°ï¼Œæ„æ€æ¯æ¬¡å‘é€16Kåˆ°brokeã€‚å½“å¤šä¸ªè®°å½•è¢«å‘é€åˆ°åŒä¸€ä¸ªåˆ†åŒºæ—¶ï¼Œç”Ÿäº§è€…å°†å°è¯•å°†è®°å½•æ‰¹å¤„ç†æˆæ›´å°‘çš„è¯·æ±‚ã€‚è¿™æœ‰åŠ©äºå®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¸Šçš„æ€§èƒ½ã€‚æ­¤é…ç½®ä»¥å­—èŠ‚ä¸ºå•ä½æ§åˆ¶é»˜è®¤æ‰¹å¤„ç†å¤§å°ã€‚\n3ã€bootstrap.serversï¼šæœåŠ¡å™¨åœ°å€brokeæœåŠ¡å™¨åœ°å€ï¼Œå¤šä¸ªç”¨é€—å·å‰²å¼€ã€‚\n4ã€buffer.memoryï¼šç”Ÿäº§è€…æœ€å¤§å¯ç”¨ç¼“å­˜ (é»˜è®¤ï¼š33554432ï¼Œ32M)ç”Ÿäº§è€…å¯ä»¥ç”¨æ¥ç¼“å†²ç­‰å¾…å‘é€åˆ°æœåŠ¡å™¨çš„è®°å½•çš„æ€»å†…å­˜å­—èŠ‚ã€‚å¦‚æœè®°å½•è¢«å‘é€çš„é€Ÿåº¦è¶…è¿‡äº†å®ƒä»¬å¯ä»¥è¢«å‘é€åˆ°æœåŠ¡å™¨çš„é€Ÿåº¦ï¼Œé‚£ä¹ˆç”Ÿäº§è€…å°†é˜»å¡ max.block.msã€‚ç„¶åå®ƒä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚\nè¯¥è®¾ç½®åº”è¯¥å¤§è‡´ä¸ç”Ÿæˆå™¨å°†ä½¿ç”¨çš„æ€»å†…å­˜ç›¸å¯¹åº”ï¼Œä½†ä¸æ˜¯ç¡¬ç»‘å®šï¼Œå› ä¸ºç”Ÿæˆå™¨ä½¿ç”¨çš„å¹¶éæ‰€æœ‰å†…å­˜éƒ½ç”¨äºç¼“å†²ã€‚ä¸€äº›é¢å¤–çš„å†…å­˜å°†ç”¨äºå‹ç¼©(å¦‚æœå¯ç”¨äº†å‹ç¼©)ä»¥åŠç»´æŠ¤é£è¡Œä¸­çš„è¯·æ±‚ã€‚\nç”Ÿäº§è€…äº§ç”Ÿçš„æ¶ˆæ¯ç¼“å­˜åˆ°æœ¬åœ°ï¼Œæ¯æ¬¡æ‰¹é‡å‘é€batch.sizeå¤§å°åˆ°æœåŠ¡å™¨ã€‚\n5ã€client.idï¼šç”Ÿäº§è€…ID(é»˜è®¤â€œâ€)è¯·æ±‚æ—¶ä¼ é€’ç»™æœåŠ¡å™¨çš„idå­—ç¬¦ä¸²ã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯é€šè¿‡å…è®¸åœ¨æœåŠ¡å™¨ç«¯è¯·æ±‚æ—¥å¿—ä¸­åŒ…å«é€»è¾‘åº”ç”¨ç¨‹åºåç§°ï¼Œä»è€Œèƒ½å¤Ÿè·Ÿè¸ªip/ç«¯å£ä¹‹å¤–çš„è¯·æ±‚æºã€‚\n6ã€compression.typeï¼šå‹ç¼©ç±»å‹ï¼ˆé»˜è®¤å€¼ï¼šproducerï¼‰æŒ‡å®šç»™å®šä¸»é¢˜çš„æœ€ç»ˆå‹ç¼©ç±»å‹ã€‚æ­¤é…ç½®æ¥å—æ ‡å‡†å‹ç¼©ç¼–è§£ç å™¨(â€œgzipâ€ã€â€œsnappyâ€ã€â€œlz4â€ã€â€œzstdâ€)ã€‚å®ƒè¿˜æ¥å—â€œæœªå‹ç¼©â€ï¼Œç›¸å½“äºæ²¡æœ‰å‹ç¼©;ä»¥åŠâ€œç”Ÿäº§è€…â€ï¼Œå³ä¿ç•™ç”Ÿäº§è€…è®¾ç½®çš„åŸå§‹å‹ç¼©ç¼–è§£ç å™¨ã€‚\nâ€œgzipâ€ï¼šå‹ç¼©æ•ˆç‡é«˜ï¼Œé€‚åˆé«˜å†…å­˜ã€CPU\nâ€œsnappyâ€ï¼šé€‚åˆå¸¦å®½æ•æ„Ÿæ€§ï¼Œå‹ç¼©åŠ›åº¦å¤§\nretries:å¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆé»˜è®¤ï¼š2147483647ï¼‰å¼‚å¸¸æ˜¯RetriableExceptionç±»å‹æˆ–è€…TransactionManagerå…è®¸é‡è¯•ï¼›\ntransactionManager.canRetry()åé¢ä¼šåˆ†æï¼›å…ˆçœ‹çœ‹å“ªäº›å¼‚å¸¸æ˜¯RetriableExceptionç±»å‹å¼‚å¸¸ã€‚\n\nè®¾ç½®å¤§äºé›¶çš„å€¼å°†å¯¼è‡´å®¢æˆ·ç«¯é‡æ–°å‘é€ä»»ä½•å‘é€å¤±è´¥å¹¶å¯èƒ½å‡ºç°æš‚æ—¶é”™è¯¯çš„è®°å½•ã€‚è¯·æ³¨æ„ï¼Œæ­¤é‡è¯•ä¸å®¢æˆ·ç«¯åœ¨æ¥æ”¶åˆ°é”™è¯¯æ—¶æ†æ¨è®°å½•æ²¡æœ‰ä»€ä¹ˆä¸åŒã€‚å¦‚æœ delivery.timeout.ms é…ç½®çš„è¶…æ—¶æ—¶é—´åœ¨ç¡®è®¤æˆåŠŸä¹‹å‰å…ˆè¿‡æœŸï¼Œé‚£ä¹ˆåœ¨é‡è¯•æ¬¡æ•°ç”¨å°½ä¹‹å‰ï¼Œç”Ÿæˆè¯·æ±‚å°±ä¼šå¤±è´¥ã€‚ç”¨æˆ·é€šå¸¸åº”è¯¥é€‰æ‹©ä¸è®¾ç½®è¿™ä¸ªé…ç½®ï¼Œè€Œæ˜¯ä½¿ç”¨ delivery.timeout.ms æ¥æ§åˆ¶é‡è¯•è¡Œä¸ºã€‚\nå¯ç”¨ç­‰å¹‚éœ€è¦æ­¤é…ç½®å€¼å¤§äº0ã€‚å¦‚æœè®¾ç½®äº†å†²çªé…ç½®ä¸”æœªæ˜¾å¼å¯ç”¨å¹‚ç­‰æ€§ï¼Œåˆ™ç¦ç”¨å¹‚ç­‰æ€§ã€‚\nå…è®¸é‡è¯•ï¼ŒåŒæ—¶å°† able.idempotence è®¾ç½®ä¸º falseï¼Œå°† max.in.flight.requests.per.connect è®¾ç½®ä¸º1ï¼Œè¿™å¯èƒ½ä¼šæ”¹å˜è®°å½•çš„é¡ºåºï¼Œå› ä¸ºå¦‚æœå°†ä¸¤ä¸ªæ‰¹å¤„ç†å‘é€åˆ°ä¸€ä¸ªåˆ†åŒºï¼Œç¬¬ä¸€ä¸ªå¤±è´¥å¹¶é‡è¯•ï¼Œä½†ç¬¬äºŒä¸ªæˆåŠŸï¼Œé‚£ä¹ˆç¬¬äºŒä¸ªæ‰¹å¤„ç†ä¸­çš„è®°å½•å¯èƒ½ä¼šé¦–å…ˆå‡ºç°ã€‚\nretry.backoff.msï¼šé‡è¯•é˜»å¡æ—¶é—´ï¼ˆé»˜è®¤ï¼š100ï¼‰\nè¿™é¿å…äº†åœ¨æŸäº›å¤±è´¥åœºæ™¯ä¸‹ä»¥ç´§å¯†å¾ªç¯çš„æ–¹å¼é‡å¤å‘é€è¯·æ±‚ã€‚\n8ã€delivery.timeout.msï¼šä¼ è¾“æ—¶é—´ï¼ˆé»˜è®¤ï¼š120000ï¼Œ2åˆ†é’Ÿï¼‰è°ƒç”¨ send ()è¿”å›åæŠ¥å‘ŠæˆåŠŸæˆ–å¤±è´¥çš„æ—¶é—´ä¸Šé™ã€‚è¿™é™åˆ¶äº†è®°å½•åœ¨å‘é€ä¹‹å‰å»¶è¿Ÿçš„æ€»æ—¶é—´ã€ç­‰å¾…ä»£ç†ç¡®è®¤çš„æ—¶é—´(å¦‚æœé¢„æœŸçš„è¯)ä»¥åŠå…è®¸å¯æ£€ç´¢çš„å‘é€å¤±è´¥çš„æ—¶é—´ã€‚å¦‚æœé‡åˆ°ä¸å¯æ¢å¤çš„é”™è¯¯ï¼Œé‡è¯•å·²ç»ç”¨å°½ï¼Œæˆ–è€…è¯¥è®°å½•è¢«æ·»åŠ åˆ°ä¸€æ‰¹å·²ç»è¾¾åˆ°æå‰äº¤ä»˜æˆªæ­¢æœŸé™çš„è®°å½•ä¸­ï¼Œç”Ÿäº§è€…å¯èƒ½ä¼šæŠ¥å‘Šæœªèƒ½åœ¨æ­¤é…ç½®ä¹‹å‰å‘é€è®°å½•ã€‚\næ­¤é…ç½®çš„å€¼åº”å¤§äºæˆ–ç­‰äº request.timeout.ms å’Œ linger.ms ä¹‹å’Œã€‚\n9ã€connections.max.idle.msï¼šå…³é—­ç©ºé—²è¿æ¥æ—¶é—´ï¼ˆé»˜è®¤ï¼š540000ï¼‰ åœ¨æ­¤é…ç½®æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹åå…³é—­ç©ºé—²è¿æ¥ã€‚\n10ã€enable.idempotenceï¼šå¼€å¯å¹‚ç­‰ï¼ˆé»˜è®¤:falseï¼‰å½“è®¾ç½®ä¸ºâ€œtrueâ€æ—¶ï¼Œç”Ÿäº§è€…å°†ç¡®ä¿åœ¨æµä¸­å‡†ç¡®åœ°å†™å…¥æ¯ä¸ªæ¶ˆæ¯çš„å‰¯æœ¬ã€‚å¦‚æœâ€œfalseâ€ï¼Œåˆ™ç”±äºä»£ç†å¤±è´¥è€Œå¯¼è‡´ç”Ÿäº§è€…é‡è¯•ï¼Œç­‰ç­‰ï¼Œå¯èƒ½ä¼šåœ¨æµä¸­å†™å…¥é‡è¯•æ¶ˆæ¯çš„å‰¯æœ¬ã€‚è¯·æ³¨æ„ï¼Œå¯ç”¨å¹‚ç­‰éœ€è¦ä½¿ç”¨max.in.flight.requests.per.connection,è¿æ¥å°äºæˆ–ç­‰äº5ï¼Œé‡è¯•å¤§äº0ä¸”ackå¿…é¡»ä¸ºâ€œallâ€ã€‚å¦‚æœç”¨æˆ·æ²¡æœ‰æ˜¾å¼åœ°è®¾ç½®è¿™äº›å€¼ï¼Œå°†é€‰æ‹©åˆé€‚çš„å€¼ã€‚å¦‚æœè®¾ç½®äº†ä¸å…¼å®¹çš„å€¼ï¼Œå°±ä¼šæŠ›å‡ºConfigExceptionã€‚\n11ã€max.in.flight.requests.per.connectionï¼šå•ä¸ªè¿æ¥ä¸Šå‘é€çš„æœªç¡®è®¤è¯·æ±‚çš„æœ€å¤§æ•°é‡ï¼ˆé»˜è®¤ï¼š5ï¼‰é˜»å¡å‰å®¢æˆ·ç«¯åœ¨å•ä¸ªè¿æ¥ä¸Šå‘é€çš„æœªç¡®è®¤è¯·æ±‚çš„æœ€å¤§æ•°é‡ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœè¯¥è®¾ç½®è®¾ç½®ä¸ºå¤§äº1ï¼Œå¹¶ä¸”å‘é€å¤±è´¥ï¼Œåˆ™æœ‰ç”±äºé‡è¯•(å³ï¼Œå¦‚æœå¯ç”¨é‡è¯•)ã€‚\n12ã€interceptor.classesï¼šæ‹¦æˆªå™¨ï¼ˆé»˜è®¤ï¼šæ— ï¼‰ç”¨ä½œæ‹¦æˆªå™¨çš„ç±»çš„åˆ—è¡¨ã€‚å®ç°æ¥å£ï¼šorg.apache.kafka.clients.producerã€‚ProducerInterceptoræ¥å£å…è®¸å°†ç”Ÿäº§è€…æ¥æ”¶åˆ°çš„è®°å½•å‘å¸ƒåˆ°Kafkaé›†ç¾¤ä¹‹å‰æ‹¦æˆªå®ƒä»¬(å¯èƒ½è¿˜ä¼šå‘ç”Ÿçªå˜)ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ²¡æœ‰æ‹¦æˆªå™¨ã€‚\n13ã€key.serializer:keyåºåˆ—åŒ–å™¨ï¼ˆé»˜è®¤æ— ï¼‰å®ç°org.apache.kafka.common. serialize .Serializeræ¥å£çš„keyçš„åºåˆ—åŒ–å™¨ç±»ã€‚Stringå¯é…ç½®ï¼šclass org.apache.kafka.common.serialization.StringSerializerã€‚\n14ã€value.serializer:valueåºåˆ—åŒ–å™¨ï¼ˆé»˜è®¤æ— ï¼‰åºåˆ—åŒ–å™¨ç±»çš„å€¼ï¼Œè¯¥å€¼å®ç°org.apache.kafka.common. serialize .Serializeræ¥å£ã€‚Stringå¯é…ç½®ï¼šclass org.apache.kafka.common.serialization.StringSerializer\n15ã€linger.msï¼šå‘é€å»¶è¿Ÿæ—¶é—´ï¼ˆé»˜è®¤ï¼š0ï¼‰ä¸ºå‡å°‘è´Ÿè½½å’Œå®¢æˆ·ç«¯çš„è¯·æ±‚æ•°é‡ï¼Œç”Ÿäº§è€…ä¸ä¼šä¸€æ¡ä¸€æ¡å‘é€ï¼Œè€Œæ˜¯ä¼šé€—ç•™ä¸€æ®µæ—¶é—´æ‰¹é‡å‘é€ã€‚batch.size å’Œ linger.ms æ»¡è¶³ä»»ä½•ä¸€ä¸ªæ¡ä»¶éƒ½ä¼šå‘é€ã€‚\n16ã€max.block.msï¼šé˜»å¡æ—¶é—´ï¼ˆé»˜è®¤ï¼š60000ï¼Œä¸€åˆ†é’Ÿï¼‰é…ç½®æ§åˆ¶KafkaProducer.send()å’ŒKafkaProducer.partitionsFor()é˜»å¡çš„æ—¶é—´ã€‚ç”±äºç¼“å†²åŒºå·²æ»¡æˆ–å…ƒæ•°æ®ä¸å¯ç”¨ï¼Œä¹Ÿä¼šé˜»å¡ã€‚ç”¨æˆ·æä¾›çš„åºåˆ—åŒ–å™¨æˆ–åˆ†åŒºç¨‹åºä¸­çš„é˜»å¡å°†ä¸è®¡å…¥æ­¤è¶…æ—¶ã€‚\n17ã€max.request.sizeï¼šæœ€å¤§è¯·æ±‚å­—èŠ‚å¤§å°ï¼ˆé»˜è®¤ï¼š1048576ï¼Œ1Mï¼‰è¯·æ±‚çš„æœ€å¤§å­—èŠ‚å¤§å°ã€‚æ­¤è®¾ç½®å°†é™åˆ¶ç”Ÿäº§è€…åœ¨å•ä¸ªè¯·æ±‚ä¸­å‘é€è®°å½•æ‰¹çš„æ•°é‡ï¼Œä»¥é¿å…å‘é€å¤§é‡è¯·æ±‚ã€‚è¿™ä¹Ÿæœ‰æ•ˆåœ°é™åˆ¶äº†æœ€å¤§è®°å½•æ‰¹å¤§å°ã€‚æ³¨æ„ï¼ŒæœåŠ¡å™¨å¯¹è®°å½•æ‰¹å¤„ç†å¤§å°æœ‰è‡ªå·±çš„ä¸Šé™ï¼Œè¿™å¯èƒ½ä¸æ­¤ä¸åŒã€‚\n18ã€metric.reportersï¼šè‡ªå®šä¹‰æŒ‡æ ‡æŠ¥å‘Šå™¨ç”¨ä½œæŒ‡æ ‡æŠ¥å‘Šå™¨çš„ç±»çš„åˆ—è¡¨ã€‚metricsreporteræ¥å£å®ç°äº†org.apache.kafka.common.metrics.MetricsReporteræ¥å£ï¼Œè¯¥æ¥å£å…è®¸æ’å…¥å°†åœ¨åˆ›å»ºæ–°åº¦é‡æ—¶å¾—åˆ°é€šçŸ¥çš„ç±»ã€‚JmxReporterå§‹ç»ˆåŒ…å«åœ¨æ³¨å†ŒJMXç»Ÿè®¡ä¿¡æ¯ä¸­ã€‚\n19ã€partitioner.classï¼šè‡ªå®šä¹‰åˆ†åŒºç­–ç•¥å®ç°æ¥å£ org.apache.kafka.clients.producer.Partitionerï¼Œé»˜è®¤å€¼ï¼šorg.apache.kafka.clients.producer.internals.DefaultPartitioner\n20ã€request.timeout.msï¼šè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š30000ï¼‰é…ç½®æ§åˆ¶å®¢æˆ·æœºç­‰å¾…è¯·æ±‚å“åº”çš„æœ€é•¿æ—¶é—´ã€‚å¦‚æœåœ¨è¶…æ—¶è¶…æ—¶ä¹‹å‰æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œå®¢æˆ·ç«¯å°†åœ¨éœ€è¦æ—¶é‡æ–°å‘é€è¯·æ±‚ï¼Œæˆ–è€…åœ¨é‡è¯•è€—å°½æ—¶å¤±è´¥è¯·æ±‚ã€‚è¿™ä¸ªåº”è¯¥å¤§äºreplica.lag.time.maxã€‚ms(ä»£ç†é…ç½®)ï¼Œä»¥å‡å°‘ç”±äºä¸å¿…è¦çš„ç”Ÿäº§è€…é‡è¯•è€Œå¯¼è‡´æ¶ˆæ¯é‡å¤çš„å¯èƒ½æ€§ã€‚\n21ã€receive.buffer.bytesï¼ˆé»˜è®¤ï¼š32768ï¼Œ32Kï¼‰è¯»å–æ•°æ®æ—¶ä½¿ç”¨çš„TCPæ¥æ”¶ç¼“å†²åŒº(SO_RCVBUF)çš„å¤§å°ã€‚å¦‚æœå€¼æ˜¯-1ï¼Œå°†ä½¿ç”¨OSé»˜è®¤å€¼ã€‚\n22ã€send.buffer.bytesï¼ˆé»˜è®¤ï¼š131072,128Kï¼‰å‘é€æ•°æ®æ—¶ä½¿ç”¨çš„TCPå‘é€ç¼“å†²åŒº(SO_SNDBUF)çš„å¤§å°ã€‚å¦‚æœå€¼æ˜¯-1ï¼Œå°†ä½¿ç”¨OSé»˜è®¤å€¼ã€‚\nretry.backoff.msï¼šé‡è¯•é˜»å¡æ—¶é—´ï¼ˆé»˜è®¤ï¼š100ï¼‰è¿™é¿å…äº†åœ¨æŸäº›å¤±è´¥åœºæ™¯ä¸‹ä»¥ç´§å¯†å¾ªç¯çš„æ–¹å¼é‡å¤å‘é€è¯·æ±‚ã€‚\näºŒã€consumeræ ¸å¿ƒé…ç½®Consumer é…ç½®å®˜æ–¹æ–‡æ¡£\n1ã€enable.auto.commitï¼šå¼€å¯è‡ªåŠ¨æäº¤ï¼ˆé»˜è®¤:trueï¼‰å¦‚æœä¸ºtrueï¼Œconsumerçš„åç§»é‡å°†åœ¨åå°å®šæœŸæäº¤ã€‚\n2ã€auto.commit.interval.msï¼šè‡ªåŠ¨æäº¤é¢‘ç‡ï¼ˆé»˜è®¤ï¼š5000ï¼‰å¦‚æœenable.auto.commitè®¾ç½®ä¸ºtrueï¼Œåˆ™ä½¿ç”¨è€…åç§»é‡è‡ªåŠ¨æäº¤åˆ°Kafkaçš„é¢‘ç‡(æ¯«ç§’)ã€‚\nclient.idï¼šå®¢æˆ·IDä¾¿äºè·Ÿè¸ªæ—¥å¿—ã€‚\n4ã€check.crcsï¼šæ˜¯å¦å¼€å¯æ•°æ®æ ¡éªŒï¼ˆé»˜è®¤ï¼štrueï¼‰è‡ªåŠ¨æ£€æŸ¥æ¶ˆè€—çš„è®°å½•çš„CRC32ã€‚è¿™ç¡®ä¿ä¸ä¼šå‘ç”Ÿå¯¹æ¶ˆæ¯çš„åœ¨çº¿æˆ–ç£ç›˜æŸåã€‚æ­¤æ£€æŸ¥å¢åŠ äº†ä¸€äº›å¼€é”€ï¼Œå› æ­¤åœ¨å¯»æ±‚æç«¯æ€§èƒ½çš„æƒ…å†µä¸‹å¯èƒ½ç¦ç”¨æ­¤æ£€æŸ¥ã€‚\n5ã€bootstrap.serversï¼šæœåŠ¡å™¨é…ç½®å¤šä¸ªç”¨éƒ½å¥½éš”å¼€ã€‚\n6ã€connections.max.idle.msï¼šå…³é—­ç©ºé—´è¿æ¥æ—¶é—´ï¼ˆé»˜è®¤ï¼š540000ï¼‰åœ¨æ­¤é…ç½®æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹åå…³é—­ç©ºé—²è¿æ¥ã€‚\n7ã€group.idï¼šç¾¤ç»„ï¼ˆé»˜è®¤ï¼šâ€œâ€ï¼‰å”¯ä¸€æ ‡è¯†ç”¨æˆ·ç¾¤ç»„ï¼ŒåŒä¸€ä¸ªgroupæ¯ä¸ªpartitionåªä¼šåˆ†é…åˆ°ä¸€ä¸ªconsumerã€‚\nmax.poll.recordsï¼šæ‹‰èµ·æœ€å¤§è®°å½•ï¼ˆé»˜è®¤ï¼š500ï¼‰å•æ¬¡è½®è¯¢()è°ƒç”¨ä¸­è¿”å›çš„è®°å½•çš„æœ€å¤§æ•°é‡ã€‚\n9ã€max.poll.interval.msï¼šæ‹‰å–è®°å½•é—´éš”ï¼ˆé»˜è®¤ï¼š300000ï¼Œ5åˆ†é’Ÿï¼‰ä½¿ç”¨æ¶ˆè´¹è€…ç»„ç®¡ç†æ—¶è½®è¯¢()è°ƒç”¨ä¹‹é—´çš„æœ€å¤§å»¶è¿Ÿã€‚è¿™ä¸ºä½¿ç”¨è€…åœ¨è·å–æ›´å¤šè®°å½•ä¹‹å‰ç©ºé—²çš„æ—¶é—´è®¾ç½®äº†ä¸Šé™ã€‚å¦‚æœåœ¨æ­¤è¶…æ—¶è¿‡æœŸä¹‹å‰æ²¡æœ‰è°ƒç”¨poll()ï¼Œåˆ™è®¤ä¸ºä½¿ç”¨è€…å¤±è´¥ï¼Œç»„å°†é‡æ–°å¹³è¡¡ï¼Œä»¥ä¾¿å°†åˆ†åŒºé‡æ–°åˆ†é…ç»™å¦ä¸€ä¸ªæˆå‘˜ã€‚\n10ã€request.timeout.msï¼šè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆé»˜è®¤ï¼š30000 ï¼Œ30Sï¼‰é…ç½®æ§åˆ¶å®¢æˆ·æœºç­‰å¾…è¯·æ±‚å“åº”çš„æœ€é•¿æ—¶é—´ã€‚å¦‚æœåœ¨è¶…æ—¶è¶…æ—¶ä¹‹å‰æ²¡æœ‰æ”¶åˆ°å“åº”ï¼Œå®¢æˆ·ç«¯å°†åœ¨éœ€è¦æ—¶é‡æ–°å‘é€è¯·æ±‚ï¼Œæˆ–è€…åœ¨é‡è¯•è€—å°½æ—¶å¤±è´¥è¯·æ±‚ã€‚\n11ã€session.timeout.msï¼šconsumer sessionè¶…æ—¶ç”¨äºæ£€æµ‹workerç¨‹åºå¤±è´¥çš„è¶…æ—¶ã€‚workerå®šæœŸå‘é€å¿ƒè·³ï¼Œä»¥å‘ä»£ç†è¡¨æ˜å…¶æ´»æ€§ã€‚å¦‚æœåœ¨æ­¤ä¼šè¯è¶…æ—¶è¿‡æœŸä¹‹å‰ä»£ç†æ²¡æœ‰æ¥æ”¶åˆ°å¿ƒè·³ï¼Œåˆ™ä»£ç†å°†ä»ç»„ä¸­åˆ é™¤ã€‚è¯·æ³¨æ„ï¼Œè¯¥å€¼å¿…é¡»ä½äºgroup.min.session.timeoutåœ¨brokeré…ç½®ä¸­é…ç½®çš„å…è®¸èŒƒå›´å†…group.max.session.timeout.msã€‚\n12ã€auto.offset.reset:åˆå§‹åç§»é‡ (é»˜è®¤ï¼šlatest)å¦‚æœKafkaä¸­æ²¡æœ‰åˆå§‹åç§»é‡ï¼Œæˆ–è€…æœåŠ¡å™¨ä¸Šä¸å†å­˜åœ¨å½“å‰åç§»é‡(ä¾‹å¦‚ï¼Œå› ä¸ºè¯¥æ•°æ®å·²è¢«åˆ é™¤)ï¼Œè¯¥æ€ä¹ˆåŠ:\nearliest:è‡ªåŠ¨é‡ç½®åç§»åˆ°æœ€æ—©çš„åç§»\nlatest:è‡ªåŠ¨å°†åç§»é‡é‡ç½®ä¸ºæœ€æ–°åç§»é‡\nnone:å¦‚æœæ²¡æœ‰ä¸ºä½¿ç”¨è€…çš„ç»„æ‰¾åˆ°ä»¥å‰çš„åç§»é‡ï¼Œåˆ™å‘ä½¿ç”¨è€…æŠ›å‡ºexception\nanything else:å‘ä½¿ç”¨è€…æŠ›å‡ºå¼‚å¸¸\n13ã€key.deserializerç”¨äºå®ç°org.apache.kafka.common. serialize .Deserializeræ¥å£çš„keyçš„ååºåˆ—åŒ–ç±»ï¼Œclass org.apache.kafka.common.serialization.StringDeserializer\n14ã€value.deserializerç”¨äºå®ç°org.apache.kafka.common. serialize .Deserializeræ¥å£çš„valueçš„ååºåˆ—åŒ–ç±»ï¼Œclass org.apache.kafka.common.serialization.StringDeserializer\n15ã€max.partition.fetch.bytesæ¯ä¸ªåˆ†åŒºæœåŠ¡å™¨å°†è¿”å›çš„æœ€å¤§æ•°æ®é‡ã€‚è®°å½•ç”±consumeræˆæ‰¹æå–ã€‚å¦‚æœfetchçš„ç¬¬ä¸€ä¸ªéç©ºåˆ†åŒºä¸­çš„ç¬¬ä¸€ä¸ªè®°å½•æ‰¹å¤„ç†å¤§äºè¿™ä¸ªé™åˆ¶ï¼Œé‚£ä¹ˆä»ç„¶ä¼šè¿”å›æ‰¹å¤„ç†ï¼Œä»¥ç¡®ä¿ä½¿ç”¨è€…èƒ½å¤Ÿå–å¾—è¿›å±•ã€‚brokeræ¥å—çš„æœ€å¤§è®°å½•æ‰¹å¤„ç†å¤§å°æ˜¯é€šè¿‡message.maxå®šä¹‰çš„ã€‚å­—èŠ‚(brokeré…ç½®)æˆ–max.messageã€‚å­—èŠ‚(topicé…ç½®)ã€‚çœ‹fetch.max.bytesç”¨äºé™åˆ¶consumerè¯·æ±‚å¤§å°çš„å­—èŠ‚ã€‚\n16ã€partition.assignment.strategyï¼šconsumerè®¢é˜…åˆ†åŒºç­–ç•¥ï¼ˆé»˜è®¤ï¼šclass org.apache.kafka.clients.consumer.RangeAssignorï¼‰\nå½“ä½¿ç”¨ç»„ç®¡ç†æ—¶ï¼Œå®¢æˆ·ç«¯å°†ä½¿ç”¨åˆ†åŒºåˆ†é…ç­–ç•¥çš„ç±»ååœ¨ä½¿ç”¨è€…å®ä¾‹ä¹‹é—´åˆ†é…åˆ†åŒºæ‰€æœ‰æƒã€‚\n17ã€fetch.max.bytesï¼šæ‹‰å–æœ€å¤§å­—èŠ‚ï¼ˆé»˜è®¤ï¼š52428800ï¼Œ50Mï¼‰æœåŠ¡å™¨åº”è¯¥ä¸ºè·å–è¯·æ±‚è¿”å›çš„æœ€å¤§æ•°æ®é‡ã€‚è®°å½•ç”±ä½¿ç”¨è€…æˆæ‰¹åœ°è·å–ï¼Œå¹¶ä¸”å¦‚æœè·å–çš„ç¬¬ä¸€ä¸ªéç©ºåˆ†åŒºä¸­çš„ç¬¬ä¸€ä¸ªè®°å½•æ‰¹å¤„ç†å¤§äºè¿™ä¸ªå€¼ï¼Œä»ç„¶ä¼šè¿”å›è®°å½•æ‰¹å¤„ç†ï¼Œä»¥ç¡®ä¿ä½¿ç”¨è€…èƒ½å¤Ÿå–å¾—è¿›å±•ã€‚å› æ­¤ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªç»å¯¹æœ€å¤§å€¼ã€‚ä»£ç†æ¥å—çš„æœ€å¤§è®°å½•æ‰¹å¤„ç†å¤§å°æ˜¯é€šè¿‡message.maxå®šä¹‰çš„ã€‚å­—èŠ‚(ä»£ç†é…ç½®)æˆ–max.messageã€‚å­—èŠ‚(ä¸»é¢˜é…ç½®)ã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨è€…å¹¶è¡Œæ‰§è¡Œå¤šä¸ªè·å–ã€‚\n18ã€heartbeat.interval.msï¼šå¿ƒè·³æ—¶é—´ï¼ˆé»˜è®¤ï¼š3000, 3Sï¼‰ä½¿ç”¨Kafkaçš„ç»„ç®¡ç†å·¥å…·æ—¶ï¼Œä»å¿ƒè·³åˆ°æ¶ˆè´¹è€…åè°ƒå™¨çš„é¢„æœŸæ—¶é—´ã€‚å¿ƒè·³è¢«ç”¨æ¥ç¡®ä¿æ¶ˆè´¹è€…çš„ä¼šè¯ä¿æŒæ´»è·ƒï¼Œå¹¶åœ¨æ–°æ¶ˆè´¹è€…åŠ å…¥æˆ–ç¦»å¼€ç»„æ—¶ä¿ƒè¿›å†å¹³è¡¡ã€‚è¯¥å€¼å¿…é¡»è®¾ç½®ä¸ºå°äºsession.timeout.msçš„1/3ã€‚å®ƒå¯ä»¥è°ƒæ•´ç”šè‡³æ›´ä½ï¼Œä»¥æ§åˆ¶æ­£å¸¸å†å¹³è¡¡çš„é¢„æœŸæ—¶é—´ã€‚\n19ã€fetch.max.wait.msï¼šæ‹‰å–é˜»å¡æ—¶é—´ï¼ˆé»˜è®¤ï¼š500ï¼‰å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®ç«‹å³æ»¡è¶³fetch.min.bytesæä¾›çš„è¦æ±‚ï¼ŒæœåŠ¡å™¨åœ¨å“åº”fetchè¯·æ±‚ä¹‹å‰å°†é˜»å¡çš„æœ€é•¿æ—¶é—´ã€‚\n20ã€fetch.min.bytesï¼šæ‹‰å–æœ€å°å­—èŠ‚æ•°ï¼ˆé»˜è®¤ï¼š1ï¼‰æœåŠ¡å™¨åº”è¯¥ä¸ºè·å–è¯·æ±‚è¿”å›çš„æœ€å°æ•°æ®é‡ã€‚å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„æ•°æ®å¯ç”¨ï¼Œè¯·æ±‚å°†ç­‰å¾…é‚£ä¹ˆå¤šæ•°æ®ç´¯ç§¯åå†å“åº”è¯·æ±‚ã€‚é»˜è®¤çš„1å­—èŠ‚è®¾ç½®æ„å‘³ç€ï¼Œåªè¦æ•°æ®çš„ä¸€ä¸ªå­—èŠ‚å¯ç”¨ï¼Œæˆ–è€…è·å–è¯·æ±‚è¶…æ—¶ç­‰å¾…æ•°æ®åˆ°è¾¾ï¼Œå°±ä¼šå“åº”è·å–è¯·æ±‚ã€‚å°†æ­¤è®¾ç½®ä¸ºå¤§äº1çš„å€¼å°†å¯¼è‡´æœåŠ¡å™¨ç­‰å¾…æ›´å¤§æ•°é‡çš„æ•°æ®ç´¯ç§¯ï¼Œè¿™å¯ä»¥ç¨å¾®æé«˜æœåŠ¡å™¨ååé‡ï¼Œä½†ä»£ä»·æ˜¯å¢åŠ ä¸€äº›å»¶è¿Ÿã€‚\n21ã€exclude.internal.topics:å…¬å¼€å†…éƒ¨topic(é»˜è®¤ï¼štrue)æ˜¯å¦åº”è¯¥å°†æ¥è‡ªå†…éƒ¨ä¸»é¢˜(å¦‚åç§»é‡)çš„è®°å½•å…¬å¼€ç»™ä½¿ç”¨è€…ï¼Œconsumerå…±äº«offsetã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œä»å†…éƒ¨ä¸»é¢˜æ¥æ”¶è®°å½•çš„å”¯ä¸€æ–¹æ³•æ˜¯è®¢é˜…å®ƒã€‚\n22ã€isolation.level(éš”ç¦»çº§åˆ«ï¼šé»˜è®¤ï¼šread_uncommittedï¼‰æ§åˆ¶å¦‚ä½•ä»¥äº‹åŠ¡æ–¹å¼è¯»å–å†™å…¥çš„æ¶ˆæ¯ã€‚å¦‚æœè®¾ç½®ä¸ºread_committed, consumer.poll()å°†åªè¿”å›å·²æäº¤çš„äº‹åŠ¡æ¶ˆæ¯ã€‚å¦‚æœè®¾ç½®ä¸ºread_uncommittedâ€™(é»˜è®¤)ï¼Œconsumer.poll()å°†è¿”å›æ‰€æœ‰æ¶ˆæ¯ï¼Œç”šè‡³æ˜¯å·²ç»ä¸­æ­¢çš„äº‹åŠ¡æ¶ˆæ¯ã€‚åœ¨ä»»ä½•ä¸€ç§æ¨¡å¼ä¸‹ï¼Œéäº‹åŠ¡æ€§æ¶ˆæ¯éƒ½å°†æ— æ¡ä»¶è¿”å›ã€‚\nå›åˆ°é¡¶éƒ¨\nä¸‰ã€brokeé…ç½®1ã€zookeeper.connectï¼šzkåœ°å€å¤šä¸ªç”¨é€—å·éš”å¼€ã€‚\n2ã€advertised.host.nameï¼ˆé»˜è®¤ï¼šnullï¼‰ä¸èµæˆä½¿ç”¨:\nåœ¨server.properties é‡Œè¿˜æœ‰å¦ä¸€ä¸ªå‚æ•°æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ï¼Œ advertised.host.nameå‚æ•°ç”¨æ¥é…ç½®è¿”å›çš„host.nameå€¼ï¼ŒæŠŠè¿™ä¸ªå‚æ•°é…ç½®ä¸ºå¤–ç½‘IPåœ°å€å³å¯ã€‚\nè¿™ä¸ªå‚æ•°é»˜è®¤æ²¡æœ‰å¯ç”¨ï¼Œé»˜è®¤æ˜¯è¿”å›çš„java.net.InetAddress.getCanonicalHostNameçš„å€¼ï¼Œåœ¨æˆ‘çš„macä¸Šè¿™ä¸ªå€¼å¹¶ä¸ç­‰äºhostnameçš„å€¼è€Œæ˜¯è¿”å›IPï¼Œä½†åœ¨linuxä¸Šè¿™ä¸ªå€¼å°±æ˜¯hostnameçš„å€¼ã€‚\n3ã€advertised.listenershostnameå’Œç«¯å£æ³¨å†Œåˆ°zkç»™ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä½¿ç”¨çš„ï¼Œå¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œå°†ä¼šä½¿ç”¨listenersçš„é…ç½®ï¼Œå¦‚æœlistenersä¹Ÿæ²¡æœ‰é…ç½®ï¼Œå°†ä½¿ç”¨java.net.InetAddress.getCanonicalHostName()æ¥è·å–è¿™ä¸ªhostnameå’Œportï¼Œå¯¹äºipv4ï¼ŒåŸºæœ¬å°±æ˜¯localhostäº†ã€‚\n4ã€auto.create.topics.enableï¼ˆè‡ªåŠ¨åˆ›å»ºtopicï¼Œé»˜è®¤ï¼štrueï¼‰ç¬¬ä¸€æ¬¡å‘åŠ¨æ¶ˆæ¯æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºtopicã€‚\n5ã€auto.leader.rebalance.enableï¼šè‡ªåŠ¨rebalance(é»˜è®¤ï¼štrue)æ”¯æŒè‡ªåŠ¨é¢†å¯¼å¹³è¡¡ã€‚å¦‚æœéœ€è¦ï¼Œåå°çº¿ç¨‹å®šæœŸæ£€æŸ¥å¹¶è§¦å‘leader balanceã€‚\n6ã€background.threadsï¼šå¤„ç†çº¿ç¨‹ï¼ˆé»˜è®¤ï¼š10ï¼‰ç”¨äºå„ç§åå°å¤„ç†ä»»åŠ¡çš„çº¿ç¨‹æ•°ã€‚\n7ã€broker.id é»˜è®¤ï¼š-1æ­¤æœåŠ¡å™¨çš„broke idã€‚å¦‚æœæœªè®¾ç½®ï¼Œå°†ç”Ÿæˆå”¯ä¸€çš„ä»£ç†idã€‚ä¸ºäº†é¿å…zookeeperç”Ÿæˆçš„broke idå’Œç”¨æˆ·é…ç½®çš„broke idä¹‹é—´çš„å†²çªï¼Œç”Ÿæˆçš„ä»£ç†idä»reserve .broker.maxå¼€å§‹id + 1ã€‚\n8ã€compression.typeï¼šå‹ç¼©ç±»å‹ï¼Œé»˜è®¤ï¼šproduceræŒ‡å®šç»™å®šä¸»é¢˜çš„æœ€ç»ˆå‹ç¼©ç±»å‹ã€‚æ­¤é…ç½®æ¥å—æ ‡å‡†å‹ç¼©ç¼–è§£ç å™¨(â€œgzipâ€ã€â€œsnappyâ€ã€â€œlz4â€ã€â€œzstdâ€)ã€‚å®ƒè¿˜æ¥å—â€œæœªå‹ç¼©â€ï¼Œç›¸å½“äºæ²¡æœ‰å‹ç¼©;ä»¥åŠâ€œproducerâ€ï¼Œå³ä¿ç•™producerè®¾ç½®çš„åŸå§‹å‹ç¼©ç¼–è§£ç å™¨ã€‚\n9ã€delete.topic.enable åˆ é™¤topic(é»˜è®¤ï¼štrue)å…è®¸åˆ é™¤ä¸»é¢˜ã€‚å¦‚æœå…³é—­æ­¤é…ç½®ï¼Œåˆ™é€šè¿‡ç®¡ç†å·¥å…·åˆ é™¤ä¸»é¢˜å°†æ— æ•ˆã€‚\n10ã€leader.imbalance.check.interval.secondsï¼ˆrebalanceæ£€æµ‹é¢‘ç‡ï¼Œé»˜è®¤ï¼š300ï¼‰æ§åˆ¶å™¨è§¦å‘åˆ†åŒºrebalanceæ£€æŸ¥çš„é¢‘ç‡ã€‚\n11ã€leader.imbalance.per.broker.percentageï¼ˆè§¦å‘rebalanceæ¯”ç‡ï¼Œé»˜è®¤ï¼š10ï¼Œ10%ï¼‰æ¯ä¸ªbrokeå…è®¸çš„leadä¸å¹³è¡¡æ¯”ç‡ã€‚å¦‚æœæ§åˆ¶å™¨è¶…è¿‡æ¯ä¸ªbrokeçš„è¿™ä¸ªå€¼ï¼Œæ§åˆ¶å™¨å°†è§¦å‘ä¸€ä¸ªleader balanceã€‚è¯¥å€¼ä»¥ç™¾åˆ†æ¯”æŒ‡å®šã€‚\n12ã€log.dirï¼ˆæ—¥å¿—ç›®å½•ï¼Œé»˜è®¤ï¼š/tmp/kafka-logsï¼‰ä¿å­˜æ—¥å¿—æ•°æ®çš„ç›®å½•ã€‚\n13ã€log.dirsä¿å­˜æ—¥å¿—æ•°æ®çš„ç›®å½•ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä¸ºæ—¥å¿—ä¸­çš„å€¼ã€‚ä½¿ç”¨dirã€‚\n14ã€log.flush.interval.messagesï¼ˆé»˜è®¤ï¼š9223372036854775807ï¼‰åœ¨å°†æ¶ˆæ¯åˆ·æ–°åˆ°ç£ç›˜ä¹‹å‰ï¼Œæ—¥å¿—åˆ†åŒºä¸Šç´¯ç§¯çš„æ¶ˆæ¯æ•°é‡\n15ã€log.flush.interval.msï¼ˆé»˜è®¤ï¼šnullï¼‰ä»»ä½•ä¸»é¢˜ä¸­çš„æ¶ˆæ¯åœ¨åˆ·æ–°åˆ°ç£ç›˜ä¹‹å‰ä¿å­˜åœ¨å†…å­˜ä¸­çš„æœ€é•¿æ—¶é—´ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®ï¼Œåˆ™ä½¿ç”¨log.flush.scheduler.interval.msä¸­çš„å€¼ã€‚\n16ã€log.flush.offset.checkpoint.interval.msï¼ˆé»˜è®¤ï¼š60000ï¼‰ä½œä¸ºæ—¥å¿—æ¢å¤ç‚¹çš„ä¸Šæ¬¡åˆ·æ–°çš„æŒä¹…è®°å½•çš„æ›´æ–°é¢‘ç‡ã€‚\n17ã€log.retention.bytes ä¿å­˜æ—¥å¿—æ–‡ä»¶çš„æœ€å¤§å€¼ï¼ˆé»˜è®¤ï¼š-1ï¼‰åˆ é™¤å‰æ—¥å¿—çš„æœ€å¤§å¤§å°ã€‚\n18ã€log.retention.hoursæ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿å­˜æ—¶é—´ï¼ˆå°æ—¶ï¼‰é»˜è®¤ï¼š168ï¼Œä¸€å‘¨æ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿å­˜æ—¶é—´ã€‚\n19ã€log.retention.minutesæ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿å­˜æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰é»˜è®¤ï¼šnull20ã€log.retention.msæ—¥å¿—æ–‡ä»¶æœ€å¤§ä¿å­˜æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰é»˜è®¤ï¼šnull21ã€log.roll.hours:æ–°segmentäº§ç”Ÿæ—¶é—´ï¼Œé»˜è®¤ï¼š168ï¼Œä¸€å‘¨å³ä½¿æ–‡ä»¶æ²¡æœ‰åˆ°è¾¾log.segment.bytesï¼Œåªè¦æ–‡ä»¶åˆ›å»ºæ—¶é—´åˆ°è¾¾æ­¤å±æ€§ï¼Œå°±ä¼šåˆ›å»ºæ–°æ–‡ä»¶ã€‚\n22ã€log.roll.ms :æ–°segmentäº§ç”Ÿæ—¶é—´æ»šå‡ºæ–°æ—¥å¿—æ®µä¹‹å‰çš„æœ€å¤§æ—¶é—´(ä»¥æ¯«ç§’ä¸ºå•ä½)ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ä¸ºlog.rollä¸­çš„å€¼ä½¿ç”¨ã€‚\n23ã€log.segment.bytesï¼šsegmentæ–‡ä»¶æœ€å¤§å€¼ï¼Œé»˜è®¤ï¼š1073741824ï¼ˆ1Gï¼‰24ã€log.segment.delete.delay.msï¼šsegmentåˆ é™¤ç­‰å¾…æ—¶é—´ï¼Œ é»˜è®¤ï¼š60000ä»æ–‡ä»¶ç³»ç»Ÿä¸­åˆ é™¤æ–‡ä»¶ä¹‹å‰ç­‰å¾…çš„æ—¶é—´é‡ã€‚\n25ã€message.max.bytes æœ€å¤§batch size é»˜è®¤ï¼š1000012ï¼Œ0.9MKafkaå…è®¸çš„æœ€å¤§è®°å½•batch sizeã€‚å¦‚æœå¢åŠ äº†è¿™ä¸ªå€¼ï¼Œå¹¶ä¸”å­˜åœ¨å¤§äº0.10.2çš„ä½¿ç”¨è€…ï¼Œé‚£ä¹ˆè¿˜å¿…é¡»å¢åŠ consumerçš„fetchå¤§å°ï¼Œä»¥ä¾¿ä»–ä»¬èƒ½å¤Ÿè·å–è¿™ä¹ˆå¤§çš„è®°å½•æ‰¹ã€‚åœ¨æœ€æ–°çš„æ¶ˆæ¯æ ¼å¼ç‰ˆæœ¬ä¸­ï¼Œè®°å½•æ€»æ˜¯æŒ‰æ‰¹è¿›è¡Œåˆ†ç»„ï¼Œä»¥æé«˜æ•ˆç‡ã€‚åœ¨ä»¥å‰çš„æ¶ˆæ¯æ ¼å¼ç‰ˆæœ¬ä¸­ï¼Œæœªå‹ç¼©è®°å½•æ²¡æœ‰åˆ†ç»„æˆæ‰¹ï¼Œè¿™ç§é™åˆ¶åªé€‚ç”¨äºå•ä¸ªè®°å½•ã€‚å¯ä»¥ä½¿ç”¨ä¸»é¢˜çº§åˆ«max.messageè®¾ç½®æ¯ä¸ªä¸»é¢˜ã€‚å­—èŠ‚çš„é…ç½®ã€‚\n26ã€min.insync.replicasï¼ˆinsyncä¸­æœ€å°å‰¯æœ¬å€¼ï¼‰å½“producerå°†acksè®¾ç½®ä¸ºâ€œallâ€(æˆ–â€œ-1â€)æ—¶ï¼Œmin.insyncã€‚å‰¯æœ¬æŒ‡å®šå¿…é¡»ç¡®è®¤å†™æ“ä½œæˆåŠŸçš„æœ€å°å‰¯æœ¬æ•°é‡ã€‚å¦‚æœä¸èƒ½æ»¡è¶³è¿™ä¸ªæœ€å°å€¼ï¼Œåˆ™ç”Ÿäº§è€…å°†å¼•å‘ä¸€ä¸ªå¼‚å¸¸(è¦ä¹ˆæ˜¯NotEnoughReplicasï¼Œè¦ä¹ˆæ˜¯NotEnoughReplicasAfterAppend)ã€‚\nå½“ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œmin.insync.replicaså’Œackå…è®¸æ‚¨æ‰§è¡Œæ›´å¤§çš„æŒä¹…æ€§ä¿è¯ã€‚ä¸€ä¸ªå…¸å‹çš„åœºæ™¯æ˜¯åˆ›å»ºä¸€ä¸ªå¤åˆ¶å› å­ä¸º3çš„ä¸»é¢˜ï¼Œè®¾ç½®min.insyncå¤åˆ¶åˆ°2ä¸ªï¼Œç”¨â€œallâ€é…ç½®å‘é€ã€‚å°†ç¡®ä¿å¦‚æœå¤§å¤šæ•°å‰¯æœ¬æ²¡æœ‰æ”¶åˆ°å†™æ“ä½œï¼Œåˆ™ç”Ÿäº§è€…å°†å¼•å‘å¼‚å¸¸ã€‚\n27ã€num.io.threadsï¼Œé»˜è®¤ï¼š8æœåŠ¡å™¨ç”¨äºå¤„ç†è¯·æ±‚çš„çº¿ç¨‹æ•°ï¼Œå…¶ä¸­å¯èƒ½åŒ…æ‹¬ç£ç›˜I/Oã€‚\n28ã€num.network.threadsï¼Œé»˜è®¤ï¼š3æœåŠ¡å™¨ç”¨äºæ¥æ”¶æ¥è‡ªç½‘ç»œçš„è¯·æ±‚å’Œå‘ç½‘ç»œå‘é€å“åº”çš„çº¿ç¨‹æ•°ã€‚\n29ã€num.recovery.threads.per.data.dir é»˜è®¤ï¼š1æ¯ä¸ªæ•°æ®ç›®å½•åœ¨å¯åŠ¨æ—¶ç”¨äºæ—¥å¿—æ¢å¤å’Œåœ¨å…³é—­æ—¶ç”¨äºåˆ·æ–°çš„çº¿ç¨‹æ•°ã€‚\n30ã€num.replica.alter.log.dirs.threads é»˜è®¤ï¼šnullå¯ä»¥åœ¨æ—¥å¿—ç›®å½•(å¯èƒ½åŒ…æ‹¬ç£ç›˜I/O)ä¹‹é—´ç§»åŠ¨å‰¯æœ¬çš„çº¿ç¨‹æ•°ã€‚\n31ã€num.replica.fetchersä»leaderå¤åˆ¶æ•°æ®åˆ°followerçš„çº¿ç¨‹æ•°ã€‚\n32ã€offset.metadata.max.bytes é»˜è®¤ï¼š4096ä¸offsetæäº¤å…³è”çš„metadataçš„æœ€å¤§å¤§å°ã€‚\n33ã€offsets.commit.timeout.ms é»˜è®¤ï¼š5000åç§»é‡æäº¤å°†è¢«å»¶è¿Ÿï¼Œç›´åˆ°åç§»é‡ä¸»é¢˜çš„æ‰€æœ‰å‰¯æœ¬æ”¶åˆ°æäº¤æˆ–è¾¾åˆ°æ­¤è¶…æ—¶ã€‚è¿™ç±»ä¼¼äºç”Ÿäº§è€…è¯·æ±‚è¶…æ—¶ã€‚\n34ã€offsets.topic.num.partitions é»˜è®¤ï¼š50åç§»é‡æäº¤ä¸»é¢˜çš„åˆ†åŒºæ•°é‡(éƒ¨ç½²åä¸åº”æ›´æ”¹)ã€‚\n35ã€offsets.topic.replication.factor å‰¯æœ¬å¤§å°,é»˜è®¤ï¼š3ä½äºä¸Šè¿°å€¼ï¼Œä¸»é¢˜å°†åˆ›å»ºå¤±è´¥ã€‚\n36ã€offsets.topic.segment.bytes é»˜è®¤104857600 ,100Msegmentæ˜ å°„æ–‡ä»¶ï¼ˆindexï¼‰æ–‡ä»¶å¤§å°ï¼Œä»¥ä¾¿åŠ å¿«æ—¥å¿—å‹ç¼©å’Œç¼“å­˜è´Ÿè½½ã€‚\n37ã€queued.max.requests é»˜è®¤ï¼š500é˜»å¡ç½‘ç»œçº¿ç¨‹ä¹‹å‰å…è®¸æ’é˜Ÿçš„è¯·æ±‚æ•°ã€‚\n38ã€replica.fetch.min.bytesé»˜è®¤ï¼š1æ¯ä¸ªfetchå“åº”æ‰€éœ€çš„æœ€å°å­—èŠ‚ã€‚å¦‚æœå­—èŠ‚ä¸å¤Ÿï¼Œåˆ™ç­‰å¾…replicaMaxWaitTimeMsã€‚\n39ã€replica.lag.time.max.ms é»˜è®¤ï¼š10000å¦‚æœfollower æ²¡æœ‰å‘é€ä»»ä½•è·å–è¯·æ±‚ï¼Œæˆ–è€…è‡³å°‘åœ¨è¿™æ®µæ—¶é—´æ²¡æœ‰æ¶ˆè€—åˆ°leaderæ—¥å¿—çš„ç»“æŸåç§»é‡ï¼Œé‚£ä¹ˆleaderå°†ä»isrä¸­åˆ é™¤follower ã€‚\n40ã€transaction.max.timeout.ms é»˜è®¤ï¼š900000äº‹åŠ¡æ‰§è¡Œæœ€é•¿æ—¶é—´ï¼Œè¶…æ—¶åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚\n41ã€unclean.leader.election.enable é»˜è®¤ï¼šfalseæ˜¯å¦é€‰ä¸¾ISRä»¥å¤–çš„å‰¯æœ¬ä½œä¸ºleader,ä¼šå¯¼è‡´æ•°æ®ä¸¢å¤±ã€‚\n42ã€zookeeper.connection.timeout.mså®¢æˆ·ç«¯ç­‰å¾…ä¸zookeeperå»ºç«‹è¿æ¥çš„æœ€é•¿æ—¶é—´ã€‚å¦‚æœæœªè®¾ç½®ï¼Œåˆ™ç”¨zookeeper.session.timeoutä¸­çš„å€¼ã€‚\n43ã€zookeeper.max.in.flight.requestsé˜»å¡ä¹‹å‰consumerå°†å‘é€ç»™Zookeeperçš„æœªç¡®è®¤è¯·æ±‚çš„æœ€å¤§æ•°é‡ã€‚\n44ã€group.max.session.timeout.msæ³¨å†Œä½¿ç”¨è€…å…è®¸çš„æœ€å¤§ä¼šè¯è¶…æ—¶ã€‚è¶…æ—¶æ—¶é—´è¶Šé•¿ï¼Œæ¶ˆè´¹è€…åœ¨å¿ƒè·³ä¹‹é—´å¤„ç†æ¶ˆæ¯çš„æ—¶é—´å°±è¶Šå¤šï¼Œè€Œæ£€æµ‹æ•…éšœçš„æ—¶é—´å°±è¶Šé•¿ã€‚\n45ã€group.min.session.timeout.msæ³¨å†Œä½¿ç”¨è€…å…è®¸çš„æœ€å°ä¼šè¯è¶…æ—¶ã€‚æ›´çŸ­çš„è¶…æ—¶å¯¼è‡´æ›´å¿«çš„æ•…éšœæ£€æµ‹ï¼Œä½†ä»£ä»·æ˜¯æ›´é¢‘ç¹çš„ç”¨æˆ·å¿ƒè·³ï¼Œè¿™å¯èƒ½ä¼šå‹å€’brokeèµ„æºã€‚\n46ã€num.partitions é»˜è®¤ï¼š1æ¯ä¸ªä¸»é¢˜çš„é»˜è®¤æ—¥å¿—åˆ†åŒºæ•°é‡ã€‚\n","categories":["è¿ç»´","Kafka"]},{"title":"æ¼«è°ˆ Kafka","url":"/posts/11915/","content":"ä¸€ã€Rebalanceæœºåˆ¶Rebalance æè¿°çš„æ˜¯ consumer group ä¸­çš„ consumer ä¸ topic  ä¸‹çš„ partition é‡æ–°åŒ¹é…çš„è¿‡ç¨‹ã€‚\n1.ä½•æ—¶å‘ç”ŸRebalance\nconsumer group ä¸­æ¶ˆè´¹è€…ä¸ªæ•°å‘ç”Ÿå˜åŒ–ï¼Œä¾‹å¦‚æ–°æ¶ˆè´¹è€…åŠ å…¥æˆ–è€…æ¶ˆè´¹è€…å®•æœº\nconsumer æ¶ˆè´¹è¶…æ—¶\nconsumer group è®¢é˜…çš„ topic ä¸ªæ•°å‘ç”Ÿå˜åŒ–\nconsumer group è®¢é˜…çš„ topic  çš„ partition æ•°é‡å‘ç”Ÿå˜åŒ–\n\n2.GroupCoordinatorï¼ˆåè°ƒè€…ï¼‰coordinator æ˜¯ Rebalance æœºåˆ¶ä¸­éå¸¸é‡è¦çš„ä¸€ä¸ªè§’è‰²ã€‚\næ¯ä¸ªæ¶ˆè´¹è€…ç»„éƒ½ä¼šæœ‰ä¸€ä¸ª coordinatorï¼Œè´Ÿè´£ç®¡ç†ç»„å†…æ¶ˆè´¹è€…ï¼Œä½†å…¶å¹¶ä¸è´Ÿè´£æ¶ˆè´¹è€…ç»„å†… partition åˆ†é…ï¼Œè€Œæ˜¯ç”± leader consumer è¿›è¡Œåˆ†é…ã€‚\n1ï¼‰_consumer_offsets Topic__consumer_offsets æ˜¯ Kafka å†…éƒ¨ä½¿ç”¨çš„ä¸€ä¸ª topicï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨æ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹æƒ…å†µï¼Œé»˜è®¤æœ‰ 50 ä¸ª partitionï¼Œæ¯ä¸ª partition ä¸‰ä¸ª  followerã€‚\næ¯ä¸ªæ¶ˆè´¹è€…ç»„çš„æ¶ˆè´¹æƒ…å†µå­˜å‚¨åœ¨å“ªä¸ª partition ä¸Šæ˜¯æ ¹æ® abs(GroupId.hashCode()) % NumPartitions è®¡ç®—å¾—æ¥çš„ã€‚\nå…¶ä¸­ NumPartitions æ˜¯ _consumer_offsets topic çš„ partition æ•°é‡ï¼Œé»˜è®¤ 50ã€‚\næ¯ä¸ª broker åœ¨å¯åŠ¨æ—¶ï¼Œéƒ½ä¼šå¯åŠ¨ä¸€ä¸ª coordinatorï¼Œä½† åªæœ‰ _consumer_offsets çš„ partition çš„ leader æ‰€åœ¨ broker ä¸Šçš„ coordinator æ‰ä¼šç›´æ¥ä¸ consumer è¿›è¡Œäº¤äº’ï¼Œå…¶ä»– coordinator åªæ˜¯ä½œä¸ºå¤‡ä»½ï¼Œä¸€æ—¦ leader çš„ broker æŒ‚æ‰ä¹‹åè¿›è¡Œä¸»å¤‡åˆ‡æ¢ã€‚\n2ï¼‰å½±å“ consumer ä¸ coordinator çš„å‚æ•°æ¶ˆè´¹è€…ä»¥ heartbeat.interval.ms å‚æ•°çš„é¢‘ç‡å‘ coordinator å‘é€å¿ƒè·³ï¼Œå½“æ¶ˆè´¹è€…åœ¨ session.timeout.ms å‚æ•°é…ç½®çš„æ—¶é—´å†…æ²¡æœ‰å‘ coordinator å‘é€ä»»ä½•è¯·æ±‚ï¼Œä¼šè®¤ä¸ºè¯¥æ¶ˆè´¹è€…æŒ‚äº†ã€‚\nä¸€èˆ¬æ¥è¯´ heartbeat.interval.ms è¦å°äº session.timeout.msï¼Œä¸ç„¶å› ä¸ºå¶ç„¶çš„ç½‘ç»œåŸå› å°‘äº†ä¸€æ¬¡å¿ƒè·³æˆ–è€…ä¸‹æ¬¡å¿ƒè·³è¿˜æ²¡æ¥å¾—åŠå‘é€å°±åˆ¤å®šæ¶ˆè´¹è€…æŒ‚äº†ï¼Œé‚£å°±ä¼šé¢‘ç¹çš„ rebalanceï¼Œå¯¹äºååé‡æ˜¯æœ‰å¾ˆå¤§å½±å“çš„ã€‚\nä½†æ˜¯å¦‚æœ session.timeout.ms è®¾çš„æ—¶é—´å¤ªé•¿äº†ï¼Œå°±ä¼šå¯¼è‡´ coordinator éœ€è¦è¾ƒé•¿çš„æ—¶é—´æ‰èƒ½åˆ¤å®šæ¶ˆè´¹è€…å®•æœºï¼Œå¯¹æ€§èƒ½ä¹Ÿæ˜¯æœ‰å½±å“çš„ã€‚\nåœ¨ kafka 0.10.1 ä¹‹åçš„ç‰ˆæœ¬ä¸­ï¼Œå°† session.timeout.ms å’Œ max.poll.interval.ms è§£è€¦äº†ã€‚\nä¹Ÿå°±æ˜¯è¯´åœ¨ new KafkaConsumer å¯¹è±¡åï¼Œåœ¨ while å¾ªç¯ä¸­æ‰§è¡Œ consumer.poll æ‹‰å–æ¶ˆæ¯è¿‡ç¨‹ä¸­ï¼Œå®é™…è¿è¡Œäº†ä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯ consumer æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹ï¼Œä¸€ä¸ªæ˜¯å®šæ—¶å‘é€å¿ƒè·³ç»™ coordinator çš„çº¿ç¨‹ï¼ˆè¿™ä¸ªçº¿ç¨‹å¯¹å¼€å‘æ˜¯é€æ˜çš„ï¼‰ã€‚\nå¦‚æœ consumer æ¶ˆè´¹æ¶ˆæ¯è€—æ—¶è¾ƒé•¿ï¼Œä¹Ÿä¸ä¼šå½±å“ç»™ coordinator å‘é€å¿ƒè·³ï¼Œå°±ä¸ä¼šå‡ºç° consumer åœ¨æ­£å¸¸æ¶ˆè´¹ï¼Œä½† coordinator è®¤ä¸º consumer å·²ç»å®•æœºçš„æƒ…å†µã€‚åªè¦ max.poll.interval.ms å‚æ•°å¯ä»¥åŒ…å« consumer çš„æ¶ˆè´¹æ—¶é•¿æ˜¯æ²¡é—®é¢˜çš„ã€‚\nç”±äºæ˜¯ç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¦‚æœ consumer çœŸçš„å®•æœºäº†ï¼Œä¹Ÿå°±ä¸ç”¨ç­‰åˆ° max.poll.interval.msä¹‹åæ‰èƒ½æ£€æµ‹å‡º consumer å®•æœºäº†ã€‚\nåœ¨ kafka 0.10.1 ä¹‹å‰ï¼Œç”±äºå¿ƒè·³åŒ…çš„å‘é€å’Œæ¶ˆæ¯æ¶ˆè´¹æ˜¯åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ï¼Œå¦‚æœæ¶ˆæ¯å¤„ç†çš„æ—¶é—´è¶…è¿‡ session.timeout.msï¼Œæ¶ˆæ¯è¿˜æ²¡æ¶ˆè´¹å®Œå°±è¢« coordinator è¸¢å‡ºæ¶ˆè´¹è€…ç»„äº†ã€‚\n3.Rebalance è¿‡ç¨‹coordinator å‘ç”Ÿ rebalance æ—¶ï¼Œcoordinator å¹¶ä¸ä¼šä¸»åŠ¨é€šçŸ¥ç»„å†…æ‰€æœ‰æ¶ˆè´¹è€…é‡æ–°åŠ å…¥æ¶ˆè´¹è€…ç»„ï¼Œè€Œæ˜¯åœ¨ consumer å‘é€å¿ƒè·³çš„æ—¶å€™ï¼Œå°† rebalance çš„æƒ…å†µé€šè¿‡å¿ƒè·³å“åº”è¿”å›ç»™ consumerã€‚\nrebalance æ•´ä½“å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼šJoining The Group å’Œ Synchronizing Group Stateã€‚\n1ï¼‰Joining The Groupè¿™ä¸€é˜¶æ®µï¼Œconsumer å‘ coordinator è¯·æ±‚åŠ å…¥æ¶ˆè´¹è€…ç»„ï¼Œcoordinator ä¼šä»æ‰€æœ‰ consumer ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªä½œä¸º leader consumerã€‚\n2ï¼‰Synchronizing Group Stateleader consumer ä» coordinator è·å–æ‰€æœ‰æ¶ˆè´¹è€…çš„ä¿¡æ¯ï¼Œå¹¶å°†æ¶ˆè´¹è€…çš„ partition åˆ†é…ä¿¡æ¯å°è£…ä¸º SyncGroup è¯·æ±‚ã€‚\nleader consumer å¹¶ä¸ç›´æ¥ä¸å…¶ä»– consumer è¿›è¡Œäº¤äº’ï¼Œè€Œæ˜¯å°† SyncGroup å‘é€ç»™ coordinatorï¼Œå†ç”± coordinator å°†åˆ†é…ç»“æœå‘é€ç»™ consumerã€‚\nå¦‚æœ leader consumer å› ä¸ºç‰¹æ®ŠåŸå› å¯¼è‡´åˆ†é… partition å¤±è´¥ï¼ˆcoordinator é€šè¿‡è¶…æ—¶çš„æ–¹å¼æ£€æµ‹ï¼‰ï¼Œé‚£ä¹ˆ coordinator ä¼šé‡æ–°è¦æ±‚è¯¥æ¶ˆè´¹è€…ç»„ä¸­æ‰€æœ‰  consumer é‡æ–°è¿›è¡Œ Joining The Groupã€‚\n4.Generation æœºåˆ¶å½“ consumer æ¶ˆè´¹è¶…æ—¶ï¼ˆè¶…è¿‡ max.poll.interval.msï¼‰ï¼Œcoordinator ä¼šå°†è¯¥ consumer ä»æ¶ˆè´¹è€…ç»„ä¸­å‰”é™¤ï¼Œè¿›è¡Œ Rebalanceï¼Œå°†å½“å‰ consumer è´Ÿè´£çš„ partition åˆ†é…ç»™å…¶ä»– consumerï¼Œå¦‚æœæ­¤æ—¶è¯¥ consumer æ¶ˆè´¹å®Œæˆæäº¤ offsetï¼Œä¼šæŠ›å‡ºå¦‚ä¸‹å¼‚å¸¸ï¼š\n\nCommit cannot be completed since the group has already rebalanced and assigned the partitions to another member. This means that the time between subsequent calls to poll() was longer than the configured max.poll.interval.ms, which typically implies that the poll loop is spending too much time message processing. You can address this either by increasing max.poll.interval.ms or by reducing the maximum size of batches returned in poll() with max.poll.records.\n\nGeneration æœºåˆ¶å°±æ˜¯ä¸ºäº†é˜²æ­¢ä¸Šè¿°æƒ…å†µä¸‹ offset æäº¤æˆåŠŸçš„ã€‚\ncoordinator æ¯è¿›è¡Œä¸€æ¬¡ rebalanceï¼Œå°±ä¼šé‡æ–°è®¾ç½® generation æ ‡è®°ã€‚\nä¾‹å¦‚ç¬¬ä¸€æ¬¡ rebalance æ ‡è®°æ˜¯ 1ï¼Œç¬¬äºŒæ¬¡ rebalance æ ‡è®°æ˜¯ 2ï¼Œæ¶ˆè´¹è€…åœ¨æäº¤ offset æ—¶ä¼šå°† generation ä¸€åŒæäº¤ï¼Œcoordinate å‘ç°æ ‡è®°å·²ç»è¿‡æ—¶ï¼Œå°±ä¼šæ‹’ç» consumer æäº¤æ¶ˆæ¯ã€‚\nGeneration æœºåˆ¶å¯èƒ½ä¼šå¯¼è‡´ä¸Šä¸€ä»£ consumer å’Œå½“å‰ä»£ consumer æ¶ˆè´¹ç›¸åŒçš„æ¶ˆæ¯ï¼Œæ‰€ä»¥ consumer åœ¨æ¶ˆè´¹æ¶ˆæ¯æ—¶éœ€è¦å®ç°å¹‚ç­‰æ€§ã€‚\n5.Leader ConsumerLeader Consumer æ˜¯åœ¨ Joining The Group é˜¶æ®µä¸­éšæœºé€‰ä¸¾çš„ï¼Œè´Ÿè´£å…¶æ¶ˆè´¹è€…ç»„ä¸­å„ä¸ª consumer çš„ partition åˆ†é…ã€‚\né™¤æ­¤ä¹‹å¤–ï¼Œè¿˜è´Ÿè´£ç›‘æ§æ¶ˆè´¹è€…ç»„è®¢é˜…çš„ Topicï¼Œä¸€æ—¦å‘ç°è®¢é˜…çš„ Topic å‘ç”Ÿå˜åŒ–ï¼Œ Leader Consumer ä¼šé€šçŸ¥ coordinator è¿›è¡Œ rebalanceã€‚\näºŒã€Partition å‰¯æœ¬åŒæ­¥æœºåˆ¶kafka ä¸€ä¸ª Partition å¯ä»¥æœ‰å¤šä¸ªå‰¯æœ¬ï¼Œé‡‡ç”¨ä¸»å¤‡æ¨¡å¼ï¼Œåªæœ‰ leador partition å¯ä»¥è¿›è¡Œè¯»å†™ï¼Œå‰¯æœ¬åªæ˜¯åŒæ­¥ leador çš„æ•°æ®ã€‚\n\nISR(in-sync Replica) ä¸ OSR(out-sync Replica)å¦‚æœä¸€ä¸ª follower è½å leader ä¸è¶…è¿‡æŸä¸ªæ—¶é—´é˜ˆå€¼ï¼Œé‚£ä¹ˆè¯¥ follower å°±åœ¨ ISR ä¸­ï¼Œå¦åˆ™æ”¾åœ¨ OSR ä¸­ã€‚\nISR å’Œ OSR å¹¶ä¸æ˜¯ä¸€æˆä¸å˜çš„ã€‚\nå½“ ISR ä¸­æŸä¸ª follower ä¸ç¬¦åˆæ¡ä»¶æ—¶ï¼Œä¼šè¿›å…¥åˆ° OSR ä¸­ï¼›\nç›¸åï¼Œå½“ OSR ä¸­æŸä¸ª follower è·Ÿä¸Šäº† leader ä¼šè¿›å…¥åˆ° ISRã€‚\nHWï¼ˆhigh watermarkï¼‰æ‰€æœ‰ ISR ä¸­æœ€å°çš„ LEO å³ä¸º HWã€‚\nLEOï¼ˆlog end offsetï¼‰partition æ—¥å¿—æ–‡ä»¶ä¸­ä¸‹ä¸€æ¡å¾…å†™å…¥æ¶ˆæ¯çš„ offsetã€‚æ— è®º leader è¿˜æ˜¯ follower éƒ½æœ‰ã€‚\nfirstUnstableOffsetkafka æ”¯æŒäº‹ç‰©æ¶ˆæ¯ï¼ŒfirstUnstableOffset æŒ‡çš„æ˜¯ç¬¬ä¸€æ¡æœªæäº¤çš„æ¶ˆæ¯çš„ offsetï¼Œä» firstUnstableOffset å¼€å§‹ï¼Œåˆ° LEO ä¹‹å‰éƒ½æ˜¯æœªæäº¤çš„æ¶ˆæ¯ã€‚\nlastStableOffsetæœ€åä¸€æ¡å·²æäº¤çš„æ¶ˆæ¯çš„ offsetã€‚\nlogStartOffsetåˆå§‹æ¶ˆæ¯çš„ offsetã€‚\n1.Partitionä¸­å“ªäº›æ¶ˆæ¯å¯ä»¥æ¶ˆè´¹ï¼Ÿå½“å…è®¸æ¶ˆè´¹æœªæäº¤çš„æ¶ˆæ¯æ—¶ï¼Œä» logStartOffset å¼€å§‹ï¼Œåˆ° HW ä¹‹å‰çš„æ¶ˆæ¯éƒ½æ˜¯å¯ä»¥æ¶ˆè´¹ã€‚\nå½“ä¸å…è®¸æ¶ˆè´¹æœªæäº¤çš„æ¶ˆæ¯æ—¶ï¼Œåªæœ‰ä» logStartOffset å¼€å§‹ï¼Œåˆ° lastStableOffset çš„æ¶ˆæ¯æ˜¯å¯ä»¥æ¶ˆè´¹çš„ã€‚\n2.åŒæ­¥è¿‡ç¨‹å½“ leader æ”¶åˆ°ç”Ÿäº§è€…çš„ä¸€æ¡æ¶ˆæ¯æ—¶ï¼ŒLEO é€šå¸¸ä¼šè‡ªå¢ 1ï¼Œè€Œ follower éœ€è¦ä» leader fetchåˆ°æ•°æ®åï¼Œæ‰èƒ½å¢åŠ  LEOã€‚\nfollower å‘å‡º fetch è¯·æ±‚åŒæ­¥æ•°æ®æ—¶ï¼Œä¼šæºå¸¦è‡ªèº«çš„ LEOï¼Œleader ä¼šæ›´æ–° remote LEO å’Œ partition çš„ HWï¼Œç„¶åå°†æ•°æ®è¿”å›ç»™ followerã€‚\nfollower è·å–åˆ°æ•°æ®åæœ‰ä¸‰ç§æƒ…å†µï¼š\n\nfollower çš„ LEO å°äº leader çš„ logStartOffsetï¼šè¯´æ˜ follower çš„æ•°æ®å¤ªè€äº†ï¼Œä¼šæŠŠè‡ªèº«çš„æ•°æ®åˆ é™¤ï¼Œé‡æ–°è·å– leader ä» logStartOffset åˆ° LEO ä¹‹å‰çš„æ•°æ®ï¼›\nfollower çš„ LEO å¤§äºç­‰äº leader logStartOffset ä¸”å°äºç­‰äº leader LEOï¼šæ­£å¸¸åŒæ­¥ç¼ºå¤±çš„æ•°æ®ï¼›\nfollower çš„ LEO å¤§äº leader LEOï¼šåˆ é™¤ follower å¤šä½™çš„ offsetï¼Œä¸ leader ä¿æŒä¸€è‡´ã€‚\n\nfollower ä¼šç”¨ leader HW å’Œè‡ªèº« LEO çš„æœ€å°å€¼è¿›è¡Œæ›´æ–°è‡ªèº« HWã€‚\næ•°æ®ä¸¢å¤±å½“ follower è¿˜æ²¡æœ‰åŒæ­¥åˆ° leader æœ€æ–°æ•°æ®ï¼Œleader æŒ‚æ‰ï¼Œfollower æˆä¸º leaderï¼Œéƒ¨åˆ†æ•°æ®ä¼šå­˜åœ¨ä¸¢å¤±çš„æƒ…å†µã€‚\nä¸‰ã€æ¶ˆæ¯é«˜å¯é æ¶ˆæ¯å¯é å‘é€1ï¼‰ACKS\nacks = 0ï¼šç”Ÿäº§è€…åœ¨æˆåŠŸå†™å…¥æ¶ˆæ¯ä¹‹å‰ä¸ä¼šç­‰å¾…brokerçš„å“åº”ï¼Œä¸€æ—¦å› ä¸ºç½‘ç»œæˆ–å…¶ä»–åŸå› å¯¼è‡´brokeræ²¡æœ‰æ”¶åˆ°æ¶ˆæ¯ï¼Œæ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚ä½†ç”±äºä¸éœ€è¦ç­‰å¾… broker å“åº”ï¼Œæ‰€ä»¥ååé‡æœ€é«˜ï¼›\nacks = 1ï¼šå½“ç”Ÿäº§è€…æ”¶åˆ°leaderå†™å…¥æ¶ˆæ¯æˆåŠŸçš„ackåï¼Œå³è®¤ä¸ºæ¶ˆæ¯å‘é€æˆåŠŸã€‚å½“æ¶ˆæ¯æ— æ³•å†™å…¥ leader ï¼Œå°†ä¼šæ”¶åˆ°ä¸€ä¸ªé”™è¯¯å“åº”ï¼Œä¸ºé¿å…æ¶ˆæ¯ä¸¢å¤±ï¼Œç”Ÿäº§è€…å°†ä¼šé‡æ–°å‘é€æ¶ˆæ¯ã€‚è‹¥leaderæˆåŠŸæ¥æ”¶æ¶ˆæ¯ä½†è¿˜æœªåŒæ­¥ç»™ followerï¼Œleader æŒ‚æ‰ï¼Œé‡æ–°é€‰ä¸¾çš„leaderæ²¡æœ‰è¯¥æ¶ˆæ¯ï¼Œæ­¤æ—¶æ¶ˆæ¯å°†ä¼šä¸¢å¤±ã€‚è¯¥æ–¹å¼çš„ååé‡å–å†³äºä½¿ç”¨å¼‚æ­¥å‘é€è¿˜æ˜¯åŒæ­¥å‘é€ï¼›\nacks = all/-1ï¼šISR ä¸­æ‰€æœ‰followerå…¨éƒ¨å†™å…¥æ¶ˆæ¯æˆåŠŸåï¼Œç”Ÿäº§è€…æ‰ä¼šæ”¶åˆ°ackã€‚è¯¥æ¨¡å¼çš„å®‰å…¨æ€§æœ€é«˜ï¼Œä½†å»¶è¿Ÿä¹Ÿæœ€é«˜ã€‚\n\n2ï¼‰æ˜¯å¦å…è®¸ä»OSRé€‰ä¸¾leaderunclean.leader.election.enable:false é…ç½®ï¼Œç¦æ­¢é€‰ä¸¾ ISR ä¹‹å¤–ï¼ˆå³ OSR ä¸­ï¼‰çš„ follower æˆä¸º leaderã€‚\nå¦‚æœå…è®¸ä» OSR ä¸­é€‰ä¸¾ leaderï¼Œå³ä½¿ ack = all/-1 ä¹Ÿä¼šå­˜åœ¨æ¶ˆæ¯ä¸¢å¤±çš„æƒ…å†µã€‚\nä½†æ˜¯å¦‚æœä¸å…è®¸ä» OSR ä¸­é€‰ä¸¾leaderï¼Œåœ¨æç«¯æƒ…å†µä¸‹ ISR ä¸­çš„brokerå…¨éƒ¨æŒ‚æ‰ï¼Œæ­¤æ—¶å°±æ— æ³•é€‰ä¸¾å‡ºleaderï¼Œåªèƒ½ç­‰å¾… ISR ä¸­leaderæ¢å¤ï¼Œè¯¥ partition ä¹Ÿå°±æ— æ³•æä¾›æœåŠ¡ï¼Œç‰ºç‰²äº†å¯ç”¨æ€§ï¼Œä½†ä¿è¯äº†æ¶ˆæ¯çš„å¯é æ€§ã€‚\n3ï¼‰retries é‡è¯•æ¬¡æ•°å½“ç”Ÿäº§è€…å‘é€äº†æ¶ˆæ¯ï¼Œå› ä¸ºç½‘ç»œåŸå› æˆ–å…¶ä»–åŸå› å¯¼è‡´æ²¡æœ‰æ”¶åˆ°ackï¼Œä¼šè¿›è¡Œé‡è¯•ã€‚\n4ï¼‰æœ€å°åŒæ­¥å‰¯æœ¬æ•°broker çš„ min.insync.replicas å‚æ•°å¯ä»¥æ§åˆ¶æ¶ˆæ¯è‡³å°‘è¢«å†™å…¥å¤šå°‘ä¸ªå‰¯æœ¬æ‰ç®—å†™å…¥æˆåŠŸï¼Œé»˜è®¤å€¼ä¸º 1ã€‚\nå¦‚æœæ¶ˆæ¯åŒæ­¥çš„å‰¯æœ¬æ•°é‡å°äºé…ç½®çš„è¯¥å€¼ï¼Œç”Ÿäº§è€…å°†æ”¶åˆ°é”™è¯¯å“åº”ï¼Œä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±ã€‚\nè¯¥é…ç½®å¯ä»¥ä¸ acks ç›¸ç»“åˆï¼Œå¹³è¡¡æ€§èƒ½ã€‚\n\nmin.insync.replicas = 2 &amp;&amp; ack = all &amp;&amp; ISR=&#123;1,2&#125;  æ—¶ï¼ŒISRä¸­ä¸¤ä¸ªfolloweråŒæ­¥å®Œæˆç”Ÿäº§è€…å°±ä¼šæ”¶åˆ°æˆåŠŸå“åº”ï¼›\nmin.insync.replicas = 2 &amp;&amp; ISR=&#123;1&#125;  æ—¶ï¼Œè‹¥ ack = all  ä¸èƒ½æˆåŠŸå†™å…¥ï¼Œè‹¥ ack = 0 æˆ– 1 å¯ä»¥æˆåŠŸå†™å…¥ï¼›\nmin.insync.replicas = 2 &amp;&amp; ack = all &amp;&amp; ISR=&#123;1,2,3&#125;  æ—¶ï¼Œéœ€è¦ ISR ä¸­æ‰€æœ‰ follower éƒ½å†™å…¥æˆåŠŸåæ‰ä¼šæ”¶åˆ°æˆåŠŸå“åº”ã€‚\n\næ¶ˆæ¯å¯é æ¶ˆè´¹\næ‰‹åŠ¨æäº¤offset\nå‡å°brokeræœåŠ¡å™¨çš„åˆ·ç›˜é—´éš”\näº‹ç‰©æ¶ˆæ¯\n\nå››ã€æ¶ˆè´¹è€…æ— æ³•æ¶ˆè´¹offsets.topic.replication.factor \noffsets topic çš„å¤åˆ¶å› å­(è®¾ç½®æ›´é«˜ä»¥ç¡®ä¿å¯ç”¨æ€§)ã€‚åœ¨é›†ç¾¤å¤§å°æ»¡è¶³æ­¤å¤åˆ¶å› å­è¦æ±‚ä¹‹å‰ï¼Œå†…éƒ¨ä¸»é¢˜åˆ›å»ºå°†å¤±è´¥ã€‚\næ–‡æ¡£é“¾æ¥ https://kafka.apache.org/documentation/#brokerconfigs_offsets.topic.replication.factor\n","categories":["è¿ç»´","Kafka"]},{"title":"Nginx location åŒ¹é…è§„åˆ™","url":"/posts/13357/","content":"ä¸€ã€urlåŒ¹é…è§„åˆ™location [=|~|~*|^~|@] /uri/ &#123;  ...&#125; \n\n\n=ï¼šè¡¨ç¤ºç²¾ç¡®åŒ¹é…åé¢çš„url\n~ï¼šè¡¨ç¤ºæ­£åˆ™åŒ¹é…ï¼Œä½†æ˜¯åŒºåˆ†å¤§å°å†™\n~*ï¼šæ­£åˆ™åŒ¹é…ï¼Œä¸åŒºåˆ†å¤§å°å†™\n^~ï¼šè¡¨ç¤ºæ™®é€šå­—ç¬¦åŒ¹é…ï¼Œå¦‚æœè¯¥é€‰é¡¹åŒ¹é…ï¼ŒåªåŒ¹é…è¯¥é€‰é¡¹ï¼Œä¸åŒ¹é…åˆ«çš„é€‰é¡¹ï¼Œä¸€èˆ¬ç”¨æ¥åŒ¹é…ç›®å½•\n@ï¼šâ€@â€ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œä½¿ç”¨åœ¨å†…éƒ¨å®šå‘æ—¶ï¼Œä¾‹å¦‚ error_page\n\nä¸Šè¿°åŒ¹é…è§„åˆ™çš„ä¼˜å…ˆåŒ¹é…é¡ºåºï¼š\n\n= å‰ç¼€çš„æŒ‡ä»¤ä¸¥æ ¼åŒ¹é…è¿™ä¸ªæŸ¥è¯¢ã€‚å¦‚æœæ‰¾åˆ°ï¼Œåœæ­¢æœç´¢ï¼›\næ‰€æœ‰å‰©ä¸‹çš„å¸¸è§„å­—ç¬¦ä¸²ï¼Œæœ€é•¿çš„åŒ¹é…ã€‚å¦‚æœè¿™ä¸ªåŒ¹é…ä½¿ç”¨ ^~ å‰ç¼€ï¼Œæœç´¢åœæ­¢ï¼›\næ­£åˆ™è¡¨è¾¾å¼ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„é¡ºåºï¼›\nå¦‚æœç¬¬ 3 æ¡è§„åˆ™äº§ç”ŸåŒ¹é…çš„è¯ï¼Œç»“æœè¢«ä½¿ç”¨ã€‚å¦åˆ™ï¼Œä½¿ç”¨ç¬¬ 2 æ¡è§„åˆ™çš„ç»“æœã€‚\n\nç›®æ ‡åœ°å€å¤„ç†è§„åˆ™åŒ¹é…åˆ°uriåï¼Œæ¥ä¸‹æ¥è¦ä»£ç†åˆ°ç›®æ ‡æœåŠ¡åœ°å€ã€‚\nupstream api_server &#123;  server 10.0.101.62:8081;  server 10.0.101.61:8082;&#125;location / &#123;        rewrite ^(.*)$ http://10.0.101.62:8000/my-module$1 break;&#125;location ^~ /my-module/ &#123;    root   /data/my-module/dist;    rewrite ^/my-module/(.*)$  /$1 break;    index  index.html index.htm;&#125;location /my-module/api &#123;    proxy_pass  http://api_server;    proxy_set_header Host $host;    proxy_set_header  X-Real-IP        $remote_addr;    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;    proxy_set_header  your-custome-header    &quot;myHeader&quot;;    proxy_set_header X-NginX-Proxy true;&#125;\n\nä¸Šè¿°é…ç½®ï¼Œé»˜è®¤è®¿é—®/ä¼šé‡å®šå‘åˆ°/my-module, ç„¶åç›´æ¥è¿”å›/data/my-module/distä¸‹çš„htmlç­‰é™æ€æ–‡ä»¶ã€‚\nè®¿é—®/my-module/apiåˆ™ä¼šä»£ç†åˆ°æˆ‘ä»¬apiæœåŠ¡å™¨åœ°å€ï¼Œæ˜¯ä¸€ä¸ªé»˜è®¤çš„round-robinè´Ÿè½½å‡è¡¡é…ç½®ã€‚\nä¸‹é¢æ˜¯è®¿é—®localhostçš„æ—¥å¿—, è®¿é—®é¦–é¡µä¸€å…±è¿›è¡Œäº†2æ¬¡é‡å®šå‘ã€‚\nRequest URL: http://10.0.101.62:8000/Request Method: GETStatus Code: 302 Moved TemporarilyLocation: http://10.0.101.62:8000/flash/Request URL: http://10.0.101.62:8000/flash/Request Method: GETStatus Code: 302 Moved TemporarilyLocation: http://10.0.101.62:8000/flash/index.htmlRequest URL: http://10.0.101.62:8000/flash/index.htmlRequest Method: GETStatus Code: 304 Not Modified\n\naliasä¸rootçš„åŒºåˆ«\nroot å®é™…è®¿é—®æ–‡ä»¶è·¯å¾„ä¼šæ‹¼æ¥URLä¸­çš„è·¯å¾„\nalias å®é™…è®¿é—®æ–‡ä»¶è·¯å¾„ä¸ä¼šæ‹¼æ¥URLä¸­çš„è·¯å¾„\n\nalias ç¤ºä¾‹ï¼š\nlocation ^~ /sta/ &#123;     alias /usr/local/nginx/html/static/;  &#125;\n\nè¯·æ±‚ï¼šhttp://test.com/sta/sta1.htmlå®é™…è®¿é—®ï¼š/usr/local/nginx/html/static/sta1.html æ–‡ä»¶\nroot ç¤ºä¾‹ï¼š\nlocation ^~ /tea/ &#123;     root /usr/local/nginx/html/;  &#125;\n\nè¯·æ±‚ï¼šhttp://test.com/tea/tea1.htmlå®é™…è®¿é—®ï¼š/usr/local/nginx/html/tea/tea1.html æ–‡ä»¶\næ˜¾ç„¶ï¼Œç¬¬äºŒæ¬¡é‡å®šå‘æ˜¯ä¸éœ€è¦çš„ï¼Œæœ¬æ„æ˜¯è®¿é—®/flash/çš„æ—¶å€™ï¼Œç›´æ¥è®¿é—®å¯¹åº”ç›®å½•ä¸‹çš„htmlé™æ€æ–‡ä»¶ã€‚ ä½†å› ä¸ºrootæ‹¼æ¥flashå¯¼è‡´æ‰¾ä¸åˆ°å¯¹åº”æ–‡ä»¶ï¼Œè¦é‡å†™urlï¼Œå»æ‰flashè¿™ä¸ªæ¨¡å—å‰ç¼€ï¼Œä½¿ç”¨äº†rewrite, è€Œrewriteä¼šè¿”å›302é‡å®šå‘ã€‚\næ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¿®æ”¹rootä¸ºalias\n location ^~ /flash/ &#123;    alias   /data/flash/dist/;    #rewrite ^/flash/(.*)$  /$1 break;    index  index.html index.htm;&#125;\n\nç›´æ¥é‡å®šå‘1æ¬¡åè¿”å›html\nRequest URL: http://10.0.101.62:8000/Request Method: GETStatus Code: 302 Moved TemporarilyRequest URL: http://10.0.101.62:8000/flash/Request Method: GETStatus Code: 200 OK (from disk cache)\n\nlast å’Œ break å…³é”®å­—çš„åŒºåˆ«åªç”¨åˆ°äº†breakï¼Œå³åŒ¹é…åˆ°æ­¤å¤„åä¸ä¼šç»§ç»­è·³ã€‚\npermanent å’Œ redirect å…³é”®å­—çš„åŒºåˆ«\nrewrite â€¦ permanent æ°¸ä¹…æ€§é‡å®šå‘ï¼Œè¯·æ±‚æ—¥å¿—ä¸­çš„çŠ¶æ€ç ä¸º301\nrewrite â€¦ redirect ä¸´æ—¶é‡å®šå‘ï¼Œè¯·æ±‚æ—¥å¿—ä¸­çš„çŠ¶æ€ç ä¸º302\n\næˆ‘ä»¬å¸¸ç”¨çš„80ç«¯å£è½¬443ï¼Œå³httpè½¬httpsçš„ä¸€ç§é…ç½®æ–¹æ¡ˆä¸ºï¼š\nserver &#123;    listen 80;    server_name demo.com;    rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent; &#125;\n\nä¼šè¿”å›301æ°¸ä¹…é‡å®šå‘åˆ°å¯¹åº”çš„httpsï¼š\nRequest URL: http://demo.com/flash/index.htmlRequest Method: GETStatus Code: 301 Moved PermanentlyLocation: https://demo/flash/index.html\n\näºŒã€ä¸€äº›ä½¿ç”¨åœºæ™¯ä¸Šè¿°demoå·®ä¸å¤šå°±æ˜¯æˆ‘å¹³æ—¶ç”¨çš„å‰åç«¯åˆ†ç¦»çš„ä»£ç†é…ç½®æ–¹æ¡ˆã€‚ä¸‹é¢æ˜¯ä¸€äº›é‡åˆ°è¿‡çš„åœºæ™¯ã€‚\né…ç½®ä¸€ä¸ªé™æ€æ–‡ä»¶ä¸‹è½½æœåŠ¡ï¼Œæˆ‘ä»¬ä¸‹é¢è½¯ä»¶ä¼šç»å¸¸çœ‹åˆ°index /çš„é¡µé¢ã€‚\nserver &#123;        listen       8888;        #ç«¯å£        server_name  _;   #æœåŠ¡å        charset utf-8,gbk;        root    /data/download;  #æ˜¾ç¤ºçš„æ ¹ç´¢å¼•ç›®å½•        autoindex on;             #å¼€å¯ç´¢å¼•åŠŸèƒ½        autoindex_exact_size off; # å…³é—­è®¡ç®—æ–‡ä»¶ç¡®åˆ‡å¤§å°ï¼ˆå•ä½bytesï¼‰ï¼Œåªæ˜¾ç¤ºå¤§æ¦‚å¤§å°ï¼ˆå•ä½kbã€mbã€gbï¼‰        autoindex_localtime on;   # æ˜¾ç¤ºæœ¬æœºæ—¶é—´è€Œé GMT æ—¶é—´&#125;\n\né…ç½®httpé‡å®šå‘åˆ°https\nserver &#123;    listen 80;    server_name demo.com;    rewrite ^(.*)$ https://$&#123;server_name&#125;$1 permanent; &#125;                   server &#123;    listen       443;    server_name  demo.com;    charset utf-8;    location / &#123;       alias   /data/web;       index  index.html index.htm;    &#125;&#125;\n\né…ç½®é™æ€å‰ç«¯é¡µé¢\nlocation / &#123;    alias   /data/web;    index  index.html index.htm;&#125;\n\né…ç½®åå‘ä»£ç†, æ¯”å¦‚æˆ‘ä»¬è®¿é—®http://demo.com/api/aaa/bbbï¼Œæˆ‘ä»¬æƒ³è¦ä»£ç†åˆ°http://api.com/api/aaa/bbb, åªåˆ‡æ¢äº†åŸŸåï¼Œuriç›¸åŒã€‚\nupstream api_server &#123;  server 10.0.101.62:8081;  server 10.0.101.61:8082;&#125;location /api &#123;    proxy_pass  http://api_server;    proxy_set_header Host $host;    proxy_set_header  X-Real-IP        $remote_addr;    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;    proxy_set_header  your-custome-header    &quot;myHeader&quot;;    proxy_set_header X-NginX-Proxy true;&#125;\n\né…ç½®åå‘ä»£ç†æ—¶ï¼Œç§»é™¤å‰ç¼€ã€‚æ¯”å¦‚æˆ‘ä»¬çš„æœåŠ¡http://demo.com/users/aaa/bbb, æˆ‘ä»¬æƒ³è¦ä»£ç†åˆ°http://users.com/aaa/bbbï¼Œå³åˆ‡æ¢åŸŸåçš„åŒæ—¶ï¼Œå»æ‰userså‰ç¼€ã€‚åŒºåˆ«æ˜¯proxy_pass ç»“å°¾çš„/.\nlocation ^~/users/ &#123;    proxy_set_header Host $host;    proxy_set_header  X-Real-IP        $remote_addr;    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;    proxy_set_header X-NginX-Proxy true;    proxy_pass http://users.com/;&#125;\n\nåå‘ä»£ç†æ—¶ï¼Œæƒ³è¦è‡ªå®šä¹‰ä¿®æ”¹uriã€‚ä½¿ç”¨rewriteæ­£åˆ™ä¿®æ”¹ã€‚\n# ä¿®æ”¹uriï¼Œå»æ‰äº†flashçš„å‰ç¼€ï¼Œ$1è¡¨ç¤ºæ­£åˆ™åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²å†…å®¹ã€‚location ^~ /flash/ &#123;    root   /data/flash/dist/;    rewrite ^/flash/(.*)$  /$1 break;    index  index.html index.htm;&#125;# ä¿®æ”¹uri, é‡æ–°ä»£ç†åˆ°æ–°çš„åœ°å€location ^~/order/ &#123;    proxy_set_header Host $host;    proxy_set_header  X-Real-IP        $remote_addr;    proxy_set_header  X-Forwarded-For  $proxy_add_x_forwarded_for;    proxy_set_header X-NginX-Proxy true;    rewrite ^/order/(.*)$ /$1 break;    proxy_pass http://order;&#125;\n\nä»£ç†è·¨åŸŸ, æ¯”å¦‚bingæ¯æ—¥ä¸€å›¾ï¼Œä¸æ”¯æŒæˆ‘ä»¬ajaxè·å–å›¾ç‰‡åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªæ”¯æŒçš„æ¥å£ã€‚\nhttp://101.200.218.760/proxy/bing/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1\nä»£ç†å¯¹è±¡ä¸ºï¼šhttps://cn.bing.com/HPImageArchive.aspx?format=js&amp;idx=0&amp;n=1\nlocation ^~/proxy/bing/ &#123;    add_header &#x27;Access-Control-Allow-Origin&#x27; &#x27;http://localhost:8088&#x27;;    add_header &#x27;Cache-Control&#x27; &#x27;public, max-age=604800&#x27;;    add_header &#x27;Access-Control-Allow-Credentials&#x27; &#x27;true&#x27;;    add_header &#x27;Access-Control-Allow-Methods&#x27; &#x27;GET, POST, OPTIONS&#x27;;    rewrite ^/proxy/bing/(.*)$ /$1 break;    proxy_pass https://cn.bing.com/; &#125;\n","categories":["è¿ç»´","Nginx"]},{"title":"Nginx proxy_pass è½¬å‘è§„åˆ™","url":"/posts/23488/","content":"ä¸€ã€proxy_pass åªåŒ…å« HOSTä¾‹å¦‚ï¼š\n\nhttp://host - âˆš\nhttps://host - âˆš\nhttp://host:port - âˆš\nhttps://host:port - âˆš\nhttp://host/ - x\nhttp://host:port/ - x\n\nè¿™ç§æƒ…å†µä¸‹ï¼Œä¼šæŠŠåŒ¹é…åˆ°çš„æ‰€æœ‰è·¯å¾„ç›´æ¥ç©¿é€è½¬å‘ã€‚æ¯”å¦‚ä»¥ä¸‹çš„é…ç½®\nlocation /api/ &#123;  proxy_pass http://127.0.0.1:3000;&#125;\n\nè®¿é—® http://127.0.0.1:80/api/test, æœ€ç»ˆçš„è¯·æ±‚åœ°å€æ˜¯ http://127.0.0.1:3000/api/test\näºŒã€proxy_pass åŒ…å«è·¯å¾„è¿™é‡Œçš„è·¯å¾„å“ªæ€•åªæ˜¯ä¸€ä¸ª / ä¹Ÿæ˜¯å­˜åœ¨çš„ï¼Œå¦‚ï¼š\n\nhttp://host - x\n\nhttp://host:port- x\n\nhttps://host/ - âˆš\n\nhttps://host:port/ - âˆš\n\nhttp://host/api - âˆš\n\nhttp://host/api/ - âˆš\n\n\nè¿™ç§æƒ…å†µä¸‹ï¼Œurl é‡Œé¢ä¼š å»æ‰ location åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œæ‹¼æ¥åˆ° proxy_pass å†è¿›è¡Œè½¬å‘ã€‚\nlocation /api/ &#123;  proxy_pass http://127.0.0.1:3000/;&#125;\n\nè®¿é—® http://127.0.0.1:80/api/testï¼Œæœ€ç»ˆçš„è¯·æ±‚åœ°å€æ˜¯ http://127.0.0.1:3000/test\nä¸‰ã€é‡å†™ä»£ç†é“¾æ¥ - url rewriteä½¿ç”¨ rewrite æŒ‡ä»¤å¹¶ä¸”ç”Ÿæ•ˆåï¼Œproxy_pass url é“¾æ¥ä¸­çš„è·¯å¾„ä¼šè¢«å¿½ç•¥ï¼Œå¦‚ï¼š\nserver &#123;  listen       83;  location / &#123;  rewrite ^/api/(.*) /fixpath=$1 break;  proxy_pass http://127.0.0.1:3000/node/;&#125;location ^/api/ &#123;  rewrite ^/api/(.*) /fixpath=$1 break   # $1è¡¨ç¤ºæ­£åˆ™åŒ¹é…åˆ°çš„å­—ç¬¦ä¸²å†…å®¹ã€‚  proxy_pass http://127.0.0.1:3000/node/;  &#125;&#125;\n\nè®¿é—® http://127.0.0.1:83/bb/ccï¼Œæœ€ç»ˆçš„è¯·æ±‚åœ°å€æ˜¯ http://127.0.0.1:3000/node/bb/ccï¼Œå› ä¸ºåŒ¹é…ä¸Š / äº†ï¼Œæ²¡æœ‰åŒ¹é… rewrite ã€‚\nè®¿é—® http://127.0.0.1:83/api/ccï¼Œæœ€ç»ˆçš„è¯·æ±‚åœ°å€æ˜¯ http://127.0.0.1:3000/fixpath=ccï¼Œæˆ‘ä»¬å†™çš„ proxy_pass http://127.0.0.1:3000/node/ é‡Œé¢çš„ node è·¯å¾„ä¸¢å¤±äº†ã€‚\n","categories":["è¿ç»´","Nginx"]},{"title":"RabbitMQ","url":"/posts/33708/","content":"æ™®é€šé›†ç¾¤æ¨¡å¼\nRabbitMQ çš„æ™®é€šé›†ç¾¤æ¨¡å¼æ˜¯ä¸èƒ½é«˜å¯ç”¨çš„ï¼Œå› ä¸ºå…¶ä»–èŠ‚ç‚¹åªåŒæ­¥å…ƒæ•°æ®ã€‚å…¶ä¸­æ¶ˆæ¯åªåœ¨å…¶æ‰€åœ¨èŠ‚ç‚¹ä¸­ä¿å­˜ã€‚å®¢æˆ·ç«¯å¯ä»¥è¿æ¥ä»»æ„èŠ‚ç‚¹å‘é˜Ÿåˆ—å‘é€æˆ–æ¶ˆè´¹æ¶ˆæ¯ï¼Œè‹¥éé˜Ÿåˆ—æ•°æ®æ‰€åœ¨èŠ‚ç‚¹ï¼Œåˆ™è¯¥èŠ‚ç‚¹ä¼šè¿›è¡Œè·¯ç”±è½¬å‘ã€‚\nå…ƒæ•°æ®ï¼š\né˜Ÿåˆ—æ•°æ®ï¼šé˜Ÿåˆ—åç§°å’Œå±æ€§\näº¤æ¢å™¨å…ƒæ•°æ®ï¼šäº¤æ¢å™¨åç§°ã€ç±»å‹ã€å±æ€§\nç»‘å®šå…ƒæ•°æ®ï¼šæè¿°äº†å¦‚æœå°†æ¶ˆæ¯è·¯ç”±åˆ°é˜Ÿåˆ—\nvhost å…ƒæ•°æ®ï¼šä¸º vhost å†…çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šæä¾›å‘½åç©ºé—´å’Œå®‰å…¨å±æ€§\n\nä¸ºä»€ä¹ˆåªåŒæ­¥å…ƒæ•°æ®ï¼Ÿ\nå­˜å‚¨ç©ºé—´ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½ä¿å­˜å…¨é‡æ•°æ®ï¼Œè‹¥èŠ‚ç‚¹é—´å­˜å‚¨ç©ºé—´å¤§å°ä¸ä¸€æ ·ï¼Œä¼šå½±å“æ¶ˆæ¯å †ç§¯èƒ½åŠ›\næ€§èƒ½ï¼šæ¶ˆæ¯çš„å‘å¸ƒè€…éœ€è¦å°†æ¶ˆæ¯å¤åˆ¶åˆ°æ¯ä¸€ä¸ªé›†ç¾¤èŠ‚ç‚¹\n\né›†ç¾¤èŠ‚ç‚¹ç±»å‹\nç£ç›˜èŠ‚ç‚¹ï¼šé…ç½®ä¿¡æ¯ã€å…ƒæ•°æ®ã€æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨ç£ç›˜ä¸Š\nå†…å­˜èŠ‚ç‚¹ï¼šé…ç½®ä¿¡æ¯ã€å…ƒæ•°æ®ã€æ¶ˆæ¯éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚å†…å­˜èŠ‚ç‚¹ç»´æŠ¤äº†ç£ç›˜èŠ‚ç‚¹çš„åœ°å€ï¼Œä¼šå°†å‰è¾¹è¯´çš„ä¿¡æ¯åŒæ­¥è‡³ç£ç›˜èŠ‚ç‚¹è¿›è¡ŒæŒä¹…åŒ–ã€‚å…¶æ€§èƒ½ä¼˜äºç£ç›˜èŠ‚ç‚¹ã€‚\n\nRabbitMQ è¦æ±‚é›†ç¾¤æ±‡æ€»è‡³å°‘æœ‰ä¸€ä¸ªç£ç›˜èŠ‚ç‚¹ï¼Œå½“èŠ‚ç‚¹åŠ å…¥å’Œç¦»å¼€é›†ç¾¤æ—¶ï¼Œå¿…é¡»é€šçŸ¥ç£ç›˜èŠ‚ç‚¹ï¼ˆå¦‚æœé›†ç¾¤ä¸­å”¯ä¸€çš„ç£ç›˜èŠ‚ç‚¹å´©æºƒï¼Œåˆ™ä¸èƒ½è¿›è¡Œåˆ›å»ºé˜Ÿåˆ—ã€åˆ›å»ºäº¤æ¢å™¨ã€åˆ›å»ºç»‘å®šã€æ·»åŠ ç”¨æˆ·ã€æ›´æ”¹æƒé™ã€æ·»åŠ å’Œåˆ é™¤é›†ç¾¤èŠ‚ç‚¹ï¼‰ã€‚å¦‚æœå”¯ä¸€çš„ç£ç›˜èŠ‚ç‚¹å´©æºƒï¼Œé›†ç¾¤æ˜¯å¯ä»¥ä¿æŒè¿è¡Œçš„ï¼Œä½†ä¸èƒ½æ›´æ”¹ä»»ä½•ä¸œè¥¿ã€‚å› æ­¤å»ºè®®åœ¨é›†ç¾¤ä¸­è®¾å€¼ä¸¤ä¸ªç£ç›˜èŠ‚ç‚¹ã€‚\n","categories":["è¿ç»´","RabbitMQ"]},{"title":"Docker æ­å»º Redis é›†ç¾¤ä»¥åŠå“ˆå¸Œæ§½åŠ¨æ€æ‰©å®¹","url":"/posts/29004/","content":"ä¸€ã€åˆ›å»ºç½‘ç»œdocker network create --subnet=172.10.1.0/24 redis\n\näºŒã€åˆ›å»º Redis å®¹å™¨åˆ›å»º6ä¸ªrediså®ä¾‹\ndocker create --name redis1 --net host --privileged=true -v /data/redis/share/redis1:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6381docker create --name redis2 --net host --privileged=true -v /data/redis/share/redis2:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6382docker create --name redis3 --net host --privileged=true -v /data/redis/share/redis3:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6383docker create --name redis4 --net host --privileged=true -v /data/redis/share/redis4:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6384docker create --name redis5 --net host --privileged=true -v /data/redis/share/redis5:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6385docker create --name redis6 --net host --privileged=true -v /data/redis/share/redis6:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6386\n\nå‘½ä»¤è¯´æ˜ï¼š\n\ndocker create                          // åˆ›å»ºå®¹å™¨\nâ€“name redis1                         // å®¹å™¨å\nâ€“net host                                // dockerç½‘ç»œï¼Œä½¿ç”¨å®¿ä¸»æœºçš„ipå’Œç«¯å£\nâ€“privileged=true                   // dockerå®¹å™¨ï¼Œè·å–å®¿ä¸»æœºrootæƒé™\n-v /data/redis/share/redis1:/data     // å®¹å™¨çš„/data æŒ‚è½½åˆ°å®¿ä¸»æœº /data/redis/share/redis-node-1\nredis:5.0.7                              // redis é•œåƒåç§°å’Œç‰ˆæœ¬å·\nâ€“cluster-enabled yes           // redis.confçš„é…ç½®ï¼šå¼€å¯redisé›†ç¾¤\nâ€“appendonly yes                 // redis.confçš„é…ç½®ï¼šå¼€å¯æ•°æ®æŒä¹…åŒ–\nâ€“port 6381                           // redis.confçš„é…ç½®ï¼šredisç«¯å£å·\n\nä¸‰ã€å¯åŠ¨å®¹å™¨docker start redis1 redis2 redis3 redis4 redis5 redis6\n\nå››ã€åˆ›å»ºé›†ç¾¤1.è¿›å…¥redis1å®¹å™¨ä¸­docker exec -it redis1 /bin/bash\n\n2.é…ç½®ä¸€ä¸»ä¸€ä»redis-cli --cluster create 192.168.20.10:6381 192.168.20.10:6382 192.168.20.10:6383 192.168.20.10:6384 192.168.20.10:6385 192.168.20.10:6386 --cluster-replicas 1\n\n3.æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯ï¼ˆ1ï¼‰è¿›å…¥rediså®¢æˆ·ç«¯redis-cli -h 192.168.20.10 -p 6381 -c\n\nï¼ˆ2ï¼‰æŸ¥çœ‹é›†ç¾¤ä¿¡æ¯cluster info\n\nï¼ˆ3ï¼‰æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯cluster nodes\n\nï¼ˆ4ï¼‰æŸ¥çœ‹é›†ç¾¤æ§½ä½ä¿¡æ¯é€€å‡ºrediså®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤\nredis-cli --cluster check 192.168.20.10:6381\n\näº”ã€redisé›†ç¾¤å“ˆå¸Œæ§½æ‰©å®¹1.æ–°å¢ä¸¤å°redisdocker create --name redis-node-7 --net host --privileged=true -v /data/redis/share/redis-node-7:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6387docker create --name redis-node-8 --net host --privileged=true -v /data/redis/share/redis-node-8:/data redis:5.0.7 --cluster-enabled yes --appendonly yes --port 6388\n\n2.å¯åŠ¨å®¹å™¨docker start redis-node-7 redis-node-8\n\n3.æ·»åŠ 6387ä¸ºmasterèŠ‚ç‚¹ï¼ˆ1ï¼‰è¿›å…¥å®¹å™¨å†…docker exec -it redis-node-7 /bin/bash\n\nï¼ˆ2ï¼‰æ·»åŠ èŠ‚ç‚¹redis-cli --cluster add-node 192.168.20.10:6387 192.168.20.10:6381\n\nè¯´æ˜ï¼š\n\n192.168.20.10:6387ï¼šè¢«æ·»åŠ èŠ‚ç‚¹\n192.168.20.10:6381ï¼šé›†ç¾¤å†…ä»»æ„èŠ‚ç‚¹\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster add-node 192.168.20.10:6387 192.168.20.10:6381&gt;&gt;&gt; Adding node 192.168.20.10:6387 to cluster 192.168.20.10:6381&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[0-5460] (5461 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[5461-10922] (5462 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[10923-16383] (5461 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0f[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.20.10:6387 to make it join the cluster.[OK] New node added correctly.123456789101112131415161718192021222324252627\n\nï¼ˆ3ï¼‰æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 5461 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 5462 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 5461 slots | 1 slaves.192.168.20.10:6387 (c4629e20...) -&gt; 0 keys | 0 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[0-5460] (5461 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[5461-10922] (5462 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[10923-16383] (5461 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots: (0 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\né€šè¿‡ä¿¡æ¯å¯ä»¥å‘ç°ï¼Œ6387 èŠ‚ç‚¹è™½ç„¶å·²æˆåŠŸåŠ å…¥åˆ°é›†ç¾¤ï¼Œä½†å¹¶æœªåˆ†é…æ§½å·ã€‚\nï¼ˆ4ï¼‰åˆ†é…æ§½å·redis-cli --cluster reshard 192.168.20.10:6381\n\nè¯´æ˜ï¼š\n\n192.168.20.10:6381ï¼šé›†ç¾¤ä¸­ä»»æ„èŠ‚ç‚¹ ip:port\n\næ‰§è¡Œç»“æœ\nroot@dev:/data# redis-cli --cluster reshard 192.168.20.10:6381&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[0-5460] (5461 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[5461-10922] (5462 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[10923-16383] (5461 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots: (0 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)? 4096        # è®¾ç½®æ§½æ•°æ® 16384/master å°æ•°What is the receiving node ID? c4629e200d17cfa3625d5769e279e02948a1386b    # è¾“å…¥æ–°èŠ‚ç‚¹ node idPlease enter all the source node IDs.    Type &#x27;all&#x27; to user all the nodes as source nodes for the hash slots.    Type &#x27;done&#x27; once you entered all the source nodes IDs.Source node #1: all                  # è¡¨ç¤ºå…¨éƒ¨èŠ‚ç‚¹é‡æ–°åˆ†é…æ§½å·\n\nï¼ˆ5ï¼‰å†æ¬¡æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381 192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 4096 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6387 (c4629e20...) -&gt; 0 keys | 4096 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[1365-5460] (4096 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\nå¯ä»¥çœ‹å‡ºæ¯ä¸ªèŠ‚ç‚¹éƒ½åˆ†é…äº† 4096 ä¸ªæ§½å·ï¼Œä½†æ˜¯ æ–°åŠ å…¥çš„èŠ‚ç‚¹æ‰€åˆ†é…çš„æ§½å·å¹¶ä¸æ˜¯è¿ç»­çš„ã€‚\nå› ä¸ºå¯¹äºæ–°åŠ å…¥çš„èŠ‚ç‚¹ï¼Œè¦é‡æ–°åˆ†é…æ§½å·æˆæœ¬è¾ƒå¤§ï¼Œæ•…ä»ä¸‰ä¸ªæ—§èŠ‚ç‚¹ç§»åŠ¨éƒ¨åˆ†æ§½å·ç»™æ–°èŠ‚ç‚¹ã€‚\n4.ä¸ºæ–°åŠ å…¥çš„masterèŠ‚ç‚¹åˆ†é…ä»èŠ‚ç‚¹ï¼ˆ1ï¼‰å°† 6388 è®¾ç½®ä¸º 6387 ä»èŠ‚ç‚¹redis-cli --cluster add-node 192.168.20.10:6388 192.168.20.10:6387 --cluster-slave --cluster-master-id c4629e200d17cfa3625d5769e279e02948a1386b\n\nè¯´æ˜ï¼š\n\nadd-nodeï¼šåè¾¹åˆ†åˆ«ä¸ºæ–°åŠ å…¥çš„èŠ‚ç‚¹å’ŒèŠ‚ç‚¹å¯¹åº”çš„mastercluster-slaveï¼šè¡¨ç¤ºæ–°åŠ å…¥çš„èŠ‚ç‚¹æ˜¯slaveèŠ‚ç‚¹â€“cluster-master-idï¼šè¡¨ç¤ºslaveå¯¹åº”çš„masterçš„node ID\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster add-node 192.168.20.10:6388 192.168.20.10:6387 --cluster-slave --cluster-master-id c4629e200d17cfa3625d5769e279e02948a1386b&gt;&gt;&gt; Adding node 192.168.20.10:6388 to cluster 192.168.20.10:6387&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6387)M: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) masterM: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[1365-5460] (4096 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.&gt;&gt;&gt; Send CLUSTER MEET to node 192.168.20.10:6388 to make it join the cluster.Waiting for the cluster to join&gt;&gt;&gt; Configure node as replica of 192.168.20.10:6387.[OK] New node added correctly.\n\nï¼ˆ2ï¼‰æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 4096 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6387 (c4629e20...) -&gt; 0 keys | 4096 slots | 1 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[1365-5460] (4096 slots) master   1 additional replica(s)S: 7f81ef37a7ae89311f0c58542a3b92b87879e8a5 192.168.20.10:6388   slots: (0 slots) slave   replicates c4629e200d17cfa3625d5769e279e02948a1386bM: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master   1 additional replica(s)[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\nå¯ä»¥çœ‹å‡ºä»èŠ‚ç‚¹å·²åŠ å…¥æˆåŠŸã€‚\nå…­ã€redisé›†ç¾¤å“ˆå¸Œæ§½æ”¶ç¼©ï¼ˆ1ï¼‰åˆ é™¤masterå¯¹åº”slaveèŠ‚ç‚¹redis-cli --cluster del-node 192.168.20.10:6388 7f81ef37a7ae89311f0c58542a3b92b87879e8a5\n\nè¯´æ˜ï¼š\n\n192.168.20.10:6388ï¼šå¯¹åº”è¢«åˆ é™¤èŠ‚ç‚¹7f81ef37a7ae89311f0c58542a3b92b87879e8a5ï¼šå¯¹åº”è¢«åˆ é™¤èŠ‚ç‚¹ node id\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster del-node 192.168.20.10:6388 7f81ef37a7ae89311f0c58542a3b92b87879e8a5&gt;&gt;&gt; Removing node 7f81ef37a7ae89311f0c58542a3b92b87879e8a5 from cluster 192.168.20.10:6388&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node.\n\nï¼ˆ2ï¼‰æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 4096 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6387 (c4629e20...) -&gt; 0 keys | 4096 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[1365-5460] (4096 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\nå¯ä»¥çœ‹å‡ºé›†ç¾¤ä¸­å·²æ—  6388 èŠ‚ç‚¹ã€‚\nï¼ˆ3ï¼‰æŸ¥çœ‹å®¹å™¨é€€å‡ºå®¹å™¨ï¼ŒæŸ¥çœ‹å®¹å™¨çŠ¶æ€ï¼Œå¯ä»¥çœ‹åˆ° redis-node-8 å®¹å™¨å·²è¢«åœç”¨\nroot@dev:~# docker ps CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMESc9827168c61d        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   2 hours ago         Up 2 hours                              redis-node-7d1ad96f4a4ee        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 3 hours                              redis6db82428f5225        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 3 hours                              redis55a0c7a3516f5        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 2 hours                              redis4cf9863611d0b        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 3 hours                              redis37fa64b2a8071        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 3 hours                              redis2eae771794f0c        redis:5.0.7         &quot;docker-entrypoint.sâ€¦&quot;   9 days ago          Up 2 hours                              redis1\n\nï¼ˆ4ï¼‰é‡æ–°åˆ†é… 6387 çš„æ§½å·éœ€å…ˆè¿›å…¥ä»»æ„ä¸€å°rediså®¹å™¨\næ‰§è¡Œå‘½ä»¤\nredis-cli --cluster reshard 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster reshard 192.168.20.10:6381&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[1365-5460] (4096 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots:[0-1364],[5461-6826],[10923-12287] (4096 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.How many slots do you want to move (from 1 to 16384)? 4096      # è¢«åˆ é™¤çš„æ§½çš„æ•°é‡What is the receiving node ID? e3b687667d24189134183edac32bf9a4f69c6033   # æ¥æ‰‹è¢«åˆ é™¤æ§½å·çš„ node idï¼Œè¿™é‡ŒæŒ‡å®šç»™ 6381ã€‚è¿™é‡Œåªèƒ½è¾“å…¥ä¸€ä¸ªnode idï¼Œè‹¥æƒ³å°†æ§½å·åˆ†é…ç»™å¤šä¸ª node éœ€è¦å¤šæ¬¡æ‰§è¡Œè¯¥å‘½ä»¤Please enter all the source node IDs.  Type &#x27;all&#x27; to use all the nodes as source nodes for the hash slots.  Type &#x27;done&#x27; once you entered all the source nodes IDs.Source node #1: c4629e200d17cfa3625d5769e279e02948a1386b     # åˆ é™¤æ§½å·çš„node idSource node #2: done          # done è¡¨ç¤ºè¾“å…¥node id ç»“æŸï¼ˆè¿™é‡Œå¯ä»¥è¾“å…¥å¤šä¸ªnode idï¼‰Do you want to proceed with the proposed reshard plan (yes/no)? yes\n\nï¼ˆ5ï¼‰å†æ¬¡æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 8192 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 4096 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 4096 slots | 1 slaves.192.168.20.10:6387 (c4629e20...) -&gt; 0 keys | 0 slots | 0 slaves.[OK] 1 keys in 4 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[0-6826],[10923-12287] (8192 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0fM: c4629e200d17cfa3625d5769e279e02948a1386b 192.168.20.10:6387   slots: (0 slots) master[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\nè¿™é‡Œå¯ä»¥çœ‹åˆ° 6387 å·²ä¸åŒ…å«ä»»ä½•æ§½å·ã€‚\nï¼ˆ6ï¼‰åˆ é™¤èŠ‚ç‚¹ 6387redis-cli --cluster del-node 192.168.20.10:6387 c4629e200d17cfa3625d5769e279e02948a1386b\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster del-node 192.168.20.10:6387 c4629e200d17cfa3625d5769e279e02948a1386b&gt;&gt;&gt; Removing node c4629e200d17cfa3625d5769e279e02948a1386b from cluster 192.168.20.10:6387&gt;&gt;&gt; Sending CLUSTER FORGET messages to the cluster...&gt;&gt;&gt; SHUTDOWN the node.\n\nï¼ˆ7ï¼‰å†æ¬¡æŸ¥çœ‹èŠ‚ç‚¹ä¿¡æ¯redis-cli --cluster check 192.168.20.10:6381\n\næ‰§è¡Œç»“æœï¼š\nroot@dev:/data# redis-cli --cluster check 192.168.20.10:6381192.168.20.10:6381 (e3b68766...) -&gt; 0 keys | 8192 slots | 1 slaves.192.168.20.10:6382 (981842c6...) -&gt; 1 keys | 4096 slots | 1 slaves.192.168.20.10:6383 (1b826b53...) -&gt; 0 keys | 4096 slots | 1 slaves.[OK] 1 keys in 3 masters.0.00 keys per slot on average.&gt;&gt;&gt; Performing Cluster Check (using node 192.168.20.10:6381)M: e3b687667d24189134183edac32bf9a4f69c6033 192.168.20.10:6381   slots:[0-6826],[10923-12287] (8192 slots) master   1 additional replica(s)M: 981842c6e96abe8abc34326400565e0b2c44dd0f 192.168.20.10:6382   slots:[6827-10922] (4096 slots) master   1 additional replica(s)S: 4f65496819a0490760d4e1375fb7a371732a1ba8 192.168.20.10:6386   slots: (0 slots) slave   replicates 1b826b5348a69af7054e04c3908ee066e9649ae0S: c450e9af3b9d84c4e8cee6e70e7317628c4a9960 192.168.20.10:6384   slots: (0 slots) slave   replicates e3b687667d24189134183edac32bf9a4f69c6033M: 1b826b5348a69af7054e04c3908ee066e9649ae0 192.168.20.10:6383   slots:[12288-16383] (4096 slots) master   1 additional replica(s)S: 88be3f5ac4cd4c468004e829f3857666e9ff9bc5 192.168.20.10:6385   slots: (0 slots) slave   replicates 981842c6e96abe8abc34326400565e0b2c44dd0f[OK] All nodes agree about slots configuration.&gt;&gt;&gt; Check for open slots...&gt;&gt;&gt; Check slots coverage...[OK] All 16384 slots covered.\n\nå¯ä»¥çœ‹å‡º 6387 èŠ‚ç‚¹å·²è¢«åˆ é™¤ã€‚\n","categories":["è¿ç»´","Redis"]},{"title":"Redis stringå¸¸ç”¨å‘½ä»¤","url":"/posts/54115/","content":"setè¯­æ³•ï¼š SET key value [NX] [XX] [EX &lt;seconds&gt;] [PX [millseconds]] è®¾ç½®ä¸€å¯¹key valueå¿…é€‰å‚æ•°è¯´æ˜  \nSETï¼šå‘½ä»¤keyï¼šå¾…è®¾ç½®çš„keyvalue: è®¾ç½®çš„keyçš„value\nå¯é€‰å‚æ•°è¯´æ˜NXï¼šè¡¨ç¤ºkeyä¸å­˜åœ¨æ‰è®¾ç½®ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›NULLXXï¼šè¡¨ç¤ºkeyå­˜åœ¨æ—¶æ‰è®¾ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›NULLEX secondsï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ç²¾ç¡®ä¸ºç§’PX millsecondï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ç²¾ç¡®ä¸ºæ¯«ç§’\nSETï¼šå‘½ä»¤\n127.0.0.1:6379&gt; set user1 &#x27;&#123;&quot;id&quot;:1,&quot;username&quot;:&quot;agan01&quot;,&quot;password&quot;:&quot;123456&quot;,&quot;sex&quot;:1&#125;&#x27;OK127.0.0.1:6379&gt; get user1&quot;&#123;\\&quot;id\\&quot;:1,\\&quot;username\\&quot;:\\&quot;agan01\\&quot;,\\&quot;password\\&quot;:\\&quot;123456\\&quot;,\\&quot;sex\\&quot;:1&#125;&quot;\n\nNXï¼šè¡¨ç¤ºkeyä¸å­˜åœ¨æ‰è®¾ç½®ï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›NULL\n127.0.0.1:6379&gt; set user1 &#x27;&#123;&quot;id&quot;:1,&quot;username&quot;:&quot;agan01&quot;,&quot;password&quot;:&quot;123456&quot;,&quot;sex&quot;:1&#125;&#x27; NX(nil)å› ä¸ºuser1å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥è®¾ç½®å¤±è´¥ï¼Œè¿”å›nil\n\nXXï¼šè¡¨ç¤ºkeyå­˜åœ¨æ—¶æ‰è®¾ç½®ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›NULL\n127.0.0.1:6379&gt; set user1 &#x27;&#123;&quot;id&quot;:2,&quot;username&quot;:&quot;agan01&quot;,&quot;password&quot;:&quot;123456&quot;,&quot;sex&quot;:1&#125;&#x27; XXOK127.0.0.1:6379&gt; get user1&quot;&#123;\\&quot;id\\&quot;:2,\\&quot;username\\&quot;:\\&quot;agan01\\&quot;,\\&quot;password\\&quot;:\\&quot;123456\\&quot;,\\&quot;sex\\&quot;:1&#125;&quot;\n\nEX secondsï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ç²¾ç¡®ä¸ºç§’é‡‡ç”¨ttlæŸ¥çœ‹å‰©ä½™è¿‡æœŸæ—¶é—´\n127.0.0.1:6379&gt; set user1 &#x27;&#123;&quot;id&quot;:2,&quot;username&quot;:&quot;agan01&quot;,&quot;password&quot;:&quot;123456&quot;,&quot;sex&quot;:1&#125;&#x27; EX 600OK\n\nPX millsecondï¼šè®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œè¿‡æœŸæ—¶é—´ç²¾ç¡®ä¸ºæ¯«ç§’\n127.0.0.1:6379&gt; set user1 &#x27;&#123;&quot;id&quot;:2,&quot;username&quot;:&quot;agan01&quot;,&quot;password&quot;:&quot;123456&quot;,&quot;sex&quot;:1&#125;&#x27; PX 600000OK\nsetnxè¯­æ³•ï¼šSETNX key valueæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°,è®¾ç½®ä¸€å¯¹key valueï¼Œå¦‚æœkeyå­˜åœ¨ï¼Œåˆ™è®¾ç½®å¤±è´¥ï¼Œç­‰åŒäº SET key value NX\nsetexè¯­æ³•ï¼šSETEX key expire valueæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼Œè®¾ç½®ä¸€å¯¹ key valueï¼Œå¹¶è®¾è¿‡æœŸæ—¶é—´,å•ä½ä¸ºç§’ï¼Œç­‰åŒäº SET key value EX expire\npsetexè¯­æ³•ï¼šPSETEX key expire valueæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼Œè®¾ç½®ä¸€å¯¹ key valueï¼Œå¹¶è®¾è¿‡æœŸæ—¶é—´,å•ä½ä¸ºæ¯«ç§’ï¼Œç­‰åŒäº SET key value PX expire\nmsetä½œç”¨ï¼šæ‰¹é‡è®¾å€¼è¯­æ³•ï¼šMSET key1 value1 [key2 value2 key3 value3 â€¦]æ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰ï¼Œkeyã€valueå¯¹è‡³å°‘ä¸ºä¸€å¯¹ã€‚è¯¥å‘½ä»¤åŠŸèƒ½æ˜¯è®¾ç½®å¤šå¯¹key-valueå€¼ã€‚\nmgetä½œç”¨ï¼šæ‰¹é‡å–å€¼è¯­æ³•ï¼šMGET key1 [key2 key3 â€¦]æ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰ï¼Œkeyå€¼è‡³å°‘ä¸ºä¸€ä¸ªï¼Œè·å–å¤šä¸ªkeyçš„valueå€¼ï¼Œkeyå€¼å­˜çš„è¿”å›å¯¹åº”çš„valueï¼Œä¸å­˜åœ¨çš„è¿”å›NULL\n127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3OK127.0.0.1:6379&gt; mget k1 k2 k31) &quot;v1&quot;2) &quot;v2&quot;3) &quot;v3&quot;\ngetsetä½œç”¨ï¼šå…ˆæŸ¥keyå‡ºvalueçš„å€¼ï¼Œç„¶åå†ä¿®æ”¹æ–°å€¼è¯­æ³•ï¼šGETSET key valueæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼Œè·å–æŒ‡å®škeyçš„valueï¼Œå¹¶è®¾ç½®keyçš„å€¼ä¸ºæ–°å€¼value\n127.0.0.1:6379&gt; getset user1 agan1&quot;&#123;\\&quot;id\\&quot;:2,\\&quot;username\\&quot;:\\&quot;agan01\\&quot;,\\&quot;password\\&quot;:\\&quot;123456\\&quot;,\\&quot;sex\\&quot;:1&#125;&quot;127.0.0.1:6379&gt; get user1&quot;agan1&quot;\nsetrangeä½œç”¨ï¼šä¸ºæŸä¸ªkeyï¼Œä¿®æ”¹åç§»é‡offsetåçš„å€¼ä¸ºvalueè¯­æ³•ï¼šSETRANGE key offset valueæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼Œè®¾ç½®æŒ‡å®škeyï¼Œåç§»é‡offsetåçš„å€¼ä¸ºvalueï¼Œå½±å“èŒƒå›´ä¸ºvalueçš„é•¿åº¦ï¼Œ offsetä¸èƒ½å°äº0\n127.0.0.1:6379&gt; set user 123456OK127.0.0.1:6379&gt; setrange user 2 agan(integer) 6127.0.0.1:6379&gt; get user&quot;12agan&quot;\n\ngetrangeä½œç”¨ï¼šæˆªå–å­—ç¬¦ä¸²è¯­æ³•ï¼šGETRANGE key start endæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼Œè·å–æŒ‡å®škeyæŒ‡å®šåŒºé—´çš„valueå€¼,startã€endå¯ä»¥ä¸ºè´Ÿæ•°ï¼Œå¦‚æœä¸ºè´Ÿæ•°åˆ™åå‘å–åŒºé—´\n127.0.0.1:6379&gt; get user&quot;12agan&quot;127.0.0.1:6379&gt; getrange user 1 3&quot;2ag&quot;127.0.0.1:6379&gt; getrange user 0 3&quot;12ag&quot;\nappendä½œç”¨ï¼šå­—ç¬¦ä¸²æ‹¼æ¥è¯­æ³•ï¼šAPPEND key str\n127.0.0.1:6379&gt; set user 123OK127.0.0.1:6379&gt; append user abc(integer) 6127.0.0.1:6379&gt; get user&quot;123abc&quot;\nsubsträ½œç”¨ï¼šå­—ç¬¦ä¸²æˆªå–è¯­æ³•ï¼šSUBSTR key str\n127.0.0.1:6379&gt; get user&quot;123abc&quot;127.0.0.1:6379&gt; substr user 0 3&quot;123a&quot;\n\næ•°å­—æ“ä½œincrä½œç”¨ï¼šè®¡æ•°å™¨è¯­æ³•ï¼š incr keyæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰ï¼ŒæŒ‡å®škeyåšåŠ 1æ“ä½œã€‚æŒ‡å®škeyå¯¹åº”çš„å€¼å¿…é¡»ä¸ºæ•´å‹ï¼Œå¦åˆ™è¿”å›é”™è¯¯,æ“ä½œæˆåŠŸåè¿”å›æ“ä½œåçš„å€¼\n127.0.0.1:6379&gt; incr product01(integer) 1127.0.0.1:6379&gt; get product01&quot;1&quot;127.0.0.1:6379&gt; incr product01(integer) 2127.0.0.1:6379&gt; incr product01(integer) 3127.0.0.1:6379&gt; get product01&quot;3&quot;\n\ndecrè¯­æ³•ï¼š decr keyæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰ï¼ŒæŒ‡å®škeyåšå‡1æ“ä½œã€‚æŒ‡å®škeyå¯¹åº”çš„å€¼å¿…é¡»ä¸ºæ•´å‹ï¼Œå¦åˆ™è¿”å›é”™è¯¯,æ“ä½œæˆåŠŸåè¿”å›æ“ä½œåçš„å€¼ã€‚ä¸ºDECRçš„é€†æ“ä½œã€‚\n127.0.0.1:6379&gt; get product01&quot;3&quot;127.0.0.1:6379&gt; decr product01(integer) 2127.0.0.1:6379&gt; decr product01(integer) 1127.0.0.1:6379&gt; get product01&quot;1&quot;\n\nincrbyä½œç”¨ï¼šåŠ æ³•è¯­æ³•ï¼šincrby key dataæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼ŒæŒ‡å®škeyåšåŠ dataæ“ä½œ,æŒ‡å®škeyå¯¹åº”çš„å€¼å’Œdataå¿…é¡»ä¸ºæ•´å‹ï¼Œå¦åˆ™è¿”å›é”™è¯¯,æ“ä½œæˆåŠŸåè¿”å›æ“ä½œåçš„å€¼\n127.0.0.1:6379&gt; set product01 100OK127.0.0.1:6379&gt; get product01&quot;100&quot;127.0.0.1:6379&gt; incrby product01 20(integer) 120127.0.0.1:6379&gt; get product01&quot;120&quot;\n\ndecrbyä½œç”¨ï¼šå‡æ³•è¯­æ³•ï¼šDECRBY key dataæ‰€æœ‰å‚æ•°ä¸ºå¿…é€‰å‚æ•°ï¼ŒæŒ‡å®škeyåšå‡dataæ“ä½œ,æŒ‡å®škeyå¯¹åº”çš„å€¼å’Œdataå¿…é¡»ä¸ºæ•´å‹ï¼Œå¦åˆ™è¿”å›é”™è¯¯,æ“ä½œæˆåŠŸåè¿”å›æ“ä½œåçš„å€¼\n127.0.0.1:6379&gt; get product01&quot;120&quot;127.0.0.1:6379&gt; decrby product01 30(integer) 90127.0.0.1:6379&gt; get product01&quot;90&quot;\nincrbyfloatä½œç”¨ï¼šåœ¨åŸæœ‰çš„keyä¸ŠåŠ ä¸Šæµ®ç‚¹æ•°\nè¯­æ³•ï¼šincrbyfloat key num\n127.0.0.1:6379&gt; set money 10.5OK127.0.0.1:6379&gt; incrbyfloat money 2.2&quot;12.7&quot;","categories":["è¿ç»´","Redis"]},{"title":"Redis å‹ç¼©åˆ—è¡¨ziplist","url":"/posts/30991/","content":"1. Ziplist ç»“æ„\nzlbytesæ— ç¬¦å· 4 å­—èŠ‚æ•´æ•°ï¼Œä¿å­˜ ziplist å†…å­˜å¤§å°ã€‚\né€šè¿‡ zlbytes å¯ä»¥ç›´æ¥å¯¹ ziplist çš„å†…å­˜å¤§å°è¿›è¡Œè°ƒæ•´ï¼Œæ— éœ€éå†æ•´ä¸ªåˆ—è¡¨ã€‚\nzltailå‹ç¼©åˆ—è¡¨æœ€åä¸€ä¸ª entry è·ç¦»èµ·å§‹åœ°å€çš„åç§»é‡ï¼Œå  4 ä¸ªå­—èŠ‚ã€‚\nè¿™ä¸ªåç§»é‡ä½¿å¾—å¯¹è¡¨å°¾çš„ pop æ“ä½œå¯ä»¥åœ¨æ— éœ€éå†æ•´ä¸ªåˆ—è¡¨çš„æƒ…å†µä¸‹è¿›è¡Œã€‚\nzllenå‹ç¼©åˆ—è¡¨çš„ entry æ•°é‡ï¼Œå  2 ä¸ªå­—èŠ‚ã€‚\nå½“å‹ç¼©åˆ—è¡¨çš„å…ƒç´ æ•°é‡æ“ä½œ 2^16 - 2 æ—¶ï¼Œzllen ä¼šè®¾ç½®ä¸º 2^16 - 1ï¼Œæ­¤æ—¶è·å–å…ƒç´ æ•°é‡éœ€è¦éå†æ•´ä¸ªå‹ç¼©åˆ—è¡¨æ‰èƒ½è·å–åˆ°ã€‚\næ•… zllen ä¸èƒ½æ›¿ä»£ zltailã€‚\nentryå‹ç¼©è¡¨å­˜å‚¨æ•°æ®çš„èŠ‚ç‚¹ï¼Œ\nï¼ˆ1ï¼‰ç»“æ„\nprevlenï¼šå‰ä¸€ä¸ª entry çš„å¤§å°ï¼Œç”¨äºåå‘éå†ï¼›\nencodingï¼šç¼–ç ï¼Œè¡¨ç¤ºä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²æˆ–æ•´æ•°ï¼›\ndataï¼š å­˜å‚¨ entry ä¸­å®é™…æ•°æ®ã€‚\n\nï¼ˆ2ï¼‰prevlenä»¥å­—èŠ‚ä¸ºå•ä½ï¼Œè®°å½•äº†å‰ä¸€ä¸ªèŠ‚ç‚¹çš„é•¿åº¦ã€‚é•¿åº¦å¯ä»¥æ˜¯ 1 å­—èŠ‚ æˆ– 5 å­—èŠ‚ã€‚\n\nå‰èŠ‚ç‚¹é•¿åº¦å°äº254ï¼šprevlené•¿åº¦ 1 å­—èŠ‚ï¼Œç”¨äºå­˜å‚¨å‰èŠ‚ç‚¹é•¿åº¦ï¼›\nå‰èŠ‚ç‚¹é•¿åº¦å¤§äº254ï¼šprevlené•¿åº¦ä¸º 5 å­—èŠ‚ï¼Œç¬¬ä¸€ä¸ªå­—èŠ‚è®¾ç½®ä¸º 254ï¼Œåé¢ 4 ä¸ªå­—èŠ‚å­˜å‚¨å‰èŠ‚ç‚¹é•¿åº¦ã€‚\n\n\nprevlen å±æ€§ä¸»è¦ç”¨äº åå‘éå†ã€‚\né€šè¿‡ zltialï¼Œå¯ä»¥å¾—åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹ä½ç½®ï¼Œè·å–åˆ°å‰ä¸€ä¸ªèŠ‚ç‚¹ prevlen ï¼ŒæŒ‡é’ˆå‘å‰ç§»åŠ¨å³å¯æŒ‡å‘å€’æ•°ç¬¬äºŒä¸ªèŠ‚ç‚¹ã€‚ä»¥æ­¤ç±»æ¨ã€‚\nï¼ˆ3ï¼‰encodingè®°å½•äº†èŠ‚ç‚¹ä¸­ data çš„ æ•°æ®ç±»å‹ å’Œ é•¿åº¦ã€‚\nç±»å‹ä¸»è¦æœ‰ä¸¤ç§ï¼šå­—ç¬¦ä¸² å’Œ æ•´æ•°ã€‚\nå­—ç¬¦ä¸²å¦‚æœ encoding ä»¥ 00ã€01 æˆ–è€… 10å¼€å¤´ï¼Œè¡¨ç¤ºæ•°æ®ç±»å‹æ˜¯å­—ç¬¦ä¸²ã€‚\n#define ZIP_STR_06B (0 &lt;&lt; 6)#define ZIP_STR_14B (1 &lt;&lt; 6)#define ZIP_STR_32B (2 &lt;&lt; 6)\n\nå­—ç¬¦ä¸²æœ‰ä¸‰ç§ç¼–ç ï¼š\n\né•¿åº¦ &lt; 2^6ï¼šä»¥ 00 å¼€å¤´ï¼Œå 6 ä½è¡¨ç¤º data æ•°æ®çš„é•¿åº¦ï¼›\n2^6 &lt;= é•¿åº¦ &lt; 2^14ï¼šä»¥ 01 å¼€å¤´ï¼Œåç»­ 6 ä½ + ä¸‹ä¸€ä¸ªå­—èŠ‚çš„ 8 ä½ï¼ˆå…±14ä½ï¼‰ï¼Œè¡¨ç¤º data é•¿åº¦ï¼›\n2^14 &lt;= é•¿åº¦ &lt; 2^32ï¼šä»¥ 10 å¼€å¤´ï¼Œåç»­ 6 ä½ä¸ç”¨ï¼Œä»ä¸‹ä¸€ä¸ªå­—èŠ‚å¼€å§‹ï¼Œè¿ç»­ 32 ä½ è¡¨ç¤º data é•¿åº¦ã€‚\n\n\næ•´æ•°å¦‚æœ encoding ä»¥ 11 å¼€å¤´ï¼Œè¡¨ç¤ºæ•°æ®ç±»å‹ä¸ºæ•´æ•°ã€‚\n\nçœ‹äº†ä¸Šå›¾çš„æœ€åä¸€ä¸ªç±»å‹ï¼Œå¯èƒ½æœ‰å°ä¼™ä¼´å°±æœ‰ç–‘é—®ï¼šä¸ºå•¥æ²¡æœ‰ 11111111 ï¼Ÿç­”ï¼šå› ä¸º 11111111 è¡¨ç¤º zlend (åè¿›åˆ¶çš„ 255ï¼Œåå…­è¿›åˆ¶çš„ oxff)\nï¼ˆ4ï¼‰datadata è¡¨ç¤ºçœŸå®å­˜çš„æ•°æ®çš„ byteæ•°ç»„ï¼Œå¯ä»¥æ˜¯ å­—ç¬¦ä¸² æˆ–è€… æ•´æ•°ï¼Œä»ç¼–ç å¯ä»¥å¾—çŸ¥ç±»å‹å’Œé•¿åº¦ã€‚çŸ¥é“é•¿åº¦ï¼Œå°±çŸ¥é“ data çš„èµ·å§‹ä½ç½®äº†ã€‚\næ¯”è¾ƒç‰¹æ®Šçš„æ˜¯ï¼Œæ•´æ•° 1 ~ 13 (0001 ~ 1101)ï¼Œå› ä¸ºæ¯”è¾ƒçŸ­ï¼Œåˆšå¥½å¯ä»¥å¡åœ¨ encoding å­—æ®µé‡Œé¢ï¼Œæ‰€ä»¥å°±æ²¡æœ‰ dataã€‚\n2. è¿é”æ›´æ–°é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“ï¼š\n\nå‰ä¸ªèŠ‚ç‚¹çš„é•¿åº¦å°äº 254 çš„æ—¶å€™ï¼Œç”¨ 1 ä¸ªå­—èŠ‚ä¿å­˜ prevlen\nå‰ä¸ªå­—èŠ‚çš„é•¿åº¦å¤§äºç­‰äº 254 çš„æ—¶å€™ï¼Œç”¨ 5 ä¸ªå­—èŠ‚ä¿å­˜ prevlen\n\nç°åœ¨æˆ‘ä»¬æ¥è€ƒè™‘ä¸€ç§æƒ…å†µï¼šå‡è®¾ä¸€ä¸ªå‹ç¼©åˆ—è¡¨ä¸­ï¼Œæœ‰å¤šä¸ªé•¿åº¦ 250 ~ 253 çš„èŠ‚ç‚¹ï¼Œå‡è®¾æ˜¯ entry1 ~ entryNã€‚\nå› ä¸ºéƒ½æ˜¯å°äº 254ï¼Œæ‰€ä»¥éƒ½æ˜¯ç”¨ 1 ä¸ªå­—èŠ‚ ä¿å­˜ prevlenã€‚\nå¦‚æœæ­¤æ—¶ï¼Œåœ¨å‹ç¼©åˆ—è¡¨æœ€å‰é¢ï¼Œæ’å…¥ä¸€ä¸ª 254 é•¿åº¦çš„èŠ‚ç‚¹ï¼Œæ­¤æ—¶å®ƒçš„é•¿åº¦éœ€è¦ 5 ä¸ªå­—èŠ‚ã€‚\nä¹Ÿå°±æ˜¯è¯´ entry1.prevlen ä¼šä» 1 ä¸ªå­—èŠ‚å˜ä¸º 5 ä¸ªå­—èŠ‚ï¼Œå› ä¸º **prevlen **å˜é•¿ï¼Œentry1 çš„é•¿åº¦è¶…è¿‡ 254 äº†ã€‚\nè¿™ä¸‹å°±ç³Ÿç³•äº†ï¼Œentry2.prevlen ä¹Ÿä¼šå› ä¸º entry1 è€Œå˜é•¿ï¼Œentry2 é•¿åº¦ä¹Ÿä¼šè¶…è¿‡ 254 äº†ã€‚\nç„¶åæ¥ç€ entry3 ä¹Ÿä¼šè¿é”æ›´æ–°ã€‚ã€‚ã€‚ç›´åˆ°èŠ‚ç‚¹ä¸è¶…è¿‡ 254ï¼Œ å™©æ¢¦ç»ˆæ­¢ã€‚ã€‚ã€‚\nè¿™ç§ç”±äºä¸€ä¸ªèŠ‚ç‚¹çš„å¢åˆ ï¼Œåç»­èŠ‚ç‚¹å˜é•¿è€Œå¯¼è‡´çš„è¿ç»­é‡æ–°åˆ†é…å†…å­˜çš„ç°è±¡ï¼Œå°±æ˜¯è¿é”æ›´æ–°ã€‚æœ€åæƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´æ•´ä¸ªå‹ç¼©åˆ—è¡¨çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½é‡æ–°åˆ†é…å†…å­˜ã€‚\næ¯æ¬¡åˆ†é…ç©ºé—´çš„æœ€åæ—¶é—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œæ‰€ä»¥è¿é”æ›´æ–°çš„æœ€åæ—¶é—´å¤æ‚åº¦é«˜è¾¾ O(n2) !\nå½±å“è™½ç„¶è¯´ï¼Œè¿é”æ›´æ–°çš„æ—¶é—´å¤æ‚åº¦é«˜ï¼Œä½†æ˜¯å®ƒé€ æˆå¤§çš„æ€§èƒ½å½±å“çš„æ¦‚ç‡å¾ˆä½ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n\nå‹ç¼©åˆ—è¡¨ä¸­éœ€è¦éœ€è¦æœ‰è¿ç»­å¤šä¸ªé•¿åº¦åˆšå¥½ä¸º 250 ~ 253 çš„èŠ‚ç‚¹ï¼Œæ‰æœ‰å¯èƒ½å‘ç”Ÿè¿é”æ›´æ–°ã€‚å®é™…ä¸Šï¼Œè¿™ç§æƒ…å†µå¹¶ä¸å¤šè§ã€‚\nå³ä½¿æœ‰è¿ç»­å¤šä¸ªé•¿åº¦åˆšå¥½ä¸º 250 ~ 253 çš„èŠ‚ç‚¹ï¼Œè¿ç»­çš„ä¸ªæ•°ä¹Ÿä¸å¤šï¼Œä¸ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§å½±å“ã€‚\n\nå› æ­¤ï¼Œå‹ç¼©åˆ—è¡¨æ’å…¥æ“ä½œï¼Œå¹³å‡å¤æ‚åº¦è¿˜æ˜¯ O(n)\næ€»ç»“ï¼š\nå‹ç¼©åˆ—è¡¨æ˜¯ä¸€ç§ä¸ºèŠ‚çº¦å†…å­˜è€Œå¼€å‘çš„é¡ºåºå‹æ•°æ®ç»“æ„ï¼Œæ˜¯ ZSETã€HASH å’Œ LIST çš„åº•å±‚å®ç°ä¹‹ä¸€ã€‚\nå‹ç¼©åˆ—è¡¨æœ‰ 3 ç§å­—ç¬¦ä¸²ç±»å‹ç¼–ç ã€6 ç§æ•´æ•°ç±»å‹ç¼–ç \nå‹ç¼©åˆ—è¡¨çš„å¢åˆ ï¼Œå¯èƒ½ä¼šå¼•å‘è¿é”æ›´æ–°æ“ä½œï¼Œä½†è¿™ç§æ“ä½œå‡ºç°çš„å‡ ç‡å¹¶ä¸é«˜ã€‚\n\n","categories":["è¿ç»´","Redis"]},{"title":"Redis å®˜æ–¹å¯è§†åŒ–å·¥å…· RedisInsight","url":"/posts/10722/","content":"RedisInsight æ˜¯ä¸€ä¸ªç›´è§‚é«˜æ•ˆçš„ Redis GUI ç®¡ç†å·¥å…·ï¼Œå®ƒå¯ä»¥å¯¹ Redis çš„å†…å­˜ã€è¿æ¥æ•°ã€å‘½ä¸­ç‡ä»¥åŠæ­£å¸¸è¿è¡Œæ—¶é—´è¿›è¡Œç›‘æ§ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç•Œé¢ä¸Šä½¿ç”¨ CLI å’Œè¿æ¥çš„ Redis è¿›è¡Œäº¤äº’ï¼ˆRedisInsight å†…ç½®å¯¹ Redis æ¨¡å—æ”¯æŒï¼‰ï¼š\nå®˜æ–¹æ–‡æ¡£ï¼šhttps://docs.redis.com/latest/ri/\nRedisInsight æä¾›çš„åŠŸèƒ½ï¼š\n\nå”¯ä¸€æ”¯æŒ Redis Cluster çš„ GUI å·¥å…·ï¼›\nå¯ä»¥åŸºäº Browser çš„ç•Œé¢æ¥è¿›è¡Œæœç´¢é”®ã€æŸ¥çœ‹å’Œç¼–è¾‘æ•°æ®ï¼›\næ”¯æŒåŸºäº SSL/TLS çš„è¿æ¥ï¼ŒåŒæ—¶è¿˜å¯ä»¥åœ¨ç•Œé¢ä¸Šè¿›è¡Œå†…å­˜åˆ†æï¼›\n\n","categories":["è¿ç»´","Redis"]},{"title":"Redis å®ç”¨å‘½ä»¤åˆé›†","url":"/posts/49997/","content":"1ã€æŸ¥çœ‹å½“å‰å†…å­˜å ç”¨redis-cli info | grep used_memory:\n\nå¯ç”¨äºè®¡ç®—æŸç§æ•°æ®å ç”¨å†…å­˜å¤§å°ã€‚\n","categories":["è¿ç»´","Redis"]},{"title":"Redis å»¶è¿Ÿæ’æŸ¥","url":"/posts/2191/","content":"å®˜æ–¹å»¶è¿Ÿé—®é¢˜æ’æŸ¥æ–‡æ¡£ï¼šhttps://redis.io/topics/latency\nä¸€ã€Rediså»¶è¿Ÿ1.ç½‘ç»œå»¶è¿Ÿredis-cli æä¾›äº†é€šè¿‡pingæµ‹é‡å»¶æ—¶çš„å‘½ä»¤ï¼Œå»¶è¿ŸæŒ‡å®¢æˆ·ç«¯å‘å‡ºå‘½ä»¤åˆ°å®¢æˆ·ç«¯æ¥æ”¶åˆ°å¯¹å‘½ä»¤çš„å“åº”ä¹‹é—´çš„æ—¶é—´ã€‚\nâ€“latencyping rediså®ä¾‹ï¼Œå¹¶æµ‹è¯•å“åº”æ—¶é—´ã€‚\né»˜è®¤ç»Ÿè®¡æ¯ç§’çš„å»¶æ—¶æƒ…å†µï¼Œå¯é€šè¿‡ -i ä¿®æ”¹æ—¶é—´é—´éš”ã€‚\né»˜è®¤ä¼šä¸€ç›´æ˜¾ç¤ºæœ€æ–°ç»Ÿè®¡ç»“æœï¼Œå¯é€šè¿‡ --raw  æˆ– --csv åªæ˜¾ç¤ºä¸€æ¬¡çš„ç»Ÿè®¡ç»“æœã€‚\nç»Ÿè®¡ç»“æœæ—¶é—´å•ä½ä¸ºmsã€‚\nroot@b86b4d13b636:/data# redis-cli -p 7001 --latencymin: 0, max: 7, avg: 0.09 (927 samples)root@b86b4d13b636:/data# redis-cli -p 7001 --latency --raw -i 10   0 17 0.70 772root@b86b4d13b636:/data# redis-cli -p 7001 --latency --csv /data/aa -i 100,11,0.58,77\n\nâ€“latency-historyä¸ --latency ä¸€æ ·ï¼Œä½†ä¼šä¿ç•™å†å²ç»“æœï¼Œæ—¶é—´é—´éš”é»˜è®¤ä¸º15sï¼Œå¯é€šè¿‡ -i æ”¹å˜æ—¶é—´é—´éš”ã€‚\nroot@b86b4d13b636:/data# redis-cli -p 7001 --latency-historymin: 0, max: 1, avg: 0.12 (1303 samples) -- 15.01 seconds rangemin: 0, max: 1, avg: 0.11 (1297 samples) -- 15.01 seconds rangemin: 0, max: 14, avg: 0.15 (1275 samples) -- 15.01 seconds range\n\nâ€“latency-distå°†å»¶è¿Ÿç»“æœä»¥å½©è‰²æ˜¾ç¤ºï¼Œå¯ä»¥æŸ¥çœ‹å»¶è¿Ÿæ—¶é—´æ‰€å æ¯”ä¾‹ã€‚\nroot@b86b4d13b636:/data# redis-cli -p 7001 --latency-dist\n\n\n2.å›ºæœ‰å»¶è¿Ÿâ€“intrinsic-latency &lt;sec&gt;&lt;sec&gt; è¡¨ç¤ºæ£€æµ‹çš„æ—¶é—´é•¿åº¦ã€‚\næœ‰ä¸€ç§å»¶è¿Ÿæ˜¯è¿è¡Œ Redis çš„ç¯å¢ƒçš„å›ºæœ‰éƒ¨åˆ†ï¼Œå³ç”±æ‚¨çš„æ“ä½œç³»ç»Ÿå†…æ ¸æä¾›çš„å»¶è¿Ÿï¼Œå¦‚æœæ‚¨ä½¿ç”¨è™šæ‹ŸåŒ–ï¼Œåˆ™ç”±æ‚¨ä½¿ç”¨çš„ç®¡ç†ç¨‹åºæä¾›ã€‚è™½ç„¶è¿™ç§å»¶è¿Ÿæ— æ³•æ¶ˆé™¤ï¼Œä½†ç ”ç©¶å®ƒå¾ˆé‡è¦ï¼Œå› ä¸ºå®ƒæ˜¯åŸºçº¿ã€‚\næ¢å¥è¯è¯´ï¼Œç”±äºå†…æ ¸æˆ–ç®¡ç†ç¨‹åºçš„å®ç°æˆ–è®¾ç½®ï¼Œredisæ— æ³•å®ç°æ¯”è¯¥å»¶è¿Ÿæ›´ä½çš„å»¶è¿Ÿæ—¶é—´ã€‚\nå‚æ•°100æ˜¯æµ‹è¯•å°†æ‰§è¡Œçš„ç§’æ•°ã€‚æˆ‘ä»¬è¿è¡Œæµ‹è¯•çš„æ—¶é—´è¶Šé•¿ï¼Œæˆ‘ä»¬å°±è¶Šæœ‰å¯èƒ½å‘ç°å»¶è¿Ÿå³°å€¼ã€‚100 ç§’é€šå¸¸æ˜¯åˆé€‚çš„ã€‚\nè¯¥æµ‹è¯•æ˜¯ CPU å¯†é›†å‹çš„ï¼Œå¹¶ä¸”å¯èƒ½ä¼šä½¿ç³»ç»Ÿä¸­çš„å•ä¸ªå†…æ ¸é¥±å’Œã€‚\nå›ºæœ‰å»¶è¿Ÿå¯èƒ½ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œå˜åŒ–ï¼Œå…·ä½“å–å†³äºç³»ç»Ÿçš„è´Ÿè½½ã€‚\nroot@b86b4d13b636:/data# redis-cli -p 7001 --intrinsic-latency 100Max latency so far: 1 microseconds.Max latency so far: 95 microseconds.Max latency so far: 134 microseconds.Max latency so far: 180 microseconds.Max latency so far: 189 microseconds.Max latency so far: 249 microseconds.Max latency so far: 271 microseconds.Max latency so far: 433 microseconds.Max latency so far: 529 microseconds.2503422416 total runs (avg latency: 0.0399 microseconds / 39.95 nanoseconds per run).Worst run took 13243x longer than the average latency.\n\n3.ç›‘æ§å»¶æ—¶ï¼ˆlatencyï¼‰Latency æœ‰5ç§å‘½ä»¤æŸ¥çœ‹ç›‘æ§æŠ¥å‘Šï¼Œè€Œä¸åŒçš„è¢«ç›‘æ§ä»£ç è·¯å¾„è¢«ç§°ä¸ºäº‹ä»¶ã€‚\nä¾‹å¦‚ï¼Œcommandæ˜¯ä¸€ä¸ªæµ‹é‡å¯èƒ½ç¼“æ…¢å‘½ä»¤æ‰§è¡Œçš„å»¶è¿Ÿå³°å€¼fast-commandçš„äº‹ä»¶ï¼Œè€Œæ˜¯ç›‘è§†O(1)å’ŒO(log N)å‘½ä»¤çš„äº‹ä»¶åç§°ã€‚å…¶ä»–äº‹ä»¶ä¸å¤ªé€šç”¨ï¼Œå¹¶ç›‘è§†ç”± Redis æ‰§è¡Œçš„éå¸¸å…·ä½“çš„æ“ä½œã€‚ä¾‹å¦‚forkäº‹ä»¶åªç›‘æ§Redisæ‰§è¡Œfork(2)ç³»ç»Ÿè°ƒç”¨æ‰€ç”¨çš„æ—¶é—´ã€‚\nå…·ä½“å¯æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼šhttps://redis.io/topics/latency-monitor\nå¼€å¯å»¶æ—¶ç›‘æ§å®˜æ–¹å»ºè®®è™½ç„¶è¿™ä¸ªç›‘æ§æ¶ˆè€—çš„å†…å­˜è¾ƒå°‘ï¼Œä½†æ˜¯å¦‚æœredisé›†ç¾¤è¿è¡Œè‰¯å¥½ï¼Œæ²¡æœ‰å……åˆ†çš„ç†ç”±ä¸è¦å¼€å¯ç›‘æ§æé«˜redisé›†ç¾¤å¯¹å†…å­˜çš„å ç”¨ç‡ã€‚\nè¶…è¿‡100æ¯«ç§’çš„å“åº”å°†ä¼šè¢«ç›‘æ§ï¼Œé»˜è®¤ä¸º0ï¼Œè¡¨ç¤ºå…³é—­çŠ¶æ€ã€‚\nCONFIG SET latency-monitor-threshold 100\n\nLatency Latestè¿”å›æ‰€æœ‰äº‹ä»¶çš„æœ€æ–°å»¶è¿Ÿæ ·æœ¬\n127.0.0.1:6379&gt; latency latest1) 1) &quot;command&quot; #äº‹ä»¶åç§°   2) (integer) 1405067976 #å»¶è¿Ÿå‘ç”Ÿçš„æ—¶é—´æˆ³   3) (integer) 251 #å»¶è¿Ÿ æ¯«ç§’   4) (integer) 1001 #äº‹ä»¶çš„æœ€å¤§å»¶è¿Ÿ\n\nLatency Historyè¿”å›ç»™å®šäº‹ä»¶çš„å»¶è¿Ÿæ—¶é—´åºåˆ—ã€‚\n127.0.0.1:6379&gt; latency history command #æŸ¥çœ‹commendäº‹ä»¶çš„å†å²å»¶è¿Ÿ1) 1) (integer) 1405067822 #æ—¶é—´æˆ³   2) (integer) 251 #å»¶è¿Ÿ2) 1) (integer) 1405067941   2) (integer) 1001\n\nLatency Reseté‡ç½®ä¸€ä¸ªæˆ–å¤šä¸ªäº‹ä»¶çš„å»¶è¿Ÿæ—¶é—´åºåˆ—æ•°æ®ã€‚\nLatency Graphå‘ˆç°äº‹ä»¶å»¶è¿Ÿæ ·æœ¬çš„ ASCII è‰ºæœ¯å›¾ã€‚\nLatency Doctorå›å¤äººç±»å¯è¯»çš„å»¶è¿Ÿåˆ†ææŠ¥å‘Šã€‚\n4.å»¶è¿ŸåŸå› è§£å†³æ’æŸ¥å»¶è¿Ÿé—®é¢˜ï¼Œæœ‰æ—¶è¿˜éœ€è¦çŸ¥é“å»¶è¿Ÿäº§ç”Ÿçš„åŸå› ï¼Œå®˜ç½‘æ€»ç»“å¯èƒ½å¦‚ä¸‹ï¼š\n\nLatency induced by network and communication\nSingle threaded nature of Redis\nLatency generated by slow commands\nLatency generated by fork\nFork time in different systems\nLatency induced by transparent huge pages\nLatency induced by swapping (operating system paging)\nLatency due to AOF and disk I/O\nLatency generated by expires\n\näºŒã€æ…¢æŸ¥è¯¢slowlog-log-slower-thanæ…¢æŸ¥è¯¢æ—¶é—´é˜ˆå€¼ï¼Œè¶…è¿‡è¿™ä¸ªé˜ˆå€¼çš„æŸ¥è¯¢å°†ä¼šè¢«è®°å½•ï¼Œé»˜è®¤ 10000 å¾®ç§’ï¼Œå³10msã€‚\n127.0.0.1:7001&gt; config get slowlog-log-slower-than1) &quot;slowlog-log-slower-than&quot;2) &quot;10000&quot;\n\nè®¾ç½®é˜ˆå€¼\n127.0.0.1:7001&gt; config set slowlog-log-slower-than 2000OK\n\nslowlog-max-lenæ…¢æŸ¥è¯¢æ—¥å¿—æœ€å¤§æ¡æ•°ï¼Œé»˜è®¤128æ¡ã€‚\n127.0.0.1:7001&gt; config get slowlog-max-len1) &quot;slowlog-max-len&quot;2) &quot;128&quot;\n\nè®¾ç½®æœ€å¤§æ¡æ•°\n127.0.0.1:7001&gt; config set slowlog-max-len 64OK\n\né…ç½®æŒä¹…åŒ–åˆ°é…ç½®æ–‡ä»¶config rewrite\n\nè·å–å‰ n æ¡æ…¢æŸ¥è¯¢æ—¥å¿—å‘½ä»¤æ ¼å¼ï¼šslowlog get [n]\n127.0.0.1:7001&gt; slowlog get 10 1) 1) (integer) 1             # æ—¥å¿—å”¯ä¸€id    2) (integer) 1640439905    # å‘½ä»¤æ‰§è¡Œæ—¶çš„ UNIX æ—¶é—´æˆ³    3) (integer) 1             # å‘½ä»¤æ‰§è¡Œæ—¶æ‰ï¼Œå•ä½ å¾®ç§’    4) 1) &quot;REPLCONF&quot;           # å‘½ä»¤åŠå‚æ•°       2) &quot;ACK&quot;       3) &quot;484&quot;    5) &quot;127.0.0.1:38877&quot;    6) &quot;&quot; 7) 1) (integer) 0    2) (integer) 1640439899    3) (integer) 6    4) 1) &quot;get&quot;       2) &quot;k&quot;    5) &quot;127.0.0.1:46228&quot;    6) &quot;&quot;\n\næ…¢æŸ¥è¯¢æ—¥å¿—é‡ç½®127.0.0.1:7001&gt; slowlog resetOK\n\nå»ºè®®slowlog-max-len é…ç½®å»ºè®®ï¼š\n\nçº¿ä¸Šå»ºè®®è°ƒå¤§æ…¢æŸ¥è¯¢åˆ—è¡¨ï¼Œè®°å½•æ…¢æŸ¥è¯¢æ—¶Redisä¼šå¯¹é•¿å‘½ä»¤åšæˆªæ–­æ“ä½œï¼Œå¹¶ä¸ä¼šå ç”¨å¤§é‡å†…å­˜ã€‚å¢å¤§æ…¢æŸ¥è¯¢åˆ—è¡¨å¯ä»¥å‡ç¼“æ…¢æŸ¥è¯¢è¢«å‰”é™¤çš„å¯èƒ½ï¼Œä¾‹å¦‚çº¿ä¸Šå¯è®¾ç½®ä¸º1000ä»¥ä¸Šã€‚\n\nslowlog-log-slower-than é…ç½®å»ºè®®ï¼š\n\né»˜è®¤å€¼è¶…è¿‡10æ¯«ç§’åˆ¤å®šä¸ºæ…¢æŸ¥è¯¢ï¼Œéœ€è¦æ ¹æ®Rediså¹¶å‘é‡è°ƒæ•´è¯¥å€¼ã€‚ç”±äºRedisé‡‡ç”¨å•çº¿ç¨‹å“åº”å‘½ä»¤ï¼Œå¯¹äºé«˜æµé‡çš„åœºæ™¯ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡Œæ—¶é—´åœ¨1æ¯«ç§’ä»¥ä¸Šï¼Œé‚£ä¹ˆRedisæœ€å¤šå¯æ”¯æ’‘OPSä¸åˆ°1000ã€‚å› æ­¤å¯¹äºé«˜OPSåœºæ™¯çš„Rediså»ºè®®è®¾ç½®ä¸º1æ¯«ç§’ã€‚\næ…¢æŸ¥è¯¢åªè®°å½•å‘½ä»¤æ‰§è¡Œæ—¶é—´ï¼Œå¹¶ä¸åŒ…æ‹¬å‘½ä»¤æ’é˜Ÿå’Œç½‘ç»œä¼ è¾“æ—¶é—´ã€‚å› æ­¤å®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ—¶é—´ä¼šå¤§äºå‘½ä»¤å®é™…æ‰§è¡Œæ—¶é—´ã€‚å› ä¸ºå‘½ä»¤æ‰§è¡Œæ’é˜Ÿæœºåˆ¶ï¼Œæ…¢æŸ¥è¯¢ä¼šå¯¼è‡´å…¶ä»–å‘½ä»¤çº§è”é˜»å¡ï¼Œå› æ­¤å½“å®¢æˆ·ç«¯å‡ºç°è¯·æ±‚è¶…æ—¶ï¼Œéœ€è¦æ£€æŸ¥è¯¥æ—¶é—´ç‚¹æ˜¯å¦æœ‰å¯¹åº”çš„æ…¢æŸ¥è¯¢ï¼Œä»è€Œåˆ†æå‡ºæ˜¯å¦ä¸ºæ…¢æŸ¥è¯¢å¯¼è‡´çš„å‘½ä»¤çº§è”é˜»å¡ã€‚\nç”±äºæ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæ…¢æŸ¥è¯¢æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šä¸¢å¤±éƒ¨åˆ†æ…¢æŸ¥è¯¢å‘½ä»¤ï¼Œä¸ºäº†é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå¯ä»¥å®šæœŸæ‰§è¡Œslow getå‘½ä»¤å°†æ…¢æŸ¥è¯¢æ—¥å¿—æŒä¹…åŒ–åˆ°å…¶ä»–å­˜å‚¨ä¸­ï¼ˆä¾‹å¦‚MySQLï¼‰ï¼Œç„¶åå¯ä»¥åˆ¶ä½œå¯è§†åŒ–ç•Œé¢è¿›è¡ŒæŸ¥è¯¢ã€‚\n\nä¸‰ã€æ“ä½œBigKeyå¦‚æœä½ æŸ¥è¯¢æ…¢æ—¥å¿—å‘ç°ï¼Œå¹¶ä¸æ˜¯å¤æ‚åº¦è¿‡é«˜çš„å‘½ä»¤å¯¼è‡´çš„ï¼Œè€Œéƒ½æ˜¯ SET / DEL è¿™ç§ç®€å•å‘½ä»¤å‡ºç°åœ¨æ…¢æ—¥å¿—ä¸­ï¼Œé‚£ä¹ˆä½ å°±è¦æ€€ç–‘ä½ çš„å®ä¾‹å¦å†™å…¥äº† bigkeyã€‚\nRedis åœ¨å†™å…¥æ•°æ®æ—¶ï¼Œéœ€è¦ä¸ºæ–°çš„æ•°æ®åˆ†é…å†…å­˜ï¼Œç›¸å¯¹åº”çš„ï¼Œå½“ä» Redis ä¸­åˆ é™¤æ•°æ®æ—¶ï¼Œå®ƒä¼šé‡Šæ”¾å¯¹åº”çš„å†…å­˜ç©ºé—´ã€‚\nå¦‚æœä¸€ä¸ª key å†™å…¥çš„ value éå¸¸å¤§ï¼Œé‚£ä¹ˆ Redis åœ¨åˆ†é…å†…å­˜æ—¶å°±ä¼šæ¯”è¾ƒè€—æ—¶ã€‚åŒæ ·çš„ï¼Œå½“åˆ é™¤è¿™ä¸ª key æ—¶ï¼Œé‡Šæ”¾å†…å­˜ä¹Ÿä¼šæ¯”è¾ƒè€—æ—¶ï¼Œè¿™ç§ç±»å‹çš„ key æˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸º bigkeyã€‚\næŸ¥çœ‹bigkeyroot@redis-1:/data# redis-cli -h 127.0.0.1 --bigkeys -i 0.01                # Scanning the entire keyspace to find biggest keys as well as# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec# per 100 SCAN commands (not usually needed).[00.00%] Biggest string found so far &#x27;&quot;quota_de_202112271630_9427&quot;&#x27; with 1 bytes-------- summary -------Sampled 188 keys in the keyspace!Total key length in bytes is 4897 (avg len 26.05)Biggest string found &#x27;&quot;quota_de_202112271630_9427&quot;&#x27; has 1 bytes0 lists with 0 items (00.00% of keys, avg size 0.00)0 hashs with 0 fields (00.00% of keys, avg size 0.00)188 strings with 188 bytes (100.00% of keys, avg size 1.00)0 streams with 0 entries (00.00% of keys, avg size 0.00)0 sets with 0 members (00.00% of keys, avg size 0.00)0 zsets with 0 members (00.00% of keys, avg size 0.00)\n\nä»è¾“å‡ºç»“æœæˆ‘ä»¬å¯ä»¥å¾ˆæ¸…æ™°åœ°çœ‹åˆ°ï¼Œæ¯ç§æ•°æ®ç±»å‹æ‰€å ç”¨çš„æœ€å¤§å†…å­˜ / æ‹¥æœ‰æœ€å¤šå…ƒç´ çš„ key æ˜¯å“ªä¸€ä¸ªï¼Œä»¥åŠæ¯ç§æ•°æ®ç±»å‹åœ¨æ•´ä¸ªå®ä¾‹ä¸­çš„å æ¯”å’Œå¹³å‡å¤§å° / å…ƒç´ æ•°é‡ã€‚\nå…¶å®ï¼Œä½¿ç”¨è¿™ä¸ªå‘½ä»¤çš„åŸç†ï¼Œå°±æ˜¯ Redis åœ¨å†…éƒ¨æ‰§è¡Œäº† SCAN å‘½ä»¤ï¼Œéå†æ•´ä¸ªå®ä¾‹ä¸­æ‰€æœ‰çš„ keyï¼Œç„¶åé’ˆå¯¹ key çš„ç±»å‹ï¼Œåˆ†åˆ«æ‰§è¡Œ STRLENã€LLENã€HLENã€SCARDã€ZCARD å‘½ä»¤ï¼Œæ¥è·å– String ç±»å‹çš„é•¿åº¦ã€å®¹å™¨ç±»å‹ï¼ˆListã€Hashã€Setã€ZSetï¼‰çš„å…ƒç´ ä¸ªæ•°ã€‚\nè¦æ³¨æ„ 2 ä¸ªé—®é¢˜ï¼š\n\nå¯¹çº¿ä¸Šå®ä¾‹è¿›è¡Œ bigkey æ‰«ææ—¶ï¼ŒRedis çš„ OPS ä¼šçªå¢ï¼Œä¸ºäº†é™ä½æ‰«æè¿‡ç¨‹ä¸­å¯¹ Redis çš„å½±å“ï¼Œæœ€å¥½æ§åˆ¶ä¸€ä¸‹æ‰«æçš„é¢‘ç‡ï¼ŒæŒ‡å®š -i å‚æ•°å³å¯ï¼Œå®ƒè¡¨ç¤ºæ‰«æè¿‡ç¨‹ä¸­æ¯æ¬¡æ‰«æåä¼‘æ¯çš„æ—¶é—´é—´éš”ï¼Œå•ä½æ˜¯ç§’\næ‰«æç»“æœä¸­ï¼Œå¯¹äºå®¹å™¨ç±»å‹ï¼ˆListã€Hashã€Setã€ZSetï¼‰çš„ keyï¼Œåªèƒ½æ‰«æå‡ºå…ƒç´ æœ€å¤šçš„ keyã€‚ä½†ä¸€ä¸ª key çš„å…ƒç´ å¤šï¼Œä¸ä¸€å®šè¡¨ç¤ºå ç”¨å†…å­˜ä¹Ÿå¤šï¼Œä½ è¿˜éœ€è¦æ ¹æ®ä¸šåŠ¡æƒ…å†µï¼Œè¿›ä¸€æ­¥è¯„ä¼°å†…å­˜å ç”¨æƒ…å†µ\n\nbigkey ä¼˜åŒ–æ–¹å‘\nä¸šåŠ¡åº”ç”¨å°½é‡é¿å…å†™å…¥ bigkey\nå¦‚æœä½ ä½¿ç”¨çš„ Redis æ˜¯ 4.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œç”¨ UNLINK å‘½ä»¤æ›¿ä»£ DELï¼Œæ­¤å‘½ä»¤å¯ä»¥æŠŠé‡Šæ”¾ key å†…å­˜çš„æ“ä½œï¼Œæ”¾åˆ°åå°çº¿ç¨‹ä¸­å»æ‰§è¡Œï¼Œä»è€Œé™ä½å¯¹ Redis çš„å½±å“\nå¦‚æœä½ ä½¿ç”¨çš„ Redis æ˜¯ 6.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥å¼€å¯ lazy-free æœºåˆ¶ï¼ˆlazyfree-lazy-user-del = yesï¼‰ï¼Œåœ¨æ‰§è¡Œ DEL å‘½ä»¤æ—¶ï¼Œé‡Šæ”¾å†…å­˜ä¹Ÿä¼šæ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œ\n\nä½†å³ä¾¿å¯ä»¥ä½¿ç”¨æ–¹æ¡ˆ 2ï¼Œä¹Ÿä¸å»ºè®®åœ¨å®ä¾‹ä¸­å­˜å…¥ bigkeyã€‚\nè¿™æ˜¯å› ä¸º bigkey åœ¨å¾ˆå¤šåœºæ™¯ä¸‹ï¼Œä¾æ—§ä¼šäº§ç”Ÿæ€§èƒ½é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œbigkey åœ¨åˆ†ç‰‡é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¯¹äºæ•°æ®çš„è¿ç§»ä¹Ÿä¼šæœ‰æ€§èƒ½å½±å“ï¼Œä»¥åŠæ•°æ®è¿‡æœŸã€æ•°æ®æ·˜æ±°ã€é€æ˜å¤§é¡µï¼Œéƒ½ä¼šå—åˆ° bigkey çš„å½±å“ã€‚\nå››ã€é›†ä¸­è¿‡æœŸå¦‚æœå¹³æ—¶åœ¨æ“ä½œ Redis æ—¶ï¼Œå¹¶æ²¡æœ‰å»¶è¿Ÿå¾ˆå¤§çš„æƒ…å†µå‘ç”Ÿï¼Œä½†åœ¨æŸä¸ªæ—¶é—´ç‚¹çªç„¶å‡ºç°ä¸€æ³¢å»¶æ—¶ï¼Œå…¶ç°è±¡è¡¨ç°ä¸ºï¼šå˜æ…¢çš„æ—¶é—´ç‚¹å¾ˆæœ‰è§„å¾‹ï¼Œä¾‹å¦‚æŸä¸ªæ•´ç‚¹ï¼Œæˆ–è€…æ¯é—´éš”å¤šä¹…å°±ä¼šå‘ç”Ÿä¸€æ³¢å»¶è¿Ÿã€‚å¦‚æœæ˜¯å‡ºç°è¿™ç§æƒ…å†µï¼Œé‚£ä¹ˆéœ€è¦æ’æŸ¥ä¸€ä¸‹ï¼Œä¸šåŠ¡ä»£ç ä¸­æ˜¯å¦å­˜åœ¨è®¾ç½®å¤§é‡ key é›†ä¸­è¿‡æœŸçš„æƒ…å†µã€‚\nå¦‚æœæœ‰å¤§é‡çš„ key åœ¨æŸä¸ªå›ºå®šæ—¶é—´ç‚¹é›†ä¸­è¿‡æœŸï¼Œåœ¨è¿™ä¸ªæ—¶é—´ç‚¹è®¿é—® Redis æ—¶ï¼Œå°±æœ‰å¯èƒ½å¯¼è‡´å»¶æ—¶å˜å¤§ã€‚\nä¸ºä»€ä¹ˆé›†ä¸­è¿‡æœŸä¼šå¯¼è‡´ Redis å»¶è¿Ÿå˜å¤§ï¼Ÿè¿™å°±éœ€è¦æˆ‘ä»¬äº†è§£ Redis çš„è¿‡æœŸç­–ç•¥æ˜¯æ€æ ·çš„ã€‚\nRedis çš„è¿‡æœŸæ•°æ®é‡‡ç”¨è¢«åŠ¨è¿‡æœŸ + ä¸»åŠ¨è¿‡æœŸä¸¤ç§ç­–ç•¥ï¼š\n\nè¢«åŠ¨è¿‡æœŸï¼šåªæœ‰å½“è®¿é—®æŸä¸ª key æ—¶ï¼Œæ‰åˆ¤æ–­è¿™ä¸ª key æ˜¯å¦å·²è¿‡æœŸï¼Œå¦‚æœå·²è¿‡æœŸï¼Œåˆ™ä»å®ä¾‹ä¸­åˆ é™¤\nä¸»åŠ¨è¿‡æœŸï¼šRedis å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æ¯éš” 100 æ¯«ç§’ï¼ˆ1ç§’10æ¬¡ï¼‰å°±ä¼šä»å…¨å±€çš„è¿‡æœŸå“ˆå¸Œè¡¨ä¸­éšæœºå–å‡º 20 ä¸ª keyï¼Œç„¶ååˆ é™¤å…¶ä¸­è¿‡æœŸçš„ keyï¼Œå¦‚æœè¿‡æœŸ key çš„æ¯”ä¾‹è¶…è¿‡äº† 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¤è¿‡ç¨‹ï¼Œç›´åˆ°è¿‡æœŸ key çš„æ¯”ä¾‹ä¸‹é™åˆ° 25% ä»¥ä¸‹ï¼Œæˆ–è€…è¿™æ¬¡ä»»åŠ¡çš„æ‰§è¡Œè€—æ—¶è¶…è¿‡äº† 25 æ¯«ç§’ï¼Œæ‰ä¼šé€€å‡ºå¾ªç¯\n\næ³¨æ„ï¼Œè¿™ä¸ªä¸»åŠ¨è¿‡æœŸ key çš„å®šæ—¶ä»»åŠ¡ï¼Œæ˜¯åœ¨ Redis ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ã€‚\nä¹Ÿå°±æ˜¯è¯´å¦‚æœåœ¨æ‰§è¡Œä¸»åŠ¨è¿‡æœŸçš„è¿‡ç¨‹ä¸­ï¼Œå‡ºç°äº†éœ€è¦å¤§é‡åˆ é™¤è¿‡æœŸ key çš„æƒ…å†µï¼Œé‚£ä¹ˆæ­¤æ—¶åº”ç”¨ç¨‹åºåœ¨è®¿é—® Redis æ—¶ï¼Œå¿…é¡»è¦ç­‰å¾…è¿™ä¸ªè¿‡æœŸä»»åŠ¡æ‰§è¡Œç»“æŸï¼ŒRedis æ‰å¯ä»¥æœåŠ¡è¿™ä¸ªå®¢æˆ·ç«¯è¯·æ±‚ã€‚\næ­¤æ—¶å°±ä¼šå‡ºç°ï¼Œåº”ç”¨è®¿é—® Redis å»¶æ—¶å˜å¤§ã€‚\nå¦‚æœæ­¤æ—¶éœ€è¦è¿‡æœŸåˆ é™¤çš„æ˜¯ä¸€ä¸ª bigkeyï¼Œé‚£ä¹ˆè¿™ä¸ªè€—æ—¶ä¼šæ›´ä¹…ã€‚è€Œä¸”ï¼Œè¿™ä¸ªæ“ä½œå»¶è¿Ÿçš„å‘½ä»¤å¹¶ä¸ä¼šè®°å½•åœ¨æ…¢æ—¥å¿—ä¸­ã€‚\nå› ä¸ºæ…¢æ—¥å¿—ä¸­åªè®°å½•ä¸€ä¸ªå‘½ä»¤çœŸæ­£æ“ä½œå†…å­˜æ•°æ®çš„è€—æ—¶ï¼Œè€Œ Redis ä¸»åŠ¨åˆ é™¤è¿‡æœŸ key çš„é€»è¾‘ï¼Œæ˜¯åœ¨å‘½ä»¤çœŸæ­£æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„ã€‚\næ‰€ä»¥ï¼Œæ­¤æ—¶ä½ ä¼šçœ‹åˆ°ï¼Œæ…¢æ—¥å¿—ä¸­æ²¡æœ‰æ“ä½œè€—æ—¶çš„å‘½ä»¤ï¼Œä½†æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå´æ„ŸçŸ¥åˆ°äº†å»¶è¿Ÿå˜å¤§ï¼Œå…¶å®æ—¶é—´éƒ½èŠ±è´¹åœ¨äº†åˆ é™¤è¿‡æœŸ key ä¸Šï¼Œè¿™ç§æƒ…å†µæˆ‘ä»¬éœ€è¦å°¤ä¸ºæ³¨æ„ã€‚\n\nåˆ†æå’Œæ’æŸ¥éœ€è¦æ£€æŸ¥ä½ çš„ä¸šåŠ¡ä»£ç ï¼Œæ˜¯å¦å­˜åœ¨é›†ä¸­è¿‡æœŸ key çš„é€»è¾‘ã€‚\nä¸€èˆ¬é›†ä¸­è¿‡æœŸä½¿ç”¨çš„æ˜¯ expireat / pexpireat å‘½ä»¤ï¼Œä½ éœ€è¦åœ¨ä»£ç ä¸­æœç´¢è¿™ä¸ªå…³é”®å­—ã€‚\næ’æŸ¥ä»£ç åï¼Œå¦‚æœç¡®å®å­˜åœ¨é›†ä¸­è¿‡æœŸ key çš„é€»è¾‘å­˜åœ¨ï¼Œä½†è¿™ç§é€»è¾‘åˆæ˜¯ä¸šåŠ¡æ‰€å¿…é¡»çš„ï¼Œé‚£æ­¤æ—¶å¦‚ä½•ä¼˜åŒ–ï¼ŒåŒæ—¶åˆä¸å¯¹ Redis æœ‰æ€§èƒ½å½±å“å‘¢ï¼Ÿ\nä¸€èˆ¬æœ‰ä¸¤ç§æ–¹æ¡ˆæ¥è§„é¿è¿™ä¸ªé—®é¢˜ï¼š\n\né›†ä¸­è¿‡æœŸ key å¢åŠ ä¸€ä¸ªéšæœºè¿‡æœŸæ—¶é—´ï¼ŒæŠŠé›†ä¸­è¿‡æœŸçš„æ—¶é—´æ‰“æ•£ï¼Œé™ä½ Redis æ¸…ç†è¿‡æœŸ key çš„å‹åŠ›\nå¦‚æœä½ ä½¿ç”¨çš„ Redis æ˜¯ 4.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¯ä»¥å¼€å¯ lazy-free æœºåˆ¶ï¼Œå½“åˆ é™¤è¿‡æœŸ key æ—¶ï¼ŒæŠŠé‡Šæ”¾å†…å­˜çš„æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œé¿å…é˜»å¡ä¸»çº¿ç¨‹\n\nç¬¬ä¸€ç§æ–¹æ¡ˆï¼Œåœ¨è®¾ç½® key çš„è¿‡æœŸæ—¶é—´æ—¶ï¼Œå¢åŠ ä¸€ä¸ªéšæœºæ—¶é—´ï¼Œä¼ªä»£ç å¯ä»¥è¿™ä¹ˆå†™ï¼š\n# åœ¨è¿‡æœŸæ—¶é—´ç‚¹ä¹‹åçš„ 5 åˆ†é’Ÿå†…éšæœºè¿‡æœŸæ‰redis.expireat(key, expire_time + random(300))    \n\nè¿™æ ·ä¸€æ¥ï¼ŒRedis åœ¨å¤„ç†è¿‡æœŸæ—¶ï¼Œä¸ä¼šå› ä¸ºé›†ä¸­åˆ é™¤è¿‡å¤šçš„ key å¯¼è‡´å‹åŠ›è¿‡å¤§ï¼Œä»è€Œé¿å…é˜»å¡ä¸»çº¿ç¨‹ã€‚\nç¬¬äºŒç§æ–¹æ¡ˆï¼ŒRedis 4.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¼€å¯ lazy-free æœºåˆ¶ï¼š\n# é‡Šæ”¾è¿‡æœŸ key çš„å†…å­˜ï¼Œæ”¾åˆ°åå°çº¿ç¨‹æ‰§è¡Œlazyfree-lazy-expire yes\n\nå¦å¤–ï¼Œé™¤äº†ä¸šåŠ¡å±‚é¢çš„ä¼˜åŒ–å’Œä¿®æ”¹é…ç½®ä¹‹å¤–ï¼Œä½ è¿˜å¯ä»¥é€šè¿‡è¿ç»´æ‰‹æ®µåŠæ—¶å‘ç°è¿™ç§æƒ…å†µã€‚\nè¿ç»´å±‚é¢ï¼Œä½ éœ€è¦æŠŠ Redis çš„å„é¡¹è¿è¡ŒçŠ¶æ€æ•°æ®ç›‘æ§èµ·æ¥ï¼Œåœ¨ Redis ä¸Šæ‰§è¡Œ INFO å‘½ä»¤å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªå®ä¾‹æ‰€æœ‰çš„è¿è¡ŒçŠ¶æ€æ•°æ®ã€‚\nåœ¨è¿™é‡Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ expired_keys è¿™ä¸€é¡¹ï¼Œå®ƒä»£è¡¨æ•´ä¸ªå®ä¾‹åˆ°ç›®å‰ä¸ºæ­¢ï¼Œç´¯è®¡åˆ é™¤è¿‡æœŸ key çš„æ•°é‡ã€‚\nä½ éœ€è¦æŠŠè¿™ä¸ªæŒ‡æ ‡ç›‘æ§èµ·æ¥ï¼Œå½“è¿™ä¸ªæŒ‡æ ‡åœ¨å¾ˆçŸ­æ—¶é—´å†…å‡ºç°äº†çªå¢ï¼Œéœ€è¦åŠæ—¶æŠ¥è­¦å‡ºæ¥ï¼Œç„¶åä¸ä¸šåŠ¡åº”ç”¨æŠ¥æ…¢çš„æ—¶é—´ç‚¹è¿›è¡Œå¯¹æ¯”åˆ†æï¼Œç¡®è®¤æ—¶é—´æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´ï¼Œåˆ™å¯ä»¥ç¡®è®¤ç¡®å®æ˜¯å› ä¸ºé›†ä¸­è¿‡æœŸ key å¯¼è‡´çš„å»¶è¿Ÿå˜å¤§ã€‚\näº”ã€å®ä¾‹å†…å­˜è¾¾åˆ°ä¸Šé™å¦‚æœä½ çš„ Redis å®ä¾‹è®¾ç½®äº†å†…å­˜ä¸Šé™ maxmemoryï¼Œé‚£ä¹ˆä¹Ÿæœ‰å¯èƒ½å¯¼è‡´ Redis å˜æ…¢ã€‚\nå½“æˆ‘ä»¬æŠŠ Redis å½“åšçº¯ç¼“å­˜ä½¿ç”¨æ—¶ï¼Œé€šå¸¸ä¼šç»™è¿™ä¸ªå®ä¾‹è®¾ç½®ä¸€ä¸ªå†…å­˜ä¸Šé™ maxmemoryï¼Œç„¶åè®¾ç½®ä¸€ä¸ªæ•°æ®æ·˜æ±°ç­–ç•¥ã€‚\nè€Œå½“å®ä¾‹çš„å†…å­˜è¾¾åˆ°äº† maxmemory åï¼Œä½ å¯èƒ½ä¼šå‘ç°ï¼Œåœ¨æ­¤ä¹‹åæ¯æ¬¡å†™å…¥æ–°æ•°æ®ï¼Œæ“ä½œå»¶è¿Ÿå˜å¤§äº†ã€‚\nè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ\nåŸå› åœ¨äºï¼Œå½“ Redis å†…å­˜è¾¾åˆ° maxmemory åï¼Œæ¯æ¬¡å†™å…¥æ–°çš„æ•°æ®ä¹‹å‰ï¼ŒRedis å¿…é¡»å…ˆä»å®ä¾‹ä¸­è¸¢å‡ºä¸€éƒ¨åˆ†æ•°æ®ï¼Œè®©æ•´ä¸ªå®ä¾‹çš„å†…å­˜ç»´æŒåœ¨ maxmemory ä¹‹ä¸‹ï¼Œç„¶åæ‰èƒ½æŠŠæ–°æ•°æ®å†™è¿›æ¥ã€‚\nè¿™ä¸ªè¸¢å‡ºæ—§æ•°æ®çš„é€»è¾‘ä¹Ÿæ˜¯éœ€è¦æ¶ˆè€—æ—¶é—´çš„ï¼Œè€Œå…·ä½“è€—æ—¶çš„é•¿çŸ­ï¼Œè¦å–å†³äºä½ é…ç½®çš„æ·˜æ±°ç­–ç•¥ï¼š\n\nallkeys-lruï¼šä¸ç®¡ key æ˜¯å¦è®¾ç½®äº†è¿‡æœŸï¼Œæ·˜æ±°æœ€è¿‘æœ€å°‘è®¿é—®çš„ key\nvolatile-lruï¼šåªæ·˜æ±°æœ€è¿‘æœ€å°‘è®¿é—®ã€å¹¶è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key\nallkeys-randomï¼šä¸ç®¡ key æ˜¯å¦è®¾ç½®äº†è¿‡æœŸï¼Œéšæœºæ·˜æ±° key\nvolatile-randomï¼šåªéšæœºæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ key\nallkeys-ttlï¼šä¸ç®¡ key æ˜¯å¦è®¾ç½®äº†è¿‡æœŸï¼Œæ·˜æ±°å³å°†è¿‡æœŸçš„ key\nnoevictionï¼šä¸æ·˜æ±°ä»»ä½• keyï¼Œå®ä¾‹å†…å­˜è¾¾åˆ° maxmeory åï¼Œå†å†™å…¥æ–°æ•°æ®ç›´æ¥è¿”å›é”™è¯¯\nallkeys-lfuï¼šä¸ç®¡ key æ˜¯å¦è®¾ç½®äº†è¿‡æœŸï¼Œæ·˜æ±°è®¿é—®é¢‘ç‡æœ€ä½çš„ keyï¼ˆ4.0+ç‰ˆæœ¬æ”¯æŒï¼‰\nvolatile-lfuï¼šåªæ·˜æ±°è®¿é—®é¢‘ç‡æœ€ä½ã€å¹¶è®¾ç½®äº†è¿‡æœŸæ—¶é—´ keyï¼ˆ4.0+ç‰ˆæœ¬æ”¯æŒï¼‰\n\nå…·ä½“ä½¿ç”¨å“ªç§ç­–ç•¥ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å…·ä½“çš„ä¸šåŠ¡åœºæ™¯æ¥é…ç½®ã€‚\nä¸€èˆ¬æœ€å¸¸ä½¿ç”¨çš„æ˜¯ allkeys-lru / volatile-lru æ·˜æ±°ç­–ç•¥ï¼Œå®ƒä»¬çš„å¤„ç†é€»è¾‘æ˜¯ï¼Œæ¯æ¬¡ä»å®ä¾‹ä¸­éšæœºå–å‡ºä¸€æ‰¹ keyï¼ˆè¿™ä¸ªæ•°é‡å¯é…ç½®ï¼‰ï¼Œç„¶åæ·˜æ±°ä¸€ä¸ªæœ€å°‘è®¿é—®çš„ keyï¼Œä¹‹åæŠŠå‰©ä¸‹çš„ key æš‚å­˜åˆ°ä¸€ä¸ªæ± å­ä¸­ï¼Œç»§ç»­éšæœºå–ä¸€æ‰¹ keyï¼Œå¹¶ä¸ä¹‹å‰æ± å­ä¸­çš„ key æ¯”è¾ƒï¼Œå†æ·˜æ±°ä¸€ä¸ªæœ€å°‘è®¿é—®çš„ keyã€‚ä»¥æ­¤å¾€å¤ï¼Œç›´åˆ°å®ä¾‹å†…å­˜é™åˆ° maxmemory ä¹‹ä¸‹ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒRedis çš„æ·˜æ±°æ•°æ®çš„é€»è¾‘ä¸åˆ é™¤è¿‡æœŸ key çš„ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨å‘½ä»¤çœŸæ­£æ‰§è¡Œä¹‹å‰æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒä¹Ÿä¼šå¢åŠ æˆ‘ä»¬æ“ä½œ Redis çš„å»¶è¿Ÿï¼Œè€Œä¸”ï¼Œå†™ OPS è¶Šé«˜ï¼Œå»¶è¿Ÿä¹Ÿä¼šè¶Šæ˜æ˜¾ã€‚\n\nå¦å¤–ï¼Œå¦‚æœæ­¤æ—¶ä½ çš„ Redis å®ä¾‹ä¸­è¿˜å­˜å‚¨äº† bigkeyï¼Œé‚£ä¹ˆåœ¨æ·˜æ±°åˆ é™¤ bigkey é‡Šæ”¾å†…å­˜æ—¶ï¼Œä¹Ÿä¼šè€—æ—¶æ¯”è¾ƒä¹…ã€‚\nçœ‹åˆ°äº†ä¹ˆï¼Ÿbigkey çš„å±å®³åˆ°å¤„éƒ½æ˜¯ï¼Œè¿™ä¹Ÿæ˜¯å‰é¢æˆ‘æé†’ä½ å°½é‡ä¸å­˜å‚¨ bigkey çš„åŸå› ã€‚\nä¼˜åŒ–å»ºè®®\né¿å…å­˜å‚¨ bigkeyï¼Œé™ä½é‡Šæ”¾å†…å­˜çš„è€—æ—¶\næ·˜æ±°ç­–ç•¥æ”¹ä¸ºéšæœºæ·˜æ±°ï¼Œéšæœºæ·˜æ±°æ¯” LRU è¦å¿«å¾ˆå¤šï¼ˆè§†ä¸šåŠ¡æƒ…å†µè°ƒæ•´ï¼‰\næ‹†åˆ†å®ä¾‹ï¼ŒæŠŠæ·˜æ±° key çš„å‹åŠ›åˆ†æ‘Šåˆ°å¤šä¸ªå®ä¾‹ä¸Š\nå¦‚æœä½¿ç”¨çš„æ˜¯ Redis 4.0 ä»¥ä¸Šç‰ˆæœ¬ï¼Œå¼€å¯ layz-free æœºåˆ¶ï¼ŒæŠŠæ·˜æ±° key é‡Šæ”¾å†…å­˜çš„æ“ä½œæ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œï¼ˆé…ç½® lazyfree-lazy-eviction = yesï¼‰\n\nå…­ã€forkè€—æ—¶ä¸¥é‡ä¸ºäº†ä¿è¯ Redis æ•°æ®çš„å®‰å…¨æ€§ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¼€å¯åå°å®šæ—¶ RDB å’Œ AOF rewrite åŠŸèƒ½ã€‚ä½†å¦‚æœä½ å‘ç°ï¼Œæ“ä½œ Redis å»¶è¿Ÿå˜å¤§ï¼Œéƒ½å‘ç”Ÿåœ¨ Redis åå° RDB å’Œ AOF rewrite æœŸé—´ï¼Œé‚£å°±éœ€è¦æ’æŸ¥ï¼Œåœ¨è¿™æœŸé—´æœ‰å¯èƒ½å¯¼è‡´å˜æ…¢çš„æƒ…å†µã€‚\nå½“ Redis å¼€å¯äº†åå° RDB å’Œ AOF rewrite åï¼Œåœ¨æ‰§è¡Œæ—¶ï¼Œå®ƒä»¬éƒ½éœ€è¦ä¸»è¿›ç¨‹åˆ›å»ºå‡ºä¸€ä¸ªå­è¿›ç¨‹è¿›è¡Œæ•°æ®çš„æŒä¹…åŒ–ã€‚\nä¸»è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œä¼šè°ƒç”¨æ“ä½œç³»ç»Ÿæä¾›çš„ fork å‡½æ•°ã€‚\nè€Œ fork åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸»è¿›ç¨‹éœ€è¦æ‹·è´è‡ªå·±çš„å†…å­˜é¡µè¡¨ç»™å­è¿›ç¨‹ï¼Œå¦‚æœè¿™ä¸ªå®ä¾‹å¾ˆå¤§ï¼Œé‚£ä¹ˆè¿™ä¸ªæ‹·è´çš„è¿‡ç¨‹ä¹Ÿä¼šæ¯”è¾ƒè€—æ—¶ã€‚\nè€Œä¸”è¿™ä¸ª fork è¿‡ç¨‹ä¼šæ¶ˆè€—å¤§é‡çš„ CPU èµ„æºï¼Œåœ¨å®Œæˆ fork ä¹‹å‰ï¼Œæ•´ä¸ª Redis å®ä¾‹ä¼šè¢«é˜»å¡ä½ï¼Œæ— æ³•å¤„ç†ä»»ä½•å®¢æˆ·ç«¯è¯·æ±‚ã€‚\nå¦‚æœæ­¤æ—¶ä½ çš„ CPU èµ„æºæœ¬æ¥å°±å¾ˆç´§å¼ ï¼Œé‚£ä¹ˆ fork çš„è€—æ—¶ä¼šæ›´é•¿ï¼Œç”šè‡³è¾¾åˆ°ç§’çº§ï¼Œè¿™ä¼šä¸¥é‡å½±å“ Redis çš„æ€§èƒ½ã€‚\né‚£å¦‚ä½•ç¡®è®¤ç¡®å®æ˜¯å› ä¸º fork è€—æ—¶å¯¼è‡´çš„ Redis å»¶è¿Ÿå˜å¤§å‘¢ï¼Ÿ\nä½ å¯ä»¥åœ¨ Redis ä¸Šæ‰§è¡Œ INFO å‘½ä»¤ï¼ŒæŸ¥çœ‹ latest_fork_usec é¡¹ï¼Œå•ä½å¾®ç§’ã€‚\n# ä¸Šä¸€æ¬¡ fork è€—æ—¶ï¼Œå•ä½å¾®ç§’latest_fork_usec:59477\n\nè¿™ä¸ªæ—¶é—´å°±æ˜¯ä¸»è¿›ç¨‹åœ¨ fork å­è¿›ç¨‹æœŸé—´ï¼Œæ•´ä¸ªå®ä¾‹é˜»å¡æ— æ³•å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶é—´ã€‚\nå¦‚æœè¿™ä¸ªè€—æ—¶å¾ˆä¹…ï¼Œå°±è¦è­¦æƒ•èµ·æ¥äº†ï¼Œè¿™æ„å‘³åœ¨è¿™æœŸé—´ï¼Œä½ çš„æ•´ä¸ª Redis å®ä¾‹éƒ½å¤„äºä¸å¯ç”¨çš„çŠ¶æ€ã€‚\né™¤äº†æ•°æ®æŒä¹…åŒ–ä¼šç”Ÿæˆ RDB ä¹‹å¤–ï¼Œå½“ä¸»ä»èŠ‚ç‚¹ç¬¬ä¸€æ¬¡å»ºç«‹æ•°æ®åŒæ­¥æ—¶ï¼Œä¸»èŠ‚ç‚¹ä¹Ÿåˆ›å»ºå­è¿›ç¨‹ç”Ÿæˆ RDBï¼Œç„¶åå‘ç»™ä»èŠ‚ç‚¹è¿›è¡Œä¸€æ¬¡å…¨é‡åŒæ­¥ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¹Ÿä¼šå¯¹ Redis äº§ç”Ÿæ€§èƒ½å½±å“ã€‚\n\nä¼˜åŒ–æ–¹æ¡ˆ\næ§åˆ¶ Redis å®ä¾‹çš„å†…å­˜ï¼šå°½é‡åœ¨ 10G ä»¥ä¸‹ï¼Œæ‰§è¡Œ fork çš„è€—æ—¶ä¸å®ä¾‹å¤§å°æœ‰å…³ï¼Œå®ä¾‹è¶Šå¤§ï¼Œè€—æ—¶è¶Šä¹…\nåˆç†é…ç½®æ•°æ®æŒä¹…åŒ–ç­–ç•¥ï¼šåœ¨ slave èŠ‚ç‚¹æ‰§è¡Œ RDB å¤‡ä»½ï¼Œæ¨èåœ¨ä½å³°æœŸæ‰§è¡Œï¼Œè€Œå¯¹äºä¸¢å¤±æ•°æ®ä¸æ•æ„Ÿçš„ä¸šåŠ¡ï¼ˆä¾‹å¦‚æŠŠ Redis å½“åšçº¯ç¼“å­˜ä½¿ç”¨ï¼‰ï¼Œå¯ä»¥å…³é—­ AOF å’Œ AOF rewrite\nRedis å®ä¾‹ä¸è¦éƒ¨ç½²åœ¨è™šæ‹Ÿæœºä¸Šï¼šfork çš„è€—æ—¶ä¹Ÿä¸ç³»ç»Ÿä¹Ÿæœ‰å…³ï¼Œè™šæ‹Ÿæœºæ¯”ç‰©ç†æœºè€—æ—¶æ›´ä¹…\né™ä½ä¸»ä»åº“å…¨é‡åŒæ­¥çš„æ¦‚ç‡ï¼šé€‚å½“è°ƒå¤§ repl-backlog-size å‚æ•°ï¼Œé¿å…ä¸»ä»å…¨é‡åŒæ­¥\n\nä¸ƒã€å¼€å¯å†…å­˜å¤§é¡µé™¤äº†ä¸Šé¢è®²åˆ°çš„å­è¿›ç¨‹ RDB å’Œ AOF rewrite æœŸé—´ï¼Œfork è€—æ—¶å¯¼è‡´çš„å»¶æ—¶å˜å¤§ä¹‹å¤–ï¼Œè¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ–¹é¢ä¹Ÿä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ï¼Œè¿™å°±æ˜¯æ“ä½œç³»ç»Ÿæ˜¯å¦å¼€å¯äº†å†…å­˜å¤§é¡µæœºåˆ¶ã€‚\nä»€ä¹ˆæ˜¯å†…å­˜å¤§é¡µï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåº”ç”¨ç¨‹åºå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜æ—¶ï¼Œæ˜¯æŒ‰å†…å­˜é¡µè¿›è¡Œç”³è¯·çš„ï¼Œè€Œå¸¸è§„çš„å†…å­˜é¡µå¤§å°æ˜¯ 4KBã€‚\nLinux å†…æ ¸ä» 2.6.38 å¼€å§‹ï¼Œæ”¯æŒäº†å†…å­˜å¤§é¡µæœºåˆ¶ï¼Œè¯¥æœºåˆ¶å…è®¸åº”ç”¨ç¨‹åºä»¥ 2MB å¤§å°ä¸ºå•ä½ï¼Œå‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ã€‚\nåº”ç”¨ç¨‹åºæ¯æ¬¡å‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜å•ä½å˜å¤§äº†ï¼Œä½†è¿™ä¹Ÿæ„å‘³ç€ç”³è¯·å†…å­˜çš„è€—æ—¶å˜é•¿ã€‚\nè¿™å¯¹ Redis ä¼šæœ‰ä»€ä¹ˆå½±å“å‘¢ï¼Ÿå½“ Redis åœ¨æ‰§è¡Œåå° RDB å’Œ AOF rewrite æ—¶ï¼Œé‡‡ç”¨ fork å­è¿›ç¨‹çš„æ–¹å¼æ¥å¤„ç†ã€‚ä½†ä¸»è¿›ç¨‹ fork å­è¿›ç¨‹åï¼Œæ­¤æ—¶çš„ä¸»è¿›ç¨‹ä¾æ—§æ˜¯å¯ä»¥æ¥æ”¶å†™è¯·æ±‚çš„ï¼Œè€Œè¿›æ¥çš„å†™è¯·æ±‚ï¼Œä¼šé‡‡ç”¨ Copy On Writeï¼ˆå†™æ—¶å¤åˆ¶ï¼‰çš„æ–¹å¼æ“ä½œå†…å­˜æ•°æ®ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œä¸»è¿›ç¨‹ä¸€æ—¦æœ‰æ•°æ®éœ€è¦ä¿®æ”¹ï¼ŒRedis å¹¶ä¸ä¼šç›´æ¥ä¿®æ”¹ç°æœ‰å†…å­˜ä¸­çš„æ•°æ®ï¼Œè€Œæ˜¯å…ˆå°†è¿™å—å†…å­˜æ•°æ®æ‹·è´å‡ºæ¥ï¼Œå†ä¿®æ”¹è¿™å—æ–°å†…å­˜çš„æ•°æ®ï¼Œè¿™å°±æ˜¯æ‰€è°“çš„ã€Œå†™æ—¶å¤åˆ¶ã€ã€‚\nå†™æ—¶å¤åˆ¶ä½ ä¹Ÿå¯ä»¥ç†è§£æˆï¼Œè°éœ€è¦å‘ç”Ÿå†™æ“ä½œï¼Œè°å°±éœ€è¦å…ˆæ‹·è´ï¼Œå†ä¿®æ”¹ã€‚\nè¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œçˆ¶è¿›ç¨‹æœ‰ä»»ä½•å†™æ“ä½œï¼Œå¹¶ä¸ä¼šå½±å“å­è¿›ç¨‹çš„æ•°æ®æŒä¹…åŒ–ï¼ˆå­è¿›ç¨‹åªæŒä¹…åŒ– fork è¿™ä¸€ç¬é—´æ•´ä¸ªå®ä¾‹ä¸­çš„æ‰€æœ‰æ•°æ®å³å¯ï¼Œä¸å…³å¿ƒæ–°çš„æ•°æ®å˜æ›´ï¼Œå› ä¸ºå­è¿›ç¨‹åªéœ€è¦ä¸€ä»½å†…å­˜å¿«ç…§ï¼Œç„¶åæŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼‰ã€‚\nä½†æ˜¯è¯·æ³¨æ„ï¼Œä¸»è¿›ç¨‹åœ¨æ‹·è´å†…å­˜æ•°æ®æ—¶ï¼Œè¿™ä¸ªé˜¶æ®µå°±æ¶‰åŠåˆ°æ–°å†…å­˜çš„ç”³è¯·ï¼Œå¦‚æœæ­¤æ—¶æ“ä½œç³»ç»Ÿå¼€å¯äº†å†…å­˜å¤§é¡µï¼Œé‚£ä¹ˆåœ¨æ­¤æœŸé—´ï¼Œå®¢æˆ·ç«¯å³ä¾¿åªä¿®æ”¹ 10B çš„æ•°æ®ï¼ŒRedis åœ¨ç”³è¯·å†…å­˜æ—¶ä¹Ÿä¼šä»¥ 2MB ä¸ºå•ä½å‘æ“ä½œç³»ç»Ÿç”³è¯·ï¼Œç”³è¯·å†…å­˜çš„è€—æ—¶å˜é•¿ï¼Œè¿›è€Œå¯¼è‡´æ¯ä¸ªå†™è¯·æ±‚çš„å»¶è¿Ÿå¢åŠ ï¼Œå½±å“åˆ° Redis æ€§èƒ½ã€‚\nåŒæ ·åœ°ï¼Œå¦‚æœè¿™ä¸ªå†™è¯·æ±‚æ“ä½œçš„æ˜¯ä¸€ä¸ª bigkeyï¼Œé‚£ä¸»è¿›ç¨‹åœ¨æ‹·è´è¿™ä¸ª bigkey å†…å­˜å—æ—¶ï¼Œä¸€æ¬¡ç”³è¯·çš„å†…å­˜ä¼šæ›´å¤§ï¼Œæ—¶é—´ä¹Ÿä¼šæ›´ä¹…ã€‚å¯è§ï¼Œbigkey åœ¨è¿™é‡Œåˆä¸€æ¬¡å½±å“åˆ°äº†æ€§èƒ½ã€‚\n\né‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿå¾ˆç®€å•ï¼Œä½ åªéœ€è¦å…³é—­å†…å­˜å¤§é¡µæœºåˆ¶å°±å¯ä»¥äº†ã€‚\né¦–å…ˆï¼Œä½ éœ€è¦æŸ¥çœ‹ Redis æœºå™¨æ˜¯å¦å¼€å¯äº†å†…å­˜å¤§é¡µï¼š\n$ cat /sys/kernel/mm/transparent_hugepage/enabled[always] madvise never\n\nå¦‚æœè¾“å‡ºé€‰é¡¹æ˜¯ alwaysï¼Œå°±è¡¨ç¤ºç›®å‰å¼€å¯äº†å†…å­˜å¤§é¡µæœºåˆ¶ï¼Œæˆ‘ä»¬éœ€è¦å…³æ‰å®ƒï¼š\n$ echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled\n\nå…¶å®ï¼Œæ“ä½œç³»ç»Ÿæä¾›çš„å†…å­˜å¤§é¡µæœºåˆ¶ï¼Œå…¶ä¼˜åŠ¿æ˜¯ï¼Œå¯ä»¥åœ¨ä¸€å®šç¨‹åºä¸Šé™ä½åº”ç”¨ç¨‹åºç”³è¯·å†…å­˜çš„æ¬¡æ•°ã€‚\nä½†æ˜¯å¯¹äº Redis è¿™ç§å¯¹æ€§èƒ½å’Œå»¶è¿Ÿæå…¶æ•æ„Ÿçš„æ•°æ®åº“æ¥è¯´ï¼Œæˆ‘ä»¬å¸Œæœ› Redis åœ¨æ¯æ¬¡ç”³è¯·å†…å­˜æ—¶ï¼Œè€—æ—¶å°½é‡çŸ­ï¼Œæ‰€ä»¥æˆ‘ä¸å»ºè®®ä½ åœ¨ Redis æœºå™¨ä¸Šå¼€å¯è¿™ä¸ªæœºåˆ¶ã€‚\nå…«ã€å¼€å¯AOFå‰é¢æˆ‘ä»¬åˆ†æäº† RDB å’Œ AOF rewrite å¯¹ Redis æ€§èƒ½çš„å½±å“ï¼Œä¸»è¦å…³æ³¨ç‚¹åœ¨ fork ä¸Šã€‚\nå…¶å®ï¼Œå…³äºæ•°æ®æŒä¹…åŒ–æ–¹é¢ï¼Œè¿˜æœ‰å½±å“ Redis æ€§èƒ½çš„å› ç´ ï¼Œè¿™æ¬¡æˆ‘ä»¬é‡ç‚¹æ¥çœ‹ AOF æ•°æ®æŒä¹…åŒ–ã€‚\nå¦‚æœä½ çš„ AOF é…ç½®ä¸åˆç†ï¼Œè¿˜æ˜¯æœ‰å¯èƒ½ä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚\nå½“ Redis å¼€å¯ AOF åï¼Œå…¶å·¥ä½œåŸç†å¦‚ä¸‹ï¼š\n\nRedis æ‰§è¡Œå†™å‘½ä»¤åï¼ŒæŠŠè¿™ä¸ªå‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶å†…å­˜ä¸­ï¼ˆwrite ç³»ç»Ÿè°ƒç”¨ï¼‰\nRedis æ ¹æ®é…ç½®çš„ AOF åˆ·ç›˜ç­–ç•¥ï¼ŒæŠŠ AOF å†…å­˜æ•°æ®åˆ·åˆ°ç£ç›˜ä¸Šï¼ˆfsync ç³»ç»Ÿè°ƒç”¨ï¼‰\n\nä¸ºäº†ä¿è¯ AOF æ–‡ä»¶æ•°æ®çš„å®‰å…¨æ€§ï¼ŒRedis æä¾›äº† 3 ç§åˆ·ç›˜æœºåˆ¶ï¼š\n\nappendfsync alwaysï¼šä¸»çº¿ç¨‹æ¯æ¬¡æ‰§è¡Œå†™æ“ä½œåç«‹å³åˆ·ç›˜ï¼Œæ­¤æ–¹æ¡ˆä¼šå ç”¨æ¯”è¾ƒå¤§çš„ç£ç›˜ IO èµ„æºï¼Œä½†æ•°æ®å®‰å…¨æ€§æœ€é«˜\nappendfsync noï¼šä¸»çº¿ç¨‹æ¯æ¬¡å†™æ“ä½œåªå†™å†…å­˜å°±è¿”å›ï¼Œå†…å­˜æ•°æ®ä»€ä¹ˆæ—¶å€™åˆ·åˆ°ç£ç›˜ï¼Œäº¤ç”±æ“ä½œç³»ç»Ÿå†³å®šï¼Œæ­¤æ–¹æ¡ˆå¯¹æ€§èƒ½å½±å“æœ€å°ï¼Œä½†æ•°æ®å®‰å…¨æ€§ä¹Ÿæœ€ä½ï¼ŒRedis å®•æœºæ—¶ä¸¢å¤±çš„æ•°æ®å–å†³äºæ“ä½œç³»ç»Ÿåˆ·ç›˜æ—¶æœº\nappendfsync everysecï¼šä¸»çº¿ç¨‹æ¯æ¬¡å†™æ“ä½œåªå†™å†…å­˜å°±è¿”å›ï¼Œç„¶åç”±åå°çº¿ç¨‹æ¯éš” 1 ç§’æ‰§è¡Œä¸€æ¬¡åˆ·ç›˜æ“ä½œï¼ˆè§¦å‘fsyncç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œæ­¤æ–¹æ¡ˆå¯¹æ€§èƒ½å½±å“ç›¸å¯¹è¾ƒå°ï¼Œä½†å½“ Redis å®•æœºæ—¶ä¼šä¸¢å¤± 1 ç§’çš„æ•°æ®\n\nAOFåˆ·ç›˜æœºåˆ¶å¯¹æ€§èƒ½çš„å½±å“å¦‚æœä½ çš„ AOF é…ç½®ä¸º appendfsync alwaysï¼Œé‚£ä¹ˆ Redis æ¯å¤„ç†ä¸€æ¬¡å†™æ“ä½œï¼Œéƒ½ä¼šæŠŠè¿™ä¸ªå‘½ä»¤å†™å…¥åˆ°ç£ç›˜ä¸­æ‰è¿”å›ï¼Œæ•´ä¸ªè¿‡ç¨‹éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œçš„ï¼Œè¿™ä¸ªè¿‡ç¨‹å¿…ç„¶ä¼šåŠ é‡ Redis å†™è´Ÿæ‹…ã€‚\nåŸå› ä¹Ÿå¾ˆç®€å•ï¼Œæ“ä½œç£ç›˜è¦æ¯”æ“ä½œå†…å­˜æ…¢å‡ ç™¾å€ï¼Œé‡‡ç”¨è¿™ä¸ªé…ç½®ä¼šä¸¥é‡æ‹–æ…¢ Redis çš„æ€§èƒ½ï¼Œå› æ­¤æˆ‘ä¸å»ºè®®ä½ æŠŠ AOF åˆ·ç›˜æ–¹å¼é…ç½®ä¸º alwaysã€‚\næˆ‘ä»¬æ¥ç€æ¥çœ‹ appendfsync no é…ç½®é¡¹ã€‚\nåœ¨è¿™ç§é…ç½®ä¸‹ï¼ŒRedis æ¯æ¬¡å†™æ“ä½œåªå†™å†…å­˜ï¼Œä»€ä¹ˆæ—¶å€™æŠŠå†…å­˜ä¸­çš„æ•°æ®åˆ·åˆ°ç£ç›˜ï¼Œäº¤ç»™æ“ä½œç³»ç»Ÿå†³å®šï¼Œæ­¤æ–¹æ¡ˆå¯¹ Redis çš„æ€§èƒ½å½±å“æœ€å°ï¼Œä½†å½“ Redis å®•æœºæ—¶ï¼Œä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ï¼Œä¸ºäº†æ•°æ®çš„å®‰å…¨æ€§ï¼Œä¸€èˆ¬æˆ‘ä»¬ä¹Ÿä¸é‡‡å–è¿™ç§é…ç½®ã€‚\n\nå¦‚æœä½ çš„ Redis åªç”¨ä½œçº¯ç¼“å­˜ï¼Œå¯¹äºæ•°æ®ä¸¢å¤±ä¸æ•æ„Ÿï¼Œé‡‡ç”¨é…ç½® appendfsync no ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚\n\nçœ‹åˆ°è¿™é‡Œï¼Œæˆ‘çŒœä½ è‚¯å®šå’Œå¤§å¤šæ•°äººçš„æƒ³æ³•ä¸€æ ·ï¼Œé€‰æ¯”è¾ƒæŠ˜ä¸­çš„æ–¹æ¡ˆ appendfsync everysec å°±æ²¡é—®é¢˜äº†å§ï¼Ÿ\nè¿™ä¸ªæ–¹æ¡ˆä¼˜åŠ¿åœ¨äºï¼ŒRedis ä¸»çº¿ç¨‹å†™å®Œå†…å­˜åå°±è¿”å›ï¼Œå…·ä½“çš„åˆ·ç›˜æ“ä½œæ˜¯æ”¾åˆ°åå°çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œåå°çº¿ç¨‹æ¯éš” 1 ç§’æŠŠå†…å­˜ä¸­çš„æ•°æ®åˆ·åˆ°ç£ç›˜ä¸­ã€‚\nè¿™ç§æ–¹æ¡ˆæ—¢å…¼é¡¾äº†æ€§èƒ½ï¼Œåˆå°½å¯èƒ½åœ°ä¿è¯äº†æ•°æ®å®‰å…¨ï¼Œæ˜¯ä¸æ˜¯è§‰å¾—å¾ˆå®Œç¾ï¼Ÿ\nä½†æ˜¯ï¼Œé‡‡ç”¨è¿™ç§æ–¹æ¡ˆä½ ä¹Ÿè¦è­¦æƒ•ä¸€ä¸‹ï¼Œå› ä¸ºè¿™ç§æ–¹æ¡ˆè¿˜æ˜¯å­˜åœ¨å¯¼è‡´ Redis å»¶è¿Ÿå˜å¤§çš„æƒ…å†µå‘ç”Ÿï¼Œç”šè‡³ä¼šé˜»å¡æ•´ä¸ª Redisã€‚\nè¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿæˆ‘æŠŠ AOF æœ€è€—æ—¶çš„åˆ·ç›˜æ“ä½œï¼Œæ”¾åˆ°åå°çº¿ç¨‹ä¸­ä¹Ÿä¼šå½±å“åˆ° Redis ä¸»çº¿ç¨‹ï¼Ÿ\nä½ è¯•æƒ³è¿™æ ·ä¸€ç§æƒ…å†µï¼šå½“ Redis åå°çº¿ç¨‹åœ¨æ‰§è¡Œ AOF æ–‡ä»¶åˆ·ç›˜æ—¶ï¼Œå¦‚æœæ­¤æ—¶ç£ç›˜çš„ IO è´Ÿè½½å¾ˆé«˜ï¼Œé‚£è¿™ä¸ªåå°çº¿ç¨‹åœ¨æ‰§è¡Œåˆ·ç›˜æ“ä½œï¼ˆfsyncç³»ç»Ÿè°ƒç”¨ï¼‰æ—¶å°±ä¼šè¢«é˜»å¡ä½ã€‚\næ­¤æ—¶çš„ä¸»çº¿ç¨‹ä¾æ—§ä¼šæ¥æ”¶å†™è¯·æ±‚ï¼Œç´§æ¥ç€ï¼Œä¸»çº¿ç¨‹åˆéœ€è¦æŠŠæ•°æ®å†™åˆ°æ–‡ä»¶å†…å­˜ä¸­ï¼ˆwrite ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼Œä½†æ­¤æ—¶çš„åå°å­çº¿ç¨‹ç”±äºç£ç›˜è´Ÿè½½è¿‡é«˜ï¼Œå¯¼è‡´ fsync å‘ç”Ÿé˜»å¡ï¼Œè¿Ÿè¿Ÿä¸èƒ½è¿”å›ï¼Œé‚£ä¸»çº¿ç¨‹åœ¨æ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œä¹Ÿä¼šè¢«é˜»å¡ä½ï¼Œç›´åˆ°åå°çº¿ç¨‹ fsync æ‰§è¡Œå®Œæˆåï¼Œä¸»çº¿ç¨‹æ‰§è¡Œ write æ‰èƒ½æˆåŠŸè¿”å›ã€‚\nçœ‹åˆ°äº†ä¹ˆï¼Ÿåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä¾æ—§æœ‰é˜»å¡çš„é£é™©ã€‚\n\næ‰€ä»¥ï¼Œå°½ç®¡ä½ çš„ AOF é…ç½®ä¸º appendfsync everysecï¼Œä¹Ÿä¸èƒ½æ‰ä»¥è½»å¿ƒï¼Œè¦è­¦æƒ•ç£ç›˜å‹åŠ›è¿‡å¤§å¯¼è‡´çš„ Redis æœ‰æ€§èƒ½é—®é¢˜ã€‚\né‚£ä»€ä¹ˆæƒ…å†µä¸‹ä¼šå¯¼è‡´ç£ç›˜ IO è´Ÿè½½è¿‡å¤§ï¼Ÿä»¥åŠå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ\næ’æŸ¥æ–¹å‘\nå­è¿›ç¨‹æ­£åœ¨æ‰§è¡Œ AOF rewriteï¼Œè¿™ä¸ªè¿‡ç¨‹ä¼šå ç”¨å¤§é‡çš„ç£ç›˜ IO èµ„æº\næœ‰å…¶ä»–åº”ç”¨ç¨‹åºåœ¨æ‰§è¡Œå¤§é‡çš„å†™æ–‡ä»¶æ“ä½œï¼Œä¹Ÿä¼šå ç”¨ç£ç›˜ IO èµ„æº\n\nå¯¹äºæƒ…å†µ1ï¼Œè¯´ç™½äº†å°±æ˜¯ï¼ŒRedis çš„ AOF åå°å­çº¿ç¨‹åˆ·ç›˜æ“ä½œï¼Œæ’ä¸Šäº†å­è¿›ç¨‹ AOF rewriteï¼\nè¿™æ€ä¹ˆåŠï¼Ÿéš¾é“è¦å…³é—­ AOF rewrite æ‰è¡Œï¼Ÿ\nå¹¸è¿çš„æ˜¯ï¼ŒRedis æä¾›äº†ä¸€ä¸ªé…ç½®é¡¹ï¼Œå½“å­è¿›ç¨‹åœ¨ AOF rewrite æœŸé—´ï¼Œå¯ä»¥è®©åå°å­çº¿ç¨‹ä¸æ‰§è¡Œåˆ·ç›˜ï¼ˆä¸è§¦å‘ fsync ç³»ç»Ÿè°ƒç”¨ï¼‰æ“ä½œã€‚\nè¿™ç›¸å½“äºåœ¨ AOF rewrite æœŸé—´ï¼Œä¸´æ—¶æŠŠ appendfsync è®¾ç½®ä¸ºäº† noneï¼Œé…ç½®å¦‚ä¸‹ï¼š\n# AOF rewrite æœŸé—´ï¼ŒAOF åå°å­çº¿ç¨‹ä¸è¿›è¡Œåˆ·ç›˜æ“ä½œ# ç›¸å½“äºåœ¨è¿™æœŸé—´ï¼Œä¸´æ—¶æŠŠ appendfsync è®¾ç½®ä¸ºäº† noneno-appendfsync-on-rewrite yes\n\nå½“ç„¶ï¼Œå¼€å¯è¿™ä¸ªé…ç½®é¡¹ï¼Œåœ¨ AOF rewrite æœŸé—´ï¼Œå¦‚æœå®ä¾‹å‘ç”Ÿå®•æœºï¼Œé‚£ä¹ˆæ­¤æ—¶ä¼šä¸¢å¤±æ›´å¤šçš„æ•°æ®ï¼Œæ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ï¼Œä½ éœ€è¦æƒè¡¡åè¿›è¡Œé€‰æ‹©ã€‚\nå¦‚æœå ç”¨ç£ç›˜èµ„æºçš„æ˜¯å…¶ä»–åº”ç”¨ç¨‹åºï¼Œé‚£å°±æ¯”è¾ƒç®€å•äº†ï¼Œä½ éœ€è¦å®šä½åˆ°æ˜¯å“ªä¸ªåº”ç”¨ç¨‹åºåœ¨å¤§é‡å†™ç£ç›˜ï¼Œç„¶åæŠŠè¿™ä¸ªåº”ç”¨ç¨‹åºè¿ç§»åˆ°å…¶ä»–æœºå™¨ä¸Šæ‰§è¡Œå°±å¥½äº†ï¼Œé¿å…å¯¹ Redis äº§ç”Ÿå½±å“ã€‚\nå½“ç„¶ï¼Œå¦‚æœä½ å¯¹ Redis çš„æ€§èƒ½å’Œæ•°æ®å®‰å…¨éƒ½æœ‰å¾ˆé«˜çš„è¦æ±‚ï¼Œé‚£ä¹ˆæˆ‘å»ºè®®ä»ç¡¬ä»¶å±‚é¢æ¥ä¼˜åŒ–ï¼Œæ›´æ¢ä¸º SSD ç£ç›˜ï¼Œæé«˜ç£ç›˜çš„ IO èƒ½åŠ›ï¼Œä¿è¯ AOF æœŸé—´æœ‰å……è¶³çš„ç£ç›˜èµ„æºå¯ä»¥ä½¿ç”¨ã€‚\nä¹ã€ç»‘å®šCPUå¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨éƒ¨ç½²æœåŠ¡æ—¶ï¼Œä¸ºäº†æé«˜æœåŠ¡æ€§èƒ½ï¼Œé™ä½åº”ç”¨ç¨‹åºåœ¨å¤šä¸ª CPU æ ¸å¿ƒä¹‹é—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¸¦æ¥çš„æ€§èƒ½æŸè€—ï¼Œé€šå¸¸é‡‡ç”¨çš„æ–¹æ¡ˆæ˜¯è¿›ç¨‹ç»‘å®š CPU çš„æ–¹å¼æé«˜æ€§èƒ½ã€‚\nä½†åœ¨éƒ¨ç½² Redis æ—¶ï¼Œå¦‚æœä½ éœ€è¦ç»‘å®š CPU æ¥æé«˜å…¶æ€§èƒ½ï¼Œå»ºè®®ä»”ç»†æ–Ÿé…Œåå†åšæ“ä½œã€‚\nä¸ºä»€ä¹ˆï¼Ÿå› ä¸º Redis åœ¨ç»‘å®š CPU æ—¶ï¼Œæ˜¯æœ‰å¾ˆå¤šè€ƒç©¶çš„ï¼Œå¦‚æœä½ ä¸äº†è§£ Redis çš„è¿è¡ŒåŸç†ï¼Œéšæ„ç»‘å®š CPU ä¸ä»…ä¸ä¼šæé«˜æ€§èƒ½ï¼Œç”šè‡³æœ‰å¯èƒ½ä¼šå¸¦æ¥ç›¸åçš„æ•ˆæœã€‚\næˆ‘ä»¬éƒ½çŸ¥é“ï¼Œä¸€èˆ¬ç°ä»£çš„æœåŠ¡å™¨ä¼šæœ‰å¤šä¸ª CPUï¼Œè€Œæ¯ä¸ª CPU åˆåŒ…å«å¤šä¸ªç‰©ç†æ ¸å¿ƒï¼Œæ¯ä¸ªç‰©ç†æ ¸å¿ƒåˆåˆ†ä¸ºå¤šä¸ªé€»è¾‘æ ¸å¿ƒï¼Œæ¯ä¸ªç‰©ç†æ ¸ä¸‹çš„é€»è¾‘æ ¸å…±ç”¨ L1/L2 Cacheã€‚\nè€Œ Redis Server é™¤äº†ä¸»çº¿ç¨‹æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ä¹‹å¤–ï¼Œè¿˜ä¼šåˆ›å»ºå­è¿›ç¨‹ã€å­çº¿ç¨‹ã€‚\nå…¶ä¸­å­è¿›ç¨‹ç”¨äºæ•°æ®æŒä¹…åŒ–ï¼Œè€Œå­çº¿ç¨‹ç”¨äºæ‰§è¡Œä¸€äº›æ¯”è¾ƒè€—æ—¶æ“ä½œï¼Œä¾‹å¦‚å¼‚æ­¥é‡Šæ”¾ fdã€å¼‚æ­¥ AOF åˆ·ç›˜ã€å¼‚æ­¥ lazy-free ç­‰ç­‰ã€‚\nå¦‚æœä½ æŠŠ Redis è¿›ç¨‹åªç»‘å®šäº†ä¸€ä¸ª CPU é€»è¾‘æ ¸å¿ƒä¸Šï¼Œé‚£ä¹ˆå½“ Redis åœ¨è¿›è¡Œæ•°æ®æŒä¹…åŒ–æ—¶ï¼Œfork å‡ºçš„å­è¿›ç¨‹ä¼šç»§æ‰¿çˆ¶è¿›ç¨‹çš„ CPU ä½¿ç”¨åå¥½ã€‚\nè€Œæ­¤æ—¶çš„å­è¿›ç¨‹ä¼šæ¶ˆè€—å¤§é‡çš„ CPU èµ„æºè¿›è¡Œæ•°æ®æŒä¹…åŒ–ï¼ˆæŠŠå®ä¾‹æ•°æ®å…¨éƒ¨æ‰«æå‡ºæ¥éœ€è¦è€—è´¹CPUï¼‰ï¼Œè¿™å°±ä¼šå¯¼è‡´å­è¿›ç¨‹ä¼šä¸ä¸»è¿›ç¨‹å‘ç”Ÿ CPU äº‰æŠ¢ï¼Œè¿›è€Œå½±å“åˆ°ä¸»è¿›ç¨‹æœåŠ¡å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè®¿é—®å»¶è¿Ÿå˜å¤§ã€‚\nè¿™å°±æ˜¯ Redis ç»‘å®š CPU å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ã€‚\né‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¦‚æœä½ ç¡®å®æƒ³è¦ç»‘å®š CPUï¼Œå¯ä»¥ä¼˜åŒ–çš„æ–¹æ¡ˆæ˜¯ï¼Œä¸è¦è®© Redis è¿›ç¨‹åªç»‘å®šåœ¨ä¸€ä¸ª CPU é€»è¾‘æ ¸ä¸Šï¼Œè€Œæ˜¯ç»‘å®šåœ¨å¤šä¸ªé€»è¾‘æ ¸å¿ƒä¸Šï¼Œè€Œä¸”ï¼Œç»‘å®šçš„å¤šä¸ªé€»è¾‘æ ¸å¿ƒæœ€å¥½æ˜¯åŒä¸€ä¸ªç‰©ç†æ ¸å¿ƒï¼Œè¿™æ ·å®ƒä»¬è¿˜å¯ä»¥å…±ç”¨ L1/L2 Cacheã€‚\nå½“ç„¶ï¼Œå³ä¾¿æˆ‘ä»¬æŠŠ Redis ç»‘å®šåœ¨å¤šä¸ªé€»è¾‘æ ¸å¿ƒä¸Šï¼Œä¹Ÿåªèƒ½åœ¨ä¸€å®šç¨‹åº¦ä¸Šç¼“è§£ä¸»çº¿ç¨‹ã€å­è¿›ç¨‹ã€åå°çº¿ç¨‹åœ¨ CPU èµ„æºä¸Šçš„ç«äº‰ã€‚\nå› ä¸ºè¿™äº›å­è¿›ç¨‹ã€å­çº¿ç¨‹è¿˜æ˜¯ä¼šåœ¨è¿™å¤šä¸ªé€»è¾‘æ ¸å¿ƒä¸Šè¿›è¡Œåˆ‡æ¢ï¼Œå­˜åœ¨æ€§èƒ½æŸè€—ã€‚\nå¦‚ä½•å†è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Ÿå¯èƒ½ä½ å·²ç»æƒ³åˆ°äº†ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥è®©ä¸»çº¿ç¨‹ã€å­è¿›ç¨‹ã€åå°çº¿ç¨‹ï¼Œåˆ†åˆ«ç»‘å®šåœ¨å›ºå®šçš„ CPU æ ¸å¿ƒä¸Šï¼Œä¸è®©å®ƒä»¬æ¥å›åˆ‡æ¢ï¼Œè¿™æ ·ä¸€æ¥ï¼Œä»–ä»¬å„è‡ªä½¿ç”¨çš„ CPU èµ„æºäº’ä¸å½±å“ã€‚\nå…¶å®ï¼Œè¿™ä¸ªæ–¹æ¡ˆ Redis å®˜æ–¹å·²ç»æƒ³åˆ°äº†ã€‚\nRedis åœ¨ 6.0 ç‰ˆæœ¬å·²ç»æ¨å‡ºäº†è¿™ä¸ªåŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»¥ä¸‹é…ç½®ï¼Œå¯¹ä¸»çº¿ç¨‹ã€åå°çº¿ç¨‹ã€åå° RDB è¿›ç¨‹ã€AOF rewrite è¿›ç¨‹ï¼Œç»‘å®šå›ºå®šçš„ CPU é€»è¾‘æ ¸å¿ƒï¼š\n# Redis Server å’Œ IO çº¿ç¨‹ç»‘å®šåˆ° CPUæ ¸å¿ƒ 0,2,4,6server_cpulist 0-7:2 # åå°å­çº¿ç¨‹ç»‘å®šåˆ° CPUæ ¸å¿ƒ 1,3bio_cpulist 1,3 # åå° AOF rewrite è¿›ç¨‹ç»‘å®šåˆ° CPU æ ¸å¿ƒ 8,9,10,11aof_rewrite_cpulist 8-11 # åå° RDB è¿›ç¨‹ç»‘å®šåˆ° CPU æ ¸å¿ƒ 1,10,11# bgsave_cpulist 1,10-1\n\nå¦‚æœä½ ä½¿ç”¨çš„æ­£å¥½æ˜¯ Redis 6.0 ç‰ˆæœ¬ï¼Œå°±å¯ä»¥é€šè¿‡ä»¥ä¸Šé…ç½®ï¼Œæ¥è¿›ä¸€æ­¥æé«˜ Redis æ€§èƒ½ã€‚\nè¿™é‡Œæˆ‘éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒRedis çš„æ€§èƒ½å·²ç»è¶³å¤Ÿä¼˜ç§€ï¼Œé™¤éä½ å¯¹ Redis çš„æ€§èƒ½æœ‰æ›´åŠ ä¸¥è‹›çš„è¦æ±‚ï¼Œå¦åˆ™ä¸å»ºè®®ä½ ç»‘å®š CPUã€‚\nä»ä¸Šé¢çš„åˆ†æä½ ä¹Ÿèƒ½çœ‹å‡ºï¼Œç»‘å®š CPU éœ€è¦ä½ å¯¹è®¡ç®—æœºä½“ç³»ç»“æ„æœ‰éå¸¸æ¸…æ™°çš„äº†è§£ï¼Œå¦åˆ™è°¨æ…æ“ä½œã€‚\nåã€ä½¿ç”¨Swapå¦‚æœä½ å‘ç° Redis çªç„¶å˜å¾—éå¸¸æ…¢ï¼Œæ¯æ¬¡çš„æ“ä½œè€—æ—¶éƒ½è¾¾åˆ°äº†å‡ ç™¾æ¯«ç§’ç”šè‡³ç§’çº§ï¼Œé‚£æ­¤æ—¶ä½ å°±éœ€è¦æ£€æŸ¥ Redis æ˜¯å¦ä½¿ç”¨åˆ°äº† Swapï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ Redis åŸºæœ¬ä¸Šå·²ç»æ— æ³•æä¾›é«˜æ€§èƒ½çš„æœåŠ¡äº†ã€‚\nä»€ä¹ˆæ˜¯ Swapï¼Ÿä¸ºä»€ä¹ˆä½¿ç”¨ Swap ä¼šå¯¼è‡´ Redis çš„æ€§èƒ½ä¸‹é™ï¼Ÿ\nå¦‚æœä½ å¯¹æ“ä½œç³»ç»Ÿæœ‰äº›äº†è§£ï¼Œå°±ä¼šçŸ¥é“æ“ä½œç³»ç»Ÿä¸ºäº†ç¼“è§£å†…å­˜ä¸è¶³å¯¹åº”ç”¨ç¨‹åºçš„å½±å“ï¼Œå…è®¸æŠŠä¸€éƒ¨åˆ†å†…å­˜ä¸­çš„æ•°æ®æ¢åˆ°ç£ç›˜ä¸Šï¼Œä»¥è¾¾åˆ°åº”ç”¨ç¨‹åºå¯¹å†…å­˜ä½¿ç”¨çš„ç¼“å†²ï¼Œè¿™äº›å†…å­˜æ•°æ®è¢«æ¢åˆ°ç£ç›˜ä¸Šçš„åŒºåŸŸï¼Œå°±æ˜¯ Swapã€‚\né—®é¢˜å°±åœ¨äºï¼Œå½“å†…å­˜ä¸­çš„æ•°æ®è¢«æ¢åˆ°ç£ç›˜ä¸Šåï¼ŒRedis å†è®¿é—®è¿™äº›æ•°æ®æ—¶ï¼Œå°±éœ€è¦ä»ç£ç›˜ä¸Šè¯»å–ï¼Œè®¿é—®ç£ç›˜çš„é€Ÿåº¦è¦æ¯”è®¿é—®å†…å­˜æ…¢å‡ ç™¾å€ï¼\nå°¤å…¶æ˜¯é’ˆå¯¹ Redis è¿™ç§å¯¹æ€§èƒ½è¦æ±‚æé«˜ã€æ€§èƒ½æå…¶æ•æ„Ÿçš„æ•°æ®åº“æ¥è¯´ï¼Œè¿™ä¸ªæ“ä½œå»¶æ—¶æ˜¯æ— æ³•æ¥å—çš„ã€‚\næ­¤æ—¶ï¼Œä½ éœ€è¦æ£€æŸ¥ Redis æœºå™¨çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œç¡®è®¤æ˜¯å¦å­˜åœ¨ä½¿ç”¨äº† Swapã€‚\nä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥æŸ¥çœ‹ Redis è¿›ç¨‹æ˜¯å¦ä½¿ç”¨åˆ°äº† Swapï¼š\n# å…ˆæ‰¾åˆ° Redis çš„è¿›ç¨‹ ID$ ps -aux | grep redis-server # æŸ¥çœ‹ Redis Swap ä½¿ç”¨æƒ…å†µ$ cat /proc/$pid/smaps | egrep &#x27;^(Swap|Size)&#x27;\n\nè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š\nSize:               1256 kBSwap:                  0 kBSize:                  4 kBSwap:                  0 kBSize:                132 kBSwap:                  0 kBSize:              63488 kBSwap:                  0 kBSize:                132 kBSwap:                  0 kBSize:              65404 kBSwap:                  0 kBSize:            1921024 kBSwap:                  0 kB...\n\nè¿™ä¸ªç»“æœä¼šåˆ—å‡º Redis è¿›ç¨‹çš„å†…å­˜ä½¿ç”¨æƒ…å†µã€‚\næ¯ä¸€è¡Œ Size è¡¨ç¤º Redis æ‰€ç”¨çš„ä¸€å—å†…å­˜å¤§å°ï¼ŒSize ä¸‹é¢çš„ Swap å°±è¡¨ç¤ºè¿™å— Size å¤§å°çš„å†…å­˜ï¼Œæœ‰å¤šå°‘æ•°æ®å·²ç»è¢«æ¢åˆ°ç£ç›˜ä¸Šäº†ï¼Œå¦‚æœè¿™ä¸¤ä¸ªå€¼ç›¸ç­‰ï¼Œè¯´æ˜è¿™å—å†…å­˜çš„æ•°æ®éƒ½å·²ç»å®Œå…¨è¢«æ¢åˆ°ç£ç›˜ä¸Šäº†ã€‚\nå¦‚æœåªæ˜¯å°‘é‡æ•°æ®è¢«æ¢åˆ°ç£ç›˜ä¸Šï¼Œä¾‹å¦‚æ¯ä¸€å— Swap å å¯¹åº” Size çš„æ¯”ä¾‹å¾ˆå°ï¼Œé‚£å½±å“å¹¶ä¸æ˜¯å¾ˆå¤§ã€‚å¦‚æœæ˜¯å‡ ç™¾å…†ç”šè‡³ä¸Š GB çš„å†…å­˜è¢«æ¢åˆ°äº†ç£ç›˜ä¸Šï¼Œé‚£ä¹ˆä½ å°±éœ€è¦è­¦æƒ•äº†ï¼Œè¿™ç§æƒ…å†µ Redis çš„æ€§èƒ½è‚¯å®šä¼šæ€¥å‰§ä¸‹é™ã€‚\nè§£å†³æ–¹æ¡ˆ\nå¢åŠ æœºå™¨çš„å†…å­˜ï¼Œè®© Redis æœ‰è¶³å¤Ÿçš„å†…å­˜å¯ä»¥ä½¿ç”¨\næ•´ç†å†…å­˜ç©ºé—´ï¼Œé‡Šæ”¾å‡ºè¶³å¤Ÿçš„å†…å­˜ä¾› Redis ä½¿ç”¨ï¼Œç„¶åé‡Šæ”¾ Redis çš„ Swapï¼Œè®© Redis é‡æ–°ä½¿ç”¨å†…å­˜\n\nå¯è§ï¼Œå½“ Redis ä½¿ç”¨åˆ° Swap åï¼Œæ­¤æ—¶çš„ Redis æ€§èƒ½åŸºæœ¬å·²è¾¾ä¸åˆ°é«˜æ€§èƒ½çš„è¦æ±‚ï¼ˆä½ å¯ä»¥ç†è§£ä¸ºæ­¦åŠŸè¢«åºŸï¼‰ï¼Œæ‰€ä»¥ä½ ä¹Ÿéœ€è¦æå‰é¢„é˜²è¿™ç§æƒ…å†µã€‚\né¢„é˜²çš„åŠæ³•å°±æ˜¯ï¼Œä½ éœ€è¦å¯¹ Redis æœºå™¨çš„å†…å­˜å’Œ Swap ä½¿ç”¨æƒ…å†µè¿›è¡Œç›‘æ§ï¼Œåœ¨å†…å­˜ä¸è¶³æˆ–ä½¿ç”¨åˆ° Swap æ—¶æŠ¥è­¦å‡ºæ¥ï¼ŒåŠæ—¶å¤„ç†ã€‚\nåä¸€ã€ç¢ç‰‡æ•´ç†Redis çš„æ•°æ®éƒ½å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå½“æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºé¢‘ç¹ä¿®æ”¹ Redis ä¸­çš„æ•°æ®æ—¶ï¼Œå°±æœ‰å¯èƒ½ä¼šå¯¼è‡´ Redis äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚\nå†…å­˜ç¢ç‰‡ä¼šé™ä½ Redis çš„å†…å­˜ä½¿ç”¨ç‡ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰§è¡Œ INFO å‘½ä»¤ï¼Œå¾—åˆ°è¿™ä¸ªå®ä¾‹çš„å†…å­˜ç¢ç‰‡ç‡ï¼š\n# Memoryused_memory:5709194824used_memory_human:5.32Gused_memory_rss:8264855552used_memory_rss_human:7.70G...mem_fragmentation_ratio:1.45\n\nè¿™ä¸ªå†…å­˜ç¢ç‰‡ç‡æ˜¯æ€ä¹ˆè®¡ç®—çš„ï¼Ÿmem_fragmentation_ratio = used_memory_rss / used_memory\nå…¶ä¸­ used_memory è¡¨ç¤º Redis å­˜å‚¨æ•°æ®çš„å†…å­˜å¤§å°ï¼Œè€Œ used_memory_rss è¡¨ç¤ºæ“ä½œç³»ç»Ÿå®é™…åˆ†é…ç»™ Redis è¿›ç¨‹çš„å¤§å°ã€‚\nå¦‚æœ mem_fragmentation_ratio &gt; 1.5ï¼Œè¯´æ˜å†…å­˜ç¢ç‰‡ç‡å·²ç»è¶…è¿‡äº† 50%ï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦é‡‡å–ä¸€äº›æªæ–½æ¥é™ä½å†…å­˜ç¢ç‰‡äº†ã€‚\nè§£å†³çš„æ–¹æ¡ˆ\nå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Redis 4.0 ä»¥ä¸‹ç‰ˆæœ¬ï¼Œåªèƒ½é€šè¿‡é‡å¯å®ä¾‹æ¥è§£å†³\nå¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Redis 4.0 ç‰ˆæœ¬ï¼Œå®ƒæ­£å¥½æä¾›äº†è‡ªåŠ¨ç¢ç‰‡æ•´ç†çš„åŠŸèƒ½ï¼Œå¯ä»¥é€šè¿‡é…ç½®å¼€å¯ç¢ç‰‡è‡ªåŠ¨æ•´ç†\n\nä½†æ˜¯ï¼Œå¼€å¯å†…å­˜ç¢ç‰‡æ•´ç†ï¼Œå®ƒä¹Ÿæœ‰å¯èƒ½ä¼šå¯¼è‡´ Redis æ€§èƒ½ä¸‹é™ã€‚\nåŸå› åœ¨äºï¼ŒRedis çš„ç¢ç‰‡æ•´ç†å·¥ä½œæ˜¯ä¹Ÿåœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œå½“å…¶è¿›è¡Œç¢ç‰‡æ•´ç†æ—¶ï¼Œå¿…ç„¶ä¼šæ¶ˆè€— CPU èµ„æºï¼Œäº§ç”Ÿæ›´å¤šçš„è€—æ—¶ï¼Œä»è€Œå½±å“åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚\næ‰€ä»¥ï¼Œå½“ä½ éœ€è¦å¼€å¯è¿™ä¸ªåŠŸèƒ½æ—¶ï¼Œæœ€å¥½æå‰æµ‹è¯•è¯„ä¼°å®ƒå¯¹ Redis çš„å½±å“ã€‚\nRedis ç¢ç‰‡æ•´ç†çš„å‚æ•°é…ç½®å¦‚ä¸‹ï¼š\n# å¼€å¯è‡ªåŠ¨å†…å­˜ç¢ç‰‡æ•´ç†ï¼ˆæ€»å¼€å…³ï¼‰activedefrag yes # å†…å­˜ä½¿ç”¨ 100MB ä»¥ä¸‹ï¼Œä¸è¿›è¡Œç¢ç‰‡æ•´ç†active-defrag-ignore-bytes 100mb # å†…å­˜ç¢ç‰‡ç‡è¶…è¿‡ 10%ï¼Œå¼€å§‹ç¢ç‰‡æ•´ç†active-defrag-threshold-lower 10# å†…å­˜ç¢ç‰‡ç‡è¶…è¿‡ 100%ï¼Œå°½æœ€å¤§åŠªåŠ›ç¢ç‰‡æ•´ç†active-defrag-threshold-upper 100 # å†…å­˜ç¢ç‰‡æ•´ç†å ç”¨ CPU èµ„æºæœ€å°ç™¾åˆ†æ¯”active-defrag-cycle-min 1# å†…å­˜ç¢ç‰‡æ•´ç†å ç”¨ CPU èµ„æºæœ€å¤§ç™¾åˆ†æ¯”active-defrag-cycle-max 25 # ç¢ç‰‡æ•´ç†æœŸé—´ï¼Œå¯¹äº List/Set/Hash/ZSet ç±»å‹å…ƒç´ ä¸€æ¬¡ Scan çš„æ•°é‡active-defrag-max-scan-fields 1000\n\néœ€è¦ç»“åˆ Redis æœºå™¨çš„è´Ÿè½½æƒ…å†µï¼Œä»¥åŠåº”ç”¨ç¨‹åºå¯æ¥å—çš„å»¶è¿ŸèŒƒå›´è¿›è¡Œè¯„ä¼°ï¼Œåˆç†è°ƒæ•´ç¢ç‰‡æ•´ç†çš„å‚æ•°ï¼Œå°½å¯èƒ½é™ä½ç¢ç‰‡æ•´ç†æœŸé—´å¯¹ Redis çš„å½±å“ã€‚\nåäºŒã€ ç½‘ç»œå¸¦å®½è¿‡è½½å¦‚æœä»¥ä¸Šäº§ç”Ÿæ€§èƒ½é—®é¢˜çš„åœºæ™¯ï¼Œä½ éƒ½è§„é¿æ‰äº†ï¼Œè€Œä¸” Redis ä¹Ÿç¨³å®šè¿è¡Œäº†å¾ˆé•¿æ—¶é—´ï¼Œä½†åœ¨æŸä¸ªæ—¶é—´ç‚¹ä¹‹åå¼€å§‹ï¼Œæ“ä½œ Redis çªç„¶å¼€å§‹å˜æ…¢äº†ï¼Œè€Œä¸”ä¸€ç›´æŒç»­ä¸‹å»ï¼Œè¿™ç§æƒ…å†µåˆæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´ï¼Ÿ\næ­¤æ—¶ä½ éœ€è¦æ’æŸ¥ä¸€ä¸‹ Redis æœºå™¨çš„ç½‘ç»œå¸¦å®½æ˜¯å¦è¿‡è½½ï¼Œæ˜¯å¦å­˜åœ¨æŸä¸ªå®ä¾‹æŠŠæ•´ä¸ªæœºå™¨çš„ç½‘è·¯å¸¦å®½å æ»¡çš„æƒ…å†µã€‚\nç½‘ç»œå¸¦å®½è¿‡è½½çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨åœ¨ TCP å±‚å’Œç½‘ç»œå±‚å°±ä¼šå‡ºç°æ•°æ®åŒ…å‘é€å»¶è¿Ÿã€ä¸¢åŒ…ç­‰æƒ…å†µã€‚\nRedis çš„é«˜æ€§èƒ½ï¼Œé™¤äº†æ“ä½œå†…å­˜ä¹‹å¤–ï¼Œå°±åœ¨äºç½‘ç»œ IO äº†ï¼Œå¦‚æœç½‘ç»œ IO å­˜åœ¨ç“¶é¢ˆï¼Œé‚£ä¹ˆä¹Ÿä¼šä¸¥é‡å½±å“ Redis çš„æ€§èƒ½ã€‚\nå¦‚æœç¡®å®å‡ºç°è¿™ç§æƒ…å†µï¼Œä½ éœ€è¦åŠæ—¶ç¡®è®¤å æ»¡ç½‘ç»œå¸¦å®½ Redis å®ä¾‹ï¼Œå¦‚æœå±äºæ­£å¸¸çš„ä¸šåŠ¡è®¿é—®ï¼Œé‚£å°±éœ€è¦åŠæ—¶æ‰©å®¹æˆ–è¿ç§»å®ä¾‹äº†ï¼Œé¿å…å› ä¸ºè¿™ä¸ªå®ä¾‹æµé‡è¿‡å¤§ï¼Œå½±å“è¿™ä¸ªæœºå™¨çš„å…¶ä»–å®ä¾‹ã€‚\nè¿ç»´å±‚é¢ï¼Œä½ éœ€è¦å¯¹ Redis æœºå™¨çš„å„é¡¹æŒ‡æ ‡å¢åŠ ç›‘æ§ï¼ŒåŒ…æ‹¬ç½‘ç»œæµé‡ï¼Œåœ¨ç½‘ç»œæµé‡è¾¾åˆ°ä¸€å®šé˜ˆå€¼æ—¶æå‰æŠ¥è­¦ï¼ŒåŠæ—¶ç¡®è®¤å’Œæ‰©å®¹ã€‚\nåä¸‰ã€å…¶ä»–åŸå› é™¤äº†ä»¥ä¸Šè¿™äº›ï¼Œè¿˜æœ‰ä¸€äº›æ¯”è¾ƒå°çš„ç‚¹ï¼Œä¹Ÿéœ€è¦æ³¨æ„ä¸€ä¸‹ï¼š\n\né¢‘ç¹çŸ­è¿æ¥\n\nä½ çš„ä¸šåŠ¡åº”ç”¨ï¼Œåº”è¯¥ä½¿ç”¨é•¿è¿æ¥æ“ä½œ Redisï¼Œé¿å…é¢‘ç¹çš„çŸ­è¿æ¥ã€‚\né¢‘ç¹çš„çŸ­è¿æ¥ä¼šå¯¼è‡´ Redis å¤§é‡æ—¶é—´è€—è´¹åœ¨è¿æ¥çš„å»ºç«‹å’Œé‡Šæ”¾ä¸Šï¼ŒTCP çš„ä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹åŒæ ·ä¹Ÿä¼šå¢åŠ è®¿é—®å»¶è¿Ÿã€‚\n\nè¿ç»´ç›‘æ§\n\nå‰é¢æˆ‘ä¹Ÿæåˆ°äº†ï¼Œè¦æƒ³æå‰é¢„çŸ¥ Redis å˜æ…¢çš„æƒ…å†µå‘ç”Ÿï¼Œå¿…ä¸å¯å°‘çš„å°±æ˜¯åšå¥½å®Œå–„çš„ç›‘æ§ã€‚\nç›‘æ§å…¶å®å°±æ˜¯å¯¹é‡‡é›† Redis çš„å„é¡¹è¿è¡Œæ—¶æŒ‡æ ‡ï¼Œé€šå¸¸çš„åšæ³•æ˜¯ç›‘æ§ç¨‹åºå®šæ—¶é‡‡é›† Redis çš„ INFO ä¿¡æ¯ï¼Œç„¶åæ ¹æ® INFO ä¿¡æ¯ä¸­çš„çŠ¶æ€æ•°æ®åšæ•°æ®å±•ç¤ºå’ŒæŠ¥è­¦ã€‚\nè¿™é‡Œæˆ‘éœ€è¦æé†’ä½ çš„æ˜¯ï¼Œåœ¨å†™ä¸€äº›ç›‘æ§è„šæœ¬ï¼Œæˆ–ä½¿ç”¨å¼€æºçš„ç›‘æ§ç»„ä»¶æ—¶ï¼Œä¹Ÿä¸èƒ½æ‰ä»¥è½»å¿ƒã€‚\nåœ¨å†™ç›‘æ§è„šæœ¬è®¿é—® Redis æ—¶ï¼Œå°½é‡é‡‡ç”¨é•¿è¿æ¥çš„æ–¹å¼é‡‡é›†çŠ¶æ€ä¿¡æ¯ï¼Œé¿å…é¢‘ç¹çŸ­è¿æ¥ã€‚åŒæ—¶ï¼Œä½ è¿˜è¦æ³¨æ„æ§åˆ¶è®¿é—® Redis çš„é¢‘ç‡ï¼Œé¿å…å½±å“åˆ°ä¸šåŠ¡è¯·æ±‚ã€‚\nåœ¨ä½¿ç”¨ä¸€äº›å¼€æºçš„ç›‘æ§ç»„ä»¶æ—¶ï¼Œæœ€å¥½äº†è§£ä¸€ä¸‹è¿™äº›ç»„ä»¶çš„å®ç°åŸç†ï¼Œä»¥åŠæ­£ç¡®é…ç½®è¿™äº›ç»„ä»¶ï¼Œé˜²æ­¢å‡ºç°ç›‘æ§ç»„ä»¶å‘ç”Ÿ Bugï¼Œå¯¼è‡´çŸ­æ—¶å¤§é‡æ“ä½œ Redisï¼Œå½±å“ Redis æ€§èƒ½çš„æƒ…å†µå‘ç”Ÿã€‚\næˆ‘ä»¬å½“æ—¶å°±å‘ç”Ÿè¿‡ï¼ŒDBA åœ¨ä½¿ç”¨ä¸€äº›å¼€æºç»„ä»¶æ—¶ï¼Œå› ä¸ºé…ç½®å’Œä½¿ç”¨é—®é¢˜ï¼Œå¯¼è‡´ç›‘æ§ç¨‹åºé¢‘ç¹åœ°ä¸ Redis å»ºç«‹å’Œæ–­å¼€è¿æ¥ï¼Œå¯¼è‡´ Redis å“åº”å˜æ…¢ã€‚\n\nå…¶å®ƒç¨‹åºäº‰æŠ¢èµ„æº\n\næœ€åéœ€è¦æé†’ä½ çš„æ˜¯ï¼Œä½ çš„ Redis æœºå™¨æœ€å¥½ä¸“é¡¹ä¸“ç”¨ï¼Œåªç”¨æ¥éƒ¨ç½² Redis å®ä¾‹ï¼Œä¸è¦éƒ¨ç½²å…¶ä»–åº”ç”¨ç¨‹åºï¼Œå°½é‡ç»™ Redis æä¾›ä¸€ä¸ªç›¸å¯¹ã€Œå®‰é™ã€çš„ç¯å¢ƒï¼Œé¿å…å…¶å®ƒç¨‹åºå ç”¨ CPUã€å†…å­˜ã€ç£ç›˜èµ„æºï¼Œå¯¼è‡´åˆ†é…ç»™ Redis çš„èµ„æºä¸è¶³è€Œå—åˆ°å½±å“ã€‚\n","categories":["è¿ç»´","Redis"]},{"title":"Redis æŒä¹…åŒ–","url":"/posts/15405/","content":"Redisæ”¯æŒä¸¤ç§æ–¹å¼çš„æŒä¹…åŒ–ï¼šRDBå¿«ç…§å’ŒAOFã€‚\nRDBæŒä¹…åŒ–RDBå¿«ç…§ç”¨å®˜æ–¹çš„è¯æ¥è¯´ï¼šRDBæŒä¹…åŒ–æ–¹æ¡ˆæ˜¯æŒ‰ç…§æŒ‡å®šæ—¶é—´é—´éš”å¯¹ä½ çš„æ•°æ®é›†ç”Ÿæˆçš„æ—¶é—´ç‚¹å¿«ç…§ï¼ˆpoint-to-time snapshotï¼‰ã€‚å®ƒä»¥ç´§ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¿å­˜Redisæ•°æ®åº“æŸä¸€æ—¶åˆ»æ‰€æœ‰æ•°æ®å¯¹è±¡çš„å†…å­˜å¿«ç…§ï¼Œå¯ç”¨äºRedisçš„æ•°æ®å¤‡ä»½ã€è½¬ç§»ä¸æ¢å¤ã€‚åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä»æ˜¯å®˜æ–¹çš„é»˜è®¤æ”¯æŒæ–¹æ¡ˆã€‚\nRDBå·¥ä½œåŸç†æ—¢ç„¶è¯´RDBæ˜¯Redisä¸­æ•°æ®é›†çš„æ—¶é—´ç‚¹å¿«ç…§ï¼Œé‚£æˆ‘ä»¬å…ˆç®€å•äº†è§£ä¸€ä¸‹Rediså†…çš„æ•°æ®å¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯å¦‚ä½•å­˜å‚¨ä¸ç»„ç»‡çš„ã€‚\né»˜è®¤æƒ…å†µä¸‹ï¼ŒRedisä¸­æœ‰16ä¸ªæ•°æ®åº“ï¼Œç¼–å·ä»0-15ï¼Œæ¯ä¸ªRedisæ•°æ®åº“ä½¿ç”¨ä¸€ä¸ªredisDbå¯¹è±¡æ¥è¡¨ç¤ºï¼ŒredisDbä½¿ç”¨hashtableå­˜å‚¨K-Vå¯¹è±¡ã€‚ä¸ºæ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¥å…¶ä¸­ä¸€ä¸ªdbä¸ºä¾‹ç»˜åˆ¶Rediså†…éƒ¨æ•°æ®çš„å­˜å‚¨ç»“æ„ç¤ºæ„å›¾ã€‚æ—¶é—´ç‚¹å¿«ç…§ä¹Ÿå°±æ˜¯æŸä¸€æ—¶åˆ»Rediså†…æ¯ä¸ªDBä¸­æ¯ä¸ªæ•°æ®å¯¹è±¡çš„çŠ¶æ€ï¼Œå…ˆå‡è®¾åœ¨è¿™ä¸€æ—¶åˆ»æ‰€æœ‰çš„æ•°æ®å¯¹è±¡ä¸å†æ”¹å˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŒ‰ç…§ä¸Šå›¾ä¸­çš„æ•°æ®ç»“æ„å…³ç³»ï¼ŒæŠŠè¿™äº›æ•°æ®å¯¹è±¡ä¾æ¬¡è¯»å–å‡ºæ¥å¹¶å†™å…¥åˆ°æ–‡ä»¶ä¸­ï¼Œä»¥æ­¤å®ç°Redisçš„æŒä¹…åŒ–ã€‚ç„¶åï¼Œå½“Redisé‡å¯æ—¶æŒ‰ç…§è§„åˆ™è¯»å–è¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œå†å†™å…¥åˆ°Rediså†…å­˜å³å¯æ¢å¤è‡³æŒä¹…åŒ–æ—¶çš„çŠ¶æ€ã€‚\nå½“ç„¶ï¼Œè¿™ä¸ªå‰ææ—¶æˆ‘ä»¬ä¸Šé¢çš„å‡è®¾æˆç«‹ï¼Œå¦åˆ™é¢å¯¹ä¸€ä¸ªæ—¶åˆ»å˜åŒ–çš„æ•°æ®é›†ï¼Œæˆ‘ä»¬æ— ä»ä¸‹æ‰‹ã€‚æˆ‘ä»¬çŸ¥é“Redisä¸­å®¢æˆ·ç«¯å‘½ä»¤å¤„ç†æ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼Œå¦‚æœæŠŠæŒä¹…åŒ–ä½œä¸ºä¸€ä¸ªå‘½ä»¤å¤„ç†ï¼Œé‚£æ•°æ®é›†è‚¯å®šæ—¶å¤„äºé™æ­¢çŠ¶æ€ã€‚å¦å¤–ï¼Œæ“ä½œç³»ç»Ÿæä¾›çš„fork()å‡½æ•°åˆ›å»ºçš„å­è¿›ç¨‹å¯è·å¾—ä¸çˆ¶è¿›ç¨‹ä¸€è‡´çš„å†…å­˜æ•°æ®ï¼Œç›¸å½“äºè·å–äº†å†…å­˜æ•°æ®å‰¯æœ¬ï¼›forkå®Œæˆåï¼Œçˆ¶è¿›ç¨‹è¯¥å¹²å˜›å¹²å˜›ï¼ŒæŒä¹…åŒ–çŠ¶æ€çš„å·¥ä½œäº¤ç»™å­è¿›ç¨‹å°±è¡Œäº†ã€‚\nå¾ˆæ˜¾ç„¶ï¼Œç¬¬ä¸€ç§æƒ…å†µä¸å¯å–ï¼ŒæŒä¹…åŒ–å¤‡ä»½ä¼šå¯¼è‡´çŸ­æ—¶é—´å†…RedisæœåŠ¡ä¸å¯ç”¨ï¼Œè¿™å¯¹äºé«˜HAçš„ç³»ç»Ÿæ¥è®²æ˜¯æ— æ³•å®¹å¿çš„ã€‚æ‰€ä»¥ï¼Œç¬¬äºŒç§æ–¹å¼æ˜¯RDBæŒä¹…åŒ–çš„ä¸»è¦å®è·µæ–¹å¼ã€‚ç”±äºforkå­è¿›ç¨‹åï¼Œçˆ¶è¿›ç¨‹æ•°æ®ä¸€ç›´åœ¨å˜åŒ–ï¼Œå­è¿›ç¨‹å¹¶ä¸ä¸çˆ¶è¿›ç¨‹åŒæ­¥ï¼ŒRDBæŒä¹…åŒ–å¿…ç„¶æ— æ³•ä¿è¯å®æ—¶æ€§ï¼›RDBæŒä¹…åŒ–å®Œæˆåå‘ç”Ÿæ–­ç”µæˆ–å®•æœºï¼Œä¼šå¯¼è‡´éƒ¨åˆ†æ•°æ®ä¸¢å¤±ï¼›å¤‡ä»½é¢‘ç‡å†³å®šäº†ä¸¢å¤±æ•°æ®é‡çš„å¤§å°ï¼Œæé«˜å¤‡ä»½é¢‘ç‡ï¼Œæ„å‘³ç€forkè¿‡ç¨‹æ¶ˆè€—è¾ƒå¤šçš„CPUèµ„æºï¼Œä¹Ÿä¼šå¯¼è‡´è¾ƒå¤§çš„ç£ç›˜I/Oã€‚\næŒä¹…åŒ–æµç¨‹åœ¨Rediså†…å®ŒæˆRDBæŒä¹…åŒ–çš„æ–¹æ³•æœ‰rdbSaveå’ŒrdbSaveBackgroundä¸¤ä¸ªå‡½æ•°æ–¹æ³•ï¼ˆæºç æ–‡ä»¶rdb.cä¸­ï¼‰ï¼Œå…ˆç®€å•è¯´ä¸‹ä¸¤è€…å·®åˆ«ï¼š\n\nrdbSaveï¼šæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œæ–¹æ³•è°ƒç”¨åå°±ä¼šç«‹åˆ»å¯åŠ¨æŒä¹…åŒ–æµç¨‹ã€‚ç”±äºRedisæ˜¯å•çº¿ç¨‹æ¨¡å‹ï¼ŒæŒä¹…åŒ–è¿‡ç¨‹ä¸­ä¼šé˜»å¡ï¼ŒRedisæ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼›\nrdbSaveBackgroundï¼šæ˜¯åå°ï¼ˆå¼‚æ­¥ï¼‰æ‰§è¡Œçš„ï¼Œè¯¥æ–¹æ³•ä¼šforkå‡ºå­è¿›ç¨‹ï¼ŒçœŸæ­£çš„æŒä¹…åŒ–è¿‡ç¨‹æ˜¯åœ¨å­è¿›ç¨‹ä¸­æ‰§è¡Œçš„ï¼ˆè°ƒç”¨rdbSaveï¼‰ï¼Œä¸»è¿›ç¨‹ä¼šç»§ç»­æä¾›æœåŠ¡ï¼›\n\nRDBæŒä¹…åŒ–çš„è§¦å‘å¿…ç„¶ç¦»ä¸å¼€ä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•ï¼Œè§¦å‘çš„æ–¹å¼åˆ†ä¸ºæ‰‹åŠ¨å’Œè‡ªåŠ¨ã€‚æ‰‹åŠ¨è§¦å‘å®¹æ˜“ç†è§£ï¼Œæ˜¯æŒ‡æˆ‘ä»¬é€šè¿‡Rediså®¢æˆ·ç«¯äººä¸ºçš„å¯¹RedisæœåŠ¡ç«¯å‘èµ·æŒä¹…åŒ–å¤‡ä»½æŒ‡ä»¤ï¼Œç„¶åRedisæœåŠ¡ç«¯å¼€å§‹æ‰§è¡ŒæŒä¹…åŒ–æµç¨‹ï¼Œè¿™é‡Œçš„æŒ‡ä»¤æœ‰saveå’Œbgsaveã€‚è‡ªåŠ¨è§¦å‘æ˜¯Redisæ ¹æ®è‡ªèº«è¿è¡Œè¦æ±‚ï¼Œåœ¨æ»¡è¶³é¢„è®¾æ¡ä»¶æ—¶è‡ªåŠ¨è§¦å‘çš„æŒä¹…åŒ–æµç¨‹ï¼Œè‡ªåŠ¨è§¦å‘çš„åœºæ™¯æœ‰å¦‚ä¸‹å‡ ä¸ªï¼ˆæ‘˜è‡ªè¿™ç¯‡æ–‡ç« ï¼‰ï¼š\n\nserverCronä¸­save m né…ç½®è§„åˆ™è‡ªåŠ¨è§¦å‘ï¼›\nä»èŠ‚ç‚¹å…¨é‡å¤åˆ¶æ—¶ï¼Œä¸»èŠ‚ç‚¹å‘é€rdbæ–‡ä»¶ç»™ä»èŠ‚ç‚¹å®Œæˆå¤åˆ¶æ“ä½œï¼Œä¸»èŠ‚ç‚¹ä¼šå‡ºå‘bgsaveï¼›\næ‰§è¡Œdebug reloadå‘½ä»¤é‡æ–°åŠ è½½redisæ—¶ï¼›\né»˜è®¤æƒ…å†µä¸‹ï¼ˆæœªå¼€å¯AOFï¼‰æ‰§è¡Œshutdownå‘½ä»¤æ—¶ï¼Œè‡ªåŠ¨æ‰§è¡Œbgsaveï¼›\n\nç»“åˆæºç åŠå‚è€ƒæ–‡ç« ï¼Œæˆ‘æ•´ç†äº†RDBæŒä¹…åŒ–æµç¨‹æ¥å¸®åŠ©å¤§å®¶æœ‰ä¸ªæ•´ä½“çš„äº†è§£ï¼Œç„¶åå†ä»ä¸€äº›ç»†èŠ‚è¿›è¡Œè¯´æ˜ã€‚ä»ä¸Šå›¾å¯ä»¥çŸ¥é“ï¼š\n\nè‡ªåŠ¨è§¦å‘çš„RDBæŒä¹…åŒ–æ˜¯é€šè¿‡rdbSaveBackgroundä»¥å­è¿›ç¨‹æ–¹å¼æ‰§è¡Œçš„æŒä¹…åŒ–ç­–ç•¥ï¼›\næ‰‹åŠ¨è§¦å‘æ˜¯ä»¥å®¢æˆ·ç«¯å‘½ä»¤æ–¹å¼è§¦å‘çš„ï¼ŒåŒ…å«saveå’Œbgsaveä¸¤ä¸ªå‘½ä»¤ï¼Œå…¶ä¸­saveå‘½ä»¤æ˜¯åœ¨Redisçš„å‘½ä»¤å¤„ç†çº¿ç¨‹ä»¥é˜»å¡çš„æ–¹å¼è°ƒç”¨rdbSaveæ–¹æ³•å®Œæˆçš„ã€‚\n\nè‡ªåŠ¨è§¦å‘æµç¨‹æ˜¯ä¸€ä¸ªå®Œæ•´çš„é“¾è·¯ï¼Œæ¶µç›–äº†rdbSaveBackgroundã€rdbSaveç­‰ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¥serverCronä¸ºä¾‹åˆ†æä¸€ä¸‹æ•´ä¸ªæµç¨‹ã€‚\nsaveè§„åˆ™åŠæ£€æŸ¥serverCronæ˜¯Rediså†…çš„ä¸€ä¸ªå‘¨æœŸæ€§å‡½æ•°ï¼Œæ¯éš”100æ¯«ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œå®ƒçš„å…¶ä¸­ä¸€é¡¹å·¥ä½œå°±æ˜¯ï¼šæ ¹æ®é…ç½®æ–‡ä»¶ä¸­saveè§„åˆ™æ¥åˆ¤æ–­å½“å‰éœ€è¦è¿›è¡Œè‡ªåŠ¨æŒä¹…åŒ–æµç¨‹ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶åˆ™å°è¯•å¼€å§‹æŒä¹…åŒ–ã€‚äº†è§£ä¸€ä¸‹è¿™éƒ¨åˆ†çš„å®ç°ã€‚\nåœ¨redisServerä¸­æœ‰å‡ ä¸ªä¸RDBæŒä¹…åŒ–æœ‰å…³çš„å­—æ®µï¼Œæˆ‘ä»ä»£ç ä¸­æ‘˜å‡ºæ¥ï¼Œä¸­è‹±æ–‡å¯¹ç…§ç€çœ‹ä¸‹ï¼š\nstruct redisServer &#123;    /* çœç•¥å…¶ä»–å­—æ®µ */     /* RDB persistence */    long long dirty;                /* Changes to DB from the last save                                     * ä¸Šæ¬¡æŒä¹…åŒ–åä¿®æ”¹keyçš„æ¬¡æ•° */    struct saveparam *saveparams;   /* Save points array for RDBï¼Œ                                     * å¯¹åº”é…ç½®æ–‡ä»¶å¤šä¸ªsaveå‚æ•° */    int saveparamslen;              /* Number of saving pointsï¼Œ                                     * saveå‚æ•°çš„æ•°é‡ */    time_t lastsave;                /* Unix time of last successful save                                      * ä¸Šæ¬¡æŒä¹…åŒ–æ—¶é—´*/    /* çœç•¥å…¶ä»–å­—æ®µ */&#125;/* å¯¹åº”redis.confä¸­çš„saveå‚æ•° */struct saveparam &#123;    time_t seconds;                    /* ç»Ÿè®¡æ—¶é—´èŒƒå›´ */       int changes;                    /* æ•°æ®ä¿®æ”¹æ¬¡æ•° */&#125;;\n\nsaveparamså¯¹åº”redis.confä¸‹çš„saveè§„åˆ™ï¼Œsaveå‚æ•°æ˜¯Redisè§¦å‘è‡ªåŠ¨å¤‡ä»½çš„è§¦å‘ç­–ç•¥ï¼Œsecondsä¸ºç»Ÿè®¡æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰ï¼Œ changesä¸ºåœ¨ç»Ÿè®¡æ—¶é—´å†…å‘ç”Ÿå†™å…¥çš„æ¬¡æ•°ã€‚save m nçš„æ„æ€æ˜¯ï¼šmç§’å†…æœ‰næ¡å†™å…¥å°±è§¦å‘ä¸€æ¬¡å¿«ç…§ï¼Œå³å¤‡ä»½ä¸€æ¬¡ã€‚saveå‚æ•°å¯ä»¥é…ç½®å¤šç»„ï¼Œæ»¡è¶³åœ¨ä¸åŒæ¡ä»¶çš„å¤‡ä»½è¦æ±‚ã€‚å¦‚æœéœ€è¦å…³é—­RDBçš„è‡ªåŠ¨å¤‡ä»½ç­–ç•¥ï¼Œå¯ä»¥ä½¿ç”¨save &quot;&quot;ã€‚ä»¥ä¸‹ä¸ºå‡ ç§é…ç½®çš„è¯´æ˜ï¼š\n# è¡¨ç¤º900ç§’ï¼ˆ15åˆ†é’Ÿï¼‰å†…è‡³å°‘æœ‰1ä¸ªkeyçš„å€¼å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œsave 900 1# è¡¨ç¤º300ç§’ï¼ˆ5åˆ†é’Ÿï¼‰å†…è‡³å°‘æœ‰1ä¸ªkeyçš„å€¼å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œsave 300 10# è¡¨ç¤º60ç§’ï¼ˆ1åˆ†é’Ÿï¼‰å†…è‡³å°‘æœ‰10000ä¸ªkeyçš„å€¼å‘ç”Ÿå˜åŒ–ï¼Œåˆ™æ‰§è¡Œsave 60 10000# è¯¥é…ç½®å°†ä¼šå…³é—­RDBæ–¹å¼çš„æŒä¹…åŒ–save &quot;&quot;\n\nserverCronå¯¹RDB saveè§„åˆ™çš„æ£€æµ‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š\nint serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) &#123;    /* çœç•¥å…¶ä»–é€»è¾‘ */        /* å¦‚æœç”¨æˆ·è¯·æ±‚è¿›è¡ŒAOFæ–‡ä»¶é‡å†™æ—¶ï¼ŒRedisæ­£åœ¨æ‰§è¡ŒRDBæŒä¹…åŒ–ï¼ŒRedisä¼šå®‰æ’åœ¨RDBæŒä¹…åŒ–å®Œæˆåæ‰§è¡ŒAOFæ–‡ä»¶é‡å†™ï¼Œ     * å¦‚æœaof_rewrite_scheduledä¸ºtrueï¼Œè¯´æ˜éœ€è¦æ‰§è¡Œç”¨æˆ·çš„è¯·æ±‚ */    /* Check if a background saving or AOF rewrite in progress terminated. */    if (hasActiveChildProcess() || ldbPendingChildren())    &#123;        run_with_period(1000) receiveChildInfo();        checkChildrenDone();    &#125; else &#123;        /* åå°æ—  saving/rewrite å­è¿›ç¨‹æ‰ä¼šè¿›è¡Œï¼Œé€ä¸ªæ£€æŸ¥æ¯ä¸ªsaveè§„åˆ™*/        for (j = 0; j &lt; server.saveparamslen; j++) &#123;            struct saveparam *sp = server.saveparams+j;                        /* æ£€æŸ¥è§„åˆ™æœ‰å‡ ä¸ªï¼šæ»¡è¶³ä¿®æ”¹æ¬¡æ•°ï¼Œæ»¡è¶³ç»Ÿè®¡å‘¨æœŸï¼Œè¾¾åˆ°é‡è¯•æ—¶é—´é—´éš”æˆ–è€…ä¸Šæ¬¡æŒä¹…åŒ–å®Œæˆ*/            if (server.dirty &gt;= sp-&gt;changes                 &amp;&amp; server.unixtime-server.lastsave &gt; sp-&gt;seconds                 &amp;&amp;(server.unixtime-server.lastbgsave_try &gt; CONFIG_BGSAVE_RETRY_DELAY || server.lastbgsave_status == C_OK))            &#123;                serverLog(LL_NOTICE,&quot;%d changes in %d seconds. Saving...&quot;, sp-&gt;changes, (int)sp-&gt;seconds);                rdbSaveInfo rsi, *rsiptr;                rsiptr = rdbPopulateSaveInfo(&amp;rsi);                /* æ‰§è¡Œbgsaveè¿‡ç¨‹ */                rdbSaveBackground(server.rdb_filename,rsiptr);                break;            &#125;        &#125;        /* çœç•¥ï¼šTrigger an AOF rewrite if needed. */    &#125;    /* çœç•¥å…¶ä»–é€»è¾‘ */&#125;\n\nå¦‚æœæ²¡æœ‰åå°çš„RDBæŒä¹…åŒ–æˆ–AOFé‡å†™è¿›ç¨‹ï¼ŒserverCronä¼šæ ¹æ®ä»¥ä¸Šé…ç½®åŠçŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦æ‰§è¡ŒæŒä¹…åŒ–æ“ä½œï¼Œåˆ¤æ–­ä¾æ®å°±æ˜¯çœ‹lastsaveã€dirtyæ˜¯å¦æ»¡è¶³saveparamsæ•°ç»„ä¸­çš„å…¶ä¸­ä¸€ä¸ªæ¡ä»¶ã€‚å¦‚æœæœ‰ä¸€ä¸ªæ¡ä»¶åŒ¹é…ï¼Œåˆ™è°ƒç”¨rdbSaveBackgroundæ–¹æ³•ï¼Œæ‰§è¡Œå¼‚æ­¥æŒä¹…åŒ–æµç¨‹ã€‚\nrdbSaveBackgroundrdbSaveBackgroundæ˜¯RDBæŒä¹…åŒ–çš„è¾…åŠ©æ€§æ–¹æ³•ï¼Œä¸»è¦å·¥ä½œæ˜¯forkå­è¿›ç¨‹ï¼Œç„¶åæ ¹æ®è°ƒç”¨æ–¹ï¼ˆçˆ¶è¿›ç¨‹æˆ–è€…å­è¿›ç¨‹ï¼‰ä¸åŒï¼Œæœ‰ä¸¤ç§ä¸åŒçš„æ‰§è¡Œé€»è¾‘ã€‚\n\nå¦‚æœè°ƒç”¨æ–¹æ˜¯çˆ¶è¿›ç¨‹ï¼Œåˆ™forkå‡ºå­è¿›ç¨‹ï¼Œä¿å­˜å­è¿›ç¨‹ä¿¡æ¯åç›´æ¥è¿”å›ã€‚\nå¦‚æœè°ƒç”¨æ–¹æ˜¯å­è¿›ç¨‹åˆ™è°ƒç”¨rdbSaveæ‰§è¡ŒRDBæŒä¹…åŒ–é€»è¾‘ï¼ŒæŒä¹…åŒ–å®Œæˆåé€€å‡ºå­è¿›ç¨‹ã€‚\n\nint rdbSaveBackground(char *filename, rdbSaveInfo *rsi) &#123;    pid_t childpid;    if (hasActiveChildProcess()) return C_ERR;    server.dirty_before_bgsave = server.dirty;    server.lastbgsave_try = time(NULL);    // forkå­è¿›ç¨‹    if ((childpid = redisFork(CHILD_TYPE_RDB)) == 0) &#123;        int retval;        /* Child å­è¿›ç¨‹ï¼šä¿®æ”¹è¿›ç¨‹æ ‡é¢˜ */        redisSetProcTitle(&quot;redis-rdb-bgsave&quot;);        redisSetCpuAffinity(server.bgsave_cpulist);        // æ‰§è¡ŒrdbæŒä¹…åŒ–        retval = rdbSave(filename,rsi);        if (retval == C_OK) &#123;            sendChildCOWInfo(CHILD_TYPE_RDB, 1, &quot;RDB&quot;);        &#125;        // æŒä¹…åŒ–å®Œæˆåï¼Œé€€å‡ºå­è¿›ç¨‹        exitFromChild((retval == C_OK) ? 0 : 1);    &#125; else &#123;        /* Parent çˆ¶è¿›ç¨‹ï¼šè®°å½•forkå­è¿›ç¨‹çš„æ—¶é—´ç­‰ä¿¡æ¯*/        if (childpid == -1) &#123;            server.lastbgsave_status = C_ERR;            serverLog(LL_WARNING,&quot;Can&#x27;t save in background: fork: %s&quot;,                strerror(errno));            return C_ERR;        &#125;        serverLog(LL_NOTICE,&quot;Background saving started by pid %ld&quot;,(long) childpid);        // è®°å½•å­è¿›ç¨‹å¼€å§‹çš„æ—¶é—´ã€ç±»å‹ç­‰ã€‚        server.rdb_save_time_start = time(NULL);        server.rdb_child_type = RDB_CHILD_TYPE_DISK;        return C_OK;    &#125;    return C_OK; /* unreached */&#125;\n\nrdbSaveæ˜¯çœŸæ­£æ‰§è¡ŒæŒä¹…åŒ–çš„æ–¹æ³•ï¼Œå®ƒåœ¨æ‰§è¡Œæ—¶å­˜åœ¨å¤§é‡çš„I/Oã€è®¡ç®—æ“ä½œï¼Œè€—æ—¶ã€CPUå ç”¨è¾ƒå¤§ï¼Œåœ¨Redisçš„å•çº¿ç¨‹æ¨¡å‹ä¸­æŒä¹…åŒ–è¿‡ç¨‹ä¼šæŒç»­å ç”¨çº¿ç¨‹èµ„æºï¼Œè¿›è€Œå¯¼è‡´Redisæ— æ³•æä¾›å…¶ä»–æœåŠ¡ã€‚ä¸ºäº†è§£å†³è¿™ä¸€é—®é¢˜Redisåœ¨rdbSaveBackgroundä¸­forkå‡ºå­è¿›ç¨‹ï¼Œç”±å­è¿›ç¨‹å®ŒæˆæŒä¹…åŒ–å·¥ä½œï¼Œé¿å…äº†å ç”¨çˆ¶è¿›ç¨‹è¿‡å¤šçš„èµ„æºã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœçˆ¶è¿›ç¨‹å†…å­˜å ç”¨è¿‡å¤§ï¼Œforkè¿‡ç¨‹ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­çˆ¶è¿›ç¨‹æ— æ³•å¯¹å¤–æä¾›æœåŠ¡ï¼›å¦å¤–ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘è®¡ç®—æœºå†…å­˜ä½¿ç”¨é‡ï¼Œforkå­è¿›ç¨‹åä¼šå ç”¨åŒå€çš„å†…å­˜èµ„æºï¼Œéœ€è¦ç¡®ä¿å†…å­˜å¤Ÿç”¨ã€‚é€šè¿‡info statså‘½ä»¤æŸ¥çœ‹latest_fork_usecé€‰é¡¹ï¼Œå¯ä»¥è·å–æœ€è¿‘ä¸€ä¸ªforkä»¥æ“ä½œçš„è€—æ—¶ã€‚\nrdbSaveRedisçš„rdbSaveå‡½æ•°æ˜¯çœŸæ­£è¿›è¡ŒRDBæŒä¹…åŒ–çš„å‡½æ•°ï¼Œæµç¨‹ã€ç»†èŠ‚è´¼å¤šï¼Œæ•´ä½“æµç¨‹å¯ä»¥æ€»ç»“ä¸ºï¼šåˆ›å»ºå¹¶æ‰“å¼€ä¸´æ—¶æ–‡ä»¶ã€Rediså†…å­˜æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶å†™å…¥ç£ç›˜ã€ä¸´æ—¶æ–‡ä»¶é‡å‘½åä¸ºæ­£å¼RDBæ–‡ä»¶ã€æ›´æ–°æŒä¹…åŒ–çŠ¶æ€ä¿¡æ¯ï¼ˆdirtyã€lastsaveï¼‰ã€‚å…¶ä¸­â€œRediså†…å­˜æ•°æ®å†™å…¥ä¸´æ—¶æ–‡ä»¶â€æœ€ä¸ºæ ¸å¿ƒå’Œå¤æ‚ï¼Œå†™å…¥è¿‡ç¨‹ç›´æ¥ä½“ç°äº†RDBæ–‡ä»¶çš„æ–‡ä»¶æ ¼å¼ï¼Œæœ¬ç€ä¸€å›¾èƒœåƒè¨€çš„ç†å¿µï¼Œæˆ‘æŒ‰ç…§æºç æµç¨‹ç»˜åˆ¶äº†ä¸‹å›¾ã€‚è¡¥å……è¯´æ˜ä¸€ä¸‹ï¼Œä¸Šå›¾å³ä¸‹è§’â€œéå†å½“å‰æ•°æ®åº“çš„é”®å€¼å¯¹å¹¶å†™å…¥â€è¿™ä¸ªç¯èŠ‚ä¼šæ ¹æ®ä¸åŒç±»å‹çš„Redisæ•°æ®ç±»å‹åŠåº•å±‚æ•°æ®ç»“æ„é‡‡ç”¨ä¸åŒçš„æ ¼å¼å†™å…¥åˆ°RDBæ–‡ä»¶ä¸­ï¼Œä¸å†å±•å¼€äº†ã€‚æˆ‘è§‰å¾—å¤§å®¶å¯¹æ•´ä¸ªè¿‡ç¨‹æœ‰ä¸ªç›´è§‚çš„ç†è§£å°±å¥½ï¼Œè¿™å¯¹äºæˆ‘ä»¬ç†è§£Rediså†…éƒ¨çš„è¿ä½œæœºåˆ¶å¤§æœ‰è£¨ç›Šã€‚\nAOFæŒä¹…åŒ–ä¸Šä¸€èŠ‚æˆ‘ä»¬çŸ¥é“RDBæ˜¯ä¸€ç§æ—¶é—´ç‚¹ï¼ˆpoint-to-timeï¼‰å¿«ç…§ï¼Œé€‚åˆæ•°æ®å¤‡ä»½åŠç¾éš¾æ¢å¤ï¼Œç”±äºå·¥ä½œåŸç†çš„â€œå…ˆå¤©æ€§ç¼ºé™·â€æ— æ³•ä¿è¯å®æ—¶æ€§æŒä¹…åŒ–ï¼Œè¿™å¯¹äºç¼“å­˜ä¸¢å¤±é›¶å®¹å¿çš„ç³»ç»Ÿæ¥è¯´æ˜¯ä¸ªç¡¬ä¼¤ï¼Œäºæ˜¯å°±æœ‰äº†AOFã€‚\nAOFå·¥ä½œåŸç†AOFæ˜¯Append Only Fileçš„ç¼©å†™ï¼Œå®ƒæ˜¯Redisçš„å®Œå…¨æŒä¹…åŒ–ç­–ç•¥ï¼Œä»1.1ç‰ˆæœ¬å¼€å§‹æ”¯æŒï¼›è¿™é‡Œçš„fileå­˜å‚¨çš„æ˜¯å¼•èµ·Redisæ•°æ®ä¿®æ”¹çš„å‘½ä»¤é›†åˆï¼ˆæ¯”å¦‚ï¼šset/hset/delç­‰ï¼‰ï¼Œè¿™äº›é›†åˆæŒ‰ç…§Redis Serverçš„å¤„ç†é¡ºåºè¿½åŠ åˆ°æ–‡ä»¶ä¸­ã€‚å½“é‡å¯Redisæ—¶ï¼ŒRediså°±å¯ä»¥ä»å¤´è¯»å–AOFä¸­çš„æŒ‡ä»¤å¹¶é‡æ”¾ï¼Œè¿›è€Œæ¢å¤å…³é—­å‰çš„æ•°æ®çŠ¶æ€ã€‚\nAOFæŒä¹…åŒ–é»˜è®¤æ˜¯å…³é—­çš„ï¼Œä¿®æ”¹redis.confä»¥ä¸‹ä¿¡æ¯å¹¶é‡å¯ï¼Œå³å¯å¼€å¯AOFæŒä¹…åŒ–åŠŸèƒ½ã€‚\n# no-å…³é—­ï¼Œyes-å¼€å¯ï¼Œé»˜è®¤noappendonly yesappendfilename appendonly.aof\n\nAOFæœ¬è´¨æ˜¯ä¸ºäº†æŒä¹…åŒ–ï¼ŒæŒä¹…åŒ–å¯¹è±¡æ˜¯Rediså†…æ¯ä¸€ä¸ªkeyçš„çŠ¶æ€ï¼ŒæŒä¹…åŒ–çš„ç›®çš„æ˜¯ä¸ºäº†åœ¨Reidså‘ç”Ÿæ•…éšœé‡å¯åèƒ½å¤Ÿæ¢å¤è‡³é‡å¯å‰æˆ–æ•…éšœå‰çš„çŠ¶æ€ã€‚ç›¸æ¯”äºRDBï¼ŒAOFé‡‡å–çš„ç­–ç•¥æ˜¯æŒ‰ç…§æ‰§è¡Œé¡ºåºæŒä¹…åŒ–æ¯ä¸€æ¡èƒ½å¤Ÿå¼•èµ·Redisä¸­å¯¹è±¡çŠ¶æ€å˜æ›´çš„å‘½ä»¤ï¼Œå‘½ä»¤æ˜¯æœ‰åºçš„ã€æœ‰é€‰æ‹©çš„ã€‚æŠŠaofæ–‡ä»¶è½¬ç§»è‡³ä»»ä½•ä¸€å°Redis Serverï¼Œä»å¤´åˆ°å°¾æŒ‰åºé‡æ”¾è¿™äº›å‘½ä»¤å³å¯æ¢å¤å¦‚åˆã€‚ä¸¾ä¸ªä¾‹å­ï¼š\né¦–å…ˆæ‰§è¡ŒæŒ‡ä»¤set number 0ï¼Œç„¶åéšæœºè°ƒç”¨incr numberã€get number å„5æ¬¡ï¼Œæœ€åå†æ‰§è¡Œä¸€æ¬¡get number ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç»“æœè‚¯å®šæ˜¯5ã€‚\nå› ä¸ºåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œèƒ½å¤Ÿå¼•èµ·numberçŠ¶æ€å˜æ›´çš„åªæœ‰set/incrç±»å‹çš„æŒ‡ä»¤ï¼Œå¹¶ä¸”å®ƒä»¬æ‰§è¡Œçš„å…ˆåé¡ºåºæ˜¯å·²çŸ¥çš„ï¼Œæ— è®ºæ‰§è¡Œå¤šå°‘æ¬¡getéƒ½ä¸ä¼šå½±å“numberçš„çŠ¶æ€ã€‚æ‰€ä»¥ï¼Œä¿ç•™æ‰€æœ‰set/incrå‘½ä»¤å¹¶æŒä¹…åŒ–è‡³aofæ–‡ä»¶å³å¯ã€‚æŒ‰ç…§aofçš„è®¾è®¡åŸç†ï¼Œaofæ–‡ä»¶ä¸­çš„å†…å®¹åº”è¯¥æ˜¯è¿™æ ·çš„ï¼ˆè¿™é‡Œæ˜¯å‡è®¾ï¼Œå®é™…ä¸ºRESPåè®®ï¼‰ï¼š\nset number 0incr numberincr numberincr numberincr numberincr number\n\næœ€æœ¬è´¨çš„åŸç†ç”¨â€œå‘½ä»¤é‡æ”¾â€å››ä¸ªå­—å°±å¯ä»¥æ¦‚æ‹¬ã€‚ä½†æ˜¯ï¼Œè€ƒè™‘å®é™…ç”Ÿäº§ç¯å¢ƒçš„å¤æ‚æ€§åŠæ“ä½œç³»ç»Ÿç­‰æ–¹é¢çš„é™åˆ¶ï¼ŒRedisæ‰€è¦è€ƒè™‘çš„å·¥ä½œè¦æ¯”è¿™ä¸ªä¾‹å­å¤æ‚çš„å¤šï¼š\n\nRedis Serverå¯åŠ¨åï¼Œaofæ–‡ä»¶ä¸€ç›´åœ¨è¿½åŠ å‘½ä»¤ï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ã€‚æ–‡ä»¶è¶Šå¤§ï¼ŒRedisé‡å¯åæ¢å¤è€—æ—¶è¶Šä¹…ï¼›æ–‡ä»¶å¤ªå¤§ï¼Œè½¬ç§»å·¥ä½œå°±è¶Šéš¾ï¼›ä¸åŠ ç®¡ç†ï¼Œå¯èƒ½æ’‘çˆ†ç¡¬ç›˜ã€‚å¾ˆæ˜¾ç„¶ï¼Œéœ€è¦åœ¨åˆé€‚çš„æ—¶æœºå¯¹æ–‡ä»¶è¿›è¡Œç²¾ç®€ã€‚ä¾‹å­ä¸­çš„5æ¡incræŒ‡ä»¤å¾ˆæ˜æ˜¾çš„å¯ä»¥æ›¿æ¢ä¸ºä¸ºä¸€æ¡setå‘½ä»¤ï¼Œå­˜åœ¨å¾ˆå¤§çš„å‹ç¼©ç©ºé—´ã€‚\nä¼—æ‰€å‘¨çŸ¥ï¼Œæ–‡ä»¶I/Oæ˜¯æ“ä½œç³»ç»Ÿæ€§èƒ½çš„çŸ­æ¿ï¼Œä¸ºäº†æé«˜æ•ˆç‡ï¼Œæ–‡ä»¶ç³»ç»Ÿè®¾è®¡äº†ä¸€å¥—å¤æ‚çš„ç¼“å­˜æœºåˆ¶ï¼ŒRedisæ“ä½œå‘½ä»¤çš„è¿½åŠ æ“ä½œåªæ˜¯æŠŠæ•°æ®å†™å…¥äº†ç¼“å†²åŒºï¼ˆaof_bufï¼‰ï¼Œä»ç¼“å†²åŒºåˆ°å†™å…¥ç‰©ç†æ–‡ä»¶åœ¨æ€§èƒ½ä¸å®‰å…¨ä¹‹é—´æƒè¡¡ä¼šæœ‰ä¸åŒçš„é€‰æ‹©ã€‚\næ–‡ä»¶å‹ç¼©å³æ„å‘³ç€é‡å†™ï¼Œé‡å†™æ—¶å³å¯ä¾æ®å·²æœ‰çš„aofæ–‡ä»¶åšå‘½ä»¤æ•´åˆï¼Œä¹Ÿå¯ä»¥å…ˆæ ¹æ®å½“å‰Rediså†…æ•°æ®çš„çŠ¶æ€åšå¿«ç…§ï¼Œå†æŠŠå­˜å‚¨å¿«ç…§è¿‡ç¨‹ä¸­çš„æ–°å¢çš„å‘½ä»¤åšè¿½åŠ ã€‚\naofå¤‡ä»½åçš„æ–‡ä»¶æ˜¯ä¸ºäº†æ¢å¤æ•°æ®ï¼Œç»“åˆaofæ–‡ä»¶çš„æ ¼å¼ã€å®Œæ•´æ€§ç­‰å› ç´ ï¼ŒRedisä¹Ÿè¦è®¾è®¡ä¸€å¥—å®Œæ•´çš„æ–¹æ¡ˆåšæ”¯æŒã€‚\n\næŒä¹…åŒ–æµç¨‹ä»æµç¨‹ä¸Šæ¥çœ‹ï¼ŒAOFçš„å·¥ä½œåŸç†å¯ä»¥æ¦‚æ‹¬ä¸ºå‡ ä¸ªæ­¥éª¤ï¼šå‘½ä»¤è¿½åŠ ï¼ˆappendï¼‰ã€æ–‡ä»¶å†™å…¥ä¸åŒæ­¥ï¼ˆfsyncï¼‰ã€æ–‡ä»¶é‡å†™ï¼ˆrewriteï¼‰ã€é‡å¯åŠ è½½ï¼ˆloadï¼‰ï¼Œæ¥ä¸‹æ¥ä¾æ¬¡äº†è§£æ¯ä¸ªæ­¥éª¤çš„ç»†èŠ‚åŠèƒŒåçš„è®¾è®¡å“²å­¦ã€‚\nå‘½ä»¤è¿½åŠ å½“ AOF æŒä¹…åŒ–åŠŸèƒ½å¤„äºæ‰“å¼€çŠ¶æ€æ—¶ï¼ŒRedis åœ¨æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œä¼šä»¥åè®®æ ¼å¼(ä¹Ÿå°±æ˜¯RESPï¼Œå³ Redis å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº¤äº’çš„é€šä¿¡åè®® )æŠŠè¢«æ‰§è¡Œçš„å†™å‘½ä»¤è¿½åŠ åˆ° Redis æœåŠ¡ç«¯ç»´æŠ¤çš„ AOF ç¼“å†²åŒºæœ«å°¾ã€‚å¯¹AOFæ–‡ä»¶åªæœ‰å•çº¿ç¨‹çš„è¿½åŠ æ“ä½œï¼Œæ²¡æœ‰seekç­‰å¤æ‚çš„æ“ä½œï¼Œå³ä½¿æ–­ç”µæˆ–å®•æœºä¹Ÿä¸å­˜åœ¨æ–‡ä»¶æŸåé£é™©ã€‚å¦å¤–ï¼Œä½¿ç”¨æ–‡æœ¬åè®®å¥½å¤„å¤šå¤šï¼š\n\næ–‡æœ¬åè®®æœ‰å¾ˆå¥½çš„å…¼å®¹æ€§ï¼›\næ–‡æœ¬åè®®å°±æ˜¯å®¢æˆ·ç«¯çš„è¯·æ±‚å‘½ä»¤ï¼Œä¸éœ€è¦äºŒæ¬¡å¤„ç†ï¼ŒèŠ‚çœäº†å­˜å‚¨åŠåŠ è½½æ—¶çš„å¤„ç†å¼€é”€ï¼›\næ–‡æœ¬åè®®å…·æœ‰å¯è¯»æ€§ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€ä¿®æ”¹ç­‰å¤„ç†ã€‚\n\nAOFç¼“å†²åŒºç±»å‹ä¸ºRedisè‡ªä¸»è®¾è®¡çš„æ•°æ®ç»“æ„sdsï¼ŒRedisä¼šæ ¹æ®å‘½ä»¤çš„ç±»å‹é‡‡ç”¨ä¸åŒçš„æ–¹æ³•ï¼ˆcatAppendOnlyGenericCommandã€catAppendOnlyExpireAtCommandç­‰ï¼‰å¯¹å‘½ä»¤å†…å®¹è¿›è¡Œå¤„ç†ï¼Œæœ€åå†™å…¥ç¼“å†²åŒºã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¦‚æœå‘½ä»¤è¿½åŠ æ—¶æ­£åœ¨è¿›è¡ŒAOFé‡å†™ï¼Œè¿™äº›å‘½ä»¤è¿˜ä¼šè¿½åŠ åˆ°é‡å†™ç¼“å†²åŒºï¼ˆaof_rewrite_bufferï¼‰ã€‚\næ–‡ä»¶å†™å…¥ä¸åŒæ­¥AOFæ–‡ä»¶çš„å†™å…¥ä¸åŒæ­¥ç¦»ä¸å¼€æ“ä½œç³»ç»Ÿçš„æ”¯æŒï¼Œå¼€å§‹ä»‹ç»ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦è¡¥å……ä¸€ä¸‹Linux I/Oç¼“å†²åŒºç›¸å…³çŸ¥è¯†ã€‚ç¡¬ç›˜I/Oæ€§èƒ½è¾ƒå·®ï¼Œæ–‡ä»¶è¯»å†™é€Ÿåº¦è¿œè¿œæ¯”ä¸ä¸ŠCPUçš„å¤„ç†é€Ÿåº¦ï¼Œå¦‚æœæ¯æ¬¡æ–‡ä»¶å†™å…¥éƒ½ç­‰å¾…æ•°æ®å†™å…¥ç¡¬ç›˜ï¼Œä¼šæ•´ä½“æ‹‰ä½æ“ä½œç³»ç»Ÿçš„æ€§èƒ½ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ“ä½œç³»ç»Ÿæä¾›äº†å»¶è¿Ÿå†™ï¼ˆdelayed writeï¼‰æœºåˆ¶æ¥æé«˜ç¡¬ç›˜çš„I/Oæ€§èƒ½ã€‚\n\nä¼ ç»Ÿçš„UNIXå®ç°åœ¨å†…æ ¸ä¸­è®¾æœ‰ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜æˆ–é¡µé¢é«˜é€Ÿç¼“å­˜ï¼Œå¤§å¤šæ•°ç£ç›˜I/Oéƒ½é€šè¿‡ç¼“å†²è¿›è¡Œã€‚ å½“å°†æ•°æ®å†™å…¥æ–‡ä»¶æ—¶ï¼Œå†…æ ¸é€šå¸¸å…ˆå°†è¯¥æ•°æ®å¤åˆ¶åˆ°å…¶ä¸­ä¸€ä¸ªç¼“å†²åŒºä¸­ï¼Œå¦‚æœè¯¥ç¼“å†²åŒºå°šæœªå†™æ»¡ï¼Œåˆ™å¹¶ä¸å°†å…¶æ’å…¥è¾“å‡ºé˜Ÿåˆ—ï¼Œè€Œæ˜¯ç­‰å¾…å…¶å†™æ»¡æˆ–è€…å½“å†…æ ¸éœ€è¦é‡ç”¨è¯¥ç¼“å†²åŒºä»¥ä¾¿å­˜æ”¾å…¶ä»–ç£ç›˜å—æ•°æ®æ—¶ï¼Œ å†å°†è¯¥ç¼“å†²æ’å…¥åˆ°è¾“å‡ºé˜Ÿåˆ—ï¼Œç„¶åå¾…å…¶åˆ°è¾¾é˜Ÿé¦–æ—¶ï¼Œæ‰è¿›è¡Œå®é™…çš„I/Oæ“ä½œã€‚è¿™ç§è¾“å‡ºæ–¹å¼å°±è¢«ç§°ä¸ºå»¶è¿Ÿå†™ã€‚\n\nå»¶è¿Ÿå†™å‡å°‘äº†ç£ç›˜è¯»å†™æ¬¡æ•°ï¼Œä½†æ˜¯å´é™ä½äº†æ–‡ä»¶å†…å®¹çš„æ›´æ–°é€Ÿåº¦ï¼Œä½¿å¾—æ¬²å†™åˆ°æ–‡ä»¶ä¸­çš„æ•°æ®åœ¨ä¸€æ®µæ—¶é—´å†…å¹¶æ²¡æœ‰å†™åˆ°ç£ç›˜ä¸Šã€‚å½“ç³»ç»Ÿå‘ç”Ÿæ•…éšœæ—¶ï¼Œè¿™ç§å»¶è¿Ÿå¯èƒ½é€ æˆæ–‡ä»¶æ›´æ–°å†…å®¹çš„ä¸¢å¤±ã€‚ä¸ºäº†ä¿è¯ç£ç›˜ä¸Šå®é™…æ–‡ä»¶ç³»ç»Ÿä¸ç¼“å†²åŒºé«˜é€Ÿç¼“å­˜ä¸­å†…å®¹çš„ä¸€è‡´æ€§ï¼ŒUNIXç³»ç»Ÿæä¾›äº†syncã€fsyncå’Œfdatasyncä¸‰ä¸ªå‡½æ•°ä¸ºå¼ºåˆ¶å†™å…¥ç¡¬ç›˜æä¾›æ”¯æŒã€‚\nRedisæ¯æ¬¡äº‹ä»¶è½®è®­ç»“æŸå‰ï¼ˆbeforeSleepï¼‰éƒ½ä¼šè°ƒç”¨å‡½æ•°flushAppendOnlyFileï¼ŒflushAppendOnlyFileä¼šæŠŠAOFç¼“å†²åŒºï¼ˆaof_bufï¼‰ä¸­çš„æ•°æ®å†™å…¥å†…æ ¸ç¼“å†²åŒºï¼Œå¹¶ä¸”æ ¹æ®appendfsyncé…ç½®æ¥å†³å®šé‡‡ç”¨ä½•ç§ç­–ç•¥æŠŠå†…æ ¸ç¼“å†²åŒºä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ï¼Œå³è°ƒç”¨fsync()ã€‚è¯¥é…ç½®æœ‰ä¸‰ä¸ªå¯é€‰é¡¹alwaysã€noã€everysecï¼Œå…·ä½“è¯´æ˜å¦‚ä¸‹ï¼š\n\nalwaysï¼šæ¯å¤„ç†ä¸€ä¸ªå‘½ä»¤éƒ½å°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥å¹¶åŒæ­¥åˆ°AOF æ–‡ä»¶ï¼Œå³æ¯ä¸ªå‘½ä»¤éƒ½è°ƒç”¨fsync()ï¼Œæ˜¯å®‰å…¨æ€§æœ€é«˜ã€æ€§èƒ½æœ€å·®çš„ä¸€ç§ç­–ç•¥ã€‚\nnoï¼šå°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œ ä½†å¹¶ä¸å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œ ä½•æ—¶åŒæ­¥ç”±æ“ä½œç³»ç»Ÿæ¥å†³å®šã€‚å³ä¸æ‰§è¡Œåˆ·ç›˜ï¼Œè®©æ“ä½œç³»ç»Ÿè‡ªå·±æ‰§è¡Œåˆ·ç›˜ã€‚æ€§èƒ½æœ€å¥½ï¼Œå®‰å…¨æ€§æœ€å·®ã€‚\neverysecï¼šå°† aof_buf ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹å†™å…¥åˆ° AOF æ–‡ä»¶ï¼Œå¦‚æœä¸Šæ¬¡åŒæ­¥ AOF æ–‡ä»¶çš„æ—¶é—´è·ç¦»ç°åœ¨è¶…è¿‡ä¸€ç§’é’Ÿï¼Œ é‚£ä¹ˆå†æ¬¡å¯¹ AOF æ–‡ä»¶è¿›è¡ŒåŒæ­¥ï¼Œ å¹¶ä¸”è¿™ä¸ªåŒæ­¥æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œç”±ä¸€ä¸ªåå°çº¿ç¨‹ä¸“é—¨è´Ÿè´£æ‰§è¡Œï¼Œå³æ¯ç§’åˆ·ç›˜1æ¬¡ã€‚è¿™æ˜¯å®˜æ–¹å»ºè®®çš„åŒæ­¥ç­–ç•¥ï¼Œä¹Ÿæ˜¯é»˜è®¤é…ç½®ï¼Œåšåˆ°å…¼é¡¾æ€§èƒ½å’Œæ•°æ®å®‰å…¨æ€§ï¼Œç†è®ºä¸Šåªæœ‰åœ¨ç³»ç»Ÿçªç„¶å®•æœºçš„æƒ…å†µä¸‹ä¸¢å¤±1ç§’çš„æ•°æ®ã€‚\n\næ³¨æ„ï¼šä¸Šé¢ä»‹ç»çš„ç­–ç•¥å—é…ç½®é¡¹no-appendfsync-on-rewriteçš„å½±å“ï¼Œå®ƒçš„ä½œç”¨æ˜¯å‘ŠçŸ¥Redisï¼šAOFæ–‡ä»¶é‡å†™æœŸé—´æ˜¯å¦ç¦æ­¢è°ƒç”¨fsync()ï¼Œé»˜è®¤æ˜¯noã€‚\nå¦‚æœappendfsyncè®¾ç½®ä¸ºalwaysæˆ–everysecï¼Œåå°æ­£åœ¨è¿›è¡Œçš„BGSAVEæˆ–è€…BGREWRITEAOFæ¶ˆè€—è¿‡å¤šçš„ç£ç›˜I/Oï¼Œåœ¨æŸäº›Linuxç³»ç»Ÿé…ç½®ä¸‹ï¼ŒRediså¯¹fsync()çš„è°ƒç”¨å¯èƒ½é˜»å¡å¾ˆé•¿æ—¶é—´ã€‚ç„¶è€Œè¿™ä¸ªé—®é¢˜è¿˜æ²¡æœ‰ä¿®å¤ï¼Œå› ä¸ºå³ä½¿æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­æ‰§è¡Œfsync()ï¼ŒåŒæ­¥å†™å…¥æ“ä½œä¹Ÿä¼šè¢«é˜»å¡ã€‚\nä¸ºäº†ç¼“è§£æ­¤é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨è¯¥é€‰é¡¹ï¼Œä»¥é˜²æ­¢åœ¨è¿›è¡ŒBGSAVEæˆ–BGREWRITEAOFæ—¶åœ¨ä¸»è¿›ç¨‹ä¸­è°ƒç”¨fsync(ï¼‰ã€‚\n\nè®¾ç½®ä¸ºyesæ„å‘³ç€ï¼Œå¦‚æœå­è¿›ç¨‹æ­£åœ¨è¿›è¡ŒBGSAVEæˆ–BGREWRITEAOFï¼ŒAOFçš„æŒä¹…åŒ–èƒ½åŠ›å°±ä¸appendfsyncè®¾ç½®ä¸ºnoæœ‰ç€ç›¸åŒçš„æ•ˆæœã€‚æœ€ç³Ÿç³•çš„æƒ…å†µä¸‹ï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´30ç§’çš„ç¼“å­˜æ•°æ®ä¸¢å¤±ã€‚\nå¦‚æœä½ çš„ç³»ç»Ÿæœ‰ä¸Šé¢æè¿°çš„å»¶è¿Ÿé—®é¢˜ï¼Œå°±æŠŠè¿™ä¸ªé€‰é¡¹è®¾ç½®ä¸ºyesï¼Œå¦åˆ™ä¿æŒä¸ºnoã€‚\n\næ–‡ä»¶é‡å†™å¦‚å‰é¢æåˆ°çš„ï¼ŒRedisé•¿æ—¶é—´è¿è¡Œï¼Œå‘½ä»¤ä¸æ–­å†™å…¥AOFï¼Œæ–‡ä»¶ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸åŠ æ§åˆ¶å¯èƒ½å½±å“å®¿ä¸»æœºçš„å®‰å…¨ã€‚\nä¸ºäº†è§£å†³AOFæ–‡ä»¶ä½“ç§¯é—®é¢˜ï¼ŒRediså¼•å…¥äº†AOFæ–‡ä»¶é‡å†™åŠŸèƒ½ï¼Œå®ƒä¼šæ ¹æ®Rediså†…æ•°æ®å¯¹è±¡çš„æœ€æ–°çŠ¶æ€ç”Ÿæˆæ–°çš„AOFæ–‡ä»¶ï¼Œæ–°æ—§æ–‡ä»¶å¯¹åº”çš„æ•°æ®çŠ¶æ€ä¸€è‡´ï¼Œä½†æ˜¯æ–°æ–‡ä»¶ä¼šå…·æœ‰è¾ƒå°çš„ä½“ç§¯ã€‚é‡å†™æ—¢å‡å°‘äº†AOFæ–‡ä»¶å¯¹ç£ç›˜ç©ºé—´çš„å ç”¨ï¼Œåˆå¯ä»¥æé«˜Redisé‡å¯æ—¶æ•°æ®æ¢å¤çš„é€Ÿåº¦ã€‚è¿˜æ˜¯ä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œæ—§æ–‡ä»¶ä¸­çš„6æ¡å‘½ä»¤ç­‰åŒäºæ–°æ–‡ä»¶ä¸­çš„1æ¡å‘½ä»¤ï¼Œå‹ç¼©æ•ˆæœæ˜¾è€Œæ˜“è§ã€‚æˆ‘ä»¬è¯´ï¼ŒAOFæ–‡ä»¶å¤ªå¤§æ—¶ä¼šè§¦å‘AOFæ–‡ä»¶é‡å†™ï¼Œé‚£åˆ°åº•æ˜¯å¤šå¤§å‘¢ï¼Ÿæœ‰å“ªäº›æƒ…å†µä¼šè§¦å‘é‡å†™æ“ä½œå‘¢ï¼Ÿ\nä¸RDBæ–¹å¼ä¸€æ ·ï¼ŒAOFæ–‡ä»¶é‡å†™æ—¢å¯ä»¥æ‰‹åŠ¨è§¦å‘ï¼Œä¹Ÿä¼šè‡ªåŠ¨è§¦å‘ã€‚æ‰‹åŠ¨è§¦å‘ç›´æ¥è°ƒç”¨bgrewriteaofå‘½ä»¤ï¼Œå¦‚æœå½“æ—¶æ— å­è¿›ç¨‹æ‰§è¡Œä¼šç«‹åˆ»æ‰§è¡Œï¼Œå¦åˆ™å®‰æ’åœ¨å­è¿›ç¨‹ç»“æŸåæ‰§è¡Œã€‚è‡ªåŠ¨è§¦å‘ç”±Redisçš„å‘¨æœŸæ€§æ–¹æ³•serverCronæ£€æŸ¥åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶æ—¶è§¦å‘ã€‚å…ˆäº†è§£ä¸¤ä¸ªé…ç½®é¡¹ï¼š\n\nauto-aof-rewrite-percentageï¼šä»£è¡¨å½“å‰AOFæ–‡ä»¶å¤§å°ï¼ˆaof_current_sizeï¼‰å’Œä¸Šä¸€æ¬¡é‡å†™åAOFæ–‡ä»¶å¤§å°ï¼ˆaof_base_sizeï¼‰ç›¸æ¯”ï¼Œå¢é•¿çš„æ¯”ä¾‹ã€‚\nauto-aof-rewrite-min-sizeï¼šè¡¨ç¤ºè¿è¡ŒBGREWRITEAOFæ—¶AOFæ–‡ä»¶å ç”¨ç©ºé—´æœ€å°å€¼ï¼Œé»˜è®¤ä¸º64MBï¼›\n\nRediså¯åŠ¨æ—¶æŠŠaof_base_sizeåˆå§‹åŒ–ä¸ºå½“æ—¶aofæ–‡ä»¶çš„å¤§å°ï¼ŒRedisè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“AOFæ–‡ä»¶é‡å†™æ“ä½œå®Œæˆæ—¶ï¼Œä¼šå¯¹å…¶è¿›è¡Œæ›´æ–°ï¼›aof_current_sizeä¸ºserverCronæ‰§è¡Œæ—¶AOFæ–‡ä»¶çš„å®æ—¶å¤§å°ã€‚å½“æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼ŒAOFæ–‡ä»¶é‡å†™å°±ä¼šè§¦å‘ï¼š\nå¢é•¿æ¯”ä¾‹ï¼š(aof_current_size - aof_base_size) / aof_base_size &gt; auto-aof-rewrite-percentageæ–‡ä»¶å¤§å°ï¼šaof_current_size &gt; auto-aof-rewrite-min-size\n\næ‰‹åŠ¨è§¦å‘ä¸è‡ªåŠ¨è§¦å‘çš„ä»£ç å¦‚ä¸‹ï¼ŒåŒæ ·åœ¨å‘¨æœŸæ€§æ–¹æ³•serverCronä¸­ï¼š\nint serverCron(struct aeEventLoop *eventLoop, long long id, void *clientData) &#123;    /* çœç•¥å…¶ä»–é€»è¾‘ */        /* å¦‚æœç”¨æˆ·è¯·æ±‚è¿›è¡ŒAOFæ–‡ä»¶é‡å†™æ—¶ï¼ŒRedisæ­£åœ¨æ‰§è¡ŒRDBæŒä¹…åŒ–ï¼ŒRedisä¼šå®‰æ’åœ¨RDBæŒä¹…åŒ–å®Œæˆåæ‰§è¡ŒAOFæ–‡ä»¶é‡å†™ï¼Œ     * å¦‚æœaof_rewrite_scheduledä¸ºtrueï¼Œè¯´æ˜éœ€è¦æ‰§è¡Œç”¨æˆ·çš„è¯·æ±‚ */    if (!hasActiveChildProcess() &amp;&amp;        server.aof_rewrite_scheduled)    &#123;        rewriteAppendOnlyFileBackground();    &#125;    /* Check if a background saving or AOF rewrite in progress terminated. */    if (hasActiveChildProcess() || ldbPendingChildren())    &#123;        run_with_period(1000) receiveChildInfo();        checkChildrenDone();    &#125; else &#123;        /* çœç•¥rdbæŒä¹…åŒ–æ¡ä»¶æ£€æŸ¥ */        /* AOFé‡å†™æ¡ä»¶æ£€æŸ¥ï¼šaofå¼€å¯ã€æ— å­è¿›ç¨‹è¿è¡Œã€å¢é•¿ç™¾åˆ†æ¯”å·²è®¾ç½®ã€å½“å‰æ–‡ä»¶å¤§å°è¶…è¿‡é˜ˆå€¼ */        if (server.aof_state == AOF_ON &amp;&amp;            !hasActiveChildProcess() &amp;&amp;            server.aof_rewrite_perc &amp;&amp;            server.aof_current_size &gt; server.aof_rewrite_min_size)        &#123;            long long base = server.aof_rewrite_base_size ?                server.aof_rewrite_base_size : 1;            /* è®¡ç®—å¢é•¿ç™¾åˆ†æ¯” */            long long growth = (server.aof_current_size*100/base) - 100;            if (growth &gt;= server.aof_rewrite_perc) &#123;                serverLog(LL_NOTICE,&quot;Starting automatic rewriting of AOF on %lld%% growth&quot;,growth);                rewriteAppendOnlyFileBackground();            &#125;        &#125;    &#125;    /**/&#125;\n\nAOFæ–‡ä»¶é‡å†™çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿå¬è¯´Redisæ”¯æŒæ··åˆæŒä¹…åŒ–ï¼Œå¯¹AOFæ–‡ä»¶é‡å†™æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ\nä»4.0ç‰ˆæœ¬å¼€å§‹ï¼ŒRedisåœ¨AOFæ¨¡å¼ä¸­å¼•å…¥äº†æ··åˆæŒä¹…åŒ–æ–¹æ¡ˆï¼Œå³ï¼šçº¯AOFæ–¹å¼ã€RDB+AOFæ–¹å¼ï¼Œè¿™ä¸€ç­–ç•¥ç”±é…ç½®å‚æ•°aof-use-rdb-preambleï¼ˆä½¿ç”¨RDBä½œä¸ºAOFæ–‡ä»¶çš„å‰åŠæ®µï¼‰æ§åˆ¶ï¼Œé»˜è®¤å…³é—­(no)ï¼Œè®¾ç½®ä¸ºyeså¯å¼€å¯ã€‚æ‰€ä»¥ï¼Œåœ¨AOFé‡å†™è¿‡ç¨‹ä¸­æ–‡ä»¶çš„å†™å…¥ä¼šæœ‰ä¸¤ç§ä¸åŒçš„æ–¹å¼ã€‚å½“aof-use-rdb-preambleçš„å€¼æ˜¯ï¼š\n\nnoï¼šæŒ‰ç…§AOFæ ¼å¼å†™å…¥å‘½ä»¤ï¼Œä¸4.0å‰ç‰ˆæœ¬æ— å·®åˆ«ï¼›\nyesï¼šå…ˆæŒ‰ç…§RDBæ ¼å¼å†™å…¥æ•°æ®çŠ¶æ€ï¼Œç„¶åæŠŠé‡å†™æœŸé—´AOFç¼“å†²åŒºçš„å†…å®¹ä»¥AOFæ ¼å¼å†™å…¥ï¼Œæ–‡ä»¶å‰åŠéƒ¨åˆ†ä¸ºRDBæ ¼å¼ï¼ŒååŠéƒ¨åˆ†ä¸ºAOFæ ¼å¼ã€‚\n\nç»“åˆæºç ï¼ˆ6.0ç‰ˆæœ¬ï¼Œæºç å¤ªå¤šè¿™é‡Œä¸è´´å‡ºï¼Œå¯å‚è€ƒaof.cï¼‰åŠå‚è€ƒèµ„æ–™ï¼Œç»˜åˆ¶AOFé‡å†™ï¼ˆBGREWRITEAOFï¼‰æµç¨‹å›¾ï¼šç»“åˆä¸Šå›¾ï¼Œæ€»ç»“ä¸€ä¸‹AOFæ–‡ä»¶é‡å†™çš„æµç¨‹ï¼š\n\nrewriteAppendOnlyFileBackgroundå¼€å§‹æ‰§è¡Œï¼Œæ£€æŸ¥æ˜¯å¦æœ‰æ­£åœ¨è¿›è¡Œçš„AOFé‡å†™æˆ–RDBæŒä¹…åŒ–å­è¿›ç¨‹ï¼šå¦‚æœæœ‰ï¼Œåˆ™é€€å‡ºè¯¥æµç¨‹ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™ç»§ç»­åˆ›å»ºæ¥ä¸‹æ¥çˆ¶å­è¿›ç¨‹é—´æ•°æ®ä¼ è¾“çš„é€šä¿¡ç®¡é“ã€‚æ‰§è¡Œfork()æ“ä½œï¼ŒæˆåŠŸåçˆ¶å­è¿›ç¨‹åˆ†åˆ«æ‰§è¡Œä¸åŒçš„æµç¨‹ã€‚\nçˆ¶è¿›ç¨‹ï¼š\nè®°å½•å­è¿›ç¨‹ä¿¡æ¯ï¼ˆpidï¼‰ã€æ—¶é—´æˆ³ç­‰ï¼›\nç»§ç»­å“åº”å…¶ä»–å®¢æˆ·ç«¯è¯·æ±‚ï¼›\næ”¶é›†AOFé‡å†™æœŸé—´çš„å‘½ä»¤ï¼Œè¿½åŠ è‡³aof_rewrite_bufferï¼›\nç­‰å¾…å¹¶å‘å­è¿›ç¨‹åŒæ­¥aof_rewrite_bufferçš„å†…å®¹ï¼›\n\n\nå­è¿›ç¨‹ï¼š\nä¿®æ”¹å½“å‰è¿›ç¨‹åç§°ï¼Œåˆ›å»ºé‡å†™æ‰€éœ€çš„ä¸´æ—¶æ–‡ä»¶ï¼Œè°ƒç”¨rewriteAppendOnlyFileå‡½æ•°ï¼›\næ ¹æ®aof-use-rdb-preambleé…ç½®ï¼Œä»¥RDBæˆ–AOFæ–¹å¼å†™å…¥å‰åŠéƒ¨åˆ†ï¼Œå¹¶åŒæ­¥è‡³ç¡¬ç›˜ï¼›\nä»çˆ¶è¿›ç¨‹æ¥æ”¶å¢é‡AOFå‘½ä»¤ï¼Œä»¥AOFæ–¹å¼å†™å…¥ååŠéƒ¨åˆ†ï¼Œå¹¶åŒæ­¥è‡³ç¡¬ç›˜ï¼›\né‡å‘½åAOFæ–‡ä»¶ï¼Œå­è¿›ç¨‹é€€å‡ºã€‚\n\n\n\næ•°æ®åŠ è½½Rediså¯åŠ¨åé€šè¿‡loadDataFromDiskå‡½æ•°æ‰§è¡Œæ•°æ®åŠ è½½å·¥ä½œã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œè™½ç„¶æŒä¹…åŒ–æ–¹å¼å¯ä»¥é€‰æ‹©AOFã€RDBæˆ–è€…ä¸¤è€…å…¼ç”¨ï¼Œä½†æ˜¯æ•°æ®åŠ è½½æ—¶å¿…é¡»åšå‡ºé€‰æ‹©ï¼Œä¸¤ç§æ–¹å¼å„è‡ªåŠ è½½ä¸€éå°±ä¹±å¥—äº†ã€‚\nç†è®ºä¸Šï¼ŒAOFæŒä¹…åŒ–æ¯”RDBå…·æœ‰æ›´å¥½çš„å®æ—¶æ€§ï¼Œå½“å¼€å¯äº†AOFæŒä¹…åŒ–æ–¹å¼ï¼ŒRedisåœ¨æ•°æ®åŠ è½½æ—¶ä¼˜å…ˆè€ƒè™‘AOFæ–¹å¼ã€‚è€Œä¸”ï¼ŒRedis 4.0ç‰ˆæœ¬åAOFæ”¯æŒäº†æ··åˆæŒä¹…åŒ–ï¼ŒåŠ è½½AOFæ–‡ä»¶éœ€è¦è€ƒè™‘ç‰ˆæœ¬å…¼å®¹æ€§ã€‚Redisæ•°æ®åŠ è½½æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šåœ¨AOFæ–¹å¼ä¸‹ï¼Œå¼€å¯æ··åˆæŒä¹…åŒ–æœºåˆ¶ç”Ÿæˆçš„æ–‡ä»¶æ˜¯â€œRDBå¤´+AOFå°¾â€ï¼Œæœªå¼€å¯æ—¶ç”Ÿæˆçš„æ–‡ä»¶å…¨éƒ¨ä¸ºAOFæ ¼å¼ã€‚è€ƒè™‘ä¸¤ç§æ–‡ä»¶æ ¼å¼çš„å…¼å®¹æ€§ï¼Œå¦‚æœRediså‘ç°AOFæ–‡ä»¶ä¸ºRDBå¤´ï¼Œä¼šä½¿ç”¨RDBæ•°æ®åŠ è½½çš„æ–¹æ³•è¯»å–å¹¶æ¢å¤å‰åŠéƒ¨åˆ†ï¼›ç„¶åå†ä½¿ç”¨AOFæ–¹å¼è¯»å–å¹¶æ¢å¤ååŠéƒ¨åˆ†ã€‚ç”±äºAOFæ ¼å¼å­˜å‚¨çš„æ•°æ®ä¸ºRESPåè®®å‘½ä»¤ï¼ŒRedisé‡‡ç”¨ä¼ªå®¢æˆ·ç«¯æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥æ¢å¤æ•°æ®ã€‚\nå¦‚æœåœ¨AOFå‘½ä»¤è¿½åŠ è¿‡ç¨‹ä¸­å‘ç”Ÿå®•æœºï¼Œç”±äºå»¶è¿Ÿå†™çš„æŠ€æœ¯ç‰¹ç‚¹ï¼ŒAOFçš„RESPå‘½ä»¤å¯èƒ½ä¸å®Œæ•´ï¼ˆè¢«æˆªæ–­ï¼‰ã€‚é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼ŒRedisä¼šæŒ‰ç…§é…ç½®é¡¹aof-load-truncatedæ‰§è¡Œä¸åŒçš„å¤„ç†ç­–ç•¥ã€‚è¿™ä¸ªé…ç½®æ˜¯å‘Šè¯‰Rediså¯åŠ¨æ—¶è¯»å–aofæ–‡ä»¶ï¼Œå¦‚æœå‘ç°æ–‡ä»¶è¢«æˆªæ–­ï¼ˆä¸å®Œæ•´ï¼‰æ—¶è¯¥å¦‚ä½•å¤„ç†ï¼š\n\nyesï¼šåˆ™å°½å¯èƒ½å¤šçš„åŠ è½½æ•°æ®ï¼Œå¹¶ä»¥æ—¥å¿—çš„æ–¹å¼é€šçŸ¥ç”¨æˆ·ï¼›\nnoï¼šåˆ™ä»¥ç³»ç»Ÿé”™è¯¯çš„æ–¹å¼å´©æºƒï¼Œå¹¶ç¦æ­¢å¯åŠ¨ï¼Œéœ€è¦ç”¨æˆ·ä¿®å¤æ–‡ä»¶åå†é‡å¯ã€‚\n\næ€»ç»“Redisæä¾›äº†ä¸¤ç§æŒä¹…åŒ–çš„é€‰æ‹©ï¼šRDBæ”¯æŒä»¥ç‰¹å®šçš„å®è·µé—´éš”ä¸ºæ•°æ®é›†ç”Ÿæˆæ—¶é—´ç‚¹å¿«ç…§ï¼›AOFæŠŠRedis Serveræ”¶åˆ°çš„æ¯æ¡å†™æŒ‡ä»¤æŒä¹…åŒ–åˆ°æ—¥å¿—ä¸­ï¼Œå¾…Redisé‡å¯æ—¶é€šè¿‡é‡æ”¾å‘½ä»¤æ¢å¤æ•°æ®ã€‚æ—¥å¿—æ ¼å¼ä¸ºRESPåè®®ï¼Œå¯¹æ—¥å¿—æ–‡ä»¶åªåšappendæ“ä½œï¼Œæ— æŸåé£é™©ã€‚å¹¶ä¸”å½“AOFæ–‡ä»¶è¿‡å¤§æ—¶å¯ä»¥è‡ªåŠ¨é‡å†™å‹ç¼©æ–‡ä»¶ã€‚\nå½“ç„¶ï¼Œå¦‚æœä½ ä¸éœ€è¦å¯¹æ•°æ®è¿›è¡ŒæŒä¹…åŒ–ï¼Œä¹Ÿå¯ä»¥ç¦ç”¨Redisçš„æŒä¹…åŒ–åŠŸèƒ½ï¼Œä½†æ˜¯å¤§å¤šæ•°æƒ…å†µå¹¶éå¦‚æ­¤ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬æ—¶æœ‰å¯èƒ½åŒæ—¶ä½¿ç”¨RDBå’ŒAOFä¸¤ç§æ–¹å¼çš„ï¼Œæœ€é‡è¦çš„å°±æ˜¯æˆ‘ä»¬è¦ç†è§£ä¸¤è€…çš„åŒºåˆ«ï¼Œä»¥ä¾¿åˆç†ä½¿ç”¨ã€‚\nRDB vs AOFRDBä¼˜ç‚¹\nRDBæ˜¯ä¸€ä¸ªç´§å‡‘å‹ç¼©çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»£è¡¨Redisåœ¨æŸä¸€ä¸ªæ—¶é—´ç‚¹ä¸Šçš„æ•°æ®å¿«ç…§ï¼Œéå¸¸é€‚åˆç”¨äºå¤‡ä»½ã€å…¨é‡å¤åˆ¶ç­‰åœºæ™¯ã€‚\nRDBå¯¹ç¾éš¾æ¢å¤ã€æ•°æ®è¿ç§»éå¸¸å‹å¥½ï¼ŒRDBæ–‡ä»¶å¯ä»¥è½¬ç§»è‡³ä»»ä½•éœ€è¦çš„åœ°æ–¹å¹¶é‡æ–°åŠ è½½ã€‚\nRDBæ˜¯Redisæ•°æ®çš„å†…å­˜å¿«ç…§ï¼Œæ•°æ®æ¢å¤é€Ÿåº¦è¾ƒå¿«ï¼Œç›¸æ¯”äºAOFçš„å‘½ä»¤é‡æ”¾æœ‰ç€æ›´é«˜çš„æ€§èƒ½ã€‚\n\nRDBç¼ºç‚¹\nRDBæ–¹å¼æ— æ³•åšåˆ°å®æ—¶æˆ–ç§’çº§æŒä¹…åŒ–ã€‚å› ä¸ºæŒä¹…åŒ–è¿‡ç¨‹æ˜¯é€šè¿‡forkå­è¿›ç¨‹åç”±å­è¿›ç¨‹å®Œæˆçš„ï¼Œå­è¿›ç¨‹çš„å†…å­˜åªæ˜¯åœ¨forkæ“ä½œé‚£ä¸€æ—¶åˆ»çˆ¶è¿›ç¨‹çš„æ•°æ®å¿«ç…§ï¼Œè€Œforkæ“ä½œåçˆ¶è¿›ç¨‹æŒç»­å¯¹å¤–æœåŠ¡ï¼Œå†…éƒ¨æ•°æ®æ—¶åˆ»å˜æ›´ï¼Œå­è¿›ç¨‹çš„æ•°æ®ä¸å†æ›´æ–°ï¼Œä¸¤è€…å§‹ç»ˆå­˜åœ¨å·®å¼‚ï¼Œæ‰€ä»¥æ— æ³•åšåˆ°å®æ—¶æ€§ã€‚\nRDBæŒä¹…åŒ–è¿‡ç¨‹ä¸­çš„forkæ“ä½œï¼Œä¼šå¯¼è‡´å†…å­˜å ç”¨åŠ å€ï¼Œè€Œä¸”çˆ¶è¿›ç¨‹æ•°æ®è¶Šå¤šï¼Œforkè¿‡ç¨‹è¶Šé•¿ã€‚\nRedisè¯·æ±‚é«˜å¹¶å‘å¯èƒ½ä¼šé¢‘ç¹å‘½ä¸­saveè§„åˆ™ï¼Œå¯¼è‡´forkæ“ä½œåŠæŒä¹…åŒ–å¤‡ä»½çš„é¢‘ç‡ä¸å¯æ§ï¼›\nRDBæ–‡ä»¶æœ‰æ–‡ä»¶æ ¼å¼è¦æ±‚ï¼Œä¸åŒç‰ˆæœ¬çš„Redisä¼šå¯¹æ–‡ä»¶æ ¼å¼è¿›è¡Œè°ƒæ•´ï¼Œå­˜åœ¨è€ç‰ˆæœ¬æ— æ³•å…¼å®¹æ–°ç‰ˆæœ¬çš„é—®é¢˜ã€‚\n\nAOFä¼˜ç‚¹\nAOFæŒä¹…åŒ–æœ‰æ›´å¥½çš„å®æ—¶æ€§ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸‰ç§ä¸åŒçš„æ–¹å¼ï¼ˆappendfsyncï¼‰ï¼šnoã€every secondã€alwaysï¼Œevery secondä½œä¸ºé»˜è®¤çš„ç­–ç•¥å…·æœ‰æœ€å¥½çš„æ€§èƒ½ï¼Œæç«¯æƒ…å†µä¸‹å¯èƒ½ä¼šä¸¢å¤±ä¸€ç§’çš„æ•°æ®ã€‚\nAOFæ–‡ä»¶åªæœ‰appendæ“ä½œï¼Œæ— å¤æ‚çš„seekç­‰æ–‡ä»¶æ“ä½œï¼Œæ²¡æœ‰æŸåé£é™©ã€‚å³ä½¿æœ€åå†™å…¥æ•°æ®è¢«æˆªæ–­ï¼Œä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨redis-check-aofå·¥å…·ä¿®å¤ï¼›\nå½“AOFæ–‡ä»¶å˜å¤§æ—¶ï¼ŒRediså¯åœ¨åå°è‡ªåŠ¨é‡å†™ã€‚é‡å†™è¿‡ç¨‹ä¸­æ—§æ–‡ä»¶ä¼šæŒç»­å†™å…¥ï¼Œé‡å†™å®Œæˆåæ–°æ–‡ä»¶å°†å˜å¾—æ›´å°ï¼Œå¹¶ä¸”é‡å†™è¿‡ç¨‹ä¸­çš„å¢é‡å‘½ä»¤ä¹Ÿä¼šappendåˆ°æ–°æ–‡ä»¶ã€‚\nAOFæ–‡ä»¶ä»¥å·²äºç†è§£ä¸è§£æçš„æ–¹å¼åŒ…å«äº†å¯¹Redisä¸­æ•°æ®çš„æ‰€æœ‰æ“ä½œå‘½ä»¤ã€‚å³ä½¿ä¸å°å¿ƒé”™è¯¯çš„æ¸…é™¤äº†æ‰€æœ‰æ•°æ®ï¼Œåªè¦æ²¡æœ‰å¯¹AOFæ–‡ä»¶é‡å†™ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ç§»é™¤æœ€åä¸€æ¡å‘½ä»¤æ‰¾å›æ‰€æœ‰æ•°æ®ã€‚\nAOFå·²ç»æ”¯æŒæ··åˆæŒä¹…åŒ–ï¼Œæ–‡ä»¶å¤§å°å¯ä»¥æœ‰æ•ˆæ§åˆ¶ï¼Œå¹¶æé«˜äº†æ•°æ®åŠ è½½æ—¶çš„æ•ˆç‡ã€‚\n\nAOFç¼ºç‚¹\nå¯¹äºç›¸åŒçš„æ•°æ®é›†åˆï¼ŒAOFæ–‡ä»¶é€šå¸¸ä¼šæ¯”RDBæ–‡ä»¶å¤§ï¼›\nåœ¨ç‰¹å®šçš„fsyncç­–ç•¥ä¸‹ï¼ŒAOFä¼šæ¯”RDBç•¥æ…¢ã€‚ä¸€èˆ¬æ¥è®²ï¼Œfsync_every_secondçš„æ€§èƒ½ä»ç„¶å¾ˆé«˜ï¼Œfsync_noçš„æ€§èƒ½ä¸RDBç›¸å½“ã€‚ä½†æ˜¯åœ¨å·¨å¤§çš„å†™å‹åŠ›ä¸‹ï¼ŒRDBæ›´èƒ½æä¾›æœ€å¤§çš„ä½å»¶æ—¶ä¿éšœã€‚\nåœ¨AOFä¸Šï¼ŒRedisæ›¾ç»é‡åˆ°ä¸€äº›å‡ ä¹ä¸å¯èƒ½åœ¨RDBä¸Šé‡åˆ°çš„ç½•è§bugã€‚ä¸€äº›ç‰¹æ®Šçš„æŒ‡ä»¤ï¼ˆå¦‚BRPOPLPUSHï¼‰å¯¼è‡´é‡æ–°åŠ è½½çš„æ•°æ®ä¸æŒä¹…åŒ–ä¹‹å‰ä¸ä¸€è‡´ï¼ŒRediså®˜æ–¹æ›¾ç»åœ¨ç›¸åŒçš„æ¡ä»¶ä¸‹è¿›è¡Œæµ‹è¯•ï¼Œä½†æ˜¯æ— æ³•å¤ç°é—®é¢˜ã€‚\n\nä½¿ç”¨å»ºè®®å¯¹RDBå’ŒAOFä¸¤ç§æŒä¹…åŒ–æ–¹å¼çš„å·¥ä½œåŸç†ã€æ‰§è¡Œæµç¨‹åŠä¼˜ç¼ºç‚¹äº†è§£åï¼Œæˆ‘ä»¬æ¥æ€è€ƒä¸‹ï¼Œå®é™…åœºæ™¯ä¸­åº”è¯¥æ€ä¹ˆæƒè¡¡åˆ©å¼Šï¼Œåˆç†çš„ä½¿ç”¨ä¸¤ç§æŒä¹…åŒ–æ–¹å¼ã€‚å¦‚æœä»…ä»…æ˜¯ä½¿ç”¨Redisä½œä¸ºç¼“å­˜å·¥å…·ï¼Œæ‰€æœ‰æ•°æ®å¯ä»¥æ ¹æ®æŒä¹…åŒ–æ•°æ®åº“è¿›è¡Œé‡å»ºï¼Œåˆ™å¯å…³é—­æŒä¹…åŒ–åŠŸèƒ½ï¼Œåšå¥½é¢„çƒ­ã€ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©ä¹‹ç±»çš„é˜²æŠ¤å·¥ä½œå³å¯ã€‚\nä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒRedisä¼šæ‰¿æ‹…æ›´å¤šçš„å·¥ä½œï¼Œå¦‚åˆ†å¸ƒå¼é”ã€æ’è¡Œæ¦œã€æ³¨å†Œä¸­å¿ƒç­‰ï¼ŒæŒä¹…åŒ–åŠŸèƒ½åœ¨ç¾éš¾æ¢å¤ã€æ•°æ®è¿ç§»æ–¹é¢å°†å‘æŒ¥è¾ƒå¤§çš„ä½œç”¨ã€‚å»ºè®®éµå¾ªå‡ ä¸ªåŸåˆ™ï¼š\n\nä¸è¦æŠŠRedisä½œä¸ºæ•°æ®åº“ï¼Œæ‰€æœ‰æ•°æ®å°½å¯èƒ½å¯ç”±åº”ç”¨æœåŠ¡è‡ªåŠ¨é‡å»ºã€‚\nä½¿ç”¨4.0ä»¥ä¸Šç‰ˆæœ¬Redisï¼Œä½¿ç”¨AOF+RDBæ··åˆæŒä¹…åŒ–åŠŸèƒ½ã€‚\nåˆç†è§„åˆ’Redisæœ€å¤§å ç”¨å†…å­˜ï¼Œé˜²æ­¢AOFé‡å†™æˆ–saveè¿‡ç¨‹ä¸­èµ„æºä¸è¶³ã€‚\né¿å…å•æœºéƒ¨ç½²å¤šå®ä¾‹ã€‚\nç”Ÿäº§ç¯å¢ƒå¤šä¸ºé›†ç¾¤åŒ–éƒ¨ç½²ï¼Œå¯åœ¨slaveå¼€å¯æŒä¹…åŒ–èƒ½åŠ›ï¼Œè®©masteræ›´å¥½çš„å¯¹å¤–æä¾›å†™æœåŠ¡ã€‚\nå¤‡ä»½æ–‡ä»¶åº”è‡ªåŠ¨ä¸Šä¼ è‡³å¼‚åœ°æœºæˆ¿æˆ–äº‘å­˜å‚¨ï¼Œåšå¥½ç¾éš¾å¤‡ä»½ã€‚\n\nå…³äºfork()é€šè¿‡ä¸Šé¢çš„åˆ†æï¼Œæˆ‘ä»¬éƒ½çŸ¥é“RDBçš„å¿«ç…§ã€AOFçš„é‡å†™éƒ½éœ€è¦forkï¼Œè¿™æ˜¯ä¸€ä¸ªé‡é‡çº§æ“ä½œï¼Œä¼šå¯¹Redisé€ æˆé˜»å¡ã€‚å› æ­¤ä¸ºäº†ä¸å½±å“Redisä¸»è¿›ç¨‹å“åº”ï¼Œæˆ‘ä»¬éœ€è¦å°½å¯èƒ½é™ä½é˜»å¡ã€‚\n\né™ä½forkçš„é¢‘ç‡ï¼Œæ¯”å¦‚å¯ä»¥æ‰‹åŠ¨æ¥è§¦å‘RDBç”Ÿæˆå¿«ç…§ã€ä¸AOFé‡å†™ï¼›\næ§åˆ¶Redisæœ€å¤§ä½¿ç”¨å†…å­˜ï¼Œé˜²æ­¢forkè€—æ—¶è¿‡é•¿ï¼›\nä½¿ç”¨æ›´é«˜æ€§èƒ½çš„ç¡¬ä»¶ï¼›\nåˆç†é…ç½®Linuxçš„å†…å­˜åˆ†é…ç­–ç•¥ï¼Œé¿å…å› ä¸ºç‰©ç†å†…å­˜ä¸è¶³å¯¼è‡´forkå¤±è´¥ã€‚\n\n","categories":["è¿ç»´","Redis"]},{"title":"Redis è·³è¡¨","url":"/posts/44045/","content":"ç†è§£è·³è¡¨ï¼Œä»å•é“¾è¡¨å¼€å§‹è¯´èµ·ä¸‹å›¾æ˜¯ä¸€ä¸ªç®€å•çš„æœ‰åºå•é“¾è¡¨ï¼Œå•é“¾è¡¨çš„ç‰¹æ€§å°±æ˜¯æ¯ä¸ªå…ƒç´ å­˜æ”¾ä¸‹ä¸€ä¸ªå…ƒç´ çš„å¼•ç”¨ã€‚å³ï¼šé€šè¿‡ç¬¬ä¸€ä¸ªå…ƒç´ å¯ä»¥æ‰¾åˆ°ç¬¬äºŒä¸ªå…ƒç´ ï¼Œé€šè¿‡ç¬¬äºŒä¸ªå…ƒç´ å¯ä»¥æ‰¾åˆ°ç¬¬ä¸‰ä¸ªå…ƒç´ ï¼Œä¾æ¬¡ç±»æ¨ï¼Œç›´åˆ°æ‰¾åˆ°æœ€åä¸€ä¸ªå…ƒç´ ã€‚\n\nç°åœ¨æˆ‘ä»¬æœ‰ä¸ªåœºæ™¯ï¼Œæƒ³å¿«é€Ÿæ‰¾åˆ°ä¸Šå›¾é“¾è¡¨ä¸­çš„ 10 è¿™ä¸ªå…ƒç´ ï¼Œåªèƒ½ä»å¤´å¼€å§‹éå†é“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°æˆ‘ä»¬éœ€è¦æ‰¾çš„å…ƒç´ ã€‚æŸ¥æ‰¾è·¯å¾„ï¼š1ã€3ã€4ã€5ã€7ã€8ã€9ã€10ã€‚è¿™æ ·çš„æŸ¥æ‰¾æ•ˆç‡å¾ˆä½ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦å¾ˆé«˜O(n)ã€‚é‚£æœ‰æ²¡æœ‰åŠæ³•æé«˜é“¾è¡¨çš„æŸ¥æ‰¾é€Ÿåº¦å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬ä»é“¾è¡¨ä¸­æ¯ä¸¤ä¸ªå…ƒç´ æŠ½å‡ºæ¥ï¼ŒåŠ ä¸€çº§ç´¢å¼•ï¼Œä¸€çº§ç´¢å¼•æŒ‡å‘äº†åŸå§‹é“¾è¡¨ï¼Œå³ï¼šé€šè¿‡ä¸€çº§ç´¢å¼• 7 çš„downæŒ‡é’ˆå¯ä»¥æ‰¾åˆ°åŸå§‹é“¾è¡¨çš„ 7 ã€‚é‚£ç°åœ¨æ€ä¹ˆæŸ¥æ‰¾ 10 è¿™ä¸ªå…ƒç´ å‘¢ï¼Ÿ\n\nå…ˆåœ¨ç´¢å¼•æ‰¾ 1ã€4ã€7ã€9ï¼Œéå†åˆ°ä¸€çº§ç´¢å¼•çš„ 9 æ—¶ï¼Œå‘ç° 9 çš„åç»§èŠ‚ç‚¹æ˜¯ 13ï¼Œæ¯” 10 å¤§ï¼Œäºæ˜¯ä¸å¾€åæ‰¾äº†ï¼Œè€Œæ˜¯é€šè¿‡ 9 æ‰¾åˆ°åŸå§‹é“¾è¡¨çš„ 9ï¼Œç„¶åå†å¾€åéå†æ‰¾åˆ°äº†æˆ‘ä»¬è¦æ‰¾çš„ 10ï¼Œéå†ç»“æŸã€‚\næœ‰æ²¡æœ‰å‘ç°ï¼ŒåŠ äº†ä¸€çº§ç´¢å¼•åï¼ŒæŸ¥æ‰¾è·¯å¾„ï¼š1ã€4ã€7ã€9ã€10ï¼ŒæŸ¥æ‰¾èŠ‚ç‚¹éœ€è¦éå†çš„å…ƒç´ ç›¸å¯¹å°‘äº†ï¼Œæˆ‘ä»¬ä¸éœ€è¦å¯¹ 10 ä¹‹å‰çš„æ‰€æœ‰æ•°æ®éƒ½éå†ï¼ŒæŸ¥æ‰¾çš„æ•ˆç‡æå‡äº†ã€‚\né‚£å¦‚æœåŠ äºŒçº§ç´¢å¼•å‘¢ï¼Ÿå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒæŸ¥æ‰¾è·¯å¾„ï¼š1ã€7ã€9ã€10ã€‚æ˜¯ä¸æ˜¯æ‰¾ 10 çš„æ•ˆç‡æ›´é«˜äº†ï¼Ÿè¿™å°±æ˜¯è·³è¡¨çš„æ€æƒ³ï¼Œç”¨â€œç©ºé—´æ¢æ—¶é—´â€ï¼Œé€šè¿‡ç»™é“¾è¡¨å»ºç«‹ç´¢å¼•ï¼Œæé«˜äº†æŸ¥æ‰¾çš„æ•ˆç‡ã€‚\n\nå¯èƒ½åŒå­¦ä»¬ä¼šæƒ³ï¼Œä»ä¸Šé¢æ¡ˆä¾‹æ¥çœ‹ï¼Œæå‡çš„æ•ˆç‡å¹¶ä¸æ˜æ˜¾ï¼Œæœ¬æ¥éœ€è¦éå†8ä¸ªå…ƒç´ ï¼Œä¼˜åŒ–äº†åŠå¤©ï¼Œè¿˜éœ€è¦éå† 4 ä¸ªå…ƒç´ ï¼Œå…¶å®æ˜¯å› ä¸ºæˆ‘ä»¬çš„æ•°æ®é‡å¤ªå°‘äº†ï¼Œå½“æ•°æ®é‡è¶³å¤Ÿå¤§æ—¶ï¼Œæ•ˆç‡æå‡ä¼šå¾ˆå¤§ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡å¦‚æœ‰åºå•é“¾è¡¨ç°åœ¨æœ‰1ä¸‡ä¸ªå…ƒç´ ï¼Œåˆ†åˆ«æ˜¯ 0~9999ã€‚ç°åœ¨æˆ‘ä»¬å»ºäº†å¾ˆå¤šçº§ç´¢å¼•ï¼Œæœ€é«˜çº§çš„ç´¢å¼•ï¼Œå°±ä¸¤ä¸ªå…ƒç´  0ã€5000ï¼Œæ¬¡é«˜çº§ç´¢å¼•å››ä¸ªå…ƒç´  0ã€2500ã€5000ã€7500ï¼Œä¾æ¬¡ç±»æ¨ï¼Œå½“æˆ‘ä»¬æŸ¥æ‰¾ 7890 è¿™ä¸ªå…ƒç´ æ—¶ï¼ŒæŸ¥æ‰¾è·¯å¾„ä¸º 0ã€5000ã€7500 â€¦ 7890ï¼Œé€šè¿‡æœ€é«˜çº§ç´¢å¼•ç›´æ¥è·³è¿‡äº†5000ä¸ªå…ƒç´ ï¼Œæ¬¡é«˜å±‚ç´¢å¼•ç›´æ¥è·³è¿‡äº†2500ä¸ªå…ƒç´ ï¼Œä»è€Œä½¿å¾—é“¾è¡¨èƒ½å¤Ÿå®ç°äºŒåˆ†æŸ¥æ‰¾ã€‚ç”±æ­¤å¯ä»¥çœ‹å‡ºï¼Œå½“å…ƒç´ æ•°é‡è¾ƒå¤šæ—¶ï¼Œç´¢å¼•æé«˜çš„æ•ˆç‡æ¯”è¾ƒå¤§ï¼Œè¿‘ä¼¼äºäºŒåˆ†æŸ¥æ‰¾ã€‚\n\nåˆ°è¿™é‡Œå¤§å®¶åº”è¯¥å·²ç»æ˜ç™½äº†ä»€ä¹ˆæ˜¯è·³è¡¨ã€‚è·³è¡¨æ˜¯å¯ä»¥å®ç°äºŒåˆ†æŸ¥æ‰¾çš„æœ‰åºé“¾è¡¨ã€‚\næŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦æ—¢ç„¶è·³è¡¨å¯ä»¥æå‡é“¾è¡¨æŸ¥æ‰¾å…ƒç´ çš„æ•ˆç‡ï¼Œé‚£æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦åˆ°åº•æ˜¯å¤šå°‘å‘¢ï¼ŸæŸ¥æ‰¾å…ƒç´ çš„è¿‡ç¨‹æ˜¯ä»æœ€é«˜çº§ç´¢å¼•å¼€å§‹ï¼Œä¸€å±‚ä¸€å±‚éå†æœ€åä¸‹æ²‰åˆ°åŸå§‹é“¾è¡¨ã€‚æ‰€ä»¥ï¼Œæ—¶é—´å¤æ‚åº¦ = ç´¢å¼•çš„é«˜åº¦ * æ¯å±‚ç´¢å¼•éå†å…ƒç´ çš„ä¸ªæ•°ã€‚\nå…ˆæ¥æ±‚è·³è¡¨çš„ç´¢å¼•é«˜åº¦ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡è®¾æ¯ä¸¤ä¸ªç»“ç‚¹ä¼šæŠ½å‡ºä¸€ä¸ªç»“ç‚¹ä½œä¸ºä¸Šä¸€çº§ç´¢å¼•çš„ç»“ç‚¹ï¼ŒåŸå§‹çš„é“¾è¡¨æœ‰nä¸ªå…ƒç´ ï¼Œåˆ™ä¸€çº§ç´¢å¼•æœ‰ n/2 ä¸ªå…ƒç´ ã€äºŒçº§ç´¢å¼•æœ‰ n/4 ä¸ªå…ƒç´ ã€kçº§ç´¢å¼•å°±æœ‰ n/2k ä¸ªå…ƒç´ ã€‚æœ€é«˜çº§ç´¢å¼•ä¸€èˆ¬æœ‰2ä¸ªå…ƒç´ ï¼Œå³ï¼šæœ€é«˜çº§ç´¢å¼• h æ»¡è¶³ 2 = n/2hï¼Œå³ h = log2n - 1ï¼Œæœ€é«˜çº§ç´¢å¼• h ä¸ºç´¢å¼•å±‚çš„é«˜åº¦åŠ ä¸ŠåŸå§‹æ•°æ®ä¸€å±‚ï¼Œè·³è¡¨çš„æ€»é«˜åº¦ h = log2nã€‚\n\næˆ‘ä»¬çœ‹ä¸Šå›¾ä¸­åŠ ç²—çš„ç®­å¤´ï¼Œè¡¨ç¤ºæŸ¥æ‰¾å…ƒç´  x çš„è·¯å¾„ï¼Œé‚£æŸ¥æ‰¾è¿‡ç¨‹ä¸­æ¯ä¸€å±‚ç´¢å¼•æœ€å¤šéå†å‡ ä¸ªå…ƒç´ å‘¢ï¼Ÿ\nå›¾ä¸­æ‰€ç¤ºï¼Œç°åœ¨åˆ°è¾¾ç¬¬ k çº§ç´¢å¼•ï¼Œæˆ‘ä»¬å‘ç°è¦æŸ¥æ‰¾çš„å…ƒç´  x æ¯” y å¤§æ¯” z å°ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦ä» y å¤„ä¸‹é™åˆ° k-1 çº§ç´¢å¼•ç»§ç»­æŸ¥æ‰¾ï¼Œk-1çº§ç´¢å¼•ä¸­æ¯” y å¤§æ¯” z å°çš„åªæœ‰ä¸€ä¸ª wï¼Œæ‰€ä»¥åœ¨ k-1 çº§ç´¢å¼•ä¸­ï¼Œæˆ‘ä»¬éå†çš„å…ƒç´ æœ€å¤šå°±æ˜¯ yã€wã€zï¼Œå‘ç° x æ¯” wå¤§æ¯” z å°ä¹‹åï¼Œå†ä¸‹é™åˆ° k-2 çº§ç´¢å¼•ã€‚æ‰€ä»¥ï¼Œk-2 çº§ç´¢å¼•æœ€å¤šéå†çš„å…ƒç´ ä¸º wã€uã€zã€‚\nå…¶å®æ¯çº§ç´¢å¼•éƒ½æ˜¯ç±»ä¼¼çš„é“ç†ï¼Œæ¯çº§ç´¢å¼•ä¸­éƒ½æ˜¯ä¸¤ä¸ªç»“ç‚¹æŠ½å‡ºä¸€ä¸ªç»“ç‚¹ä½œä¸ºä¸Šä¸€çº§ç´¢å¼•çš„ç»“ç‚¹ã€‚ ç°åœ¨æˆ‘ä»¬å¾—å‡ºç»“è®ºï¼šå½“æ¯çº§ç´¢å¼•éƒ½æ˜¯ä¸¤ä¸ªç»“ç‚¹æŠ½å‡ºä¸€ä¸ªç»“ç‚¹ä½œä¸ºä¸Šä¸€çº§ç´¢å¼•çš„ç»“ç‚¹æ—¶ï¼Œæ¯ä¸€å±‚æœ€å¤šéå†3ä¸ªç»“ç‚¹ã€‚\nè·³è¡¨çš„ç´¢å¼•é«˜åº¦ h = log2nï¼Œä¸”æ¯å±‚ç´¢å¼•æœ€å¤šéå† 3 ä¸ªå…ƒç´ ã€‚æ‰€ä»¥è·³è¡¨ä¸­æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(3*logn)ï¼Œçœç•¥å¸¸æ•°å³ï¼šO(logn)ã€‚\nç©ºé—´å¤æ‚åº¦è·³è¡¨é€šè¿‡å»ºç«‹ç´¢å¼•ï¼Œæ¥æé«˜æŸ¥æ‰¾å…ƒç´ çš„æ•ˆç‡ï¼Œå°±æ˜¯å…¸å‹çš„â€œç©ºé—´æ¢æ—¶é—´â€çš„æ€æƒ³ï¼Œæ‰€ä»¥åœ¨ç©ºé—´ä¸Šåšäº†ä¸€äº›ç‰ºç‰²ï¼Œé‚£ç©ºé—´å¤æ‚åº¦åˆ°åº•æ˜¯å¤šå°‘å‘¢ï¼Ÿ\nå‡å¦‚åŸå§‹é“¾è¡¨åŒ…å« n ä¸ªå…ƒç´ ï¼Œåˆ™ä¸€çº§ç´¢å¼•å…ƒç´ ä¸ªæ•°ä¸º n/2ã€äºŒçº§ç´¢å¼•å…ƒç´ ä¸ªæ•°ä¸º n/4ã€ä¸‰çº§ç´¢å¼•å…ƒç´ ä¸ªæ•°ä¸º n/8 ä»¥æ­¤ç±»æ¨ã€‚æ‰€ä»¥ï¼Œç´¢å¼•èŠ‚ç‚¹çš„æ€»å’Œæ˜¯ï¼šn/2 + n/4 + n/8 + â€¦ + 8 + 4 + 2 = n-2ï¼Œ**ç©ºé—´å¤æ‚åº¦æ˜¯ O(n)**ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼šå¦‚æœæ¯ä¸‰ä¸ªç»“ç‚¹æŠ½ä¸€ä¸ªç»“ç‚¹åšä¸ºç´¢å¼•ï¼Œç´¢å¼•æ€»å’Œæ•°å°±æ˜¯ n/3 + n/9 + n/27 + â€¦ + 9 + 3 + 1= n/2ï¼Œå‡å°‘äº†ä¸€åŠã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡è¾ƒå°‘ç´¢å¼•æ•°æ¥å‡å°‘ç©ºé—´å¤æ‚åº¦ï¼Œä½†æ˜¯ç›¸åº”çš„è‚¯å®šä¼šé€ æˆæŸ¥æ‰¾æ•ˆç‡æœ‰ä¸€å®šä¸‹é™ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®æˆ‘ä»¬çš„åº”ç”¨åœºæ™¯æ¥æ§åˆ¶è¿™ä¸ªé˜ˆå€¼ï¼Œçœ‹æˆ‘ä»¬æ›´æ³¨é‡æ—¶é—´è¿˜æ˜¯ç©ºé—´ã€‚\n\nButï¼Œç´¢å¼•ç»“ç‚¹å¾€å¾€åªéœ€è¦å­˜å‚¨ key å’Œå‡ ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸éœ€è¦å­˜å‚¨å®Œæ•´çš„å¯¹è±¡ï¼Œæ‰€ä»¥å½“å¯¹è±¡æ¯”ç´¢å¼•ç»“ç‚¹å¤§å¾ˆå¤šæ—¶ï¼Œç´¢å¼•å ç”¨çš„é¢å¤–ç©ºé—´å°±å¯ä»¥å¿½ç•¥äº†ã€‚ä¸¾ä¸ªä¾‹å­ï¼šæˆ‘ä»¬ç°åœ¨éœ€è¦ç”¨è·³è¡¨æ¥ç»™æ‰€æœ‰å­¦ç”Ÿå»ºç´¢å¼•ï¼Œå­¦ç”Ÿæœ‰å¾ˆå¤šå±æ€§ï¼šå­¦å·ã€å§“åã€æ€§åˆ«ã€èº«ä»½è¯å·ã€å¹´é¾„ã€å®¶åº­ä½å€ã€èº«é«˜ã€ä½“é‡ç­‰ã€‚å­¦ç”Ÿçš„å„ç§å±æ€§åªéœ€è¦åœ¨åŸå§‹é“¾è¡¨ä¸­å­˜å‚¨ä¸€ä»½å³å¯ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨å­¦ç”Ÿçš„å­¦å·ï¼ˆint ç±»å‹çš„æ•°æ®ï¼‰å»ºç«‹ç´¢å¼•ï¼Œæ‰€ä»¥ç´¢å¼•ç›¸å¯¹åŸå§‹æ•°æ®è€Œè¨€ï¼Œå ç”¨çš„ç©ºé—´å¯ä»¥å¿½ç•¥ã€‚\næ’å…¥æ•°æ®æ’å…¥æ•°æ®çœ‹èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œè·³è¡¨çš„åŸå§‹é“¾è¡¨éœ€è¦ä¿æŒæœ‰åºï¼Œæ‰€ä»¥æˆ‘ä»¬ä¼šå‘æŸ¥æ‰¾å…ƒç´ ä¸€æ ·ï¼Œæ‰¾åˆ°å…ƒç´ åº”è¯¥æ’å…¥çš„ä½ç½®ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¦æ’å…¥æ•°æ®6ï¼Œæ•´ä¸ªè¿‡ç¨‹ç±»ä¼¼äºæŸ¥æ‰¾6ï¼Œæ•´ä¸ªçš„æŸ¥æ‰¾è·¯å¾„ä¸º 1ã€1ã€1ã€4ã€4ã€5ã€‚æŸ¥æ‰¾åˆ°ç¬¬åº•å±‚åŸå§‹é“¾è¡¨çš„å…ƒç´  5 æ—¶ï¼Œå‘ç° 5 å°äº 6 ä½†æ˜¯åç»§èŠ‚ç‚¹ 7 å¤§äº 6ï¼Œæ‰€ä»¥åº”è¯¥æŠŠ 6 æ’å…¥åˆ° 5 ä¹‹å 7 ä¹‹å‰ã€‚æ•´ä¸ªæ—¶é—´å¤æ‚åº¦ä¸ºæŸ¥æ‰¾å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ O(logn)ã€‚\n\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå‡å¦‚ä¸€ç›´å¾€åŸå§‹åˆ—è¡¨ä¸­æ·»åŠ æ•°æ®ï¼Œä½†æ˜¯ä¸æ›´æ–°ç´¢å¼•ï¼Œå°±å¯èƒ½å‡ºç°ä¸¤ä¸ªç´¢å¼•èŠ‚ç‚¹ä¹‹é—´æ•°æ®éå¸¸å¤šçš„æƒ…å†µï¼Œæç«¯æƒ…å†µï¼Œè·³è¡¨é€€åŒ–ä¸ºå•é“¾è¡¨ï¼Œä»è€Œä½¿å¾—æŸ¥æ‰¾æ•ˆç‡ä» O(logn) é€€åŒ–ä¸º O(n)ã€‚é‚£è¿™ç§é—®é¢˜è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦åœ¨æ’å…¥æ•°æ®çš„æ—¶å€™ï¼Œç´¢å¼•èŠ‚ç‚¹ä¹Ÿéœ€è¦ç›¸åº”çš„å¢åŠ ã€æˆ–è€…é‡å»ºç´¢å¼•ï¼Œæ¥é¿å…æŸ¥æ‰¾æ•ˆç‡çš„é€€åŒ–ã€‚é‚£æˆ‘ä»¬è¯¥å¦‚ä½•å»ç»´æŠ¤è¿™ä¸ªç´¢å¼•å‘¢ï¼Ÿ\n\næ¯”è¾ƒå®¹æ˜“ç†è§£çš„åšæ³•å°±æ˜¯å®Œå…¨é‡å»ºç´¢å¼•ï¼Œæˆ‘ä»¬æ¯æ¬¡æ’å…¥æ•°æ®åï¼Œéƒ½æŠŠè¿™ä¸ªè·³è¡¨çš„ç´¢å¼•åˆ æ‰å…¨éƒ¨é‡å»ºï¼Œé‡å»ºç´¢å¼•çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿå› ä¸ºç´¢å¼•çš„ç©ºé—´å¤æ‚åº¦æ˜¯ O(n)ï¼Œå³ï¼šç´¢å¼•èŠ‚ç‚¹çš„ä¸ªæ•°æ˜¯ O(n) çº§åˆ«ï¼Œæ¯æ¬¡å®Œå…¨é‡æ–°å»ºä¸€ä¸ª O(n) çº§åˆ«çš„ç´¢å¼•ï¼Œæ—¶é—´å¤æ‚åº¦ä¹Ÿæ˜¯ O(n) ã€‚é€ æˆçš„åæœæ˜¯ï¼šä¸ºäº†ç»´æŠ¤ç´¢å¼•ï¼Œå¯¼è‡´æ¯æ¬¡æ’å…¥æ•°æ®çš„æ—¶é—´å¤æ‚åº¦å˜æˆäº† O(n)ã€‚\né‚£æœ‰æ²¡æœ‰å…¶ä»–æ•ˆç‡æ¯”è¾ƒé«˜çš„æ–¹å¼æ¥ç»´æŠ¤ç´¢å¼•å‘¢ï¼Ÿ\nå‡å¦‚è·³è¡¨æ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 1/2ï¼Œæœ€ç†æƒ³çš„ç´¢å¼•å°±æ˜¯åœ¨åŸå§‹é“¾è¡¨ä¸­æ¯éš”ä¸€ä¸ªå…ƒç´ æŠ½å–ä¸€ä¸ªå…ƒç´ åšä¸ºä¸€çº§ç´¢å¼•ã€‚æ¢ç§è¯´æ³•ï¼Œæˆ‘ä»¬åœ¨åŸå§‹é“¾è¡¨ä¸­éšæœºçš„é€‰ n/2 ä¸ªå…ƒç´ åšä¸ºä¸€çº§ç´¢å¼•æ˜¯ä¸æ˜¯ä¹Ÿèƒ½é€šè¿‡ç´¢å¼•æé«˜æŸ¥æ‰¾çš„æ•ˆç‡å‘¢ï¼Ÿ \nå½“ç„¶å¯ä»¥äº†ï¼Œå› ä¸ºä¸€èˆ¬éšæœºé€‰çš„å…ƒç´ ç›¸å¯¹æ¥è¯´éƒ½æ˜¯æ¯”è¾ƒå‡åŒ€çš„ã€‚\nå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéšæœºé€‰æ‹©äº†n/2 ä¸ªå…ƒç´ åšä¸ºä¸€çº§ç´¢å¼•ï¼Œè™½ç„¶ä¸æ˜¯æ¯éš”ä¸€ä¸ªå…ƒç´ æŠ½å–ä¸€ä¸ªï¼Œä½†æ˜¯å¯¹äºæŸ¥æ‰¾æ•ˆç‡æ¥è®²ï¼Œå½±å“ä¸å¤§ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³æ‰¾å…ƒç´  16ï¼Œä»ç„¶å¯ä»¥é€šè¿‡ä¸€çº§ç´¢å¼•ï¼Œä½¿å¾—éå†è·¯å¾„è¾ƒå°‘äº†å°†è¿‘ä¸€åŠã€‚\nå¦‚æœæŠ½å–çš„ä¸€çº§ç´¢å¼•çš„å…ƒç´ æ°å¥½æ˜¯å‰ä¸€åŠçš„å…ƒç´  1ã€3ã€4ã€5ã€7ã€8ï¼Œé‚£ä¹ˆæŸ¥æ‰¾æ•ˆç‡ç¡®å®æ²¡æœ‰æå‡ï¼Œä½†æ˜¯è¿™æ ·çš„æ¦‚ç‡å¤ªå°äº†ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºï¼šå½“åŸå§‹é“¾è¡¨ä¸­å…ƒç´ æ•°é‡è¶³å¤Ÿå¤§ï¼Œä¸”æŠ½å–è¶³å¤Ÿéšæœºçš„è¯ï¼Œæˆ‘ä»¬å¾—åˆ°çš„ç´¢å¼•æ˜¯å‡åŒ€çš„ã€‚æˆ‘ä»¬è¦æ¸…æ¥šè®¾è®¡è‰¯å¥½çš„æ•°æ®ç»“æ„éƒ½æ˜¯ä¸ºäº†åº”å¯¹å¤§æ•°æ®é‡çš„åœºæ™¯ï¼Œå¦‚æœåŸå§‹é“¾è¡¨åªæœ‰ 5 ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆä¾æ¬¡éå† 5 ä¸ªå…ƒç´ ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ•°æ®é‡å¤ªå°‘äº†ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥ç»´æŠ¤ä¸€ä¸ªè¿™æ ·çš„ç´¢å¼•ï¼šéšæœºé€‰ n/2 ä¸ªå…ƒç´ åšä¸ºä¸€çº§ç´¢å¼•ã€éšæœºé€‰ n/4 ä¸ªå…ƒç´ åšä¸ºäºŒçº§ç´¢å¼•ã€éšæœºé€‰ n/8 ä¸ªå…ƒç´ åšä¸ºä¸‰çº§ç´¢å¼•ï¼Œä¾æ¬¡ç±»æ¨ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚ç´¢å¼•ã€‚è¿™é‡Œæ¯å±‚ç´¢å¼•çš„å…ƒç´ ä¸ªæ•°å·²ç»ç¡®å®šï¼Œä¸”æ¯å±‚ç´¢å¼•å…ƒç´ é€‰å–çš„è¶³å¤Ÿéšæœºï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡ç´¢å¼•æ¥æå‡è·³è¡¨çš„æŸ¥æ‰¾æ•ˆç‡ã€‚\n\né‚£ä»£ç è¯¥å¦‚ä½•å®ç°ï¼Œæ‰èƒ½ä½¿è·³è¡¨æ»¡è¶³ä¸Šè¿°è¿™ä¸ªæ ·å­å‘¢ï¼Ÿå¯ä»¥åœ¨æ¯æ¬¡æ–°æ’å…¥å…ƒç´ çš„æ—¶å€™ï¼Œå°½é‡è®©è¯¥å…ƒç´ æœ‰ 1/2 çš„å‡ ç‡å»ºç«‹ä¸€çº§ç´¢å¼•ã€1/4 çš„å‡ ç‡å»ºç«‹äºŒçº§ç´¢å¼•ã€1/8 çš„å‡ ç‡å»ºç«‹ä¸‰çº§ç´¢å¼•ï¼Œä»¥æ­¤ç±»æ¨ï¼Œå°±èƒ½æ»¡è¶³æˆ‘ä»¬ä¸Šé¢çš„æ¡ä»¶ã€‚ç°åœ¨æˆ‘ä»¬å°±éœ€è¦ä¸€ä¸ªæ¦‚ç‡ç®—æ³•å¸®æˆ‘ä»¬æŠŠæ§è¿™ä¸ª 1/2ã€1/4ã€1/8 â€¦ ï¼Œå½“æ¯æ¬¡æœ‰æ•°æ®è¦æ’å…¥æ—¶ï¼Œå…ˆé€šè¿‡æ¦‚ç‡ç®—æ³•å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªå…ƒç´ éœ€è¦æ’å…¥åˆ°å‡ çº§ç´¢å¼•ä¸­ï¼Œç„¶åå¼€å§‹ç»´æŠ¤ç´¢å¼•å¹¶æŠŠæ•°æ®æ’å…¥åˆ°åŸå§‹é“¾è¡¨ä¸­ã€‚ä¸‹é¢å¼€å§‹è®²è§£è¿™ä¸ªæ¦‚ç‡ç®—æ³•ä»£ç å¦‚ä½•å®ç°ã€‚\næˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ª randomLevel() æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¼šéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼ˆMAX_LEVELè¡¨ç¤ºç´¢å¼•çš„æœ€é«˜å±‚æ•°ï¼‰ï¼Œä¸”è¯¥æ–¹æ³•æœ‰ 1/2 çš„æ¦‚ç‡è¿”å› 1ã€1/4 çš„æ¦‚ç‡è¿”å› 2ã€1/8çš„æ¦‚ç‡è¿”å› 3ï¼Œä»¥æ­¤ç±»æ¨ã€‚\n\nrandomLevel() æ–¹æ³•è¿”å› 1 è¡¨ç¤ºå½“å‰æ’å…¥çš„è¯¥å…ƒç´ ä¸éœ€è¦å»ºç´¢å¼•ï¼Œåªéœ€è¦å­˜å‚¨æ•°æ®åˆ°åŸå§‹é“¾è¡¨å³å¯ï¼ˆæ¦‚ç‡ 1/2ï¼‰\nrandomLevel() æ–¹æ³•è¿”å› 2 è¡¨ç¤ºå½“å‰æ’å…¥çš„è¯¥å…ƒç´ éœ€è¦å»ºä¸€çº§ç´¢å¼•ï¼ˆæ¦‚ç‡ 1/4ï¼‰\nrandomLevel() æ–¹æ³•è¿”å› 3 è¡¨ç¤ºå½“å‰æ’å…¥çš„è¯¥å…ƒç´ éœ€è¦å»ºäºŒçº§ç´¢å¼•ï¼ˆæ¦‚ç‡ 1/8ï¼‰\nrandomLevel() æ–¹æ³•è¿”å› 4 è¡¨ç¤ºå½“å‰æ’å…¥çš„è¯¥å…ƒç´ éœ€è¦å»ºä¸‰çº§ç´¢å¼•ï¼ˆæ¦‚ç‡ 1/16ï¼‰\nã€‚ã€‚ã€‚ä»¥æ­¤ç±»æ¨\n\næ‰€ä»¥ï¼Œé€šè¿‡ randomLevel() æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶æ•´ä¸ªè·³è¡¨å„çº§ç´¢å¼•ä¸­å…ƒç´ çš„ä¸ªæ•°ã€‚é‡ç‚¹æ¥äº†ï¼šrandomLevel() æ–¹æ³•è¿”å› 2 çš„æ—¶å€™ä¼šå»ºç«‹ä¸€çº§ç´¢å¼•ï¼Œæˆ‘ä»¬æƒ³è¦ä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®çš„ 1/2ï¼Œä½†æ˜¯ randomLevel() æ–¹æ³•è¿”å› 2 çš„æ¦‚ç‡ä¸º 1/4ï¼Œé‚£æ˜¯ä¸æ˜¯æœ‰çŸ›ç›¾å‘¢ï¼Ÿæ˜æ˜è¯´å¥½çš„ 1/2ï¼Œç»“æœä¸€çº§ç´¢å¼•å…ƒç´ ä¸ªæ•°æ€ä¹ˆå˜æˆäº†åŸå§‹é“¾è¡¨çš„ 1/4ï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸‹å›¾ï¼Œåº”è¯¥å°±æ˜ç™½äº†ã€‚\n\nå‡è®¾æˆ‘ä»¬åœ¨æ’å…¥å…ƒç´  6 çš„æ—¶å€™ï¼ŒrandomLevel() æ–¹æ³•è¿”å› 1ï¼Œåˆ™æˆ‘ä»¬ä¸ä¼šä¸º 6 å»ºç«‹ç´¢å¼•ã€‚æ’å…¥ 7 çš„æ—¶å€™ï¼ŒrandomLevel() æ–¹æ³•è¿”å›3 ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸ºå…ƒç´  7 å»ºç«‹äºŒçº§ç´¢å¼•ã€‚è¿™é‡Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªç‰¹ç‚¹ï¼šå½“å»ºç«‹äºŒçº§ç´¢å¼•çš„æ—¶å€™ï¼ŒåŒæ—¶ä¹Ÿä¼šå»ºç«‹ä¸€çº§ç´¢å¼•ï¼›å½“å»ºç«‹ä¸‰çº§ç´¢å¼•æ—¶ï¼ŒåŒæ—¶ä¹Ÿä¼šå»ºç«‹ä¸€çº§ã€äºŒçº§ç´¢å¼•ã€‚æ‰€ä»¥ï¼Œä¸€çº§ç´¢å¼•ä¸­å…ƒç´ çš„ä¸ªæ•°ç­‰äº [ åŸå§‹é“¾è¡¨å…ƒç´ ä¸ªæ•° ] * *[ randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 1 çš„æ¦‚ç‡ ]*ã€‚å› ä¸º randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 1å°±ä¼šå»ºç´¢å¼•ï¼Œå‡¡æ˜¯å»ºç´¢å¼•ï¼Œæ— è®ºå‡ çº§ç´¢å¼•å¿…ç„¶æœ‰ä¸€çº§ç´¢å¼•ï¼Œæ‰€ä»¥ä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®ä¸ªæ•°çš„æ¯”ç‡ä¸º randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 1 çš„æ¦‚ç‡ã€‚é‚£ randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 1 çš„æ¦‚ç‡æ˜¯å¤šå°‘å‘¢ï¼Ÿå› ä¸º randomLevel() æ–¹æ³•éšæœºç”Ÿæˆ 1~MAX_LEVEL çš„æ•°å­—ï¼Œä¸” randomLevel() æ–¹æ³•è¿”å›å€¼ 1 çš„æ¦‚ç‡ä¸º 1/2ï¼Œåˆ™ randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 1 çš„æ¦‚ç‡ä¸º 1 - 1/2 = 1/2ã€‚å³é€šè¿‡ä¸Šè¿°æµç¨‹å®ç°äº†ä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®ä¸ªæ•°çš„ 1/2ã€‚\nåŒç†ï¼Œå½“ randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 2 æ—¶ï¼Œä¼šå»ºç«‹äºŒçº§æˆ–äºŒçº§ä»¥ä¸Šç´¢å¼•ï¼Œéƒ½ä¼šåœ¨äºŒçº§ç´¢å¼•ä¸­å¢åŠ å…ƒç´ ï¼Œå› æ­¤äºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®çš„æ¯”ç‡ä¸º randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 2 çš„æ¦‚ç‡ã€‚ randomLevel() æ–¹æ³•è¿”å›å€¼ &gt; 2 çš„æ¦‚ç‡ä¸º 1 å‡å» randomLevel() = 1 æˆ– =2 çš„æ¦‚ç‡ï¼Œå³ 1 - 1/2 - 1/4 = 1/4ã€‚OKï¼Œè¾¾åˆ°äº†æˆ‘ä»¬è®¾è®¡çš„ç›®æ ‡ï¼šäºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®çš„ 1/4ã€‚\nä»¥æ­¤ç±»æ¨ï¼Œå¯ä»¥å¾—å‡ºï¼Œéµå®ˆä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ï¼š\n\nrandomLevel() æ–¹æ³•ï¼Œéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼ˆMAX_LEVELè¡¨ç¤ºç´¢å¼•çš„æœ€é«˜å±‚æ•°ï¼‰ï¼Œä¸”æœ‰ 1/2çš„æ¦‚ç‡è¿”å› 1ã€1/4çš„æ¦‚ç‡è¿”å› 2ã€1/8çš„æ¦‚ç‡è¿”å› 3 â€¦\nrandomLevel() æ–¹æ³•è¿”å› 1 ä¸å»ºç´¢å¼•ã€è¿”å›2å»ºä¸€çº§ç´¢å¼•ã€è¿”å› 3 å»ºäºŒçº§ç´¢å¼•ã€è¿”å› 4 å»ºä¸‰çº§ç´¢å¼• â€¦\n\nå°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬æƒ³è¦çš„ç»“æœï¼Œå³ï¼šä¸€çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°åº”è¯¥å åŸå§‹æ•°æ®çš„ 1/2ï¼ŒäºŒçº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®çš„ 1/4ï¼Œä¸‰çº§ç´¢å¼•ä¸­å…ƒç´ ä¸ªæ•°å åŸå§‹æ•°æ®çš„ 1/8 ï¼Œä¾æ¬¡ç±»æ¨ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚ç´¢å¼•ã€‚\nä½†æ˜¯é—®é¢˜åˆæ¥äº†ï¼Œæ€ä¹ˆè®¾è®¡è¿™ä¹ˆä¸€ä¸ª randomLevel() æ–¹æ³•å‘¢ï¼Ÿç›´æ¥æ’¸ä»£ç ï¼š\n// è¯¥ randomLevel æ–¹æ³•ä¼šéšæœºç”Ÿæˆ 1~MAX_LEVEL ä¹‹é—´çš„æ•°ï¼Œä¸” ï¼š//        1/2 çš„æ¦‚ç‡è¿”å› 1//        1/4 çš„æ¦‚ç‡è¿”å› 2//        1/8 çš„æ¦‚ç‡è¿”å› 3 ä»¥æ­¤ç±»æ¨private int randomLevel() &#123;  int level = 1;  // å½“ level &lt; MAX_LEVELï¼Œä¸”éšæœºæ•°å°äºè®¾å®šçš„æ™‹å‡æ¦‚ç‡æ—¶ï¼Œlevel + 1  while (Math.random() &lt; SKIPLIST_P &amp;&amp; level &lt; MAX_LEVEL)    level += 1;  return level;&#125;\n\nä¸Šè¿°ä»£ç å¯ä»¥å®ç°æˆ‘ä»¬çš„åŠŸèƒ½ï¼Œè€Œä¸”ï¼Œæˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­æ™‹å‡æ¦‚ç‡ SKIPLIST_P è®¾ç½®çš„ 1/2ï¼Œå³ï¼šæ¯ä¸¤ä¸ªç»“ç‚¹æŠ½å‡ºä¸€ä¸ªç»“ç‚¹ä½œä¸ºä¸Šä¸€çº§ç´¢å¼•çš„ç»“ç‚¹ã€‚å¦‚æœæˆ‘ä»¬æƒ³èŠ‚çœç©ºé—´åˆ©ç”¨ç‡ï¼Œå¯ä»¥é€‚å½“çš„é™ä½ä»£ç ä¸­çš„ SKIPLIST_Pï¼Œä»è€Œå‡å°‘ç´¢å¼•å…ƒç´ ä¸ªæ•°ï¼ŒRedis çš„ zset ä¸­ SKIPLIST_P è®¾å®šçš„ 0.25ã€‚ä¸‹å›¾æ‰€ç¤ºï¼Œæ˜¯Redis t_zset.c ä¸­ zslRandomLevel å‡½æ•°çš„å®ç°ï¼š\n\nRedis æºç ä¸­ (random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF)  åœ¨åŠŸèƒ½ä¸Šç­‰ä»·äºæˆ‘ä»£ç ä¸­çš„ Math.random() &lt; SKIPLIST_P ï¼Œåªä¸è¿‡ Redis ä½œè€… antirez ä½¿ç”¨ä½è¿ç®—æ¥æé«˜æµ®ç‚¹æ•°æ¯”è¾ƒçš„æ•ˆç‡ã€‚\næ•´ä½“æ€è·¯å¤§å®¶åº”è¯¥æ˜ç™½äº†ï¼Œé‚£æ’å…¥æ•°æ®æ—¶ç»´æŠ¤ç´¢å¼•çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿ**å…ƒç´ æ’å…¥åˆ°å•é“¾è¡¨çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)**ï¼Œæˆ‘ä»¬ç´¢å¼•çš„é«˜åº¦æœ€å¤šä¸º lognï¼Œå½“æ’å…¥ä¸€ä¸ªå…ƒç´  x æ—¶ï¼Œæœ€åçš„æƒ…å†µå°±æ˜¯å…ƒç´  x éœ€è¦æ’å…¥åˆ°æ¯å±‚ç´¢å¼•ä¸­ï¼Œæ‰€ä»¥æ’å…¥æ•°æ®åˆ°å„å±‚ç´¢å¼•ä¸­ï¼Œæœ€åæ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)ã€‚\nè¿‡ç¨‹å¤§æ¦‚ç†è§£äº†ï¼Œå†é€šè¿‡ä¸€ä¸ªä¾‹å­æè¿°ä¸€ä¸‹è·³è¡¨æ’å…¥æ•°æ®çš„å…¨æµç¨‹ã€‚ç°åœ¨æˆ‘ä»¬è¦æ’å…¥æ•°æ® 6 åˆ°è·³è¡¨ä¸­ï¼Œé¦–å…ˆ randomLevel() è¿”å› 3ï¼Œè¡¨ç¤ºéœ€è¦å»ºäºŒçº§ç´¢å¼•ï¼Œå³ï¼šä¸€çº§ç´¢å¼•å’ŒäºŒçº§ç´¢å¼•éœ€è¦å¢åŠ å…ƒç´  6ã€‚è¯¥è·³è¡¨ç›®å‰æœ€é«˜ä¸‰çº§ç´¢å¼•ï¼Œé¦–å…ˆæ‰¾åˆ°ä¸‰çº§ç´¢å¼•çš„ 1ï¼Œå‘ç° 6 æ¯” 1å¤§æ¯” 13å°ï¼Œæ‰€ä»¥ï¼Œä» 1 ä¸‹æ²‰åˆ°äºŒçº§ç´¢å¼•ã€‚\n\nä¸‹æ²‰åˆ°äºŒçº§ç´¢å¼•åï¼Œå‘ç° 6 æ¯” 1 å¤§æ¯” 7 å°ï¼Œæ­¤æ—¶éœ€è¦åœ¨äºŒçº§ç´¢å¼•ä¸­ 1 å’Œ 7 ä¹‹é—´åŠ ä¸€ä¸ªå…ƒç´ 6 ï¼Œå¹¶ä»å…ƒç´  1 ç»§ç»­ä¸‹æ²‰åˆ°ä¸€çº§ç´¢å¼•ã€‚\n\nä¸‹æ²‰åˆ°ä¸€çº§ç´¢å¼•åï¼Œå‘ç° 6 æ¯” 1 å¤§æ¯” 4 å¤§ï¼Œæ‰€ä»¥å¾€åæŸ¥æ‰¾ï¼Œå‘ç° 6 æ¯” 4 å¤§æ¯” 7 å°ï¼Œæ­¤æ—¶éœ€è¦åœ¨ä¸€çº§ç´¢å¼•ä¸­ 4 å’Œ 7 ä¹‹é—´åŠ ä¸€ä¸ªå…ƒç´  6 ï¼Œå¹¶æŠŠäºŒçº§ç´¢å¼•çš„ 6 æŒ‡å‘ ä¸€çº§ç´¢å¼•çš„ 6ï¼Œæœ€åï¼Œä»å…ƒç´  4 ç»§ç»­ä¸‹æ²‰åˆ°åŸå§‹é“¾è¡¨ã€‚\n\nä¸‹æ²‰åˆ°åŸå§‹é“¾è¡¨åï¼Œå°±æ¯”è¾ƒç®€å•äº†ï¼Œå‘ç° 4ã€5 æ¯” 6å°ï¼Œ7æ¯”6å¤§ï¼Œæ‰€ä»¥å°†6æ’å…¥åˆ° 5 å’Œ 7 ä¹‹é—´å³å¯ï¼Œæ•´ä¸ªæ’å…¥è¿‡ç¨‹ç»“æŸã€‚\n\næ•´ä¸ªæ’å…¥è¿‡ç¨‹çš„è·¯å¾„ä¸æŸ¥æ‰¾å…ƒç´ è·¯å¾„ç±»ä¼¼ï¼Œ æ¯å±‚ç´¢å¼•ä¸­æ’å…¥å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ O(1)ï¼Œæ‰€ä»¥æ•´ä¸ªæ’å…¥çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(logn)ã€‚\nåˆ é™¤æ•°æ®è·³è¡¨åˆ é™¤æ•°æ®æ—¶ï¼Œè¦æŠŠç´¢å¼•ä¸­å¯¹åº”èŠ‚ç‚¹ä¹Ÿè¦åˆ æ‰ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœè¦åˆ é™¤å…ƒç´  9ï¼Œéœ€è¦æŠŠåŸå§‹é“¾è¡¨ä¸­çš„ 9 å’Œç¬¬ä¸€çº§ç´¢å¼•çš„ 9 éƒ½åˆ é™¤æ‰ã€‚\n\nè·³è¡¨ä¸­ï¼Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘å‘¢ï¼Ÿ\nåˆ é™¤å…ƒç´ çš„è¿‡ç¨‹è·ŸæŸ¥æ‰¾å…ƒç´ çš„è¿‡ç¨‹ç±»ä¼¼ï¼Œåªä¸è¿‡åœ¨æŸ¥æ‰¾çš„è·¯å¾„ä¸Šå¦‚æœå‘ç°äº†è¦åˆ é™¤çš„å…ƒç´  xï¼Œåˆ™æ‰§è¡Œåˆ é™¤æ“ä½œã€‚è·³è¡¨ä¸­ï¼Œæ¯ä¸€å±‚ç´¢å¼•å…¶å®éƒ½æ˜¯ä¸€ä¸ªæœ‰åºçš„å•é“¾è¡¨ï¼Œå•é“¾è¡¨åˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(1)ï¼Œç´¢å¼•å±‚æ•°ä¸º logn è¡¨ç¤ºæœ€å¤šéœ€è¦åˆ é™¤ logn ä¸ªå…ƒç´ ï¼Œæ‰€ä»¥åˆ é™¤å…ƒç´ çš„æ€»æ—¶é—´åŒ…å« æŸ¥æ‰¾å…ƒç´ çš„æ—¶é—´ åŠ  åˆ é™¤ lognä¸ªå…ƒç´ çš„æ—¶é—´ ä¸º O(logn) + O(logn) = 2 O(logn)ï¼Œå¿½ç•¥å¸¸æ•°éƒ¨åˆ†ï¼Œåˆ é™¤å…ƒç´ çš„æ—¶é—´å¤æ‚åº¦ä¸º O(logn)ã€‚\næ€»ç»“\nè·³è¡¨æ˜¯å¯ä»¥å®ç°äºŒåˆ†æŸ¥æ‰¾çš„æœ‰åºé“¾è¡¨ï¼›\næ¯ä¸ªå…ƒç´ æ’å…¥æ—¶éšæœºç”Ÿæˆå®ƒçš„levelï¼›\næœ€åº•å±‚åŒ…å«æ‰€æœ‰çš„å…ƒç´ ï¼›\nå¦‚æœä¸€ä¸ªå…ƒç´ å‡ºç°åœ¨level(x)ï¼Œé‚£ä¹ˆå®ƒè‚¯å®šå‡ºç°åœ¨xä»¥ä¸‹çš„levelä¸­ï¼›\næ¯ä¸ªç´¢å¼•èŠ‚ç‚¹åŒ…å«ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªå‘ä¸‹ï¼Œä¸€ä¸ªå‘å³ï¼›ï¼ˆç¬”è®°ç›®å‰çœ‹è¿‡çš„å„ç§è·³è¡¨æºç å®ç°åŒ…æ‹¬Redis çš„zset éƒ½æ²¡æœ‰å‘ä¸‹çš„æŒ‡é’ˆï¼Œé‚£æ€ä¹ˆä»äºŒçº§ç´¢å¼•è·³åˆ°ä¸€çº§ç´¢å¼•å‘¢ï¼Ÿç•™ä¸ªæ‚¬å¿µï¼Œçœ‹æºç å§ï¼Œæ–‡æœ«æœ‰è·³è¡¨å®ç°æºç ï¼‰\nè·³è¡¨æŸ¥è¯¢ã€æ’å…¥ã€åˆ é™¤çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(log n)ï¼Œä¸å¹³è¡¡äºŒå‰æ ‘æ¥è¿‘ï¼›\n\nä¸ºä»€ä¹ˆRedisé€‰æ‹©ä½¿ç”¨è·³è¡¨è€Œä¸æ˜¯çº¢é»‘æ ‘æ¥å®ç°æœ‰åºé›†åˆï¼ŸRedis ä¸­çš„æœ‰åºé›†åˆ(zset) æ”¯æŒçš„æ“ä½œï¼š\n\næ’å…¥ä¸€ä¸ªå…ƒç´ \nåˆ é™¤ä¸€ä¸ªå…ƒç´ \næŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ \næœ‰åºè¾“å‡ºæ‰€æœ‰å…ƒç´ \næŒ‰ç…§èŒƒå›´åŒºé—´æŸ¥æ‰¾å…ƒç´ ï¼ˆæ¯”å¦‚æŸ¥æ‰¾å€¼åœ¨ [100, 356] ä¹‹é—´çš„æ•°æ®ï¼‰\n\nå…¶ä¸­ï¼Œå‰å››ä¸ªæ“ä½œçº¢é»‘æ ‘ä¹Ÿå¯ä»¥å®Œæˆï¼Œä¸”æ—¶é—´å¤æ‚åº¦è·Ÿè·³è¡¨æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯ï¼ŒæŒ‰ç…§åŒºé—´æ¥æŸ¥æ‰¾æ•°æ®è¿™ä¸ªæ“ä½œï¼Œçº¢é»‘æ ‘çš„æ•ˆç‡æ²¡æœ‰è·³è¡¨é«˜ã€‚æŒ‰ç…§åŒºé—´æŸ¥æ‰¾æ•°æ®æ—¶ï¼Œè·³è¡¨å¯ä»¥åšåˆ° O(logn) çš„æ—¶é—´å¤æ‚åº¦å®šä½åŒºé—´çš„èµ·ç‚¹ï¼Œç„¶ååœ¨åŸå§‹é“¾è¡¨ä¸­é¡ºåºå¾€åéå†å°±å¯ä»¥äº†ï¼Œéå¸¸é«˜æ•ˆã€‚\nå·¥ä¸šä¸Šå…¶ä»–ä½¿ç”¨è·³è¡¨çš„åœºæ™¯åœ¨åšå®¢ä¸Šä»æ¥æ²¡æœ‰è§è¿‡æœ‰åŒå­¦è®²è¿° HBase MemStore çš„æ•°æ®ç»“æ„ï¼Œå…¶å® HBase MemStore å†…éƒ¨å­˜å‚¨æ•°æ®å°±ä½¿ç”¨çš„è·³è¡¨ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼ŸHBase å±äº LSM Tree ç»“æ„çš„æ•°æ®åº“ï¼ŒLSM Tree ç»“æ„çš„æ•°æ®åº“æœ‰ä¸ªç‰¹ç‚¹ï¼Œå®æ—¶å†™å…¥çš„æ•°æ®å…ˆå†™å…¥åˆ°å†…å­˜ï¼Œå†…å­˜è¾¾åˆ°é˜ˆå€¼å¾€ç£ç›˜ flush çš„æ—¶å€™ï¼Œä¼šç”Ÿæˆç±»ä¼¼äº StoreFile çš„ æœ‰åºæ–‡ä»¶ï¼Œè€Œè·³è¡¨æ°å¥½å°±æ˜¯å¤©ç„¶æœ‰åºçš„ï¼Œæ‰€ä»¥åœ¨ flush çš„æ—¶å€™æ•ˆç‡å¾ˆé«˜ï¼Œè€Œä¸”è·³è¡¨æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤æ€§èƒ½éƒ½å¾ˆé«˜ï¼Œè¿™åº”è¯¥æ˜¯ HBase MemStore å†…éƒ¨å­˜å‚¨æ•°æ®ä½¿ç”¨è·³è¡¨çš„åŸå› ä¹‹ä¸€ã€‚HBase ä½¿ç”¨çš„æ˜¯ java.util.concurrent ä¸‹çš„ ConcurrentSkipListMap()ã€‚\nGoogle å¼€æºçš„ key/value å­˜å‚¨å¼•æ“ LevelDB ä»¥åŠ Facebook åŸºäº LevelDB ä¼˜åŒ–çš„ RocksDB éƒ½æ˜¯ LSM Tree ç»“æ„çš„æ•°æ®åº“ï¼Œä»–ä»¬å†…éƒ¨çš„ MemTable éƒ½æ˜¯ä½¿ç”¨äº†è·³è¡¨è¿™ç§æ•°æ®ç»“æ„ã€‚\n","categories":["è¿ç»´","Redis"]},{"title":"Redis é«˜çº§å®¢æˆ·ç«¯Lettuceè¯¦è§£","url":"/posts/46477/","content":"å‰æLettuceæ˜¯ä¸€ä¸ªRedisçš„Javaé©±åŠ¨åŒ…ï¼Œåˆè¯†å¥¹çš„æ—¶å€™æ˜¯ä½¿ç”¨RedisTemplateçš„æ—¶å€™é‡åˆ°ç‚¹é—®é¢˜Debugåˆ°åº•å±‚çš„ä¸€äº›æºç ï¼Œå‘ç°spring-data-redisçš„é©±åŠ¨åŒ…åœ¨æŸä¸ªç‰ˆæœ¬ä¹‹åæ›¿æ¢ä¸ºLettuceã€‚Lettuceç¿»è¯‘ä¸ºç”Ÿèœï¼Œæ²¡é”™ï¼Œå°±æ˜¯åƒçš„é‚£ç§ç”Ÿèœï¼Œæ‰€ä»¥å®ƒçš„Logoé•¿è¿™æ ·ï¼š\n[\næ—¢ç„¶èƒ½è¢«Springç”Ÿæ€æ‰€è®¤å¯ï¼ŒLettuceæƒ³å¿…æœ‰è¿‡äººä¹‹å¤„ï¼Œäºæ˜¯ç¬”è€…èŠ±æ—¶é—´é˜…è¯»å¥¹çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ•´ç†æµ‹è¯•ç¤ºä¾‹ï¼Œå†™ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ç¼–å†™æœ¬æ–‡æ—¶æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºLettuce 5.1.8.RELEASEï¼ŒSpringBoot 2.1.8.RELEASEï¼ŒJDK [8,11]ã€‚è¶…é•¿è­¦å‘Šï¼šè¿™ç¯‡æ–‡ç« æ–­æ–­ç»­ç»­èŠ±äº†ä¸¤å‘¨å®Œæˆï¼Œè¶…è¿‡4ä¸‡å­—â€¦..\nLettuceç®€ä»‹Lettuceæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½åŸºäºJavaç¼–å†™çš„Redisé©±åŠ¨æ¡†æ¶ï¼Œåº•å±‚é›†æˆäº†Project Reactoræä¾›å¤©ç„¶çš„ååº”å¼ç¼–ç¨‹ï¼Œé€šä¿¡æ¡†æ¶é›†æˆäº†Nettyä½¿ç”¨äº†éé˜»å¡IOï¼Œ5.xç‰ˆæœ¬ä¹‹åèåˆäº†JDK1.8çš„å¼‚æ­¥ç¼–ç¨‹ç‰¹æ€§ï¼Œåœ¨ä¿è¯é«˜æ€§èƒ½çš„åŒæ—¶æä¾›äº†ååˆ†ä¸°å¯Œæ˜“ç”¨çš„APIï¼Œ5.1ç‰ˆæœ¬çš„æ–°ç‰¹æ€§å¦‚ä¸‹ï¼š\n\næ”¯æŒRedisçš„æ–°å¢å‘½ä»¤ZPOPMIN, ZPOPMAX, BZPOPMIN, BZPOPMAXã€‚\næ”¯æŒé€šè¿‡Braveæ¨¡å—è·Ÿè¸ªRediså‘½ä»¤æ‰§è¡Œã€‚\næ”¯æŒRedis Streamsã€‚\næ”¯æŒå¼‚æ­¥çš„ä¸»ä»è¿æ¥ã€‚\næ”¯æŒå¼‚æ­¥è¿æ¥æ± ã€‚\næ–°å¢å‘½ä»¤æœ€å¤šæ‰§è¡Œä¸€æ¬¡æ¨¡å¼ï¼ˆç¦æ­¢è‡ªåŠ¨é‡è¿ï¼‰ã€‚\nå…¨å±€å‘½ä»¤è¶…æ—¶è®¾ç½®ï¼ˆå¯¹å¼‚æ­¥å’Œååº”å¼å‘½ä»¤ä¹Ÿæœ‰æ•ˆï¼‰ã€‚\nâ€¦â€¦ç­‰ç­‰\n\næ³¨æ„ä¸€ç‚¹ï¼šRedisçš„ç‰ˆæœ¬è‡³å°‘éœ€è¦2.6ï¼Œå½“ç„¶è¶Šé«˜è¶Šå¥½ï¼ŒAPIçš„å…¼å®¹æ€§æ¯”è¾ƒå¼ºå¤§ã€‚\nåªéœ€è¦å¼•å…¥å•ä¸ªä¾èµ–å°±å¯ä»¥å¼€å§‹æ„‰å¿«åœ°ä½¿ç”¨Lettuceï¼š\n\nMaven\n&lt;dependency&gt;    &lt;groupId&gt;io.lettuce&lt;/groupId&gt;    &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;    &lt;version&gt;5.1.8.RELEASE&lt;/version&gt;&lt;/dependency&gt;\nGradle\ndependencies &#123;  compile &#x27;io.lettuce:lettuce-core:5.1.8.RELEASE&#x27;&#125;\n\nè¿æ¥Rediså•æœºã€å“¨å…µã€é›†ç¾¤æ¨¡å¼ä¸‹è¿æ¥Rediséœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†å»è¡¨ç¤ºè¿æ¥çš„ç»†èŠ‚ä¿¡æ¯ï¼Œåœ¨Lettuceä¸­è¿™ä¸ªç»Ÿä¸€çš„æ ‡å‡†æ˜¯RedisURIã€‚å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ„é€ ä¸€ä¸ªRedisURIå®ä¾‹ï¼š\n\nå®šåˆ¶çš„å­—ç¬¦ä¸²URIè¯­æ³•ï¼š\n\nRedisURI uri = RedisURI.create(&quot;redis://localhost/&quot;);\n\n\nä½¿ç”¨å»ºé€ å™¨ï¼ˆRedisURI.Builderï¼‰ï¼š\n\nRedisURI uri = RedisURI.builder().withHost(&quot;localhost&quot;).withPort(6379).build();\n\n\nç›´æ¥é€šè¿‡æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼š\n\nRedisURI uri = new RedisURI(&quot;localhost&quot;, 6379, 60, TimeUnit.SECONDS);\n\nå®šåˆ¶çš„è¿æ¥URIè¯­æ³•\nå•æœºï¼ˆå‰ç¼€ä¸ºredis://ï¼‰\n\næ ¼å¼ï¼šredis://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]å®Œæ•´ï¼šredis://mypassword@127.0.0.1:6379/0?timeout=10sç®€å•ï¼šredis://localhost\n\n\nå•æœºå¹¶ä¸”ä½¿ç”¨SSLï¼ˆå‰ç¼€ä¸ºrediss://ï¼‰ &lt;== æ³¨æ„åé¢å¤šäº†ä¸ªs\n\næ ¼å¼ï¼šrediss://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]å®Œæ•´ï¼šrediss://mypassword@127.0.0.1:6379/0?timeout=10sç®€å•ï¼šrediss://localhost\n\n\nå•æœºUnix Domain Socketsæ¨¡å¼ï¼ˆå‰ç¼€ä¸ºredis-socket://ï¼‰\n\næ ¼å¼ï¼šredis-socket://path[?[timeout=timeout[d|h|m|s|ms|us|ns]][&amp;_database=database_]]å®Œæ•´ï¼šredis-socket:///tmp/redis?timeout=10s&amp;_database=0\n\n\nå“¨å…µï¼ˆå‰ç¼€ä¸ºredis-sentinel://ï¼‰\n\næ ¼å¼ï¼šredis-sentinel://[password@]host[:port][,host2[:port2]][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]#sentinelMasterIdå®Œæ•´ï¼šredis-sentinel://mypassword@127.0.0.1:6379,127.0.0.1:6380/0?timeout=10s#mymaster\n\nè¶…æ—¶æ—¶é—´å•ä½ï¼š\n\nd å¤©\nh å°æ—¶\nm åˆ†é’Ÿ\ns ç§’é’Ÿ\nms æ¯«ç§’\nus å¾®ç§’\nns çº³ç§’\n\nä¸ªäººå»ºè®®ä½¿ç”¨RedisURIæä¾›çš„å»ºé€ å™¨ï¼Œæ¯•ç«Ÿå®šåˆ¶çš„URIè™½ç„¶ç®€æ´ï¼Œä½†æ˜¯æ¯”è¾ƒå®¹æ˜“å‡ºç°äººä¸ºé”™è¯¯ã€‚é‰´äºç¬”è€…æ²¡æœ‰SSLå’ŒUnix Domain Socketçš„ä½¿ç”¨åœºæ™¯ï¼Œä¸‹é¢ä¸å¯¹è¿™ä¸¤ç§è¿æ¥æ–¹å¼è¿›è¡Œåˆ—ä¸¾ã€‚\nåŸºæœ¬ä½¿ç”¨Lettuceä½¿ç”¨çš„æ—¶å€™ä¾èµ–äºå››ä¸ªä¸»è¦ç»„ä»¶ï¼š\n\nRedisURIï¼šè¿æ¥ä¿¡æ¯ã€‚\nRedisClientï¼šRediså®¢æˆ·ç«¯ï¼Œç‰¹æ®Šåœ°ï¼Œé›†ç¾¤è¿æ¥æœ‰ä¸€ä¸ªå®šåˆ¶çš„RedisClusterClientã€‚\nConnectionï¼šRedisè¿æ¥ï¼Œä¸»è¦æ˜¯StatefulConnectionæˆ–è€…StatefulRedisConnectionçš„å­ç±»ï¼Œè¿æ¥çš„ç±»å‹ä¸»è¦ç”±è¿æ¥çš„å…·ä½“æ–¹å¼ï¼ˆå•æœºã€å“¨å…µã€é›†ç¾¤ã€è®¢é˜…å‘å¸ƒç­‰ç­‰ï¼‰é€‰å®šï¼Œæ¯”è¾ƒé‡è¦ã€‚\nRedisCommandsï¼šRediså‘½ä»¤APIæ¥å£ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–äº†Rediså‘è¡Œç‰ˆæœ¬çš„æ‰€æœ‰å‘½ä»¤ï¼Œæä¾›äº†åŒæ­¥ï¼ˆsyncï¼‰ã€å¼‚æ­¥ï¼ˆasyncï¼‰ã€ååº”å¼ï¼ˆreativeï¼‰çš„è°ƒç”¨æ–¹å¼ï¼Œå¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä¼šç»å¸¸è·ŸRedisCommandsç³»åˆ—æ¥å£æ‰“äº¤é“ã€‚\n\nä¸€ä¸ªåŸºæœ¬ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š\n@Testpublic void testSetGet() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()                    // &lt;1&gt; åˆ›å»ºå•æœºè¿æ¥çš„è¿æ¥ä¿¡æ¯            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);   // &lt;2&gt; åˆ›å»ºå®¢æˆ·ç«¯    StatefulRedisConnection&lt;String, String&gt; connection = redisClient.connect();     // &lt;3&gt; åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„è¿æ¥    RedisCommands&lt;String, String&gt; redisCommands = connection.sync();                // &lt;4&gt; åˆ›å»ºåŒæ­¥å‘½ä»¤    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    String result = redisCommands.set(&quot;name&quot;, &quot;throwable&quot;, setArgs);    Assertions.assertThat(result).isEqualToIgnoringCase(&quot;OK&quot;);    result = redisCommands.get(&quot;name&quot;);    Assertions.assertThat(result).isEqualTo(&quot;throwable&quot;);    // ... å…¶ä»–æ“ä½œ    connection.close();   // &lt;5&gt; å…³é—­è¿æ¥    redisClient.shutdown();  // &lt;6&gt; å…³é—­å®¢æˆ·ç«¯&#125;\n\næ³¨æ„ï¼š\n\n**&lt;5&gt;**ï¼šå…³é—­è¿æ¥ä¸€èˆ¬åœ¨åº”ç”¨ç¨‹åºåœæ­¢ä¹‹å‰æ“ä½œï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªRedisé©±åŠ¨å®ä¾‹ä¸éœ€è¦å¤ªå¤šçš„è¿æ¥ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦ä¸€ä¸ªè¿æ¥å®ä¾‹å°±å¯ä»¥ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿æ¥çš„éœ€è¦å¯ä»¥è€ƒè™‘ä½¿ç”¨è¿æ¥æ± ï¼Œå…¶å®Redisç›®å‰å¤„ç†å‘½ä»¤çš„æ¨¡å—æ˜¯å•çº¿ç¨‹ï¼Œåœ¨å®¢æˆ·ç«¯å¤šä¸ªè¿æ¥å¤šçº¿ç¨‹è°ƒç”¨ç†è®ºä¸Šæ²¡æœ‰æ•ˆæœï¼‰ã€‚\n&lt;6&gt;ï¼šå…³é—­å®¢æˆ·ç«¯ä¸€èˆ¬åº”ç”¨ç¨‹åºåœæ­¢ä¹‹å‰æ“ä½œï¼Œå¦‚æœæ¡ä»¶å…è®¸çš„è¯ï¼ŒåŸºäºåå¼€å…ˆé—­åŸåˆ™ï¼Œå®¢æˆ·ç«¯å…³é—­åº”è¯¥åœ¨è¿æ¥å…³é—­ä¹‹åæ“ä½œã€‚\n\nAPILettuceä¸»è¦æä¾›ä¸‰ç§APIï¼š\n\nåŒæ­¥ï¼ˆsyncï¼‰ï¼šRedisCommandsã€‚\nå¼‚æ­¥ï¼ˆasyncï¼‰ï¼šRedisAsyncCommandsã€‚\nååº”å¼ï¼ˆreactiveï¼‰ï¼šRedisReactiveCommandsã€‚\n\nå…ˆå‡†å¤‡å¥½ä¸€ä¸ªå•æœºRedisè¿æ¥å¤‡ç”¨ï¼š\nprivate static StatefulRedisConnection&lt;String, String&gt; CONNECTION;private static RedisClient CLIENT;@BeforeClasspublic static void beforeClass() &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    CLIENT = RedisClient.create(redisUri);    CONNECTION = CLIENT.connect();&#125;@AfterClasspublic static void afterClass() throws Exception &#123;    CONNECTION.close();    CLIENT.shutdown();&#125;\n\nRediså‘½ä»¤APIçš„å…·ä½“å®ç°å¯ä»¥ç›´æ¥ä»StatefulRedisConnectionå®ä¾‹è·å–ï¼Œè§å…¶æ¥å£å®šä¹‰ï¼š\npublic interface StatefulRedisConnection&lt;K, V&gt; extends StatefulConnection&lt;K, V&gt; &#123;    boolean isMulti();    RedisCommands&lt;K, V&gt; sync();    RedisAsyncCommands&lt;K, V&gt; async();    RedisReactiveCommands&lt;K, V&gt; reactive();&#125;    \n\nå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸æŒ‡å®šç¼–ç è§£ç å™¨RedisCodecçš„å‰æä¸‹ï¼ŒRedisClientåˆ›å»ºçš„StatefulRedisConnectionå®ä¾‹ä¸€èˆ¬æ˜¯æ³›å‹å®ä¾‹StatefulRedisConnection&lt;String,String&gt;ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å‘½ä»¤APIçš„KEYå’ŒVALUEéƒ½æ˜¯Stringç±»å‹ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼èƒ½æ»¡è¶³å¤§éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯ã€‚å½“ç„¶ï¼Œå¿…è¦çš„æ—¶å€™å¯ä»¥å®šåˆ¶ç¼–ç è§£ç å™¨RedisCodec&lt;K,V&gt;ã€‚\nåŒæ­¥APIå…ˆæ„å»ºRedisCommandså®ä¾‹ï¼š\nprivate static RedisCommands&lt;String, String&gt; COMMAND;@BeforeClasspublic static void beforeClass() &#123;    COMMAND = CONNECTION.sync();&#125;\n\nåŸºæœ¬ä½¿ç”¨ï¼š\n@Testpublic void testSyncPing() throws Exception &#123;   String pong = COMMAND.ping();   Assertions.assertThat(pong).isEqualToIgnoringCase(&quot;PONG&quot;);&#125;@Testpublic void testSyncSetAndGet() throws Exception &#123;    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    COMMAND.set(&quot;name&quot;, &quot;throwable&quot;, setArgs);    String value = COMMAND.get(&quot;name&quot;);    log.info(&quot;Get value: &#123;&#125;&quot;, value);&#125;// Get value: throwable\n\nåŒæ­¥APIåœ¨æ‰€æœ‰å‘½ä»¤è°ƒç”¨ä¹‹åä¼šç«‹å³è¿”å›ç»“æœã€‚å¦‚æœç†Ÿæ‚‰Jedisçš„è¯ï¼ŒRedisCommandsçš„ç”¨æ³•å…¶å®å’Œå®ƒç›¸å·®ä¸å¤§ã€‚\nå¼‚æ­¥APIå…ˆæ„å»ºRedisAsyncCommandså®ä¾‹ï¼š\nprivate static RedisAsyncCommands&lt;String, String&gt; ASYNC_COMMAND;@BeforeClasspublic static void beforeClass() &#123;    ASYNC_COMMAND = CONNECTION.async();&#125;\n\nåŸºæœ¬ä½¿ç”¨ï¼š\n@Testpublic void testAsyncPing() throws Exception &#123;    RedisFuture&lt;String&gt; redisFuture = ASYNC_COMMAND.ping();    log.info(&quot;Ping result:&#123;&#125;&quot;, redisFuture.get());&#125;// Ping result:PONG\n\nRedisAsyncCommandsæ‰€æœ‰æ–¹æ³•æ‰§è¡Œè¿”å›ç»“æœéƒ½æ˜¯RedisFutureå®ä¾‹ï¼Œè€ŒRedisFutureæ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š\npublic interface RedisFuture&lt;V&gt; extends CompletionStage&lt;V&gt;, Future&lt;V&gt; &#123;    String getError();    boolean await(long timeout, TimeUnit unit) throws InterruptedException;&#125;    \n\nä¹Ÿå°±æ˜¯ï¼ŒRedisFutureå¯ä»¥æ— ç¼ä½¿ç”¨Futureæˆ–è€…JDK1.8ä¸­å¼•å…¥çš„CompletableFutureæä¾›çš„æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n@Testpublic void testAsyncSetAndGet1() throws Exception &#123;    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    RedisFuture&lt;String&gt; future = ASYNC_COMMAND.set(&quot;name&quot;, &quot;throwable&quot;, setArgs);    // CompletableFuture#thenAccept()    future.thenAccept(value -&gt; log.info(&quot;Setå‘½ä»¤è¿”å›:&#123;&#125;&quot;, value));    // Future#get()    future.get();&#125;// Setå‘½ä»¤è¿”å›:OK@Testpublic void testAsyncSetAndGet2() throws Exception &#123;    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    CompletableFuture&lt;Void&gt; result =            (CompletableFuture&lt;Void&gt;) ASYNC_COMMAND.set(&quot;name&quot;, &quot;throwable&quot;, setArgs)                    .thenAcceptBoth(ASYNC_COMMAND.get(&quot;name&quot;),                            (s, g) -&gt; &#123;                                log.info(&quot;Setå‘½ä»¤è¿”å›:&#123;&#125;&quot;, s);                                log.info(&quot;Getå‘½ä»¤è¿”å›:&#123;&#125;&quot;, g);                            &#125;);    result.get();&#125;// Setå‘½ä»¤è¿”å›:OK// Getå‘½ä»¤è¿”å›:throwable\n\nå¦‚æœèƒ½ç†Ÿç»ƒä½¿ç”¨CompletableFutureå’Œå‡½æ•°å¼ç¼–ç¨‹æŠ€å·§ï¼Œå¯ä»¥ç»„åˆå¤šä¸ªRedisFutureå®Œæˆä¸€äº›åˆ—å¤æ‚çš„æ“ä½œã€‚\nååº”å¼APILettuceå¼•å…¥çš„ååº”å¼ç¼–ç¨‹æ¡†æ¶æ˜¯Project Reactorï¼Œå¦‚æœæ²¡æœ‰ååº”å¼ç¼–ç¨‹ç»éªŒå¯ä»¥å…ˆè‡ªè¡Œäº†è§£ä¸€ä¸‹Project Reactorã€‚\næ„å»ºRedisReactiveCommandså®ä¾‹ï¼š\nprivate static RedisReactiveCommands&lt;String, String&gt; REACTIVE_COMMAND;@BeforeClasspublic static void beforeClass() &#123;    REACTIVE_COMMAND = CONNECTION.reactive();&#125;\n\næ ¹æ®Project Reactorï¼ŒRedisReactiveCommandsçš„æ–¹æ³•å¦‚æœè¿”å›çš„ç»“æœåªåŒ…å«0æˆ–1ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿”å›å€¼ç±»å‹æ˜¯Monoï¼Œå¦‚æœè¿”å›çš„ç»“æœåŒ…å«0åˆ°Nï¼ˆNå¤§äº0ï¼‰ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿”å›å€¼æ˜¯Fluxã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n@Testpublic void testReactivePing() throws Exception &#123;    Mono&lt;String&gt; ping = REACTIVE_COMMAND.ping();    ping.subscribe(v -&gt; log.info(&quot;Ping result:&#123;&#125;&quot;, v));    Thread.sleep(1000);&#125;// Ping result:PONG@Testpublic void testReactiveSetAndGet() throws Exception &#123;    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    REACTIVE_COMMAND.set(&quot;name&quot;, &quot;throwable&quot;, setArgs).block();    REACTIVE_COMMAND.get(&quot;name&quot;).subscribe(value -&gt; log.info(&quot;Getå‘½ä»¤è¿”å›:&#123;&#125;&quot;, value));    Thread.sleep(1000);&#125;// Getå‘½ä»¤è¿”å›:throwable@Testpublic void testReactiveSet() throws Exception &#123;    REACTIVE_COMMAND.sadd(&quot;food&quot;, &quot;bread&quot;, &quot;meat&quot;, &quot;fish&quot;).block();    Flux&lt;String&gt; flux = REACTIVE_COMMAND.smembers(&quot;food&quot;);    flux.subscribe(log::info);    REACTIVE_COMMAND.srem(&quot;food&quot;, &quot;bread&quot;, &quot;meat&quot;, &quot;fish&quot;).block();    Thread.sleep(1000);&#125;// meat// bread// fish\n\nä¸¾ä¸ªæ›´åŠ å¤æ‚çš„ä¾‹å­ï¼ŒåŒ…å«äº†äº‹åŠ¡ã€å‡½æ•°è½¬æ¢ç­‰ï¼š\n@Testpublic void testReactiveFunctional() throws Exception &#123;    REACTIVE_COMMAND.multi().doOnSuccess(r -&gt; &#123;        REACTIVE_COMMAND.set(&quot;counter&quot;, &quot;1&quot;).doOnNext(log::info).subscribe();        REACTIVE_COMMAND.incr(&quot;counter&quot;).doOnNext(c -&gt; log.info(String.valueOf(c))).subscribe();    &#125;).flatMap(s -&gt; REACTIVE_COMMAND.exec())            .doOnNext(transactionResult -&gt; log.info(&quot;Discarded:&#123;&#125;&quot;, transactionResult.wasDiscarded()))            .subscribe();    Thread.sleep(1000);&#125;// OK// 2// Discarded:false\n\nè¿™ä¸ªæ–¹æ³•å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå…ˆæŠŠcounterè®¾ç½®ä¸º1ï¼Œå†å°†counterè‡ªå¢1ã€‚\nå‘å¸ƒå’Œè®¢é˜…éé›†ç¾¤æ¨¡å¼ä¸‹çš„å‘å¸ƒè®¢é˜…ä¾èµ–äºå®šåˆ¶çš„è¿æ¥StatefulRedisPubSubConnectionï¼Œé›†ç¾¤æ¨¡å¼ä¸‹çš„å‘å¸ƒè®¢é˜…ä¾èµ–äºå®šåˆ¶çš„è¿æ¥StatefulRedisClusterPubSubConnectionï¼Œä¸¤è€…åˆ†åˆ«æ¥æºäºRedisClient#connectPubSub()ç³»åˆ—æ–¹æ³•å’ŒRedisClusterClient#connectPubSub()ï¼š\n\néé›†ç¾¤æ¨¡å¼ï¼š\n\n// å¯èƒ½æ˜¯å•æœºã€æ™®é€šä¸»ä»ã€å“¨å…µç­‰éé›†ç¾¤æ¨¡å¼çš„å®¢æˆ·ç«¯RedisClient client = ...StatefulRedisPubSubConnection&lt;String, String&gt; connection = client.connectPubSub();connection.addListener(new RedisPubSubListener&lt;String, String&gt;() &#123; ... &#125;);// åŒæ­¥å‘½ä»¤RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();sync.subscribe(&quot;channel&quot;);// å¼‚æ­¥å‘½ä»¤RedisPubSubAsyncCommands&lt;String, String&gt; async = connection.async();RedisFuture&lt;Void&gt; future = async.subscribe(&quot;channel&quot;);// ååº”å¼å‘½ä»¤RedisPubSubReactiveCommands&lt;String, String&gt; reactive = connection.reactive();reactive.subscribe(&quot;channel&quot;).subscribe();reactive.observeChannels().doOnNext(patternMessage -&gt; &#123;...&#125;).subscribe()\n\n\né›†ç¾¤æ¨¡å¼ï¼š\n\n// ä½¿ç”¨æ–¹å¼å…¶å®å’Œéé›†ç¾¤æ¨¡å¼åŸºæœ¬ä¸€è‡´RedisClusterClient clusterClient = ...StatefulRedisClusterPubSubConnection&lt;String, String&gt; connection = clusterClient.connectPubSub();connection.addListener(new RedisPubSubListener&lt;String, String&gt;() &#123; ... &#125;);RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();sync.subscribe(&quot;channel&quot;);// ...\n\nè¿™é‡Œç”¨å•æœºåŒæ­¥å‘½ä»¤çš„æ¨¡å¼ä¸¾ä¸€ä¸ªRedisé”®ç©ºé—´é€šçŸ¥ï¼ˆRedis Keyspace Notificationsï¼‰çš„ä¾‹å­ï¼š\n@Testpublic void testSyncKeyspaceNotification() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            // æ³¨æ„è¿™é‡Œåªèƒ½æ˜¯0å·åº“            .withDatabase(0)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);    StatefulRedisConnection&lt;String, String&gt; redisConnection = redisClient.connect();    RedisCommands&lt;String, String&gt; redisCommands = redisConnection.sync();    // åªæ¥æ”¶é”®è¿‡æœŸçš„äº‹ä»¶    redisCommands.configSet(&quot;notify-keyspace-events&quot;, &quot;Ex&quot;);    StatefulRedisPubSubConnection&lt;String, String&gt; connection = redisClient.connectPubSub();    connection.addListener(new RedisPubSubAdapter&lt;&gt;() &#123;        @Override        public void psubscribed(String pattern, long count) &#123;            log.info(&quot;pattern:&#123;&#125;,count:&#123;&#125;&quot;, pattern, count);        &#125;        @Override        public void message(String pattern, String channel, String message) &#123;            log.info(&quot;pattern:&#123;&#125;,channel:&#123;&#125;,message:&#123;&#125;&quot;, pattern, channel, message);        &#125;    &#125;);    RedisPubSubCommands&lt;String, String&gt; commands = connection.sync();    commands.psubscribe(&quot;__keyevent@0__:expired&quot;);    redisCommands.setex(&quot;name&quot;, 2, &quot;throwable&quot;);    Thread.sleep(10000);    redisConnection.close();    connection.close();    redisClient.shutdown();&#125;// pattern:__keyevent@0__:expired,count:1// pattern:__keyevent@0__:expired,channel:__keyevent@0__:expired,message:name\n\nå®é™…ä¸Šï¼Œåœ¨å®ç°RedisPubSubListenerçš„æ—¶å€™å¯ä»¥å•ç‹¬æŠ½ç¦»ï¼Œå°½é‡ä¸è¦è®¾è®¡æˆåŒ¿åå†…éƒ¨ç±»çš„å½¢å¼ã€‚\näº‹åŠ¡å’Œæ‰¹é‡å‘½ä»¤æ‰§è¡Œäº‹åŠ¡ç›¸å…³çš„å‘½ä»¤å°±æ˜¯WATCHã€UNWATCHã€EXECã€MULTIå’ŒDISCARDï¼Œåœ¨RedisCommandsç³»åˆ—æ¥å£ä¸­æœ‰å¯¹åº”çš„æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼š\n// åŒæ­¥æ¨¡å¼@Testpublic void testSyncMulti() throws Exception &#123;    COMMAND.multi();    COMMAND.setex(&quot;name-1&quot;, 2, &quot;throwable&quot;);    COMMAND.setex(&quot;name-2&quot;, 2, &quot;doge&quot;);    TransactionResult result = COMMAND.exec();    int index = 0;    for (Object r : result) &#123;        log.info(&quot;Result-&#123;&#125;:&#123;&#125;&quot;, index, r);        index++;    &#125;&#125;// Result-0:OK// Result-1:OK\n\nRedisçš„Pipelineä¹Ÿå°±æ˜¯ç®¡é“æœºåˆ¶å¯ä»¥ç†è§£ä¸ºæŠŠå¤šä¸ªå‘½ä»¤æ‰“åŒ…åœ¨ä¸€æ¬¡è¯·æ±‚å‘é€åˆ°RedisæœåŠ¡ç«¯ï¼Œç„¶åRedisæœåŠ¡ç«¯æŠŠæ‰€æœ‰çš„å“åº”ç»“æœæ‰“åŒ…å¥½ä¸€æ¬¡æ€§è¿”å›ï¼Œä»è€ŒèŠ‚çœä¸å¿…è¦çš„ç½‘ç»œèµ„æºï¼ˆæœ€ä¸»è¦æ˜¯å‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°ï¼‰ã€‚Rediså¯¹äºPipelineæœºåˆ¶å¦‚ä½•å®ç°å¹¶æ²¡æœ‰æ˜ç¡®çš„è§„å®šï¼Œä¹Ÿæ²¡æœ‰æä¾›ç‰¹æ®Šçš„å‘½ä»¤æ”¯æŒPipelineæœºåˆ¶ã€‚Jedisä¸­åº•å±‚é‡‡ç”¨BIOï¼ˆé˜»å¡IOï¼‰é€šè®¯ï¼Œæ‰€ä»¥å®ƒçš„åšæ³•æ˜¯å®¢æˆ·ç«¯ç¼“å­˜å°†è¦å‘é€çš„å‘½ä»¤ï¼Œæœ€åéœ€è¦è§¦å‘ç„¶ååŒæ­¥å‘é€ä¸€ä¸ªå·¨å¤§çš„å‘½ä»¤åˆ—è¡¨åŒ…ï¼Œå†æ¥æ”¶å’Œè§£æä¸€ä¸ªå·¨å¤§çš„å“åº”åˆ—è¡¨åŒ…ã€‚Pipelineåœ¨Lettuceä¸­å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œç”±äºåº•å±‚çš„é€šè®¯æ¡†æ¶æ˜¯Nettyï¼Œæ‰€ä»¥ç½‘ç»œé€šè®¯å±‚é¢çš„ä¼˜åŒ–Lettuceä¸éœ€è¦è¿‡å¤šå¹²é¢„ï¼Œæ¢è¨€ä¹‹å¯ä»¥è¿™æ ·ç†è§£ï¼šNettyå¸®Lettuceä»åº•å±‚å®ç°äº†Redisçš„Pipelineæœºåˆ¶ã€‚ä½†æ˜¯ï¼ŒLettuceçš„å¼‚æ­¥APIä¹Ÿæä¾›äº†æ‰‹åŠ¨Flushçš„æ–¹æ³•ï¼š\n@Testpublic void testAsyncManualFlush() &#123;    // å–æ¶ˆè‡ªåŠ¨flush    ASYNC_COMMAND.setAutoFlushCommands(false);    List&lt;RedisFuture&lt;?&gt;&gt; redisFutures = Lists.newArrayList();    int count = 5000;    for (int i = 0; i &lt; count; i++) &#123;        String key = &quot;key-&quot; + (i + 1);        String value = &quot;value-&quot; + (i + 1);        redisFutures.add(ASYNC_COMMAND.set(key, value));        redisFutures.add(ASYNC_COMMAND.expire(key, 2));    &#125;    long start = System.currentTimeMillis();    ASYNC_COMMAND.flushCommands();    boolean result = LettuceFutures.awaitAll(10, TimeUnit.SECONDS, redisFutures.toArray(new RedisFuture[0]));    Assertions.assertThat(result).isTrue();    log.info(&quot;Lettuce cost:&#123;&#125; ms&quot;, System.currentTimeMillis() - start);&#125;// Lettuce cost:1302 ms\n\nä¸Šé¢åªæ˜¯ä»æ–‡æ¡£çœ‹åˆ°çš„ä¸€äº›ç†è®ºæœ¯è¯­ï¼Œä½†æ˜¯ç°å®æ˜¯éª¨æ„Ÿçš„ï¼Œå¯¹æ¯”äº†ä¸‹Jedisçš„Pipelineæä¾›çš„æ–¹æ³•ï¼Œå‘ç°äº†Jedisçš„Pipelineæ‰§è¡Œè€—æ—¶æ¯”è¾ƒä½ï¼š\n@Testpublic void testJedisPipeline() throws Exception &#123;    Jedis jedis = new Jedis();    Pipeline pipeline = jedis.pipelined();    int count = 5000;    for (int i = 0; i &lt; count; i++) &#123;        String key = &quot;key-&quot; + (i + 1);        String value = &quot;value-&quot; + (i + 1);        pipeline.set(key, value);        pipeline.expire(key, 2);    &#125;    long start = System.currentTimeMillis();    pipeline.syncAndReturnAll();    log.info(&quot;Jedis cost:&#123;&#125; ms&quot;, System.currentTimeMillis()  - start);&#125;// Jedis cost:9 ms\n\nä¸ªäººçŒœæµ‹Lettuceå¯èƒ½åº•å±‚å¹¶éåˆå¹¶æ‰€æœ‰å‘½ä»¤ä¸€æ¬¡å‘é€ï¼ˆç”šè‡³å¯èƒ½æ˜¯å•æ¡å‘é€ï¼‰ï¼Œå…·ä½“å¯èƒ½éœ€è¦æŠ“åŒ…æ‰èƒ½å®šä½ã€‚ä¾æ­¤æ¥çœ‹ï¼Œå¦‚æœçœŸçš„æœ‰å¤§é‡æ‰§è¡ŒRediså‘½ä»¤çš„åœºæ™¯ï¼Œä¸å¦¨å¯ä»¥ä½¿ç”¨Jedisçš„Pipelineã€‚\næ³¨æ„ï¼šç”±ä¸Šé¢çš„æµ‹è¯•æ¨æ–­RedisTemplateçš„executePipelined()æ–¹æ³•æ˜¯** å‡çš„Â **Pipelineæ‰§è¡Œæ–¹æ³•ï¼Œä½¿ç”¨RedisTemplateçš„æ—¶å€™è¯·åŠ¡å¿…æ³¨æ„è¿™ä¸€ç‚¹ã€‚\nLuaè„šæœ¬æ‰§è¡ŒLettuceä¸­æ‰§è¡ŒRedisçš„Luaå‘½ä»¤çš„åŒæ­¥æ¥å£å¦‚ä¸‹ï¼š\npublic interface RedisScriptingCommands&lt;K, V&gt; &#123;    &lt;T&gt; T eval(String var1, ScriptOutputType var2, K... var3);    &lt;T&gt; T eval(String var1, ScriptOutputType var2, K[] var3, V... var4);    &lt;T&gt; T evalsha(String var1, ScriptOutputType var2, K... var3);    &lt;T&gt; T evalsha(String var1, ScriptOutputType var2, K[] var3, V... var4);    List&lt;Boolean&gt; scriptExists(String... var1);    String scriptFlush();    String scriptKill();    String scriptLoad(V var1);    String digest(V var1);&#125;\n\nå¼‚æ­¥å’Œååº”å¼çš„æ¥å£æ–¹æ³•å®šä¹‰å·®ä¸å¤šï¼Œä¸åŒçš„åœ°æ–¹å°±æ˜¯è¿”å›å€¼ç±»å‹ï¼Œä¸€èˆ¬æˆ‘ä»¬å¸¸ç”¨çš„æ˜¯eval()ã€evalsha()å’ŒscriptLoad()æ–¹æ³•ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š\nprivate static RedisCommands&lt;String, String&gt; COMMANDS;private static String RAW_LUA = &quot;local key = KEYS[1]\\n&quot; +        &quot;local value = ARGV[1]\\n&quot; +        &quot;local timeout = ARGV[2]\\n&quot; +        &quot;redis.call(&#x27;SETEX&#x27;, key, tonumber(timeout), value)\\n&quot; +        &quot;local result = redis.call(&#x27;GET&#x27;, key)\\n&quot; +        &quot;return result;&quot;;private static AtomicReference&lt;String&gt; LUA_SHA = new AtomicReference&lt;&gt;();@Testpublic void testLua() throws Exception &#123;    LUA_SHA.compareAndSet(null, COMMANDS.scriptLoad(RAW_LUA));    String[] keys = new String[]&#123;&quot;name&quot;&#125;;    String[] args = new String[]&#123;&quot;throwable&quot;, &quot;5000&quot;&#125;;    String result = COMMANDS.evalsha(LUA_SHA.get(), ScriptOutputType.VALUE, keys, args);    log.info(&quot;Get value:&#123;&#125;&quot;, result);&#125;// Get value:throwable\n\né«˜å¯ç”¨å’Œåˆ†ç‰‡ä¸ºäº†Redisçš„é«˜å¯ç”¨ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨æ™®é€šä¸»ä»ï¼ˆMaster/Replicaï¼Œè¿™é‡Œç¬”è€…ç§°ä¸ºæ™®é€šä¸»ä»æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ä»…ä»…åšäº†ä¸»ä»å¤åˆ¶ï¼Œæ•…éšœéœ€è¦æ‰‹åŠ¨åˆ‡æ¢ï¼‰ã€å“¨å…µå’Œé›†ç¾¤ã€‚æ™®é€šä¸»ä»æ¨¡å¼å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ä»¥é…åˆå“¨å…µè¿è¡Œï¼Œåªæ˜¯å“¨å…µæä¾›è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œä¸»èŠ‚ç‚¹æå‡åŠŸèƒ½ã€‚æ™®é€šä¸»ä»å’Œå“¨å…µéƒ½å¯ä»¥ä½¿ç”¨MasterSlaveï¼Œé€šè¿‡å…¥å‚åŒ…æ‹¬RedisClientã€ç¼–ç è§£ç å™¨ä»¥åŠä¸€ä¸ªæˆ–è€…å¤šä¸ªRedisURIè·å–å¯¹åº”çš„Connectionå®ä¾‹ã€‚\nè¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼ŒMasterSlaveä¸­æä¾›çš„æ–¹æ³•å¦‚æœåªè¦æ±‚ä¼ å…¥ä¸€ä¸ªRedisURIå®ä¾‹ï¼Œé‚£ä¹ˆLettuceä¼šè¿›è¡Œæ‹“æ‰‘å‘ç°æœºåˆ¶ï¼Œè‡ªåŠ¨è·å–Redisä¸»ä»èŠ‚ç‚¹ä¿¡æ¯ï¼›å¦‚æœè¦æ±‚ä¼ å…¥ä¸€ä¸ªRedisURIé›†åˆï¼Œé‚£ä¹ˆå¯¹äºæ™®é€šä¸»ä»æ¨¡å¼æ¥è¯´æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯æ˜¯é™æ€çš„ï¼Œä¸ä¼šè¿›è¡Œå‘ç°å’Œæ›´æ–°ã€‚\næ‹“æ‰‘å‘ç°çš„è§„åˆ™å¦‚ä¸‹ï¼š\n\nå¯¹äºæ™®é€šä¸»ä»ï¼ˆMaster/Replicaï¼‰æ¨¡å¼ï¼Œä¸éœ€è¦æ„ŸçŸ¥RedisURIæŒ‡å‘ä»èŠ‚ç‚¹è¿˜æ˜¯ä¸»èŠ‚ç‚¹ï¼Œåªä¼šè¿›è¡Œä¸€æ¬¡æ€§çš„æ‹“æ‰‘æŸ¥æ‰¾æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ­¤åèŠ‚ç‚¹ä¿¡æ¯ä¼šä¿å­˜åœ¨é™æ€ç¼“å­˜ä¸­ï¼Œä¸ä¼šæ›´æ–°ã€‚\nå¯¹äºå“¨å…µæ¨¡å¼ï¼Œä¼šè®¢é˜…æ‰€æœ‰å“¨å…µå®ä¾‹å¹¶ä¾¦å¬è®¢é˜…/å‘å¸ƒæ¶ˆæ¯ä»¥è§¦å‘æ‹“æ‰‘åˆ·æ–°æœºåˆ¶ï¼Œæ›´æ–°ç¼“å­˜çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å“¨å…µå¤©ç„¶å°±æ˜¯åŠ¨æ€å‘ç°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸æ”¯æŒé™æ€é…ç½®ã€‚\n\næ‹“æ‰‘å‘ç°æœºåˆ¶çš„æä¾›APIä¸ºTopologyProviderï¼Œéœ€è¦äº†è§£å…¶åŸç†çš„å¯ä»¥å‚è€ƒå…·ä½“çš„å®ç°ã€‚\nå¯¹äºé›†ç¾¤ï¼ˆClusterï¼‰æ¨¡å¼ï¼ŒLettuceæä¾›äº†ä¸€å¥—ç‹¬ç«‹çš„APIã€‚\nå¦å¤–ï¼Œå¦‚æœLettuceè¿æ¥é¢å‘çš„æ˜¯éå•ä¸ªRedisèŠ‚ç‚¹ï¼Œè¿æ¥å®ä¾‹æä¾›äº†æ•°æ®è¯»å–èŠ‚ç‚¹åå¥½ï¼ˆReadFromï¼‰è®¾ç½®ï¼Œå¯é€‰å€¼æœ‰ï¼š\n\nMASTERï¼šåªä»MasterèŠ‚ç‚¹ä¸­è¯»å–ã€‚\nMASTER_PREFERREDï¼šä¼˜å…ˆä»MasterèŠ‚ç‚¹ä¸­è¯»å–ã€‚\nSLAVE_PREFERREDï¼šä¼˜å…ˆä»SlavorèŠ‚ç‚¹ä¸­è¯»å–ã€‚\nSLAVEï¼šåªä»SlavorèŠ‚ç‚¹ä¸­è¯»å–ã€‚\nNEARESTï¼šä½¿ç”¨æœ€è¿‘ä¸€æ¬¡è¿æ¥çš„Rediså®ä¾‹è¯»å–ã€‚\n\næ™®é€šä¸»ä»æ¨¡å¼å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªRedisæœåŠ¡å½¢æˆæ ‘çŠ¶ä¸»ä»å…³ç³»å¦‚ä¸‹ï¼š\n\nèŠ‚ç‚¹ä¸€ï¼šlocalhost:6379ï¼Œè§’è‰²ä¸ºMasterã€‚\nèŠ‚ç‚¹äºŒï¼šlocalhost:6380ï¼Œè§’è‰²ä¸ºSlavorï¼ŒèŠ‚ç‚¹ä¸€çš„ä»èŠ‚ç‚¹ã€‚\nèŠ‚ç‚¹ä¸‰ï¼šlocalhost:6381ï¼Œè§’è‰²ä¸ºSlavorï¼ŒèŠ‚ç‚¹äºŒçš„ä»èŠ‚ç‚¹ã€‚\n\né¦–æ¬¡åŠ¨æ€èŠ‚ç‚¹å‘ç°ä¸»ä»æ¨¡å¼çš„èŠ‚ç‚¹ä¿¡æ¯éœ€è¦å¦‚ä¸‹æ„å»ºè¿æ¥ï¼š\n@Testpublic void testDynamicReplica() throws Exception &#123;    // è¿™é‡Œåªéœ€è¦é…ç½®ä¸€ä¸ªèŠ‚ç‚¹çš„è¿æ¥ä¿¡æ¯ï¼Œä¸ä¸€å®šéœ€è¦æ˜¯ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥    RedisURI uri = RedisURI.builder().withHost(&quot;localhost&quot;).withPort(6379).build();    RedisClient redisClient = RedisClient.create(uri);    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), uri);    // åªä»ä»èŠ‚ç‚¹è¯»å–æ•°æ®    connection.setReadFrom(ReadFrom.SLAVE);    // æ‰§è¡Œå…¶ä»–Rediså‘½ä»¤    connection.close();    redisClient.shutdown();&#125;\n\nå¦‚æœéœ€è¦æŒ‡å®šé™æ€çš„Redisä¸»ä»èŠ‚ç‚¹è¿æ¥å±æ€§ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·æ„å»ºè¿æ¥ï¼š\n@Testpublic void testStaticReplica() throws Exception &#123;    List&lt;RedisURI&gt; uris = new ArrayList&lt;&gt;();    RedisURI uri1 = RedisURI.builder().withHost(&quot;localhost&quot;).withPort(6379).build();    RedisURI uri2 = RedisURI.builder().withHost(&quot;localhost&quot;).withPort(6380).build();    RedisURI uri3 = RedisURI.builder().withHost(&quot;localhost&quot;).withPort(6381).build();    uris.add(uri1);    uris.add(uri2);    uris.add(uri3);    RedisClient redisClient = RedisClient.create();    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient,            new Utf8StringCodec(), uris);    // åªä»ä¸»èŠ‚ç‚¹è¯»å–æ•°æ®    connection.setReadFrom(ReadFrom.MASTER);    // æ‰§è¡Œå…¶ä»–Rediså‘½ä»¤    connection.close();    redisClient.shutdown();&#125;\n\nå“¨å…µæ¨¡å¼ç”±äºLettuceè‡ªèº«æä¾›äº†å“¨å…µçš„æ‹“æ‰‘å‘ç°æœºåˆ¶ï¼Œæ‰€ä»¥åªéœ€è¦éšä¾¿é…ç½®ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹çš„RedisURIå®ä¾‹å³å¯ï¼š\n@Testpublic void testDynamicSentinel() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withPassword(&quot;ä½ çš„å¯†ç &quot;)            .withSentinel(&quot;localhost&quot;, 26379)            .withSentinelMasterId(&quot;å“¨å…µMasterçš„ID&quot;)            .build();    RedisClient redisClient = RedisClient.create();    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), redisUri);    // åªå…è®¸ä»ä»èŠ‚ç‚¹è¯»å–æ•°æ®    connection.setReadFrom(ReadFrom.SLAVE);    RedisCommands&lt;String, String&gt; command = connection.sync();    SetArgs setArgs = SetArgs.Builder.nx().ex(5);    command.set(&quot;name&quot;, &quot;throwable&quot;, setArgs);    String value = command.get(&quot;name&quot;);    log.info(&quot;Get value:&#123;&#125;&quot;, value);&#125;// Get value:throwable\n\né›†ç¾¤æ¨¡å¼é‰´äºç¬”è€…å¯¹Redisé›†ç¾¤æ¨¡å¼å¹¶ä¸ç†Ÿæ‚‰ï¼ŒClusteræ¨¡å¼ä¸‹çš„APIä½¿ç”¨æœ¬èº«å°±æœ‰æ¯”è¾ƒå¤šçš„é™åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œåªç®€å•ä»‹ç»ä¸€ä¸‹æ€ä¹ˆç”¨ã€‚å…ˆè¯´å‡ ä¸ªç‰¹æ€§ï¼š\nä¸‹é¢çš„APIæä¾›è·¨æ§½ä½ï¼ˆSlotï¼‰è°ƒç”¨çš„åŠŸèƒ½ï¼š\n\nRedisAdvancedClusterCommandsã€‚\nRedisAdvancedClusterAsyncCommandsã€‚\nRedisAdvancedClusterReactiveCommandsã€‚\n\né™æ€èŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½ï¼š\n\nmastersï¼šé€‰æ‹©æ‰€æœ‰ä¸»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ã€‚\nslavesï¼šé€‰æ‹©æ‰€æœ‰ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼Œå…¶å®å°±æ˜¯åªè¯»æ¨¡å¼ã€‚\nall nodesï¼šå‘½ä»¤å¯ä»¥åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œã€‚\n\né›†ç¾¤æ‹“æ‰‘è§†å›¾åŠ¨æ€æ›´æ–°åŠŸèƒ½ï¼š\n\næ‰‹åŠ¨æ›´æ–°ï¼Œä¸»åŠ¨è°ƒç”¨RedisClusterClient#reloadPartitions()ã€‚\nåå°å®šæ—¶æ›´æ–°ã€‚\nè‡ªé€‚åº”æ›´æ–°ï¼ŒåŸºäºè¿æ¥æ–­å¼€å’ŒMOVED/ASKå‘½ä»¤é‡å®šå‘è‡ªåŠ¨æ›´æ–°ã€‚\n\nRedisé›†ç¾¤æ­å»ºè¯¦ç»†è¿‡ç¨‹å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå‡è®¾å·²ç»æ­å»ºå¥½é›†ç¾¤å¦‚ä¸‹ï¼ˆ192.168.56.200æ˜¯ç¬”è€…çš„è™šæ‹ŸæœºHostï¼‰ï¼š\n\n192.168.56.200:7001 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½0-5460ã€‚\n192.168.56.200:7002 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½5461-10922ã€‚\n192.168.56.200:7003 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½10923-16383ã€‚\n192.168.56.200:7004 =&gt; 7001çš„ä»èŠ‚ç‚¹ã€‚\n192.168.56.200:7005 =&gt; 7002çš„ä»èŠ‚ç‚¹ã€‚\n192.168.56.200:7006 =&gt; 7003çš„ä»èŠ‚ç‚¹ã€‚\n\nç®€å•çš„é›†ç¾¤è¿æ¥å’Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š\n@Testpublic void testSyncCluster()&#123;    RedisURI uri = RedisURI.builder().withHost(&quot;192.168.56.200&quot;).build();    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();    commands.setex(&quot;name&quot;,10, &quot;throwable&quot;);    String value = commands.get(&quot;name&quot;);    log.info(&quot;Get value:&#123;&#125;&quot;, value);&#125;// Get value:throwable\n\nèŠ‚ç‚¹é€‰æ‹©ï¼š\n@Testpublic void testSyncNodeSelection() &#123;    RedisURI uri = RedisURI.builder().withHost(&quot;192.168.56.200&quot;).withPort(7001).build();    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();//  commands.all();  // æ‰€æœ‰èŠ‚ç‚¹//  commands.masters();  // ä¸»èŠ‚ç‚¹    // ä»èŠ‚ç‚¹åªè¯»    NodeSelection&lt;String, String&gt; replicas = commands.slaves();    NodeSelectionCommands&lt;String, String&gt; nodeSelectionCommands = replicas.commands();    // è¿™é‡Œåªæ˜¯æ¼”ç¤º,ä¸€èˆ¬åº”è¯¥ç¦ç”¨keys *å‘½ä»¤    Executions&lt;List&lt;String&gt;&gt; keys = nodeSelectionCommands.keys(&quot;*&quot;);    keys.forEach(key -&gt; log.info(&quot;key: &#123;&#125;&quot;, key));    connection.close();    redisClusterClient.shutdown();&#125;\n\nå®šæ—¶æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾ï¼ˆæ¯éš”ååˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶é—´è‡ªè¡Œè€ƒé‡ï¼Œä¸èƒ½å¤ªé¢‘ç¹ï¼‰ï¼š\n@Testpublic void testPeriodicClusterTopology() throws Exception &#123;    RedisURI uri = RedisURI.builder().withHost(&quot;192.168.56.200&quot;).withPort(7001).build();    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);    ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions            .builder()            .enablePeriodicRefresh(Duration.of(10, ChronoUnit.MINUTES))            .build();    redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build());    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();    commands.setex(&quot;name&quot;, 10, &quot;throwable&quot;);    String value = commands.get(&quot;name&quot;);    log.info(&quot;Get value:&#123;&#125;&quot;, value);    Thread.sleep(Integer.MAX_VALUE);    connection.close();    redisClusterClient.shutdown();&#125;\n\nè‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾ï¼š\n@Testpublic void testAdaptiveClusterTopology() throws Exception &#123;    RedisURI uri = RedisURI.builder().withHost(&quot;192.168.56.200&quot;).withPort(7001).build();    RedisClusterClient redisClusterClient = RedisClusterClient.create(uri);    ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions.builder()            .enableAdaptiveRefreshTrigger(                    ClusterTopologyRefreshOptions.RefreshTrigger.MOVED_REDIRECT,                    ClusterTopologyRefreshOptions.RefreshTrigger.PERSISTENT_RECONNECTS            )            .adaptiveRefreshTriggersTimeout(Duration.of(30, ChronoUnit.SECONDS))            .build();    redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build());    StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect();    RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();    commands.setex(&quot;name&quot;, 10, &quot;throwable&quot;);    String value = commands.get(&quot;name&quot;);    log.info(&quot;Get value:&#123;&#125;&quot;, value);    Thread.sleep(Integer.MAX_VALUE);    connection.close();    redisClusterClient.shutdown();&#125;\n\nåŠ¨æ€å‘½ä»¤å’Œè‡ªå®šä¹‰å‘½ä»¤è‡ªå®šä¹‰å‘½ä»¤æ˜¯Rediså‘½ä»¤æœ‰é™é›†ï¼Œä¸è¿‡å¯ä»¥æ›´ç»†ç²’åº¦æŒ‡å®šKEYã€ARGVã€å‘½ä»¤ç±»å‹ã€ç¼–ç è§£ç å™¨å’Œè¿”å›å€¼ç±»å‹ï¼Œä¾èµ–äºdispatch()æ–¹æ³•ï¼š\n// è‡ªå®šä¹‰å®ç°PINGæ–¹æ³•@Testpublic void testCustomPing() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();    RedisCommands&lt;String, String&gt; sync = connect.sync();    RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8;    String result = sync.dispatch(CommandType.PING, new StatusOutput&lt;&gt;(codec));    log.info(&quot;PING:&#123;&#125;&quot;, result);    connect.close();    redisClient.shutdown();&#125;// PING:PONG// è‡ªå®šä¹‰å®ç°Setæ–¹æ³•@Testpublic void testCustomSet() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();    RedisCommands&lt;String, String&gt; sync = connect.sync();    RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8;    sync.dispatch(CommandType.SETEX, new StatusOutput&lt;&gt;(codec),            new CommandArgs&lt;&gt;(codec).addKey(&quot;name&quot;).add(5).addValue(&quot;throwable&quot;));    String result = sync.get(&quot;name&quot;);    log.info(&quot;Get value:&#123;&#125;&quot;, result);    connect.close();    redisClient.shutdown();&#125;// Get value:throwable\n\nåŠ¨æ€å‘½ä»¤æ˜¯åŸºäºRediså‘½ä»¤æœ‰é™é›†ï¼Œå¹¶ä¸”é€šè¿‡æ³¨è§£å’ŒåŠ¨æ€ä»£ç†å®Œæˆä¸€äº›å¤æ‚å‘½ä»¤ç»„åˆçš„å®ç°ã€‚ä¸»è¦æ³¨è§£åœ¨io.lettuce.core.dynamic.annotationåŒ…è·¯å¾„ä¸‹ã€‚ç®€å•ä¸¾ä¸ªä¾‹å­ï¼š\npublic interface CustomCommand extends Commands &#123;    // SET [key] [value]    @Command(&quot;SET ?0 ?1&quot;)    String setKey(String key, String value);    // SET [key] [value]    @Command(&quot;SET :key :value&quot;)    String setKeyNamed(@Param(&quot;key&quot;) String key, @Param(&quot;value&quot;) String value);    // MGET [key1] [key2]    @Command(&quot;MGET ?0 ?1&quot;)    List&lt;String&gt; mGet(String key1, String key2);    /**     * æ–¹æ³•åä½œä¸ºå‘½ä»¤     */    @CommandNaming(strategy = CommandNaming.Strategy.METHOD_NAME)    String mSet(String key1, String value1, String key2, String value2);&#125;@Testpublic void testCustomDynamicSet() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);    StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();    RedisCommandFactory commandFactory = new RedisCommandFactory(connect);    CustomCommand commands = commandFactory.getCommands(CustomCommand.class);    commands.setKey(&quot;name&quot;, &quot;throwable&quot;);    commands.setKeyNamed(&quot;throwable&quot;, &quot;doge&quot;);    log.info(&quot;MGET ===&gt; &quot; + commands.mGet(&quot;name&quot;, &quot;throwable&quot;));    commands.mSet(&quot;key1&quot;, &quot;value1&quot;,&quot;key2&quot;, &quot;value2&quot;);    log.info(&quot;MGET ===&gt; &quot; + commands.mGet(&quot;key1&quot;, &quot;key2&quot;));    connect.close();    redisClient.shutdown();&#125;// MGET ===&gt; [throwable, doge]// MGET ===&gt; [value1, value2]\n\né«˜é˜¶ç‰¹æ€§Lettuceæœ‰å¾ˆå¤šé«˜é˜¶ä½¿ç”¨ç‰¹æ€§ï¼Œè¿™é‡Œåªåˆ—ä¸¾ä¸ªäººè®¤ä¸ºå¸¸ç”¨çš„ä¸¤ç‚¹ï¼š\n\né…ç½®å®¢æˆ·ç«¯èµ„æºã€‚\nä½¿ç”¨è¿æ¥æ± ã€‚\n\næ›´å¤šå…¶ä»–ç‰¹æ€§å¯ä»¥è‡ªè¡Œå‚çœ‹å®˜æ–¹æ–‡æ¡£ã€‚\né…ç½®å®¢æˆ·ç«¯èµ„æºå®¢æˆ·ç«¯èµ„æºçš„è®¾ç½®ä¸Lettuceçš„æ€§èƒ½ã€å¹¶å‘å’Œäº‹ä»¶å¤„ç†ç›¸å…³ã€‚çº¿ç¨‹æ± æˆ–è€…çº¿ç¨‹ç»„ç›¸å…³é…ç½®å æ®å®¢æˆ·ç«¯èµ„æºé…ç½®çš„å¤§éƒ¨åˆ†ï¼ˆEventLoopGroupså’ŒEventExecutorGroupï¼‰ï¼Œè¿™äº›çº¿ç¨‹æ± æˆ–è€…çº¿ç¨‹ç»„æ˜¯è¿æ¥ç¨‹åºçš„åŸºç¡€ç»„ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯èµ„æºåº”è¯¥åœ¨å¤šä¸ªRediså®¢æˆ·ç«¯ä¹‹é—´å…±äº«ï¼Œå¹¶ä¸”åœ¨ä¸å†ä½¿ç”¨çš„æ—¶å€™éœ€è¦è‡ªè¡Œå…³é—­ã€‚ç¬”è€…è®¤ä¸ºï¼Œå®¢æˆ·ç«¯èµ„æºæ˜¯é¢å‘Nettyçš„ã€‚æ³¨æ„ï¼šé™¤éç‰¹åˆ«ç†Ÿæ‚‰æˆ–è€…èŠ±é•¿æ—¶é—´å»æµ‹è¯•è°ƒæ•´ä¸‹é¢æåˆ°çš„å‚æ•°ï¼Œå¦åˆ™åœ¨æ²¡æœ‰ç»éªŒçš„å‰æä¸‹å‡­ç›´è§‰ä¿®æ”¹é»˜è®¤å€¼ï¼Œæœ‰å¯èƒ½ä¼šè¸©å‘ã€‚\nå®¢æˆ·ç«¯èµ„æºæ¥å£æ˜¯ClientResourcesï¼Œå®ç°ç±»æ˜¯DefaultClientResourcesã€‚\næ„å»ºDefaultClientResourceså®ä¾‹ï¼š\n// é»˜è®¤ClientResources resources = DefaultClientResources.create();// å»ºé€ å™¨ClientResources resources = DefaultClientResources.builder()                        .ioThreadPoolSize(4)                        .computationThreadPoolSize(4)                        .build()\n\nä½¿ç”¨ï¼š\nClientResources resources = DefaultClientResources.create();// éé›†ç¾¤RedisClient client = RedisClient.create(resources, uri);// é›†ç¾¤RedisClusterClient clusterClient = RedisClusterClient.create(resources, uris);// ......client.shutdown();clusterClient.shutdown();// å…³é—­èµ„æºresources.shutdown();\n\nå®¢æˆ·ç«¯èµ„æºåŸºæœ¬é…ç½®ï¼š\n\n\n\nå±æ€§\næè¿°\né»˜è®¤å€¼\n\n\n\nioThreadPoolSize\nI/Oçº¿ç¨‹æ•°\nRuntime.getRuntime().availableProcessors()\n\n\ncomputationThreadPoolSize\nä»»åŠ¡çº¿ç¨‹æ•°\nRuntime.getRuntime().availableProcessors()\n\n\nå®¢æˆ·ç«¯èµ„æºé«˜çº§é…ç½®ï¼š\n\n\n\nå±æ€§\næè¿°\né»˜è®¤å€¼\n\n\n\neventLoopGroupProvider\nEventLoopGroupæä¾›å•†\n-\n\n\neventExecutorGroupProvider\nEventExecutorGroupæä¾›å•†\n-\n\n\neventBus\näº‹ä»¶æ€»çº¿\nDefaultEventBus\n\n\ncommandLatencyCollectorOptions\nå‘½ä»¤å»¶æ—¶æ”¶é›†å™¨é…ç½®\nDefaultCommandLatencyCollectorOptions\n\n\ncommandLatencyCollector\nå‘½ä»¤å»¶æ—¶æ”¶é›†å™¨\nDefaultCommandLatencyCollector\n\n\ncommandLatencyPublisherOptions\nå‘½ä»¤å»¶æ—¶å‘å¸ƒå™¨é…ç½®\nDefaultEventPublisherOptions\n\n\ndnsResolver\nDNSå¤„ç†å™¨\nJDKæˆ–è€…Nettyæä¾›\n\n\nreconnectDelay\né‡è¿å»¶æ—¶é…ç½®\nDelay.exponential()\n\n\nnettyCustomizer\nNettyè‡ªå®šä¹‰é…ç½®å™¨\n-\n\n\ntracing\nè½¨è¿¹è®°å½•å™¨\n-\n\n\néé›†ç¾¤å®¢æˆ·ç«¯RedisClientçš„å±æ€§é…ç½®ï¼š\nRediséé›†ç¾¤å®¢æˆ·ç«¯RedisClientæœ¬èº«æä¾›äº†é…ç½®å±æ€§æ–¹æ³•ï¼š\nRedisClient client = RedisClient.create(uri);client.setOptions(ClientOptions.builder()                       .autoReconnect(false)                       .pingBeforeActivateConnection(true)                       .build());\n\néé›†ç¾¤å®¢æˆ·ç«¯çš„é…ç½®å±æ€§åˆ—è¡¨ï¼š\n\n\n\nå±æ€§\næè¿°\né»˜è®¤å€¼\n\n\n\npingBeforeActivateConnection\nè¿æ¥æ¿€æ´»ä¹‹å‰æ˜¯å¦æ‰§è¡ŒPINGå‘½ä»¤\nfalse\n\n\nautoReconnect\næ˜¯å¦è‡ªåŠ¨é‡è¿\ntrue\n\n\ncancelCommandsOnReconnectFailure\né‡è¿å¤±è´¥æ˜¯å¦æ‹’ç»å‘½ä»¤æ‰§è¡Œ\nfalse\n\n\nsuspendReconnectOnProtocolFailure\nåº•å±‚åè®®å¤±è´¥æ˜¯å¦æŒ‚èµ·é‡è¿æ“ä½œ\nfalse\n\n\nrequestQueueSize\nè¯·æ±‚é˜Ÿåˆ—å®¹é‡\n2147483647(Integer#MAX_VALUE)\n\n\ndisconnectedBehavior\nå¤±å»è¿æ¥æ—¶å€™çš„è¡Œä¸º\nDEFAULT\n\n\nsslOptions\nSSLé…ç½®\n-\n\n\nsocketOptions\nSocketé…ç½®\n10 seconds Connection-Timeout, no keep-alive, no TCP noDelay\n\n\ntimeoutOptions\nè¶…æ—¶é…ç½®\n-\n\n\npublishOnScheduler\nå‘å¸ƒååº”å¼ä¿¡å·æ•°æ®çš„è°ƒåº¦å™¨\nä½¿ç”¨I/Oçº¿ç¨‹\n\n\né›†ç¾¤å®¢æˆ·ç«¯å±æ€§é…ç½®ï¼š\nRedisé›†ç¾¤å®¢æˆ·ç«¯RedisClusterClientæœ¬èº«æä¾›äº†é…ç½®å±æ€§æ–¹æ³•ï¼š\nRedisClusterClient client = RedisClusterClient.create(uri);ClusterTopologyRefreshOptions topologyRefreshOptions = ClusterTopologyRefreshOptions.builder()                .enablePeriodicRefresh(refreshPeriod(10, TimeUnit.MINUTES))                .enableAllAdaptiveRefreshTriggers()                .build();client.setOptions(ClusterClientOptions.builder()                       .topologyRefreshOptions(topologyRefreshOptions)                       .build());\n\né›†ç¾¤å®¢æˆ·ç«¯çš„é…ç½®å±æ€§åˆ—è¡¨ï¼š\n\n\n\nå±æ€§\næè¿°\né»˜è®¤å€¼\n\n\n\nenablePeriodicRefresh\næ˜¯å¦å…è®¸å‘¨æœŸæ€§æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾\nfalse\n\n\nrefreshPeriod\næ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾å‘¨æœŸ\n60ç§’\n\n\nenableAdaptiveRefreshTrigger\nè®¾ç½®è‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘å™¨RefreshTrigger\n-\n\n\nadaptiveRefreshTriggersTimeout\nè‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘å™¨è¶…æ—¶è®¾ç½®\n30ç§’\n\n\nrefreshTriggersReconnectAttempts\nè‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘é‡è¿æ¬¡æ•°\n5\n\n\ndynamicRefreshSources\næ˜¯å¦å…è®¸åŠ¨æ€åˆ·æ–°æ‹“æ‰‘èµ„æº\ntrue\n\n\ncloseStaleConnections\næ˜¯å¦å…è®¸å…³é—­é™ˆæ—§çš„è¿æ¥\ntrue\n\n\nmaxRedirects\né›†ç¾¤é‡å®šå‘æ¬¡æ•°ä¸Šé™\n5\n\n\nvalidateClusterNodeMembership\næ˜¯å¦æ ¡éªŒé›†ç¾¤èŠ‚ç‚¹çš„æˆå‘˜å…³ç³»\ntrue\n\n\nä½¿ç”¨è¿æ¥æ± å¼•å…¥è¿æ¥æ± ä¾èµ–commons-pool2ï¼š\n&lt;dependency&gt;    &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;    &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;    &lt;version&gt;2.7.0&lt;/version&gt;&lt;/dependency\n\nåŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š\n@Testpublic void testUseConnectionPool() throws Exception &#123;    RedisURI redisUri = RedisURI.builder()            .withHost(&quot;localhost&quot;)            .withPort(6379)            .withTimeout(Duration.of(10, ChronoUnit.SECONDS))            .build();    RedisClient redisClient = RedisClient.create(redisUri);    GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig();    GenericObjectPool&lt;StatefulRedisConnection&lt;String, String&gt;&gt; pool            = ConnectionPoolSupport.createGenericObjectPool(redisClient::connect, poolConfig);    try (StatefulRedisConnection&lt;String, String&gt; connection = pool.borrowObject()) &#123;        RedisCommands&lt;String, String&gt; command = connection.sync();        SetArgs setArgs = SetArgs.Builder.nx().ex(5);        command.set(&quot;name&quot;, &quot;throwable&quot;, setArgs);        String n = command.get(&quot;name&quot;);        log.info(&quot;Get value:&#123;&#125;&quot;, n);    &#125;    pool.close();    redisClient.shutdown();&#125;\n\nå…¶ä¸­ï¼ŒåŒæ­¥è¿æ¥çš„æ± åŒ–æ”¯æŒéœ€è¦ç”¨ConnectionPoolSupportï¼Œå¼‚æ­¥è¿æ¥çš„æ± åŒ–æ”¯æŒéœ€è¦ç”¨AsyncConnectionPoolSupportï¼ˆLettuce5.1ä¹‹åæ‰æ”¯æŒï¼‰ã€‚\nå‡ ä¸ªå¸¸è§çš„æ¸è¿›å¼åˆ é™¤ä¾‹å­æ¸è¿›å¼åˆ é™¤Hashä¸­çš„åŸŸ-å±æ€§ï¼š\n@Testpublic void testDelBigHashKey() throws Exception &#123;    // SCANå‚æ•°    ScanArgs scanArgs = ScanArgs.Builder.limit(2);    // TEMPæ¸¸æ ‡    ScanCursor cursor = ScanCursor.INITIAL;    // ç›®æ ‡KEY    String key = &quot;BIG_HASH_KEY&quot;;    prepareHashTestData(key);    log.info(&quot;å¼€å§‹æ¸è¿›å¼åˆ é™¤Hashçš„å…ƒç´ ...&quot;);    int counter = 0;    do &#123;        MapScanCursor&lt;String, String&gt; result = COMMAND.hscan(key, cursor, scanArgs);        // é‡ç½®TEMPæ¸¸æ ‡        cursor = ScanCursor.of(result.getCursor());        cursor.setFinished(result.isFinished());        Collection&lt;String&gt; fields = result.getMap().values();        if (!fields.isEmpty()) &#123;            COMMAND.hdel(key, fields.toArray(new String[0]));        &#125;        counter++;    &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));    log.info(&quot;æ¸è¿›å¼åˆ é™¤Hashçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...&quot;, counter);&#125;private void prepareHashTestData(String key) throws Exception &#123;    COMMAND.hset(key, &quot;1&quot;, &quot;1&quot;);    COMMAND.hset(key, &quot;2&quot;, &quot;2&quot;);    COMMAND.hset(key, &quot;3&quot;, &quot;3&quot;);    COMMAND.hset(key, &quot;4&quot;, &quot;4&quot;);    COMMAND.hset(key, &quot;5&quot;, &quot;5&quot;);&#125;\n\næ¸è¿›å¼åˆ é™¤é›†åˆä¸­çš„å…ƒç´ ï¼š\n@Testpublic void testDelBigSetKey() throws Exception &#123;    String key = &quot;BIG_SET_KEY&quot;;    prepareSetTestData(key);    // SCANå‚æ•°    ScanArgs scanArgs = ScanArgs.Builder.limit(2);    // TEMPæ¸¸æ ‡    ScanCursor cursor = ScanCursor.INITIAL;    log.info(&quot;å¼€å§‹æ¸è¿›å¼åˆ é™¤Setçš„å…ƒç´ ...&quot;);    int counter = 0;    do &#123;        ValueScanCursor&lt;String&gt; result = COMMAND.sscan(key, cursor, scanArgs);        // é‡ç½®TEMPæ¸¸æ ‡        cursor = ScanCursor.of(result.getCursor());        cursor.setFinished(result.isFinished());        List&lt;String&gt; values = result.getValues();        if (!values.isEmpty()) &#123;            COMMAND.srem(key, values.toArray(new String[0]));        &#125;        counter++;    &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));    log.info(&quot;æ¸è¿›å¼åˆ é™¤Setçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...&quot;, counter);&#125;private void prepareSetTestData(String key) throws Exception &#123;    COMMAND.sadd(key, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;);&#125;\n\næ¸è¿›å¼åˆ é™¤æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼š\n@Testpublic void testDelBigZSetKey() throws Exception &#123;    // SCANå‚æ•°    ScanArgs scanArgs = ScanArgs.Builder.limit(2);    // TEMPæ¸¸æ ‡    ScanCursor cursor = ScanCursor.INITIAL;    // ç›®æ ‡KEY    String key = &quot;BIG_ZSET_KEY&quot;;    prepareZSetTestData(key);    log.info(&quot;å¼€å§‹æ¸è¿›å¼åˆ é™¤ZSetçš„å…ƒç´ ...&quot;);    int counter = 0;    do &#123;        ScoredValueScanCursor&lt;String&gt; result = COMMAND.zscan(key, cursor, scanArgs);        // é‡ç½®TEMPæ¸¸æ ‡        cursor = ScanCursor.of(result.getCursor());        cursor.setFinished(result.isFinished());        List&lt;ScoredValue&lt;String&gt;&gt; scoredValues = result.getValues();        if (!scoredValues.isEmpty()) &#123;            COMMAND.zrem(key, scoredValues.stream().map(ScoredValue&lt;String&gt;::getValue).toArray(String[]::new));        &#125;        counter++;    &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished()));    log.info(&quot;æ¸è¿›å¼åˆ é™¤ZSetçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...&quot;, counter);&#125;private void prepareZSetTestData(String key) throws Exception &#123;    COMMAND.zadd(key, 0, &quot;1&quot;);    COMMAND.zadd(key, 0, &quot;2&quot;);    COMMAND.zadd(key, 0, &quot;3&quot;);    COMMAND.zadd(key, 0, &quot;4&quot;);    COMMAND.zadd(key, 0, &quot;5&quot;);&#125;\n\nåœ¨SpringBootä¸­ä½¿ç”¨Lettuceä¸ªäººè®¤ä¸ºï¼Œspring-data-redisä¸­çš„APIå°è£…å¹¶ä¸æ˜¯å¾ˆä¼˜ç§€ï¼Œç”¨èµ·æ¥æ¯”è¾ƒé‡ï¼Œä¸å¤Ÿçµæ´»ï¼Œè¿™é‡Œç»“åˆå‰é¢çš„ä¾‹å­å’Œä»£ç ï¼Œåœ¨SpringBootè„šæ‰‹æ¶é¡¹ç›®ä¸­é…ç½®å’Œæ•´åˆLettuceã€‚å…ˆå¼•å…¥ä¾èµ–ï¼š\n&lt;dependencyManagement&gt;    &lt;dependencies&gt;        &lt;dependency&gt;            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;            &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt;            &lt;version&gt;2.1.8.RELEASE&lt;/version&gt;            &lt;type&gt;pom&lt;/type&gt;            &lt;scope&gt;import&lt;/scope&gt;        &lt;/dependency&gt;    &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;    &lt;/dependency&gt;            &lt;dependency&gt;        &lt;groupId&gt;io.lettuce&lt;/groupId&gt;        &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt;        &lt;version&gt;5.1.8.RELEASE&lt;/version&gt;    &lt;/dependency&gt;    &lt;dependency&gt;        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;        &lt;artifactId&gt;lombok&lt;/artifactId&gt;        &lt;version&gt;1.18.10&lt;/version&gt;        &lt;scope&gt;provided&lt;/scope&gt;    &lt;/dependency&gt;&lt;/dependencies&gt;        \n\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåº”ç”¨åº”è¯¥ä½¿ç”¨å•ä¸ªRediså®¢æˆ·ç«¯å®ä¾‹å’Œå•ä¸ªè¿æ¥å®ä¾‹ï¼Œè¿™é‡Œè®¾è®¡ä¸€ä¸ªè„šæ‰‹æ¶ï¼Œé€‚é…å•æœºã€æ™®é€šä¸»ä»ã€å“¨å…µå’Œé›†ç¾¤å››ç§ä½¿ç”¨åœºæ™¯ã€‚å¯¹äºå®¢æˆ·ç«¯èµ„æºï¼Œé‡‡ç”¨é»˜è®¤çš„å®ç°å³å¯ã€‚å¯¹äºRedisçš„è¿æ¥å±æ€§ï¼Œæ¯”è¾ƒä¸»è¦çš„æœ‰Hostã€Portå’ŒPasswordï¼Œå…¶ä»–å¯ä»¥æš‚æ—¶å¿½ç•¥ã€‚åŸºäºçº¦å®šå¤§äºé…ç½®çš„åŸåˆ™ï¼Œå…ˆå®šåˆ¶ä¸€ç³»åˆ—å±æ€§é…ç½®ç±»ï¼ˆå…¶å®æœ‰äº›é…ç½®æ˜¯å¯ä»¥å®Œå…¨å…±ç”¨ï¼Œä½†æ˜¯è€ƒè™‘åˆ°è¦æ¸…æ™°æè¿°ç±»ä¹‹é—´çš„å…³ç³»ï¼Œè¿™é‡Œæ‹†åˆ†å¤šä¸ªé…ç½®å±æ€§ç±»å’Œå¤šä¸ªé…ç½®æ–¹æ³•ï¼‰ï¼š\n@Data@ConfigurationProperties(prefix = &quot;lettuce&quot;)public class LettuceProperties &#123;    private LettuceSingleProperties single;    private LettuceReplicaProperties replica;    private LettuceSentinelProperties sentinel;    private LettuceClusterProperties cluster;&#125;@Datapublic class LettuceSingleProperties &#123;    private String host;    private Integer port;    private String password;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceReplicaProperties extends LettuceSingleProperties &#123;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceSentinelProperties extends LettuceSingleProperties &#123;    private String masterId;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceClusterProperties extends LettuceSingleProperties &#123;&#125;\n\né…ç½®ç±»å¦‚ä¸‹ï¼Œä¸»è¦ä½¿ç”¨@ConditionalOnPropertyåšéš”ç¦»ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¾ˆå°‘æœ‰äººä¼šåœ¨ä¸€ä¸ªåº”ç”¨ä½¿ç”¨ä¸€ç§ä»¥ä¸Šçš„Redisè¿æ¥åœºæ™¯ï¼š\n@RequiredArgsConstructor@Configuration@ConditionalOnClass(name = &quot;io.lettuce.core.RedisURI&quot;)@EnableConfigurationProperties(value = LettuceProperties.class)public class LettuceAutoConfiguration &#123;    private final LettuceProperties lettuceProperties;    @Bean(destroyMethod = &quot;shutdown&quot;)    public ClientResources clientResources() &#123;        return DefaultClientResources.create();    &#125;    @Bean    @ConditionalOnProperty(name = &quot;lettuce.single.host&quot;)    public RedisURI singleRedisUri() &#123;        LettuceSingleProperties singleProperties = lettuceProperties.getSingle();        return RedisURI.builder()                .withHost(singleProperties.getHost())                .withPort(singleProperties.getPort())                .withPassword(singleProperties.getPassword())                .build();    &#125;    @Bean(destroyMethod = &quot;shutdown&quot;)    @ConditionalOnProperty(name = &quot;lettuce.single.host&quot;)    public RedisClient singleRedisClient(ClientResources clientResources, @Qualifier(&quot;singleRedisUri&quot;) RedisURI redisUri) &#123;        return RedisClient.create(clientResources, redisUri);    &#125;    @Bean(destroyMethod = &quot;close&quot;)    @ConditionalOnProperty(name = &quot;lettuce.single.host&quot;)    public StatefulRedisConnection&lt;String, String&gt; singleRedisConnection(@Qualifier(&quot;singleRedisClient&quot;) RedisClient singleRedisClient) &#123;        return singleRedisClient.connect();    &#125;    @Bean    @ConditionalOnProperty(name = &quot;lettuce.replica.host&quot;)    public RedisURI replicaRedisUri() &#123;        LettuceReplicaProperties replicaProperties = lettuceProperties.getReplica();        return RedisURI.builder()                .withHost(replicaProperties.getHost())                .withPort(replicaProperties.getPort())                .withPassword(replicaProperties.getPassword())                .build();    &#125;    @Bean(destroyMethod = &quot;shutdown&quot;)    @ConditionalOnProperty(name = &quot;lettuce.replica.host&quot;)    public RedisClient replicaRedisClient(ClientResources clientResources, @Qualifier(&quot;replicaRedisUri&quot;) RedisURI redisUri) &#123;        return RedisClient.create(clientResources, redisUri);    &#125;    @Bean(destroyMethod = &quot;close&quot;)    @ConditionalOnProperty(name = &quot;lettuce.replica.host&quot;)    public StatefulRedisMasterSlaveConnection&lt;String, String&gt; replicaRedisConnection(@Qualifier(&quot;replicaRedisClient&quot;) RedisClient replicaRedisClient,                                                                                     @Qualifier(&quot;replicaRedisUri&quot;) RedisURI redisUri) &#123;        return MasterSlave.connect(replicaRedisClient, new Utf8StringCodec(), redisUri);    &#125;    @Bean    @ConditionalOnProperty(name = &quot;lettuce.sentinel.host&quot;)    public RedisURI sentinelRedisUri() &#123;        LettuceSentinelProperties sentinelProperties = lettuceProperties.getSentinel();        return RedisURI.builder()                .withPassword(sentinelProperties.getPassword())                .withSentinel(sentinelProperties.getHost(), sentinelProperties.getPort())                .withSentinelMasterId(sentinelProperties.getMasterId())                .build();    &#125;    @Bean(destroyMethod = &quot;shutdown&quot;)    @ConditionalOnProperty(name = &quot;lettuce.sentinel.host&quot;)    public RedisClient sentinelRedisClient(ClientResources clientResources, @Qualifier(&quot;sentinelRedisUri&quot;) RedisURI redisUri) &#123;        return RedisClient.create(clientResources, redisUri);    &#125;    @Bean(destroyMethod = &quot;close&quot;)    @ConditionalOnProperty(name = &quot;lettuce.sentinel.host&quot;)    public StatefulRedisMasterSlaveConnection&lt;String, String&gt; sentinelRedisConnection(@Qualifier(&quot;sentinelRedisClient&quot;) RedisClient sentinelRedisClient,                                                                                      @Qualifier(&quot;sentinelRedisUri&quot;) RedisURI redisUri) &#123;        return MasterSlave.connect(sentinelRedisClient, new Utf8StringCodec(), redisUri);    &#125;    @Bean    @ConditionalOnProperty(name = &quot;lettuce.cluster.host&quot;)    public RedisURI clusterRedisUri() &#123;        LettuceClusterProperties clusterProperties = lettuceProperties.getCluster();        return RedisURI.builder()                .withHost(clusterProperties.getHost())                .withPort(clusterProperties.getPort())                .withPassword(clusterProperties.getPassword())                .build();    &#125;    @Bean(destroyMethod = &quot;shutdown&quot;)    @ConditionalOnProperty(name = &quot;lettuce.cluster.host&quot;)    public RedisClusterClient redisClusterClient(ClientResources clientResources, @Qualifier(&quot;clusterRedisUri&quot;) RedisURI redisUri) &#123;        return RedisClusterClient.create(clientResources, redisUri);    &#125;    @Bean(destroyMethod = &quot;close&quot;)    @ConditionalOnProperty(name = &quot;lettuce.cluster&quot;)    public StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection(RedisClusterClient clusterClient) &#123;        return clusterClient.connect();    &#125;&#125;\n\næœ€åä¸ºäº†è®©IDEè¯†åˆ«æˆ‘ä»¬çš„é…ç½®ï¼Œå¯ä»¥æ·»åŠ IDEäº²ç¼˜æ€§ï¼Œ/META-INFæ–‡ä»¶å¤¹ä¸‹æ–°å¢ä¸€ä¸ªæ–‡ä»¶spring-configuration-metadata.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š\n&#123;  &quot;properties&quot;: [    &#123;      &quot;name&quot;: &quot;lettuce.single&quot;,      &quot;type&quot;: &quot;club.throwable.spring.lettuce.LettuceSingleProperties&quot;,      &quot;description&quot;: &quot;å•æœºé…ç½®&quot;,      &quot;sourceType&quot;: &quot;club.throwable.spring.lettuce.LettuceProperties&quot;    &#125;,    &#123;      &quot;name&quot;: &quot;lettuce.replica&quot;,      &quot;type&quot;: &quot;club.throwable.spring.lettuce.LettuceReplicaProperties&quot;,      &quot;description&quot;: &quot;ä¸»ä»é…ç½®&quot;,      &quot;sourceType&quot;: &quot;club.throwable.spring.lettuce.LettuceProperties&quot;    &#125;,    &#123;      &quot;name&quot;: &quot;lettuce.sentinel&quot;,      &quot;type&quot;: &quot;club.throwable.spring.lettuce.LettuceSentinelProperties&quot;,      &quot;description&quot;: &quot;å“¨å…µé…ç½®&quot;,      &quot;sourceType&quot;: &quot;club.throwable.spring.lettuce.LettuceProperties&quot;    &#125;,    &#123;      &quot;name&quot;: &quot;lettuce.single&quot;,      &quot;type&quot;: &quot;club.throwable.spring.lettuce.LettuceClusterProperties&quot;,      &quot;description&quot;: &quot;é›†ç¾¤é…ç½®&quot;,      &quot;sourceType&quot;: &quot;club.throwable.spring.lettuce.LettuceProperties&quot;    &#125;  ]&#125;\n\nå¦‚æœæƒ³IDEäº²ç¼˜æ€§åšå¾—æ›´å¥½ï¼Œå¯ä»¥æ·»åŠ /META-INF/additional-spring-configuration-metadata.jsonè¿›è¡Œæ›´å¤šç»†èŠ‚å®šä¹‰ã€‚ç®€å•ä½¿ç”¨å¦‚ä¸‹ï¼š\n@Slf4j@Componentpublic class RedisCommandLineRunner implements CommandLineRunner &#123;    @Autowired    @Qualifier(&quot;singleRedisConnection&quot;)    private StatefulRedisConnection&lt;String, String&gt; connection;    @Override    public void run(String... args) throws Exception &#123;        RedisCommands&lt;String, String&gt; redisCommands = connection.sync();        redisCommands.setex(&quot;name&quot;, 5, &quot;throwable&quot;);        log.info(&quot;Get value:&#123;&#125;&quot;, redisCommands.get(&quot;name&quot;));    &#125;&#125;// Get value:throwable\n\nå°ç»“æœ¬æ–‡ç®—æ˜¯åŸºäºLettuceçš„å®˜æ–¹æ–‡æ¡£ï¼Œå¯¹å®ƒçš„ä½¿ç”¨è¿›è¡Œå…¨æ–¹ä½çš„åˆ†æï¼ŒåŒ…æ‹¬ä¸»è¦åŠŸèƒ½ã€é…ç½®éƒ½åšäº†ä¸€äº›ç¤ºä¾‹ï¼Œé™äºç¯‡å¹…éƒ¨åˆ†ç‰¹æ€§å’Œé…ç½®ç»†èŠ‚æ²¡æœ‰åˆ†æã€‚Lettuceå·²ç»è¢«spring-data-redisæ¥çº³ä½œä¸ºå®˜æ–¹çš„Rediså®¢æˆ·ç«¯é©±åŠ¨ï¼Œæ‰€ä»¥å€¼å¾—ä¿¡èµ–ï¼Œå®ƒçš„ä¸€äº›APIè®¾è®¡ç¡®å®æ¯”è¾ƒåˆç†ï¼Œæ‰©å±•æ€§é«˜çš„åŒæ—¶çµæ´»æ€§ä¹Ÿé«˜ã€‚ä¸ªäººå»ºè®®ï¼ŒåŸºäºLettuceåŒ…è‡ªè¡Œæ·»åŠ é…ç½®åˆ°SpringBootåº”ç”¨ç”¨èµ·æ¥ä¼šå¾—å¿ƒåº”æ‰‹ï¼Œæ¯•ç«ŸRedisTemplateå®åœ¨å¤ªç¬¨é‡ï¼Œè€Œä¸”è¿˜å±è”½äº†Lettuceä¸€äº›é«˜çº§ç‰¹æ€§å’Œçµæ´»çš„APIã€‚\nå‚è€ƒèµ„æ–™ï¼š\n\nLettuce Reference Guide\n\nåŸæ–‡é“¾æ¥ï¼šhttps://www.cnblogs.com/throwable/p/11601538.html\n","categories":["è¿ç»´","Redis"]},{"title":"å¿«é€Ÿéƒ¨ç½² Redis","url":"/posts/9379/","content":"ä¸€ã€Docker éƒ¨ç½² Redis1. å•æœº Redisdocker run -d -p 6379:6379 --name redis-s redis:latest redis-server --appendonly no --requirepass abc123\n\n\nappendonlyï¼šæ˜¯å¦å¼€å¯æŒä¹…åŒ–\nrequirepassï¼šå¯†ç \n\n2. é›†ç¾¤ Redisdocker run -d -e &quot;IP=0.0.0.0&quot; -p 7000-7005:7000-7005 --name redis grokzen/redis-cluster\n\nIP=0.0.0.0 è®¾ç½®çš„æ˜¯é›†ç¾¤ä¸­ Redis çš„ IPï¼Œ0.0.0.0 è¡¨ç¤ºä¸º 127.0.0.1ã€‚è‹¥é…ç½®é”™è¯¯ä¼šå¯¼è‡´å®¢æˆ·ç«¯åœ¨è¯»å–æ‹“æ‰‘å›¾æ—¶æ— æ³•è®¿é—®åˆ°å„ä¸ªredisèŠ‚ç‚¹ã€‚\näºŒã€K8S éƒ¨ç½² Redis1. é›†ç¾¤ Rediscat &lt;&lt;EOF | kubectl -f -kind: ServiceapiVersion: v1metadata:  name: redis-clusterspec:  type: NodePort  ports:  - name: redis1    port: 7000    nodePort: 31070    targetPort: 7000    protocol: TCP  - name: redis2    port: 7001    nodePort: 31071    targetPort: 7001    protocol: TCP  - name: redis3    port: 7002    nodePort: 31072    targetPort: 7002    protocol: TCP  - name: redis4    port: 7003    nodePort: 31073    targetPort: 7003    protocol: TCP  - name: redis5    port: 7004    nodePort: 31074    targetPort: 7004    protocol: TCP  - name: redis6    port: 7005    nodePort: 31075    targetPort: 7005    protocol: TCP  selector:    name: redis-cluster---apiVersion: apps/v1kind: Deploymentmetadata:  name: redis-clusterspec:  replicas: 1  selector:    matchLabels:      name: redis-cluster  template:    metadata:      labels:        name: redis-cluster    spec:      containers:      - name: redis-cluster        image: grokzen/redis-cluster        imagePullPolicy: IfNotPresent        ports:        - containerPort: 7000          name: redis1          protocol: TCP        - containerPort: 7001          name: redis2          protocol: TCP        - containerPort: 7002          name: redis3          protocol: TCP        - containerPort: 7003          name: redis4          protocol: TCP        - containerPort: 7004          name: redis5          protocol: TCP        - containerPort: 7005          name: redis6          protocol: TCPEOF\n\n","categories":["è¿ç»´","Redis"]},{"title":"å¿«é€Ÿéƒ¨ç½² Zookeeper","url":"/posts/29635/","content":"Docker éƒ¨ç½² Zookeeperdocker run -d -e TZ=&quot;Asia/Shanghai&quot; -p 2181:2181 --name zk zookeeper\n\n","categories":["è¿ç»´","Zookeeper"]},{"title":"Elasticsearch è¯¦è§£","url":"/posts/30870/","content":"ä¸€ã€ç”Ÿæ´»ä¸­çš„æ•°æ®æœç´¢å¼•æ“æ˜¯å¯¹æ•°æ®çš„æ£€ç´¢ï¼Œæ‰€ä»¥æˆ‘ä»¬å…ˆä»ç”Ÿæ´»ä¸­çš„æ•°æ®è¯´èµ·ã€‚\næˆ‘ä»¬ç”Ÿæ´»ä¸­çš„æ•°æ®æ€»ä½“åˆ†ä¸ºä¸¤ç§ï¼šç»“æ„åŒ–æ•°æ® å’Œ éç»“æ„åŒ–æ•°æ® ã€‚\nç»“æ„åŒ–æ•°æ® ï¼šä¹Ÿç§°ä½œè¡Œæ•°æ®ï¼Œæ˜¯ç”±äºŒç»´è¡¨ç»“æ„æ¥é€»è¾‘è¡¨è¾¾å’Œå®ç°çš„æ•°æ®ï¼Œä¸¥æ ¼åœ°éµå¾ªæ•°æ®æ ¼å¼ä¸é•¿åº¦è§„èŒƒï¼Œä¸»è¦é€šè¿‡å…³ç³»å‹æ•°æ®åº“è¿›è¡Œå­˜å‚¨å’Œç®¡ç†ã€‚æŒ‡å…·æœ‰å›ºå®šæ ¼å¼æˆ–æœ‰é™é•¿åº¦çš„æ•°æ®ï¼Œå¦‚æ•°æ®åº“ï¼Œå…ƒæ•°æ®ç­‰ã€‚\néç»“æ„åŒ–æ•°æ® ï¼šåˆå¯ç§°ä¸ºå…¨æ–‡æ•°æ®ï¼Œä¸å®šé•¿æˆ–æ— å›ºå®šæ ¼å¼ï¼Œä¸é€‚äºç”±æ•°æ®åº“äºŒç»´è¡¨æ¥è¡¨ç°ï¼ŒåŒ…æ‹¬æ‰€æœ‰æ ¼å¼çš„åŠå…¬æ–‡æ¡£ã€XMLã€HTMLã€wordæ–‡æ¡£ï¼Œé‚®ä»¶ï¼Œå„ç±»æŠ¥è¡¨ã€å›¾ç‰‡å’Œå’…é¢‘ã€è§†é¢‘ä¿¡æ¯ç­‰ã€‚\n\nè¯´æ˜ï¼šå¦‚æœè¦æ›´ç»†è‡´çš„åŒºåˆ†çš„è¯ï¼ŒXMLã€HTMLå¯åˆ’åˆ†ä¸º åŠç»“æ„åŒ–æ•°æ® ã€‚å› ä¸ºå®ƒä»¬ä¹Ÿå…·æœ‰è‡ªå·±ç‰¹å®šçš„æ ‡ç­¾æ ¼å¼ï¼Œæ‰€ä»¥æ—¢å¯ä»¥æ ¹æ®éœ€è¦æŒ‰ç»“æ„åŒ–æ•°æ®æ¥å¤„ç†ï¼Œä¹Ÿå¯æŠ½å–å‡ºçº¯æ–‡æœ¬æŒ‰éç»“æ„åŒ–æ•°æ®æ¥å¤„ç†ã€‚\n\næ ¹æ®ä¸¤ç§æ•°æ®åˆ†ç±»ï¼Œæœç´¢ä¹Ÿç›¸åº”çš„åˆ†ä¸ºä¸¤ç§ï¼šç»“æ„åŒ–æ•°æ®æœç´¢ å’Œéç»“æ„åŒ–æ•°æ®æœç´¢ ã€‚\nå¯¹äºç»“æ„åŒ–æ•°æ®ï¼Œå› ä¸ºå®ƒä»¬å…·æœ‰ç‰¹å®šçš„ç»“æ„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯å¯ä»¥é€šè¿‡å…³ç³»å‹æ•°æ®åº“ï¼ˆmysqlï¼Œoracleç­‰ï¼‰çš„ äºŒç»´è¡¨ï¼ˆtableï¼‰çš„æ–¹å¼å­˜å‚¨å’Œæœç´¢ï¼Œä¹Ÿå¯ä»¥å»ºç«‹ç´¢å¼•ã€‚\nå¯¹äºéç»“æ„åŒ–æ•°æ®ï¼Œä¹Ÿå³å¯¹å…¨æ–‡æ•°æ®çš„æœç´¢ä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼šé¡ºåºæ‰«ææ³• ï¼Œå…¨æ–‡æ£€ç´¢ ã€‚\né¡ºåºæ‰«æ ï¼šé€šè¿‡æ–‡å­—åç§°ä¹Ÿå¯äº†è§£åˆ°å®ƒçš„å¤§æ¦‚æœç´¢æ–¹å¼ï¼Œå³æŒ‰ç…§é¡ºåºæ‰«æçš„æ–¹å¼æŸ¥è¯¢ç‰¹å®šçš„å…³é”®å­—ã€‚ä¾‹å¦‚ç»™ä½ ä¸€å¼ æŠ¥çº¸ï¼Œè®©ä½ æ‰¾åˆ°è¯¥æŠ¥çº¸ä¸­â€œå¹³å®‰â€çš„æ–‡å­—åœ¨å“ªäº›åœ°æ–¹å‡ºç°è¿‡ã€‚ä½ è‚¯å®šéœ€è¦ä»å¤´åˆ°å°¾æŠŠæŠ¥çº¸é˜…è¯»æ‰«æä¸€éç„¶åæ ‡è®°å‡ºå…³é”®å­—åœ¨å“ªäº›ç‰ˆå—å‡ºç°è¿‡ä»¥åŠå®ƒçš„å‡ºç°ä½ç½®ã€‚\nè¿™ç§æ–¹å¼æ— ç–‘æ˜¯æœ€è€—æ—¶çš„æœ€ä½æ•ˆçš„ï¼Œå¦‚æœæŠ¥çº¸æ’ç‰ˆå­—ä½“å°ï¼Œè€Œä¸”ç‰ˆå—è¾ƒå¤šç”šè‡³æœ‰å¤šä»½æŠ¥çº¸ï¼Œç­‰ä½ æ‰«æå®Œä½ çš„çœ¼ç›ä¹Ÿå·®ä¸å¤šäº†ã€‚\nå…¨æ–‡æœç´¢ ï¼šå¯¹éç»“æ„åŒ–æ•°æ®é¡ºåºæ‰«æå¾ˆæ…¢ï¼Œæˆ‘ä»¬æ˜¯å¦å¯ä»¥è¿›è¡Œä¼˜åŒ–ï¼ŸæŠŠæˆ‘ä»¬çš„éç»“æ„åŒ–æ•°æ®æƒ³åŠæ³•å¼„å¾—æœ‰ä¸€å®šç»“æ„ä¸å°±è¡Œäº†å—ï¼Ÿå°†éç»“æ„åŒ–æ•°æ®ä¸­çš„ä¸€éƒ¨åˆ†ä¿¡æ¯æå–å‡ºæ¥ï¼Œé‡æ–°ç»„ç»‡ï¼Œä½¿å…¶å˜å¾—æœ‰ä¸€å®šç»“æ„ï¼Œç„¶åå¯¹æ­¤æœ‰ä¸€å®šç»“æ„çš„æ•°æ®è¿›è¡Œæœç´¢ï¼Œä»è€Œè¾¾åˆ°æœç´¢ç›¸å¯¹è¾ƒå¿«çš„ç›®çš„ã€‚\nè¿™ç§æ–¹å¼å°±æ„æˆäº†å…¨æ–‡æ£€ç´¢çš„åŸºæœ¬æ€è·¯ã€‚è¿™éƒ¨åˆ†ä»éç»“æ„åŒ–æ•°æ®ä¸­æå–å‡ºçš„ç„¶åé‡æ–°ç»„ç»‡çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬ç§°ä¹‹ç´¢å¼• ã€‚è¿™ç§æ–¹å¼çš„ä¸»è¦å·¥ä½œé‡åœ¨å‰æœŸç´¢å¼•çš„åˆ›å»ºï¼Œä½†æ˜¯å¯¹äºåæœŸæœç´¢å´æ˜¯å¿«é€Ÿé«˜æ•ˆçš„ã€‚\näºŒã€å…ˆè¯´è¯´ Luceneé€šè¿‡å¯¹ç”Ÿæ´»ä¸­æ•°æ®çš„ç±»å‹ä½œäº†ä¸€ä¸ªç®€çŸ­äº†è§£ä¹‹åï¼Œæˆ‘ä»¬çŸ¥é“å…³ç³»å‹æ•°æ®åº“çš„SQLæ£€ç´¢æ˜¯å¤„ç†ä¸äº†è¿™ç§éç»“æ„åŒ–æ•°æ®çš„ã€‚è¿™ç§éç»“æ„åŒ–æ•°æ®çš„å¤„ç†éœ€è¦ä¾èµ–å…¨æ–‡æœç´¢ï¼Œè€Œç›®å‰å¸‚åœºä¸Šå¼€æ”¾æºä»£ç çš„æœ€å¥½å…¨æ–‡æ£€ç´¢å¼•æ“å·¥å…·åŒ…å°±å±äº apache çš„ Luceneäº†ã€‚\nä½†æ˜¯ Lucene åªæ˜¯ä¸€ä¸ªå·¥å…·åŒ…ï¼Œå®ƒä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„å…¨æ–‡æ£€ç´¢å¼•æ“ã€‚Luceneçš„ç›®çš„æ˜¯ä¸ºè½¯ä»¶å¼€å‘äººå‘˜æä¾›ä¸€ä¸ªç®€å•æ˜“ç”¨çš„å·¥å…·åŒ…ï¼Œä»¥æ–¹ä¾¿çš„åœ¨ç›®æ ‡ç³»ç»Ÿä¸­å®ç°å…¨æ–‡æ£€ç´¢çš„åŠŸèƒ½ï¼Œæˆ–è€…æ˜¯ä»¥æ­¤ä¸ºåŸºç¡€å»ºç«‹èµ·å®Œæ•´çš„å…¨æ–‡æ£€ç´¢å¼•æ“ã€‚\nç›®å‰ä»¥ Lucene ä¸ºåŸºç¡€å»ºç«‹çš„å¼€æºå¯ç”¨å…¨æ–‡æœç´¢å¼•æ“ä¸»è¦æ˜¯ Solr å’Œ Elasticsearchã€‚\nSolr å’Œ Elasticsearch éƒ½æ˜¯æ¯”è¾ƒæˆç†Ÿçš„å…¨æ–‡æœç´¢å¼•æ“ï¼Œèƒ½å®Œæˆçš„åŠŸèƒ½å’Œæ€§èƒ½ä¹ŸåŸºæœ¬ä¸€æ ·ã€‚ä½†æ˜¯ ES æœ¬èº«å°±å…·æœ‰åˆ†å¸ƒå¼çš„ç‰¹æ€§å’Œæ˜“å®‰è£…ä½¿ç”¨çš„ç‰¹ç‚¹ï¼Œè€ŒSolrçš„åˆ†å¸ƒå¼éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹æ¥å®ç°ï¼Œä¾‹å¦‚é€šè¿‡ä½¿ç”¨ZooKeeperæ¥è¾¾åˆ°åˆ†å¸ƒå¼åè°ƒç®¡ç†ã€‚\nä¸ç®¡æ˜¯ Solr è¿˜æ˜¯ Elasticsearch åº•å±‚éƒ½æ˜¯ä¾èµ–äº Luceneï¼Œè€Œ Lucene èƒ½å®ç°å…¨æ–‡æœç´¢ä¸»è¦æ˜¯å› ä¸ºå®ƒå®ç°äº†å€’æ’ç´¢å¼• çš„æŸ¥è¯¢ç»“æ„ã€‚\nå¦‚ä½•ç†è§£å€’æ’ç´¢å¼•å‘¢ï¼Ÿå‡å¦‚ç°æœ‰ä¸‰ä»½æ•°æ®æ–‡æ¡£ï¼Œæ–‡æ¡£çš„å†…å®¹å¦‚ä¸‹åˆ†åˆ«æ˜¯ï¼š\n\nJava is the best programming language.\nPHP is the best programming language.\nJavascript is the best programming language.\n\nä¸ºäº†åˆ›å»ºå€’æ’ç´¢å¼•ï¼Œæˆ‘ä»¬é€šè¿‡åˆ†è¯å™¨å°†æ¯ä¸ªæ–‡æ¡£çš„å†…å®¹åŸŸæ‹†åˆ†æˆå•ç‹¬çš„è¯ï¼ˆæˆ‘ä»¬ç§°å®ƒä¸ºè¯æ¡æˆ– Termï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰ä¸é‡å¤è¯æ¡çš„æ’åºåˆ—è¡¨ï¼Œç„¶ååˆ—å‡ºæ¯ä¸ªè¯æ¡å‡ºç°åœ¨å“ªä¸ªæ–‡æ¡£ã€‚ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š\nTerm          Doc_1    Doc_2   Doc_3-------------------------------------Java        |   X   |        |is          |   X   |   X    |   Xthe         |   X   |   X    |   Xbest        |   X   |   X    |   Xprogramming |   x   |   X    |   Xlanguage    |   X   |   X    |   XPHP         |       |   X    |Javascript  |       |        |   X-------------------------------------\n\nè¿™ç§ç»“æ„ç”±æ–‡æ¡£ä¸­æ‰€æœ‰ä¸é‡å¤è¯çš„åˆ—è¡¨æ„æˆï¼Œå¯¹äºå…¶ä¸­æ¯ä¸ªè¯éƒ½æœ‰ä¸€ä¸ªæ–‡æ¡£åˆ—è¡¨ä¸ä¹‹å…³è”ã€‚è¿™ç§ç”±å±æ€§å€¼æ¥ç¡®å®šè®°å½•çš„ä½ç½®çš„ç»“æ„å°±æ˜¯å€’æ’ç´¢å¼• ã€‚å¸¦æœ‰å€’æ’ç´¢å¼•çš„æ–‡ä»¶æˆ‘ä»¬ç§°ä¸ºå€’æ’æ–‡ä»¶ã€‚\næˆ‘ä»¬å°†ä¸Šé¢çš„å†…å®¹è½¬æ¢ä¸ºå›¾çš„å½¢å¼æ¥è¯´æ˜å€’æ’ç´¢å¼•çš„ç»“æ„ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ\n\nå…¶ä¸­ä¸»è¦æœ‰å¦‚ä¸‹å‡ ä¸ªæ ¸å¿ƒæœ¯è¯­éœ€è¦ç†è§£ï¼š\n\nè¯æ¡(Term) ï¼šç´¢å¼•é‡Œé¢æœ€å°çš„å­˜å‚¨å’ŒæŸ¥è¯¢å•å…ƒï¼Œå¯¹äºè‹±æ–‡æ¥è¯´æ˜¯ä¸€ä¸ªå•è¯ï¼Œå¯¹äºä¸­æ–‡æ¥è¯´ä¸€èˆ¬æŒ‡åˆ†è¯åçš„ä¸€ä¸ªè¯ã€‚\nè¯å…¸(Term Dictionary) ï¼šæˆ–å­—å…¸ï¼Œæ˜¯è¯æ¡Termçš„é›†åˆã€‚æœç´¢å¼•æ“çš„é€šå¸¸ç´¢å¼•å•ä½æ˜¯å•è¯ï¼Œå•è¯è¯å…¸æ˜¯ç”±æ–‡æ¡£é›†åˆä¸­å‡ºç°è¿‡çš„æ‰€æœ‰å•è¯æ„æˆçš„å­—ç¬¦ä¸²é›†åˆï¼Œå•è¯è¯å…¸å†…æ¯æ¡ç´¢å¼•é¡¹è®°è½½å•è¯æœ¬èº«çš„ä¸€äº›ä¿¡æ¯ä»¥åŠæŒ‡å‘â€œå€’æ’åˆ—è¡¨â€çš„æŒ‡é’ˆã€‚\nå€’æ’è¡¨(Post list) ï¼šä¸€ä¸ªæ–‡æ¡£é€šå¸¸ç”±å¤šä¸ªè¯ç»„æˆï¼Œå€’æ’è¡¨è®°å½•çš„æ˜¯æŸä¸ªè¯åœ¨å“ªäº›æ–‡æ¡£é‡Œå‡ºç°è¿‡ä»¥åŠå‡ºç°çš„ä½ç½®ã€‚æ¯æ¡è®°å½•ç§°ä¸ºä¸€ä¸ªå€’æ’é¡¹(Posting)ã€‚å€’æ’è¡¨è®°å½•çš„ä¸å•æ˜¯æ–‡æ¡£ç¼–å·ï¼Œè¿˜å­˜å‚¨äº†è¯é¢‘ç­‰ä¿¡æ¯ã€‚\nå€’æ’æ–‡ä»¶(Inverted File) ï¼šæ‰€æœ‰å•è¯çš„å€’æ’åˆ—è¡¨å¾€å¾€é¡ºåºåœ°å­˜å‚¨åœ¨ç£ç›˜çš„æŸä¸ªæ–‡ä»¶é‡Œï¼Œè¿™ä¸ªæ–‡ä»¶è¢«ç§°ä¹‹ä¸ºå€’æ’æ–‡ä»¶ï¼Œå€’æ’æ–‡ä»¶æ˜¯å­˜å‚¨å€’æ’ç´¢å¼•çš„ç‰©ç†æ–‡ä»¶ã€‚\n\nä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥äº†è§£åˆ°å€’æ’ç´¢å¼•ä¸»è¦ç”±ä¸¤ä¸ªéƒ¨åˆ†ç»„æˆï¼šè¯å…¸ å’Œå€’æ’æ–‡ä»¶ ã€‚è¯å…¸å’Œå€’æ’è¡¨æ˜¯Luceneä¸­å¾ˆé‡è¦çš„ä¸¤ç§æ•°æ®ç»“æ„ï¼Œæ˜¯å®ç°å¿«é€Ÿæ£€ç´¢çš„é‡è¦åŸºçŸ³ã€‚è¯å…¸å’Œå€’æ’æ–‡ä»¶æ˜¯åˆ†ä¸¤éƒ¨åˆ†å­˜å‚¨çš„ï¼Œè¯å…¸åœ¨å†…å­˜ä¸­è€Œå€’æ’æ–‡ä»¶å­˜å‚¨åœ¨ç£ç›˜ä¸Šã€‚\nä¸‰ã€æ ¸å¿ƒæ¦‚å¿µä¸€äº›åŸºç¡€çŸ¥è¯†çš„é“ºå«ä¹‹åæˆ‘ä»¬æ­£å¼è¿›å…¥ä»Šå¤©çš„ä¸»è§’Elasticsearchçš„ä»‹ç»ï¼Œ ESæ˜¯ä½¿ç”¨Javaç¼–å†™çš„ä¸€ç§å¼€æºæœç´¢å¼•æ“ï¼Œå®ƒåœ¨å†…éƒ¨ä½¿ç”¨Luceneåšç´¢å¼•ä¸æœç´¢ï¼Œé€šè¿‡å¯¹Luceneçš„å°è£…ï¼Œéšè—äº†Luceneçš„å¤æ‚æ€§ï¼Œå–è€Œä»£ä¹‹çš„æä¾›ä¸€å¥—ç®€å•ä¸€è‡´çš„ RESTful APIã€‚\nç„¶è€Œï¼ŒElasticsearch ä¸ä»…ä»…æ˜¯ Luceneï¼Œå¹¶ä¸”ä¹Ÿä¸ä»…ä»…åªæ˜¯ä¸€ä¸ªå…¨æ–‡æœç´¢å¼•æ“ã€‚å®ƒå¯ä»¥è¢«ä¸‹é¢è¿™æ ·å‡†ç¡®çš„å½¢å®¹ï¼š\n\nä¸€ä¸ªåˆ†å¸ƒå¼çš„å®æ—¶æ–‡æ¡£å­˜å‚¨ï¼Œæ¯ä¸ªå­—æ®µå¯ä»¥è¢«ç´¢å¼•ä¸æœç´¢ã€‚\nä¸€ä¸ªåˆ†å¸ƒå¼å®æ—¶åˆ†ææœç´¢å¼•æ“ã€‚\nèƒ½èƒœä»»ä¸Šç™¾ä¸ªæœåŠ¡èŠ‚ç‚¹çš„æ‰©å±•ï¼Œå¹¶æ”¯æŒ PB çº§åˆ«çš„ç»“æ„åŒ–æˆ–è€…éç»“æ„åŒ–æ•°æ®ã€‚\n\nå®˜ç½‘å¯¹Elasticsearchçš„ä»‹ç»æ˜¯Elasticsearch æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ ã€å¯æ‰©å±• ã€è¿‘å®æ—¶çš„ æœç´¢ä¸æ•°æ®åˆ†æå¼•æ“ã€‚æˆ‘ä»¬é€šè¿‡ä¸€äº›æ ¸å¿ƒæ¦‚å¿µæ¥çœ‹ä¸‹Elasticsearch æ˜¯å¦‚ä½•åšåˆ°åˆ†å¸ƒå¼ï¼Œå¯æ‰©å±•å’Œè¿‘å®æ—¶æœç´¢çš„ã€‚\né›†ç¾¤ï¼ˆClusterï¼‰ESçš„é›†ç¾¤æ­å»ºå¾ˆç®€å•ï¼Œä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹åè°ƒç®¡ç†ç»„ä»¶ï¼Œè‡ªèº«å†…éƒ¨å°±å®ç°äº†é›†ç¾¤çš„ç®¡ç†åŠŸèƒ½ã€‚ESé›†ç¾¤ç”±ä¸€ä¸ªæˆ–å¤šä¸ªElasticsearchèŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹é…ç½®ç›¸åŒçš„ cluster.name å³å¯åŠ å…¥é›†ç¾¤ï¼Œé»˜è®¤å€¼ä¸º â€œelasticsearchâ€ã€‚ç¡®ä¿ä¸åŒçš„ç¯å¢ƒä¸­ä½¿ç”¨ä¸åŒçš„é›†ç¾¤åç§°ï¼Œå¦åˆ™æœ€ç»ˆä¼šå¯¼è‡´èŠ‚ç‚¹åŠ å…¥é”™è¯¯çš„é›†ç¾¤ã€‚\nä¸€ä¸ªElasticsearchæœåŠ¡å¯åŠ¨å®ä¾‹å°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰ã€‚èŠ‚ç‚¹é€šè¿‡node.nameæ¥è®¾ç½®èŠ‚ç‚¹åç§°ï¼Œå¦‚æœä¸è®¾ç½®åˆ™åœ¨å¯åŠ¨æ—¶ç»™èŠ‚ç‚¹åˆ†é…ä¸€ä¸ªéšæœºé€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ä½œä¸ºåç§°ã€‚\nå‘ç°æœºåˆ¶é‚£ä¹ˆæœ‰ä¸€ä¸ªé—®é¢˜ï¼ŒESå†…éƒ¨æ˜¯å¦‚ä½•é€šè¿‡ä¸€ä¸ªç›¸åŒçš„è®¾ç½®cluster.name å°±èƒ½å°†ä¸åŒçš„èŠ‚ç‚¹è¿æ¥åˆ°åŒä¸€ä¸ªé›†ç¾¤çš„ï¼Ÿç­”æ¡ˆæ˜¯Zen Discoveryã€‚\nZen Discoveryæ˜¯Elasticsearchçš„å†…ç½®é»˜è®¤å‘ç°æ¨¡å—ï¼ˆå‘ç°æ¨¡å—çš„èŒè´£æ˜¯å‘ç°é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä»¥åŠé€‰ä¸¾masterèŠ‚ç‚¹ï¼‰ã€‚å®ƒæä¾›å•æ’­å’ŒåŸºäºæ–‡ä»¶çš„å‘ç°ï¼Œå¹¶ä¸”å¯ä»¥æ‰©å±•ä¸ºé€šè¿‡æ’ä»¶æ”¯æŒäº‘ç¯å¢ƒå’Œå…¶ä»–å½¢å¼çš„å‘ç°ã€‚Zen Discovery ä¸å…¶ä»–æ¨¡å—é›†æˆï¼Œä¾‹å¦‚ï¼ŒèŠ‚ç‚¹ä¹‹é—´çš„æ‰€æœ‰é€šä¿¡éƒ½ä½¿ç”¨Transportæ¨¡å—å®Œæˆã€‚èŠ‚ç‚¹ä½¿ç”¨å‘ç°æœºåˆ¶é€šè¿‡Pingçš„æ–¹å¼æŸ¥æ‰¾å…¶ä»–èŠ‚ç‚¹ã€‚\nElasticsearch é»˜è®¤è¢«é…ç½®ä¸ºä½¿ç”¨å•æ’­å‘ç°ï¼Œä»¥é˜²æ­¢èŠ‚ç‚¹æ— æ„ä¸­åŠ å…¥é›†ç¾¤ã€‚åªæœ‰åœ¨åŒä¸€å°æœºå™¨ä¸Šè¿è¡Œçš„èŠ‚ç‚¹æ‰ä¼šè‡ªåŠ¨ç»„æˆé›†ç¾¤ã€‚\nå¦‚æœé›†ç¾¤çš„èŠ‚ç‚¹è¿è¡Œåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œä½¿ç”¨å•æ’­ï¼Œä½ å¯ä»¥ä¸º Elasticsearch æä¾›ä¸€äº›å®ƒåº”è¯¥å»å°è¯•è¿æ¥çš„èŠ‚ç‚¹åˆ—è¡¨ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹è”ç³»åˆ°å•æ’­åˆ—è¡¨ä¸­çš„æˆå‘˜æ—¶ï¼Œå®ƒå°±ä¼šå¾—åˆ°æ•´ä¸ªé›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç„¶åå®ƒä¼šè”ç³» master èŠ‚ç‚¹ï¼Œå¹¶åŠ å…¥é›†ç¾¤ã€‚\nè¿™æ„å‘³ç€å•æ’­åˆ—è¡¨ä¸éœ€è¦åŒ…å«é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œ å®ƒåªæ˜¯éœ€è¦è¶³å¤Ÿçš„èŠ‚ç‚¹ï¼Œå½“ä¸€ä¸ªæ–°èŠ‚ç‚¹è”ç³»ä¸Šå…¶ä¸­ä¸€ä¸ªå¹¶ä¸”è¯´ä¸Šè¯å°±å¯ä»¥äº†ã€‚å¦‚æœä½ ä½¿ç”¨ master å€™é€‰èŠ‚ç‚¹ä½œä¸ºå•æ’­åˆ—è¡¨ï¼Œä½ åªè¦åˆ—å‡ºä¸‰ä¸ªå°±å¯ä»¥äº†ã€‚è¿™ä¸ªé…ç½®åœ¨ elasticsearch.yml æ–‡ä»¶ä¸­ï¼š\ndiscovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;]\n\nèŠ‚ç‚¹å¯åŠ¨åå…ˆ ping ï¼Œå¦‚æœdiscovery.zen.ping.unicast.hosts æœ‰è®¾ç½®ï¼Œåˆ™ ping è®¾ç½®ä¸­çš„ host ï¼Œå¦åˆ™å°è¯• ping localhost çš„å‡ ä¸ªç«¯å£ï¼Œ Elasticsearch æ”¯æŒåŒä¸€ä¸ªä¸»æœºå¯åŠ¨å¤šä¸ªèŠ‚ç‚¹ï¼Œ Ping çš„ response ä¼šåŒ…å«è¯¥èŠ‚ç‚¹çš„åŸºæœ¬ä¿¡æ¯ä»¥åŠè¯¥èŠ‚ç‚¹è®¤ä¸ºçš„ master èŠ‚ç‚¹ã€‚é€‰ä¸¾å¼€å§‹ï¼Œå…ˆä»å„èŠ‚ç‚¹è®¤ä¸ºçš„ master ä¸­é€‰ï¼Œè§„åˆ™å¾ˆç®€å•ï¼ŒæŒ‰ç…§ id çš„å­—å…¸åºæ’åºï¼Œå–ç¬¬ä¸€ä¸ªã€‚å¦‚æœå„èŠ‚ç‚¹éƒ½æ²¡æœ‰è®¤ä¸ºçš„ master ï¼Œåˆ™ä»æ‰€æœ‰èŠ‚ç‚¹ä¸­é€‰æ‹©ï¼Œè§„åˆ™åŒä¸Šã€‚\nè¿™é‡Œæœ‰ä¸ªé™åˆ¶æ¡ä»¶å°±æ˜¯ discovery.zen.minimum_master_nodes ï¼Œå¦‚æœèŠ‚ç‚¹æ•°è¾¾ä¸åˆ°æœ€å°å€¼çš„é™åˆ¶ï¼Œåˆ™å¾ªç¯ä¸Šè¿°è¿‡ç¨‹ï¼Œç›´åˆ°èŠ‚ç‚¹æ•°è¶³å¤Ÿå¯ä»¥å¼€å§‹é€‰ä¸¾ã€‚æœ€åé€‰ä¸¾ç»“æœæ˜¯è‚¯å®šèƒ½é€‰ä¸¾å‡ºä¸€ä¸ª master ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ª local èŠ‚ç‚¹é‚£å°±é€‰å‡ºçš„æ˜¯è‡ªå·±ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹æ˜¯ master ï¼Œåˆ™å¼€å§‹ç­‰å¾…èŠ‚ç‚¹æ•°è¾¾åˆ° discovery.zen.minimum_master_nodesï¼Œç„¶åæä¾›æœåŠ¡ã€‚å¦‚æœå½“å‰èŠ‚ç‚¹ä¸æ˜¯ master ï¼Œåˆ™å°è¯•åŠ å…¥ master ã€‚Elasticsearch å°†ä»¥ä¸ŠæœåŠ¡å‘ç°ä»¥åŠé€‰ä¸»çš„æµç¨‹å«åš ZenDiscovery ã€‚\nç”±äºå®ƒæ”¯æŒä»»æ„æ•°ç›®çš„é›†ç¾¤ï¼ˆ 1- N ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½åƒ Zookeeper é‚£æ ·é™åˆ¶èŠ‚ç‚¹å¿…é¡»æ˜¯å¥‡æ•°ï¼Œä¹Ÿå°±æ— æ³•ç”¨æŠ•ç¥¨çš„æœºåˆ¶æ¥é€‰ä¸»ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªè§„åˆ™ï¼Œåªè¦æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½éµå¾ªåŒæ ·çš„è§„åˆ™ï¼Œå¾—åˆ°çš„ä¿¡æ¯éƒ½æ˜¯å¯¹ç­‰çš„ï¼Œé€‰å‡ºæ¥çš„ä¸»èŠ‚ç‚¹è‚¯å®šæ˜¯ä¸€è‡´çš„ã€‚ä½†åˆ†å¸ƒå¼ç³»ç»Ÿçš„é—®é¢˜å°±å‡ºåœ¨ä¿¡æ¯ä¸å¯¹ç­‰çš„æƒ…å†µï¼Œè¿™æ—¶å€™å¾ˆå®¹æ˜“å‡ºç°è„‘è£‚ï¼ˆ Split-Brain ï¼‰çš„é—®é¢˜ï¼Œå¤§å¤šæ•°è§£å†³æ–¹æ¡ˆå°±æ˜¯è®¾ç½®ä¸€ä¸ª quorum å€¼ï¼Œè¦æ±‚å¯ç”¨èŠ‚ç‚¹å¿…é¡»å¤§äº quorum ï¼ˆä¸€èˆ¬æ˜¯è¶…è¿‡åŠæ•°èŠ‚ç‚¹ï¼‰ï¼Œæ‰èƒ½å¯¹å¤–æä¾›æœåŠ¡ã€‚è€Œ Elasticsearch ä¸­ï¼Œè¿™ä¸ª quorum çš„é…ç½®å°±æ˜¯ discovery.zen.minimum_master_nodes ã€‚\nèŠ‚ç‚¹çš„è§’è‰²æ¯ä¸ªèŠ‚ç‚¹æ—¢å¯ä»¥æ˜¯å€™é€‰ä¸»èŠ‚ç‚¹ ä¹Ÿå¯ä»¥æ˜¯æ•°æ®èŠ‚ç‚¹ ï¼Œé€šè¿‡åœ¨é…ç½®æ–‡ä»¶../config/elasticsearch.ymlä¸­è®¾ç½®å³å¯ï¼Œé»˜è®¤éƒ½ä¸ºtrueã€‚\nnode.master: true  //æ˜¯å¦å€™é€‰ä¸»èŠ‚ç‚¹node.data: true    //æ˜¯å¦æ•°æ®èŠ‚ç‚¹\n\næ•°æ®èŠ‚ç‚¹ è´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œç›¸å…³çš„æ“ä½œï¼Œä¾‹å¦‚å¯¹æ•°æ®è¿›è¡Œå¢ã€åˆ ã€æ”¹ã€æŸ¥å’Œèšåˆç­‰æ“ä½œï¼Œæ‰€ä»¥æ•°æ®èŠ‚ç‚¹ï¼ˆdataèŠ‚ç‚¹ï¼‰å¯¹æœºå™¨é…ç½®è¦æ±‚æ¯”è¾ƒé«˜ï¼Œå¯¹CPUã€å†…å­˜å’ŒI/Oçš„æ¶ˆè€—å¾ˆå¤§ã€‚é€šå¸¸éšç€é›†ç¾¤çš„æ‰©å¤§ï¼Œéœ€è¦å¢åŠ æ›´å¤šçš„æ•°æ®èŠ‚ç‚¹æ¥æé«˜æ€§èƒ½å’Œå¯ç”¨æ€§ã€‚\nå€™é€‰ä¸»èŠ‚ç‚¹ å¯ä»¥è¢«é€‰ä¸¾ä¸ºä¸»èŠ‚ç‚¹ï¼ˆmasterèŠ‚ç‚¹ï¼‰ï¼Œé›†ç¾¤ä¸­åªæœ‰å€™é€‰ä¸»èŠ‚ç‚¹æ‰æœ‰é€‰ä¸¾æƒå’Œè¢«é€‰ä¸¾æƒï¼Œå…¶ä»–èŠ‚ç‚¹ä¸å‚ä¸é€‰ä¸¾çš„å·¥ä½œã€‚ä¸»èŠ‚ç‚¹è´Ÿè´£åˆ›å»ºç´¢å¼•ã€åˆ é™¤ç´¢å¼•ã€è·Ÿè¸ªå“ªäº›èŠ‚ç‚¹æ˜¯ç¾¤é›†çš„ä¸€éƒ¨åˆ†ï¼Œå¹¶å†³å®šå“ªäº›åˆ†ç‰‡åˆ†é…ç»™ç›¸å…³çš„èŠ‚ç‚¹ã€è¿½è¸ªé›†ç¾¤ä¸­èŠ‚ç‚¹çš„çŠ¶æ€ç­‰ï¼Œç¨³å®šçš„ä¸»èŠ‚ç‚¹å¯¹é›†ç¾¤çš„å¥åº·æ˜¯éå¸¸é‡è¦çš„ã€‚\n\nä¸€ä¸ªèŠ‚ç‚¹æ—¢å¯ä»¥æ˜¯å€™é€‰ä¸»èŠ‚ç‚¹ä¹Ÿå¯ä»¥æ˜¯æ•°æ®èŠ‚ç‚¹ï¼Œä½†æ˜¯ç”±äºæ•°æ®èŠ‚ç‚¹å¯¹CPUã€å†…å­˜æ ¸I/0æ¶ˆè€—éƒ½å¾ˆå¤§ï¼Œæ‰€ä»¥å¦‚æœæŸä¸ªèŠ‚ç‚¹æ—¢æ˜¯æ•°æ®èŠ‚ç‚¹åˆæ˜¯ä¸»èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå¯èƒ½ä¼šå¯¹ä¸»èŠ‚ç‚¹äº§ç”Ÿå½±å“ä»è€Œå¯¹æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€äº§ç”Ÿå½±å“ã€‚\nå› æ­¤ä¸ºäº†æé«˜é›†ç¾¤çš„å¥åº·æ€§ï¼Œæˆ‘ä»¬åº”è¯¥å¯¹Elasticsearché›†ç¾¤ä¸­çš„èŠ‚ç‚¹åšå¥½è§’è‰²ä¸Šçš„åˆ’åˆ†å’Œéš”ç¦»ã€‚å¯ä»¥ä½¿ç”¨å‡ ä¸ªé…ç½®è¾ƒä½çš„æœºå™¨ç¾¤ä½œä¸ºå€™é€‰ä¸»èŠ‚ç‚¹ç¾¤ã€‚\nä¸»èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹ä¹‹é—´é€šè¿‡Pingçš„æ–¹å¼äº’æ£€æŸ¥ï¼Œä¸»èŠ‚ç‚¹è´Ÿè´£Pingæ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰èŠ‚ç‚¹å·²ç»æŒ‚æ‰ã€‚å…¶ä»–èŠ‚ç‚¹ä¹Ÿé€šè¿‡Pingçš„æ–¹å¼åˆ¤æ–­ä¸»èŠ‚ç‚¹æ˜¯å¦å¤„äºå¯ç”¨çŠ¶æ€ã€‚\nè™½ç„¶å¯¹èŠ‚ç‚¹åšäº†è§’è‰²åŒºåˆ†ï¼Œä½†æ˜¯ç”¨æˆ·çš„è¯·æ±‚å¯ä»¥å‘å¾€ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ç”±è¯¥èŠ‚ç‚¹è´Ÿè´£åˆ†å‘è¯·æ±‚ã€æ”¶é›†ç»“æœç­‰æ“ä½œï¼Œè€Œä¸éœ€è¦ä¸»èŠ‚ç‚¹è½¬å‘ï¼Œè¿™ç§èŠ‚ç‚¹å¯ç§°ä¹‹ä¸ºåè°ƒèŠ‚ç‚¹ ï¼Œåè°ƒèŠ‚ç‚¹æ˜¯ä¸éœ€è¦æŒ‡å®šå’Œé…ç½®çš„ï¼Œé›†ç¾¤ä¸­çš„ä»»ä½•èŠ‚ç‚¹éƒ½å¯ä»¥å……å½“åè°ƒèŠ‚ç‚¹çš„è§’è‰²ã€‚\nè„‘è£‚ç°è±¡åŒæ—¶å¦‚æœç”±äºç½‘ç»œæˆ–å…¶ä»–åŸå› å¯¼è‡´é›†ç¾¤ä¸­é€‰ä¸¾å‡ºå¤šä¸ªMasterèŠ‚ç‚¹ï¼Œä½¿å¾—æ•°æ®æ›´æ–°æ—¶å‡ºç°ä¸ä¸€è‡´ï¼Œè¿™ç§ç°è±¡ç§°ä¹‹ä¸ºè„‘è£‚ ï¼Œå³é›†ç¾¤ä¸­ä¸åŒçš„èŠ‚ç‚¹å¯¹äºmasterçš„é€‰æ‹©å‡ºç°äº†åˆ†æ­§ï¼Œå‡ºç°äº†å¤šä¸ªmasterç«äº‰ã€‚\nâ€œè„‘è£‚â€é—®é¢˜å¯èƒ½æœ‰ä»¥ä¸‹å‡ ä¸ªåŸå› é€ æˆï¼š\n\nç½‘ç»œé—®é¢˜ ï¼šé›†ç¾¤é—´çš„ç½‘ç»œå»¶è¿Ÿå¯¼è‡´ä¸€äº›èŠ‚ç‚¹è®¿é—®ä¸åˆ°masterï¼Œè®¤ä¸ºmasteræŒ‚æ‰äº†ä»è€Œé€‰ä¸¾å‡ºæ–°çš„masterï¼Œå¹¶å¯¹masterä¸Šçš„åˆ†ç‰‡å’Œå‰¯æœ¬æ ‡çº¢ï¼Œåˆ†é…æ–°çš„ä¸»åˆ†ç‰‡\nèŠ‚ç‚¹è´Ÿè½½ ï¼šä¸»èŠ‚ç‚¹çš„è§’è‰²æ—¢ä¸ºmasteråˆä¸ºdataï¼Œè®¿é—®é‡è¾ƒå¤§æ—¶å¯èƒ½ä¼šå¯¼è‡´ESåœæ­¢å“åº”ï¼ˆå‡æ­»çŠ¶æ€ï¼‰é€ æˆå¤§é¢ç§¯å»¶è¿Ÿï¼Œæ­¤æ—¶å…¶ä»–èŠ‚ç‚¹å¾—ä¸åˆ°ä¸»èŠ‚ç‚¹çš„å“åº”è®¤ä¸ºä¸»èŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä¼šé‡æ–°é€‰å–ä¸»èŠ‚ç‚¹ã€‚\nå†…å­˜å›æ”¶ ï¼šä¸»èŠ‚ç‚¹çš„è§’è‰²æ—¢ä¸ºmasteråˆä¸ºdataï¼Œå½“dataèŠ‚ç‚¹ä¸Šçš„ESè¿›ç¨‹å ç”¨çš„å†…å­˜è¾ƒå¤§ï¼Œå¼•å‘JVMçš„å¤§è§„æ¨¡å†…å­˜å›æ”¶ï¼Œé€ æˆESè¿›ç¨‹å¤±å»å“åº”ã€‚\n\nä¸ºäº†é¿å…è„‘è£‚ç°è±¡çš„å‘ç”Ÿï¼Œæˆ‘ä»¬å¯ä»¥ä»åŸå› ç€æ‰‹é€šè¿‡ä»¥ä¸‹å‡ ä¸ªæ–¹é¢æ¥åšå‡ºä¼˜åŒ–æªæ–½ï¼š\n\né€‚å½“è°ƒå¤§å“åº”æ—¶é—´ï¼Œå‡å°‘è¯¯åˆ¤é€šè¿‡å‚æ•°discovery.zen.ping_timeoutè®¾ç½®èŠ‚ç‚¹çŠ¶æ€çš„å“åº”æ—¶é—´ï¼Œé»˜è®¤ä¸º3sï¼Œå¯ä»¥é€‚å½“è°ƒå¤§ï¼Œå¦‚æœmasteråœ¨è¯¥å“åº”æ—¶é—´çš„èŒƒå›´å†…æ²¡æœ‰åšå‡ºå“åº”åº”ç­”ï¼Œåˆ¤æ–­è¯¥èŠ‚ç‚¹å·²ç»æŒ‚æ‰äº†ã€‚è°ƒå¤§å‚æ•°ï¼ˆå¦‚6sï¼Œdiscovery.zen.ping_timeout:6ï¼‰ï¼Œå¯é€‚å½“å‡å°‘è¯¯åˆ¤ã€‚\né€‰ä¸¾è§¦å‘æˆ‘ä»¬éœ€è¦åœ¨å€™é€‰é›†ç¾¤ä¸­çš„èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¸­è®¾ç½®å‚æ•°discovery.zen.munimum_master_nodesçš„å€¼ï¼Œè¿™ä¸ªå‚æ•°è¡¨ç¤ºåœ¨é€‰ä¸¾ä¸»èŠ‚ç‚¹æ—¶éœ€è¦å‚ä¸é€‰ä¸¾çš„å€™é€‰ä¸»èŠ‚ç‚¹çš„èŠ‚ç‚¹æ•°ï¼Œé»˜è®¤å€¼æ˜¯1ï¼Œå®˜æ–¹å»ºè®®å–å€¼(master_eligibel_nodes/2) + 1ï¼Œå…¶ä¸­master_eligibel_nodesä¸ºå€™é€‰ä¸»èŠ‚ç‚¹çš„ä¸ªæ•°ã€‚è¿™æ ·åšæ—¢èƒ½é˜²æ­¢è„‘è£‚ç°è±¡çš„å‘ç”Ÿï¼Œä¹Ÿèƒ½æœ€å¤§é™åº¦åœ°æå‡é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼Œå› ä¸ºåªè¦ä¸å°‘äºdiscovery.zen.munimum_master_nodesä¸ªå€™é€‰èŠ‚ç‚¹å­˜æ´»ï¼Œé€‰ä¸¾å·¥ä½œå°±èƒ½æ­£å¸¸è¿›è¡Œã€‚å½“å°äºè¿™ä¸ªå€¼çš„æ—¶å€™ï¼Œæ— æ³•è§¦å‘é€‰ä¸¾è¡Œä¸ºï¼Œé›†ç¾¤æ— æ³•ä½¿ç”¨ï¼Œä¸ä¼šé€ æˆåˆ†ç‰‡æ··ä¹±çš„æƒ…å†µã€‚\nè§’è‰²åˆ†ç¦»å³æ˜¯ä¸Šé¢æˆ‘ä»¬æåˆ°çš„å€™é€‰ä¸»èŠ‚ç‚¹å’Œæ•°æ®èŠ‚ç‚¹è¿›è¡Œè§’è‰²åˆ†ç¦»ï¼Œè¿™æ ·å¯ä»¥å‡è½»ä¸»èŠ‚ç‚¹çš„è´Ÿæ‹…ï¼Œé˜²æ­¢ä¸»èŠ‚ç‚¹çš„å‡æ­»çŠ¶æ€å‘ç”Ÿï¼Œå‡å°‘å¯¹ä¸»èŠ‚ç‚¹â€œå·²æ­»â€çš„è¯¯åˆ¤ã€‚\n\nåˆ†ç‰‡ï¼ˆShardsï¼‰ESæ”¯æŒPBçº§å…¨æ–‡æœç´¢ï¼Œå½“ç´¢å¼•ä¸Šçš„æ•°æ®é‡å¤ªå¤§çš„æ—¶å€™ï¼ŒESé€šè¿‡æ°´å¹³æ‹†åˆ†çš„æ–¹å¼å°†ä¸€ä¸ªç´¢å¼•ä¸Šçš„æ•°æ®æ‹†åˆ†å‡ºæ¥åˆ†é…åˆ°ä¸åŒçš„æ•°æ®å—ä¸Šï¼Œæ‹†åˆ†å‡ºæ¥çš„æ•°æ®åº“å—ç§°ä¹‹ä¸ºä¸€ä¸ªåˆ†ç‰‡ ã€‚\nè¿™ç±»ä¼¼äºMySqlçš„åˆ†åº“åˆ†è¡¨ï¼Œåªä¸è¿‡Mysqlåˆ†åº“åˆ†è¡¨éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹ç»„ä»¶è€ŒESå†…éƒ¨è‡ªèº«å®ç°äº†æ­¤åŠŸèƒ½ã€‚\nåœ¨ä¸€ä¸ªå¤šåˆ†ç‰‡çš„ç´¢å¼•ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œé€šè¿‡è·¯ç”±æ¥ç¡®å®šå…·ä½“å†™å…¥å“ªä¸€ä¸ªåˆ†ç‰‡ä¸­ï¼Œæ‰€ä»¥åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™éœ€è¦æŒ‡å®šåˆ†ç‰‡çš„æ•°é‡ï¼Œå¹¶ä¸”åˆ†ç‰‡çš„æ•°é‡ä¸€æ—¦ç¡®å®šå°±ä¸èƒ½ä¿®æ”¹ã€‚\nåˆ†ç‰‡çš„æ•°é‡å’Œä¸‹é¢ä»‹ç»çš„å‰¯æœ¬æ•°é‡éƒ½æ˜¯å¯ä»¥é€šè¿‡åˆ›å»ºç´¢å¼•æ—¶çš„settingsæ¥é…ç½®ï¼ŒESé»˜è®¤ä¸ºä¸€ä¸ªç´¢å¼•åˆ›å»º5ä¸ªä¸»åˆ†ç‰‡, å¹¶åˆ†åˆ«ä¸ºæ¯ä¸ªåˆ†ç‰‡åˆ›å»ºä¸€ä¸ªå‰¯æœ¬ã€‚\nPUT /myIndex&#123;   &quot;settings&quot; : &#123;      &quot;number_of_shards&quot; : 5,      &quot;number_of_replicas&quot; : 1   &#125;&#125;\n\nESé€šè¿‡åˆ†ç‰‡çš„åŠŸèƒ½ä½¿å¾—ç´¢å¼•åœ¨è§„æ¨¡ä¸Šå’Œæ€§èƒ½ä¸Šéƒ½å¾—åˆ°æå‡ï¼Œæ¯ä¸ªåˆ†ç‰‡éƒ½æ˜¯Luceneä¸­çš„ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼Œæ¯ä¸ªåˆ†ç‰‡å¿…é¡»æœ‰ä¸€ä¸ªä¸»åˆ†ç‰‡å’Œé›¶åˆ°å¤šä¸ªå‰¯æœ¬ã€‚\nå‰¯æœ¬ï¼ˆReplicasï¼‰å‰¯æœ¬å°±æ˜¯å¯¹åˆ†ç‰‡çš„Copyï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡éƒ½æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªå‰¯æœ¬åˆ†ç‰‡ï¼Œå½“ä¸»åˆ†ç‰‡å¼‚å¸¸æ—¶ï¼Œå‰¯æœ¬å¯ä»¥æä¾›æ•°æ®çš„æŸ¥è¯¢ç­‰æ“ä½œã€‚ä¸»åˆ†ç‰‡å’Œå¯¹åº”çš„å‰¯æœ¬åˆ†ç‰‡æ˜¯ä¸ä¼šåœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ï¼Œæ‰€ä»¥å‰¯æœ¬åˆ†ç‰‡æ•°çš„æœ€å¤§å€¼æ˜¯ n -1ï¼ˆå…¶ä¸­nä¸ºèŠ‚ç‚¹æ•°ï¼‰ã€‚\nå¯¹æ–‡æ¡£çš„æ–°å»ºã€ç´¢å¼•å’Œåˆ é™¤è¯·æ±‚éƒ½æ˜¯å†™æ“ä½œï¼Œå¿…é¡»åœ¨ä¸»åˆ†ç‰‡ä¸Šé¢å®Œæˆä¹‹åæ‰èƒ½è¢«å¤åˆ¶åˆ°ç›¸å…³çš„å‰¯æœ¬åˆ†ç‰‡ï¼ŒESä¸ºäº†æé«˜å†™å…¥çš„èƒ½åŠ›è¿™ä¸ªè¿‡ç¨‹æ˜¯å¹¶å‘å†™çš„ï¼ŒåŒæ—¶ä¸ºäº†è§£å†³å¹¶å‘å†™çš„è¿‡ç¨‹ä¸­æ•°æ®å†²çªçš„é—®é¢˜ï¼ŒESé€šè¿‡ä¹è§‚é”çš„æ–¹å¼æ§åˆ¶ï¼Œæ¯ä¸ªæ–‡æ¡£éƒ½æœ‰ä¸€ä¸ª _version ï¼ˆç‰ˆæœ¬ï¼‰å·ï¼Œå½“æ–‡æ¡£è¢«ä¿®æ”¹æ—¶ç‰ˆæœ¬å·é€’å¢ã€‚ä¸€æ—¦æ‰€æœ‰çš„å‰¯æœ¬åˆ†ç‰‡éƒ½æŠ¥å‘Šå†™æˆåŠŸæ‰ä¼šå‘åè°ƒèŠ‚ç‚¹æŠ¥å‘ŠæˆåŠŸï¼Œåè°ƒèŠ‚ç‚¹å‘å®¢æˆ·ç«¯æŠ¥å‘ŠæˆåŠŸã€‚\n\nä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºä¸ºäº†è¾¾åˆ°é«˜å¯ç”¨ï¼ŒMasterèŠ‚ç‚¹ä¼šé¿å…å°†ä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡æ”¾åœ¨åŒä¸€ä¸ªèŠ‚ç‚¹ä¸Šã€‚\nå‡è®¾è¿™æ—¶èŠ‚ç‚¹Node1æœåŠ¡å®•æœºäº†æˆ–è€…ç½‘ç»œä¸å¯ç”¨äº†ï¼Œé‚£ä¹ˆä¸»èŠ‚ç‚¹ä¸Šä¸»åˆ†ç‰‡S0ä¹Ÿå°±ä¸å¯ç”¨äº†ã€‚å¹¸è¿çš„æ˜¯è¿˜å­˜åœ¨å¦å¤–ä¸¤ä¸ªèŠ‚ç‚¹èƒ½æ­£å¸¸å·¥ä½œï¼Œè¿™æ—¶ESä¼šé‡æ–°é€‰ä¸¾æ–°çš„ä¸»èŠ‚ç‚¹ï¼Œè€Œä¸”è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸Šå­˜åœ¨æˆ‘ä»¬çš„æ‰€éœ€è¦çš„S0çš„æ‰€æœ‰æ•°æ®ï¼Œæˆ‘ä»¬ä¼šå°†S0çš„å‰¯æœ¬åˆ†ç‰‡æå‡ä¸ºä¸»åˆ†ç‰‡ï¼Œè¿™ä¸ªæå‡ä¸»åˆ†ç‰‡çš„è¿‡ç¨‹æ˜¯ç¬é—´å‘ç”Ÿçš„ã€‚æ­¤æ—¶é›†ç¾¤çš„çŠ¶æ€å°†ä¼šä¸º yellowã€‚\nä¸ºä»€ä¹ˆæˆ‘ä»¬é›†ç¾¤çŠ¶æ€æ˜¯ yellow è€Œä¸æ˜¯ green å‘¢ï¼Ÿè™½ç„¶æˆ‘ä»¬æ‹¥æœ‰æ‰€æœ‰çš„2ä¸ªä¸»åˆ†ç‰‡ï¼Œä½†æ˜¯åŒæ—¶è®¾ç½®äº†æ¯ä¸ªä¸»åˆ†ç‰‡éœ€è¦å¯¹åº”ä¸¤ä»½å‰¯æœ¬åˆ†ç‰‡ï¼Œè€Œæ­¤æ—¶åªå­˜åœ¨ä¸€ä»½å‰¯æœ¬åˆ†ç‰‡ã€‚æ‰€ä»¥é›†ç¾¤ä¸èƒ½ä¸º green çš„çŠ¶æ€ã€‚å¦‚æœæˆ‘ä»¬åŒæ ·å…³é—­äº† Node2 ï¼Œæˆ‘ä»¬çš„ç¨‹åºä¾ç„¶å¯ä»¥ä¿æŒåœ¨ä¸ä¸¢ä»»ä½•æ•°æ®çš„æƒ…å†µä¸‹è¿è¡Œï¼Œå› ä¸ºNode3 ä¸ºæ¯ä¸€ä¸ªåˆ†ç‰‡éƒ½ä¿ç•™ç€ä¸€ä»½å‰¯æœ¬ã€‚\nå¦‚æœæˆ‘ä»¬é‡æ–°å¯åŠ¨Node1 ï¼Œé›†ç¾¤å¯ä»¥å°†ç¼ºå¤±çš„å‰¯æœ¬åˆ†ç‰‡å†æ¬¡è¿›è¡Œåˆ†é…ï¼Œé‚£ä¹ˆé›†ç¾¤çš„çŠ¶æ€åˆå°†æ¢å¤åˆ°åŸæ¥çš„æ­£å¸¸çŠ¶æ€ã€‚å¦‚æœNode1ä¾ç„¶æ‹¥æœ‰ç€ä¹‹å‰çš„åˆ†ç‰‡ï¼Œå®ƒå°†å°è¯•å»é‡ç”¨å®ƒä»¬ï¼Œåªä¸è¿‡è¿™æ—¶Node1èŠ‚ç‚¹ä¸Šçš„åˆ†ç‰‡ä¸å†æ˜¯ä¸»åˆ†ç‰‡è€Œæ˜¯å‰¯æœ¬åˆ†ç‰‡äº†ï¼Œå¦‚æœæœŸé—´æœ‰æ›´æ”¹çš„æ•°æ®åªéœ€è¦ä»ä¸»åˆ†ç‰‡ä¸Šå¤åˆ¶ä¿®æ”¹çš„æ•°æ®æ–‡ä»¶å³å¯ã€‚\n\nå°ç»“:\n1ã€å°†æ•°æ®åˆ†ç‰‡æ˜¯ä¸ºäº†æé«˜å¯å¤„ç†æ•°æ®çš„å®¹é‡å’Œæ˜“äºè¿›è¡Œæ°´å¹³æ‰©å±•ï¼Œä¸ºåˆ†ç‰‡åšå‰¯æœ¬æ˜¯ä¸ºäº†æé«˜é›†ç¾¤çš„ç¨³å®šæ€§å’Œæé«˜å¹¶å‘é‡ã€‚2ã€å‰¯æœ¬æ˜¯ä¹˜æ³•ï¼Œè¶Šå¤šæ¶ˆè€—è¶Šå¤§ï¼Œä½†ä¹Ÿè¶Šä¿é™©ã€‚åˆ†ç‰‡æ˜¯é™¤æ³•ï¼Œåˆ†ç‰‡è¶Šå¤šï¼Œå•åˆ†ç‰‡æ•°æ®å°±è¶Šå°‘ä¹Ÿè¶Šåˆ†æ•£ã€‚3ã€å‰¯æœ¬è¶Šå¤šï¼Œé›†ç¾¤çš„å¯ç”¨æ€§å°±è¶Šé«˜ï¼Œä½†æ˜¯ç”±äºæ¯ä¸ªåˆ†ç‰‡éƒ½ç›¸å½“äºä¸€ä¸ªLuceneçš„ç´¢å¼•æ–‡ä»¶ï¼Œä¼šå ç”¨ä¸€å®šçš„æ–‡ä»¶å¥æŸ„ã€å†…å­˜åŠCPUï¼Œå¹¶ä¸”åˆ†ç‰‡é—´çš„æ•°æ®åŒæ­¥ä¹Ÿä¼šå ç”¨ä¸€å®šçš„ç½‘ç»œå¸¦å®½ï¼Œæ‰€ä»¥ç´¢å¼•çš„åˆ†ç‰‡æ•°å’Œå‰¯æœ¬æ•°ä¹Ÿä¸æ˜¯è¶Šå¤šè¶Šå¥½ã€‚\n\næ˜ å°„ï¼ˆMappingï¼‰æ˜ å°„æ˜¯ç”¨äºå®šä¹‰ESå¯¹ç´¢å¼•ä¸­å­—æ®µçš„å­˜å‚¨ç±»å‹ã€åˆ†è¯æ–¹å¼å’Œæ˜¯å¦å­˜å‚¨ç­‰ä¿¡æ¯ï¼Œå°±åƒæ•°æ®åº“ä¸­çš„ schema ï¼Œæè¿°äº†æ–‡æ¡£å¯èƒ½å…·æœ‰çš„å­—æ®µæˆ–å±æ€§ã€æ¯ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹ã€‚åªä¸è¿‡å…³ç³»å‹æ•°æ®åº“å»ºè¡¨æ—¶å¿…é¡»æŒ‡å®šå­—æ®µç±»å‹ï¼Œè€ŒESå¯¹äºå­—æ®µç±»å‹å¯ä»¥ä¸æŒ‡å®šç„¶ååŠ¨æ€å¯¹å­—æ®µç±»å‹çŒœæµ‹ï¼Œä¹Ÿå¯ä»¥åœ¨åˆ›å»ºç´¢å¼•æ—¶å…·ä½“æŒ‡å®šå­—æ®µçš„ç±»å‹ã€‚\nå¯¹å­—æ®µç±»å‹æ ¹æ®æ•°æ®æ ¼å¼è‡ªåŠ¨è¯†åˆ«çš„æ˜ å°„ç§°ä¹‹ä¸ºåŠ¨æ€æ˜ å°„ï¼ˆDynamic mappingï¼‰ ï¼Œæˆ‘ä»¬åˆ›å»ºç´¢å¼•æ—¶å…·ä½“å®šä¹‰å­—æ®µç±»å‹çš„æ˜ å°„ç§°ä¹‹ä¸ºé™æ€æ˜ å°„ æˆ–æ˜¾ç¤ºæ˜ å°„ï¼ˆExplicit mappingï¼‰ ã€‚\nåœ¨è®²è§£åŠ¨æ€æ˜ å°„å’Œé™æ€æ˜ å°„çš„ä½¿ç”¨å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹ESä¸­çš„æ•°æ®æœ‰å“ªäº›å­—æ®µç±»å‹ï¼Ÿä¹‹åæˆ‘ä»¬å†è®²è§£ä¸ºä»€ä¹ˆæˆ‘ä»¬åˆ›å»ºç´¢å¼•æ—¶éœ€è¦å»ºç«‹é™æ€æ˜ å°„è€Œä¸ä½¿ç”¨åŠ¨æ€æ˜ å°„ã€‚\nESï¼ˆv6.8ï¼‰ä¸­å­—æ®µæ•°æ®ç±»å‹ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç±»ï¼š\n\n\n\nç±»åˆ«\næ•°æ®ç±»å‹\n\n\n\næ ¸å¿ƒç±»å‹\ntext, keywords, long, integer, short, double, data, booleanç­‰ç­‰\n\n\nå¤æ‚ç±»å‹\nObject, Nested\n\n\nåœ°ç†ç±»å‹\ngeo_point, geo_shape\n\n\nç‰¹æ®Šç±»å‹\nip, completion, token_count, joinç­‰ç­‰\n\n\nâ€¦â€¦.\nâ€¦\n\n\ntext ç”¨äºç´¢å¼•å…¨æ–‡å€¼çš„å­—æ®µï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶æ­£æ–‡æˆ–äº§å“è¯´æ˜ã€‚è¿™äº›å­—æ®µæ˜¯è¢«åˆ†è¯çš„ï¼Œå®ƒä»¬é€šè¿‡åˆ†è¯å™¨ä¼ é€’ ï¼Œä»¥åœ¨è¢«ç´¢å¼•ä¹‹å‰å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºå•ä¸ªæœ¯è¯­çš„åˆ—è¡¨ã€‚åˆ†æè¿‡ç¨‹å…è®¸Elasticsearchæœç´¢å•ä¸ªå•è¯ä¸­æ¯ä¸ªå®Œæ•´çš„æ–‡æœ¬å­—æ®µã€‚æ–‡æœ¬å­—æ®µä¸ç”¨äºæ’åºï¼Œå¾ˆå°‘ç”¨äºèšåˆã€‚\nkeyword ç”¨äºç´¢å¼•ç»“æ„åŒ–å†…å®¹çš„å­—æ®µï¼Œä¾‹å¦‚ç”µå­é‚®ä»¶åœ°å€ï¼Œä¸»æœºåï¼ŒçŠ¶æ€ä»£ç ï¼Œé‚®æ”¿ç¼–ç æˆ–æ ‡ç­¾ã€‚å®ƒä»¬é€šå¸¸ç”¨äºè¿‡æ»¤ï¼Œæ’åºï¼Œå’Œèšåˆã€‚keywordå­—æ®µåªèƒ½æŒ‰å…¶ç¡®åˆ‡å€¼è¿›è¡Œæœç´¢ã€‚\né€šè¿‡å¯¹å­—æ®µç±»å‹çš„äº†è§£æˆ‘ä»¬çŸ¥é“æœ‰äº›å­—æ®µéœ€è¦æ˜ç¡®å®šä¹‰çš„ï¼Œä¾‹å¦‚æŸä¸ªå­—æ®µæ˜¯textç±»å‹è¿˜æ˜¯kewordç±»å‹å·®åˆ«æ˜¯å¾ˆå¤§çš„ï¼Œæ—¶é—´å­—æ®µä¹Ÿè®¸æˆ‘ä»¬éœ€è¦æŒ‡å®šå®ƒçš„æ—¶é—´æ ¼å¼ï¼Œè¿˜æœ‰ä¸€äº›å­—æ®µæˆ‘ä»¬éœ€è¦æŒ‡å®šç‰¹å®šçš„åˆ†è¯å™¨ç­‰ç­‰ã€‚å¦‚æœé‡‡ç”¨åŠ¨æ€æ˜ å°„æ˜¯ä¸èƒ½ç²¾ç¡®åšåˆ°è¿™äº›çš„ï¼Œè‡ªåŠ¨è¯†åˆ«å¸¸å¸¸ä¼šä¸æˆ‘ä»¬æœŸæœ›çš„æœ‰äº›å·®å¼‚ã€‚\næ‰€ä»¥åˆ›å»ºç´¢å¼•ç»™çš„æ—¶å€™ä¸€ä¸ªå®Œæ•´çš„æ ¼å¼åº”è¯¥æ˜¯æŒ‡å®šåˆ†ç‰‡å’Œå‰¯æœ¬æ•°ä»¥åŠMappingçš„å®šä¹‰ï¼Œå¦‚ä¸‹ï¼š\nPUT my_index&#123;   &quot;settings&quot; : &#123;      &quot;number_of_shards&quot; : 5,      &quot;number_of_replicas&quot; : 1   &#125;  &quot;mappings&quot;: &#123;    &quot;_doc&quot;: &#123;      &quot;properties&quot;: &#123;        &quot;title&quot;:    &#123; &quot;type&quot;: &quot;text&quot;  &#125;,        &quot;name&quot;:     &#123; &quot;type&quot;: &quot;text&quot;  &#125;,        &quot;age&quot;:      &#123; &quot;type&quot;: &quot;integer&quot; &#125;,        &quot;created&quot;:  &#123;          &quot;type&quot;:   &quot;date&quot;,          &quot;format&quot;: &quot;strict_date_optional_time||epoch_millis&quot;        &#125;      &#125;    &#125;  &#125;&#125;\n\nå››ã€åŸºæœ¬ä½¿ç”¨åœ¨å†³å®šä½¿ç”¨ Elasticsearch çš„æ—¶å€™é¦–å…ˆè¦è€ƒè™‘çš„æ˜¯ç‰ˆæœ¬é—®é¢˜ï¼ŒElasticsearch ï¼ˆæ’é™¤ 0.x å’Œ 1.xï¼‰ç›®å‰æœ‰å¦‚ä¸‹å¸¸ç”¨çš„ç¨³å®šçš„ä¸»ç‰ˆæœ¬ï¼š2.xï¼Œ5.xï¼Œ6.xï¼Œ7.xï¼ˆcurrentï¼‰ã€‚ä½ å¯èƒ½ä¼šå‘ç°æ²¡æœ‰ 3.x å’Œ 4.xï¼ŒES ä» 2.4.6 ç›´æ¥è·³åˆ°äº† 5.0.0ã€‚\nå…¶å®æ˜¯ä¸ºäº†ELKï¼ˆElasticSearch, logstash, kibanaï¼‰æŠ€æœ¯æ ˆçš„ç‰ˆæœ¬ç»Ÿä¸€ï¼Œå…çš„ç»™ç”¨æˆ·å¸¦æ¥æ··ä¹±ã€‚åœ¨ Elasticsearch æ˜¯ 2.x ï¼ˆ2.x çš„æœ€åä¸€ç‰ˆ 2.4.6 çš„å‘å¸ƒæ—¶é—´æ˜¯ July 25, 2017ï¼‰ çš„æƒ…å†µä¸‹ï¼Œkibana å·²ç»æ˜¯ 4.xï¼ˆKibana 4.6.5 çš„å‘å¸ƒæ—¶é—´æ˜¯ July 25, 2017ï¼‰ï¼Œé‚£ä¹ˆåœ¨ kibana çš„ä¸‹ä¸€ä¸»ç‰ˆæœ¬è‚¯å®šæ˜¯ 5.x äº†ï¼Œæ‰€ä»¥ Elasticsearch ç›´æ¥å°†è‡ªå·±çš„ä¸»ç‰ˆæœ¬å‘å¸ƒä¸º 5.0.0 äº†ã€‚ç»Ÿä¸€ä¹‹åï¼Œæˆ‘ä»¬é€‰ç‰ˆæœ¬å°±ä¸ä¼šçŠ¹è±«å›°æƒ‘äº†ï¼Œæˆ‘ä»¬é€‰å®š elasticsearch çš„ç‰ˆæœ¬åå†é€‰æ‹©ç›¸åŒç‰ˆæœ¬çš„ kibana å°±è¡Œäº†ï¼Œä¸ç”¨æ‹…å¿§ç‰ˆæœ¬ä¸å…¼å®¹çš„é—®é¢˜ã€‚\nElasticsearchæ˜¯ä½¿ç”¨Javaæ„å»ºï¼Œæ‰€ä»¥é™¤äº†æ³¨æ„ ELK æŠ€æœ¯çš„ç‰ˆæœ¬ç»Ÿä¸€ï¼Œæˆ‘ä»¬åœ¨é€‰æ‹© Elasticsearch çš„ç‰ˆæœ¬çš„æ—¶å€™è¿˜éœ€è¦æ³¨æ„ JDKçš„ç‰ˆæœ¬ã€‚å› ä¸ºæ¯ä¸ªå¤§ç‰ˆæœ¬æ‰€ä¾èµ–çš„ JDKç‰ˆæœ¬ä¹Ÿä¸åŒï¼Œç›®å‰7.2ç‰ˆæœ¬å·²ç»å¯ä»¥æ”¯æŒ jdk11ã€‚\nå®‰è£…ä½¿ç”¨1ã€ä¸‹è½½å’Œè§£å‹Elasticsearchï¼Œæ— éœ€å®‰è£…è§£å‹åå³å¯ç”¨ï¼Œè§£å‹åç›®å½•å¦‚ä¸‹ã€‚\n\nbinï¼šäºŒè¿›åˆ¶ç³»ç»ŸæŒ‡ä»¤ç›®å½•ï¼ŒåŒ…å«å¯åŠ¨å‘½ä»¤å’Œå®‰è£…æ’ä»¶å‘½ä»¤ç­‰ã€‚\nconfigï¼šé…ç½®æ–‡ä»¶ç›®å½•ã€‚\ndataï¼šæ•°æ®å­˜å‚¨ç›®å½•ã€‚\nlibï¼šä¾èµ–åŒ…ç›®å½•ã€‚\nlogsï¼šæ—¥å¿—æ–‡ä»¶ç›®å½•ã€‚\nmodulesï¼šæ¨¡å—åº“ï¼Œä¾‹å¦‚x-packçš„æ¨¡å—ã€‚\npluginsï¼šæ’ä»¶ç›®å½•ã€‚\n\n2ã€å®‰è£…ç›®å½•ä¸‹è¿è¡Œ bin/elasticsearchæ¥å¯åŠ¨ ESã€‚3ã€é»˜è®¤åœ¨9200ç«¯å£è¿è¡Œï¼Œè¯·æ±‚curl http://localhost:9200/ æˆ–è€…æµè§ˆå™¨è¾“å…¥http://localhost:9200ï¼Œå¾—åˆ°ä¸€ä¸ª JSON å¯¹è±¡ï¼Œå…¶ä¸­åŒ…å«å½“å‰èŠ‚ç‚¹ã€é›†ç¾¤ã€ç‰ˆæœ¬ç­‰ä¿¡æ¯ã€‚\n&#123;  &quot;name&quot; : &quot;U7fp3O9&quot;,  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,  &quot;cluster_uuid&quot; : &quot;-Rj8jGQvRIelGd9ckicUOA&quot;,  &quot;version&quot; : &#123;    &quot;number&quot; : &quot;6.8.1&quot;,    &quot;build_flavor&quot; : &quot;default&quot;,    &quot;build_type&quot; : &quot;zip&quot;,    &quot;build_hash&quot; : &quot;1fad4e1&quot;,    &quot;build_date&quot; : &quot;2019-06-18T13:16:52.517138Z&quot;,    &quot;build_snapshot&quot; : false,    &quot;lucene_version&quot; : &quot;7.7.0&quot;,    &quot;minimum_wire_compatibility_version&quot; : &quot;5.6.0&quot;,    &quot;minimum_index_compatibility_version&quot; : &quot;5.0.0&quot;  &#125;,  &quot;tagline&quot; : &quot;You Know, for Search&quot;&#125;\n\né›†ç¾¤å¥åº·çŠ¶æ€è¦æ£€æŸ¥ç¾¤é›†è¿è¡ŒçŠ¶å†µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ Kibana æ§åˆ¶å°ä¸­è¿è¡Œä»¥ä¸‹å‘½ä»¤ GET /_cluster/healthï¼Œå¾—åˆ°å¦‚ä¸‹ä¿¡æ¯ï¼š\n&#123;  &quot;cluster_name&quot; : &quot;wujiajian&quot;,  &quot;status&quot; : &quot;yellow&quot;,  &quot;timed_out&quot; : false,  &quot;number_of_nodes&quot; : 1,  &quot;number_of_data_nodes&quot; : 1,  &quot;active_primary_shards&quot; : 9,  &quot;active_shards&quot; : 9,  &quot;relocating_shards&quot; : 0,  &quot;initializing_shards&quot; : 0,  &quot;unassigned_shards&quot; : 5,  &quot;delayed_unassigned_shards&quot; : 0,  &quot;number_of_pending_tasks&quot; : 0,  &quot;number_of_in_flight_fetch&quot; : 0,  &quot;task_max_waiting_in_queue_millis&quot; : 0,  &quot;active_shards_percent_as_number&quot; : 64.28571428571429&#125;\n\né›†ç¾¤çŠ¶æ€é€šè¿‡ ç»¿ï¼Œé»„ï¼Œçº¢ æ¥æ ‡è¯†\n\nç»¿è‰² ï¼šé›†ç¾¤å¥åº·å®Œå¥½ï¼Œä¸€åˆ‡åŠŸèƒ½é½å…¨æ­£å¸¸ï¼Œæ‰€æœ‰åˆ†ç‰‡å’Œå‰¯æœ¬éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œã€‚\né»„è‰² ï¼šé¢„è­¦çŠ¶æ€ï¼Œæ‰€æœ‰ä¸»åˆ†ç‰‡åŠŸèƒ½æ­£å¸¸ï¼Œä½†è‡³å°‘æœ‰ä¸€ä¸ªå‰¯æœ¬æ˜¯ä¸èƒ½æ­£å¸¸å·¥ä½œçš„ã€‚æ­¤æ—¶é›†ç¾¤æ˜¯å¯ä»¥æ­£å¸¸å·¥ä½œçš„ï¼Œä½†æ˜¯é«˜å¯ç”¨æ€§åœ¨æŸç§ç¨‹åº¦ä¸Šä¼šå—å½±å“ã€‚\nçº¢è‰² ï¼šé›†ç¾¤ä¸å¯æ­£å¸¸ä½¿ç”¨ã€‚æŸä¸ªæˆ–æŸäº›åˆ†ç‰‡åŠå…¶å‰¯æœ¬å¼‚å¸¸ä¸å¯ç”¨ï¼Œè¿™æ—¶é›†ç¾¤çš„æŸ¥è¯¢æ“ä½œè¿˜èƒ½æ‰§è¡Œï¼Œä½†æ˜¯è¿”å›çš„ç»“æœä¼šä¸å‡†ç¡®ã€‚å¯¹äºåˆ†é…åˆ°è¿™ä¸ªåˆ†ç‰‡çš„å†™å…¥è¯·æ±‚å°†ä¼šæŠ¥é”™ï¼Œæœ€ç»ˆä¼šå¯¼è‡´æ•°æ®çš„ä¸¢å¤±ã€‚\n\nå½“é›†ç¾¤çŠ¶æ€ä¸ºçº¢è‰²æ—¶ï¼Œå®ƒå°†ä¼šç»§ç»­ä»å¯ç”¨çš„åˆ†ç‰‡æä¾›æœç´¢è¯·æ±‚æœåŠ¡ï¼Œä½†æ˜¯ä½ éœ€è¦å°½å¿«ä¿®å¤é‚£äº›æœªåˆ†é…çš„åˆ†ç‰‡ã€‚\näº”ã€æœºåˆ¶åŸç†ESçš„åŸºæœ¬æ¦‚å¿µå’ŒåŸºæœ¬æ“ä½œä»‹ç»å®Œäº†ä¹‹åæˆ‘ä»¬å¯èƒ½è¿˜æœ‰å¾ˆå¤šç–‘æƒ‘ï¼Œå®ƒä»¬å†…éƒ¨æ˜¯å¦‚ä½•è¿è¡Œçš„ï¼Ÿä¸»åˆ†ç‰‡å’Œå‰¯æœ¬åˆ†ç‰‡æ˜¯å¦‚ä½•åŒæ­¥çš„ï¼Ÿåˆ›å»ºç´¢å¼•çš„æµç¨‹æ˜¯ä»€ä¹ˆæ ·çš„ï¼ŸESå¦‚ä½•å°†ç´¢å¼•æ•°æ®åˆ†é…åˆ°ä¸åŒçš„åˆ†ç‰‡ä¸Šçš„ï¼Ÿä»¥åŠè¿™äº›ç´¢å¼•æ•°æ®æ˜¯å¦‚ä½•å­˜å‚¨çš„ï¼Ÿä¸ºä»€ä¹ˆè¯´ESæ˜¯è¿‘å®æ—¶ æœç´¢å¼•æ“è€Œæ–‡æ¡£çš„ CRUD (åˆ›å»º-è¯»å–-æ›´æ–°-åˆ é™¤) æ“ä½œæ˜¯å®æ—¶çš„ï¼Ÿä»¥åŠElasticsearch æ˜¯æ€æ ·ä¿è¯æ›´æ–°è¢«æŒä¹…åŒ–åœ¨æ–­ç”µæ—¶ä¹Ÿä¸ä¸¢å¤±æ•°æ®ï¼Ÿè¿˜æœ‰ä¸ºä»€ä¹ˆåˆ é™¤æ–‡æ¡£ä¸ä¼šç«‹åˆ»é‡Šæ”¾ç©ºé—´ï¼Ÿå¸¦ç€è¿™äº›ç–‘é—®æˆ‘ä»¬è¿›å…¥æ¥ä¸‹æ¥çš„å†…å®¹ã€‚\nå†™ç´¢å¼•åŸç†ä¸‹å›¾æè¿°äº†3ä¸ªèŠ‚ç‚¹çš„é›†ç¾¤ï¼Œå…±æ‹¥æœ‰12ä¸ªåˆ†ç‰‡ï¼Œå…¶ä¸­æœ‰4ä¸ªä¸»åˆ†ç‰‡ï¼ˆS0ã€S1ã€S2ã€S3ï¼‰å’Œ8ä¸ªå‰¯æœ¬åˆ†ç‰‡ï¼ˆR0ã€R1ã€R2ã€R3ï¼‰ï¼Œæ¯ä¸ªä¸»åˆ†ç‰‡å¯¹åº”ä¸¤ä¸ªå‰¯æœ¬åˆ†ç‰‡ï¼ŒèŠ‚ç‚¹1æ˜¯ä¸»èŠ‚ç‚¹ï¼ˆMasterèŠ‚ç‚¹ï¼‰è´Ÿè´£æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ã€‚\n\nå†™ç´¢å¼•æ˜¯åªèƒ½å†™åœ¨ä¸»åˆ†ç‰‡ä¸Šï¼Œç„¶ååŒæ­¥åˆ°å‰¯æœ¬åˆ†ç‰‡ã€‚è¿™é‡Œæœ‰å››ä¸ªä¸»åˆ†ç‰‡ï¼Œä¸€æ¡æ•°æ®ESæ˜¯æ ¹æ®ä»€ä¹ˆè§„åˆ™å†™åˆ°ç‰¹å®šåˆ†ç‰‡ä¸Šçš„å‘¢ï¼Ÿè¿™æ¡ç´¢å¼•æ•°æ®ä¸ºä»€ä¹ˆè¢«å†™åˆ°S0ä¸Šè€Œä¸å†™åˆ°S1æˆ–S2ä¸Šï¼Ÿé‚£æ¡æ•°æ®ä¸ºä»€ä¹ˆåˆè¢«å†™åˆ°S3ä¸Šè€Œä¸å†™åˆ°S0ä¸Šäº†ï¼Ÿ\né¦–å…ˆè¿™è‚¯å®šä¸ä¼šæ˜¯éšæœºçš„ï¼Œå¦åˆ™å°†æ¥è¦è·å–æ–‡æ¡£çš„æ—¶å€™æˆ‘ä»¬å°±ä¸çŸ¥é“ä»ä½•å¤„å¯»æ‰¾äº†ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯æ ¹æ®ä¸‹é¢è¿™ä¸ªå…¬å¼å†³å®šçš„ï¼š\nshard = hash(routing) % number_of_primary_shards\n\nrouting æ˜¯ä¸€ä¸ªå¯å˜å€¼ï¼Œé»˜è®¤æ˜¯æ–‡æ¡£çš„ _id ï¼Œä¹Ÿå¯ä»¥è®¾ç½®æˆä¸€ä¸ªè‡ªå®šä¹‰çš„å€¼ã€‚routing é€šè¿‡ hash å‡½æ•°ç”Ÿæˆä¸€ä¸ªæ•°å­—ï¼Œç„¶åè¿™ä¸ªæ•°å­—å†é™¤ä»¥ number_of_primary_shards ï¼ˆä¸»åˆ†ç‰‡çš„æ•°é‡ï¼‰åå¾—åˆ°ä½™æ•° ã€‚è¿™ä¸ªåœ¨ 0 åˆ° number_of_primary_shards-1 ä¹‹é—´çš„ä½™æ•°ï¼Œå°±æ˜¯æˆ‘ä»¬æ‰€å¯»æ±‚çš„æ–‡æ¡£æ‰€åœ¨åˆ†ç‰‡çš„ä½ç½®ã€‚\nè¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦åœ¨åˆ›å»ºç´¢å¼•çš„æ—¶å€™å°±ç¡®å®šå¥½ä¸»åˆ†ç‰‡çš„æ•°é‡å¹¶ä¸”æ°¸è¿œä¸ä¼šæ”¹å˜è¿™ä¸ªæ•°é‡ï¼šå› ä¸ºå¦‚æœæ•°é‡å˜åŒ–äº†ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¹‹å‰è·¯ç”±çš„å€¼éƒ½ä¼šæ— æ•ˆï¼Œæ–‡æ¡£ä¹Ÿå†ä¹Ÿæ‰¾ä¸åˆ°äº†ã€‚\nç”±äºåœ¨ESé›†ç¾¤ä¸­æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡ä¸Šé¢çš„è®¡ç®—å…¬å¼éƒ½çŸ¥é“é›†ç¾¤ä¸­çš„æ–‡æ¡£çš„å­˜æ”¾ä½ç½®ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¤„ç†è¯»å†™è¯·æ±‚çš„èƒ½åŠ›ã€‚åœ¨ä¸€ä¸ªå†™è¯·æ±‚è¢«å‘é€åˆ°æŸä¸ªèŠ‚ç‚¹åï¼Œè¯¥èŠ‚ç‚¹å³ä¸ºå‰é¢è¯´è¿‡çš„åè°ƒèŠ‚ç‚¹ï¼Œåè°ƒèŠ‚ç‚¹ä¼šæ ¹æ®è·¯ç”±å…¬å¼è®¡ç®—å‡ºéœ€è¦å†™åˆ°å“ªä¸ªåˆ†ç‰‡ä¸Šï¼Œå†å°†è¯·æ±‚è½¬å‘åˆ°è¯¥åˆ†ç‰‡çš„ä¸»åˆ†ç‰‡èŠ‚ç‚¹ä¸Šã€‚\nå‡å¦‚æ­¤æ—¶æ•°æ®é€šè¿‡è·¯ç”±è®¡ç®—å…¬å¼å–ä½™åå¾—åˆ°çš„å€¼æ˜¯ shard = hash(routing) % 4 = 0ï¼Œåˆ™å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š\n\n\nå®¢æˆ·ç«¯å‘ES1èŠ‚ç‚¹ï¼ˆåè°ƒèŠ‚ç‚¹ï¼‰å‘é€å†™è¯·æ±‚ï¼Œé€šè¿‡è·¯ç”±è®¡ç®—å…¬å¼å¾—åˆ°å€¼ä¸º0ï¼Œåˆ™å½“å‰æ•°æ®åº”è¢«å†™åˆ°ä¸»åˆ†ç‰‡S0ä¸Šã€‚\nES1èŠ‚ç‚¹å°†è¯·æ±‚è½¬å‘åˆ°S0ä¸»åˆ†ç‰‡æ‰€åœ¨çš„èŠ‚ç‚¹ES3ï¼ŒES3æ¥å—è¯·æ±‚å¹¶å†™å…¥åˆ°ç£ç›˜ã€‚\nå¹¶å‘å°†æ•°æ®å¤åˆ¶åˆ°ä¸¤ä¸ªå‰¯æœ¬åˆ†ç‰‡R0ä¸Šï¼Œå…¶ä¸­é€šè¿‡ä¹è§‚å¹¶å‘æ§åˆ¶æ•°æ®çš„å†²çªã€‚ä¸€æ—¦æ‰€æœ‰çš„å‰¯æœ¬åˆ†ç‰‡éƒ½æŠ¥å‘ŠæˆåŠŸï¼Œåˆ™èŠ‚ç‚¹ES3å°†å‘åè°ƒèŠ‚ç‚¹æŠ¥å‘ŠæˆåŠŸï¼Œåè°ƒèŠ‚ç‚¹å‘å®¢æˆ·ç«¯æŠ¥å‘ŠæˆåŠŸã€‚\n\nå­˜å‚¨åŸç†ä¸Šé¢ä»‹ç»äº†åœ¨ESå†…éƒ¨ç´¢å¼•çš„å†™å¤„ç†æµç¨‹ï¼Œè¿™ä¸ªæµç¨‹æ˜¯åœ¨ESçš„å†…å­˜ä¸­æ‰§è¡Œçš„ï¼Œæ•°æ®è¢«åˆ†é…åˆ°ç‰¹å®šçš„åˆ†ç‰‡å’Œå‰¯æœ¬ä¸Šä¹‹åï¼Œæœ€ç»ˆæ˜¯å­˜å‚¨åˆ°ç£ç›˜ä¸Šçš„ï¼Œè¿™æ ·åœ¨æ–­ç”µçš„æ—¶å€™å°±ä¸ä¼šä¸¢å¤±æ•°æ®ã€‚å…·ä½“çš„å­˜å‚¨è·¯å¾„å¯åœ¨é…ç½®æ–‡ä»¶../config/elasticsearch.ymlä¸­è¿›è¡Œè®¾ç½®ï¼Œé»˜è®¤å­˜å‚¨åœ¨å®‰è£…ç›®å½•çš„dataæ–‡ä»¶å¤¹ä¸‹ã€‚å»ºè®®ä¸è¦ä½¿ç”¨é»˜è®¤å€¼ï¼Œå› ä¸ºè‹¥ESè¿›è¡Œäº†å‡çº§ï¼Œåˆ™æœ‰å¯èƒ½å¯¼è‡´æ•°æ®å…¨éƒ¨ä¸¢å¤±ã€‚\npath.data: /path/to/data  //ç´¢å¼•æ•°æ®path.logs: /path/to/logs  //æ—¥å¿—è®°å½•\n\nåˆ†æ®µå­˜å‚¨ç´¢å¼•æ–‡æ¡£ä»¥æ®µçš„å½¢å¼å­˜å‚¨åœ¨ç£ç›˜ä¸Šï¼Œä½•ä¸ºæ®µ ï¼Ÿç´¢å¼•æ–‡ä»¶è¢«æ‹†åˆ†ä¸ºå¤šä¸ªå­æ–‡ä»¶ï¼Œåˆ™æ¯ä¸ªå­æ–‡ä»¶å«ä½œæ®µ ï¼Œ æ¯ä¸€ä¸ªæ®µæœ¬èº«éƒ½æ˜¯ä¸€ä¸ªå€’æ’ç´¢å¼•ï¼Œå¹¶ä¸”æ®µå…·æœ‰ä¸å˜æ€§ï¼Œä¸€æ—¦ç´¢å¼•çš„æ•°æ®è¢«å†™å…¥ç¡¬ç›˜ï¼Œå°±ä¸å¯å†ä¿®æ”¹ã€‚åœ¨åº•å±‚é‡‡ç”¨äº†åˆ†æ®µçš„å­˜å‚¨æ¨¡å¼ï¼Œä½¿å®ƒåœ¨è¯»å†™æ—¶å‡ ä¹å®Œå…¨é¿å…äº†é”çš„å‡ºç°ï¼Œå¤§å¤§æå‡äº†è¯»å†™æ€§èƒ½ã€‚\næ®µè¢«å†™å…¥åˆ°ç£ç›˜åä¼šç”Ÿæˆä¸€ä¸ªæäº¤ç‚¹ ï¼Œæäº¤ç‚¹æ˜¯ä¸€ä¸ªç”¨æ¥è®°å½•æ‰€æœ‰æäº¤åæ®µä¿¡æ¯çš„æ–‡ä»¶ã€‚ä¸€ä¸ªæ®µä¸€æ—¦æ‹¥æœ‰äº†æäº¤ç‚¹ï¼Œå°±è¯´æ˜è¿™ä¸ªæ®µåªæœ‰è¯»çš„æƒé™ï¼Œå¤±å»äº†å†™çš„æƒé™ã€‚ç›¸åï¼Œå½“æ®µåœ¨å†…å­˜ä¸­æ—¶ï¼Œå°±åªæœ‰å†™çš„æƒé™ï¼Œè€Œä¸å…·å¤‡è¯»æ•°æ®çš„æƒé™ï¼Œæ„å‘³ç€ä¸èƒ½è¢«æ£€ç´¢ã€‚\n\næ®µ çš„æ¦‚å¿µæå‡ºä¸»è¦æ˜¯å› ä¸ºï¼šåœ¨æ—©æœŸå…¨æ–‡æ£€ç´¢ä¸­ä¸ºæ•´ä¸ªæ–‡æ¡£é›†åˆå»ºç«‹äº†ä¸€ä¸ªå¾ˆå¤§çš„å€’æ’ç´¢å¼•ï¼Œå¹¶å°†å…¶å†™å…¥ç£ç›˜ä¸­ã€‚å¦‚æœç´¢å¼•æœ‰æ›´æ–°ï¼Œå°±éœ€è¦é‡æ–°å…¨é‡åˆ›å»ºä¸€ä¸ªç´¢å¼•æ¥æ›¿æ¢åŸæ¥çš„ç´¢å¼•ã€‚è¿™ç§æ–¹å¼åœ¨æ•°æ®é‡å¾ˆå¤§æ—¶æ•ˆç‡å¾ˆä½ï¼Œå¹¶ä¸”ç”±äºåˆ›å»ºä¸€æ¬¡ç´¢å¼•çš„æˆæœ¬å¾ˆé«˜ï¼Œæ‰€ä»¥å¯¹æ•°æ®çš„æ›´æ–°ä¸èƒ½è¿‡äºé¢‘ç¹ï¼Œä¹Ÿå°±ä¸èƒ½ä¿è¯æ—¶æ•ˆæ€§ã€‚\nç´¢å¼•æ–‡ä»¶åˆ†æ®µå­˜å‚¨å¹¶ä¸”ä¸å¯ä¿®æ”¹ï¼Œé‚£ä¹ˆæ–°å¢ã€æ›´æ–°å’Œåˆ é™¤å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ\n\næ–°å¢ï¼Œæ–°å¢å¾ˆå¥½å¤„ç†ï¼Œç”±äºæ•°æ®æ˜¯æ–°çš„ï¼Œæ‰€ä»¥åªéœ€è¦å¯¹å½“å‰æ–‡æ¡£æ–°å¢ä¸€ä¸ªæ®µå°±å¯ä»¥äº†ã€‚\nåˆ é™¤ï¼Œç”±äºä¸å¯ä¿®æ”¹ï¼Œæ‰€ä»¥å¯¹äºåˆ é™¤æ“ä½œï¼Œä¸ä¼šæŠŠæ–‡æ¡£ä»æ—§çš„æ®µä¸­ç§»é™¤è€Œæ˜¯é€šè¿‡æ–°å¢ä¸€ä¸ª.delæ–‡ä»¶ï¼Œæ–‡ä»¶ä¸­ä¼šåˆ—å‡ºè¿™äº›è¢«åˆ é™¤æ–‡æ¡£çš„æ®µä¿¡æ¯ã€‚è¿™ä¸ªè¢«æ ‡è®°åˆ é™¤çš„æ–‡æ¡£ä»ç„¶å¯ä»¥è¢«æŸ¥è¯¢åŒ¹é…åˆ°ï¼Œ ä½†å®ƒä¼šåœ¨æœ€ç»ˆç»“æœè¢«è¿”å›å‰ä»ç»“æœé›†ä¸­ç§»é™¤ã€‚\næ›´æ–°ï¼Œä¸èƒ½ä¿®æ”¹æ—§çš„æ®µæ¥è¿›è¡Œåæ˜ æ–‡æ¡£çš„æ›´æ–°ï¼Œå…¶å®æ›´æ–°ç›¸å½“äºæ˜¯åˆ é™¤å’Œæ–°å¢è¿™ä¸¤ä¸ªåŠ¨ä½œç»„æˆã€‚ä¼šå°†æ—§çš„æ–‡æ¡£åœ¨.delæ–‡ä»¶ä¸­æ ‡è®°åˆ é™¤ï¼Œç„¶åæ–‡æ¡£çš„æ–°ç‰ˆæœ¬è¢«ç´¢å¼•åˆ°ä¸€ä¸ªæ–°çš„æ®µä¸­ã€‚å¯èƒ½ä¸¤ä¸ªç‰ˆæœ¬çš„æ–‡æ¡£éƒ½ä¼šè¢«ä¸€ä¸ªæŸ¥è¯¢åŒ¹é…åˆ°ï¼Œä½†è¢«åˆ é™¤çš„é‚£ä¸ªæ—§ç‰ˆæœ¬æ–‡æ¡£åœ¨ç»“æœé›†è¿”å›å‰å°±ä¼šè¢«ç§»é™¤ã€‚\n\næ®µè¢«è®¾å®šä¸ºä¸å¯ä¿®æ”¹å…·æœ‰ä¸€å®šçš„ä¼˜åŠ¿ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼Œä¼˜åŠ¿ä¸»è¦è¡¨ç°åœ¨ï¼š\n\nä¸éœ€è¦é”ã€‚å¦‚æœä½ ä»æ¥ä¸æ›´æ–°ç´¢å¼•ï¼Œä½ å°±ä¸éœ€è¦æ‹…å¿ƒå¤šè¿›ç¨‹åŒæ—¶ä¿®æ”¹æ•°æ®çš„é—®é¢˜ã€‚\nä¸€æ—¦ç´¢å¼•è¢«è¯»å…¥å†…æ ¸çš„æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œä¾¿ä¼šç•™åœ¨å“ªé‡Œï¼Œç”±äºå…¶ä¸å˜æ€§ã€‚åªè¦æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­è¿˜æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œé‚£ä¹ˆå¤§éƒ¨åˆ†è¯»è¯·æ±‚ä¼šç›´æ¥è¯·æ±‚å†…å­˜ï¼Œè€Œä¸ä¼šå‘½ä¸­ç£ç›˜ã€‚è¿™æä¾›äº†å¾ˆå¤§çš„æ€§èƒ½æå‡ã€‚\nå…¶å®ƒç¼“å­˜(åƒfilterç¼“å­˜)ï¼Œåœ¨ç´¢å¼•çš„ç”Ÿå‘½å‘¨æœŸå†…å§‹ç»ˆæœ‰æ•ˆã€‚å®ƒä»¬ä¸éœ€è¦åœ¨æ¯æ¬¡æ•°æ®æ”¹å˜æ—¶è¢«é‡å»ºï¼Œå› ä¸ºæ•°æ®ä¸ä¼šå˜åŒ–ã€‚\nå†™å…¥å•ä¸ªå¤§çš„å€’æ’ç´¢å¼•å…è®¸æ•°æ®è¢«å‹ç¼©ï¼Œå‡å°‘ç£ç›˜ I/O å’Œ éœ€è¦è¢«ç¼“å­˜åˆ°å†…å­˜çš„ç´¢å¼•çš„ä½¿ç”¨é‡ã€‚\n\næ®µçš„ä¸å˜æ€§çš„ç¼ºç‚¹å¦‚ä¸‹ï¼š\n\nå½“å¯¹æ—§æ•°æ®è¿›è¡Œåˆ é™¤æ—¶ï¼Œæ—§æ•°æ®ä¸ä¼šé©¬ä¸Šè¢«åˆ é™¤ï¼Œè€Œæ˜¯åœ¨.delæ–‡ä»¶ä¸­è¢«æ ‡è®°ä¸ºåˆ é™¤ã€‚è€Œæ—§æ•°æ®åªèƒ½ç­‰åˆ°æ®µæ›´æ–°æ—¶æ‰èƒ½è¢«ç§»é™¤ï¼Œè¿™æ ·ä¼šé€ æˆå¤§é‡çš„ç©ºé—´æµªè´¹ã€‚\nè‹¥æœ‰ä¸€æ¡æ•°æ®é¢‘ç¹çš„æ›´æ–°ï¼Œæ¯æ¬¡æ›´æ–°éƒ½æ˜¯æ–°å¢æ–°çš„æ ‡è®°æ—§çš„ï¼Œåˆ™ä¼šæœ‰å¤§é‡çš„ç©ºé—´æµªè´¹ã€‚\næ¯æ¬¡æ–°å¢æ•°æ®æ—¶éƒ½éœ€è¦æ–°å¢ä¸€ä¸ªæ®µæ¥å­˜å‚¨æ•°æ®ã€‚å½“æ®µçš„æ•°é‡å¤ªå¤šæ—¶ï¼Œå¯¹æœåŠ¡å™¨çš„èµ„æºä¾‹å¦‚æ–‡ä»¶å¥æŸ„çš„æ¶ˆè€—ä¼šéå¸¸å¤§ã€‚\nåœ¨æŸ¥è¯¢çš„ç»“æœä¸­åŒ…å«æ‰€æœ‰çš„ç»“æœé›†ï¼Œéœ€è¦æ’é™¤è¢«æ ‡è®°åˆ é™¤çš„æ—§æ•°æ®ï¼Œè¿™å¢åŠ äº†æŸ¥è¯¢çš„è´Ÿæ‹…ã€‚\n\nå»¶è¿Ÿå†™ç­–ç•¥ä»‹ç»å®Œäº†å­˜å‚¨çš„å½¢å¼ï¼Œé‚£ä¹ˆç´¢å¼•æ˜¯å†™å…¥åˆ°ç£ç›˜çš„è¿‡ç¨‹æ˜¯è¿™æ€æ ·çš„ï¼Ÿæ˜¯å¦æ˜¯ç›´æ¥è°ƒ fsync ç‰©ç†æ€§åœ°å†™å…¥ç£ç›˜ï¼Ÿ\n\nç­”æ¡ˆæ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œå¦‚æœæ˜¯ç›´æ¥å†™å…¥åˆ°ç£ç›˜ä¸Šï¼Œç£ç›˜çš„I/Oæ¶ˆè€—ä¸Šä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œé‚£ä¹ˆå½“å†™æ•°æ®é‡å¤§çš„æ—¶å€™ä¼šé€ æˆESåœé¡¿å¡æ­»ï¼ŒæŸ¥è¯¢ä¹Ÿæ— æ³•åšåˆ°å¿«é€Ÿå“åº”ã€‚å¦‚æœçœŸæ˜¯è¿™æ ·ESä¹Ÿå°±ä¸ä¼šç§°ä¹‹ä¸ºè¿‘å®æ—¶ å…¨æ–‡æœç´¢å¼•æ“äº†ã€‚\n\nä¸ºäº†æå‡å†™çš„æ€§èƒ½ï¼ŒESå¹¶æ²¡æœ‰æ¯æ–°å¢ä¸€æ¡æ•°æ®å°±å¢åŠ ä¸€ä¸ªæ®µåˆ°ç£ç›˜ä¸Šï¼Œè€Œæ˜¯é‡‡ç”¨å»¶è¿Ÿå†™ çš„ç­–ç•¥ã€‚\næ¯å½“æœ‰æ–°å¢çš„æ•°æ®æ—¶ï¼Œå°±å°†å…¶å…ˆå†™å…¥åˆ°å†…å­˜ä¸­ï¼Œåœ¨å†…å­˜å’Œç£ç›˜ä¹‹é—´æ˜¯æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œå½“è¾¾åˆ°é»˜è®¤çš„æ—¶é—´ï¼ˆ1ç§’é’Ÿï¼‰æˆ–è€…å†…å­˜çš„æ•°æ®è¾¾åˆ°ä¸€å®šé‡æ—¶ï¼Œä¼šè§¦å‘ä¸€æ¬¡åˆ·æ–°ï¼ˆRefreshï¼‰ï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ç”Ÿæˆåˆ°ä¸€ä¸ªæ–°çš„æ®µä¸Šå¹¶ç¼“å­˜åˆ°æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿ ä¸Šï¼Œç¨åå†è¢«åˆ·æ–°åˆ°ç£ç›˜ä¸­å¹¶ç”Ÿæˆæäº¤ç‚¹ ã€‚\nè¿™é‡Œçš„å†…å­˜ä½¿ç”¨çš„æ˜¯ESçš„JVMå†…å­˜ï¼Œè€Œæ–‡ä»¶ç¼“å­˜ç³»ç»Ÿä½¿ç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„å†…å­˜ã€‚æ–°çš„æ•°æ®ä¼šç»§ç»­çš„è¢«å†™å…¥å†…å­˜ï¼Œä½†å†…å­˜ä¸­çš„æ•°æ®å¹¶ä¸æ˜¯ä»¥æ®µçš„å½¢å¼å­˜å‚¨çš„ï¼Œå› æ­¤ä¸èƒ½æä¾›æ£€ç´¢åŠŸèƒ½ã€‚ç”±å†…å­˜åˆ·æ–°åˆ°æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿçš„æ—¶å€™ä¼šç”Ÿæˆäº†æ–°çš„æ®µï¼Œå¹¶å°†æ®µæ‰“å¼€ä»¥ä¾›æœç´¢ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦ç­‰åˆ°è¢«åˆ·æ–°åˆ°ç£ç›˜ã€‚\nåœ¨ Elasticsearch ä¸­ï¼Œå†™å…¥å’Œæ‰“å¼€ä¸€ä¸ªæ–°æ®µçš„è½»é‡çš„è¿‡ç¨‹å«åš refresh ï¼ˆå³å†…å­˜åˆ·æ–°åˆ°æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹æ¯ä¸ªåˆ†ç‰‡ä¼šæ¯ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¯´ Elasticsearch æ˜¯è¿‘å®æ—¶æœç´¢ ï¼Œå› ä¸ºæ–‡æ¡£çš„å˜åŒ–å¹¶ä¸æ˜¯ç«‹å³å¯¹æœç´¢å¯è§ï¼Œä½†ä¼šåœ¨ä¸€ç§’ä¹‹å†…å˜ä¸ºå¯è§ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘ refreshï¼ŒPOST /_refresh åˆ·æ–°æ‰€æœ‰ç´¢å¼•ï¼ŒPOST /nba/_refreshåˆ·æ–°æŒ‡å®šçš„ç´¢å¼•ã€‚\n\nTips ï¼šå°½ç®¡åˆ·æ–°æ˜¯æ¯”æäº¤è½»é‡å¾ˆå¤šçš„æ“ä½œï¼Œå®ƒè¿˜æ˜¯ä¼šæœ‰æ€§èƒ½å¼€é”€ã€‚å½“å†™æµ‹è¯•çš„æ—¶å€™ï¼Œ æ‰‹åŠ¨åˆ·æ–°å¾ˆæœ‰ç”¨ï¼Œä½†æ˜¯ä¸è¦åœ¨ç”Ÿäº§&gt; ç¯å¢ƒä¸‹æ¯æ¬¡ç´¢å¼•ä¸€ä¸ªæ–‡æ¡£éƒ½å»æ‰‹åŠ¨åˆ·æ–°ã€‚è€Œä¸”å¹¶ä¸æ˜¯æ‰€æœ‰çš„æƒ…å†µéƒ½éœ€è¦æ¯ç§’åˆ·æ–°ã€‚å¯èƒ½ä½ æ­£åœ¨ä½¿ç”¨ Elasticsearch ç´¢å¼•å¤§é‡çš„æ—¥å¿—æ–‡ä»¶ï¼Œ ä½ å¯èƒ½æƒ³ä¼˜åŒ–ç´¢å¼•é€Ÿåº¦è€Œä¸æ˜¯&gt; è¿‘å®æ—¶æœç´¢ï¼Œ è¿™æ—¶å¯ä»¥åœ¨åˆ›å»ºç´¢å¼•æ—¶åœ¨settingsä¸­é€šè¿‡è°ƒå¤§refresh_interval = &quot;30s&quot; çš„å€¼ ï¼Œ é™ä½æ¯ä¸ªç´¢å¼•çš„åˆ·æ–°é¢‘ç‡ï¼Œè®¾å€¼æ—¶éœ€è¦æ³¨æ„åé¢å¸¦ä¸Šæ—¶é—´å•ä½ï¼Œå¦åˆ™é»˜è®¤æ˜¯æ¯«ç§’ã€‚å½“refresh_interval = -1æ—¶è¡¨ç¤ºå…³é—­ç´¢å¼•çš„è‡ªåŠ¨åˆ·æ–°ã€‚\n\nè™½ç„¶é€šè¿‡å»¶æ—¶å†™çš„ç­–ç•¥å¯ä»¥å‡å°‘æ•°æ®å¾€ç£ç›˜ä¸Šå†™çš„æ¬¡æ•°æå‡äº†æ•´ä½“çš„å†™å…¥èƒ½åŠ›ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿä¹Ÿæ˜¯å†…å­˜ç©ºé—´ï¼Œå±äºæ“ä½œç³»ç»Ÿçš„å†…å­˜ï¼Œåªè¦æ˜¯å†…å­˜éƒ½å­˜åœ¨æ–­ç”µæˆ–å¼‚å¸¸æƒ…å†µä¸‹ä¸¢å¤±æ•°æ®çš„å±é™©ã€‚\nä¸ºäº†é¿å…ä¸¢å¤±æ•°æ®ï¼ŒElasticsearchæ·»åŠ äº†äº‹åŠ¡æ—¥å¿—ï¼ˆTranslogï¼‰ ï¼Œäº‹åŠ¡æ—¥å¿—è®°å½•äº†æ‰€æœ‰è¿˜æ²¡æœ‰æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ•°æ®ã€‚æ·»åŠ äº†äº‹åŠ¡æ—¥å¿—åæ•´ä¸ªå†™ç´¢å¼•çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚\n\n\nä¸€ä¸ªæ–°æ–‡æ¡£è¢«ç´¢å¼•ä¹‹åï¼Œå…ˆè¢«å†™å…¥åˆ°å†…å­˜ä¸­ï¼Œä½†æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®çš„ä¸¢å¤±ï¼Œä¼šè¿½åŠ ä¸€ä»½æ•°æ®åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚ä¸æ–­æœ‰æ–°çš„æ–‡æ¡£è¢«å†™å…¥åˆ°å†…å­˜ï¼ŒåŒæ—¶ä¹Ÿéƒ½ä¼šè®°å½•åˆ°äº‹åŠ¡æ—¥å¿—ä¸­ã€‚è¿™æ—¶æ–°æ•°æ®è¿˜ä¸èƒ½è¢«æ£€ç´¢å’ŒæŸ¥è¯¢ã€‚\nå½“è¾¾åˆ°é»˜è®¤çš„åˆ·æ–°æ—¶é—´æˆ–å†…å­˜ä¸­çš„æ•°æ®è¾¾åˆ°ä¸€å®šé‡åï¼Œä¼šè§¦å‘ä¸€æ¬¡ refreshï¼Œå°†å†…å­˜ä¸­çš„æ•°æ®ä»¥ä¸€ä¸ªæ–°æ®µå½¢å¼åˆ·æ–°åˆ°æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿä¸­å¹¶æ¸…ç©ºå†…å­˜ã€‚è¿™æ—¶è™½ç„¶æ–°æ®µæœªè¢«æäº¤åˆ°ç£ç›˜ï¼Œä½†æ˜¯å¯ä»¥æä¾›æ–‡æ¡£çš„æ£€ç´¢åŠŸèƒ½ä¸”ä¸èƒ½è¢«ä¿®æ”¹ã€‚\néšç€æ–°æ–‡æ¡£ç´¢å¼•ä¸æ–­è¢«å†™å…¥ï¼Œå½“æ—¥å¿—æ•°æ®å¤§å°è¶…è¿‡512Mæˆ–è€…æ—¶é—´è¶…è¿‡30åˆ†é’Ÿæ—¶ï¼Œä¼šè§¦å‘ä¸€æ¬¡ flushã€‚å†…å­˜ä¸­çš„æ•°æ®è¢«å†™å…¥åˆ°ä¸€ä¸ªæ–°æ®µåŒæ—¶è¢«å†™å…¥åˆ°æ–‡ä»¶ç¼“å­˜ç³»ç»Ÿï¼Œæ–‡ä»¶ç³»ç»Ÿç¼“å­˜ä¸­æ•°æ®é€šè¿‡ fsync åˆ·æ–°åˆ°ç£ç›˜ä¸­ï¼Œç”Ÿæˆæäº¤ç‚¹ï¼Œæ—¥å¿—æ–‡ä»¶è¢«åˆ é™¤ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„æ–°æ—¥å¿—ã€‚\n\né€šè¿‡è¿™ç§æ–¹å¼å½“æ–­ç”µæˆ–éœ€è¦é‡å¯æ—¶ï¼ŒESä¸ä»…è¦æ ¹æ®æäº¤ç‚¹å»åŠ è½½å·²ç»æŒä¹…åŒ–è¿‡çš„æ®µï¼Œè¿˜éœ€è¦å·¥å…·Translogé‡Œçš„è®°å½•ï¼ŒæŠŠæœªæŒä¹…åŒ–çš„æ•°æ®é‡æ–°æŒä¹…åŒ–åˆ°ç£ç›˜ä¸Šï¼Œé¿å…äº†æ•°æ®ä¸¢å¤±çš„å¯èƒ½ã€‚\næ®µåˆå¹¶ç”±äºè‡ªåŠ¨åˆ·æ–°æµç¨‹æ¯ç§’ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ®µ ï¼Œè¿™æ ·ä¼šå¯¼è‡´çŸ­æ—¶é—´å†…çš„æ®µæ•°é‡æš´å¢ã€‚è€Œæ®µæ•°ç›®å¤ªå¤šä¼šå¸¦æ¥è¾ƒå¤§çš„éº»çƒ¦ã€‚æ¯ä¸€ä¸ªæ®µéƒ½ä¼šæ¶ˆè€—æ–‡ä»¶å¥æŸ„ã€å†…å­˜å’Œcpuè¿è¡Œå‘¨æœŸã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæ¯ä¸ªæœç´¢è¯·æ±‚éƒ½å¿…é¡»è½®æµæ£€æŸ¥æ¯ä¸ªæ®µç„¶ååˆå¹¶æŸ¥è¯¢ç»“æœï¼Œæ‰€ä»¥æ®µè¶Šå¤šï¼Œæœç´¢ä¹Ÿå°±è¶Šæ…¢ã€‚\nElasticsearché€šè¿‡åœ¨åå°å®šæœŸè¿›è¡Œæ®µåˆå¹¶æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚å°çš„æ®µè¢«åˆå¹¶åˆ°å¤§çš„æ®µï¼Œç„¶åè¿™äº›å¤§çš„æ®µå†è¢«åˆå¹¶åˆ°æ›´å¤§çš„æ®µã€‚æ®µåˆå¹¶çš„æ—¶å€™ä¼šå°†é‚£äº›æ—§çš„å·²åˆ é™¤æ–‡æ¡£ä»æ–‡ä»¶ç³»ç»Ÿä¸­æ¸…é™¤ã€‚è¢«åˆ é™¤çš„æ–‡æ¡£ä¸ä¼šè¢«æ‹·è´åˆ°æ–°çš„å¤§æ®µä¸­ã€‚åˆå¹¶çš„è¿‡ç¨‹ä¸­ä¸ä¼šä¸­æ–­ç´¢å¼•å’Œæœç´¢ã€‚\n\næ®µåˆå¹¶åœ¨è¿›è¡Œç´¢å¼•å’Œæœç´¢æ—¶ä¼šè‡ªåŠ¨è¿›è¡Œï¼Œåˆå¹¶è¿›ç¨‹é€‰æ‹©ä¸€å°éƒ¨åˆ†å¤§å°ç›¸ä¼¼çš„æ®µï¼Œå¹¶ä¸”åœ¨åå°å°†å®ƒä»¬åˆå¹¶åˆ°æ›´å¤§çš„æ®µä¸­ï¼Œè¿™äº›æ®µæ—¢å¯ä»¥æ˜¯æœªæäº¤çš„ä¹Ÿå¯ä»¥æ˜¯å·²æäº¤çš„ã€‚åˆå¹¶ç»“æŸåè€çš„æ®µä¼šè¢«åˆ é™¤ï¼Œæ–°çš„æ®µè¢« flush åˆ°ç£ç›˜ï¼ŒåŒæ—¶å†™å…¥ä¸€ä¸ªåŒ…å«æ–°æ®µï¼ˆå·²æ’é™¤æ—§çš„è¢«åˆå¹¶çš„æ®µï¼‰çš„æ–°æäº¤ç‚¹ï¼Œæ–°çš„æ®µè¢«æ‰“å¼€å¯ä»¥ç”¨æ¥æœç´¢ã€‚\næ®µåˆå¹¶çš„è®¡ç®—é‡åºå¤§ï¼Œ è€Œä¸”è¿˜è¦åƒæ‰å¤§é‡ç£ç›˜ I/Oï¼Œæ®µåˆå¹¶ä¼šæ‹–ç´¯å†™å…¥é€Ÿç‡ï¼Œå¦‚æœä»»å…¶å‘å±•ä¼šå½±å“æœç´¢æ€§èƒ½ã€‚Elasticsearchåœ¨é»˜è®¤æƒ…å†µä¸‹ä¼šå¯¹åˆå¹¶æµç¨‹è¿›è¡Œèµ„æºé™åˆ¶ï¼Œæ‰€ä»¥æœç´¢ä»ç„¶æœ‰è¶³å¤Ÿçš„èµ„æºå¾ˆå¥½åœ°æ‰§è¡Œã€‚\nå…­ã€æ€§èƒ½ä¼˜åŒ–å­˜å‚¨è®¾å¤‡ç£ç›˜åœ¨ç°ä»£æœåŠ¡å™¨ä¸Šé€šå¸¸éƒ½æ˜¯ç“¶é¢ˆã€‚Elasticsearch é‡åº¦ä½¿ç”¨ç£ç›˜ï¼Œä½ çš„ç£ç›˜èƒ½å¤„ç†çš„ååé‡è¶Šå¤§ï¼Œä½ çš„èŠ‚ç‚¹å°±è¶Šç¨³å®šã€‚è¿™é‡Œæœ‰ä¸€äº›ä¼˜åŒ–ç£ç›˜ I/O çš„æŠ€å·§ï¼š\n\nä½¿ç”¨ SSDã€‚å°±åƒå…¶ä»–åœ°æ–¹æè¿‡çš„ï¼Œ ä»–ä»¬æ¯”æœºæ¢°ç£ç›˜ä¼˜ç§€å¤šäº†ã€‚\nä½¿ç”¨ RAID 0ã€‚æ¡å¸¦åŒ– RAID ä¼šæé«˜ç£ç›˜ I/Oï¼Œä»£ä»·æ˜¾ç„¶å°±æ˜¯å½“ä¸€å—ç¡¬ç›˜æ•…éšœæ—¶æ•´ä¸ªå°±æ•…éšœäº†ã€‚ä¸è¦ä½¿ç”¨é•œåƒæˆ–è€…å¥‡å¶æ ¡éªŒ RAID å› ä¸ºå‰¯æœ¬å·²ç»æä¾›äº†è¿™ä¸ªåŠŸèƒ½ã€‚\nå¦å¤–ï¼Œä½¿ç”¨å¤šå—ç¡¬ç›˜ï¼Œå¹¶å…è®¸ Elasticsearch é€šè¿‡å¤šä¸ª path.data ç›®å½•é…ç½®æŠŠæ•°æ®æ¡å¸¦åŒ–åˆ†é…åˆ°å®ƒä»¬ä¸Šé¢ã€‚\nä¸è¦ä½¿ç”¨è¿œç¨‹æŒ‚è½½çš„å­˜å‚¨ï¼Œæ¯”å¦‚ NFS æˆ–è€… SMB/CIFSã€‚è¿™ä¸ªå¼•å…¥çš„å»¶è¿Ÿå¯¹æ€§èƒ½æ¥è¯´å®Œå…¨æ˜¯èƒŒé“è€Œé©°çš„ã€‚\nå¦‚æœä½ ç”¨çš„æ˜¯ EC2ï¼Œå½“å¿ƒ EBSã€‚å³ä¾¿æ˜¯åŸºäº SSD çš„ EBSï¼Œé€šå¸¸ä¹Ÿæ¯”æœ¬åœ°å®ä¾‹çš„å­˜å‚¨è¦æ…¢ã€‚\n\nå†…éƒ¨ç´¢å¼•ä¼˜åŒ–\nElasticsearchä¸ºäº†èƒ½å¿«é€Ÿæ‰¾åˆ°æŸä¸ªtermï¼Œå…ˆå°†æ‰€æœ‰çš„termæ’ä¸ªåºï¼Œç„¶åæ ¹æ®äºŒåˆ†æ³•æŸ¥æ‰¾termï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºlogNï¼Œå°±åƒé€šè¿‡å­—å…¸æŸ¥æ‰¾ä¸€æ ·ï¼Œè¿™å°±æ˜¯Term Dictionary ã€‚ç°åœ¨å†çœ‹èµ·æ¥ï¼Œä¼¼ä¹å’Œä¼ ç»Ÿæ•°æ®åº“é€šè¿‡B-Treeçš„æ–¹å¼ç±»ä¼¼ã€‚\nä½†æ˜¯å¦‚æœtermå¤ªå¤šï¼Œterm dictionaryä¹Ÿä¼šå¾ˆå¤§ï¼Œæ”¾å†…å­˜ä¸ç°å®ï¼Œäºæ˜¯æœ‰äº†Term Index ï¼Œå°±åƒå­—å…¸é‡Œçš„ç´¢å¼•é¡µä¸€æ ·ï¼ŒAå¼€å¤´çš„æœ‰å“ªäº›termï¼Œåˆ†åˆ«åœ¨å“ªé¡µï¼Œå¯ä»¥ç†è§£term indexæ˜¯ä¸€é¢—æ ‘ã€‚è¿™æ£µæ ‘ä¸ä¼šåŒ…å«æ‰€æœ‰çš„termï¼Œå®ƒåŒ…å«çš„æ˜¯termçš„ä¸€äº›å‰ç¼€ã€‚é€šè¿‡term indexå¯ä»¥å¿«é€Ÿåœ°å®šä½åˆ°term dictionaryçš„æŸä¸ªoffsetï¼Œç„¶åä»è¿™ä¸ªä½ç½®å†å¾€åé¡ºåºæŸ¥æ‰¾ã€‚\nåœ¨å†…å­˜ä¸­ç”¨FSTæ–¹å¼å‹ç¼©term indexï¼ŒFSTä»¥å­—èŠ‚çš„æ–¹å¼å­˜å‚¨æ‰€æœ‰çš„termï¼Œè¿™ç§å‹ç¼©æ–¹å¼å¯ä»¥æœ‰æ•ˆçš„ç¼©å‡å­˜å‚¨ç©ºé—´ï¼Œä½¿å¾—term indexè¶³ä»¥æ”¾è¿›å†…å­˜ï¼Œä½†è¿™ç§æ–¹å¼ä¹Ÿä¼šå¯¼è‡´æŸ¥æ‰¾æ—¶éœ€è¦æ›´å¤šçš„CPUèµ„æºã€‚æ¼”ç¤ºåœ°å€ï¼šBuild your own FST\nå¯¹äºå­˜å‚¨åœ¨ç£ç›˜ä¸Šçš„å€’æ’è¡¨åŒæ ·ä¹Ÿé‡‡ç”¨äº†å‹ç¼©æŠ€æœ¯å‡å°‘å­˜å‚¨æ‰€å ç”¨çš„ç©ºé—´ï¼Œæ›´å¤šå¯ä»¥é˜…è¯» Frame of Reference and Roaring Bitmapsã€‚\nè°ƒæ•´é…ç½®å‚æ•°\nç»™æ¯ä¸ªæ–‡æ¡£æŒ‡å®šæœ‰åºçš„å…·æœ‰å‹ç¼©è‰¯å¥½çš„åºåˆ—æ¨¡å¼IDï¼Œé¿å…éšæœºçš„UUID-4 è¿™æ ·çš„ IDï¼Œè¿™æ ·çš„IDå‹ç¼©æ¯”å¾ˆä½ï¼Œä¼šæ˜æ˜¾æ‹–æ…¢ Luceneã€‚\nå¯¹äºé‚£äº›ä¸éœ€è¦èšåˆå’Œæ’åºçš„ç´¢å¼•å­—æ®µç¦ç”¨Doc valuesã€‚Doc Valuesæ˜¯æœ‰åºçš„åŸºäºdocument =&gt; field valueçš„æ˜ å°„åˆ—è¡¨ï¼›\nä¸éœ€è¦åšæ¨¡ç³Šæ£€ç´¢çš„å­—æ®µä½¿ç”¨ keywordç±»å‹ä»£æ›¿ text ç±»å‹ï¼Œè¿™æ ·å¯ä»¥é¿å…åœ¨å»ºç«‹ç´¢å¼•å‰å¯¹è¿™äº›æ–‡æœ¬è¿›è¡Œåˆ†è¯ã€‚\nå¦‚æœä½ çš„æœç´¢ç»“æœä¸éœ€è¦è¿‘å®æ—¶çš„å‡†ç¡®åº¦ï¼Œè€ƒè™‘æŠŠæ¯ä¸ªç´¢å¼•çš„ index.refresh_interval æ”¹åˆ° 30s ã€‚å¦‚æœä½ æ˜¯åœ¨åšå¤§æ‰¹é‡å¯¼å…¥ï¼Œå¯¼å…¥æœŸé—´ä½ å¯ä»¥é€šè¿‡è®¾ç½®è¿™ä¸ªå€¼ä¸º -1 å…³æ‰åˆ·æ–°ï¼Œè¿˜å¯ä»¥é€šè¿‡è®¾ç½® index.number_of_replicas: 0å…³é—­å‰¯æœ¬ã€‚åˆ«å¿˜è®°åœ¨å®Œå·¥çš„æ—¶å€™é‡æ–°å¼€å¯å®ƒã€‚\né¿å…æ·±åº¦åˆ†é¡µæŸ¥è¯¢å»ºè®®ä½¿ç”¨Scrollè¿›è¡Œåˆ†é¡µæŸ¥è¯¢ã€‚æ™®é€šåˆ†é¡µæŸ¥è¯¢æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªfrom + sizeçš„ç©ºä¼˜å…ˆé˜Ÿåˆ—ï¼Œæ¯ä¸ªåˆ†ç‰‡ä¼šè¿”å›from + size æ¡æ•°æ®ï¼Œé»˜è®¤åªåŒ…å«æ–‡æ¡£idå’Œå¾—åˆ†scoreç»™åè°ƒèŠ‚ç‚¹ï¼Œå¦‚æœæœ‰nä¸ªåˆ†ç‰‡ï¼Œåˆ™åè°ƒèŠ‚ç‚¹å†å¯¹ï¼ˆfrom + sizeï¼‰Ã— n æ¡æ•°æ®è¿›è¡ŒäºŒæ¬¡æ’åºï¼Œç„¶åé€‰æ‹©éœ€è¦è¢«å–å›çš„æ–‡æ¡£ã€‚å½“fromå¾ˆå¤§æ—¶ï¼Œæ’åºè¿‡ç¨‹ä¼šå˜å¾—å¾ˆæ²‰é‡å ç”¨CPUèµ„æºä¸¥é‡ã€‚\nå‡å°‘æ˜ å°„å­—æ®µï¼Œåªæä¾›éœ€è¦æ£€ç´¢ï¼Œèšåˆæˆ–æ’åºçš„å­—æ®µã€‚å…¶ä»–å­—æ®µå¯å­˜åœ¨å…¶ä»–å­˜å‚¨è®¾å¤‡ä¸Šï¼Œä¾‹å¦‚Hbaseï¼Œåœ¨ESä¸­å¾—åˆ°ç»“æœåå†å»HbaseæŸ¥è¯¢è¿™äº›å­—æ®µã€‚\nåˆ›å»ºç´¢å¼•å’ŒæŸ¥è¯¢æ—¶æŒ‡å®šè·¯ç”±routingå€¼ï¼Œè¿™æ ·å¯ä»¥ç²¾ç¡®åˆ°å…·ä½“çš„åˆ†ç‰‡æŸ¥è¯¢ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚è·¯ç”±çš„é€‰æ‹©éœ€è¦æ³¨æ„æ•°æ®çš„åˆ†å¸ƒå‡è¡¡ã€‚\n\nJVMè°ƒä¼˜\nç¡®ä¿å †å†…å­˜æœ€å°å€¼ï¼ˆ Xms ï¼‰ä¸æœ€å¤§å€¼ï¼ˆ Xmx ï¼‰çš„å¤§å°æ˜¯ç›¸åŒçš„ï¼Œé˜²æ­¢ç¨‹åºåœ¨è¿è¡Œæ—¶æ”¹å˜å †å†…å­˜å¤§å°ã€‚Elasticsearch é»˜è®¤å®‰è£…åè®¾ç½®çš„å †å†…å­˜æ˜¯ 1 GBã€‚å¯é€šè¿‡../config/jvm.optionæ–‡ä»¶è¿›è¡Œé…ç½®ï¼Œä½†æ˜¯æœ€å¥½ä¸è¦è¶…è¿‡ç‰©ç†å†…å­˜çš„50%å’Œè¶…è¿‡32GBã€‚\nGC é»˜è®¤é‡‡ç”¨CMSçš„æ–¹å¼ï¼Œå¹¶å‘ä½†æ˜¯æœ‰STWçš„é—®é¢˜ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨G1æ”¶é›†å™¨ã€‚\nESéå¸¸ä¾èµ–æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼ˆFilesystem Cacheï¼‰ï¼Œå¿«é€Ÿæœç´¢ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œåº”è¯¥è‡³å°‘ç¡®ä¿ç‰©ç†ä¸Šæœ‰ä¸€åŠçš„å¯ç”¨å†…å­˜åˆ†é…åˆ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ã€‚\n\n","categories":["è¿ç»´"],"tags":["Elasticsearch"]}]