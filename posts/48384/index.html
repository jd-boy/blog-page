<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="JD">
    
    <title>
        
            Pod 与 Service 的 DNS |
        
        Bean You
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="http://qiniu.jzcupid.cn/blog%E5%9B%BE%E6%A0%87.ico">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"jzcupid.cn","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"http://qiniu.jzcupid.cn/blog%E5%9B%BE%E6%A0%87.ico","favicon":"http://qiniu.jzcupid.cn/blog%E5%9B%BE%E6%A0%87.ico","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"莫听穿林打叶声，何妨吟啸且徐行"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"trigger":"auto","preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Bean You
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Pod 与 Service 的 DNS</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="http://qiniu.jzcupid.cn/blog%E5%9B%BE%E6%A0%87.ico">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">JD</span>
                        
                            <span class="author-label">Lv5</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2022-08-07 13:45:49
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Kubernetes/">Kubernetes</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>Kubernetes 为 Service 和 Pod 创建 DNS 记录。 你可以使用一致的 DNS 名称而非 IP 地址访问 Service。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/" >原文连接<i class="fas fa-external-link-alt"></i></a></p>
<h2 id="一、介绍"><a href="#一、介绍" class="headerlink" title="一、介绍"></a>一、介绍</h2><p>Kubernetes DNS 除了在集群上调度 DNS Pod 和 Service， 还配置 kubelet 以告知各个容器使用 DNS Service 的 IP 来解析 DNS 名称。</p>
<p>集群中定义的每个 Service （包括 DNS 服务器自身）都被赋予一个 DNS 名称。 默认情况下，客户端 Pod 的 DNS 搜索列表会包含 Pod 自身的名字空间和集群的默认域。</p>
<h3 id="Service-的名字空间"><a href="#Service-的名字空间" class="headerlink" title="Service 的名字空间"></a>Service 的名字空间</h3><p>DNS 查询可能因为执行查询的 Pod 所在的名字空间而返回不同的结果。 不指定名字空间的 DNS 查询会被限制在 Pod 所在的名字空间内。 要访问其他名字空间中的 Service，需要在 DNS 查询中指定名字空间。</p>
<p>例如，假定名字空间 <code>test</code> 中存在一个 Pod，<code>prod</code> 名字空间中存在一个服务 <code>data</code>。</p>
<p>Pod 查询 <code>data</code> 时没有返回结果，因为使用的是 Pod 的名字空间 <code>test</code>。</p>
<p>Pod 查询 <code>data.prod</code> 时则会返回预期的结果，因为查询中指定了名字空间。</p>
<p>DNS 查询可以使用 Pod 中的 <code>/etc/resolv.conf</code> 展开。kubelet 会为每个 Pod 生成此文件。例如，对 <code>data</code> 的查询可能被展开为 <code>data.test.svc.cluster.local</code>。 <code>search</code> 选项的取值会被用来展开查询。要进一步了解 DNS 查询，可参阅 <a target="_blank" rel="noopener" href="https://www.man7.org/linux/man-pages/man5/resolv.conf.5.html"><code>resolv.conf</code> 手册页面</a>。</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 10.32.0.10</span><br><span class="line">search &lt;namespace&gt;.svc.cluster.local svc.cluster.local cluster.local</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<p>概括起来，名字空间 <code>test</code> 中的 Pod 可以成功地解析 <code>data.prod</code> 或者 <code>data.prod.svc.cluster.local</code>。</p>
<h3 id="DNS-记录"><a href="#DNS-记录" class="headerlink" title="DNS 记录"></a>DNS 记录</h3><p>哪些对象会获得 DNS 记录呢？</p>
<ol>
<li>Services</li>
<li>Pods</li>
</ol>
<p>以下各节详细介绍已支持的 DNS 记录类型和布局。 其它布局、名称或者查询即使碰巧可以工作，也应视为实现细节， 将来很可能被更改而且不会因此发出警告。 有关最新规范请查看 <a class="link"   target="_blank" rel="noopener" href="https://github.com/kubernetes/dns/blob/master/docs/specification.md" >Kubernetes 基于 DNS 的服务发现<i class="fas fa-external-link-alt"></i></a>。</p>
<h3 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h3><h4 id="A-AAAA-记录"><a href="#A-AAAA-记录" class="headerlink" title="A/AAAA 记录"></a>A/AAAA 记录</h4><p>“普通” Service（除了无头 Service）会以 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 这种名字的形式被分配一个 DNS A 或 AAAA 记录，取决于 Service 的 IP 协议族。 该名称会解析成对应 Service 的集群 IP。</p>
<p>“无头（Headless）” Service （没有集群 IP）也会以 <code>my-svc.my-namespace.svc.cluster-domain.example</code> 这种名字的形式被指派一个 DNS A 或 AAAA 记录， 具体取决于 Service 的 IP 协议族。 与普通 Service 不同，这一记录会被解析成对应 Service 所选择的 Pod IP 的集合。 客户端要能够使用这组 IP，或者使用标准的轮转策略从这组 IP 中进行选择。</p>
<h4 id="SRV-记录"><a href="#SRV-记录" class="headerlink" title="SRV 记录"></a>SRV 记录</h4><p>Kubernetes 根据普通 Service 或 <a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/#headless-services" >Headless Service<i class="fas fa-external-link-alt"></i></a> 中的命名端口创建 SRV 记录。每个命名端口， SRV 记录格式为 <code>_my-port-name._my-port-protocol.my-svc.my-namespace.svc.cluster-domain.example</code>。 普通 Service，该记录会被解析成端口号和域名：<code>my-svc.my-namespace.svc.cluster-domain.example</code>。 无头 Service，该记录会被解析成多个结果，及该服务的每个后端 Pod 各一个 SRV 记录， 其中包含 Pod 端口号和格式为 <code>auto-generated-name.my-svc.my-namespace.svc.cluster-domain.example</code> 的域名。</p>
<h2 id="二、Pods"><a href="#二、Pods" class="headerlink" title="二、Pods"></a>二、Pods</h2><h3 id="A-AAAA-记录-1"><a href="#A-AAAA-记录-1" class="headerlink" title="A/AAAA 记录"></a>A/AAAA 记录</h3><p>一般而言，Pod 会对应如下 DNS 名字解析：</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pod-ip-address.my-namespace.pod.cluster-domain.example</span><br></pre></td></tr></table></figure>

<p>例如，对于一个位于 <code>default</code> 名字空间，IP 地址为 172.17.0.3 的 Pod， 如果集群的域名为 <code>cluster.local</code>，则 Pod 会对应 DNS 名称：</p>
<p><code>172-17-0-3.default.pod.cluster.local</code>.</p>
<p>通过 Service 暴露出来的所有 Pod 都会有如下 DNS 解析名称可用：</p>
<p><code>pod-ip-address.service-name.my-namespace.svc.cluster-domain.example</code>.</p>
<h3 id="Pod-的-hostname-和-subdomain-字段"><a href="#Pod-的-hostname-和-subdomain-字段" class="headerlink" title="Pod 的 hostname 和 subdomain 字段"></a>Pod 的 hostname 和 subdomain 字段</h3><p>当前，创建 Pod 时其主机名取自 Pod 的 <code>metadata.name</code> 值。</p>
<p>Pod 规约中包含一个可选的 <code>hostname</code> 字段，可以用来指定 Pod 的主机名。 当这个字段被设置时，它将优先于 Pod 的名字成为该 Pod 的主机名。 举个例子，给定一个 <code>hostname</code> 设置为 “<code>my-host</code>“ 的 Pod， 该 Pod 的主机名将被设置为 “<code>my-host</code>“。</p>
<p>Pod 规约还有一个可选的 <code>subdomain</code> 字段，可以用来指定 Pod 的子域名。 举个例子，某 Pod 的 <code>hostname</code> 设置为 “<code>foo</code>”，<code>subdomain</code> 设置为 “<code>bar</code>”， 在名字空间 “<code>my-namespace</code>” 中对应的完全限定域名（FQDN）为 “<code>foo.bar.my-namespace.svc.cluster-domain.example</code>”。</p>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default-subdomain</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span> <span class="comment"># 实际上不需要指定端口号</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">1234</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">1234</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-1</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostname:</span> <span class="string">busybox-2</span></span><br><span class="line">  <span class="attr">subdomain:</span> <span class="string">default-subdomain</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure>

<p>如果某无头 Service 与某 Pod 在同一个名字空间中，且它们具有相同的子域名， 集群的 DNS 服务器也会为该 Pod 的全限定主机名返回 A 记录或 AAAA 记录。 例如，在同一个名字空间中，给定一个主机名为 “busybox-1”、 子域名设置为 “default-subdomain” 的 Pod，和一个名称为 “<code>default-subdomain</code>” 的无头 Service，Pod 将看到自己的 FQDN 为 “<code>busybox-1.default-subdomain.my-namespace.svc.cluster-domain.example</code>“。 DNS 会为此名字提供一个 A 记录或 AAAA 记录，指向该 Pod 的 IP。 “<code>busybox1</code>” 和 “<code>busybox2</code>” 这两个 Pod 分别具有它们自己的 A 或 AAAA 记录。</p>
<p>Endpoints 对象可以为任何端点地址及其 IP 指定 <code>hostname</code>。</p>
<p><strong>说明：</strong> 由于不是为 Pod 名称创建 A 或 AAAA 记录的，因此 Pod 的 A 或 AAAA 需要 <code>hostname</code>。 没有设置 <code>hostname</code> 但设置了 <code>subdomain</code> 的 Pod 只会为 无头 Service 创建 A 或 AAAA 记录（<code>default-subdomain.my-namespace.svc.cluster-domain.example</code>） 指向 Pod 的 IP 地址。 另外，除非在服务上设置了 <code>publishNotReadyAddresses=True</code>，否则只有 Pod 进入就绪状态 才会有与之对应的记录。</p>
<h3 id="Pod-的-setHostnameAsFQDN-字段"><a href="#Pod-的-setHostnameAsFQDN-字段" class="headerlink" title="Pod 的 setHostnameAsFQDN 字段"></a>Pod 的 setHostnameAsFQDN 字段</h3><p><strong>特性状态：</strong> <code>Kubernetes v1.22 [stable]</code></p>
<p>当 Pod 配置为具有全限定域名 (FQDN) 时，其主机名是短主机名。 例如，如果你有一个具有完全限定域名 <code>busybox-1.default-subdomain.my-namespace.svc.cluster-domain.example</code> 的 Pod， 则默认情况下，该 Pod 内的 <code>hostname</code> 命令返回 <code>busybox-1</code>，而 <code>hostname --fqdn</code> 命令返回 FQDN。</p>
<p>当你在 Pod 规约中设置了 <code>setHostnameAsFQDN: true</code> 时，kubelet 会将 Pod 的全限定域名（FQDN）作为该 Pod 的主机名记录到 Pod 所在名字空间。 在这种情况下，<code>hostname</code> 和 <code>hostname --fqdn</code> 都会返回 Pod 的全限定域名。</p>
<p><strong>说明：</strong></p>
<p>在 Linux 中，内核的主机名字段（<code>struct utsname</code> 的 <code>nodename</code> 字段）限定 最多 64 个字符。</p>
<p>如果 Pod 启用这一特性，而其 FQDN 超出 64 字符，Pod 的启动会失败。 Pod 会一直出于 <code>Pending</code> 状态（通过 <code>kubectl</code> 所看到的 <code>ContainerCreating</code>）， 并产生错误事件，例如 “Failed to construct FQDN from Pod hostname and cluster domain, FQDN <code>long-FQDN</code> is too long (64 characters is the max, 70 characters requested).” （无法基于 Pod 主机名和集群域名构造 FQDN，FQDN <code>long-FQDN</code> 过长，至多 64 字符，请求字符数为 70）。 对于这种场景而言，改善用户体验的一种方式是创建一个 <a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/extensible-admission-controllers/#admission-webhooks" >准入 Webhook 控制器<i class="fas fa-external-link-alt"></i></a>， 在用户创建顶层对象（如 Deployment）的时候控制 FQDN 的长度。</p>
<h3 id="Pod-的-DNS-策略"><a href="#Pod-的-DNS-策略" class="headerlink" title="Pod 的 DNS 策略"></a>Pod 的 DNS 策略</h3><p>DNS 策略可以逐个 Pod 来设定。目前 Kubernetes 支持以下特定 Pod 的 DNS 策略。 这些策略可以在 Pod 规约中的 <code>dnsPolicy</code> 字段设置：</p>
<ul>
<li><strong>Default</strong>： Pod 从运行所在的节点继承名称解析配置。参考 <a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-custom-nameservers" >相关讨论<i class="fas fa-external-link-alt"></i></a> 获取更多信息。</li>
<li><strong>ClusterFirst</strong>：与配置的集群域后缀不匹配的任何 DNS 查询（例如 “<a class="link"   target="_blank" rel="noopener" href="http://www.kubernetes.io&quot;)/" >www.kubernetes.io&quot;）<i class="fas fa-external-link-alt"></i></a> 都将转发到从节点继承的上游名称服务器。集群管理员可能配置了额外的存根域和上游 DNS 服务器。 参阅<a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/dns-custom-nameservers" >相关讨论<i class="fas fa-external-link-alt"></i></a> 了解在这些场景中如何处理 DNS 查询的信息。</li>
<li><strong>ClusterFirstWithHostNet</strong>：对于以 hostNetwork 方式运行的 Pod，应显式设置其 DNS 策略 <code>ClusterFirstWithHostNet</code>。<ul>
<li>注意：这在 Windows 上不支持。 有关详细信息，请参见<a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/#dns-windows" >下文<i class="fas fa-external-link-alt"></i></a>。</li>
</ul>
</li>
<li><strong>None</strong>：此设置允许 Pod 忽略 Kubernetes 环境中的 DNS 设置。Pod 会使用其 <code>dnsConfig</code> 字段 所提供的 DNS 设置。 参见 <a class="link"   target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/concepts/services-networking/dns-pod-service/#pod-dns-config" >Pod 的 DNS 配置<i class="fas fa-external-link-alt"></i></a>节。</li>
</ul>
<p><strong>说明：</strong> <code>Default</code> 不是默认的 DNS 策略。如果未明确指定 <code>dnsPolicy</code>，则使用 <code>ClusterFirst</code>。</p>
<p>下面的示例显示了一个 Pod，其 DNS 策略设置为 <code>ClusterFirstWithHostNet</code>， 因为它已将 <code>hostNetwork</code> 设置为 <code>true</code>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox:1.28</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3600&quot;</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Always</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">ClusterFirstWithHostNet</span></span><br></pre></td></tr></table></figure>

<h3 id="Pod-的-DNS-配置"><a href="#Pod-的-DNS-配置" class="headerlink" title="Pod 的 DNS 配置"></a>Pod 的 DNS 配置</h3><p><strong>特性状态：</strong> <code>Kubernetes v1.14 [stable]</code></p>
<p>Pod 的 DNS 配置可让用户对 Pod 的 DNS 设置进行更多控制。</p>
<p><code>dnsConfig</code> 字段是可选的，它可以与任何 <code>dnsPolicy</code> 设置一起使用。 但是，当 Pod 的 <code>dnsPolicy</code> 设置为 “<code>None</code>“ 时，必须指定 <code>dnsConfig</code> 字段。</p>
<p>用户可以在 <code>dnsConfig</code> 字段中指定以下属性：</p>
<ul>
<li><code>nameservers</code>：将用作于 Pod 的 DNS 服务器的 IP 地址列表。 最多可以指定 3 个 IP 地址。当 Pod 的 <code>dnsPolicy</code> 设置为 “<code>None</code>“ 时， 列表必须至少包含一个 IP 地址，否则此属性是可选的。 所列出的服务器将合并到从指定的 DNS 策略生成的基本名称服务器，并删除重复的地址。</li>
<li><code>searches</code>：用于在 Pod 中查找主机名的 DNS 搜索域的列表。此属性是可选的。 指定此属性时，所提供的列表将合并到根据所选 DNS 策略生成的基本搜索域名中。 重复的域名将被删除。Kubernetes 最多允许 6 个搜索域。</li>
<li><code>options</code>：可选的对象列表，其中每个对象可能具有 <code>name</code> 属性（必需）和 <code>value</code> 属性（可选）。 此属性中的内容将合并到从指定的 DNS 策略生成的选项。 重复的条目将被删除。</li>
</ul>
<p>以下是具有自定义 DNS 设置的 Pod 示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dns-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">dnsConfig:</span></span><br><span class="line">    <span class="attr">nameservers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">1.2</span><span class="number">.3</span><span class="number">.4</span></span><br><span class="line">    <span class="attr">searches:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ns1.svc.cluster-domain.example</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my.dns.search.suffix</span></span><br><span class="line">    <span class="attr">options:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ndots</span></span><br><span class="line">        <span class="attr">value:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">edns0</span></span><br></pre></td></tr></table></figure>

<p>创建上面的 Pod 后，容器 <code>test</code> 会在其 <code>/etc/resolv.conf</code> 文件中获取以下内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 1.2.3.4</span><br><span class="line">search ns1.svc.cluster-domain.example my.dns.search.suffix</span><br><span class="line">options ndots:2 edns0</span><br></pre></td></tr></table></figure>

<p>对于 IPv6 设置，搜索路径和名称服务器应按以下方式设置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it dns-example -- cat /etc/resolv.conf</span><br></pre></td></tr></table></figure>

<p>输出类似于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver fd00:79:30::a</span><br><span class="line">search default.svc.cluster-domain.example svc.cluster-domain.example cluster-domain.example</span><br><span class="line">options ndots:5</span><br></pre></td></tr></table></figure>

<h4 id="扩展-DNS-配置"><a href="#扩展-DNS-配置" class="headerlink" title="扩展 DNS 配置"></a>扩展 DNS 配置</h4><p><strong>特性状态：</strong> <code>Kubernetes 1.22 [alpha]</code></p>
<p>对于 Pod DNS 配置，Kubernetes 默认允许最多 6 个 搜索域（ Search Domain） 以及一个最多 256 个字符的搜索域列表。</p>
<p>如果启用 kube-apiserver 和 kubelet 的特性门控 <code>ExpandedDNSConfig</code>，Kubernetes 将可以有最多 32 个 搜索域以及一个最多 2048 个字符的搜索域列表。</p>
<h2 id="三、Windows-节点上的-DNS-解析"><a href="#三、Windows-节点上的-DNS-解析" class="headerlink" title="三、Windows 节点上的 DNS 解析"></a>三、Windows 节点上的 DNS 解析</h2><ul>
<li>在 Windows 节点上运行的 Pod 不支持 ClusterFirstWithHostNet。 Windows 将所有带有 <code>.</code> 的名称视为全限定域名（FQDN）并跳过全限定域名（FQDN）解析。</li>
<li>在 Windows 上，可以使用的 DNS 解析器有很多。 由于这些解析器彼此之间会有轻微的行为差别，建议使用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/powershell/module/dnsclient/resolve-dnsname"><code>Resolve-DNSName</code></a> powershell cmdlet 进行名称查询解析。</li>
<li>在 Linux 上，有一个 DNS 后缀列表，当解析全名失败时可以使用。 在 Windows 上，你只能有一个 DNS 后缀， 即与该 Pod 的命名空间相关联的 DNS 后缀（例如：<code>mydns.svc.cluster.local</code>）。 Windows 可以解析全限定域名（FQDN），和使用了该 DNS 后缀的 Services 或者网络名称。 例如，在 <code>default</code> 命名空间中生成一个 Pod，该 Pod 会获得的 DNS 后缀为 <code>default.svc.cluster.local</code>。 在 Windows 的 Pod 中，你可以解析 <code>kubernetes.default.svc.cluster.local</code> 和 <code>kubernetes</code>， 但是不能解析部分限定名称（<code>kubernetes.default</code> 和 <code>kubernetes.default.svc</code>）。</li>
</ul>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/posts/30022/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">k8s 版本回退</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/posts/15671/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">maxmind-db 根据 IP 获取地理位置信息</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">JD</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%BB%8B%E7%BB%8D"><span class="nav-text">一、介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Service-%E7%9A%84%E5%90%8D%E5%AD%97%E7%A9%BA%E9%97%B4"><span class="nav-text">Service 的名字空间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DNS-%E8%AE%B0%E5%BD%95"><span class="nav-text">DNS 记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Services"><span class="nav-text">Services</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#A-AAAA-%E8%AE%B0%E5%BD%95"><span class="nav-text">A&#x2F;AAAA 记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SRV-%E8%AE%B0%E5%BD%95"><span class="nav-text">SRV 记录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Pods"><span class="nav-text">二、Pods</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#A-AAAA-%E8%AE%B0%E5%BD%95-1"><span class="nav-text">A&#x2F;AAAA 记录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E7%9A%84-hostname-%E5%92%8C-subdomain-%E5%AD%97%E6%AE%B5"><span class="nav-text">Pod 的 hostname 和 subdomain 字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E7%9A%84-setHostnameAsFQDN-%E5%AD%97%E6%AE%B5"><span class="nav-text">Pod 的 setHostnameAsFQDN 字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E7%9A%84-DNS-%E7%AD%96%E7%95%A5"><span class="nav-text">Pod 的 DNS 策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Pod-%E7%9A%84-DNS-%E9%85%8D%E7%BD%AE"><span class="nav-text">Pod 的 DNS 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%89%A9%E5%B1%95-DNS-%E9%85%8D%E7%BD%AE"><span class="nav-text">扩展 DNS 配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Windows-%E8%8A%82%E7%82%B9%E4%B8%8A%E7%9A%84-DNS-%E8%A7%A3%E6%9E%90"><span class="nav-text">三、Windows 节点上的 DNS 解析</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
