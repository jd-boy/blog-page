<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="JD">
    
    <title>
        
            总结 httpclient 资源释放和连接复用 |
        
        Bean You
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/favicon.png">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"jzcupid.cn","root":"/","language":"en","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/favicon.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"莫听穿林打叶声，何妨吟啸且徐行。"},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":true}}},"local_search":{"enable":true,"trigger":"auto","preload":true},"code_copy":{"enable":true,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Bean You
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">总结 httpclient 资源释放和连接复用</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">JD</span>
                        
                            <span class="author-label">Lv6</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2023-04-09 15:11:50
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E7%BB%8F%E9%AA%8C%E6%96%87%E6%A1%A3/">经验文档</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <p>最近修改同事代码时遇到一个问题，通过 httpclient 默认配置产生的 httpclient 如果不关闭，会导致连接无法释放，很快打满服务器连接（内嵌 Jetty 配置了 25 连接上限），主动关闭问题解决；后来优化为通过连接池生成 httpclient 后，如果关闭 httpclient 又会导致连接池关闭，后面新的 httpclient 也无法再请求，这里总结遇到的一些问题和疑问。</p>
<ol>
<li>官网示例中的以下三个 close 分别释放了什么资源，是否可以省略，以及在什么时机调用，使用连接池时有区别么？</li>
<li>作为 RPC 通信客户端，如何复用 TCP 连接？</li>
</ol>
<h4 id="一、资源释放"><a href="#一、资源释放" class="headerlink" title="一、资源释放"></a>一、资源释放</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CloseableHttpClient httpclient = HttpClients.createDefault();</span><br><span class="line">HttpGet httpget = <span class="keyword">new</span> HttpGet(<span class="string">&quot;http://localhost/&quot;</span>);</span><br><span class="line">CloseableHttpResponse response = httpclient.execute(httpget);</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    HttpEntity entity = response.getEntity();</span><br><span class="line">    <span class="keyword">if</span> (entity != <span class="keyword">null</span>) &#123;</span><br><span class="line">        InputStream instream = entity.getContent();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// do something useful</span></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            instream.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    response.close();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// httpclient.close();</span></span><br></pre></td></tr></table></figure>

<p>首先需要了解默认配置 <code>createDefault</code> 和使用了 custom 连接池（文章最后的 HttpClientUtil）两种情况的区别，通过源码可以看到前者也创建了连接池，最大连接20个，单个 host最大2个，但是区别在于每次创建的 httpclient 都自己维护了自己的连接池，而 custom 连接池时所有 httpclient 共用同一个连接池，这是在 api 使用方面需要注意的地方，要避免每次请求新建连接池、关闭连接池，造成性能问题。</p>
<blockquote>
<p>The difference between closing the content stream and closing the response is that the former will attempt to keep the underlying connection alive by consuming the entity content while the latter immediately shuts down and discards the connection.</p>
</blockquote>
<p>第一个 close 是读取 http 正文的数据流，类似的还有响应写入流，都需要主动关闭，如果是使用 <code>EntityUtils.toString(response.getEntity(), &quot;UTF-8&quot;);</code> 的方式，其内部会进行关闭。如果还有要读/写的数据、或不主动关闭，相当于 http 请求事务未处理完成，这时通过其他方式关闭（第二个 close）相当于异常终止，会导致该连接无法被复用，对比下面两段日志。</p>
<p>第一个 close 未调用时，第二个 close 调用，连接无法被复用，kept alive 0。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">o.a.http.impl.execchain.MainClientExec   : Connection can be kept alive indefinitely</span><br><span class="line">h.i.c.DefaultManagedHttpClientConnection : http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line">o.a.http.impl.execchain.MainClientExec   : Connection discarded</span><br><span class="line">h.i.c.PoolingHttpClientConnectionManager : Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 0; route allocated: 0 of 2; total allocated: 0 of 20]</span></span><br></pre></td></tr></table></figure>

<p>第一个 close 正常调用时，第二个 close 调用，连接可以被复用，kept alive 1。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">o.a.http.impl.execchain.MainClientExec   : Connection can be kept alive indefinitely</span><br><span class="line">h.i.c.PoolingHttpClientConnectionManager : Connection [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080] can be kept alive indefinitely</span></span><br><span class="line">h.i.c.DefaultManagedHttpClientConnection : http-outgoing-<span class="number">0</span>: set socket timeout to <span class="number">0</span></span><br><span class="line">h.i.c.PoolingHttpClientConnectionManager : Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 1; route allocated: 1 of 2; total allocated: 1 of 20]</span></span><br></pre></td></tr></table></figure>

<p>第二个 close 是强行制止和释放连接到连接池，相当于对第一个 close 的保底操作（上面关闭了这个似乎没必要了？），结合上面引用的官方文档写到 immediately shuts down and discards the connection，这里如果判断需要 keep alive 实际也不会关闭 TCP 连接，因为通过 netstat 可以看到，第二段日志后在终端可以继续观察到连接：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.51003        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.51003        127.0.0.1.8080         ESTABLISHED</span><br></pre></td></tr></table></figure>

<p>在 SOF 上可以搜到这段话，但是感觉和上面观察到的并不相符？</p>
<blockquote>
<p>The underlying HTTP connection is still held by the response object to allow the response content to be streamed directly from the network socket. In order to ensure correct deallocation of system resources, the user MUST call CloseableHttpResponse#close() from a finally clause. Please note that if response content is not fully consumed the underlying connection cannot be safely re-used and will be shut down and discarded by the connection manager.</p>
</blockquote>
<p>第三个 clsoe，也就是 httpclient.close 会彻底关闭连接池，以及其中所有连接，一般情况下，只有在关闭应用时调用以释放资源（补充：当 <code>httpClientBuilder.setConnectionManagerShared(true)</code> 时，并不会关闭连接池）。</p>
<h4 id="二、连接复用"><a href="#二、连接复用" class="headerlink" title="二、连接复用"></a>二、连接复用</h4><p>根据 http 协议 1.1 版本，各个 web 服务器都默认支持 keepalive，因此当 http 请求正常完成后，服务器不会主动关闭 tcp（直到空闲超时或数量达到上限），使连接会保留一段时间，前面我们也知道 httpclient 在判断可以 keepalive 后，即使调用了 close 也不会关闭 tcp 连接（可以认为 release 到连接池）。为了管理这些保留的连接，以及方便 api 调用，一般设置一个全局的连接池，并基于该连接池提供 httpclient 实例，这样就不需要考虑维护 httpclient 实例生命周期，随用随取（方便状态管理？），此外考虑到 http 的单路性，一个请求响应完成结束后，该连接才可以再次复用，因此连接池的最大连接数决定了并发处理量，该配置也是一种保护机制，超出上限的请求会被阻塞，也可以配合熔断组件使用，当服务方慢、或不健康时熔断降级。</p>
<p>最后还有一个问题，观察到 keepalive 的 tcp 连接过一段时间后会变成如下状态：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.51866        FIN_WAIT_2</span><br><span class="line">tcp4       0      0  127.0.0.1.51866        127.0.0.1.8080         CLOSE_WAIT</span><br></pre></td></tr></table></figure>

<p>可以看出服务器经过一段时间，认为该连接空闲，因此主动关闭，收到对方响应后进入 FIN_WAIT_2 状态（等待对方也发起关闭），而客户端进入 CLOSE_WAIT 状态后却不再发起自己这一方的关闭请求，这时双方处于半关闭。官方文档解释如下：</p>
<blockquote>
<p>One of the major shortcomings of the classic blocking I/O model is that the network socket can react to I/O events only when blocked in an I/O operation. When a connection is released back to the manager, it can be kept alive however it is unable to monitor the status of the socket and react to any I/O events. If the connection gets closed on the server side, the client side connection is unable to detect the change in the connection state (and react appropriately by closing the socket on its end).</p>
</blockquote>
<p>这需要有定期主动做一些检测和关闭动作，从这个角度考虑，默认配置产生的 HttpClient 没有这一功能，不应该用于生产环境，下面这个监控线程可以完成该工作，包含它的完整的 HttpUtil 从文章最后连接获取。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IdleConnectionMonitorThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> HttpClientConnectionManager connMgr;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> shutdown;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">IdleConnectionMonitorThread</span><span class="params">(HttpClientConnectionManager connMgr)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>();</span><br><span class="line">    <span class="keyword">this</span>.connMgr = connMgr;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">while</span> (!shutdown) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">          wait(<span class="number">30</span> * <span class="number">1000</span>);</span><br><span class="line">          <span class="comment">// Close expired connections</span></span><br><span class="line">          connMgr.closeExpiredConnections();</span><br><span class="line">          <span class="comment">// Optionally, close connections</span></span><br><span class="line">          <span class="comment">// that have been idle longer than 30 sec</span></span><br><span class="line">          connMgr.closeIdleConnections(<span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</span><br><span class="line">      <span class="comment">// terminate</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>最后展示一个完整的示例，首先多线程发起两个请求，看到创建两个连接，30秒之后再发起一个请求，可以复用之前其中一个连接，另一个连接因空闲被关闭，随后最后等待 2 分钟后再发起一个请求，由于之前连接已过期失效，重新创建连接。</p>
<ol>
<li><p>并发两个请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.504</span>  [       Thread-<span class="number">4</span>] : Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 0; route allocated: 0 of 150; total allocated: 0 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.504</span>  [       Thread-<span class="number">5</span>] : Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 0; route allocated: 0 of 150; total allocated: 0 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.515</span>  [       Thread-<span class="number">5</span>] : Connection leased: [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 0; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.515</span>  [       Thread-<span class="number">4</span>] : Connection leased: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 0; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.517</span>  [       Thread-<span class="number">5</span>] : Opening connection &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.517</span>  [       Thread-<span class="number">4</span>] : Opening connection &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.519</span>  [       Thread-<span class="number">4</span>] : Connecting to /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.519</span>  [       Thread-<span class="number">5</span>] : Connecting to /<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.521</span>  [       Thread-<span class="number">5</span>] : Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52421</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">44.521</span>  [       Thread-<span class="number">4</span>] : Connection established <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">52420</span>&lt;-&gt;<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">8080</span></span><br><span class="line">....</span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.486</span>  [           main] : [leased: <span class="number">2</span>; pending: <span class="number">0</span>; available: <span class="number">0</span>; max: <span class="number">150</span>]</span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.630</span>  [       Thread-<span class="number">4</span>] : Connection can be kept alive indefinitely</span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.630</span>  [       Thread-<span class="number">5</span>] : Connection can be kept alive indefinitely</span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">4</span>] : Connection [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080] can be kept alive indefinitely</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">5</span>] : Connection [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080] can be kept alive indefinitely</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">4</span>] : http-outgoing-<span class="number">0</span>: set socket timeout to <span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">5</span>] : http-outgoing-<span class="number">1</span>: set socket timeout to <span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">4</span>] : Connection released: [id: <span class="number">0</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 1; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">49.633</span>  [       Thread-<span class="number">5</span>] : Connection released: [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 2; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">54</span>:<span class="number">54.488</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">2</span>; max: <span class="number">150</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52421        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52420        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52421        127.0.0.1.8080         ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52420        127.0.0.1.8080         ESTABLISHED</span><br></pre></td></tr></table></figure></li>
<li><p>下一个请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">14.489</span>  [       Thread-<span class="number">6</span>] : Connection request: [route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 2; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">14.491</span>  [       Thread-<span class="number">6</span>] : http-outgoing-<span class="number">1</span> &lt;&lt; <span class="string">&quot;[read] I/O error: Read timed out&quot;</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">14.491</span>  [       Thread-<span class="number">6</span>] : Connection leased: [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 1; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">14.491</span>  [       Thread-<span class="number">6</span>] : http-outgoing-<span class="number">1</span>: set socket timeout to <span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">14.492</span>  [       Thread-<span class="number">6</span>] : http-outgoing-<span class="number">1</span>: set socket timeout to <span class="number">8000</span></span><br><span class="line">.....</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">19.501</span>  [           main] : [leased: <span class="number">1</span>; pending: <span class="number">0</span>; available: <span class="number">1</span>; max: <span class="number">150</span>]</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">19.504</span>  [       Thread-<span class="number">6</span>] : Connection can be kept alive indefinitely</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">19.504</span>  [       Thread-<span class="number">6</span>] : Connection [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080] can be kept alive indefinitely</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">19.505</span>  [       Thread-<span class="number">6</span>] : http-outgoing-<span class="number">1</span>: set socket timeout to <span class="number">0</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">19.505</span>  [       Thread-<span class="number">6</span>] : Connection released: [id: <span class="number">1</span>][route: &#123;&#125;-&gt;http:<span class="comment">//127.0.0.1:8080][total kept alive: 2; route allocated: 2 of 150; total allocated: 2 of 150]</span></span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">24.504</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">2</span>; max: <span class="number">150</span>]</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52421        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52420        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52421        127.0.0.1.8080         ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52420        127.0.0.1.8080         ESTABLISHED</span><br></pre></td></tr></table></figure>

<p>复用了上面的连接，下面是随后逐步超时的日志。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">39.513</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">2</span>; max: <span class="number">150</span>]</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">44.491</span>  [       Thread-<span class="number">8</span>] : Closing expired connections</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">44.492</span>  [       Thread-<span class="number">8</span>] : Closing connections idle longer than <span class="number">30</span> SECONDS</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">44.492</span>  [       Thread-<span class="number">8</span>] : http-outgoing-<span class="number">0</span>: Close connection</span><br><span class="line"><span class="number">16</span>:<span class="number">55</span>:<span class="number">44.518</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">1</span>; max: <span class="number">150</span>]</span><br><span class="line">....</span><br><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">09.535</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">1</span>; max: <span class="number">150</span>]</span><br><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">14.499</span>  [       Thread-<span class="number">8</span>] : Closing expired connections</span><br><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">14.499</span>  [       Thread-<span class="number">8</span>] : Closing connections idle longer than <span class="number">30</span> SECONDS</span><br><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">14.499</span>  [       Thread-<span class="number">8</span>] : http-outgoing-<span class="number">1</span>: Close connection</span><br><span class="line"><span class="number">16</span>:<span class="number">56</span>:<span class="number">14.540</span>  [           main] : [leased: <span class="number">0</span>; pending: <span class="number">0</span>; available: <span class="number">0</span>; max: <span class="number">150</span>]</span><br></pre></td></tr></table></figure>

<p>分别对应状态如下，可以看到复用了 52421，随后 52420 空闲超时被回收，以及最后 52421 也被回收。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52421        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52421        127.0.0.1.8080         ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52420        127.0.0.1.8080         TIME_WAIT</span><br><span class="line">...</span><br><span class="line"><span class="meta">#</span><span class="bash">netstat -n | grep tcp4 | grep 8080</span></span><br><span class="line">tcp4       0      0  127.0.0.1.52421        127.0.0.1.8080         TIME_WAIT</span><br></pre></td></tr></table></figure></li>
<li><p>最后一个请求后，日志省略，可以看到是新的连接 52443。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">netstat -n | grep tcp4 | grep 8080</span><br><span class="line">tcp4       0      0  127.0.0.1.8080         127.0.0.1.52443        ESTABLISHED</span><br><span class="line">tcp4       0      0  127.0.0.1.52443        127.0.0.1.8080         ESTABLISHED</span><br></pre></td></tr></table></figure></li>
</ol>
<p>文章所有演示用例和封装类链接：<a class="link"   target="_blank" rel="noopener" href="https://github.com/JeffreyPeng/http-client-case/" >https://github.com/JeffreyPeng/http-client-case/<i class="fas fa-external-link-alt"></i></a></p>
<p>参考：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/fundamentals.html" >https://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/fundamentals.html<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://hc.apache.org/httpcomponents-client-ga/tutorial/html/connmgmt.html" >https://hc.apache.org/httpcomponents-client-ga/tutorial/html/connmgmt.html<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.baeldung.com/httpclient-connection-management" >https://www.baeldung.com/httpclient-connection-management<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.jianshu.com/p/56881801d02c" >https://www.jianshu.com/p/56881801d02c<i class="fas fa-external-link-alt"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/61423830" >https://zhuanlan.zhihu.com/p/61423830<i class="fas fa-external-link-alt"></i></a></p>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/posts/29893/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Mac 配置终端</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/posts/25831/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Wireshark 抓包</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>
              -
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">JD</a>
        </div>
        
            <script async  src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                    <span id="busuanzi_container_site_uv">
                        Visitor Count&nbsp;<span id="busuanzi_value_site_uv"></span>&ensp;
                    </span>
                
                
                    <span id="busuanzi_container_site_pv">
                        Totalview&nbsp;<span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%B5%84%E6%BA%90%E9%87%8A%E6%94%BE"><span class="nav-text">一、资源释放</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E8%BF%9E%E6%8E%A5%E5%A4%8D%E7%94%A8"><span class="nav-text">二、连接复用</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>





<div class="post-scripts">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>



</body>
</html>
